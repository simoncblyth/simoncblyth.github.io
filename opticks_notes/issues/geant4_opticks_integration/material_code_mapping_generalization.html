<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Material Code Mapping Generalization &mdash; OpticksDevNotes 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="OpticksDevNotes 0.0.1 documentation" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">OpticksDevNotes 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Material Code Mapping Generalization</a><ul>
<li><a class="reference internal" href="#issue-dec-2016-lookup-fails-with-live-g4gun">Issue : Dec 2016 : Lookup fails with live g4gun</a></li>
<li><a class="reference internal" href="#legacy-approach">Legacy Approach</a><ul>
<li><a class="reference internal" href="#translate-on-load">Translate on load</a></li>
<li><a class="reference internal" href="#lookups">Lookups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes">Changes</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/issues/geant4_opticks_integration/material_code_mapping_generalization.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="material-code-mapping-generalization">
<h1>Material Code Mapping Generalization<a class="headerlink" href="#material-code-mapping-generalization" title="Permalink to this headline">¶</a></h1>
<p>Persisted gensteps contain material indices, in order to
map these to actual materials it is necessary to have
a code to material name mapping.</p>
<div class="section" id="issue-dec-2016-lookup-fails-with-live-g4gun">
<h2>Issue : Dec 2016 : Lookup fails with live g4gun<a class="headerlink" href="#issue-dec-2016-lookup-fails-with-live-g4gun" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>HUH did not do anything substantial but it seems not to be happening anymore</li>
</ul>
<div class="highlight-python"><pre>delta:opticksgeo blyth$ opticks-find applyLookup
./ok/ok.bash:G4StepNPY::applyLookup does a to b mapping between lingo which is invoked
./ok/ok.bash:     553         genstep.applyLookup(0, 2);   // translate materialIndex (1st quad, 3rd number) from chroma to GGeo

./optickscore/OpticksEvent.cc:    m_g4step-&gt;applyLookup(0, 2);  // jj, kk [1st quad, third value] is materialIndex
./optickscore/OpticksEvent.cc:    idx-&gt;applyLookup&lt;unsigned char&gt;(phosel_values);
./optickscore/tests/IndexerTest.cc:    idx-&gt;applyLookup&lt;unsigned char&gt;(phosel-&gt;getValues());
./opticksnpy/tests/NLookupTest.cc:    cs.applyLookup(0, 2); // materialIndex  (1st quad, 3rd number)

./opticksnpy/G4StepNPY.cpp:bool G4StepNPY::applyLookup(unsigned int index)
./opticksnpy/G4StepNPY.cpp:        printf(" G4StepNPY::applyLookup  %3u -&gt; %3d  a[%s] b[%s] \n", acode, bcode, aname.c_str(), bname.c_str() );
./opticksnpy/G4StepNPY.cpp:        printf("G4StepNPY::applyLookup failed to translate acode %u : %s \n", acode, aname.c_str() );
./opticksnpy/G4StepNPY.cpp:void G4StepNPY::applyLookup(unsigned int jj, unsigned int kk)
./opticksnpy/G4StepNPY.cpp:            bool ok = applyLookup(index);
./opticksnpy/G4StepNPY.cpp:       LOG(fatal) &lt;&lt; "G4StepNPY::applyLookup"
./opticksnpy/G4StepNPY.cpp:       m_npy-&gt;save("$TMP/G4StepNPY_applyLookup_FAIL.npy");
./opticksnpy/G4StepNPY.cpp:       dumpLookupFails("G4StepNPY::applyLookup");
./opticksnpy/G4StepNPY.hpp:       void applyLookup(unsigned int jj, unsigned int kk);
./opticksnpy/G4StepNPY.hpp:       bool applyLookup(unsigned int index);</pre>
</div>
<div class="highlight-python"><pre>075 void OpticksRun::setGensteps(NPY&lt;float&gt;* gensteps)
 76 {
 77     LOG(info) &lt;&lt; "OpticksRun::setGensteps " &lt;&lt; gensteps-&gt;getShapeString() ;
 78
 79     assert(m_evt &amp;&amp; m_g4evt &amp;&amp; "must OpticksRun::createEvent prior to OpticksRun::setGensteps");
 80
 81     m_g4evt-&gt;setGenstepData(gensteps);
 82
 83     passBaton();
 84 }
 85
 86 void OpticksRun::passBaton()
 87 {
 88     NPY&lt;float&gt;* nopstep = m_g4evt-&gt;getNopstepData() ;
 89     NPY&lt;float&gt;* genstep = m_g4evt-&gt;getGenstepData() ;
 90
 91     LOG(info) &lt;&lt; "OpticksRun::passBaton"
 92               &lt;&lt; " nopstep " &lt;&lt; nopstep
 93               &lt;&lt; " genstep " &lt;&lt; genstep
 94               ;
 95
 96
 97    //
 98    // Not-cloning as these buffers are not actually distinct
 99    // between G4 and OK.
100    //
101    // Nopstep and Genstep should be treated as owned
102    // by the m_g4evt not the Opticks m_evt
103    // where the m_evt pointers are just weak reference guests
104    //
105
106     m_evt-&gt;setNopstepData(nopstep);
107     m_evt-&gt;setGenstepData(genstep);
108 }</pre>
</div>
<div class="highlight-python"><pre>0938 void OpticksEvent::setGenstepData(NPY&lt;float&gt;* genstep_data, bool progenitor, const char* oac_label)
 939 {
 940     int nitems = NPYBase::checkNumItems(genstep_data);
 941     if(nitems &lt; 1)
 942     {
 943          LOG(warning) &lt;&lt; "OpticksEvent::setGenstepData SKIP "
 944                       &lt;&lt; " nitems " &lt;&lt; nitems
 945                       ;
 946          return ;
 947     }
 948
 949     importGenstepData(genstep_data, oac_label );
 950
 951     setBufferControl(genstep_data);
 952
 953     m_genstep_data = genstep_data  ;
 954     m_parameters-&gt;add&lt;std::string&gt;("genstepDigest",   m_genstep_data-&gt;getDigestString()  );
 955
 956     //                                                j k l sz   type        norm   iatt  item_from_dim
 957     ViewNPY* vpos = new ViewNPY("vpos",m_genstep_data,1,0,0,4,ViewNPY::FLOAT,false,false, 1);    // (x0, t0)                     2nd GenStep quad
 958     ViewNPY* vdir = new ViewNPY("vdir",m_genstep_data,2,0,0,4,ViewNPY::FLOAT,false,false, 1);    // (DeltaPosition, step_length) 3rd GenStep quad
 959
 960     m_genstep_vpos = vpos ;
 961
 962     m_genstep_attr = new MultiViewNPY("genstep_attr");
 963     m_genstep_attr-&gt;add(vpos);
 964     m_genstep_attr-&gt;add(vdir);
 965
 966     {
 967         m_num_gensteps = m_genstep_data-&gt;getShape(0) ;
 968         unsigned int num_photons = m_genstep_data-&gt;getUSum(0,3);
 969         bool resize = progenitor ;
 970         setNumPhotons(num_photons, resize); // triggers a resize   &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; SPECIAL HANDLING OF GENSTEP &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
 971     }
 972 }




1046 void OpticksEvent::importGenstepData(NPY&lt;float&gt;* gs, const char* oac_label)
1047 {
1048     Parameters* gsp = gs-&gt;getParameters();
1049     m_parameters-&gt;append(gsp);
1050
1051     gs-&gt;setBufferSpec(OpticksEvent::GenstepSpec(isCompute()));
1052
1053     assert(m_g4step == NULL &amp;&amp; "OpticksEvent::importGenstepData can only do this once ");
1054     m_g4step = new G4StepNPY(gs);
1055
1056     OpticksActionControl oac(gs-&gt;getActionControlPtr());
1057     if(oac_label)
1058     {
1059         LOG(debug) &lt;&lt; "OpticksEvent::importGenstepData adding oac_label " &lt;&lt; oac_label ;
1060         oac.add(oac_label);
1061     }
1062
1063
1064     LOG(debug) &lt;&lt; "OpticksEvent::importGenstepData"
1065                &lt;&lt; brief()
1066                &lt;&lt; " shape " &lt;&lt; gs-&gt;getShapeString()
1067                &lt;&lt; " " &lt;&lt; oac.description("oac")
1068                ;
1069
1070     if(oac("GS_LEGACY"))
1071     {
1072         translateLegacyGensteps(gs);
1073     }
1074     else if(oac("GS_TORCH"))
1075     {
1076         LOG(debug) &lt;&lt; " checklabel of torch steps  " &lt;&lt; oac.description("oac") ;
1077         m_g4step-&gt;checklabel(TORCH);
1078     }
1079     else if(oac("GS_FABRICATED"))
1080     {
1081         m_g4step-&gt;checklabel(FABRICATED);
1082     }
1083     else
1084     {
1085         LOG(debug) &lt;&lt; " checklabel of non-legacy (collected direct) gensteps  " &lt;&lt; oac.description("oac") ;
1086         m_g4step-&gt;checklabel(CERENKOV, SCINTILLATION);
1087     }
1088
1089     m_g4step-&gt;countPhotons();
....
1105 }
1106



0986 void OpticksEvent::translateLegacyGensteps(NPY&lt;float&gt;* gs)
 987 {
 988     OpticksActionControl oac(gs-&gt;getActionControlPtr());
 989     bool gs_torch = oac.isSet("GS_TORCH") ;
 990     bool gs_legacy = oac.isSet("GS_LEGACY") ;
 991
 992     if(!gs_legacy) return ;
 993     assert(!gs_torch); // there are no legacy torch files ?
 994
 995     if(gs-&gt;isGenstepTranslated())
 996     {
 997         LOG(warning) &lt;&lt; "OpticksEvent::translateLegacyGensteps already translated " ;
 998         return ;
 999     }
1000
1001     gs-&gt;setGenstepTranslated();
1002
1003     NLookup* lookup = gs-&gt;getLookup();
1004     if(!lookup)
1005             LOG(fatal) &lt;&lt; "OpticksEvent::translateLegacyGensteps"
1006                        &lt;&lt; " IMPORT OF LEGACY GENSTEPS REQUIRES gs-&gt;setLookup(NLookup*) "
1007                        &lt;&lt; " PRIOR TO OpticksEvent::setGenstepData(gs) "
1008                        ;
1009
1010     assert(lookup);
1011
1012     m_g4step-&gt;relabel(CERENKOV, SCINTILLATION);
1013
1014     // CERENKOV or SCINTILLATION codes are used depending on
1015     // the sign of the pre-label
1016     // this becomes the ghead.i.x used in cu/generate.cu
1017     // which dictates what to generate
1018
1019     lookup-&gt;close("OpticksEvent::translateLegacyGensteps GS_LEGACY");
1020
1021     m_g4step-&gt;setLookup(lookup);
1022     m_g4step-&gt;applyLookup(0, 2);  // jj, kk [1st quad, third value] is materialIndex
1023     // replaces original material indices with material lines
1024     // for easy access to properties using boundary_lookup GPU side
1025
1026 }</pre>
</div>
</div>
<div class="section" id="legacy-approach">
<h2>Legacy Approach<a class="headerlink" href="#legacy-approach" title="Permalink to this headline">¶</a></h2>
<div class="section" id="translate-on-load">
<h3>Translate on load<a class="headerlink" href="#translate-on-load" title="Permalink to this headline">¶</a></h3>
<p>Genstep material indices are translated into GPU material lines on loading the file,
to keep things simple GPU side.</p>
<p><cite>NPY&lt;float&gt;* OpticksHub::loadGenstepFile()</cite>:</p>
<div class="highlight-python"><pre>389     G4StepNPY* g4step = new G4StepNPY(gs);
390     g4step-&gt;relabel(CERENKOV, SCINTILLATION);
391     // which code is used depends in the sign of the pre-label
392     // becomes the ghead.i.x used in cu/generate.cu
393
394     if(m_opticks-&gt;isDayabay())
395     {
396         // within GGeo this depends on GBndLib
397         NLookup* lookup = m_ggeo ? m_ggeo-&gt;getLookup() : NULL ;
398         if(lookup)
399         {
400             g4step-&gt;setLookup(lookup);
401             g4step-&gt;applyLookup(0, 2);  // jj, kk [1st quad, third value] is materialIndex
402             //
403             // replaces original material indices with material lines
404             // for easy access to properties using boundary_lookup GPU side
405             //
406         }
407         else
408         {
409             LOG(warning) &lt;&lt; "OpticksHub::loadGenstepFile not applying lookup" ;
410         }
411     }
412     return gs ;</pre>
</div>
<ul class="simple">
<li>with in memory gensteps direct from G4, need to do the
same thing but with the lookup will need to be different</li>
</ul>
</div>
<div class="section" id="lookups">
<h3>Lookups<a class="headerlink" href="#lookups" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>npy-/NLookup does the mapping</li>
</ul>
<div class="highlight-python"><pre>/// setupLookup is invoked by GGeo::loadGeometry

620 void GGeo::setupLookup()
621 {
622     //  maybe this belongs in GBndLib ?
623     //
624     m_lookup = new NLookup() ;
625
626     const char* cmmd = m_opticks-&gt;getDetectorBase() ;
627
628     m_lookup-&gt;loadA( cmmd, "ChromaMaterialMap.json", "/dd/Materials/") ;
629
630     std::map&lt;std::string, unsigned int&gt;&amp; msu  = m_lookup-&gt;getB() ;
631
632     m_bndlib-&gt;fillMaterialLineMap( msu ) ;
633
634     m_lookup-&gt;crossReference();
635
636     //m_lookup-&gt;dump("GGeo::setupLookup");
637 }</pre>
</div>
<p>ggeo-/tests/NLookupTest.cc:</p>
<div class="highlight-python"><pre>GBndLib* blib = GBndLib::load(m_opticks, true );

NLookup* m_lookup = new NLookup();

const char* cmmd = m_opticks-&gt;getDetectorBase() ;

m_lookup-&gt;loadA( cmmd , "ChromaMaterialMap.json", "/dd/Materials/") ;

std::map&lt;std::string, unsigned int&gt;&amp; msu = m_lookup-&gt;getB() ;

blib-&gt;fillMaterialLineMap( msu ) ;     // shortname eg "GdDopedLS" to material line mapping

m_lookup-&gt;crossReference();

m_lookup-&gt;dump("ggeo-/NLookupTest");</pre>
</div>
<p>ChromaMaterialMap.json contains name to code mappings used
for a some very old gensteps that were produced by G4DAEChroma
and which are still in use.
As the assumption of all gensteps being produced the same
way and with the same material mappings will soon become
incorrect, need a more flexible way.</p>
<p>Perhaps a sidecar file to the gensteps .npy should
contain material mappings, and if it doesnt exist then
defaults are used ?</p>
<div class="highlight-python"><pre>simon:DayaBay blyth$ cat ChromaMaterialMap.json | tr "," "\n"
{"/dd/Materials/OpaqueVacuum": 18
 "/dd/Materials/Pyrex": 21
 "/dd/Materials/PVC": 20
 "/dd/Materials/NitrogenGas": 16
 "/dd/Materials/Teflon": 24
 "/dd/Materials/ESR": 9
 "/dd/Materials/MineralOil": 14</pre>
</div>
</div>
</div>
<div class="section" id="changes">
<h2>Changes<a class="headerlink" href="#changes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>move NLookup to live up in OpticksHub in order to
configure it from the hub prior to geometry loading
when the lookup cross referencing is done</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">OpticksDevNotes 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>