
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Opticks Testing, Geocache Creation, Python setup &#8212; Opticks 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Opticks Externals" href="externals.html" />
    <link rel="prev" title="Opticks Install Instructions" href="install.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="externals.html" title="Opticks Externals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Opticks Install Instructions"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Opticks Testing, Geocache Creation, Python setup</a><ul>
<li><a class="reference internal" href="#testing-installation-with-opticks-t">Testing Installation with <strong>opticks-t</strong></a></li>
<li><a class="reference internal" href="#creating-a-geocache-geometry-directory-with-geocache-create">Creating a geocache geometry directory with <strong>geocache-create</strong></a><ul>
<li><a class="reference internal" href="#inspect-the-geocache-with-opticks-kcd">Inspect the geocache with <strong>opticks-kcd</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#opticks-analysis-and-debugging-using-python-ipython-numpy-and-matplotlib-manage-with-miniconda">Opticks Analysis and Debugging using Python, IPython, NumPy and Matplotlib : manage with <strong>miniconda</strong></a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Opticks Install Instructions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="externals.html"
                        title="next chapter">Opticks Externals</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/docs/testing.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="opticks-testing-geocache-creation-python-setup">
<h1><a class="toc-backref" href="#id1">Opticks Testing, Geocache Creation, Python setup</a><a class="headerlink" href="#opticks-testing-geocache-creation-python-setup" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#opticks-testing-geocache-creation-python-setup" id="id1">Opticks Testing, Geocache Creation, Python setup</a><ul>
<li><a class="reference internal" href="#testing-installation-with-opticks-t" id="id2">Testing Installation with <strong>opticks-t</strong></a></li>
<li><a class="reference internal" href="#creating-a-geocache-geometry-directory-with-geocache-create" id="id3">Creating a geocache geometry directory with <strong>geocache-create</strong></a></li>
<li><a class="reference internal" href="#opticks-analysis-and-debugging-using-python-ipython-numpy-and-matplotlib-manage-with-miniconda" id="id4">Opticks Analysis and Debugging using Python, IPython, NumPy and Matplotlib : manage with <strong>miniconda</strong></a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="testing-installation-with-opticks-t">
<h2><a class="toc-backref" href="#id2">Testing Installation with <strong>opticks-t</strong></a><a class="headerlink" href="#testing-installation-with-opticks-t" title="Permalink to this headline">¶</a></h2>
<p>The <em>opticks-t</em> function runs ctests for all the opticks projects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>simon:opticks blyth$ opticks-
simon:opticks blyth$ opticks-t
Test project /usr/local/opticks/build
      Start  1: SysRapTest.SEnvTest
 1/65 Test  #1: SysRapTest.SEnvTest ........................   Passed    0.00 sec
      Start  2: SysRapTest.SSysTest
 2/65 Test  #2: SysRapTest.SSysTest ........................   Passed    0.00 sec
      Start  3: SysRapTest.SDigestTest
 3/65 Test  #3: SysRapTest.SDigestTest .....................   Passed    0.00 sec
.....
.....
      Start 59: cfg4Test.CPropLibTest
59/65 Test #59: cfg4Test.CPropLibTest ......................   Passed    0.05 sec
      Start 60: cfg4Test.CTestDetectorTest
60/65 Test #60: cfg4Test.CTestDetectorTest .................   Passed    0.04 sec
      Start 61: cfg4Test.CGDMLDetectorTest
61/65 Test #61: cfg4Test.CGDMLDetectorTest .................   Passed    0.45 sec
      Start 62: cfg4Test.CG4Test
62/65 Test #62: cfg4Test.CG4Test ...........................   Passed    5.06 sec
      Start 63: cfg4Test.G4MaterialTest
63/65 Test #63: cfg4Test.G4MaterialTest ....................   Passed    0.02 sec
      Start 64: cfg4Test.G4StringTest
64/65 Test #64: cfg4Test.G4StringTest ......................   Passed    0.02 sec
      Start 65: cfg4Test.G4BoxTest
65/65 Test #65: cfg4Test.G4BoxTest .........................   Passed    0.02 sec

100% tests passed, 0 tests failed out of 65

Total Test time (real) =  59.89 sec
opticks-ctest : use -V to show output
</pre></div>
</div>
</div>
<div class="section" id="creating-a-geocache-geometry-directory-with-geocache-create">
<h2><a class="toc-backref" href="#id3">Creating a geocache geometry directory with <strong>geocache-create</strong></a><a class="headerlink" href="#creating-a-geocache-geometry-directory-with-geocache-create" title="Permalink to this headline">¶</a></h2>
<p>Many of the tests will fail in the absence of a geocache.
Geometries are created using the <em>geocache-</em> bash functions.
To create a geometry use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geocache</span><span class="o">-</span>              <span class="c1"># run precursor function which defines the others</span>
<span class="nb">type</span> <span class="n">geocache</span><span class="o">-</span><span class="n">create</span>   <span class="c1"># take a look at geocache-create</span>
<span class="n">geocache</span><span class="o">-</span><span class="n">create</span>        <span class="c1"># create geocache from GDML geometry file, default geometry is Dayabay near site detector</span>
</pre></div>
</div>
<p>The bash functions essentially boil down to the below commandline
with additional command line options for metadata recording:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OKX4Test</span> <span class="o">--</span><span class="n">deletegeocache</span> <span class="o">--</span><span class="n">gdmlpath</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">your</span><span class="o">/</span><span class="n">detector</span><span class="o">.</span><span class="n">gdml</span>
</pre></div>
</div>
<p>The <strong>OKX4Test</strong> executable loads a GDML file and translates it into an Opticks GGeo geometry
instance and persists that into a geocache.</p>
<p>Geocache creation is time and memory consuming, taking about 1 minute for the JUNO geometry
on a workstation with lots of memory. Fortunately this only needs to be done once per geometry, and
as the geocache is composed of binary .npy files they are fast to load and upload to the GPU.</p>
<p>Near to the end of the logging from geocache creation you should find output
similar to the below which reports the OPTICKS_KEY value of the geometry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@755</span><span class="p">]</span>  <span class="n">ok</span><span class="o">.</span><span class="n">idpath</span>  <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">blyth</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">opticks</span><span class="o">/</span><span class="n">geocache</span><span class="o">/</span><span class="n">OKX4Test_lWorld0x4bc2710_PV_g4live</span><span class="o">/</span><span class="n">g4ok_gltf</span><span class="o">/</span><span class="n">f6cc352e44243f8fa536ab483ad390ce</span><span class="o">/</span><span class="mi">1</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@756</span><span class="p">]</span>  <span class="n">ok</span><span class="o">.</span><span class="n">keyspec</span> <span class="n">OKX4Test</span><span class="o">.</span><span class="n">X4PhysicalVolume</span><span class="o">.</span><span class="n">lWorld0x4bc2710_PV</span><span class="o">.</span><span class="n">f6cc352e44243f8fa536ab483ad390ce</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@757</span><span class="p">]</span>  <span class="n">To</span> <span class="n">reuse</span> <span class="n">this</span> <span class="n">geometry</span><span class="p">:</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@758</span><span class="p">]</span>    <span class="mf">1.</span> <span class="nb">set</span> <span class="n">envvar</span> <span class="n">OPTICKS_KEY</span><span class="o">=</span><span class="n">OKX4Test</span><span class="o">.</span><span class="n">X4PhysicalVolume</span><span class="o">.</span><span class="n">lWorld0x4bc2710_PV</span><span class="o">.</span><span class="n">f6cc352e44243f8fa536ab483ad390ce</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@759</span><span class="p">]</span>    <span class="mf">2.</span> <span class="n">enable</span> <span class="n">envvar</span> <span class="n">sensitivity</span> <span class="k">with</span> <span class="o">--</span><span class="n">envkey</span> <span class="n">argument</span> <span class="n">to</span> <span class="n">Opticks</span> <span class="n">executables</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">FATAL</span> <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@767</span><span class="p">]</span> <span class="n">THE</span> <span class="n">LIVE</span> <span class="n">keyspec</span> <span class="n">DOES</span> <span class="n">NOT</span> <span class="n">MATCH</span> <span class="n">THAT</span> <span class="n">OF</span> <span class="n">THE</span> <span class="n">CURRENT</span> <span class="n">ENVVAR</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@768</span><span class="p">]</span>  <span class="p">(</span><span class="n">envvar</span><span class="p">)</span> <span class="n">OPTICKS_KEY</span><span class="o">=</span><span class="n">NONE</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">reportGeoCacheCoordinates</span><span class="nd">@769</span><span class="p">]</span>  <span class="p">(</span><span class="n">live</span><span class="p">)</span>   <span class="n">OPTICKS_KEY</span><span class="o">=</span><span class="n">OKX4Test</span><span class="o">.</span><span class="n">X4PhysicalVolume</span><span class="o">.</span><span class="n">lWorld0x4bc2710_PV</span><span class="o">.</span><span class="n">f6cc352e44243f8fa536ab483ad390ce</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.129</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">263983</span><span class="p">]</span> <span class="p">[</span><span class="n">Opticks</span><span class="p">::</span><span class="n">dumpRC</span><span class="nd">@202</span><span class="p">]</span>  <span class="n">rc</span> <span class="mi">0</span> <span class="n">rcmsg</span> <span class="p">:</span> <span class="o">-</span>
</pre></div>
</div>
<p>Opticks executables and scripts read the <strong>OPTICKS_KEY</strong> envvar to determine the geometry to load.
Add some lines to <cite>~/.opticks_config</cite> exporting the OPTICKS_KEY:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export OPTICKS_KEY=OKX4Test.X4PhysicalVolume.lWorld0x4bc2710_PV.f6cc352e44243f8fa536ab483ad390ce
export OPTICKS_KEYDIR=$(opticks-keydir)   # derived from OPTICKS_KEY
</pre></div>
</div>
<div class="section" id="inspect-the-geocache-with-opticks-kcd">
<h3>Inspect the geocache with <strong>opticks-kcd</strong><a class="headerlink" href="#inspect-the-geocache-with-opticks-kcd" title="Permalink to this headline">¶</a></h3>
<p>The bash function <strong>opticks-kcd</strong> changes directory to the geocache directory which is derived from the
<strong>OPTICKS_KEY</strong> envvar.  Searching for NumPy arrays in the geocache reveals a large number of them.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:1 blyth$ find . -name &#39;*.npy&#39; | wc -l
    2065

epsilon:1 blyth$ find . -name volume_transforms.npy
./GMergedMesh/0/volume_transforms.npy
./GMergedMesh/6/volume_transforms.npy
./GMergedMesh/1/volume_transforms.npy
./GMergedMesh/4/volume_transforms.npy
./GMergedMesh/3/volume_transforms.npy
./GMergedMesh/2/volume_transforms.npy
./GMergedMesh/5/volume_transforms.npy
./GNodeLib/volume_transforms.npy
</pre></div>
</div>
<p>IPython session loadind the placement transform of a particular volume in the geometry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:1 blyth$ ipython

In [1]: import numpy as np
In [2]: vt = np.load(&quot;GNodeLib/volume_transforms.npy&quot;)
In [3]: vt.shape
Out[3]: (12230, 4, 4)
In [3]: vt[3154]
Out[3]:
array([[      0.54317,      -0.83962,       0.     ,       0.     ],
       [      0.83962,       0.54317,       0.     ,       0.     ],
       [      0.     ,       0.     ,       1.     ,       0.     ],
       [ -18079.453  , -799699.44   ,   -7100.     ,       1.     ]],
      dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="section" id="opticks-analysis-and-debugging-using-python-ipython-numpy-and-matplotlib-manage-with-miniconda">
<h2><a class="toc-backref" href="#id4">Opticks Analysis and Debugging using Python, IPython, NumPy and Matplotlib : manage with <strong>miniconda</strong></a><a class="headerlink" href="#opticks-analysis-and-debugging-using-python-ipython-numpy-and-matplotlib-manage-with-miniconda" title="Permalink to this headline">¶</a></h2>
<p>Opticks uses the NumPy (NPY) buffer serialization format
for geometry and event data, thus analysis and debugging requires
python and ipython with numpy and matplotib extensions.
For management of these and other python packages it is
convenient to use miniconda.</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">https://docs.conda.io/en/latest/miniconda.html</a></li>
</ul>
<p>Opticks is in the process of migrating scripts from python2 to python3,
currently using Python 3.7.8. Please report problems from unmigrated scripts.</p>
<p>After installing miniconda the additional packages can be installed with
commands such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="n">ipython</span>
<span class="n">conda</span> <span class="n">install</span> <span class="n">numpy</span>
<span class="n">conda</span> <span class="n">install</span> <span class="n">matplotlib</span>
</pre></div>
</div>
<p>In addition to your PATH you can also control which python Opticks
uses with the optional OPTICKS_PYTHON envvar, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">OPTICKS_PYTHON</span><span class="o">=</span><span class="n">python3</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="externals.html" title="Opticks Externals"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Opticks Install Instructions"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>