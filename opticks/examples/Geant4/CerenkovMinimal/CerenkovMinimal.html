
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>CerenkovMinimal &#8212; Opticks 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">CerenkovMinimal</a><ul>
<li><a class="reference internal" href="#objective">Objective</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#full-opticks-usage-via-geocache">Full Opticks usage, via geocache</a></li>
<li><a class="reference internal" href="#review-sources">Review Sources</a></li>
<li><a class="reference internal" href="#aligned-rng-stream">Aligned RNG stream</a></li>
<li><a class="reference internal" href="#l4cerenkov">L4Cerenkov</a></li>
<li><a class="reference internal" href="#following-logging-output">Following Logging Output</a></li>
<li><a class="reference internal" href="#what-are-hits">What are hits ?</a></li>
<li><a class="reference internal" href="#controlling-the-embedded-opticks">Controlling the embedded Opticks</a></li>
<li><a class="reference internal" href="#examining-full-event-data">Examining Full Event Data</a></li>
<li><a class="reference internal" href="#examining-hit-data">Examining Hit Data</a></li>
<li><a class="reference internal" href="#meanings-of-the-photon-flags">Meanings of the photon flags</a><ul>
<li><a class="reference internal" href="#p-flags-u-z-4-debug-bytes">p.flags.u.z : 4 debug bytes</a></li>
<li><a class="reference internal" href="#p-flags-u-w-photon-history-mask">p.flags.u.w : photon history mask</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/examples/Geant4/CerenkovMinimal/CerenkovMinimal.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cerenkovminimal">
<h1>CerenkovMinimal<a class="headerlink" href="#cerenkovminimal" title="Permalink to this headline">¶</a></h1>
<div class="section" id="objective">
<h2>Objective<a class="headerlink" href="#objective" title="Permalink to this headline">¶</a></h2>
<p>CerenkovMinimal aims to show minimal use of embedded Opticks
to act as an starting point for users familiar with Geant4 examples.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The idea is to simplify Opticks usage by everything going
through the G4Opticks interface. This intentionally constrains
Opticks functionality and flexibility.</p>
</div>
<div class="section" id="full-opticks-usage-via-geocache">
<h2>Full Opticks usage, via geocache<a class="headerlink" href="#full-opticks-usage-via-geocache" title="Permalink to this headline">¶</a></h2>
<p>The geocache and gensteps created from the simple CerenkovMinimal
Geant4 geometry can be used from full unconstrained Opticks executables
by setting the OPTICKS_KEY reported by CerenkovMinimal.</p>
</div>
<div class="section" id="review-sources">
<h2>Review Sources<a class="headerlink" href="#review-sources" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>CerenkovMinimal.cc</dt>
<dd>main, includes only G4.hh</dd>
<dt>G4</dt>
<dd>holds instances of all the below action classes, PhysicsList&lt;L4Cerenkov&gt;
and the Ctx. Connects them up.</dd>
<dt>PhysicsList</dt>
<dd>mostly standard but with templated Cerenkov class</dd>
<dt>L4Cerenkov</dt>
<dd><p class="first">minimally modified Cerenkov process that invokes
G4Opticks::Get()-&gt;collectCerenkovStep</p>
<p class="last">Currently for validation the ordinary photon generation loop
is performed, with G4Opticks::setAlignIndex(photon_record_id)
being called at the head before any consumption of random numbers
and G4Opticks::setAlignIndex(-1) being called at the tail of the loop</p>
</dd>
<dt>Cerenkov</dt>
<dd>not currently used. Looks like a shim subclass
of G4Cerenkov with PostStepGetPhysicalInteractionLength
reimplemented for easy prodding</dd>
<dt>DetectorConstruction</dt>
<dd>very standard, in the style of simple Geant4 examples</dd>
<dt>SensitiveDetector</dt>
<dd>processHits invokes G4Opticks::collectHit</dd>
<dt>Ctx</dt>
<dd><p class="first">instance is resident of G4 and is passed as only argument to
all the action ctors.</p>
<p>Context struct used via setEvent setTrack setStep etc..
to maintain convenient state access</p>
<p>Ctx::setTrack currently kills non-optical tracks after the first
genstep has been collected : for debugging with a single genstep</p>
<p class="last">Ctx::setTrackOptical invokes G4Opticks::setAlignIndex(photon_record_id)
Ctx::postTrackOptical invokes G4Opticks::setAlignIndex(-1)</p>
</dd>
<dt>TrackInfo</dt>
<dd><p class="first">used to pass the photon_record_id from the L4Cerenkov photon generation
loop to subsequent propagation.</p>
<p class="last">G4VUserTrackInformation subclass that holds a photon_record_id, this
is convenient for example when multiple Geant4 events correspond
to a single Opticks event and also when doing reemission continuation :
ie maintaining the original identity of a photon through a reemission in
Geant4 to allow comparison with Opticks that does this naturally</p>
</dd>
<dt>RunAction</dt>
<dd>BeginOfRunAction passes world volume with G4Opticks::setGeometry
EndOfRunAction invokes G4Opticks::Finalize</dd>
<dt>EventAction</dt>
<dd>EndOfEventAction invokes G4Opticks::propagateOpticalPhotons</dd>
<dt>TrackingAction</dt>
<dd>handoff G4Track to Ctx::setTrack and Ctx::postTrack</dd>
<dt>SteppingAction</dt>
<dd>handoff G4Step to Ctx::setStep</dd>
<dt>PrimaryGeneratorAction</dt>
<dd>standard simple G4ParticleGun</dd>
<dt>Cerenkov.hh</dt>
<dd>shim on top of G4Cerenkov for debug dumping only</dd>
<dt>L4Cerenkov.hh</dt>
<dd>G4VProcess subclass based on G4Cerenkov that collects Cerenkov gensteps
using G4Opticks. Currently the CPU photon generation loop is still being
done for comparison purposes.</dd>
<dt>PhysicsList.hh</dt>
<dd>EM and Optical physics, ConstructOp is templated, currently using
L4Cerenkov</dd>
<dt>SensitiveDetector.hh</dt>
<dd>SensitiveDetector::ProcessHits is for standard Geant4 hits not ones from GPU.
Fairly undeveloped, needs machinery to shovel GPU hits in bulk into
collections.</dd>
</dl>
</div>
<div class="section" id="aligned-rng-stream">
<h2>Aligned RNG stream<a class="headerlink" href="#aligned-rng-stream" title="Permalink to this headline">¶</a></h2>
<p>Notice the calls to G4Opticks::setAlignIndex, which invoke CAlignEngine::SetSequenceIndex</p>
<ul class="simple">
<li>L4Cerenkov : with argument photon_record_id and -1 bracketing the body of the photon generation</li>
<li>Ctx::setTrackOptical Ctx::postTrackOptical which get invoked while propagating</li>
</ul>
<p>This is done to allow the RNG sequence for each photon to be continuous in order to
make it possible to match with the RNG sequence used on GPU.  Note this approach
has also been made to work across Scintillator reemission in CFG4.</p>
</div>
<div class="section" id="l4cerenkov">
<h2>L4Cerenkov<a class="headerlink" href="#l4cerenkov" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>random alignment setup is done prior to any consumption of
random numbers within the photon generation loop</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">182</span> <span class="n">G4VParticleChange</span><span class="o">*</span>
<span class="mi">183</span> <span class="n">L4Cerenkov</span><span class="p">::</span><span class="n">PostStepDoIt</span><span class="p">(</span><span class="n">const</span> <span class="n">G4Track</span><span class="o">&amp;</span> <span class="n">aTrack</span><span class="p">,</span> <span class="n">const</span> <span class="n">G4Step</span><span class="o">&amp;</span> <span class="n">aStep</span><span class="p">)</span>
<span class="mi">184</span>
<span class="o">...</span>
<span class="mi">292</span>         <span class="n">G4double</span> <span class="n">MeanNumberOfPhotons1</span> <span class="o">=</span>
<span class="mi">293</span>                      <span class="n">GetAverageNumberOfPhotons</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span><span class="n">beta1</span><span class="p">,</span><span class="n">aMaterial</span><span class="p">,</span><span class="n">Rindex</span><span class="p">);</span>
<span class="mi">294</span>         <span class="n">G4double</span> <span class="n">MeanNumberOfPhotons2</span> <span class="o">=</span>
<span class="mi">295</span>                      <span class="n">GetAverageNumberOfPhotons</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span><span class="n">beta2</span><span class="p">,</span><span class="n">aMaterial</span><span class="p">,</span><span class="n">Rindex</span><span class="p">);</span>
<span class="mi">296</span>
<span class="mi">297</span>
<span class="mi">298</span> <span class="c1">#ifdef WITH_OPTICKS</span>
<span class="mi">299</span>     <span class="n">unsigned</span> <span class="n">opticks_photon_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="mi">300</span>     <span class="p">{</span>
<span class="mi">301</span>         <span class="n">const</span> <span class="n">G4ParticleDefinition</span><span class="o">*</span> <span class="n">definition</span> <span class="o">=</span> <span class="n">aParticle</span><span class="o">-&gt;</span><span class="n">GetDefinition</span><span class="p">();</span>
<span class="mi">302</span>         <span class="n">G4ThreeVector</span> <span class="n">deltaPosition</span> <span class="o">=</span> <span class="n">aStep</span><span class="o">.</span><span class="n">GetDeltaPosition</span><span class="p">();</span>
<span class="mi">303</span>         <span class="n">G4int</span> <span class="n">materialIndex</span> <span class="o">=</span> <span class="n">aMaterial</span><span class="o">-&gt;</span><span class="n">GetIndex</span><span class="p">();</span>
<span class="mi">304</span>         <span class="n">G4cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;L4Cerenkov::PostStepDoIt&quot;</span>
<span class="mi">305</span>                <span class="o">&lt;&lt;</span> <span class="s2">&quot; dp (Pmax-Pmin) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dp</span>
<span class="mi">306</span>                <span class="o">&lt;&lt;</span> <span class="n">G4endl</span>
<span class="mi">307</span>                <span class="p">;</span>
<span class="mi">308</span>
<span class="mi">309</span>         <span class="n">opticks_photon_offset</span> <span class="o">=</span> <span class="n">G4Opticks</span><span class="p">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumPhotons</span><span class="p">();</span>
<span class="mi">310</span>         <span class="o">//</span> <span class="n">total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">photons</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">gensteps</span> <span class="n">collected</span> <span class="n">before</span> <span class="n">this</span> <span class="n">one</span>
<span class="mi">311</span>         <span class="o">//</span> <span class="n">within</span> <span class="n">this</span> <span class="n">OpticksEvent</span> <span class="p">(</span><span class="n">potentially</span> <span class="n">crossing</span> <span class="n">multiple</span> <span class="n">G4Event</span><span class="p">)</span>
<span class="mi">312</span>
<span class="mi">313</span>         <span class="n">G4Opticks</span><span class="p">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">collectCerenkovStep</span><span class="p">(</span>
<span class="mi">314</span>                <span class="mi">0</span><span class="p">,</span>                  <span class="o">//</span> <span class="mi">0</span>     <span class="nb">id</span><span class="p">:</span><span class="n">zero</span> <span class="n">means</span> <span class="n">use</span> <span class="n">cerenkov</span> <span class="n">step</span> <span class="n">count</span>
<span class="mi">315</span>                <span class="n">aTrack</span><span class="o">.</span><span class="n">GetTrackID</span><span class="p">(),</span>
<span class="mi">316</span>                <span class="n">materialIndex</span><span class="p">,</span>
<span class="mi">317</span>                <span class="n">NumPhotons</span><span class="p">,</span>
<span class="mi">318</span>
<span class="mi">319</span>                <span class="n">x0</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span>                <span class="o">//</span> <span class="mi">1</span>
<span class="mi">320</span>                <span class="n">x0</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span>
<span class="mi">321</span>                <span class="n">x0</span><span class="o">.</span><span class="n">z</span><span class="p">(),</span>
<span class="mi">322</span>                <span class="n">t0</span><span class="p">,</span>
<span class="mi">323</span>
<span class="mi">324</span>                <span class="n">deltaPosition</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span>     <span class="o">//</span> <span class="mi">2</span>
<span class="mi">325</span>                <span class="n">deltaPosition</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span>
<span class="mi">326</span>                <span class="n">deltaPosition</span><span class="o">.</span><span class="n">z</span><span class="p">(),</span>
<span class="mi">327</span>                <span class="n">aStep</span><span class="o">.</span><span class="n">GetStepLength</span><span class="p">(),</span>
<span class="mi">328</span>
<span class="mi">329</span>                <span class="n">definition</span><span class="o">-&gt;</span><span class="n">GetPDGEncoding</span><span class="p">(),</span>   <span class="o">//</span> <span class="mi">3</span>
<span class="mi">330</span>                <span class="n">definition</span><span class="o">-&gt;</span><span class="n">GetPDGCharge</span><span class="p">(),</span>
<span class="mi">331</span>                <span class="n">aTrack</span><span class="o">.</span><span class="n">GetWeight</span><span class="p">(),</span>
<span class="mi">332</span>                <span class="n">pPreStepPoint</span><span class="o">-&gt;</span><span class="n">GetVelocity</span><span class="p">(),</span>
<span class="mi">333</span>
<span class="mi">334</span>                <span class="n">BetaInverse</span><span class="p">,</span>       <span class="o">//</span> <span class="mi">4</span>
<span class="mi">335</span>                <span class="n">Pmin</span><span class="p">,</span>
<span class="mi">336</span>                <span class="n">Pmax</span><span class="p">,</span>
<span class="mi">337</span>                <span class="n">maxCos</span><span class="p">,</span>
<span class="mi">338</span>
<span class="mi">339</span>                <span class="n">maxSin2</span><span class="p">,</span>   <span class="o">//</span> <span class="mi">5</span>
<span class="mi">340</span>                <span class="n">MeanNumberOfPhotons1</span><span class="p">,</span>
<span class="mi">341</span>                <span class="n">MeanNumberOfPhotons2</span><span class="p">,</span>
<span class="mi">342</span>                <span class="n">pPostStepPoint</span><span class="o">-&gt;</span><span class="n">GetVelocity</span><span class="p">()</span>
<span class="mi">343</span>         <span class="p">);</span>
<span class="mi">344</span>     <span class="p">}</span>
<span class="mi">345</span> <span class="c1">#endif</span>
<span class="mi">346</span>
<span class="mi">347</span>
<span class="mi">348</span>     <span class="o">//</span> <span class="n">NB</span> <span class="n">eventually</span> <span class="n">the</span> <span class="n">below</span> <span class="n">CPU</span> <span class="n">photon</span> <span class="n">generation</span> <span class="n">loop</span>
<span class="mi">349</span>     <span class="o">//</span>    <span class="n">will</span> <span class="n">be</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">kept</span> <span class="k">for</span> <span class="n">now</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">comparisons</span> <span class="k">for</span> <span class="n">validation</span>
<span class="mi">350</span>
<span class="mi">351</span>     <span class="k">for</span> <span class="p">(</span><span class="n">G4int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NumPhotons</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">352</span>
<span class="mi">353</span>         <span class="o">//</span> <span class="n">Determine</span> <span class="n">photon</span> <span class="n">energy</span>
<span class="mi">354</span> <span class="c1">#ifdef WITH_OPTICKS</span>
<span class="mi">355</span>         <span class="n">unsigned</span> <span class="n">record_id</span> <span class="o">=</span> <span class="n">opticks_photon_offset</span><span class="o">+</span><span class="n">i</span> <span class="p">;</span>
<span class="mi">356</span>         <span class="n">G4Opticks</span><span class="p">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setAlignIndex</span><span class="p">(</span><span class="n">record_id</span><span class="p">);</span>
<span class="mi">357</span> <span class="c1">#endif</span>
<span class="mi">358</span>
<span class="mi">359</span>         <span class="n">G4double</span> <span class="n">rand</span><span class="p">;</span>
<span class="mi">360</span>         <span class="n">G4double</span> <span class="n">sampledEnergy</span><span class="p">,</span> <span class="n">sampledRI</span><span class="p">;</span>
<span class="mi">361</span>         <span class="n">G4double</span> <span class="n">cosTheta</span><span class="p">,</span> <span class="n">sin2Theta</span><span class="p">;</span>
<span class="mi">362</span>
<span class="mi">363</span>         <span class="o">//</span> <span class="n">sample</span> <span class="n">an</span> <span class="n">energy</span>
<span class="mi">364</span>
<span class="mi">365</span>         <span class="n">do</span> <span class="p">{</span>
<span class="mi">366</span>             <span class="n">rand</span> <span class="o">=</span> <span class="n">G4UniformRand</span><span class="p">();</span>
<span class="mi">367</span>             <span class="n">sampledEnergy</span> <span class="o">=</span> <span class="n">Pmin</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">*</span> <span class="n">dp</span><span class="p">;</span>
<span class="mi">368</span>             <span class="n">sampledRI</span> <span class="o">=</span> <span class="n">Rindex</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">(</span><span class="n">sampledEnergy</span><span class="p">);</span>
<span class="mi">369</span>             <span class="n">cosTheta</span> <span class="o">=</span> <span class="n">BetaInverse</span> <span class="o">/</span> <span class="n">sampledRI</span><span class="p">;</span>

<span class="o">...</span>    <span class="n">standard</span> <span class="n">Cerenkov</span> <span class="n">generation</span> <span class="o">....</span>

<span class="mi">463</span>         <span class="n">aParticleChange</span><span class="o">.</span><span class="n">AddSecondary</span><span class="p">(</span><span class="n">aSecondaryTrack</span><span class="p">);</span>
<span class="mi">464</span>
<span class="mi">465</span>
<span class="mi">466</span> <span class="c1">#ifdef WITH_OPTICKS</span>
<span class="mi">467</span>         <span class="n">aSecondaryTrack</span><span class="o">-&gt;</span><span class="n">SetUserInformation</span><span class="p">(</span><span class="n">new</span> <span class="n">TrackInfo</span><span class="p">(</span> <span class="n">record_id</span> <span class="p">)</span> <span class="p">);</span>
<span class="mi">468</span>         <span class="n">G4Opticks</span><span class="p">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setAlignIndex</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="mi">469</span> <span class="c1">#endif</span>
<span class="mi">470</span>
<span class="mi">471</span>
<span class="mi">472</span>     <span class="p">}</span>  <span class="o">//</span> <span class="n">CPU</span> <span class="n">photon</span> <span class="n">generation</span> <span class="n">loop</span>
<span class="mi">473</span>
<span class="mi">474</span>     <span class="k">if</span> <span class="p">(</span><span class="n">verboseLevel</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">475</span>        <span class="n">G4cout</span> <span class="o">&lt;&lt;</span><span class="s2">&quot;L4Cerenkov::PostStepDoIt DONE -- NumberOfSecondaries = &quot;</span>
<span class="mi">476</span>               <span class="o">&lt;&lt;</span> <span class="n">aParticleChange</span><span class="o">.</span><span class="n">GetNumberOfSecondaries</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">G4endl</span><span class="p">;</span>
<span class="mi">477</span>     <span class="p">}</span>
<span class="mi">478</span>
<span class="mi">479</span>
<span class="mi">480</span> <span class="c1">#ifdef WITH_OPTICKS</span>
<span class="mi">481</span>        <span class="n">G4cout</span>
<span class="mi">482</span>            <span class="o">&lt;&lt;</span> <span class="s2">&quot;L4Cerenkov::PostStepDoIt G4Opticks.collectSecondaryPhotons&quot;</span>
<span class="mi">483</span>            <span class="o">&lt;&lt;</span> <span class="n">G4endl</span>
<span class="mi">484</span>            <span class="p">;</span>
<span class="mi">485</span>
<span class="mi">486</span>         <span class="n">G4Opticks</span><span class="p">::</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">collectSecondaryPhotons</span><span class="p">(</span><span class="n">pParticleChange</span><span class="p">)</span> <span class="p">;</span>
<span class="mi">487</span> <span class="c1">#endif</span>
<span class="mi">488</span>
<span class="mi">489</span>         <span class="k">return</span> <span class="n">pParticleChange</span><span class="p">;</span>
<span class="mi">490</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="following-logging-output">
<h2>Following Logging Output<a class="headerlink" href="#following-logging-output" title="Permalink to this headline">¶</a></h2>
<p>The below is a selection of the logging output from CernkovMinimal
with some explanations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:~ blyth$ oe-      # setup the environment
epsilon:~ blyth$ CerenkovMinimal

**************************************************************
 Geant4 version Name: geant4-10-04-patch-02    (25-May-2018)
                       Copyright : Geant4 Collaboration

...
2020-06-06 21:03:42.503 INFO  [61988576] [OpEngine::uploadEvent@136] .
2020-06-06 21:03:42.512 INFO  [61988576] [OpEngine::propagate@145] [
2020-06-06 21:03:42.512 INFO  [61988576] [OpSeeder::seedPhotonsFromGenstepsViaOptiX@173] SEEDING TO SEED BUF
2020-06-06 21:03:42.524 INFO  [61988576] [OpEngine::propagate@155] ( propagator.launch
2020-06-06 21:03:43.533 INFO  [61988576] [OPropagator::prelaunch@185] 1 : (0;221,1)

     ## (221,1) are the (width,height) dimensions of the OptiX launch
     ## the number of photons is always known ahead of time, coming from the
     ## gensteps collected from Geant4

2020-06-06 21:03:43.533 INFO  [61988576] [BTimes::dump@177] OPropagator::prelaunch
              validate000                  2.4e-05
               compile000                    2e-06
             prelaunch000                 0.800931
2020-06-06 21:03:43.533 INFO  [61988576] [OPropagator::launch@214] LAUNCH NOW -
2020-06-06 21:03:43.535 INFO  [61988576] [OPropagator::launch@223] LAUNCH DONE
2020-06-06 21:03:43.535 INFO  [61988576] [OPropagator::launch@225] 1 : (0;221,1)
2020-06-06 21:03:43.535 INFO  [61988576] [BTimes::dump@177] OPropagator::launch
                launch001                 0.001449

     ## thats the time of the launch

2020-06-06 21:03:43.535 INFO  [61988576] [OpEngine::propagate@157] ) propagator.launch
2020-06-06 21:03:43.535 INFO  [61988576] [OpIndexer::indexSequenceCompute@237] OpIndexer::indexSequenceCompute
2020-06-06 21:03:43.539 INFO  [61988576] [OpEngine::propagate@160] ]
2020-06-06 21:03:43.539 INFO  [61988576] [OpEngine::downloadEvent@186] .
2020-06-06 21:03:43.540 INFO  [61988576] [OEvent::downloadHits@396]  nhit 44 --dbghit N hitmask 0x40 SD SURFACE_DETECT

     ## the hitmask determines what is regarded as a hit, this can be changed with the &quot;--dbghitmask&quot; option

2020-06-06 21:03:43.540 FATAL [61988576] [OpPropagator::propagate@78] evtId(0) DONE nhit: 44
2020-06-06 21:03:43.540 INFO  [61988576] [OpticksEvent::saveHitData@1689]  num_hit 0 ht 0,4,4 tag -1

      ## this num_hit 0 for sub-event tag -1 (4) is expected see notes below
      ## This is because the Opticks &quot;G4&quot; event (with negated tag) m_g4evt in G4Opticks is not filled
      ## that is only currently done with CFG4 fully instrumented running.

2020-06-06 21:03:43.542 ERROR [61988576] [OpticksEvent::saveIndex@2382] SKIP as not indexed
2020-06-06 21:03:43.543 INFO  [61988576] [OpticksEvent::makeReport@1773] tagdir /tmp/blyth/opticks/source/evt/g4live/natural/-1
2020-06-06 21:03:43.554 INFO  [61988576] [OpticksEvent::saveHitData@1689]  num_hit 44 ht 44,4,4 tag 1

      ## num_hit 44 for sub-event tag 1 (Opticks)

2020-06-06 21:03:43.558 INFO  [61988576] [OpticksEvent::makeReport@1773] tagdir /tmp/blyth/opticks/source/evt/g4live/natural/1
2020-06-06 21:03:43.570 ERROR [61988576] [GGeo::anaEvent@2069]  evt 0x7f9ce7ddfb50
2020-06-06 21:03:43.570 INFO  [61988576] [OpticksAna::run@92]  anakey (null) enabled N
...
2020-06-06 21:03:43.577 INFO  [61988576] [Opticks::saveParameters@1185]  postpropagate save parameters.json into TagZeroDir /tmp/blyth/opticks/source/evt/g4live/natural/0
2020-06-06 21:03:43.578 INFO  [61988576] [OpticksEvent::saveHitData@1689]  num_hit 148 ht 148,4,4 tag -1

      ## these 148 hits from standard G4 are &quot;artificially&quot; stuffed into m_g4evt in order to


EventAction::EndOfEventAction num_hits 44 hits 0x7f9cec9a47a0

###] EventAction::EndOfEventAction G4Opticks.propagateOpticalPhotons

EventAction::EndOfEventAction DumpHitCollections
SensitiveDetector::DumpHitCollections query SD0/OpHitCollectionA hcid    0 hc 0x7f9ce990bcc0 hc.entries 118
SensitiveDetector::DumpHitCollections query SD0/OpHitCollectionB hcid    1 hc 0x7f9ce990bd08 hc.entries 30


###[ RunAction::EndOfRunAction G4Opticks.Finalize
</pre></div>
</div>
<p>In the above logging there is a clear discrepancy with 44 hits from Opticks and 148 from Geant4.
There are many possible causes of this.   Debugging to attain a match is almost impossible
when the only information available is the hits obtained.  It is far easier when the
full information of the optical photon propagation is recorded.
The CFG4 package does full step-by-step recording Opticks and Geant4 propagations
into two OpticksEvent instances.
Due to its complexity this is not yet used for G4Opticks based running.</p>
<p>Other tricks very useful to attain a match used in CFG4 running are:</p>
<ul class="simple">
<li>performing random aligned simulations that consume the same random numbers</li>
<li>using common input photons generated on CPU</li>
</ul>
<p>Random aligned simulations mean that comparisons are not clouded by
statistics, allowing direct comparison of positions, times, wavelengths, polarizations.</p>
</div>
<div class="section" id="what-are-hits">
<h2>What are hits ?<a class="headerlink" href="#what-are-hits" title="Permalink to this headline">¶</a></h2>
<p>The hitmask is used to select which photons are regarded as “hits” and then only
these are downloaded from GPU to CPU.</p>
<p>optixrap/OEvent.cc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">65</span> <span class="n">OEvent</span><span class="p">::</span><span class="n">OEvent</span><span class="p">(</span><span class="n">Opticks</span><span class="o">*</span> <span class="n">ok</span><span class="p">,</span> <span class="n">OContext</span><span class="o">*</span> <span class="n">ocontext</span><span class="p">)</span>
<span class="mi">66</span>    <span class="p">:</span>
<span class="mi">67</span>    <span class="n">m_log</span><span class="p">(</span><span class="n">new</span> <span class="n">SLog</span><span class="p">(</span><span class="s2">&quot;OEvent::OEvent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">)),</span>
<span class="mi">68</span>    <span class="n">m_ok</span><span class="p">(</span><span class="n">ok</span><span class="p">),</span>
<span class="mi">69</span>    <span class="o">//</span><span class="n">m_hitmask</span><span class="p">(</span><span class="n">SURFACE_DETECT</span><span class="p">),</span>
<span class="mi">70</span>    <span class="o">//</span><span class="n">m_hitmask</span><span class="p">(</span><span class="n">TORCH</span> <span class="o">|</span> <span class="n">BULK_SCATTER</span> <span class="o">|</span> <span class="n">BOUNDARY_TRANSMIT</span> <span class="o">|</span> <span class="n">SURFACE_ABSORB</span><span class="p">),</span>
<span class="mi">71</span>    <span class="n">m_hitmask</span><span class="p">(</span><span class="n">ok</span><span class="o">-&gt;</span><span class="n">getDbgHitMask</span><span class="p">()),</span>
<span class="mi">72</span>    <span class="n">m_compute</span><span class="p">(</span><span class="n">ok</span><span class="o">-&gt;</span><span class="n">isCompute</span><span class="p">()),</span>
<span class="mi">73</span>    <span class="n">m_dbghit</span><span class="p">(</span><span class="n">m_ok</span><span class="o">-&gt;</span><span class="n">isDbgHit</span><span class="p">()),</span>            <span class="o">//</span> <span class="o">--</span><span class="n">dbghit</span>
</pre></div>
</div>
<p>The default “ok-&gt;getDbgHitMask()” is “SD” for SURFACE_DETECT which can be seen from, optickscore/OpticksCfg.cc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">87</span>        <span class="n">m_mask</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
<span class="mi">88</span>        <span class="n">m_dbghitmask</span><span class="p">(</span><span class="s2">&quot;SD&quot;</span><span class="p">),</span>
<span class="mi">89</span>        <span class="o">//</span><span class="n">m_dbghitmask</span><span class="p">(</span><span class="s2">&quot;TO,SC,BT,SA&quot;</span><span class="p">),</span>  <span class="o">//</span> <span class="n">see</span> <span class="n">OEvent</span><span class="p">::</span><span class="n">OEvent</span>
<span class="mi">90</span>        <span class="n">m_x4polyskip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
<span class="mi">91</span>        <span class="n">m_csgskiplv</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
</pre></div>
</div>
<p>The downloading is done in optixrap/OEvent.cc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">473</span> <span class="o">/**</span>
<span class="mi">474</span> <span class="n">OEvent</span><span class="p">::</span><span class="n">downloadHits</span>
<span class="mi">475</span> <span class="o">-------------------------</span>
<span class="mi">476</span>
<span class="mi">477</span> <span class="n">Downloading</span> <span class="n">hits</span> <span class="ow">is</span> <span class="n">special</span> <span class="n">because</span> <span class="n">a</span> <span class="n">selection</span> <span class="n">of</span> <span class="n">the</span>
<span class="mi">478</span> <span class="n">photon</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">necessitating</span>
<span class="mi">479</span> <span class="n">the</span> <span class="n">use</span> <span class="n">of</span> <span class="n">Thrust</span> <span class="n">stream</span> <span class="n">compaction</span><span class="o">.</span> <span class="n">This</span> <span class="n">avoids</span> <span class="n">allocating</span>
<span class="mi">480</span> <span class="n">memory</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">photons</span> <span class="n">on</span> <span class="n">the</span> <span class="n">host</span><span class="p">,</span> <span class="n">just</span> <span class="n">need</span> <span class="n">to</span> <span class="n">allocate</span>
<span class="mi">481</span> <span class="k">for</span> <span class="n">the</span> <span class="n">hits</span><span class="o">.</span>
<span class="mi">482</span>
<span class="mi">483</span> <span class="n">In</span> <span class="n">interop</span> <span class="n">need</span> <span class="n">CUDA</span><span class="o">/</span><span class="n">Thrust</span> <span class="n">access</span> <span class="n">to</span> <span class="n">underlying</span> <span class="n">OpenGL</span> <span class="n">buffer</span><span class="o">.</span>
<span class="mi">484</span> <span class="n">In</span> <span class="n">compute</span> <span class="n">need</span> <span class="n">CUDA</span><span class="o">/</span><span class="n">Thrust</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">OptiX</span> <span class="n">buffer</span><span class="o">.</span>
<span class="mi">485</span>
<span class="mi">486</span> <span class="o">**/</span>
<span class="mi">487</span>
<span class="mi">488</span> <span class="n">unsigned</span> <span class="n">OEvent</span><span class="p">::</span><span class="n">downloadHitsCompute</span><span class="p">(</span><span class="n">OpticksEvent</span><span class="o">*</span> <span class="n">evt</span><span class="p">)</span>
<span class="mi">489</span> <span class="p">{</span>
<span class="mi">490</span>     <span class="n">OK_PROFILE</span><span class="p">(</span><span class="s2">&quot;_OEvent::downloadHitsCompute&quot;</span><span class="p">);</span>
<span class="mi">491</span>
<span class="mi">492</span>     <span class="n">NPY</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;*</span> <span class="n">hit</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">getHitData</span><span class="p">();</span>
<span class="mi">493</span>
<span class="mi">494</span>     <span class="n">CBufSpec</span> <span class="n">cpho</span> <span class="o">=</span> <span class="n">m_photon_buf</span><span class="o">-&gt;</span><span class="n">bufspec</span><span class="p">();</span>
<span class="mi">495</span>     <span class="k">assert</span><span class="p">(</span> <span class="n">cpho</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
<span class="mi">496</span>     <span class="n">cpho</span><span class="o">.</span><span class="n">size</span> <span class="o">/=</span> <span class="mi">4</span> <span class="p">;</span>    <span class="o">//</span>  <span class="n">decrease</span> <span class="n">size</span> <span class="n">by</span> <span class="n">factor</span> <span class="n">of</span> <span class="mi">4</span><span class="p">,</span> <span class="n">increases</span> <span class="n">cpho</span> <span class="s2">&quot;item&quot;</span> <span class="kn">from</span> <span class="mi">1</span><span class="o">*</span><span class="n">float4</span> <span class="n">to</span> <span class="mi">4</span><span class="o">*</span><span class="n">float4</span>
<span class="mi">497</span>
<span class="mi">498</span>     <span class="nb">bool</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">m_dbghit</span> <span class="p">;</span>
<span class="mi">499</span>     <span class="n">TBuf</span> <span class="n">tpho</span><span class="p">(</span><span class="s2">&quot;tpho&quot;</span><span class="p">,</span> <span class="n">cpho</span> <span class="p">);</span>
<span class="mi">500</span>     <span class="n">unsigned</span> <span class="n">nhit</span> <span class="o">=</span> <span class="n">tpho</span><span class="o">.</span><span class="n">downloadSelection4x4</span><span class="p">(</span><span class="s2">&quot;OEvent::downloadHits&quot;</span><span class="p">,</span> <span class="n">hit</span><span class="p">,</span> <span class="n">m_hitmask</span><span class="p">,</span> <span class="n">verbose</span><span class="p">);</span>
<span class="mi">501</span>     <span class="o">//</span> <span class="n">hit</span> <span class="n">buffer</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="n">resized</span> <span class="n">to</span> <span class="n">fit</span> <span class="n">downloaded</span> <span class="n">hits</span> <span class="p">(</span><span class="n">nhit</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="mi">502</span>     <span class="k">assert</span><span class="p">(</span><span class="n">hit</span><span class="o">-&gt;</span><span class="n">hasShape</span><span class="p">(</span><span class="n">nhit</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">));</span>
<span class="mi">503</span>
<span class="mi">504</span>     <span class="n">OK_PROFILE</span><span class="p">(</span><span class="s2">&quot;OEvent::downloadHitsCompute&quot;</span><span class="p">);</span>
<span class="mi">505</span>
<span class="mi">506</span>     <span class="n">LOG</span><span class="p">(</span><span class="n">LEVEL</span><span class="p">)</span>
<span class="mi">507</span>          <span class="o">&lt;&lt;</span> <span class="s2">&quot; nhit &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nhit</span>
<span class="mi">508</span>          <span class="o">&lt;&lt;</span> <span class="s2">&quot; hit &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">hit</span><span class="o">-&gt;</span><span class="n">getShapeString</span><span class="p">()</span>
<span class="mi">509</span>          <span class="p">;</span>
<span class="mi">510</span>
<span class="mi">511</span>     <span class="k">return</span> <span class="n">nhit</span> <span class="p">;</span>
<span class="mi">512</span> <span class="p">}</span>
</pre></div>
</div>
<p>The resulting (nhit,4,4) hits buffer contains all the items of the photon buffer matching the hitmask.
The photon and hits buffers contain photon structs</p>
<p>optixrap/cu/photon.h:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">41</span> <span class="n">struct</span> <span class="n">Photon</span>
<span class="mi">42</span> <span class="p">{</span>
<span class="mi">43</span>    <span class="n">float3</span> <span class="n">position</span> <span class="p">;</span>
<span class="mi">44</span>    <span class="nb">float</span>  <span class="n">time</span> <span class="p">;</span>
<span class="mi">45</span>
<span class="mi">46</span>    <span class="n">float3</span> <span class="n">direction</span> <span class="p">;</span>
<span class="mi">47</span>    <span class="nb">float</span>  <span class="n">weight</span> <span class="p">;</span>
<span class="mi">48</span>
<span class="mi">49</span>    <span class="n">float3</span> <span class="n">polarization</span> <span class="p">;</span>
<span class="mi">50</span>    <span class="nb">float</span>  <span class="n">wavelength</span> <span class="p">;</span>
<span class="mi">51</span>
<span class="mi">52</span>    <span class="n">quad</span> <span class="n">flags</span> <span class="p">;</span>     <span class="o">//</span> <span class="n">x</span><span class="p">:</span><span class="n">boundary</span>  <span class="n">y</span><span class="p">:</span><span class="n">photon_id</span>   <span class="n">z</span><span class="p">:</span><span class="n">m1</span>   <span class="n">w</span><span class="p">:</span><span class="n">history</span>
<span class="mi">53</span>                     <span class="o">//</span>             <span class="p">[</span><span class="n">debug</span><span class="o">-</span><span class="n">only</span><span class="p">]</span>
<span class="mi">54</span> <span class="p">};</span>
<span class="mi">55</span>
<span class="mi">56</span>
</pre></div>
</div>
</div>
<div class="section" id="controlling-the-embedded-opticks">
<h2>Controlling the embedded Opticks<a class="headerlink" href="#controlling-the-embedded-opticks" title="Permalink to this headline">¶</a></h2>
<p>G4Opticks uses an embedded Opticks instance which has its own commandline.
Some of the first logging output from G4Opticks details the commandline that is in use.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">01.049</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">33575005</span><span class="p">]</span> <span class="p">[</span><span class="n">G4Opticks</span><span class="p">::</span><span class="n">EmbeddedCommandLine</span><span class="nd">@130</span><span class="p">]</span> <span class="n">Using</span> <span class="n">ecl</span> <span class="p">:[</span> <span class="o">--</span><span class="n">compute</span> <span class="o">--</span><span class="n">embedded</span> <span class="o">--</span><span class="n">xanalytic</span> <span class="o">--</span><span class="n">production</span> <span class="o">--</span><span class="n">nosave</span><span class="p">]</span> <span class="n">OPTICKS_EMBEDDED_COMMANDLINE</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">01.049</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">33575005</span><span class="p">]</span> <span class="p">[</span><span class="n">G4Opticks</span><span class="p">::</span><span class="n">EmbeddedCommandLine</span><span class="nd">@131</span><span class="p">]</span>  <span class="n">mode</span><span class="p">(</span><span class="n">Pro</span><span class="o">/</span><span class="n">Dev</span><span class="o">/</span><span class="n">Asis</span><span class="p">)</span> <span class="n">P</span> <span class="n">using</span> <span class="s2">&quot;pro&quot;</span> <span class="p">(</span><span class="n">production</span><span class="p">)</span> <span class="n">commandline</span> <span class="n">without</span> <span class="n">event</span> <span class="n">saving</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">01.049</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">33575005</span><span class="p">]</span> <span class="p">[</span><span class="n">G4Opticks</span><span class="p">::</span><span class="n">EmbeddedCommandLine</span><span class="nd">@136</span><span class="p">]</span> <span class="n">Using</span> <span class="n">extra1</span> <span class="n">argument</span> <span class="p">:[</span><span class="o">--</span><span class="n">skipaheadstep</span> <span class="mi">1000</span><span class="p">]</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">01.049</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">33575005</span><span class="p">]</span> <span class="p">[</span><span class="n">G4Opticks</span><span class="p">::</span><span class="n">EmbeddedCommandLine</span><span class="nd">@146</span><span class="p">]</span> <span class="n">Using</span> <span class="n">eclx</span> <span class="n">envvar</span> <span class="p">:[]</span> <span class="n">OPTICKS_EMBEDDED_COMMANDLINE_EXTRA</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">01.049</span> <span class="n">INFO</span>  <span class="p">[</span><span class="mi">33575005</span><span class="p">]</span> <span class="p">[</span><span class="o">*</span><span class="n">G4Opticks</span><span class="p">::</span><span class="n">InitOpticks</span><span class="nd">@231</span><span class="p">]</span> <span class="n">instanciate</span> <span class="n">Opticks</span> <span class="n">using</span> <span class="n">embedded</span> <span class="n">commandline</span> <span class="n">only</span>
 <span class="o">--</span><span class="n">compute</span> <span class="o">--</span><span class="n">embedded</span> <span class="o">--</span><span class="n">xanalytic</span> <span class="o">--</span><span class="n">production</span> <span class="o">--</span><span class="n">nosave</span>  <span class="o">--</span><span class="n">skipaheadstep</span> <span class="mi">1000</span>
</pre></div>
</div>
<p>Two envvars can be used to control this commandline.</p>
<dl class="docutils">
<dt>OPTICKS_EMBEDDED_COMMANDLINE</dt>
<dd><p class="first">Two special values “pro” and “dev” correspond to standard commandlines that are
expected to be appropriate for production and development.  Note that the “dev” mode
has saving enabled and will save large numbers of event files. The “pro” mode should
save very few files.</p>
<p class="last">The default “pro” mode corresponds to actual commandline “–compute –embedded –xanalytic –production –nosave”
The “dev” mode corresponds to ” –compute –embedded –xanalytic –save –natural –printenabled –pindex 0”</p>
</dd>
<dt>OPTICKS_EMBEDDED_COMMANDLINE_EXTRA</dt>
<dd>This envvar (for expert use only) can be used to add some additional options to the commandline.
Duplicated commandline options will trip asserts.</dd>
</dl>
<p>Typically when you wish to enable full event saving for debugging and analysis simply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">OPTICKS_EMBEDDED_COMMANDLINE</span><span class="o">=</span><span class="n">dev</span>
<span class="n">CerenkovMinimal</span>
</pre></div>
</div>
</div>
<div class="section" id="examining-full-event-data">
<h2>Examining Full Event Data<a class="headerlink" href="#examining-full-event-data" title="Permalink to this headline">¶</a></h2>
<p>When saving is enabled around 20 NumPy arrays are written for every event.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:~ blyth$ ls -l  /tmp/blyth/opticks/source/evt/g4live/natural/1/*.npy
-rw-r--r--  1 blyth  wheel    144 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLisLabels.npy
-rw-r--r--  1 blyth  wheel     88 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLis.npy
-rw-r--r--  1 blyth  wheel    144 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileAccLabels.npy
-rw-r--r--  1 blyth  wheel     96 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileAcc.npy
-rw-r--r--  1 blyth  wheel     80 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLabels.npy
-rw-r--r--  1 blyth  wheel     80 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfile.npy
-rw-r--r--  1 blyth  wheel     96 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/idom.npy
-rw-r--r--  1 blyth  wheel    128 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/fdom.npy
-rw-r--r--  1 blyth  wheel   2680 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/rs.npy
-rw-r--r--  1 blyth  wheel    340 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/ps.npy
-rw-r--r--  1 blyth  wheel     80 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/wy.npy
-rw-r--r--  1 blyth  wheel     80 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/dg.npy
-rw-r--r--  1 blyth  wheel   1120 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/ph.npy
-rw-r--r--  1 blyth  wheel  10480 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/rx.npy
-rw-r--r--  1 blyth  wheel   4240 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/ox.npy
-rw-r--r--  1 blyth  wheel    368 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/gs.npy
-rw-r--r--  1 blyth  wheel     80 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/hy.npy
-rw-r--r--  1 blyth  wheel    528 Mar 16 15:15 /tmp/blyth/opticks/source/evt/g4live/natural/1/ht.npy
epsilon:~ blyth$
</pre></div>
</div>
<p>The np.py script can be used to dump the shapes of the arrays:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:~ blyth$ np.py /tmp/blyth/opticks/source/evt/g4live/natural/1/*.npy
a :        /tmp/blyth/opticks/source/evt/g4live/natural/1/ox.npy :           (65, 4, 4) : 664a09f7c9df20fd7d7dd2b0f81ba924 : 20210316-1515
b :        /tmp/blyth/opticks/source/evt/g4live/natural/1/ph.npy :           (65, 1, 2) : 34e62cf02f2704c8dfd4416af0669462 : 20210316-1515
c :        /tmp/blyth/opticks/source/evt/g4live/natural/1/ps.npy :           (65, 1, 4) : 9001be6559eaf49850fe8f2f3f327001 : 20210316-1515
d :        /tmp/blyth/opticks/source/evt/g4live/natural/1/rs.npy :       (65, 10, 1, 4) : b97c5cc9f518cfcb77dc0e4d8194fecc : 20210316-1515
e :        /tmp/blyth/opticks/source/evt/g4live/natural/1/rx.npy :       (65, 10, 2, 4) : a4878228712f585f46567e59bde95655 : 20210316-1515
f :        /tmp/blyth/opticks/source/evt/g4live/natural/1/ht.npy :            (7, 4, 4) : be3c6de10d2e706f03a416508cfca316 : 20210316-1515
g :      /tmp/blyth/opticks/source/evt/g4live/natural/1/fdom.npy :            (3, 1, 4) : 098ac4cd701409d36788edcea0d51a31 : 20210316-1515
h :        /tmp/blyth/opticks/source/evt/g4live/natural/1/gs.npy :            (3, 6, 4) : eb7c1b49d19a09e5886b6468a398269f : 20210316-1515
</pre></div>
</div>
<p>These are persisted OpticksEvent. See optickscore/OpticksEvent.cc to follow the details of what everything is.
Opticks has many python analysis scripts that use NumPy to interpret these arrays. However initially
it is useful to use a manual approach to examine the arrays.</p>
<p>Loading photon arrays for first three events:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> <span class="p">;</span> <span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">ox_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/tmp/blyth/opticks/source/evt/g4live/natural/?/ox.npy&quot;</span><span class="p">))</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">ox_paths</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
<span class="p">[</span><span class="s1">&#39;/tmp/blyth/opticks/source/evt/g4live/natural/1/ox.npy&#39;</span><span class="p">,</span>
 <span class="s1">&#39;/tmp/blyth/opticks/source/evt/g4live/natural/2/ox.npy&#39;</span><span class="p">,</span>
 <span class="s1">&#39;/tmp/blyth/opticks/source/evt/g4live/natural/3/ox.npy&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ox_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ox_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ox_paths</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ox_paths</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="p">(</span><span class="mi">71</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="p">(</span><span class="mi">67</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>Dumping the first photon from each event:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span><span class="mf">127.661</span><span class="p">,</span> <span class="o">-</span><span class="mf">35.996</span><span class="p">,</span>  <span class="mf">90.</span>   <span class="p">,</span>   <span class="mf">0.728</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">0.796</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.225</span><span class="p">,</span>   <span class="mf">0.562</span><span class="p">,</span>   <span class="mf">1.</span>   <span class="p">],</span>
       <span class="p">[</span> <span class="o">-</span><span class="mf">0.571</span><span class="p">,</span>   <span class="mf">0.027</span><span class="p">,</span>   <span class="mf">0.82</span> <span class="p">,</span>  <span class="mf">79.028</span><span class="p">],</span>
       <span class="p">[</span>    <span class="n">nan</span><span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">12</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span><span class="mf">136.877</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.657</span><span class="p">,</span>  <span class="mf">90.</span>   <span class="p">,</span>   <span class="mf">0.745</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">0.834</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.059</span><span class="p">,</span>   <span class="mf">0.549</span><span class="p">,</span>   <span class="mf">1.</span>   <span class="p">],</span>
       <span class="p">[</span> <span class="o">-</span><span class="mf">0.552</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.089</span><span class="p">,</span>   <span class="mf">0.829</span><span class="p">,</span>  <span class="mf">79.028</span><span class="p">],</span>
       <span class="p">[</span>    <span class="n">nan</span><span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">13</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span><span class="mf">131.949</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.657</span><span class="p">,</span>  <span class="mf">90.</span>   <span class="p">,</span>   <span class="mf">0.727</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">0.824</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.06</span> <span class="p">,</span>   <span class="mf">0.563</span><span class="p">,</span>   <span class="mf">1.</span>   <span class="p">],</span>
       <span class="p">[</span> <span class="o">-</span><span class="mf">0.566</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.088</span><span class="p">,</span>   <span class="mf">0.819</span><span class="p">,</span>  <span class="mf">79.028</span><span class="p">],</span>
       <span class="p">[</span>    <span class="n">nan</span><span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the last lines contains int32 or uint32 so when viewed as float
will often appear as nan.  The array can be viewed as a different type to see the values of the flags:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span> <span class="mi">1124029005</span><span class="p">,</span> <span class="o">-</span><span class="mi">1039139963</span><span class="p">,</span>  <span class="mi">1119092736</span><span class="p">,</span>  <span class="mi">1060782814</span><span class="p">],</span>
       <span class="p">[</span> <span class="mi">1061935996</span><span class="p">,</span> <span class="o">-</span><span class="mi">1100614914</span><span class="p">,</span>  <span class="mi">1057998924</span><span class="p">,</span>  <span class="mi">1065353216</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mi">1089327308</span><span class="p">,</span>  <span class="mi">1021211713</span><span class="p">,</span>  <span class="mi">1062341336</span><span class="p">,</span>  <span class="mi">1117654571</span><span class="p">],</span>
       <span class="p">[</span>    <span class="o">-</span><span class="mi">196607</span><span class="p">,</span>           <span class="mi">2</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>         <span class="mi">129</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">)</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>     <span class="c1">## control number fomatting</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span><span class="mf">127.66074</span>   <span class="p">,</span> <span class="o">-</span><span class="mf">35.995625</span>  <span class="p">,</span>  <span class="mf">90.</span>        <span class="p">,</span>   <span class="mf">0.7275828</span> <span class="p">],</span>
       <span class="p">[</span>  <span class="mf">0.7963178</span> <span class="p">,</span>  <span class="o">-</span><span class="mf">0.22455975</span><span class="p">,</span>   <span class="mf">0.56165004</span><span class="p">,</span>   <span class="mf">1.</span>        <span class="p">],</span>
       <span class="p">[</span> <span class="o">-</span><span class="mf">0.57103276</span><span class="p">,</span>   <span class="mf">0.02715504</span><span class="p">,</span>   <span class="mf">0.82047796</span><span class="p">,</span>  <span class="mf">79.02767</span>   <span class="p">],</span>
       <span class="p">[</span>         <span class="n">nan</span><span class="p">,</span>   <span class="mf">0.</span>        <span class="p">,</span>   <span class="mf">0.</span>        <span class="p">,</span>   <span class="mf">0.</span>        <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">25</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span><span class="mf">303.0482</span>    <span class="p">,</span> <span class="mf">116.91953</span>   <span class="p">,</span>  <span class="mf">90.</span>        <span class="p">,</span>   <span class="mf">1.5299634</span> <span class="p">],</span>
       <span class="p">[</span>  <span class="mf">0.89899653</span><span class="p">,</span>   <span class="mf">0.34706625</span><span class="p">,</span>   <span class="mf">0.26711446</span><span class="p">,</span>   <span class="mf">1.</span>        <span class="p">],</span>
       <span class="p">[</span> <span class="o">-</span><span class="mf">0.43312532</span><span class="p">,</span>   <span class="mf">0.794904</span>  <span class="p">,</span>   <span class="mf">0.42488822</span><span class="p">,</span>  <span class="mf">64.74065</span>   <span class="p">],</span>
       <span class="p">[</span>         <span class="n">nan</span><span class="p">,</span>   <span class="mf">0.</span>        <span class="p">,</span>   <span class="mf">0.</span>        <span class="p">,</span>   <span class="mf">0.</span>        <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>For plotting of the data use matplotlib for 2d histograms or pyvista for GPU
accelerated plots of 3d data.</p>
</div>
<div class="section" id="examining-hit-data">
<h2>Examining Hit Data<a class="headerlink" href="#examining-hit-data" title="Permalink to this headline">¶</a></h2>
<p>CerenkovMinimal persists OpticksEvent instances from both the Opticks and Geant4 simulations,
the convention of using positive event tags for Opticks (1) and corresponding negated tags for Geant4 (-1) is used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:g4ok blyth$ l /tmp/blyth/opticks/source/evt/g4live/natural/1/*.npy
-rw-r--r--  1 blyth  wheel    144 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLisLabels.npy
-rw-r--r--  1 blyth  wheel     88 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLis.npy
-rw-r--r--  1 blyth  wheel    144 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileAccLabels.npy
-rw-r--r--  1 blyth  wheel     96 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileAcc.npy
-rw-r--r--  1 blyth  wheel   5520 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfileLabels.npy
-rw-r--r--  1 blyth  wheel   1440 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/OpticksProfile.npy
-rw-r--r--  1 blyth  wheel     96 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/idom.npy
-rw-r--r--  1 blyth  wheel    128 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/fdom.npy
-rw-r--r--  1 blyth  wheel   8920 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/rs.npy
-rw-r--r--  1 blyth  wheel    964 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/ps.npy
-rw-r--r--  1 blyth  wheel   3616 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/ph.npy
-rw-r--r--  1 blyth  wheel  35440 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/rx.npy
-rw-r--r--  1 blyth  wheel  14224 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/ox.npy
-rw-r--r--  1 blyth  wheel    176 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/gs.npy
-rw-r--r--  1 blyth  wheel   2896 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/1/ht.npy
epsilon:g4ok blyth$

epsilon:g4ok blyth$ l /tmp/blyth/opticks/source/evt/g4live/natural/-1/*.npy
-rw-r--r--  1 blyth  wheel  14224 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/so.npy
-rw-r--r--  1 blyth  wheel   9552 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/ht.npy
-rw-r--r--  1 blyth  wheel    144 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfileLisLabels.npy
-rw-r--r--  1 blyth  wheel     88 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfileLis.npy
-rw-r--r--  1 blyth  wheel    144 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfileAccLabels.npy
-rw-r--r--  1 blyth  wheel     96 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfileAcc.npy
-rw-r--r--  1 blyth  wheel   5392 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfileLabels.npy
-rw-r--r--  1 blyth  wheel   1408 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/OpticksProfile.npy
-rw-r--r--  1 blyth  wheel     96 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/idom.npy
-rw-r--r--  1 blyth  wheel    128 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/fdom.npy
-rw-r--r--  1 blyth  wheel     80 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/ph.npy
-rw-r--r--  1 blyth  wheel     80 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/rx.npy
-rw-r--r--  1 blyth  wheel     80 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/ox.npy
-rw-r--r--  1 blyth  wheel    176 Jun  7 14:53 /tmp/blyth/opticks/source/evt/g4live/natural/-1/gs.npy
epsilon:g4ok blyth$
</pre></div>
</div>
<p>The Geant4 OpticksEvent instance m_g4evt is mostly empty as full instrumentation is
not used.  But the hit data in ht.npy is present.</p>
<p>As the NPY (NumPy) serialization is used for binary array data the persisted
arrays are easily examined from ipython using NumPy</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>epsilon:bin blyth$ ipython

# import numpy as np      # done within the ipython profile setup

In [1]: ht = np.load(&quot;/tmp/blyth/opticks/source/evt/g4live/natural/1/ht.npy&quot;)

In [2]: ht
Out[2]:
array([[[ 303.0482,  116.9195,   90.    ,    1.53  ],
        [   0.899 ,    0.3471,    0.2671,    1.    ],
        [  -0.4331,    0.7949,    0.4249,   64.7406],
        [      nan,    0.    ,    0.    ,    0.    ]],

       [[ 153.1065,   16.8344,   90.    ,    0.8098],
        [   0.858 ,    0.0946,    0.5049,    1.    ],
        [  -0.4882,    0.4558,    0.7442,  117.8821],
        [      nan,    0.    ,    0.    ,    0.    ]],

...

In [3]: ht.shape
Out[3]: (44, 4, 4)     ## (nhit, 4,4)


In [2]: ht[:,0]    # row 0 : position, time
Out[2]:
array([[ 303.0482,  116.9195,   90.    ,    1.53  ],
       [ 153.1065,   16.8344,   90.    ,    0.8098],
       [ 128.8066,  -28.0179,   90.    ,    0.7245],
       [ 132.6022,  -13.899 ,   90.    ,    0.7302],
       [ 248.9373,   86.2949,   90.    ,    1.2638],
       [ 210.6323,   62.5527,   90.    ,    1.0778],
       [ 129.7702,  -21.9672,   90.    ,    0.7237],
       ...
       [ 127.8584,  -37.3653,   90.    ,    0.7297],
       [ -29.2682,  152.4176,   90.    ,   13.2224],
       [ 135.6495,   -6.84  ,   90.    ,    0.7396],
       [ 128.1061,  -33.5526,   90.    ,    0.7268],
       [ 127.9607,  -43.2016,   90.    ,    0.7367],
       [ 328.9369, -337.5704,   90.    ,    2.1781],
       [ 131.8775,  -65.5113,   90.    ,    0.7834],
       [ 188.6135, -165.1583,   90.    ,    1.2091]], dtype=float32)

In [3]: ht[:,0].shape
Out[3]: (44, 4)


## The nan and wierd values of the flags in the last row when viewed as floats are expected.
## Viewing them as integers is needed, which is easily done with *view*

In [4]: ht.view(np.int32)[:,3]
Out[4]:
array([[      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,     1089],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,     1089],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65],
       [      -3,        0, 67305985,       65]], dtype=int32)

       ## boundary, sensor idx, debug,  history mask


In [12]: &quot;%x&quot; % 67305985
Out[12]: &#39;4030201&#39;     # view in hex
</pre></div>
</div>
</div>
<div class="section" id="meanings-of-the-photon-flags">
<h2>Meanings of the photon flags<a class="headerlink" href="#meanings-of-the-photon-flags" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>p.flags.i.x</dt>
<dd>signed integer boundary index of the last intersection boundary</dd>
<dt>p.flags.u.y</dt>
<dd>sensor index, intended to hold something like a PMT identifier (TODO: revive this)</dd>
<dt>p.flags.u.z</dt>
<dd>debugging bit field, currently 3 of the 4 bytes hold placeholder values</dd>
<dt>p.flags.u.w</dt>
<dd>photon history mask constructed from bitwise OR of state flags for every step of the propagation</dd>
</dl>
<div class="section" id="p-flags-u-z-4-debug-bytes">
<h3>p.flags.u.z : 4 debug bytes<a class="headerlink" href="#p-flags-u-z-4-debug-bytes" title="Permalink to this headline">¶</a></h3>
<p>The entry is used for debugging, currently holding an initial quadrant position code
and 3 placeholder bytes.</p>
<p>optixrap/cu/generate.cu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>491     // initial quadrant
492     uifchar4 c4 ;
493     c4.uchar_.x =
494                   (  p.position.x &gt; 0.f ? QX : 0u )
495                    |
496                   (  p.position.y &gt; 0.f ? QY : 0u )
497                    |
498                   (  p.position.z &gt; 0.f ? QZ : 0u )
499                   ;
500
501     c4.uchar_.y = 2u ;   // 3-bytes up for grabs
502     c4.uchar_.z = 3u ;
503     c4.uchar_.w = 4u ;
504
505     p.flags.f.z = c4.f ;
506
507
</pre></div>
</div>
</div>
<div class="section" id="p-flags-u-w-photon-history-mask">
<h3>p.flags.u.w : photon history mask<a class="headerlink" href="#p-flags-u-w-photon-history-mask" title="Permalink to this headline">¶</a></h3>
<p>Opticks has both C++ and python machinery to interpret the history mask and analyse events</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>In [4]: from opticks.ana.hismask import HisMask

In [5]: hm = HisMask()
[2020-06-17 15:06:41,227] p70385 {__init__            :enum.py   :37} INFO     - parsing $OPTICKS_PREFIX/include/OpticksCore/OpticksPhoton.h
[2020-06-17 15:06:41,227] p70385 {__init__            :enum.py   :39} INFO     - path expands to /usr/local/opticks/include/OpticksCore/OpticksPhoton.h

In [6]: hm.label(65)
Out[6]: &#39;SD|CK&#39;

In [7]: hm.label(1089)
Out[7]: &#39;BR|SD|CK&#39;

In [8]: hm.abbrev.abbr2name
Out[8]:
{&#39;/usr/local/opticks/include/OpticksCore/OpticksFlags_Abbrev.json&#39;: &#39;jsonLoadPath&#39;,
 &#39;AB&#39;: &#39;BULK_ABSORB&#39;,
 &#39;BR&#39;: &#39;BOUNDARY_REFLECT&#39;,
 &#39;BT&#39;: &#39;BOUNDARY_TRANSMIT&#39;,
 &#39;CK&#39;: &#39;CERENKOV&#39;,
 &#39;DR&#39;: &#39;SURFACE_DREFLECT&#39;,
 &#39;FD&#39;: &#39;FABRICATED&#39;,
 &#39;GN&#39;: &#39;G4GUN&#39;,
 &#39;GS&#39;: &#39;GENSTEPSOURCE&#39;,
 &#39;MI&#39;: &#39;MISS&#39;,
 &#39;MY&#39;: &#39;MACHINERY&#39;,
 &#39;NA&#39;: &#39;NAN_ABORT&#39;,
 &#39;NL&#39;: &#39;NATURAL&#39;,
 &#39;PS&#39;: &#39;PRIMARYSOURCE&#39;,
 &#39;RE&#39;: &#39;BULK_REEMIT&#39;,
 &#39;SA&#39;: &#39;SURFACE_ABSORB&#39;,
 &#39;SC&#39;: &#39;BULK_SCATTER&#39;,
 &#39;SD&#39;: &#39;SURFACE_DETECT&#39;,
 &#39;SI&#39;: &#39;SCINTILLATION&#39;,
 &#39;SO&#39;: &#39;EMITSOURCE&#39;,
 &#39;SR&#39;: &#39;SURFACE_SREFLECT&#39;,
 &#39;TO&#39;: &#39;TORCH&#39;,
 &#39;XX&#39;: &#39;BAD_FLAG&#39;}
</pre></div>
</div>
<p>For more detail on the content of Opticks Events and the meanings of the
flags see <em>docs/opticks_event_data.rst</em></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>