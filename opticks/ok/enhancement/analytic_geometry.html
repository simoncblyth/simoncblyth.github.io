
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Analytic Geometry &#8212; Opticks 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Analytic Geometry</a><ul>
<li><a class="reference internal" href="#principal">Principal</a></li>
<li><a class="reference internal" href="#aligning-three-geometries">Aligning three geometries</a></li>
<li><a class="reference internal" href="#containment-box-handling">Containment Box Handling</a></li>
<li><a class="reference internal" href="#gpmt-operation">GPmt Operation</a></li>
<li><a class="reference internal" href="#photocathode">Photocathode</a></li>
<li><a class="reference internal" href="#test-box-debugging">Test Box Debugging</a></li>
<li><a class="reference internal" href="#fixing-box-normals">Fixing box normals</a></li>
<li><a class="reference internal" href="#face-slicing">Face Slicing</a></li>
<li><a class="reference internal" href="#id1">Photocathode</a></li>
<li><a class="reference internal" href="#first-and-second-solids-pyrex-and-contained-vacuum">First and Second Solids, Pyrex and contained vacuum</a></li>
<li><a class="reference internal" href="#tubs-issue-fixed-was-caused-by-cylinder-poking-outside-its-bbox">Tubs Issue FIXED, was caused by cylinder poking outside its bbox</a></li>
<li><a class="reference internal" href="#just-tubs">Just Tubs</a></li>
<li><a class="reference internal" href="#just-tracing-a-single-instance">Just Tracing a single instance</a></li>
<li><a class="reference internal" href="#plumbing-check">Plumbing check</a></li>
<li><a class="reference internal" href="#how-to-optix-intersect-with-csg-solid">How to OptiX intersect with CSG solid ?</a></li>
<li><a class="reference internal" href="#how-to-proceed">How to proceed ?</a></li>
<li><a class="reference internal" href="#detdesc-pmt-is-involved">detdesc PMT is involved</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ok/enhancement/analytic_geometry.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="analytic-geometry">
<h1>Analytic Geometry<a class="headerlink" href="#analytic-geometry" title="Permalink to this headline">¶</a></h1>
<div class="section" id="principal">
<h2>Principal<a class="headerlink" href="#principal" title="Permalink to this headline">¶</a></h2>
<p>Triangle meshes are a convenient initial step to the GPU
as all geometry can be treated with the same code.
Special treatment of important geometry (PMTs) however
is expected to have large performance gains.</p>
<p>Ray intersection with CSG solids boils down to
analytic solving quadratic/cubic polynomials. There is
a technique to handle union intersections by applying boolean operations
to intersection segments of the sub volumes.</p>
</div>
<div class="section" id="aligning-three-geometries">
<h2>Aligning three geometries<a class="headerlink" href="#aligning-three-geometries" title="Permalink to this headline">¶</a></h2>
<p>Actually not 2 but 3 geometries:</p>
<dl class="docutils">
<dt>OpenGL</dt>
<dd><p class="first">GMergedMesh triangulated geometry, to first order only impacts visualization not propagation/tracing,
but the solid identity infomation including boundary indices comes from GMergedMesh.</p>
<p class="last">Geometry is modified by <em>–box</em>  option according to <em>–boxconfig</em>. The orignal instance-1
GMergedMesh is combined with the GSolid fabricated by GTestBox</p>
</dd>
<dt>OptiX Triangulated</dt>
<dd>translation of GMergedMesh triangulated into OptiX</dd>
<dt>OptiX Analytic</dt>
<dd>somewhat manual addon entering via GPmt and created in python by <em>pmt-parts</em></dd>
</dl>
</div>
<div class="section" id="containment-box-handling">
<h2>Containment Box Handling<a class="headerlink" href="#containment-box-handling" title="Permalink to this headline">¶</a></h2>
<p>Actually the parameters of the containment bbox should be obtained from GMergedMesh.1,
it should be enlarged according to input parameter and the resulting gbbox
should then be fed down via GGeo::modifyGeometry to:</p>
<dl class="docutils">
<dt>GTestBox</dt>
<dd>to fabricate the GSolid</dd>
<dt>GPmt</dt>
<dd>to create a <em>Part</em> struct to tack on to the parts buffer</dd>
</dl>
<ul class="simple">
<li>Avoids mal-duplication.</li>
<li>allows pslice to apply to content and not the containment box
(but pslicing is a low level Analytic Part debug thing,
as it cannot be applied at triangulated level)</li>
</ul>
</div>
<div class="section" id="gpmt-operation">
<h2>GPmt Operation<a class="headerlink" href="#gpmt-operation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>reads <em>pmt-parts</em> written float parts buffer, deriving a solid buffer from it
using solid or node indices which are embedded into the parts buffer</li>
<li>these five indices 0:4 hail from the detdesc tree parse of <em>hemi-pmt.xml</em>
and these must match the indices from the GMergedMesh identity buffer</li>
<li>for debug want to skip some solids, eg to see behavior with a solid lump of Pyrex/Vacuum/Bialkali
but at the moment the identity would then be misaligned ?</li>
</ul>
</div>
<div class="section" id="photocathode">
<h2>Photocathode<a class="headerlink" href="#photocathode" title="Permalink to this headline">¶</a></h2>
<p>Geant4/detdesc model is with seperate very thin spherical parts, including
a shared boundary with the inside of the pyrex.</p>
<p>For surface based geometry coincident boundaries are unhealthy, so instead model it
similar to how Pyrex/Vacuum modelling of the pyrex envelope is done.</p>
<p>Again this might entail adding solids, which will mess up identity.  Seems</p>
</div>
<div class="section" id="test-box-debugging">
<h2>Test Box Debugging<a class="headerlink" href="#test-box-debugging" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ggv-box(){
   ggv --box \
        --animtimemax 7 \
        --boxconfig &quot;size=2;boundary=MineralOil/Rock//;&quot; \
        --torchconfig &quot;source=0,0,400;target=0,0,0;radius=150;zenith_azimuth=1,0,1,0&quot; \
         $*
}
</pre></div>
</div>
<ul class="simple">
<li>need to sort out analytic boundary identity labelling, the missers
think they are in Pyrex, when should be MO
[FIXED]</li>
<li>GGeo/GMergedMesh should be orchestrating the analytic PMT for commality,
currently OGeo/GPmt just grabbing from GCache
[FIXED]</li>
<li>where do i set the boundary of the analytic test box ?
again need to bring control of triangulated and analytic together
to avoid confusion
[FIXED]</li>
</ul>
<p>From OptiX point of view there 5 (or 6 with the container) primitives.
These need to line up with the triangulated solids for identity to work.
Each primitive has a small numbers of parts (up to 4).
Total of 16 parts.</p>
<p>When put the container at the end in pmt-parts the material mapping
works better as that aligns with GMergedMesh::combine order.
This is brittle, will fail when slicing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="n">Nov</span><span class="o">-</span><span class="mi">05</span> <span class="mi">19</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mf">49.364081</span><span class="p">]:</span><span class="n">info</span><span class="p">:</span> <span class="n">OGeo</span><span class="p">::</span><span class="n">makeAnalyticGeometry</span> <span class="n">identity</span> <span class="n">buffer</span> <span class="n">BufferId</span>   <span class="o">-</span><span class="mi">1</span> <span class="n">BufferTarget</span>    <span class="mi">0</span> <span class="n">NumBytes</span>      <span class="mi">96</span> <span class="n">ItemSize</span>      <span class="mi">16</span> <span class="n">NumElements</span>       <span class="mi">4</span> <span class="n">NumItems</span>       <span class="mi">6</span> <span class="n">NumElementsTotal</span>      <span class="mi">24</span>

<span class="p">(</span>  <span class="mi">0</span><span class="p">)</span>        <span class="mi">3199</span>          <span class="mi">47</span>          <span class="mi">27</span>           <span class="mi">0</span>
<span class="p">(</span>  <span class="mi">1</span><span class="p">)</span>        <span class="mi">3200</span>          <span class="mi">46</span>          <span class="mi">28</span>           <span class="mi">0</span>
<span class="p">(</span>  <span class="mi">2</span><span class="p">)</span>        <span class="mi">3201</span>          <span class="mi">43</span>          <span class="mi">29</span>           <span class="mi">3</span>
<span class="p">(</span>  <span class="mi">3</span><span class="p">)</span>        <span class="mi">3202</span>          <span class="mi">44</span>          <span class="mi">30</span>           <span class="mi">0</span>
<span class="p">(</span>  <span class="mi">4</span><span class="p">)</span>        <span class="mi">3203</span>          <span class="mi">45</span>          <span class="mi">30</span>           <span class="mi">0</span>
<span class="p">(</span>  <span class="mi">5</span><span class="p">)</span>           <span class="mi">5</span>        <span class="mi">1000</span>         <span class="mi">123</span>           <span class="mi">0</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">05</span> <span class="mi">19</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mf">00.317306</span><span class="p">]</span> <span class="p">[</span><span class="mh">0x000007fff7448031</span><span class="p">]</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>    <span class="n">GBndLib</span><span class="p">::</span><span class="n">dump</span>
 <span class="p">(</span>  <span class="mi">0</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>                   <span class="n">Vacuum</span> <span class="n">om</span><span class="p">:</span>                   <span class="n">Vacuum</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span>
 <span class="o">...</span>
 <span class="p">(</span> <span class="mi">27</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>                    <span class="n">Pyrex</span> <span class="n">om</span><span class="p">:</span>               <span class="n">MineralOil</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span>
 <span class="p">(</span> <span class="mi">28</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>                   <span class="n">Vacuum</span> <span class="n">om</span><span class="p">:</span>                    <span class="n">Pyrex</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span>
 <span class="p">(</span> <span class="mi">29</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>                 <span class="n">Bialkali</span> <span class="n">om</span><span class="p">:</span>                   <span class="n">Vacuum</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span><span class="n">lvPmtHemiCathodeSensorSurface</span>
 <span class="p">(</span> <span class="mi">30</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>             <span class="n">OpaqueVacuum</span> <span class="n">om</span><span class="p">:</span>                   <span class="n">Vacuum</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span>
 <span class="o">...</span>
 <span class="p">(</span><span class="mi">122</span><span class="p">)</span> <span class="n">im</span><span class="p">:</span>                  <span class="n">RadRock</span> <span class="n">om</span><span class="p">:</span>                     <span class="n">Rock</span> <span class="ow">is</span><span class="p">:</span>                          <span class="n">os</span><span class="p">:</span>
</pre></div>
</div>
<p>Implementing container making C++ side ?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>simon:pmt blyth$ ggv --pmt 0:15
[2015-Nov-05 20:44:09.782958]:info: 0:/usr/local/env/optix/ggeo/bin/GPmtTest
[2015-Nov-05 20:44:09.783831]:info: 1:0:15
[2015-Nov-05 20:44:09.784031]:info: NPY::make_slice from 16 -&gt; 15 slice NSlice      0 :    15 :     1
[2015-Nov-05 20:44:09.784205]:info: GPmt::loadFromCache slicing partBuf  origBuf 16,4,4 partBuf 15,4,4
GPmt::make_container pbb min   -101.168   -101.168    -23.838  max    101.168    101.168     56.000
...
GPmt::make_container pbb min    -27.500    -27.500   -164.500  max     27.500     27.500      1.500
GPmt::make_container bb min   -101.168   -101.168   -169.000  max    101.168    101.168    131.000
GPmt::make_container bb factor 3.0  min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
[2015-Nov-05 20:44:09.784475]:info: parts shape: 15,4,4
     0.0000      0.0000     69.0000    102.0000
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>simon:pmt blyth$ ggv --pmt 0:16
[2015-Nov-05 20:44:54.266290]:info: 0:/usr/local/env/optix/ggeo/bin/GPmtTest
[2015-Nov-05 20:44:54.266963]:info: 1:0:16
[2015-Nov-05 20:44:54.267173]:info: NPY::make_slice from 16 -&gt; 16 slice NSlice      0 :    16 :     1
[2015-Nov-05 20:44:54.267336]:info: GPmt::loadFromCache slicing partBuf  origBuf 16,4,4 partBuf 16,4,4
GPmt::make_container pbb min   -101.168   -101.168    -23.838  max    101.168    101.168     56.000
GPmt::make_container pbb min   -101.168   -101.168     56.000  max    101.168    101.168    100.070
GPmt::make_container pbb min    -84.540    -84.540    100.070  max     84.540     84.540    131.000
...
GPmt::make_container pbb min    -98.143    -98.143    -30.000  max     98.143     98.143     56.000
GPmt::make_container pbb min    -97.151    -97.151    -29.000  max     97.151     97.151     56.131
GPmt::make_container pbb min    -27.500    -27.500   -164.500  max     27.500     27.500      1.500
GPmt::make_container pbb min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
GPmt::make_container bb min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
GPmt::make_container bb factor 3.0  min  -2351.168  -2351.168  -2419.000  max   2351.168   2351.168   2381.000
[2015-Nov-05 20:44:54.267608]:info: parts shape: 16,4,4
</pre></div>
</div>
</div>
<div class="section" id="fixing-box-normals">
<h2>Fixing box normals<a class="headerlink" href="#fixing-box-normals" title="Permalink to this headline">¶</a></h2>
<p>After fixing ray box normals, get very pretty Lambertian render of PMT in box with <em>ggv-pmt</em> ie:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ggv-pmt ()
{
    ggv.sh --tracer --restrictmesh 1 --analyticmesh 1 --islice 0 --target 3199 $*
}
</pre></div>
</div>
<p>But the OptiX mode of <em>ggv-box</em> is far less pretty with nasty black faces, thats with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ggv-box ()
{
    ggv --box --animtimemax 7 --boxconfig &quot;size=2;boundary=MineralOil/Rock//;&quot; --torchconfig &quot;source=0,0,400;target=0,0,0;radius=102;zenith_azimuth=1,0,1,0&quot; $*
}
</pre></div>
</div>
<p>Also photon reflections show non-symmetric behaviour, discriminating againt two of the box faces.</p>
<p>How is that possible ?</p>
<ul class="simple">
<li>different code in propagator and tracer ?</li>
<li>different geometry ?</li>
<li>normal issue or iimpinging other geometry ?</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ggv.sh --tracer  --analyticmesh 1 --islice 0 --target 3199 $*
# not restricting to instanced, see pretty render of analytic PMT with no extra box ?

ggv.sh --tracer  --islice 0 --target 3199 $*
# triangulated PMT
</pre></div>
</div>
<p>After fixing <em>ggv-box</em> mismatch, changing to <em>size=3</em> get the pretty render in OptiX mode and symmetric reflections:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ggv-box ()
{
    ggv --box --animtimemax 7 --boxconfig &quot;size=3;boundary=MineralOil/Rock//;&quot; --torchconfig &quot;source=0,0,400;target=0,0,0;radius=102;zenith_azimuth=1,0,1,0&quot; $*
}
</pre></div>
</div>
<ul class="simple">
<li>Explain that ?</li>
<li>Also, still material colors seem wrong.</li>
</ul>
</div>
<div class="section" id="face-slicing">
<h2>Face Slicing<a class="headerlink" href="#face-slicing" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">0</span><span class="p">:</span><span class="mi">720</span>
<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">720</span><span class="p">:</span><span class="mi">1392</span>
<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">1392</span><span class="p">:</span><span class="mi">2352</span>
<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">2352</span><span class="p">:</span><span class="mi">2832</span>
<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">2832</span><span class="p">:</span><span class="mi">2928</span>

    <span class="c1"># selecting faces of single solids, nodeinfo.npy provides the face index ranges</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;GMergedMesh/1/nodeinfo.npy&quot;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">ni</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span> <span class="mi">720</span><span class="p">,</span>  <span class="mi">362</span><span class="p">,</span> <span class="mi">3199</span><span class="p">,</span> <span class="mi">3155</span><span class="p">],</span>
       <span class="p">[</span> <span class="mi">672</span><span class="p">,</span>  <span class="mi">338</span><span class="p">,</span> <span class="mi">3200</span><span class="p">,</span> <span class="mi">3199</span><span class="p">],</span>
       <span class="p">[</span> <span class="mi">960</span><span class="p">,</span>  <span class="mi">482</span><span class="p">,</span> <span class="mi">3201</span><span class="p">,</span> <span class="mi">3200</span><span class="p">],</span>
       <span class="p">[</span> <span class="mi">480</span><span class="p">,</span>  <span class="mi">242</span><span class="p">,</span> <span class="mi">3202</span><span class="p">,</span> <span class="mi">3200</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mi">96</span><span class="p">,</span>   <span class="mi">50</span><span class="p">,</span> <span class="mi">3203</span><span class="p">,</span> <span class="mi">3200</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">uint32</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ni</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">1392</span><span class="p">,</span> <span class="mi">2352</span><span class="p">,</span> <span class="mi">2832</span><span class="p">,</span> <span class="mi">2928</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">uint64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Photocathode<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmt</span><span class="o">-</span><span class="n">parts</span>   <span class="c1"># move to writing full partition file, and pslicing as needed</span>

<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">1392</span><span class="p">:</span><span class="mi">2352</span> <span class="o">--</span><span class="n">pslice</span> <span class="mi">8</span><span class="p">:</span><span class="mi">10</span>

<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">1392</span><span class="p">:</span><span class="mi">2352</span> <span class="o">--</span><span class="n">pslice</span> <span class="mi">8</span><span class="p">:</span><span class="mi">12</span>   <span class="c1"># after add inner spheres</span>
</pre></div>
</div>
</div>
<div class="section" id="first-and-second-solids-pyrex-and-contained-vacuum">
<h2>First and Second Solids, Pyrex and contained vacuum<a class="headerlink" href="#first-and-second-solids-pyrex-and-contained-vacuum" title="Permalink to this headline">¶</a></h2>
<p>OptiX render is as would expect, with pyrex and vacuum very thinly separated,
to make the inner volume visible adjust near to control the ray trace epsilon</p>
<p>OpenGL render not as would expect, much fatter to the back.
As if pushed out by the dynode ?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmt</span><span class="o">-</span><span class="n">parts</span> <span class="mi">0</span><span class="p">:</span><span class="mi">8</span>
<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span> <span class="o">--</span><span class="n">fslice</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1392</span>
</pre></div>
</div>
</div>
<div class="section" id="tubs-issue-fixed-was-caused-by-cylinder-poking-outside-its-bbox">
<h2>Tubs Issue FIXED, was caused by cylinder poking outside its bbox<a class="headerlink" href="#tubs-issue-fixed-was-caused-by-cylinder-poking-outside-its-bbox" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>enable ENDCAP_P only in pmt-/dd.py and regen with</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmt</span><span class="o">-</span><span class="n">parts</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span>
</pre></div>
</div>
<ul class="simple">
<li>setup coloring in cu/pinhole_camera.cu</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100   // BGRA
101   uchar4 color = prd.flag == HP_PCAP_I ? RED :  make_color( prd.result );
</pre></div>
</div>
<ul class="simple">
<li>get expected behavior for outer and inner HP_PCAP_O and HP_PCAP_I</li>
<li>PCAP endcap is to the right(in default initial ggv-pmt viewpoint)</li>
<li>doing the same for QCAP see view dependent shape mis-behaviour, but disabling the
partition_union resetting of bbox avoids it</li>
<li>the problem was the bbox was clipped in at the 3spehere interseciton plane
but ZSize was not changed</li>
<li>from point of view of cylinder rendering the relevant PQ vector is not (0,0,sizeZ)
but rather (0,0,clipped_sizeZ)</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">194</span> <span class="n">static</span> <span class="n">__device__</span>
<span class="mi">195</span> <span class="n">void</span> <span class="n">intersect_ztubs</span><span class="p">(</span><span class="n">quad</span><span class="o">&amp;</span> <span class="n">q0</span><span class="p">,</span> <span class="n">quad</span><span class="o">&amp;</span> <span class="n">q1</span><span class="p">,</span> <span class="n">quad</span><span class="o">&amp;</span> <span class="n">q2</span><span class="p">,</span> <span class="n">quad</span><span class="o">&amp;</span> <span class="n">q3</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint4</span><span class="o">&amp;</span> <span class="n">identity</span> <span class="p">)</span>
<span class="mi">196</span> <span class="p">{</span>
<span class="mi">197</span> <span class="o">/*</span>
<span class="mi">198</span> <span class="n">Position</span> <span class="n">shift</span> <span class="n">below</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">match</span> <span class="n">between</span> <span class="n">different</span> <span class="n">cylinder</span> <span class="n">Z</span> <span class="n">origin</span> <span class="n">conventions</span>
<span class="mi">199</span>
<span class="mi">200</span> <span class="o">*</span> <span class="n">Ericson</span> <span class="n">calc</span> <span class="n">implemented</span> <span class="n">below</span> <span class="n">has</span> <span class="n">cylinder</span> <span class="n">origin</span> <span class="n">at</span> <span class="n">endcap</span> <span class="n">P</span>
<span class="mi">201</span> <span class="o">*</span> <span class="n">detdesc</span><span class="o">/</span><span class="n">G4</span> <span class="n">Tubs</span> <span class="n">has</span> <span class="n">cylinder</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">center</span>
<span class="mi">202</span>
<span class="mi">203</span> <span class="o">*/</span>
<span class="mi">204</span>     <span class="nb">float</span> <span class="n">sizeZ</span> <span class="o">=</span> <span class="n">q1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">x</span> <span class="p">;</span>
<span class="mi">205</span>     <span class="nb">float</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">q0</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">sizeZ</span><span class="o">/</span><span class="mf">2.</span><span class="n">f</span> <span class="p">;</span>
<span class="mi">206</span>     <span class="n">float3</span> <span class="n">position</span> <span class="o">=</span> <span class="n">make_float3</span><span class="p">(</span> <span class="n">q0</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">q0</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">z0</span> <span class="p">);</span>  <span class="o">//</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mf">169.</span>
<span class="mi">207</span>     <span class="nb">float</span> <span class="n">clipped_sizeZ</span> <span class="o">=</span> <span class="n">q3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">q2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">z</span> <span class="p">;</span>
<span class="mi">208</span>
<span class="mi">209</span>     <span class="nb">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">q0</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">w</span> <span class="p">;</span>
<span class="mi">210</span>     <span class="nb">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">q1</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">w</span> <span class="p">;</span>
<span class="mi">211</span>
<span class="mi">212</span>     <span class="nb">bool</span> <span class="n">PCAP</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ENDCAP_P</span> <span class="p">;</span>
<span class="mi">213</span>     <span class="nb">bool</span> <span class="n">QCAP</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ENDCAP_Q</span> <span class="p">;</span>
<span class="mi">214</span>
<span class="mi">215</span>     <span class="o">//</span><span class="n">rtPrintf</span><span class="p">(</span><span class="s2">&quot;intersect_ztubs position </span><span class="si">%10.4f</span><span class="s2"> </span><span class="si">%10.4f</span><span class="s2"> </span><span class="si">%10.4f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="p">);</span>
<span class="mi">216</span>     <span class="o">//</span><span class="n">rtPrintf</span><span class="p">(</span><span class="s2">&quot;intersect_ztubs flags </span><span class="si">%d</span><span class="s2"> PCAP </span><span class="si">%d</span><span class="s2"> QCAP </span><span class="si">%d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">PCAP</span><span class="p">,</span> <span class="n">QCAP</span><span class="p">);</span>
<span class="mi">217</span>
<span class="mi">218</span>     <span class="n">float3</span> <span class="n">m</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">origin</span> <span class="o">-</span> <span class="n">position</span> <span class="p">;</span>
<span class="mi">219</span>     <span class="n">float3</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="p">;</span>
<span class="mi">220</span>     <span class="n">float3</span> <span class="n">d</span> <span class="o">=</span> <span class="n">make_float3</span><span class="p">(</span><span class="mf">0.</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.</span><span class="n">f</span><span class="p">,</span> <span class="n">clipped_sizeZ</span> <span class="p">);</span>
<span class="mi">221</span>
<span class="mi">222</span>     <span class="nb">float</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">radius</span> <span class="p">;</span>
<span class="mi">223</span>     <span class="n">float3</span> <span class="n">dnorm</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="mi">224</span>
</pre></div>
</div>
</div>
<div class="section" id="just-tubs">
<h2>Just Tubs<a class="headerlink" href="#just-tubs" title="Permalink to this headline">¶</a></h2>
<p>Some funny straight lines as rotate around:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmt</span><span class="o">-</span><span class="n">parts</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span>   <span class="c1"># just tubs</span>

<span class="n">ggv</span><span class="o">-</span><span class="n">pmt</span>
</pre></div>
</div>
<p>Either a bug or maybe optical illusion due to:</p>
<ul class="simple">
<li>perspective projection</li>
<li>no depth/inside/outside queues</li>
</ul>
<p>Perhaps Z cut happening in wrong frame ?</p>
<p>TODO:</p>
<ul class="simple">
<li>get orthographic projection working for OptiX raygen</li>
<li>matplotlib projection plot of points of the mesh</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;GMergedMesh/1/vertices.npy&quot;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">v</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([[</span>   <span class="mf">0.</span>   <span class="p">,</span>    <span class="mf">0.</span>   <span class="p">,</span>  <span class="mf">131.</span>   <span class="p">],</span>
       <span class="p">[</span>  <span class="mf">33.905</span><span class="p">,</span>    <span class="mf">0.</span>   <span class="p">,</span>  <span class="mf">126.536</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">32.75</span> <span class="p">,</span>    <span class="mf">8.775</span><span class="p">,</span>  <span class="mf">126.536</span><span class="p">],</span>
       <span class="o">...</span><span class="p">,</span>
       <span class="p">[</span>  <span class="mf">26.563</span><span class="p">,</span>   <span class="o">-</span><span class="mf">7.118</span><span class="p">,</span>    <span class="mf">1.5</span>  <span class="p">],</span>
       <span class="p">[</span>   <span class="mf">0.</span>   <span class="p">,</span>    <span class="mf">0.</span>   <span class="p">,</span>    <span class="mf">1.5</span>  <span class="p">],</span>
       <span class="p">[</span>   <span class="mf">0.</span>   <span class="p">,</span>    <span class="mf">0.</span>   <span class="p">,</span> <span class="o">-</span><span class="mf">164.5</span>  <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="p">(</span><span class="mi">1474</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">ni</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1">## sum of vertices, it matches as these are fixed meshes with no dupes</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">1474</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;GMergedMesh/1/indices.npy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">i</span><span class="o">.</span><span class="n">shape</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="p">(</span><span class="mi">2928</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="mi">720</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="mi">0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="mi">720</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="mi">361</span>

<span class="n">n</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">ni</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="mi">2928</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="mi">720</span><span class="p">])</span><span class="o">.</span><span class="n">size</span>    <span class="c1"># hmm no need for doing indices look up into the vertices, its all contiguous</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="mi">362</span>
</pre></div>
</div>
</div>
<div class="section" id="just-tracing-a-single-instance">
<h2>Just Tracing a single instance<a class="headerlink" href="#just-tracing-a-single-instance" title="Permalink to this headline">¶</a></h2>
<p>Using OTracerTest with the below is much faster than with
full context (including all those propagate buffers) and full geometry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pmt-parts 0:4   # 3sphere + tubs


ggv --tracer --restrictmesh 1 --analyticmesh 1 --islice 0 --target 3199

ggv-pmt    # abbreviation for above

ggv-allpmt --stack $((1024 + 512))      # stack can be reduced a bit with just the tracer


ggv --tracer --restrictmesh 1 --analyticmesh 1

ggv-allpmt
</pre></div>
</div>
</div>
<div class="section" id="plumbing-check">
<h2>Plumbing check<a class="headerlink" href="#plumbing-check" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ggv</span> <span class="o">--</span><span class="n">restrictmesh</span> <span class="mi">1</span> <span class="o">--</span><span class="n">analyticmesh</span> <span class="mi">1</span> <span class="o">--</span><span class="n">torchconfig</span> <span class="s2">&quot;radius=300;frame=3199;source=0,0,1000;target=0,0,0&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-optix-intersect-with-csg-solid">
<h2>How to OptiX intersect with CSG solid ?<a class="headerlink" href="#how-to-optix-intersect-with-csg-solid" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>simon:OptiX_380_sdk blyth$ find . -name &#39;*.cu&#39;  -exec grep -l intersect {} \;
./ambocc/parallelogram.cu
./ambocc/sphere.cu
./buffersOfBuffers/parallelogram.cu
./buffersOfBuffers/sphere_texcoord.cu
./cook/clearcoat.cu
./cook/dof_camera.cu
./cook/parallelogram.cu
./cook/sphere.cu
./cook/sphere_texcoord.cu
./cuda/triangle_mesh.cu
./cuda/triangle_mesh_small.cu
./device_exceptions/device_exceptions.cu
./displacement/geometry_programs.cu
./glass/glass.cu
./glass/triangle_mesh_iterative.cu
./heightfield/heightfield.cu
./hybridShadows/triangle_mesh_fat.cu
./isgReflections/parallelogram.cu
./isgReflections/triangle_mesh_fat.cu
./isgShadows/triangle_mesh_fat.cu
./julia/block_floor.cu
./julia/julia.cu
...

simon:OptiX_380_sdk blyth$ find . -type f -exec grep -l union {} \;
./julia/block_floor.cu
./julia/distance_field.h
</pre></div>
</div>
<p>Julia sample has lots of non-trivial intersection examples</p>
<p>julia/block_floor.cu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">538</span> <span class="n">RT_PROGRAM</span> <span class="n">void</span> <span class="n">intersect</span><span class="p">(</span><span class="nb">int</span> <span class="n">primIdx</span><span class="p">)</span>
<span class="mi">539</span> <span class="p">{</span>
<span class="mi">540</span>   <span class="n">object_factory</span><span class="o">&lt;</span><span class="n">false</span><span class="o">&gt;</span><span class="p">::</span><span class="n">Object</span> <span class="n">obj</span><span class="p">;</span>
<span class="mi">541</span>   <span class="n">object_factory</span><span class="o">&lt;</span><span class="n">false</span><span class="o">&gt;</span><span class="p">::</span><span class="n">make_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">);</span>
<span class="mi">542</span>
<span class="mi">543</span>   <span class="o">//</span> <span class="n">first</span> <span class="n">check</span> <span class="k">for</span> <span class="n">intersection</span> <span class="n">between</span> <span class="n">the</span> <span class="n">ray</span> <span class="ow">and</span> <span class="n">aabb</span>
<span class="mi">544</span>   <span class="n">optix</span><span class="p">::</span><span class="n">Ray</span> <span class="n">tmp_ray</span> <span class="o">=</span> <span class="n">ray</span><span class="p">;</span>
<span class="mi">545</span>   <span class="k">if</span><span class="p">(</span><span class="n">intersect_aabb</span><span class="p">(</span><span class="n">tmp_ray</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">546</span>     <span class="nb">float</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.25e-3</span><span class="n">f</span><span class="p">;</span>
<span class="mi">547</span>     <span class="nb">float</span> <span class="n">max_epsilon</span> <span class="o">=</span> <span class="mf">2.5e-2</span><span class="n">f</span><span class="p">;</span>
<span class="mi">548</span>
<span class="mi">549</span>     <span class="n">float3</span> <span class="n">hit_point</span><span class="p">;</span>
<span class="mi">550</span>     <span class="nb">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">adaptive_sphere_trace</span><span class="o">&lt;</span><span class="mi">1000</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tmp_ray</span><span class="p">,</span> <span class="n">make_distance_to_primitive</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">hit_point</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">max_epsilon</span><span class="p">);</span>
<span class="mi">551</span>     <span class="k">if</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmp_ray</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
<span class="mi">552</span>     <span class="p">{</span>
<span class="mi">553</span>       <span class="k">if</span><span class="p">(</span><span class="n">rtPotentialIntersection</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
<p>julia/distance_field.h:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">216</span> <span class="o">//</span> <span class="n">The</span> <span class="n">union</span> <span class="n">of</span> <span class="n">two</span> <span class="n">primitives</span>
<span class="mi">217</span> <span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">Primitive1</span><span class="p">,</span> <span class="n">typename</span> <span class="n">Primitive2</span><span class="o">&gt;</span>
<span class="mi">218</span>   <span class="k">class</span> <span class="nc">PrimitiveUnion</span>
<span class="mi">219</span> <span class="p">{</span>
<span class="mi">220</span>   <span class="n">public</span><span class="p">:</span>
<span class="mi">221</span>     <span class="o">//</span> <span class="n">null</span> <span class="n">constructor</span> <span class="n">creates</span> <span class="n">an</span> <span class="n">undefined</span> <span class="n">DistanceUnion</span>
<span class="mi">222</span>     <span class="n">HD_DECL</span>
<span class="mi">223</span>     <span class="n">PrimitiveUnion</span><span class="p">(</span><span class="n">void</span><span class="p">){}</span>
<span class="mi">224</span>
<span class="mi">225</span>     <span class="n">HD_DECL</span>
<span class="mi">226</span>     <span class="n">PrimitiveUnion</span><span class="p">(</span><span class="n">Primitive1</span> <span class="n">p1</span><span class="p">,</span> <span class="n">Primitive2</span> <span class="n">p2</span><span class="p">):</span><span class="n">m_prim1</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span><span class="n">m_prim2</span><span class="p">(</span><span class="n">p2</span><span class="p">){}</span>
<span class="mi">227</span>
<span class="mi">228</span>     <span class="n">HD_DECL</span>
<span class="mi">229</span>     <span class="nb">float</span> <span class="n">distance</span><span class="p">(</span><span class="n">const</span> <span class="n">float3</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="n">const</span>
<span class="mi">230</span>     <span class="p">{</span>
<span class="mi">231</span>       <span class="k">return</span> <span class="n">fminf</span><span class="p">(</span><span class="n">m_prim1</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">m_prim2</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="mi">232</span>     <span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
<p>shadeTree/parallelogram.cu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">37</span> <span class="n">RT_PROGRAM</span> <span class="n">void</span> <span class="n">intersect</span><span class="p">(</span><span class="nb">int</span> <span class="n">primIdx</span><span class="p">)</span>
<span class="mi">38</span> <span class="p">{</span>
<span class="mi">39</span>   <span class="n">float3</span> <span class="n">n</span> <span class="o">=</span> <span class="n">make_float3</span><span class="p">(</span> <span class="n">plane</span> <span class="p">);</span>
<span class="mi">40</span>   <span class="nb">float</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">n</span> <span class="p">);</span>
<span class="mi">41</span>   <span class="nb">float</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span>
<span class="mi">42</span>   <span class="k">if</span><span class="p">(</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">ray</span><span class="o">.</span><span class="n">tmin</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">ray</span><span class="o">.</span><span class="n">tmax</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">43</span>     <span class="n">float3</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
<span class="mi">44</span>     <span class="n">float3</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">;</span>
<span class="mi">45</span>     <span class="nb">float</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">vi</span><span class="p">);</span>
<span class="mi">46</span>     <span class="k">if</span><span class="p">(</span><span class="n">a1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">a1</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
<span class="mi">47</span>       <span class="nb">float</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">vi</span><span class="p">);</span>
<span class="mi">48</span>       <span class="k">if</span><span class="p">(</span><span class="n">a2</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">a2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
<span class="mi">49</span>         <span class="k">if</span><span class="p">(</span> <span class="n">rtPotentialIntersection</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">50</span>           <span class="n">geometric_normal</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<span class="mi">51</span>           <span class="n">shading_normal</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<span class="mi">52</span>           <span class="n">uv</span> <span class="o">=</span> <span class="n">make_float2</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
<span class="mi">53</span>           <span class="n">rtReportIntersection</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
<span class="mi">54</span>         <span class="p">}</span>
<span class="mi">55</span>       <span class="p">}</span>
<span class="mi">56</span>     <span class="p">}</span>
<span class="mi">57</span>   <span class="p">}</span>
<span class="mi">58</span> <span class="p">}</span>
</pre></div>
</div>
<p>tutorial.cpp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">238</span> <span class="n">float4</span> <span class="n">make_plane</span><span class="p">(</span> <span class="n">float3</span> <span class="n">n</span><span class="p">,</span> <span class="n">float3</span> <span class="n">p</span> <span class="p">)</span>
<span class="mi">239</span> <span class="p">{</span>
<span class="mi">240</span>   <span class="n">n</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="mi">241</span>   <span class="nb">float</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="mi">242</span>   <span class="k">return</span> <span class="n">make_float4</span><span class="p">(</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="p">);</span>
<span class="mi">243</span> <span class="p">}</span>
</pre></div>
</div>
<p>tutorial10.cu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>313 //
314 // Intersection program for programmable convex hull primitive
///
///     https://en.wikipedia.org/wiki/Line–plane_intersection
///     http://geomalgorithms.com/index.html
///
315 //
316 rtBuffer&lt;float4&gt; planes;
317 RT_PROGRAM void chull_intersect(int primIdx)
318 {
319   int n = planes.size();
320   float t0 = -FLT_MAX;
321   float t1 = FLT_MAX;
322   float3 t0_normal = make_float3(0);
323   float3 t1_normal = make_float3(0);
324   for(int i = 0; i &lt; n &amp;&amp; t0 &lt; t1; ++i ) {
325     float4 plane = planes[i];
326     float3 n = make_float3(plane);
327     float  d = plane.w;
328
329     float denom = dot(n, ray.direction);
330     float t = -(d + dot(n, ray.origin))/denom;
///
///  Plane eqn, p0 is point in plane, n is normal
///     (p - p0).n = 0
///
///  Line
///      p = ray.origin + t * ray.direction
///
///  Intersect
///
///    (ray.origin + t * ray.direction - p0 ).n = 0
///
///     dot(n, ray.origin) + t * dot(n, ray.direction) - dot(p0, n) = 0
///
///                  dot(p0,n) - dot(n, ray.origin)
///            t =  --------------------------------
///                     dot(n, ray.direction)
///
///

331     if( denom &lt; 0){
332       // enter
333       if(t &gt; t0){
334         t0 = t;
335         t0_normal = n;
336       }
337     } else {
338       //exit
339       if(t &lt; t1){
340         t1 = t;
341         t1_normal = n;
342       }
343     }
344   }
345
346   if(t0 &gt; t1)
347     return;
348
349   if(rtPotentialIntersection( t0 )){
350     shading_normal = geometric_normal = t0_normal;
351     rtReportIntersection(0);
352   } else if(rtPotentialIntersection( t1 )){
353     shading_normal = geometric_normal = t1_normal;
354     rtReportIntersection(0);
355   }
356 }
</pre></div>
</div>
</div>
<div class="section" id="how-to-proceed">
<h2>How to proceed ?<a class="headerlink" href="#how-to-proceed" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>on revisiting G4DAE include GDML G4 CSG model description together
with the triangulated COLLADA</li>
</ul>
</div>
<div class="section" id="detdesc-pmt-is-involved">
<h2>detdesc PMT is involved<a class="headerlink" href="#detdesc-pmt-is-involved" title="Permalink to this headline">¶</a></h2>
<p>Complicated assemblies of CSG solids. Implementing analytic is non-trivial.</p>
<p>G5:/home/blyth/local/env/dyb/NuWa-trunk/dybgaudi/Detector/XmlDetDesc/DDDB/PMT/geometry.xml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">08</span>   <span class="o">&lt;</span><span class="n">catalog</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PMT&quot;</span><span class="o">&gt;</span>
<span class="mi">09</span>
<span class="mi">10</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemiFrame&quot;</span><span class="o">/&gt;</span>
<span class="mi">11</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemi&quot;</span><span class="o">/&gt;</span>
<span class="mi">12</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemiwPmtHolder&quot;</span><span class="o">/&gt;</span>
<span class="mi">13</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvAdPmtCollar&quot;</span><span class="o">/&gt;</span>
<span class="mi">14</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemiCathode&quot;</span><span class="o">/&gt;</span>
<span class="mi">15</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemiVacuum&quot;</span><span class="o">/&gt;</span>
<span class="mi">16</span>     <span class="o">&lt;</span><span class="n">logvolref</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;hemi-pmt.xml#lvPmtHemiBottom&quot;</span><span class="o">/&gt;</span>
<span class="o">..</span>
</pre></div>
</div>
<p>dybgaudi/Detector/XmlDetDesc/DDDB/PMT/hemi-pmt.xml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>37   &lt;!-- The PMT glass --&gt;
38   &lt;logvol name=&quot;lvPmtHemi&quot; material=&quot;Pyrex&quot;&gt;
39     &lt;union name=&quot;pmt-hemi&quot;&gt;
40       &lt;intersection name=&quot;pmt-hemi-glass-bulb&quot;&gt;
41           &lt;sphere name=&quot;pmt-hemi-face-glass&quot;
42                 outerRadius=&quot;PmtHemiFaceROC&quot;/&gt;
43
44           &lt;sphere name=&quot;pmt-hemi-top-glass&quot;
45                outerRadius=&quot;PmtHemiBellyROC&quot;/&gt;
46           &lt;posXYZ z=&quot;PmtHemiFaceOff-PmtHemiBellyOff&quot;/&gt;
47
48           &lt;sphere name=&quot;pmt-hemi-bot-glass&quot;
49                 outerRadius=&quot;PmtHemiBellyROC&quot;/&gt;
50           &lt;posXYZ z=&quot;PmtHemiFaceOff+PmtHemiBellyOff&quot;/&gt;
51
52       &lt;/intersection&gt;
53       &lt;tubs name=&quot;pmt-hemi-base&quot;
54         sizeZ=&quot;PmtHemiGlassBaseLength&quot;
55         outerRadius=&quot;PmtHemiGlassBaseRadius&quot;/&gt;
56       &lt;posXYZ z=&quot;-0.5*PmtHemiGlassBaseLength&quot;/&gt;
57     &lt;/union&gt;
58
59     &lt;physvol name=&quot;pvPmtHemiVacuum&quot;
60          logvol=&quot;/dd/Geometry/PMT/lvPmtHemiVacuum&quot;/&gt;
61
62   &lt;/logvol&gt;
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>118   &lt;!-- The Photo Cathode --&gt;
119   &lt;!-- use if limit photocathode to a face on diameter gt 167mm. --&gt;
120   &lt;logvol name=&quot;lvPmtHemiCathode&quot; material=&quot;Bialkali&quot; sensdet=&quot;DsPmtSensDet&quot;&gt;
121     &lt;union name=&quot;pmt-hemi-cathode&quot;&gt;
122       &lt;sphere name=&quot;pmt-hemi-cathode-face&quot;
123           outerRadius=&quot;PmtHemiFaceROCvac&quot;
124           innerRadius=&quot;PmtHemiFaceROCvac-PmtHemiCathodeThickness&quot;
125           deltaThetaAngle=&quot;PmtHemiFaceCathodeAngle&quot;/&gt;
126       &lt;sphere name=&quot;pmt-hemi-cathode-belly&quot;
127           outerRadius=&quot;PmtHemiBellyROCvac&quot;
128           innerRadius=&quot;PmtHemiBellyROCvac-PmtHemiCathodeThickness&quot;
129           startThetaAngle=&quot;PmtHemiBellyCathodeAngleStart&quot;
130           deltaThetaAngle=&quot;PmtHemiBellyCathodeAngleDelta&quot;/&gt;
131       &lt;posXYZ z=&quot;PmtHemiFaceOff-PmtHemiBellyOff&quot;/&gt;
132     &lt;/union&gt;
133   &lt;/logvol&gt;
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Opticks 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>