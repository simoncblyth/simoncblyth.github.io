<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>[MAYBE FIXED] Cannot Add Extra Errors &mdash; Heprez Unversioned directory documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Unversioned directory',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Heprez Unversioned directory documentation" href="../../" />
    <link rel="up" title="porting" href="../" />
    <link rel="next" title="Indices Compare No Backups" href="../indices_compare_no_backup/" />
    <link rel="prev" title="[DEFER] No Qtys in range" href="../no_qtys_in_range/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../indices_compare_no_backup/" title="Indices Compare No Backups"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../no_qtys_in_range/" title="[DEFER] No Qtys in range"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Heprez Unversioned directory documentation</a> &raquo;</li>
          <li><a href="../" accesskey="U">porting</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> /e </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">/h</a>   </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/"> cms01 </a> </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/downloads/"> downloads </a> </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/rezdb/db/hfagc/"> rezdb/db/hfagc/ </a> </li>
</ul>






<h3>Content Skeleton</h3>

<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SOP/">SOP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/end_of_2011/">LOG</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../heprez/">HEPREZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../heprez/#heprez-usage-log">HEPREZ USAGE LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rezdb/">REZDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../compilation/">Compilation latex document</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../docs/math/">Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hepex/hepex/">Hepex Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../future/">Future of b2c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment/">Environment for heprez installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chiba/">Chiba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chibatomcat/chibatomcat/">CHIBA TOMCAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batik/">Batik</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inkscape/">Inkscape</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dvisvgm/">DVISVGM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../images/">Binary Image creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backup/backup/">Partial Backup Machinery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backup/part/build/">BACKUP ANT BUILD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exist_/">LOW LEVEL EXIST USAGE FUNCTIONS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exist/">exist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../macports/">macports</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">porting</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../kek/">KEK Port Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../b2mc_install/">b2mc installation notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scrape_iteration/">Scrape Interation on b2mc without Illustrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../broken_plot_splitting/">Broken Plot Splitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../empty_unit_error/">empty unit error</a></li>
<li class="toctree-l2"><a class="reference internal" href="../no_qtys_in_range/">[DEFER] No Qtys in range</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">[MAYBE FIXED] Cannot Add Extra Errors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reproduce-in-test-environment">Reproduce in test environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#understanding-why">Understanding why</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examine-the-xml">Examine the XML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-new-resource">Create new resource</a></li>
<li class="toctree-l4"><a class="reference internal" href="#source-check">Source check</a></li>
<li class="toctree-l4"><a class="reference internal" href="#thoughts">Thoughts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rezdb-create-button">rezdb create button</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chiba-access-to-instances-of-individual-quotes-or-headers">chiba access to instances of individual quotes or headers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#where-the-spares-come-from">where the spares come from</a></li>
<li class="toctree-l4"><a class="reference internal" href="#possible-solution">Possible Solution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#where-do-these-stylesheets-get-uploaded-to-xmldb">Where do these stylesheets get uploaded to xmldb ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#need-to-protect-chiba-from-the-namespaces">need to protect chiba from the namespaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-exist-chiba-on-cms01">update exist/chiba on cms01</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../indices_compare_no_backup/">Indices Compare No Backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other/">Other issues and feature ideas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../server_migration/">Server Migration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../eperl/">eperl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svg/">svg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scrape/">scrape</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/porting/cannot_add_extra_errors.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../no_qtys_in_range/"
                        title="previous chapter">[DEFER] No Qtys in range</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../indices_compare_no_backup/"
                        title="next chapter">Indices Compare No Backups</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="maybe-fixed-cannot-add-extra-errors">
<h1>[MAYBE FIXED] Cannot Add Extra Errors<a class="headerlink" href="#maybe-fixed-cannot-add-extra-errors" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference external" href="http://130.87.106.59:8080/rezdb/db/hfagc/cdf/cdfyasmine/cdf_fall2012_Bs2DsDs.xml">http://130.87.106.59:8080/rezdb/db/hfagc/cdf/cdfyasmine/cdf_fall2012_Bs2DsDs.xml</a><ul>
<li>cannot add extra errors issue, <a class="reference external" href="http://cms01.phys.ntu.edu.tw/rezdb/db/hfagc/cdf/cdfyasmine/cdf_fall2012_Bs2DsDs.xml">http://cms01.phys.ntu.edu.tw/rezdb/db/hfagc/cdf/cdfyasmine/cdf_fall2012_Bs2DsDs.xml</a></li>
</ul>
</li>
</ul>
<div class="section" id="reproduce-in-test-environment">
<h2>Reproduce in test environment<a class="headerlink" href="#reproduce-in-test-environment" title="Permalink to this headline">¶</a></h2>
<p>Login as guest to /db/test</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://130.87.106.59:8080/rezdb/db/test/">http://130.87.106.59:8080/rezdb/db/test/</a></li>
<li>replace default template <cite>/db/stylesheets/rez-instance-template.xml</cite> with <cite>/db/hfagc/cdf/cdfyasmine/cdf_fall2012_Bs2DsDs.xml</cite></li>
<li>change default resource name from something.xml to cdf_fall2012_Bs2DsDs.xml</li>
<li>hit create</li>
<li>edit the newly created test resource</li>
<li>the Xerrors/Xerr &#8220;Append&#8221; button does nothing</li>
</ol>
</div>
<div class="section" id="understanding-why">
<h2>Understanding why<a class="headerlink" href="#understanding-why" title="Permalink to this headline">¶</a></h2>
<div class="section" id="examine-the-xml">
<h3>Examine the XML<a class="headerlink" href="#examine-the-xml" title="Permalink to this headline">¶</a></h3>
<p>Raw xml shows a closed tags for <a class="reference external" href="http://130.87.106.59:8080/xmldb/db/test/cdf_fall2012_Bs2DsDs.xml">http://130.87.106.59:8080/xmldb/db/test/cdf_fall2012_Bs2DsDs.xml</a>:</p>
<div class="highlight-python"><pre>&lt;rez:xerrors/&gt;</pre>
</div>
<p>In contrast the <a class="reference external" href="http://130.87.106.59:8080/xmldb/db/stylesheets/rez-instance-template.xml">http://130.87.106.59:8080/xmldb/db/stylesheets/rez-instance-template.xml</a> has a placeholder:</p>
<div class="highlight-python"><pre>&lt;xerrors&gt;
    &lt;xerr&gt;
        &lt;errname&gt;model&lt;/errname&gt;
        &lt;type&gt;absolute&lt;/type&gt;
        &lt;symm&gt;0.2&lt;/symm&gt;
        &lt;plus/&gt;
        &lt;minus/&gt;
    &lt;/xerr&gt;
&lt;/xerrors&gt;</pre>
</div>
</div>
<div class="section" id="create-new-resource">
<h3>Create new resource<a class="headerlink" href="#create-new-resource" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Create <cite>test_xerror_adding.xml</cite> using the default template</p>
</li>
<li><p class="first">the 3rd error:model shows up</p>
</li>
<li><p class="first">delete the Xerror and submit, gets you to:</p>
<div class="highlight-python"><pre>&lt;rez:xerrors/&gt;</pre>
</div>
</li>
<li><p class="first">thus only get a chance to set the Xerror at creation, and if you delete there is no way to get it back</p>
</li>
<li><p class="first">try deleting the syst:</p>
<div class="highlight-python"><pre>&lt;rez:errors&gt;
    &lt;rez:err&gt;
        &lt;rez:errname&gt;stat&lt;/rez:errname&gt;
        &lt;rez:type&gt;absolute&lt;/rez:type&gt;
        &lt;rez:symm/&gt;
        &lt;rez:plus&gt;1.3&lt;/rez:plus&gt;
        &lt;rez:minus&gt;1.4&lt;/rez:minus&gt;
    &lt;/rez:err&gt;
&lt;/rez:errors&gt;</pre>
</div>
</li>
<li><p class="first">and then the stat:</p>
<div class="highlight-python"><pre>&lt;rez:errors/&gt;
&lt;rez:xerrors/&gt;</pre>
</div>
</li>
<li><p class="first">same issue : cannot append once down to zero</p>
</li>
<li><p class="first">try with mode specification, deleting the Prod down to zero:</p>
<div class="highlight-python"><pre>&lt;rez:mode&gt;
    &lt;rez:src&gt;-511&lt;/rez:src&gt;
    &lt;rez:qwn&gt;BR&lt;/rez:qwn&gt;
    &lt;rez:ccimpl&gt;on&lt;/rez:ccimpl&gt;
    &lt;rez:mtag&gt;BR:-511:&lt;/rez:mtag&gt;
&lt;/rez:mode&gt;</pre>
</div>
</li>
<li><p class="first">in contrast this works, can create a prod out of nothing:</p>
<div class="highlight-python"><pre>&lt;rez:mode&gt;
&lt;rez:src&gt;-511&lt;/rez:src&gt;
&lt;rez:prod&gt;111&lt;/rez:prod&gt;
&lt;rez:qwn&gt;BR&lt;/rez:qwn&gt;
&lt;rez:ccimpl&gt;on&lt;/rez:ccimpl&gt;
&lt;rez:mtag&gt;BR:-511:111&lt;/rez:mtag&gt;
&lt;/rez:mode&gt;</pre>
</div>
</li>
<li><p class="first">a prod is very simple though, just an element with a code</p>
</li>
</ol>
</div>
<div class="section" id="source-check">
<h3>Source check<a class="headerlink" href="#source-check" title="Permalink to this headline">¶</a></h3>
<p>Check how the xforms are customized</p>
<ul class="simple">
<li>h/chiba/xsd2xhtml/build.xml</li>
</ul>
<div class="highlight-python"><pre>290              &lt;!-- correct the empty repeat problem --&gt;
291             &lt;filter token="begin.empty.fix" value="${close}" /&gt;
292             &lt;filter token="end.empty.fix"   value="${open}" /&gt;</pre>
</div>
<div class="highlight-python"><pre>b2mc:xslxsd heprez$ vi fix-form-3.xsl
b2mc:xslxsd heprez$ pwd
/Users/heprez/h/chiba/xsd2xhtml/src/xslxsd</pre>
</div>
<div class="highlight-python"><pre>410    &lt;!--
411         handle the empty repeat problem
412        as is done in actions.xhtml , by a constraint to skip the last
413        and by a preparation of the instance to stick a blank last entry in
414        the repeat ...
415
416        the instances created will then need post-processing to regain standard
417        mode order and skip the last entry
418
419        diddle the preexisting repeat nodeset to skip the last , and include
420        another that works with append
421
422        this works for simple repeats like src and prod, but whatabout quote
423        and errors xerrors
424
425
426        doing an append and then a delete screws up the index somehow , seems
427        ok when all full
428
429    --&gt;</pre>
</div>
<div class="highlight-python"><pre>464    &lt;!--
465   &lt;xsl:template match="xforms:bind" &gt;
466        &lt;xsl:element name="xforms:bind" &gt;
467            &lt;xsl:apply-templates select="@*|node()" /&gt;
468         &lt;/xsl:element&gt;
469    &lt;/xsl:template&gt;
470    --&gt;
471
472    &lt;!--  begin.empty.fix(bind) @begin.empty.fix@
473    &lt;xsl:template match="xforms:bind[@xforms:nodeset='rez:src'
474                                  or @xforms:nodeset='rez:prod'
475                                  or @xforms:nodeset='rez:mode'
476                                  or @xforms:nodeset='rez:err'
477                                  or @xforms:nodeset='rez:xerr'
478                                  or @xforms:nodeset='rez:quote'
479                                  ]" &gt;
480
481         &lt;xsl:variable name="bid"      select="@xforms:id"/&gt;
482         &lt;xsl:variable name="bnodeset" select="substring-after(@xforms:nodeset,'rez:')" /&gt;
483
484         &lt;xsl:comment&gt; add empty bind , allowing append &lt;/xsl:comment&gt;
485         &lt;xsl:element name="xforms:bind" &gt;
486              &lt;xsl:attribute name="dbg" &gt;&lt;xsl:value-of select="$bid" /&gt;&lt;/xsl:attribute&gt;
487              &lt;xsl:attribute name="id" &gt;&lt;xsl:value-of select="concat('empty-',$bid)" /&gt; &lt;/xsl:attribute&gt;
488              &lt;xsl:attribute name="nodeset" &gt;&lt;xsl:value-of select="$bnodeset" /&gt; &lt;/xsl:attribute&gt;
489         &lt;/xsl:element&gt;
490
491         &lt;xsl:comment&gt;
492             modify the nodeset to skip the last in order to have a spare when
493             delete all visible NB cannot copy as need to process nested binds
494             the relevant seems not to do anything
495         &lt;/xsl:comment&gt;
496         &lt;xsl:element name="xforms:bind" &gt;
497              &lt;xsl:attribute name="nodeset" &gt;&lt;xsl:value-of select="concat($bnodeset,'[position()!=last()]')" /&gt; &lt;/xsl:attribute&gt;
498              &lt;xsl:attribute name="relevant" &gt;&lt;xsl:value-of select="concat('count(../',$bnodeset,') &amp;gt; 1')"/&gt;&lt;/xsl:attribute&gt;
499              &lt;xsl:for-each select="@*[local-name()!='nodeset' and local-name()!='relevant' ] " &gt;
500                  &lt;xsl:copy/&gt;
501              &lt;/xsl:for-each&gt;
502              &lt;xsl:apply-templates select="*" /&gt;
503         &lt;/xsl:element&gt;
504
505         &lt;xsl:comment&gt; following the magic incantation of actions.xhtml &lt;/xsl:comment&gt;
506         &lt;xsl:element name="xforms:bind" &gt;
507               &lt;xsl:attribute name="dbg" &gt;&lt;xsl:value-of select="$bid" /&gt;&lt;/xsl:attribute&gt;
508               &lt;xsl:attribute name="id" &gt;&lt;xsl:value-of select="concat('insert-',$bid)" /&gt; &lt;/xsl:attribute&gt;
509               &lt;xsl:attribute name="nodeset" &gt;&lt;xsl:value-of select="$bnodeset"/&gt;&lt;/xsl:attribute&gt;
510               &lt;xsl:attribute name="readonly" &gt;&lt;xsl:value-of select="concat('count(../',$bnodeset,') = 1')"/&gt;&lt;/xsl:attribute&gt;
511         &lt;/xsl:element&gt;
512    &lt;/xsl:template&gt;
513   @end.empty.fix@  end.empty.fix (bind)  --&gt;
514
515
516    &lt;!--
517        add "Append" button before the "Insert after selected" button
518        and set a bind attribute on the insert after selected according to the
519        actions.xhtml example
520    --&gt;
521
522  &lt;!--  begin.empty.fix(group) @begin.empty.fix@
523  &lt;xsl:template match="xforms:group[
524                                 ./xforms:label='Src'
525                              or ./xforms:label='Prod'
526                              or ./xforms:label='Mode'
527                              or ./xforms:label='Err'
528                              or ./xforms:label='Xerr'
529                              or ./xforms:label='Quote'
530                                     ]/xforms:trigger[./xforms:label='Insert after selected']"&gt;
531
532
533        &lt;xsl:variable name="bbind" select="./xforms:action/xforms:insert/@xforms:bind"/&gt;
534        &lt;xforms:trigger&gt;
535             &lt;xforms:label&gt;Append&lt;/xforms:label&gt;
536             &lt;xforms:hint&gt;appends a new entry at the end of this collection&lt;/xforms:hint&gt;
537             &lt;xforms:action&gt;
538                 &lt;xforms:insert&gt;
539                     &lt;xsl:attribute name="bind"&gt;&lt;xsl:value-of select="concat('empty-',$bbind)" /&gt;&lt;/xsl:attribute&gt;
540                     &lt;xsl:attribute name="xforms:at"&gt;last() - 1&lt;/xsl:attribute&gt;
541                     &lt;xsl:attribute name="position"&gt;after&lt;/xsl:attribute&gt;
542                 &lt;/xforms:insert&gt;
543             &lt;/xforms:action&gt;
544        &lt;/xforms:trigger&gt;
545
546        &lt;xsl:element name="xforms:trigger" &gt;
547              &lt;xsl:attribute name="bind"&gt;&lt;xsl:value-of select="concat('insert-',$bbind)" /&gt;&lt;/xsl:attribute&gt;
548              &lt;xsl:for-each select="@*[local-name()!='bind']" &gt;
549                  &lt;xsl:copy/&gt;
550              &lt;/xsl:for-each&gt;
551              &lt;xsl:for-each select="*" &gt;
552                   &lt;xsl:copy-of select="."  /&gt;
553              &lt;/xsl:for-each&gt;
554         &lt;/xsl:element&gt;
555
556    &lt;/xsl:template&gt;
557    @end.empty.fix@ end.empty.fix(group) --&gt;
558</pre>
</div>
</div>
<div class="section" id="thoughts">
<h3>Thoughts<a class="headerlink" href="#thoughts" title="Permalink to this headline">¶</a></h3>
<p>The real fix requires more knowledge of chiba xforms (an obsolete project) that I care to acquire,
but some kind of workaround stylesheet that can be applied to a quote from the rezdb interface to add back
empties seems that it might be easily tractable.</p>
<p>Maybe apply a stylesheet transform at creation from template that fills in empties.</p>
</div>
<div class="section" id="rezdb-create-button">
<h3>rezdb create button<a class="headerlink" href="#rezdb-create-button" title="Permalink to this headline">¶</a></h3>
<p>The rezdb interface is implemented in xquery and xtylesheets, the heart is the xquery.</p>
<ul class="simple">
<li><cite>h/hfag/mods/webapp/hfagc/bookinfo-insert-sm.xq</cite></li>
</ul>
<p>Submission from the chiba xforms POSTS to the rezdb instance page:</p>
<div class="highlight-python"><pre>&lt;xforms:submission xforms:action="/rezdb{$doc}?elem={$elem}&amp;amp;action={$action}&amp;amp;start={$start}&amp;amp;otart={$otart}&amp;amp;howmany={$howmany}&amp;amp;user={$user}&amp;amp;pass={$pass}" id="submission_0" xforms:method="post"/&gt;</pre>
</div>
</div>
<div class="section" id="chiba-access-to-instances-of-individual-quotes-or-headers">
<h3>chiba access to instances of individual quotes or headers<a class="headerlink" href="#chiba-access-to-instances-of-individual-quotes-or-headers" title="Permalink to this headline">¶</a></h3>
<p>From <cite>hfag/mods/webapp/hfagc/sitemap.xmap.template</cite>:</p>
<div class="highlight-python"><pre>703              &lt;map:match  pattern="provide-instance.xq"&gt;
704                  &lt;map:generate src="provide-instance.xq" type="xquery" label="sauce"  /&gt;
705                  &lt;map:transform src="xmldb:exist:///db/stylesheets/no-ns-one-spare-no-exre.xsl" /&gt;
706                  &lt;map:select type="request-parameter" &gt;
707                        &lt;map:parameter name="parameter-name" value="strip" /&gt;
708                        &lt;map:when test="yes" &gt;
709                             &lt;map:transform src="context://hfagc/stylesheets/strip.xsl" /&gt;
710                        &lt;/map:when&gt;
711                        &lt;map:otherwise&gt;
712                        &lt;/map:otherwise&gt;
713                   &lt;/map:select&gt;
714                   &lt;map:serialize type="xml"/&gt;
715              &lt;/map:match&gt;</pre>
</div>
<p>Use <strong>cocoon-view=sauce</strong> to see the generator output:</p>
<div class="highlight-python"><pre>b2mc:h heprez$ curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/test_xerror_adding.xml&amp;cocoon-view=sauce" | xmllint --format -
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;exist:result xmlns:exist="http://exist.sourceforge.net/NS/exist" hash="ixml:content-hash:-511111BRonBR:-511:111active-5.30.00001-BR:-511:111"&gt;
  &lt;rez:quote xmlns:rez="http://hfag.phys.ntu.edu.tw/hfagc/rez" exist:id="25" exist:source="/db/test/test_xerror_adding.xml" mode="pro" time="2013-07-15T18:21:35.841+0900" stamp="1373880095841" stamp_hash="ixml:content-hash:-511111BRonBR:-511:111active-5.30.00001-BR:-511:111" stamp_id="25" stamp_source="/db/test/test_xerror_adding.xml"&gt;
    &lt;rez:mode&gt;
      &lt;rez:src&gt;-511&lt;/rez:src&gt;
      &lt;rez:prod&gt;111&lt;/rez:prod&gt;
      &lt;rez:qwn&gt;BR&lt;/rez:qwn&gt;
      &lt;rez:ccimpl&gt;on&lt;/rez:ccimpl&gt;
      &lt;rez:mtag&gt;BR:-511:111&lt;/rez:mtag&gt;
    &lt;/rez:mode&gt;
    &lt;rez:status&gt;active&lt;/rez:status&gt;
    &lt;rez:pdg&gt;-&lt;/rez:pdg&gt;
    &lt;rez:title/&gt;
    &lt;rez:comment/&gt;
    &lt;rez:value&gt;
      &lt;rez:number&gt;5.3&lt;/rez:number&gt;
      &lt;rez:unit&gt;0.00001&lt;/rez:unit&gt;
      &lt;rez:signif/&gt;
      &lt;rez:ltype&gt;-&lt;/rez:ltype&gt;
      &lt;rez:limit/&gt;
      &lt;rez:cl/&gt;
    &lt;/rez:value&gt;
    &lt;rez:errors/&gt;
    &lt;rez:xerrors/&gt;
    &lt;rez:qtag&gt;BR:-511:111&lt;/rez:qtag&gt;
  &lt;/rez:quote&gt;
&lt;/exist:result&gt;
b2mc:h heprez$</pre>
</div>
</div>
<div class="section" id="where-the-spares-come-from">
<h3>where the spares come from<a class="headerlink" href="#where-the-spares-come-from" title="Permalink to this headline">¶</a></h3>
<p><cite>hfag/mods/webapp/hfagc/provide-instance.xq</cite> gives single quotes or header based on request, with the spare src and prod added (for chiba benefit):</p>
<div class="highlight-python"><pre>b2mc:h heprez$ curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/test_xerror_adding.xml" | xmllint --format -
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;quote stamp_hash="ixml:content-hash:-511111BRonBR:-511:111active-5.30.00001-BR:-511:111" stamp_id="25" stamp_source="/db/test/test_xerror_adding.xml" mode="pro" time="2013-07-15T18:21:35.841+0900" stamp="1373880095841"&gt;
  &lt;status&gt;active&lt;/status&gt;
  &lt;pdg&gt;-&lt;/pdg&gt;
  &lt;title/&gt;
  &lt;comment/&gt;
  &lt;value&gt;
    &lt;number&gt;5.3&lt;/number&gt;
    &lt;unit&gt;0.00001&lt;/unit&gt;
    &lt;signif/&gt;
    &lt;ltype&gt;-&lt;/ltype&gt;
    &lt;limit/&gt;
    &lt;cl/&gt;
  &lt;/value&gt;
  &lt;errors/&gt;
  &lt;xerrors/&gt;
  &lt;qtag&gt;BR:-511:111&lt;/qtag&gt;
  &lt;mode&gt;
    &lt;src&gt;-511&lt;/src&gt;
    &lt;src/&gt;
    &lt;prod&gt;111&lt;/prod&gt;
    &lt;prod/&gt;
    &lt;qwn&gt;BR&lt;/qwn&gt;
    &lt;ccimpl&gt;on&lt;/ccimpl&gt;
    &lt;mtag&gt;BR:-511:111&lt;/mtag&gt;
  &lt;/mode&gt;
  &lt;mode&gt;
    &lt;src&gt;-511&lt;/src&gt;
    &lt;src/&gt;
    &lt;prod&gt;111&lt;/prod&gt;
    &lt;prod/&gt;
    &lt;qwn&gt;BR&lt;/qwn&gt;
    &lt;ccimpl&gt;on&lt;/ccimpl&gt;
    &lt;mtag&gt;BR:-511:111&lt;/mtag&gt;
  &lt;/mode&gt;
&lt;/quote&gt;</pre>
</div>
<p>Try document with a third error:</p>
<div class="highlight-python"><pre>curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/bchdspi0.xml" | xmllint --format -</pre>
</div>
<p>The last err or xerr is duplicated by the stylesheet:</p>
<div class="highlight-python"><pre>b2mc:h heprez$ curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/bchdspi0.xml" | xmllint --format -
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;quote stamp_hash="ixml:content-hash:-521-431111BRonBR:-521:-431,111active-$\bar{B}^- \rightarrow D_s^- \pi^0$1.50.000014.9-statabsolute0.50.4systabsolute0.1Ds BRabsolute0.2BR:-521:-431,111" stamp_id="51" stamp_source="/db/test/bchdspi0.xml" mode="pro" time="2008-06-05T16:43:34.062-0800" stamp="1212713014062"&gt;
  &lt;status&gt;active&lt;/status&gt;
  &lt;pdg&gt;-&lt;/pdg&gt;
  &lt;title&gt;$\bar{B}^- \rightarrow D_s^- \pi^0$&lt;/title&gt;
  &lt;comment/&gt;
  &lt;value&gt;
    &lt;number&gt;1.5&lt;/number&gt;
    &lt;unit&gt;0.00001&lt;/unit&gt;
    &lt;signif&gt;4.9&lt;/signif&gt;
    &lt;ltype&gt;-&lt;/ltype&gt;
    &lt;limit/&gt;
    &lt;cl/&gt;
  &lt;/value&gt;
  &lt;errors&gt;
    &lt;err&gt;
      &lt;errname&gt;stat&lt;/errname&gt;
      &lt;type&gt;absolute&lt;/type&gt;
      &lt;symm/&gt;
      &lt;plus&gt;0.5&lt;/plus&gt;
      &lt;minus&gt;0.4&lt;/minus&gt;
    &lt;/err&gt;
    &lt;err&gt;
      &lt;errname&gt;syst&lt;/errname&gt;
      &lt;type&gt;absolute&lt;/type&gt;
      &lt;symm&gt;0.1&lt;/symm&gt;
      &lt;plus/&gt;
      &lt;minus/&gt;
    &lt;/err&gt;
    &lt;err&gt;
      &lt;errname&gt;syst&lt;/errname&gt;
      &lt;type&gt;absolute&lt;/type&gt;
      &lt;symm&gt;0.1&lt;/symm&gt;
      &lt;plus/&gt;
      &lt;minus/&gt;
    &lt;/err&gt;
  &lt;/errors&gt;
  &lt;xerrors&gt;
    &lt;xerr&gt;
      &lt;errname&gt;Ds BR&lt;/errname&gt;
      &lt;type&gt;absolute&lt;/type&gt;
      &lt;symm&gt;0.2&lt;/symm&gt;
      &lt;plus/&gt;
      &lt;minus/&gt;
    &lt;/xerr&gt;
    &lt;xerr&gt;
      &lt;errname&gt;Ds BR&lt;/errname&gt;
      &lt;type&gt;absolute&lt;/type&gt;
      &lt;symm&gt;0.2&lt;/symm&gt;
      &lt;plus/&gt;
      &lt;minus/&gt;
    &lt;/xerr&gt;
  &lt;/xerrors&gt;
  &lt;qtag&gt;BR:-521:-431,111&lt;/qtag&gt;
  &lt;mode&gt;
    &lt;src&gt;-521&lt;/src&gt;
    &lt;src/&gt;
    &lt;prod&gt;-431&lt;/prod&gt;
    &lt;prod&gt;111&lt;/prod&gt;
    &lt;prod/&gt;
    &lt;qwn&gt;BR&lt;/qwn&gt;
    &lt;ccimpl&gt;on&lt;/ccimpl&gt;
    &lt;mtag&gt;BR:-521:-431,111&lt;/mtag&gt;
  &lt;/mode&gt;
  &lt;mode&gt;
    &lt;src&gt;-521&lt;/src&gt;
    &lt;src/&gt;
    &lt;prod&gt;-431&lt;/prod&gt;
    &lt;prod&gt;111&lt;/prod&gt;
    &lt;prod/&gt;
    &lt;qwn&gt;BR&lt;/qwn&gt;
    &lt;ccimpl&gt;on&lt;/ccimpl&gt;
    &lt;mtag&gt;BR:-521:-431,111&lt;/mtag&gt;
  &lt;/mode&gt;
&lt;/quote&gt;</pre>
</div>
<p>Due to the xforms fixing the spares do not appear in the interface, but they are there ready to be used for appending
from empty.</p>
<p>When catching POST data with <cite>hfag/mods/webapp/hfagc/bookinfo-insert-sm.xq</cite> the
spares in the last slot are removed:</p>
<div class="highlight-python"><pre>157                                  if ( $action = "Update" ) then
158                                       (: catch the edited data for the quote, parse it as xml, transform it, and store it temporarily :)
159                                       let $pdata  := util:catch( "java.lang.Exception",request:get-request-data(), "&lt;error/&gt;" )
160                                       let $tmpdoc := concat( "/db/chiba/",$user,$doc , "_" , $elem, "_", $start )
161
162                                       (:
163                                           add-ns-remove-spare.xsl has spare removal for the last "quote" "src" "prod" "err" and "xerr"
164                                           which is applied to the parsed POST data prior to saving into /db/chiba
165                                           eg http://130.87.106.59:8080/xmldb/db/chiba/guest/db/test/test_xerror_adding.xml_quote_1
166                                       :)
167                                       let $chiba  := util:catch( "java.lang.Exception" ,
168                                           ixml:parsetransform( $pdata , $tmpdoc  , $user , $pass , "xmldb:exist:///db/stylesheets/add-ns-remove-spare.xsl" ,
169                                                 &lt;parameters&gt;
170                                                 &lt;param name="stamp"        value="{$tstamp}" /&gt;
171                                                 &lt;param name="time"         value="{$fstamp}" /&gt;
172                                                 &lt;param name="anno"         value="{$elem}" /&gt;
173                                                 &lt;/parameters&gt;
174                                                 ),
175                                           concat( "exception in ixml:parsetransform", $util:exception-message)
176                                           )</pre>
</div>
<p>With <a class="reference external" href="http://130.87.106.59:8080/xmldb/db/stylesheets/add-ns-remove-spare.xsl">http://130.87.106.59:8080/xmldb/db/stylesheets/add-ns-remove-spare.xsl</a></p>
<div class="highlight-python"><pre>b2mc:h heprez$ find . -name add-ns-remove-spare.xsl
./chiba/integration/add-ns-remove-spare.xsl</pre>
</div>
</div>
<div class="section" id="possible-solution">
<h3>Possible Solution<a class="headerlink" href="#possible-solution" title="Permalink to this headline">¶</a></h3>
<p>Detect and recover instances with empty error or xerror by planting spares</p>
<div class="highlight-python"><pre>b2mc:h heprez$ find . -name no-ns-one-spare-no-exre.xsl
./chiba/xsd2xhtml/src/xslxml/no-ns-one-spare-no-exre.xsl</pre>
</div>
<p>Grab a quote with the empty issue and a normal:</p>
<div class="highlight-python"><pre>b2mc:h heprez$ curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/test_xerror_adding.xml&amp;cocoon-view=sauce" | xmllint --format - &gt; /tmp/k/provide-instance-xq-demo.xml
b2mc:h heprez$ curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/bchdspi0.xml&amp;cocoon-view=sauce" | xmllint --format - &gt; /tmp/k/provide-instance-xq-demo-normal.xml</pre>
</div>
<p>Test transform:</p>
<div class="highlight-python"><pre>xsltproc ~/h/chiba/xsd2xhtml/src/xslxml/no-ns-one-spare-no-exre-no-empties.xsl  /tmp/k/provide-instance-xq-demo.xml</pre>
</div>
</div>
<div class="section" id="where-do-these-stylesheets-get-uploaded-to-xmldb">
<h3>Where do these stylesheets get uploaded to xmldb ?<a class="headerlink" href="#where-do-these-stylesheets-get-uploaded-to-xmldb" title="Permalink to this headline">¶</a></h3>
<p>The contents of /db/stylesheets contains all the xsl from</p>
<ul class="simple">
<li><a class="reference external" href="http://130.87.106.59:8080/xmldb/db/stylesheets/">http://130.87.106.59:8080/xmldb/db/stylesheets/</a></li>
<li><em>chiba-stylesheets</em></li>
</ul>
</div>
<div class="section" id="need-to-protect-chiba-from-the-namespaces">
<h3>need to protect chiba from the namespaces<a class="headerlink" href="#need-to-protect-chiba-from-the-namespaces" title="Permalink to this headline">¶</a></h3>
<p>Avoid putting bare elements in the stylesheet to keep ns-less.</p>
</div>
<div class="section" id="update-exist-chiba-on-cms01">
<h3>update exist/chiba on cms01<a class="headerlink" href="#update-exist-chiba-on-cms01" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@cms01 ~]$ exist-
[blyth@cms01 ~]$ exist-propagate- webapp/hfagc
[blyth@cms01 ~]$ exist-place-xsl
=== exist-place-xsl : xmllint --xinclude present-instance.xsl --output /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/stylesheets/present-instance.xsl
=== exist-place-xsl : xmllint --xinclude db2html-scb.xsl --output /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/stylesheets/db2html-scb.xsl

[blyth@cms01 ~]$ chiba-
[blyth@cms01 ~]$ chiba-stylesheets

[blyth@cms01 ~]$ exist-fill-templates
=== exist-fill-templates : a e /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/docs/security.xml from /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/docs/security.xml.template
NOT updated
=== exist-fill-templates : a e /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc.9dec2011/sitemap.xmap from /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc.9dec2011/sitemap.xmap.template
UPDATED
=== exist-fill-templates : a e /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc.9dec2011/xquery/env.xqm from /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc.9dec2011/xquery/env.xqm.template
UPDATED
=== exist-fill-templates : a e /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/sitemap.xmap from /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/sitemap.xmap.template
UPDATED
=== exist-fill-templates : a e /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/xquery/env.xqm from /data/heprez/install/exist/eXist-snapshot-20051026/unpack/4/webapp/hfagc/xquery/env.xqm.template
UPDATED
[blyth@cms01 ~]$</pre>
</div>
<p>Test with <a class="reference external" href="http://cms01.phys.ntu.edu.tw/rezdb/db/test/b0colsup.xml">http://cms01.phys.ntu.edu.tw/rezdb/db/test/b0colsup.xml</a> before bouncing the problem is there</p>
<div class="highlight-python"><pre>curl -s "http://localhost:9090/hfagc/provide-instance.xq?elem=quote&amp;start=1&amp;doc=/db/test/b0colsup.xml&amp;cocoon-view=sauce" | xmllint --format -</pre>
</div>
<p>Failed to load the stylesheet:</p>
<div class="highlight-python"><pre>[blyth@cms01 exist_]$ ./putt.py /db/stylesheets/no-ns-one-spare-no-exre-no-empties.xsl /home/blyth/heprez/chiba/xsd2xhtml/src/xslxml --host localhost --port 9090
empty result
fsmt 2013-07-16 11:56:18
dbmt 1970-01-01 08:00:00
empty result
error in putt ... not stamp change 1970-01-01 08:00:00
[blyth@cms01 exist_]$</pre>
</div>
<p>This was due to a permission denied from out of date password.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../indices_compare_no_backup/" title="Indices Compare No Backups"
             >next</a> |</li>
        <li class="right" >
          <a href="../no_qtys_in_range/" title="[DEFER] No Qtys in range"
             >previous</a> |</li>
        <li><a href="../../">Heprez Unversioned directory documentation</a> &raquo;</li>
          <li><a href="../" >porting</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>