<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Partial Backup Machinery &mdash; Heprez Unversioned directory documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Unversioned directory',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Heprez Unversioned directory documentation" href="../../" />
    <link rel="up" title="&lt;no title&gt;" href="../" />
    <link rel="next" title="BACKUP ANT BUILD" href="../part/build/" />
    <link rel="prev" title="&lt;no title&gt;" href="../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../part/build/" title="BACKUP ANT BUILD"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../" title="&lt;no title&gt;"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Heprez Unversioned directory documentation</a> &raquo;</li>
          <li><a href="../" accesskey="U">&lt;no title&gt;</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> /e </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">/h</a>   </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/"> cms01 </a> </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/downloads/"> downloads </a> </li>
	<li> <a href="http://cms01.phys.ntu.edu.tw/rezdb/db/hfagc/"> rezdb/db/hfagc/ </a> </li>
</ul>






<h3>Content Skeleton</h3>

<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SOP/">SOP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/end_of_2011/">LOG</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../heprez/">HEPREZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../heprez/#heprez-usage-log">HEPREZ USAGE LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rezdb/">REZDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../compilation/">Compilation latex document</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../docs/math/">Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hepex/hepex/">Hepex Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../future/">Future of b2c</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment/">Environment for heprez installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chiba/">Chiba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chibatomcat/chibatomcat/">CHIBA TOMCAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batik/">Batik</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inkscape/">Inkscape</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dvisvgm/">DVISVGM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../images/">Binary Image creation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Partial Backup Machinery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#define-reference-backup-example">DEFINE REFERENCE BACKUP EXAMPLE</a></li>
<li class="toctree-l2"><a class="reference internal" href="#backup-status-determination">BACKUP STATUS DETERMINATION</a></li>
<li class="toctree-l2"><a class="reference internal" href="#functions-called-by-the-above-not-usually-run-directly">FUNCTIONS CALLED BY THE ABOVE : NOT USUALLY RUN DIRECTLY</a></li>
<li class="toctree-l2"><a class="reference internal" href="#new-users-manual-propagation">New users manual propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requirements-of-editing">Requirements of Editing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../part/build/">BACKUP ANT BUILD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exist_/">LOW LEVEL EXIST USAGE FUNCTIONS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exist/">exist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../macports/">macports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../porting/">porting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../eperl/">eperl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svg/">svg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scrape/">scrape</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/backup/backup.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../"
                        title="previous chapter">&lt;no title&gt;</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../part/build/"
                        title="next chapter">BACKUP ANT BUILD</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="partial-backup-machinery">
<h1>Partial Backup Machinery<a class="headerlink" href="#partial-backup-machinery" title="Permalink to this headline">¶</a></h1>
<p>All Backups must be run from the dev machine, not production</p>
<dl class="docutils">
<dt><em>backup-sync</em></dt>
<dd>rsync from dev machine $HEPREZ_DATA/backup/ to H:$H_HEPREZ_DATA/backup/</dd>
<dt><em>backup-log</em></dt>
<dd>recording the purpose behind the backups</dd>
<dt><em>backup-dev</em></dt>
<dd>&#8220;localhost&#8221; dev backup (must be done from dev server)
simply does backup of the dev instance  ... no trimmings</dd>
<dt><em>backup-pro</em></dt>
<dd><p class="first">&#8220;$HEPREZ_SERVER&#8221; backup (pro to dev, must be done from dev server)</p>
<p>Backup will be ABORTed if register-status indicates that there are
unregistered results</p>
<p>This requires :9090/xmlrpc access to the server, which usually
requires a special hole in the firewall, see #112</p>
<p class="last">Note this is differs from exist2qxml.py which uses frontdoor HTTP
access, avoiding the need to fiddle with the firewall.</p>
</dd>
<dt><em>backup-prepare</em></dt>
<dd>invokes backup-status then proceeds to backup-load
as appropriate which loads /db/hfagc etc
(this is called by heprez-propagate)</dd>
<dt><em>backup-refbackup stamp</em></dt>
<dd>where stamp is eg  2009/May20-1742
confer the honor of reference backup on a timestamp. This
is used for comparisons. Although non-critical it needs
to be defined to avoid comparison failures that abort <em>images-preillus</em></dd>
<dt><em>backup-status</em></dt>
<dd>compare timestamps to see what needs doin</dd>
<dt><em>backup-status-dump</em></dt>
<dd>some detail to show how the status was determined</dd>
</dl>
<div class="section" id="define-reference-backup-example">
<h2>DEFINE REFERENCE BACKUP EXAMPLE<a class="headerlink" href="#define-reference-backup-example" title="Permalink to this headline">¶</a></h2>
<p>This is necessary to prevent <em>images-preillus</em> from aborting, but the purpose is
simply to provide relevant diffs against a prior reference.</p>
<p>To confer reference status on a localhost backup check the available timestamps with <em>backup-ls</em>:</p>
<div class="highlight-python"><pre>b2mc:localhost heprez$ backup-ls
=== backup-ls-lnkdir : pro_lastbackup /Users/heprez/data/data/backup/part/cms01.phys.ntu.edu.tw/last-backup /Users/heprez/data/data/backup/part/cms01.phys.ntu.edu.tw
total 32
drwxr-xr-x  8 heprez  staff  272 Jun 21 17:20:43 2013 2013
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:21:56 2013 last -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:21:56 2013 last-backup -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:36:10 2013 prev -&gt; 2013/Jun20-2034
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:36:10 2013 prev-backup -&gt; 2013/Jun20-2034
=== backup-ls-lnkdir : lastrestore /Users/heprez/data/data/backup/part/localhost/last-restore /Users/heprez/data/data/backup/part/localhost
total 56
drwxr-xr-x  5 heprez  staff  170 Jun 21 17:22:09 2013 2013
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22:12 2013 last -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22:12 2013 last-backup -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22:08 2013 last-restore -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:56:25 2013 prev -&gt; 2013/Jun20-2054
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:56:25 2013 prev-backup -&gt; 2013/Jun20-2054
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:10:40 2013 prev-restore -&gt; 2013/Jun21-1708
=== backup-ls : CAUTION TOUCHING THESE LINKS WILL HAVE AN IMPACT BUT WILL NOT BE VISIBLE FROM THESE TIMESTAMPS</pre>
</div>
<p>Then use <em>backup-refbackup</em>:</p>
<div class="highlight-python"><pre>b2mc:localhost heprez$ backup-refbackup 2013/Jun20-2054
=== backup-refbackup : setting reference backup as 2013/Jun20-2054 from /Users/heprez/data/data/backup/part/localhost this is used as reference for many comparisons
total 56
drwxr-xr-x  5 heprez  staff  170 Jun 21 17:22 2013
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22 last -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22 last-backup -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:22 last-restore -&gt; 2013/Jun21-1720
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:56 prev -&gt; 2013/Jun20-2054
lrwxr-xr-x  1 heprez  staff   15 Jun 20 20:56 prev-backup -&gt; 2013/Jun20-2054
lrwxr-xr-x  1 heprez  staff   15 Jun 21 17:10 prev-restore -&gt; 2013/Jun21-1708
lrwxr-xr-x  1 heprez  staff   15 Jun 21 19:34 refbackup -&gt; 2013/Jun20-2054</pre>
</div>
</div>
<div class="section" id="backup-status-determination">
<h2>BACKUP STATUS DETERMINATION<a class="headerlink" href="#backup-status-determination" title="Permalink to this headline">¶</a></h2>
<p>The status is based on time ordering of directory link targets:</p>
<dl class="docutils">
<dt><strong>pro_lastbackup</strong></dt>
<dd>user initiated step of backing up from production to dev machine via backup-pro</dd>
<dt><strong>lastrestore</strong></dt>
<dd>propagation of the backup from production into local database via backup-load</dd>
<dt><strong>safetybackup</strong></dt>
<dd>safety local backup prior to diddling with database content done by backup-load</dd>
</dl>
<p>NB the health of the links are checked by this function, bad links would give incorrect results
CAUTION: timestamps on the links rather than their &#8220;names&#8221; is what is used
(the names and timestamps are normally matched if no manual interventions are made).</p>
</div>
<div class="section" id="functions-called-by-the-above-not-usually-run-directly">
<h2>FUNCTIONS CALLED BY THE ABOVE : NOT USUALLY RUN DIRECTLY<a class="headerlink" href="#functions-called-by-the-above-not-usually-run-directly" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><em>backup-load</em></dt>
<dd><p class="first">THIS WILL ARCHIVE CURRENT THEN LOAD THE LAST BACKUP FROM
PRODUCTION INTO THE LOCAL NODE</p>
<p class="last">Normally called from backup-prepare which does status checks first</p>
</dd>
<dt><em>backup-users-path</em></dt>
<dd>For example /Users/blyth/.heprez/cur/users.xml</dd>
<dt><em>backup-load-users</em></dt>
<dd><p class="first">Loads the users file into /db/system/users.xml only
if the db collection /db/hfagc does not exist indicating a
fresh db</p>
<p>This will fail with permission denied on  re-running
because the admin passwd was changed the first time.</p>
<p class="last">This file is essential for restoring from instance to instance
otherwise get NPEs from RemoteManagement due to the non-existing users
that own resources being restored.
A fresh exist users.xml has only: admin, guest</p>
</dd>
</dl>
<p><em>backup-load-users-insitu</em></p>
<blockquote>
<div><p>Loads last backup users.xml into /db/system/users.xml to
accomodate new users/groups.</p>
<p>See #104 #174</p>
</div></blockquote>
<dl class="docutils">
<dt><em>backup-stamp</em></dt>
<dd><p class="first">prepare ant arguments for time stamps, avoiding doing such things with the manipulation
challenged ant</p>
<p>Examples:</p>
<div class="last highlight-python"><pre>backup-stamp
        -DSTAMP=2010/Jan08-1430 -Dstamp.year=2010 -Dstamp.date=Jan08-1430
backup-stamp auto
        -DSTAMP=2010/Jan08-1430 -Dstamp.year=2010 -Dstamp.date=Jan08-1430
backup-stamp 2009/May25-1951
         -DSTAMP=2009/May25-1951 -Dstamp.year=2009 -Dstamp.date=May25-1951</pre>
</div>
</dd>
</dl>
</div>
<div class="section" id="new-users-manual-propagation">
<h2>New users manual propagation<a class="headerlink" href="#new-users-manual-propagation" title="Permalink to this headline">¶</a></h2>
<p>When adding new users it is necessary to perform manual users.xml
propagation from the editing machine to the scraping machine,
<strong>before performing propagations via backup/recoveries</strong>
which contain resources belonging to the new users.
This avoids DB corruption when performing recovery from
backup on the scraping machine (which is the
For details see #104 #174</p>
<dl class="docutils">
<dt><em>backup-users-path arg</em></dt>
<dd>emits path to users file and creates the arg labelled directory
where arg is typically : &#8220;new&#8221; &#8220;cur&#8221; &#8220;saf&#8221; or &#8220;chk&#8221;</dd>
<dt><em>backup-users-get-current</em></dt>
<dd>download /db/system/users.xml from local exist instance (which must be running)
into &#8220;cur&#8221; path</dd>
<dt><em>backup-users-check</em></dt>
<dd>gets the current users.xml file if not already cached and compares with
slated &#8220;new&#8221; users.xml
NB &#8220;new&#8221; users.xml must always be placed there manully</dd>
<dt><em>backup-users-load-new</em></dt>
<dd>invokes the backup-users-check and then asks for confirmation before
loading the &#8220;new&#8221; users.xml into the local exist instance (which must be running)</dd>
</dl>
<p>Typical workflow:</p>
<p>Follow instructions from #104 to add new users on editing machine using exist client
in a remote manner</p>
<p>On the server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">C</span><span class="o">&gt;</span> <span class="n">backup</span><span class="o">-</span><span class="n">users</span><span class="o">-</span><span class="n">get</span><span class="o">-</span><span class="n">current</span>      <span class="c"># grab the users file, checking it contains the new users</span>
</pre></div>
</div>
<p>On the scraper:</p>
<div class="highlight-python"><pre>G&gt; heprez- ; exist- ; exist-start    # manual startup in Terminal.app as customary on G

G&gt; cd ; mkdir -p .heprez/new
G&gt; scp C:.heprez/cur/users.xml .heprez/new/users.xml  # manually honour the new users file from the remote editing machine

G&gt; backup-users-load-new            # load the new file into scraper exist instance
G&gt; exist_get /db/system/users.xml   # check looks OK

G&gt; heprez-propagate                 # after edits ready, perform propagations (with some trepidation)</pre>
</div>
</div>
<div class="section" id="requirements-of-editing">
<h2>Requirements of Editing<a class="headerlink" href="#requirements-of-editing" title="Permalink to this headline">¶</a></h2>
<p>The /db/hfagc rez are only edited on the HEPREZ_SERVER
For the purposes of rez editing the db needs to contain :</p>
<ul class="simple">
<li>/db/hfagc, the current rez</li>
<li>/db/stylesheets, for instance presentation stylesheets</li>
<li>/db/hfagc_system, particle + qtag indices</li>
</ul>
<p>File system requires</p>
<ul class="simple">
<li>images, pngs corresponding to the particle/qtag indices</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../part/build/" title="BACKUP ANT BUILD"
             >next</a> |</li>
        <li class="right" >
          <a href="../" title="&lt;no title&gt;"
             >previous</a> |</li>
        <li><a href="../../">Heprez Unversioned directory documentation</a> &raquo;</li>
          <li><a href="../" >&lt;no title&gt;</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>