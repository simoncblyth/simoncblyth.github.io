<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>G4DAE : Export Geant4 Geometry to COLLADA/DAE XML files</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="visible" />
<!-- style sheet links -->
<script src="ui/my-small-white/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/my-small-white/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/my-small-white/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/my-small-white/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/my-small-white/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>G4DAE : Export Geant4 Geometry to COLLADA/DAE XML files</h1>

</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">G4DAE : Export Geant4 Geometry to COLLADA/DAE XML files</h1>

<!-- comment

Parallel session 2B : Latest developments on visualization drivers
Tuesday 30/09 16:00-17:30
(maximum of 20min, including 5 min discussion)

- Joseph Perl: « Improving vis performances in MT »
- Akinori Kimura: « Updates of the gMocren driver »
- Simon Blyth (invited as a contributor for this session) : « Collada geometry exporter G4DAE»
- Laurent Garnier: «  Updates on OpenGL (Qt and Wt) drivers »
- space for discussion

Laurent


TODO:
* Need page regarding g4daeview.py implementation techniques
* need cuts

00: G4DAE : Export Geant4 Geometry to COLLADA/DAE XML files
 1: https://bitbucket.org/simoncblyth/g4dae
 2: COLLADA : Standard for 3D Digital Asset Exchange (DAE)
 3: Compare DAE Exports to GDML and VRML2(WRL)
 4: Tested G4DAE reading applications and frameworks
 5: G4DAE export view/edit with OSX Xcode.app (1)
 6: G4DAE export view/edit with OSX Xcode.app (2)
 7: G4DAE export in OSX Sketchup
 8: G4DAE export in OSX Finder, Interactive Quicklook (1)
 9: G4DAE export in OSX 10.8+ Finder, Rotate/Pan/Zoom
10: G4DAE export in OSX 10.8+ Preview : Daya Bay Antineutrino Detector
11: My Modules/Applications using G4DAE exports (OSX/Linux)
12: g4daeserver.py : View exported geometry in web browser
13: g4daeserver.py : View exported geometry in web browser, details
14: G4DAE Exporter Status : almost feature complete -->
<!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->

       <style type="text/css">

          div.slide { 
             background-clip: border-box;
             background-repeat: no-repeat;
             height: 100%;
          }
          div.slide#slide0{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          } 

       </style>
    <p class="small"><a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html">http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html</a>
<a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html">http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html</a></p>
<div class="sidebar">
<p class="first sidebar-title">Why export into DAE ?</p>
<p class="last">Ubiquitous geometry visualization
for Geant4 users and outreach. Facilitate
innovative use of geometry data.</p>
</div>
<p class="small">Outline:</p>
<ul class="small simple">
<li>Exporter details</li>
<li>What is COLLADA/DAE ?</li>
<li>Validating exports</li>
<li>General viewing of exports</li>
<li>Custom use: <span class="red">bridging to GPU</span></li>
<li>OpenGL Viewer implementation</li>
<li>Optical Photon Data handling</li>
<li>Introducing <em>Chroma</em></li>
<li><em>Chroma</em> raycasting</li>
<li><em>Chroma</em> photon propagation</li>
<li><em>G4DAE</em> Exporter status</li>
<li>Conclusion</li>
</ul>

</div>
<div class="slide" id="https-bitbucket-org-simoncblyth-g4dae">
<h1><a class="reference external" href="https://bitbucket.org/simoncblyth/g4dae">https://bitbucket.org/simoncblyth/g4dae</a></h1>
<p class="small">Exports <em>Geant4</em> Geometry into COLLADA/DAE standard 3D files,
based on <em>GDML writer</em> code, same <em>XercesC</em> dependency for XML handling. Export includes:</p>
<ul class="small simple">
<li>volume tree: solid/physical volume/logical volume heirarchy</li>
<li>geometry: vertices, triangles+quads   (triangulation from <em>G4Polyhedron</em>)</li>
<li>materials and surfaces with properties as function of wavelength
(using DAE <em>extra</em> XML elements)</li>
</ul>
<img alt="/env/geant4/geometry/collada/g4dae/g4dae_bitbucket.png" class="align-center" src="/env/geant4/geometry/collada/g4dae/g4dae_bitbucket.png" style="width: 700px;" />
</div>
<div class="slide" id="collada-standard-for-3d-digital-asset-exchange-dae">
<h1><span class="small">COLLADA : Standard for 3D Digital Asset Exchange (DAE)</span></h1>
<ul class="small simple">
<li><a class="reference external" href="https://www.khronos.org/collada/">https://www.khronos.org/collada/</a></li>
</ul>
<img alt="/env/graphics/collada/collada_khronos.png" class="align-center" src="/env/graphics/collada/collada_khronos.png" style="width: 900px;" />
</div>
<div class="slide" id="compare-dae-exports-to-gdml-and-vrml2-wrl">
<h1><span class="small">Compare DAE Exports to GDML and VRML2(WRL)</span></h1>
<p class="small">Export validation:</p>
<blockquote class="small">
<ul class="simple">
<li>Comparison of all vertices/faces reveals <span class="red">boolean solids are discrepant</span>.</li>
<li>Perfect <a class="footnote-reference" href="#perfect" id="id1">[1]</a> DAE WRL agreement achieved by <em>cheating</em> : <span class="blue">perform triangulation once and reuse</span>.</li>
<li>Boolean solid triangulation sensitivity must be kept in mind as a potential systematic
for computational uses</li>
<li><strong>DAE not much bigger than GDML</strong>, despite including all triangles/vertices <a class="footnote-reference" href="#not-repeating" id="id2">[2]</a></li>
</ul>
</blockquote>
<table border="1" class="small docutils">
<colgroup>
<col width="23%" />
<col width="20%" />
<col width="16%" />
<col width="21%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Qty</th>
<th class="head">DayaBay</th>
<th class="head">Lingao</th>
<th class="head">Far</th>
<th class="head">Juno x0.5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Volumes</td>
<td>12,229</td>
<td>12,229</td>
<td>18,903</td>
<td>25,000</td>
</tr>
<tr><td>Triangles</td>
<td>2,448,064</td>
<td>2,448,064</td>
<td>4,189,680</td>
<td>21,886,158</td>
</tr>
<tr><td>Vertices</td>
<td>1,245,996</td>
<td>1,245,996</td>
<td>2,128,208</td>
<td>10,993,079</td>
</tr>
<tr><td>DAE/GDML/WRL (MB)</td>
<td><strong>6.9</strong>/4.0/98</td>
<td><strong>6.9</strong>/4.0/96</td>
<td><strong>8.6</strong>/6.0/167</td>
<td><strong>6.1</strong>/-/-</td>
</tr>
</tbody>
</table>
<p class="tiny"><tt class="docutils literal">VGDX_20140414</tt> counts using <tt class="docutils literal">g4daeview.py <span class="pre">-g</span> 0: <span class="pre">--with-chroma</span></tt>, Juno geometry truncated</p>
<table class="tiny docutils footnote" frame="void" id="perfect" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Maximum DAE WRL offset &lt; 0.13 mm, after patching VRML2 export precision bug (fixed in current G4).
Details: <a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="not-repeating" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Geometry is not repeated, instead the COLLADA format uses geometry instancing and a tree of transforms,
just like GDML</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="tested-g4dae-reading-applications-and-frameworks">
<h1><span class="small">Tested G4DAE reading applications and frameworks</span></h1>
<div class="sidebar">
<p class="first sidebar-title">G4DAE Usage</p>
<p class="last">Many commercial, open source apps/libs
can view/edit G4DAE files.</p>
</div>
<p class="small">Commercial:</p>
<ul class="small simple">
<li><em>Finder/Quicklook/Preview/Xcode</em> (standard OSX 10.8+)<ul>
<li><span class="blue">Xcode : useful effect tweaking interface</span></li>
<li><span class="blue">Preview : set black background for visibility</span></li>
</ul>
</li>
<li><em>Sketchup 8</em> free (OSX) [also Windows]</li>
<li><em>ESKO Studio Viewer</em> free (iOS on iPad)</li>
</ul>
<p class="small">Open source:</p>
<ul class="small simple">
<li><em>Meshlab</em> (OSX/Linux), slow DAE loading, OK interface [also Windows]</li>
<li><em>Blender</em> (OSX), painful GUI  [also Windows/Linux]</li>
</ul>
<p class="small">Frameworks:</p>
<ul class="small simple">
<li><em>pycollada</em>, Python COLLADA parsing/construction, <span class="red">lxml + numpy powered fast parsing</span></li>
<li><em>threejs</em>, Javascript COLLADA loading, renders HTML canvas with WebGL</li>
<li><em>SceneKit</em>, Objective C Framework used by OSX apps</li>
</ul>
<p class="small">Many more applications and frameworks listed <a class="reference external" href="http://en.wikipedia.org/wiki/COLLADA">http://en.wikipedia.org/wiki/COLLADA</a></p>
<p class="tiny"><a class="reference external" href="http://meshlab.sourceforge.net">http://meshlab.sourceforge.net</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/meshlab">https://bitbucket.org/simoncblyth/meshlab</a> (fork improves COLLADA loading speed)</p>
</div>
<div class="slide" id="g4dae-export-in-osx-finder-interactive-quicklook-1">
<h1><span class="small">G4DAE export in OSX Finder, Interactive Quicklook (1)</span></h1>
<p class="small">Coverflow through geometries:</p>
<img alt="/env/geant4/geometry/collada/osx_finder/g4dae_osx_finder.png" class="align-center" src="/env/geant4/geometry/collada/osx_finder/g4dae_osx_finder.png" style="width: 900px;" />
</div>
<div class="slide" id="g4dae-export-in-osx-10-8-finder-rotate-pan-zoom">
<h1><span class="small">G4DAE export in OSX 10.8+ Finder, Rotate/Pan/Zoom</span></h1>
<p class="small">Rotate/Pan/Zoom in the Finder:</p>
<img alt="/env/geant4/geometry/collada/osx_finder/g4dae_osx_finder_2.png" class="align-center" src="/env/geant4/geometry/collada/osx_finder/g4dae_osx_finder_2.png" style="width: 900px;" />
</div>
<div class="slide" id="g4dae-export-view-edit-with-osx-xcode-app-1">
<h1><span class="small">G4DAE export view/edit with OSX Xcode.app (1)</span></h1>
<p class="small">Deep tree makes choice of default appearance problematic. Useful editing.</p>
<img alt="/env/geant4/geometry/collada/xcode/g4dae_xcode.png" class="align-center" src="/env/geant4/geometry/collada/xcode/g4dae_xcode.png" style="width: 900px;" />
</div>
<div class="slide" id="g4dae-export-view-edit-with-osx-xcode-app-2">
<h1><span class="small">G4DAE export view/edit with OSX Xcode.app (2)</span></h1>
<p class="small">Bialkali PMT cathode highlighted by Xcode effect edit.</p>
<img alt="/env/geant4/geometry/collada/xcode/g4dae_xcode_2.png" class="align-center" src="/env/geant4/geometry/collada/xcode/g4dae_xcode_2.png" style="width: 900px;" />
</div>
<div class="slide" id="g4dae-export-in-osx-10-8-preview-daya-bay-antineutrino-detector">
<h1><span class="small">G4DAE export in OSX 10.8+ Preview : Daya Bay Antineutrino Detector</span></h1>
<ul class="tiny simple">
<li>Set black background for visibility  <tt class="docutils literal">Preview &gt; <span class="pre">Preferences...</span> &gt; General [Window Background]</tt></li>
<li>Control with iOS-like gestures, pinch/rotate etc..</li>
</ul>
<img alt="/env/geant4/geometry/collada/osx_preview/g4dae_osx_preview.png" class="align-center" src="/env/geant4/geometry/collada/osx_preview/g4dae_osx_preview.png" style="width: 900px;" />
</div>
<div class="slide" id="g4dae-export-in-osx-sketchup">
<h1><span class="small">G4DAE export in OSX Sketchup</span></h1>
<p class="tiny">Available for Windows too.</p>
<img alt="/env/geant4/geometry/collada/sketchup/g4dae_sketchup.png" class="align-center" src="/env/geant4/geometry/collada/sketchup/g4dae_sketchup.png" style="width: 900px;" />
</div>
<div class="slide" id="my-modules-applications-using-g4dae-exports-osx-linux">
<h1><span class="small">My Modules/Applications using G4DAE exports (OSX/Linux)</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Custom Benefits</p>
<p class="last">General purpose OS/app support useful, but custom development
needed to really benefit. Availability of frameworks
allows high level approach.</p>
</div>
<p class="small"><span class="red">g4daenode.py</span> <em>pycollada</em> based G4DAE parser</p>
<ul class="small simple">
<li>reconstructs Geant4 volume tree from raw tree</li>
<li>parses <strong>extra</strong> material/surface properties</li>
<li>provides partial geometry tree creation</li>
</ul>
<p class="small"><span class="red">g4daeserver.py</span> <em>threejs/WebGL</em> (client) and <em>pycollada/webpy</em> (server) based webapp:</p>
<ul class="small simple">
<li>3D geometry viewer in the browser, <strong>NO client installation</strong></li>
<li>useful for debugging single volumes</li>
<li>did not pursue as python development more flexible than Javascript in browser</li>
</ul>
<p class="small"><span class="red">g4daeview.py</span> <em>pyopengl/pycollada/numpy</em> based 3D viewer app</p>
<ul class="small simple">
<li>many interactive features detailed later</li>
<li>integrates with GPU/CUDA based <strong>Chroma</strong> project</li>
<li>live link to Geant4 (via StackAction sending optical photons over <em>ZeroMQ</em> message queue)</li>
</ul>
<p class="tiny"><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daenode.py">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daenode.py</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/g4daeserver/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/g4daeserver/</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/g4daeview.py">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/g4daeview.py</a></p>
</div>
<div class="slide" id="g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files">
<h1><span class="small">g4daeview.py : Fast OpenGL 3D viewer for G4DAE files</span></h1>
<p class="small">G4DAE visualization <a class="footnote-reference" href="#g4daeview-usage" id="id3">[3]</a> implemented with PyCollada, PyOpenGL and Glumpy</p>
<ul class="small simple">
<li>very fast/responsive 3D OpenGL visualization <a class="footnote-reference" href="#vbo" id="id4">[4]</a></li>
<li>flexible tree/list based partial geometry loading</li>
<li>intuitive virtual trackball translate/rotate</li>
<li>parallel or perspective projections</li>
<li>interactive fov and near/far plane clipping</li>
<li>persistent viewpoint bookmarks</li>
<li>animation by interpolation between bookmarks or orbiting</li>
<li>numerical control via UDP remote messaging</li>
<li>live Geant4 connection, photon visualization, single stepping</li>
<li>easily extensible python implementation <a class="footnote-reference" href="#g4daeview-code" id="id5">[5]</a></li>
<li>photon picking interface, with property inspection</li>
</ul>
<p class="small">Also used for testing GPU photon propagation with Chroma project</p>
<ul class="small simple">
<li>interactive raycasting, including animated</li>
<li>propagation visualization, with time slider</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="g4daeview-usage" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="vbo" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Implemented with single OpenGL Vertex Buffer Object (VBO) for entire geometry</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="g4daeview-code" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daeview-py-initial-photon-positions">
<h1><span class="small">g4daeview.py : Initial Photon Positions</span></h1>
<p class="tiny">Initial photon positions of a Geant4 simulated muon that crosses
between the Dayabay Near hall ADs. Colors represent photon wavelengths.
Optical photons: collected in G4 StackAction, serialized, sent over ZeroMQ, deserialized,
presented using OpenGL GLSL shaders.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140518-174941.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140518-174941.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-implementation">
<h1><span class="small">g4daeview.py : Implementation</span></h1>
<!-- comment

http://dayabay.phys.ntu.edu.tw/tracs/env/browser/trunk/geant4/geometry/collada/daeviewgl.py?rev=4344 -->
<p class="small">Based on <em>glumpy</em> <a class="footnote-reference" href="#glumpy" id="id6">[6]</a> and <em>pyopengl</em> <a class="footnote-reference" href="#pyopengl" id="id7">[7]</a></p>
<ul class="small">
<li><p class="first">started from .obj viewer <a class="footnote-reference" href="#glumpy-obj-viewer" id="id8">[8]</a></p>
</li>
<li><p class="first">added vertices, triangles from <strong>G4DAE</strong> export</p>
<blockquote>
<ul class="simple">
<li>entire geometry in <span class="red">single VBO</span></li>
<li>only <strong>one</strong> OpenGL command needed to draw</li>
</ul>
</blockquote>
</li>
<li><p class="first">immediately (few hrs): <span class="red">shockingly fast graphics</span></p>
<blockquote>
<ul class="simple">
<li>smoothly slinging around ~2.5M triangles, no stuttering</li>
</ul>
</blockquote>
</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="glumpy" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="https://code.google.com/p/glumpy/">https://code.google.com/p/glumpy/</a> many useful examples of pyopengl usage</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="pyopengl" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="http://pyopengl.sourceforge.net">http://pyopengl.sourceforge.net</a>  cross platform Python binding to OpenGL and related APIs</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="glumpy-obj-viewer" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td><a class="reference external" href="http://bitbucket.org/simoncblyth/env/src/tip/graphics/glumpy/glumpy_examples/obj-viewer-structured.py">http://bitbucket.org/simoncblyth/env/src/tip/graphics/glumpy/glumpy_examples/obj-viewer-structured.py</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daeview-py-optical-photon-op-data-handling">
<h1><span class="small">g4daeview.py : Optical Photon (OP) Data Handling</span></h1>
<p class="small">Photon data flow:</p>
<ul class="small simple">
<li>OP collected in <em>StackAction::ClassifyNewTrack</em> and killed <a class="footnote-reference" href="#alt" id="id9">[9]</a></li>
<li><em>NewStage</em> send OP lists <a class="footnote-reference" href="#mqtransport" id="id10">[10]</a> to <em>CUDA/Chroma</em> process, propagated on GPU</li>
<li>reply back to <em>NewStage</em> to form hits</li>
</ul>
<div class="sidebar">
<p class="first sidebar-title">CUDA/OpenGL interop</p>
<p class="last">Same GPU resident data structure
accessible to computation and presentation</p>
</div>
<p class="small">When visualizing/debugging:</p>
<ul class="small simple">
<li>populate OpenGL VBO data structure</li>
<li>on load, propagate, saving steps into VBO slots</li>
<li>presentation, every frame:<ul>
<li>photon styles, GLSL shaders: spagetti, confetti, noodles, ...</li>
<li>simple CUDA <em>presenter</em> kernel to interpolate between steps based on an input time</li>
</ul>
</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="alt" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td>Would be more efficient to collect OP inside Cerenkov and Scintillation processes,
avoiding creating and stacking only to immediately kill.</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="mqtransport" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td>ROOT TObject (de)serialization, network message queue ZeroMQ</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daeview-py-status">
<h1><span class="small">g4daeview.py : Status</span></h1>
<p class="small">Not mature, but intend to facilitate usage anyhow.</p>
<p class="small"><strong>Plan:</strong></p>
<ul class="small simple">
<li>break out into separate bitbucket repository<ul>
<li><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/</a></li>
</ul>
</li>
</ul>
<ul class="small simple">
<li>degrade to OpenGL only features, when CUDA not available<ul>
<li><em>glumpy/pyopengl/numpy/pycollada</em> : visualization/navigation/bookmarks</li>
<li><em>Chroma/PyCUDA/Chroma</em> : photon propagation, raycasting</li>
</ul>
</li>
</ul>
<ul class="small simple">
<li>document installation and usage</li>
</ul>
</div>
<div class="slide" id="chroma-ultra-fast-photon-mc-developed-by-stan-seibert-university-of-pennsylvania">
<h1><span class="small">Chroma : Ultra-fast Photon MC, Developed by Stan Seibert, University of Pennsylvania</span></h1>
<ul class="small simple">
<li><a class="reference external" href="http://chroma.bitbucket.org">http://chroma.bitbucket.org</a></li>
</ul>
<blockquote class="small">
Chroma tracks photons through a <span class="red">triangle-mesh detector geometry</span>,
simulating processes like diffuse and specular reflections,
refraction, Rayleigh scattering and absorption. Using triangle meshes
eliminate geometry code as <span class="red">just one code path</span>.</blockquote>
<div class="sidebar">
<p class="first sidebar-title">Original Motivation for G4DAE exporter</p>
<p class="last">Allow use of Chroma GPU accelerated optical photon propagation
with existing DayaBay Geant4 geometry.</p>
</div>
<p class="small">200x performance claim:</p>
<blockquote>
<em>With a CUDA GPU Chroma has propagated 2.5M photons per second
in a detector with 29k photomultiplier tubes. This is
200x faster than GEANT4.</em></blockquote>
<p class="small"><strong>BUT</strong> Chroma needs : <span class="red">triangles + inside/outside materials</span></p>
<p class="tiny"><a class="reference external" href="http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf">http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf</a></p>
</div>
<div class="slide" id="chroma-raycasting-exercises-geometry-intersection">
<h1><span class="small">Chroma Raycasting : exercises geometry intersection</span></h1>
<p class="small">Raycasting exercises slowest part of optical photon propagation: <span class="red">geometry intersection</span>.</p>
<img alt="/env/chroma/chroma_camera/chroma_raycast_illustration.png" class="align-center" src="/env/chroma/chroma_camera/chroma_raycast_illustration.png" style="width: 600px;" />
<ul class="small simple">
<li>Shoot rays thru every pixel out into geometry, 1 CUDA thread for each, typically &gt;1M rays</li>
<li>Find triangle intersections using BVH <a class="footnote-reference" href="#bvh" id="id11">[11]</a> acceleration structure</li>
<li>Determine color based on ray to triangle normal angle</li>
<li>Alpha blend nearest 10 surfaces, providing transparency effect</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="bvh" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[11]</a></td><td>Boundary Volume Heirarchy, a tree of bounding boxes with triangles inside leaf nodes</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="chroma-raycast-with-entire-geometry-in-view">
<h1><span class="small">Chroma Raycast with entire geometry in view</span></h1>
<p class="small">Render Split into 3x3 CUDA kernel launches, 1 thread per pixel, ~1.8s for 1.23M pixels, 2.4M tris (with <a class="footnote-reference" href="#hw" id="id12">[12]</a>)</p>
<img alt="/env/chroma/chroma_camera/20140423-162109.png" class="align-center" src="/env/chroma/chroma_camera/20140423-162109.png" style="width: 800px;" />
<table class="tiny docutils footnote" frame="void" id="hw" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[12]</a></td><td>MacBook Pro (2013), NVIDIA GeForce GT 750M 2048 MB ;
Workstation GPUs such as NVIDIA Kepler K20 expected at least ~3x faster</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daeview-py-dayabay-chroma-photon-propagation-1">
<h1><span class="small">g4daeview.py : Dayabay Chroma Photon Propagation (1)</span></h1>
<p class="tiny">Chroma GPU photon propagation at 12 nanoseconds.  The photons are generated by Geant4
simulation of a 100 GeV muon travelling from right to left.
Photon colors indicate reemission (green), absorption(red),
specular reflection (magenta), scattering(blue), no history (white).</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" style="height: 600px;" />
</div>
<div class="slide" id="g4daeview-py-dayabay-chroma-photon-propagation-2">
<h1><span class="small">g4daeview.py : Dayabay Chroma Photon Propagation (2)</span></h1>
<p class="tiny">Chroma GPU photon propagation at 14 nanoseconds.
The interface provides interactive control of the propagation time
allowing any stage of the propagation to be viewed by
scrubbing time backwards/forwards. The speed of this visualization
is achieved by interoperation of CUDA kernels and OpenGL shaders accessing
the same GPU resident photon propagation data.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-163403.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-163403.png" style="height: 600px;" />
</div>
<div class="slide" id="g4dae-exporter-status-almost-feature-complete">
<h1><span class="small">G4DAE Exporter Status : almost feature complete</span></h1>
<p class="small">Development started with GDML from <strong>geant4.10.00.p01</strong></p>
<ul class="small simple">
<li>made minor backports to work with <strong>geant4.9.2.p01</strong></li>
<li>patched old version to give access to material property tables</li>
</ul>
<p class="small"><strong>Remaining tasks:</strong></p>
<ul class="small simple">
<li>test with newer and latest versions of Geant4</li>
</ul>
<ul class="small simple">
<li>implement parametrized/replica geometry handling, following GDML</li>
<li>confirm issue (inherited from GDML) of
edge case skipped <strong>G4LogicalBorderSurface</strong>
where a volume is shared between multiple volume pairs.</li>
</ul>
<ul class="small simple">
<li>test on more geometries, currently mainly DayaBay and JUNO</li>
</ul>
<ul class="small simple">
<li>export appearance adjustments<ul>
<li>current uniform translucent white, invisible when white background</li>
<li>too many parameters, unclear what to use for defaults</li>
<li>investigate propagating from <strong>G4VisAttributes</strong></li>
</ul>
</li>
</ul>
<ul class="small simple">
<li>review code:<ul>
<li>remove: unused parsing inherited from GDML</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="g4dae-conclusion">
<h1><span class="small">G4DAE : Conclusion</span></h1>
<ul class="simple">
<li><a class="reference external" href="https://bitbucket.org/simoncblyth/g4dae">https://bitbucket.org/simoncblyth/g4dae</a></li>
</ul>
<p>I propose to contribute the COLLADA/DAE geometry exporter
to the Geant4 collaboration, as I believe this can be
useful for facilitating:</p>
<ul class="simple">
<li>fast/flexible/ubiquitous visualization</li>
<li>external computation using geometry data such as<ul>
<li>GPU raycasting</li>
<li>GPU optical photon simulation</li>
</ul>
</li>
</ul>
<p class="small">Links for this presentation and another on GPU optical photon propagation:</p>
<ul class="small simple">
<li><a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html">http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html</a></li>
<li><a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html">http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html</a></li>
</ul>
</div>
<div class="slide" id="extra-slides">
<h1><span class="small">Extra slides</span></h1>
<ul class="small simple">
<li>g4daeserver.py : View exported geometry in web browser</li>
<li>g4daeserver.py : View exported geometry in web browser, details</li>
<li>g4daeview.py : Photon Selection Interface</li>
<li>g4daeview.py : Propagation Step Selection Interface</li>
</ul>
</div>
<div class="slide" id="g4daeserver-py-view-exported-geometry-in-web-browser">
<h1><span class="small">g4daeserver.py : View exported geometry in web browser</span></h1>
<img alt="/env/geant4/geometry/collada/webgl_safari_daeserver/webgl_safari_daeserver.png" class="align-center" src="/env/geant4/geometry/collada/webgl_safari_daeserver/webgl_safari_daeserver.png" style="width: 900px;" />
</div>
<div class="slide" id="g4daeserver-py-view-exported-geometry-in-web-browser-details">
<h1><span class="small">g4daeserver.py : View exported geometry in web browser, details</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Instant web access to any volume</p>
<p class="last">Very useful for single volume debugging, did not pursue
as prefer Python development over Javascript.</p>
</div>
<p class="small">Select volume subtree by name or index and recursion depth</p>
<ul class="small simple">
<li><a class="reference external" href="http://belle7.nuu.edu.tw/g4dae/tree/3150___1.html">http://belle7.nuu.edu.tw/g4dae/tree/3150___1.html</a></li>
</ul>
<p class="small">Client in browser based on:</p>
<ul class="small simple">
<li><strong>threejs</strong>, Javascript 3D library<ul>
<li>reads DAE geometry subtrees from server</li>
<li>parses DAE and renders with <strong>WebGL</strong>  (<strong>OpenGL</strong> GPU accelerated)</li>
</ul>
</li>
</ul>
<p class="small">Server:</p>
<ul class="small simple">
<li><strong>g4daenode.py</strong>, reconstructs Geant4 tree from G4DAE export
using <strong>pycollada</strong> parser</li>
<li><strong>webpy</strong>, serve .html and .dae subtrees at each request,
running under apache mod_fcgi</li>
</ul>
<p class="small">Command line access to DAE subtrees:</p>
<pre class="small literal-block">
curl -O http://belle7.nuu.edu.tw/g4dae/tree/3155___2.dae
</pre>
<p class="tiny"><a class="reference external" href="http://threejs.org">http://threejs.org</a>
<a class="reference external" href="http://pycollada.github.io">http://pycollada.github.io</a>
<a class="reference external" href="http://webpy.org">http://webpy.org</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/g4daeserver/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/g4daeserver/</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daenode.py">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daenode.py</a></p>
</div>
<div class="slide" id="g4daeview-py-photon-selection-interface">
<h1><span class="small">g4daeview.py : Photon Selection Interface</span></h1>
<p class="tiny">Propagation steps OR photons can be selected by materials, propagation history, or special selection by photon identifier.
Photons can be selected by clicking their 3D representations allowing inspection of the
propagation history of individual photons.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/grab_glut_menu.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/grab_glut_menu.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-propagation-step-selection-interface">
<h1><span class="small">g4daeview.py : Propagation Step Selection Interface</span></h1>
<p class="tiny">Photon propagation steps with material pair GdDopedLS,Acrylic. The larger
squares represent selected photons, providing access to numerical details of propagation history.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-183318.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-183318.png" style="height: 650px;" />
</div>
</div>
</body>
</html>
