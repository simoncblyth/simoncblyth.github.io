.. meta::

   :title: Opticks + JUNO : PMT Geometry + Optical Model Progress
   :name: opticks_20230428_More_junoPMTOpticalModel_issues_and_Validation_of_CustomG4OpBoundaryProcess_fix
   :description: (28 April 2023)
   :notes: sim/phys meeting

.. include:: my_s5defs.txt

.. include:: s5_background_image.txt


.. comment

   Klop



:i:`Opticks + JUNO : More junoPMTOpticalModel Issues + Validation of Custom4 C4OpBoundaryProcess Fix` 
========================================================================================================

.. raw:: html

    <div class="mytitle">
        <header>
            <h1 style="background-color:lightgrey"> 
                Opticks + JUNO : More junoPMTOpticalModel Issues + Validation of Custom4 C4OpBoundaryProcess Fix
                <h2 style="background-color:lightgrey;text-align:center"> Open source, https://bitbucket.org/simoncblyth/opticks </h2>
            </h1>
        </header>
    </div>
    <p style="margin-bottom:52mm;" />

.. class:: small

  * *junoPMTOpticalModel* issues: 

    * :r:`FORCED OVERLY COMPLEX:` PMT geometry and Geant4 step histories
    * :r:`BUGS:` polarization and propagation time within PMT are wrong
    * :b:`NEW:` :r:`MORE BUGS:` unphysical mid-vacuum reflect, refract, absorb, detect, "tunneling" 

  * Custom Boundary POM (PMT Optical Model) Alternative, Custom4 mini-package

    * C4OpBoundaryProcess, C4CustomART.h 
    * POM/PMT quadrant controls 

  * Standalone PMT tests (Custom4 + j/PMTSim + Opticks) 

    * :b:`NEW:` :r:`PMT=0,1 Chi2 comparision reveals ModelTrigger whereAmI bug` 
    * Unphysical photon examples, mid-vacuum A,R,T,D,"Tunneling" 
    * ModelTrigger_Debug, mis-placed triggers, HAMA immunity  
    * finding and fixing junoPMTOpticalModel::ModelTrigger whereAmI bug 
    * PMT=0,1 Chi2 comparisons of photon histories 

  * "Insitu" tests within junosw, with Opticks instrumentation

    * input photons, photon history recorded into Opticks/SEvt  
    * PMT=0,1 Chi2 comparisons with input photons


.. raw:: html

    <div class="mycredit">
       <h2 style="background-color:lightgrey"> Simon C Blyth, IHEP, CAS  &mdash; 28 April 2023 </h2>
    </div>


.. s5_talk:: 

    junoPMTOpticalModel is the FastSim based implementation of the PMT Optical Model.

    However using FastSim comes with a large number of problems. 

    I will remind you of the ones I reported before, and include some
    new issues I found while testing an alternative approach to using FastSim.

    Namely using a custom boundary process. 

 
.. comment

    1. DONE : describe ProcessHits issue, checks, fix 
    2. DONE : present POM:0 standalone check
    3. DONE : insitu POM:0 test
    4. DONE : review j1 notes, for more content 
    5. DONE : bump Custom4, checking without C4_DEBUG running 
    6. DONE : need to reference the issue, branch and merge request 

    7. DONE : C+S C4Lab 
    8. DONE : gun running test
    9. DONE : NoOpticks compile+run test 













junoPMTOpticalModel Issues : All from using FastSim 
----------------------------------------------------

.. sidebar:: :small:`Customized C4OpBoundaryProcess`

    .. class:: small

         * simple 2 volume (Pyrex+Vacuum) geometry 
         * standard G4OpBoundaryProcess reflect/refract/absorb/TIR 
         * :r:`much less code : reuse of standard Geant4`
         * easier Opticks on GPU : simpler, more standard
 
           * no near-degenerate 1e-3 mm boundaries
           * allows same geometry on CPU and GPU 
           * avoid history rewriting for comparisons 
          
         **BUT : need to change very nasty Geant4 impl:**

         ``G4OpBoundaryProcess::PostStepDoIt``
             ugly monolith, rats nest of nested ifs 

         * Unpleasant to get familiar with 
         * Change palatable, using : ``C4CustomART.h``
         * Keep change separated, detailed validation vital 
                

.. raw:: html

   <p style="margin-bottom:1cm;" />


.. class:: small

   1. :r:`Four volume PMT due to FastSim limitation`

      * Two volumes (Pyrex + Vacuum) would be natural 

.. raw:: html

   <p style="margin-bottom:1cm;" />

.. class:: small

   2. :r:`Fake volumes yield many fake intersects`

      * Pyrex/Pyrex + Vacuum/Vacuum same material fakes
      * :b:`complicates Geant4 step point history` 
      * :b:`complicates comparison with Opticks`

.. raw:: html

   <p style="margin-bottom:1cm;" />

.. class:: small

   3. :r:`Non-FastSim in PMT propagate at Pyrex(not Vac.) speed`

      * FastSim->SlowSim transition misses speed fixup 

.. raw:: html

   <p style="margin-bottom:1cm;" />

.. class:: small

   4. :r:`reflected + refracted polarization incorrect`

      * should follow G4OpBoundaryProcess, depending on S/P 

.. raw:: html

   <p style="margin-bottom:1cm;" />

.. class:: small

   5. :r:`ModelTrigger whereAmI BUG` => Unphysical photons  

      * mid-vacuum A,R,T,D inside PMT 
      * "tunneling" through dynode/MCP 


.. comment

   * :b:`All issues stem from using FastSim (designed for regions)`
 
     * :b:`not good fit for 1 boundary (Pyrex/ARC/PHC/Vacuum)`

    .. class:: small

       6. TODO: look into _qe definition 

          * justification for ``efficiency=_qe/An`` ? 



.. s5_talk::
 
    There is quite a long list of FastSim issues, number 5 is the 
    new one : with a fraction of photons behaving unphysically 



:i:`hamaLogicalPMT_fake.png`
------------------------------

.. class:: small
 
   Biggest problem with FastSim based POM : :r:`forces using unnatural geometry`    

.. raw:: html

    <p style="margin-bottom:3cm;" />


.. class:: normal

   |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp|
   :c:`body` hidden under :m:`inner1` :y:`inner2` 

   |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp|
   :c:`body` is :r:`FastSim envelope volume`


.. raw:: html

    <p style="margin-bottom:10cm;" />


.. class:: large

    CURRENT : **Unnatural** 4-volume PMT (Pyrex+Pyrex+Vacuum+Vacuum) => :r:`Half Fake`


.. s5_talk::

    Biggest problem with using FastSim is that it forces using 
    an unnatural PMT geometry 
  
    * natural geometry is 2 volumes : but here there are 4 volumes
    * 2 of them are workarounds that allow FastSim to be used

    Murky colors are because there are near degenerate Fake volumes on top of each other  


:i:`hamaLogicalPMT_natural.png`
---------------------------------

.. class:: small
 
   Biggest advantage with Custom Boundary Process POM : :r:`enables natural geometry`    


.. raw:: html

    <p style="margin-bottom:15.6cm;" />


.. class:: large

    Natural 2-volume PMT (:b:`Pyrex` + :c:`Vacuum`) : :r:`NOT COMPATIBLE WITH FastSim`  


.. s5_talk::

    Natural geometry is not possible when using FastSim









:small:`FIX : Pivot to Custom Boundary Process For PMT Optical Model ?`
-------------------------------------------------------------------------

.. sidebar:: :small:`Custom Boundary POM`

    .. raw:: html 

       <pre class="mypretiny">
         +---------------pmt-Pyrex----------------+
         |                                        |
         |                                        |
         |                                        |
         |       +~inner~Vacuum~~~~~~~~~~~+       |
         |       !                        !       |
         |       !                        !       |
         |       !                        !       |
         |       !                        !       |
         |       !                        !       |
         |       +                        +       |
         |       |                        |       |
         |       |                        |       |
         |       |                        |       |
         |       |                        |       |
         |       |                        |       |
         |       +------------------------+       |
         |                                        |
         |                                        |
         |                                        |
         +----------------------------------------+
       </pre>

    .. class:: small

       ``OpSurfaceName[0] == '@'``

       * ``local_z>0`` : does MultiLayer ART calc 
       * ``!(local_z>0)`` : standard *mirror_opsurf*

.. class:: small
 
   **Custom Boundary Process : Advantages**

   * natural geometry, no fakes
   * standard Geant4 polarization, propagation, time 
   * less code, simpler code
   * simpler Geant4 step history (no fakes)
   * same geometry on GPU+CPU, easier Opticks validation  
   * half the geometry objects to model PMT (4->2)

   +----------------------+-----------------------+
   | Current FastSim POM  | 4 Solid, 4 LV, 4 PV   |
   +----------------------+-----------------------+
   | Custom Boundary POM  | 2 Solid, 2 LV, 2 PV   | 
   +----------------------+-----------------------+

   **Disadvantages**

   * maintain Custom4 C4OpBoundaryProcess  
   * updating Geant4 may require care (depending on changes)  

.. raw:: html 

    <p style="margin-bottom:1cm;" />

.. class:: large

   :r:`Advantages far outweigh disadvantages`

.. s5_talk::

   Customizing Geant4 boundary process does have some disadvantages but 
   the advantages far outweigh them.  It provides a natural fix for 
   all the problems and it requires less code. 

   BUT its a big change, so have to make careful checks of validity 



:small:`C4OpBoundaryProcess::PostStepDoIt : 3-way (A,R,T) Customization`
---------------------------------------------------------------------------------------

.. sidebar:: :small:`PostStepDoIt type switch`

    .. raw:: html

        <pre class="mypretiny">
        if( <span class="r">m_custom_status == 'Y'</span> )
        {
            G4double rand = G4UniformRand();
            if ( rand < theAbsorption )
            {
                <span class="b">DoAbsorption();     // A</span> 
            }
            else
            {
                <span class="r">DielectricDielectric();  // R or T</span>
            }
        }
        else if (type == dielectric_metal) 
        {
              DielectricMetal();
        }
        ...
        </pre>    

    .. class:: small
 
        Standard :b:`DoAbsorption` :r:`DielectricDielectric` reused 



.. class:: small

    :b:`G4OpBoundaryProcess unless OpticalSurfaceNam[0] == '@'/'#'`

.. raw:: html

    <pre class="mypretiny">
    if( OpticalSurfaceName0 == '@' || OpticalSurfaceName0 == '#' )  
    {    
        if( m_custom_art->local_z(aTrack) < 0. ) // <span class="b">Lower hemi : Standard</span>
        {    
            m_custom_status = 'Z' ;
        }    
        else if( OpticalSurfaceName0 == '@') // <span class="b">MultiFilm ART POM</span>
        {    
            <span class="r">m_custom_status = 'Y' ;</span>
            <span class="r">m_custom_art->doIt(aTrack, aStep) ;</span> 

            type = dielectric_dielectric ;
            theModel = glisur ;
            theFinish = polished ;  
        }    
        else if( OpticalSurfaceName0 == '#' ) // <span class="b">Traditional POM</span>
        {    
            m_custom_status = '-' ;

            type = dielectric_metal ;
            theModel = glisur ;
            theReflectivity = 0. ;
            theTransmittance = 0. ;
            theEfficiency = 1. ;
        }
    }
    </pre>

.. class:: small

    *DielectricDielectric* expects 2-way **(theReflectivity,theTransmittance)** => so ``C4CustomART.h`` rescales 3-way **(A,R,T)**

    ``(theAbsorption,theReflectivity,theTransmittance) <= (A, R/(1-A), T/(1-A))``
    

.. s5_talk::

    This shows now the C4OpBoundaryProcess is customized.  It usually does exactly the 
    same as G4OpBoundaryProcess. The customization is only active for OpticalSurfaces
    with names starting with certain prefixes.   


:small:`custom4/C4CustomART.h : include into C4OpBoundaryProcess.cc`
-----------------------------------------------------------------------

.. sidebar:: :small:`C4CustomART customizations`

    .. class:: small

      *doIt* C4MultiLayrStack.h TMM calc, only for:
 
      * OpticalSurfaceName[0]=='@' && local_z > 0  
      * -> :b:`Absorption, Transmittance, Reflectivity, Efficiency`  
      * changed via references collected by ctor 

      :b:`reuse standard G4OpBoundaryProcess`

      * standard reflect, refract, absorb, detect 
      * standard polarization 
      * standard time, speed
      * :r:`"inject" minimal change needed for POM`


.. raw:: html

    <pre class="mypretiny">
    &#35;include "C4IPMTAccessor.h"
    &#35;include "C4MultiLayrStack.h"    
    &#35;include "C4Touchable.h"

    struct C4CustomART {
        <span class="r">const C4IPMTAccessor* accessor ; </span> 
        <span class="b">G4double& theAbsorption ;   // doIt sets these
        G4double& theReflectivity ;
        G4double& theTransmittance ; 
        G4double& theEfficiency ;</span> 
        
        const G4ThreeVector& theGlobalPoint ;
        const G4ThreeVector& OldMomentum ;  
        const G4ThreeVector& OldPolarization ;
        const G4ThreeVector& theRecoveredNormal ;
        const G4double& thePhotonMomentum ; 
        
        C4CustomART(
            const C4IPMTAccessor* accessor,
            G4double& theAbsorption,
            G4double& theReflectivity,
            G4double& theTransmittance,
            G4double& theEfficiency,
            const G4ThreeVector& theGlobalPoint,
            const G4ThreeVector& OldMomentum,  
            const G4ThreeVector& OldPolarization,
            const G4ThreeVector& theRecoveredNormal,
            const G4double& thePhotonMomentum
        );  
        double local_z( const G4Track& aTrack );
        <span class="b">void doIt(const G4Track& aTrack, const G4Step& aStep ); </span>
    };  
    </pre>

.. class:: small

   https://github.com/simoncblyth/customgeant4/blob/main/C4CustomART.h


.. s5_talk::

   Separate header for cleaner customization. 

   `custom4/C4CustomART.h <https://github.com/simoncblyth/customgeant4/blob/main/C4CustomART.h>`_

   Reuse as much of the standard G4OpBoundaryProcess as possible just changing the minimum needed.  


:small:`Custom4 : mini-package with Geant4 customizations`
------------------------------------------------------------

.. sidebar:: :small:`Why Custom4 mini-package ?`

   .. class:: small

       * :r:`Avoid junosw-opticks circular dependency:` 

         * by splitting off Custom4 mini-package

       * ``Custom4`` depends only on Geant4
       * junosw depends on ``Custom4``
       * opticks uses ``Custom4`` for detailed testing

       Added to : **junoenv/junoenv-external-libs.sh**

       Auto-installed like other externals (eg Geant4), or:

   ::

       cd $JUNOTOP/junoenv
       bash junoenv libs get custom4
       bash junoenv libs conf custom4
       bash junoenv libs make custom4
       bash junoenv libs install custom4

       bash junoenv libs all custom4

       
 
.. image:: Custom4/Custom4_README.png
   :width: 580px
   :align: left


.. class:: small

    https://github.com/simoncblyth/customgeant4/


.. s5_talk::

   Circular dependency should be avoided when possible, so I did that by 
   splitting of the customization into a mini-package which is a junoenv external, 
   just like Geant4 is.  



:small:`PMT/POM quadrants : choice of PMT geometry and Optical Model impl.`
-----------------------------------------------------------------------------------------

.. class:: small

    +----------------------------------+-----------------------------------+----------------------------------+   
    | 4 POM*PMT quadrants              | Unnatural PMT Impl                | Natural PMT Impl                 |
    |                                  |                                   |                                  |
    |                                  | ``--pmt-unnatural-geometry``      | ``--pmt-natural-geometry``       |
    |                                  | *m_UsePMTNaturalGeometry:false*   | *m_UsePMTNaturalGeometry:true*   |        
    +==================================+===================================+==================================+   
    | **Traditional POM                |                                   |                                  |
    | (photons stop at photocathode,   |                                   |                                  | 
    | none enter PMT)**                |                                   |                                  |
    |                                  |                                   |                                  |
    | PMT innards modelled with only   | OpticalSurfaceName                | OpticalSurfaceName               |
    | (QE,CE)                          | without prefix                    | starting '#'                     |
    |                                  |                                   |                                  |
    | ``--no-pmt-optical-model``       |                                   | :b:`C4OpBoundaryProcess active`  |
    | *m_UsePMTOpticalModel:false*     |                                   |                                  |
    +----------------------------------+-----------------------------------+----------------------------------+
    | **MultiFilm POM                  |                                   |                                  |
    | (photons refract                 | :r:`junoPMTOpticalModel           | C4MultiLayrStack.h               |
    | into PMT, complex                | FastSim in control`               | C4CustomART.h                    |
    | rindex layers)**                 | (boundary process not run)        |                                  | 
    |                                  |                                   |                                  |
    |                                  |                                   |                                  |
    |                                  | OpticalSurfaceName                | OpticalSurfaceName               |
    |                                  | without prefix                    | starting '@'                     |
    |                                  |                                   |                                  |
    |                                  |                                   | :b:`C4OpBoundaryProcess Active`  |
    | ``--pmt-optical-model``          |                                   | **DEFAULT QUADRANT**             |
    | *m_UsePMTOpticalModel:true*      |                                   |                                  |
    +----------------------------------+-----------------------------------+----------------------------------+


.. class:: small

    ``C4OpBoundaryProcess`` exactly same as ``G4OpBoundaryProcess``, unless:  
       1. OpticalSurfaceName starts '@' or '#' 
       2. intersect onto solid "upper" (local_z > 0) 

     
.. s5_talk::

    Just like the POM switch for the optical model there is 
    also a switch for the unnatural or natural PMT geometry implementation. 




:small:`Standalone PMT tests : junosw extracts + Custom4 + Geant4` 
---------------------------------------------------------------------------------------------

.. sidebar:: :small:`Standalone Advantages`

    .. class:: small

        * :r:`Fast development cycle`, full control:

        +------------------------------------------------+
        | https://github.com/simoncblyth/j/              |
        +------------------------------------------------+
        | https://bitbucket.org/simoncblyth/opticks/     | 
        +------------------------------------------------+
        | https://github.com/simoncblyth/customgeant4/   |
        +------------------------------------------------+


.. class:: small

    **j:PMTSim Standalone PMT geometry and Optical Model** 

    * https://github.com/simoncblyth/j/tree/main/PMTSim
    * "virtual pkg" : :r:`reference junosw/blyth-88 branch sources`
    * :r:`Depends on Custom4 mini-package`, Geant4, opticks/SysRap

    Quadrant Controls:

    * ``N=0/1`` **PMT geometry impl switch**
    * ``POM=0/1`` **PMT Optical Model impl switch**

    **Optical only Geant4 simulation, with full step point recording**  

    * `opticks:u4/tests/U4SimulateTest.sh <https://bitbucket.org/simoncblyth/opticks/src/master/u4/tests/U4SimulateTest.sh>`_

    ``N=0/1 POM=0/1 ./U4SimulateTest.sh``

    **Geant4 Simtrace intersection : 2D geometry plotting**  

    * `opticks:u4/tests/U4SimtraceTest.sh <https://bitbucket.org/simoncblyth/opticks/src/master/u4/tests/U4SimtraceTest.sh>`_

    ``N=0/1 ./U4SimtraceTest.sh``


.. s5_talk::

    In order to test the pivot, I started with standalone tests using simple
    geometries with a few PMTs only.  Standalone testing has a much faster 
    development cycle so its advantageous to do all initial developments 
    whilst running standalone tests. 
    




:i:`FewPMT_demo.png`
-----------------------


.. raw:: html

    <p style="margin-bottom:172mm;" />

.. class:: small

   two_pmt layout with HAMA, NNVT (Natural Geometry N=1)


.. s5_talk::

    Natural HAMA and NNVT geometries.


:i:`FewPMT_demo0.png`
----------------------

.. raw:: html

    <p style="margin-bottom:172mm;" />

.. class:: small

   Compare Unnatural/Natural N=0/1 geometry simulations by skipping N=0 Pyrex/Pyrex + Vacuum/Vacuum fake points


.. s5_talk::

    Unnatural HAMA and NNVT geometries.



Statistical Comparison of Simulation Histories
------------------------------------------------

.. class:: small

   +-------+--------------+----------------------------------------------------------------------------------+
   |       |  Geometry    |                                                                                  |
   +=======+==============+==================================================================================+
   | **A** | N=0          | Unnatural 4-volume Pyrex+Pyrex+Vacuum+Vacuum PMT Geometry (FastSim kludge)       |
   +-------+--------------+----------------------------------------------------------------------------------+
   | **B** | N=1          | Natural 2-volume Pyrex+Vacuum PMT Geometry (Using Custom4 C4OpBoundaryProcess)   | 
   +-------+--------------+----------------------------------------------------------------------------------+

   As comparing simulations from different geometries : :b:`random aligned comparison is impractical`, so:

   1. skip recording fake points (Vacuum/Vacuum + Pyrex/Pyrex) -> :b:`make histories comparable` 
   2. validate using statistical comparison of photon simulation histories : **chi2 history matching**  
  
   Initial comparisons : 

   * :red:`HUGE Chi2` 

     * very different history counts between simulations 

   * find : ~2.5% of "whereAmI:Pyrex" **junoPMTOpticalModel::ModelTrigger** actually in Vacuum 

     * -> :r:`Unphysical reflect/refract/absorb/detect in middle of PMT vacuum` 
     * :b:`unphysical N=0 behaviour` -> huge chi2 in A/B comparison 


.. s5_talk::

   Because the pivot is changing the geometry an aligned comparison is not practical, 
   from divergence of the random streams when reaching different geometry. 


:small:`Unphysical junoPMTOpticalModel::ModelTrigger FastSim Examples`
--------------------------------------------------------------------------

.. class:: small

    FastSim **junoPMTOpticalModel::ModelTrigger** should happen:
 
    1. on Vac/Vac inner1/inner2 border in middle of PMT 
    2. on Pyrex/Pyrex pmt/body border around upper hemi-ellipsoid 

    :b:`ModelTrigger elsewhere is a BUG` -> unphysical results, including :r:`"tunneling" through geometry`  


    Commandlines to create plots showing : :r:`NNVT Unphysical mid-Vacuum Reflect/Refract/Detect/Absorb` 

    * caused by "Undefined" behaviour of **junoPMTOpticalModel::ModelTrigger** 

.. raw:: html 

    <pre class="mypretiny">
    APID=2181 AOPT=idx N=0 SUBTITLE="9:reflect at vac/vac (but obscured)" ./U4SimtraceTest.sh ana

    APID=2563 AOPT=idx N=0 SUBTITLE="7:SD at vac/vac" ./U4SimtraceTest.sh ana

    APID=2912 AOPT=idx N=0 SUBTITLE="7:vac/vac refract 11:SD detect in vac" ./U4SimtraceTest.sh ana

    APID=2942 AOPT=idx N=0 SUBTITLE="6->7:cross-geometry 7:vac/vac-reflect" ./U4SimtraceTest.sh ana

    APID=2982 AOPT=idx N=0 SUBTITLE="7:unphysical refract" ./U4SimtraceTest.sh ana

    APID=5866 AOPT=idx N=0 SUBTITLE="7:reflect at vac/vac" ./U4SimtraceTest.sh ana

    APID=7625 AOPT=idx N=0 SUBTITLE="13:detect mid vacuum" ./U4SimtraceTest.sh ana

    APID=8499 AOPT=idx N=0 SUBTITLE="13:detect mid vacuum" ./U4SimtraceTest.sh ana 
    </pre>


.. s5_talk::

    Examples of unphysical photons easy to find 




:i:`FewPMT_2563_Unphysical_SD_in_vacuum.png`
---------------------------------------------

.. s5_talk::

    SURFACE_DETECT in middle of PMT vacuum 



:i:`FewPMT_2912_Unphysical_refract_and_detect.png`
----------------------------------------------------

.. s5_talk::

    REFRACT in middle of PMT vacuum 


:i:`FewPMT_2942_Unphysical_cross_geometry_vac_reflect.png`
------------------------------------------------------------

.. s5_talk::

    Tunneling and reflect in vacuum 



:i:`FewPMT_2982_Unphysical_vac_refract.png`
---------------------------------------------

.. s5_talk::

    Vacuum refract 


:i:`FewPMT_5866_vac_reflect.png`
----------------------------------

.. s5_talk::

    Vacuum reflect 


:i:`FewPMT_7625_Unphysical_detect_mid_vacuum.png`
--------------------------------------------------

.. s5_talk::

    Vacuum SD



:i:`FewPMT_8499_Unphysical_detect_mid_vacuum.png`
--------------------------------------------------


.. s5_talk::

    Vacuum SD



:small:`Debug junoPMTOpticalModel::ModelTrigger with simple struct` 
---------------------------------------------------------------------

.. sidebar:: :small:`ModelTrigger_Debug.h`

   .. class:: small 

       * :b:`add()` collects struct into RECORD vector
       * :r:`Array()` serializes RECORD vector into NP 
       * ipython/NumPy analysis of arrays

       * https://github.com/simoncblyth/np/

       :r:`Record details of every candidate trigger` 


.. raw:: html 

   <pre class="mypretiny">
    &#35;include "NPX.h"

    struct ModelTrigger_Debug
    {
       static constexpr const char* NAME = "ModelTrigger_Debug.npy" ; 
       static std::vector&lt;ModelTrigger_Debug&gt; RECORD ; 
       static const int NUM_QUAD = 7 ;
       
       <span class="b">void add(){ RECORD.push_back(*this); }</span>

       <span class="r">static NP* Array(){ return
       NPX::ArrayFromVec&lt;double,ModelTrigger_Debug&gt;(RECORD,NUM_QUAD,4);
       }</span> 

       static void Save(const char* savedir); 
       
       double pos_x ;       // 00
       double pos_y ;       // 01
       double pos_z ;       // 02
       double time ;        // 03
       ...
       
       double   dist1 ;     // 20
       double   dist2 ;     // 21
       uint64_t mlv   ;     // 22
       uc8      etrig ;     // 23
       
       uint64_t index ;     // 30 
       uint64_t pv ;        // 31
       uint64_t whereAmI ;  // 32
       uint64_t trig ;      // 33
       ...
    };
    </pre>   

.. class:: small

   Simulation/DetSimV2/PMTSim/include/ModelTrigger_Debug.h


.. s5_talk::

   Collect ModelTrigger_Debug arrays for analysis 



:i:`FewPMT_NNVT_ModelTriggerBuggy_inner2_Pyrex_trig.png`
---------------------------------------------------------

.. raw:: html

    <p style="margin-bottom:165mm;" />

.. class:: small

    :b:`Reflection off NNVT innards => misplaced "Pyrex" ModelTrigger =>` :r:`FastSim too soon => Unphysical photons` 


.. s5_talk::

    Plotting the positions of the model triggers shows misplaced triggers for NNVT



:i:`FewPMT_HAMA_ModelTriggerBuggy_no_inner2_Pyrex_trig.png`
------------------------------------------------------------

.. raw:: html

    <p style="margin-bottom:165mm;" />

.. class:: small

    :r:`Why no similar ModelTriggerBuggy problem for HAMA ?` **Undefined behaviour of G4UnionSolid::DistanceToIn from Inside** 


.. s5_talk::

    BUT : no similar problem with HAMA ? Why ? 

    




:small:`junoPMTOpticalModel::ModelTrigger : NNVT : ~2.5% UNPHYSICAL TRIG`
------------------------------------------------------------------------------------------

::

    u4/tests/U4SimulateTest.sh 
    u4/tests/U4SimulateTest_mt.py


.. class:: small

   Check ModelTrigger position, whereAmI : 271/11214 ~2.5% unphysical

.. raw:: html 

    <pre class="mypretiny">
    mtd_trig = mtd.trig == 1
    mtd_upper = mtd.pos[:,2] > 1e-4
    mtd_mid   = np.abs( mtd.pos[:,2]) < 1e-4
    mtd_lower = mtd.pos[:,2] < -1e-4

    mtd_trig_vacuum = np.logical_and(mtd.trig == 1, mtd.whereAmI_ == 2 )
    mtd_trig_vacuum_upper = np.logical_and(mtd_trig_vacuum, mtd_upper )
    mtd_trig_vacuum_mid   = np.logical_and(mtd_trig_vacuum, mtd_mid )
    mtd_trig_vacuum_lower = np.logical_and(mtd_trig_vacuum, mtd_lower )

    mtd_trig_pyrex  = np.logical_and(mtd.trig == 1, mtd.whereAmI_ == 1 )
    mtd_trig_pyrex_upper = np.logical_and(mtd_trig_pyrex, mtd_upper )
    mtd_trig_pyrex_mid   = np.logical_and(mtd_trig_pyrex, mtd_mid )
    mtd_trig_pyrex_lower = np.logical_and(mtd_trig_pyrex, mtd_lower )
    </pre>

.. class:: small

    NumPy mask expressions used for ModelTrigger_Debug analysis



.. s5_talk::

   These are examples of NumPy expressions for selecting from arrays  



:small:`Implications of whereAmI bug for NNVT ModelTrigger results`
-------------------------------------------------------------------------------------------------------

.. class:: small

    ``~/opticks/u4/tests/G4VSolid_Test.{sh,cc}`` 

    :r:`G4UnionSolid::DistanceToIn(DistanceToOut) from Inside(Outside) is "Undefined"` :b:`BUT GEANT4 DOES NOT CHECK`


.. raw:: html

    <pre class="mypretiny">
    &gt; u4t ; ./G4VSolid_Test.sh 
                                                                 NNVT INNER2: Just Lower-Hemi-Ellipsoid
            pos    INNER1  DistToIn DistToOut      Dist        INNER2  DistToIn DistToOut      Dist     trig
       (0,0,20)   kInside  170.0000  170.0000  170.0000      kOutside kInfinity    0.0000 kInfinity      YES
       (0,0,15)   kInside  175.0000  175.0000  175.0000      kOutside kInfinity    0.0000 kInfinity      YES
       (0,0,10)   kInside  180.0000  180.0000  180.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,5)   kInside  185.0000  185.0000  185.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,4)   kInside  186.0000  186.0000  186.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,3)   kInside  187.0000  187.0000  187.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,2)   kInside  188.0000  188.0000  188.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,1)   kInside  189.0000  189.0000  189.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,0)  kSurface    0.0000  190.0000  190.0000      kSurface kInfinity    0.0000    0.0000      YES
       (0,0,-1)  kOutside    1.0000  191.0000    1.0000       kInside kInfinity    1.0000    1.0000      YES
       (0,0,-2)  kOutside    2.0000  192.0000    2.0000       kInside kInfinity    2.0000    2.0000      YES
       (0,0,-3)  kOutside    3.0000  193.0000    3.0000       kInside kInfinity    3.0000    3.0000      YES
       (0,0,-4)  kOutside    4.0000  194.0000    4.0000       kInside kInfinity    4.0000    4.0000      YES
       (0,0,-5)  kOutside    5.0000  195.0000    5.0000       kInside kInfinity    5.0000    5.0000      YES
       (0,0,-6)  kOutside    6.0000  196.0000    6.0000       kInside kInfinity    6.0000    6.0000      YES
       (0,0,-7)  kOutside    7.0000  197.0000    7.0000       kInside kInfinity    7.0000    7.0000      YES
       (0,0,-8)  kOutside    8.0000  198.0000    8.0000       kInside kInfinity    8.0000    8.0000      YES
       (0,0,-9)  kOutside    9.0000  199.0000    9.0000       kInside kInfinity    9.0000    9.0000      YES
      (0,0,-10)  kOutside   10.0000  200.0000   10.0000       kInside kInfinity   10.0000   10.0000      YES
    </pre>

.. class:: small

    * DistanceToIn, DistanceToOut, ``Distance_`` in +Z direction from points along Z axis
    * CSG constituent structure of NNVT inner1/inner2 yield mis-placed Pyrex triggers for Z > -185 mm


.. s5_talk::

    Testing the ModelTrigger logic from a variety of positions along Z axis

    * bug causes "Undefined" behaviour
 


:small:`Distance uses DistanceToOut/In depending on G4VSolid::Inside`
-------------------------------------------------------------------------

.. class:: small

   * Returns distance to first intersect from position *pos* in direction *dir*, :r:`just like a ray tracer` 

::

    inline G4double Distance(
         const G4VSolid* solid, 
         const G4ThreeVector& pos, const G4ThreeVector& dir, EInside& in ) 
    {
        in = solid->Inside(pos) ; 
        G4double t = kInfinity ; 
        switch( in )
        {   
            case kInside:  t = solid->DistanceToOut( pos, dir ) ; break ; 
            case kSurface: t = solid->DistanceToOut( pos, dir ) ; break ; 
            case kOutside: t = solid->DistanceToIn(  pos, dir ) ; break ; 
        }   
        return t ; 
    }

.. class:: small

   * Avoid "Undefined" result by using appropriate ``DistanceToOut`` or ``DistanceToIn`` method.

.. s5_talk::

   The Geant4 simtrace geometry plots are based on this kind of Distance function.   



:small:`Implications of whereAmI bug for HAMA ModelTrigger results`
-------------------------------------------------------------------------------------------------------

.. class:: small 

    * DistanceToIn, DistanceToOut, Distance in +Z direction from points along Z axis

.. raw:: html

    <pre class="mypretiny">
    &gt; u4t ; ./G4VSolid_Test.sh 
                                                                 HAMA INNER2: Union of Polycone and Lower-Hemi-Ellipsoid
            pos    INNER1  DistToIn DistToOut      Dist        INNER2  DistToIn DistToOut      Dist     trig
       (0,0,20)   kInside  170.0000  170.0000  170.0000      kOutside kInfinity    0.0000 kInfinity      YES
       (0,0,15)   kInside  175.0000  175.0000  175.0000      kOutside kInfinity    0.0000 kInfinity      YES
       (0,0,10)   kInside  180.0000  180.0000  180.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,5)   kInside  185.0000  185.0000  185.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,4)   kInside  186.0000  186.0000  186.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,3)   kInside  187.0000  187.0000  187.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,2)   kInside  188.0000  188.0000  188.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,1)   kInside  189.0000  189.0000  189.0000      kOutside kInfinity    0.0000 kInfinity      YES
        (0,0,0)  kSurface    0.0000  190.0000  190.0000      kSurface kInfinity    0.0000    0.0000      YES
       (0,0,-1)  kOutside    1.0000  191.0000    1.0000       kInside kInfinity    1.0000    1.0000      YES
       (0,0,-2)  kOutside    2.0000  192.0000    2.0000       kInside kInfinity    2.0000    2.0000      YES
       (0,0,-3)  kOutside    3.0000  193.0000    3.0000       kInside kInfinity    3.0000    3.0000      YES
       (0,0,-4)  kOutside    4.0000  194.0000    4.0000       kInside kInfinity    4.0000    4.0000      YES
       (0,0,-5)  kOutside    5.0000  195.0000    5.0000       kInside    0.0000    5.0000    5.0000      NO 
       (0,0,-6)  kOutside    6.0000  196.0000    6.0000       kInside    1.0000    6.0000    6.0000      NO 
       (0,0,-7)  kOutside    7.0000  197.0000    7.0000       kInside    2.0000    7.0000    7.0000      NO 
       (0,0,-8)  kOutside    8.0000  198.0000    8.0000       kInside    3.0000    8.0000    8.0000      NO 
       (0,0,-9)  kOutside    9.0000  199.0000    9.0000       kInside    4.0000    9.0000    9.0000      NO 
      (0,0,-10)  kOutside   10.0000  200.0000   10.0000       kInside    5.0000   10.0000   10.0000      NO 
    </pre>


.. class:: small

    * HAMA INNER2 has equatorial cylinder from Z=-5 mm to Z=0 mm (NNVT has no such cylinder) 
    * The equatorial cylinder changes the "Undefined" behavior preventing triggers below Z=-5 mm 
    * :r:`So ModelTrigger bug is avoided for HAMA by "Undefined" behaviour` :b:`(NOT GOOD)`


.. s5_talk::

   Mock up the geometry and scan Distance functions to understand why HAMA not giving bad triggers



:small:`junoPMTOpticalModel::ModelTrigger BUG => Unphysical Photons`
---------------------------------------------------------------------

.. sidebar:: :small:`ModelTrigger whereAmI bug`

    .. raw:: html 

       <pre class="mypretiny">+----------*----pmt-Pyrex----------------+
       |                                        |
       |                                        |
       |     +------*-------body-Pyrex----+     |
       |     | +-----*-------inner1-Vac-+ |     |
       |     | |      \                 | |     |
       |     | |       \                | |     |
       |     | |        \               |-|     |
       |     | |         \              |1e-3   |
       |     | |          \             | |     |
       |     | +~~vac/vac~~\~~~~~!~~~~~~+ |     |
       |     | |            \   / \     | |     |
       |     | |             \ /   \    | |     |
       |     | |     +--------*---+ \   | |     |
       |     | |     | dynode/MCP |  \  | |     |
       |     | |     +------------+   \ | |     |
       |     | +-inner2-Vac------------*+ |     |
       |     +----------------------------+     |
       |                                        |
       |                                        |
       +----------------------------------------+
       </pre>

    .. class:: small

       * dyn/MCP reflect => whereAmI:kInGlass 
       * -> :r:`unphysical mid Vacuum A/R/T/D`
       * "Undefined" G4VSolid::DistanceToIn


.. raw:: html

   <pre class="mypretiny">
    G4bool junoPMTOpticalModel::ModelTrigger(const G4FastTrack &fastTrack)
    {   <span class="r">// GetVolume : CAUTION NEEDED AT BORDERS </span> 
      ...
      if(fastTrack.GetPrimaryTrack()->GetVolume() == _inner2_phys){
          return false;
      }   <span class="r">// SIMPLISTIC VIEW OF GEOMETRY </span>
      if(fastTrack.GetPrimaryTrack()->GetVolume() == _inner1_phys){
          whereAmI = kInVacuum;
      }else{
          whereAmI = kInGlass;
          <span class="r">// BUG: REFLECTION FROM dynode/MCP -> kInGlass </span>
      }
      if(whereAmI == kInGlass){ 
          dist1 = _inner1_solid->DistanceToIn(pos, dir);
          <span class="r">dist2 = _inner2_solid->DistanceToIn(pos, dir);</span>
          <span class="r">// BUG: dist2 "Undefined" at reflect inside inner2</span>
          if(dist1 == kInfinity){ return false;
          }else if(dist1>dist2){  return false;
          }else{                  return true;}     
          <span class="r">// BUG: depends on "Undefined" behaviour (+CSG constituents) </span> 
      }else{
          dist1 = _inner1_solid->DistanceToOut(pos, dir);
          dist2 = _inner2_solid->DistanceToIn(pos, dir);
          if(dist2 == kInfinity){ return true;}
          <span class="b"> // reliance on edge handling : not a good approach</span> 
      }
      return false;
    }  
 
  </pre>


.. s5_talk::

    Looking back at the implementation : the bug is obvious 



:small:`junoPMTOpticalModel::ModelTrigger FIXED`
---------------------------------------------------------------------

.. sidebar:: :small:`FIXED : "Ray Style" ModelTrigger`

    .. raw:: html 

        <pre class="mypretiny">
        G4bool ModelTrigger(const G4FastTrack &fastTrack)
        {
          bool trig = false ; 
          dist1 = Distance( _inner1_solid, pos, dir, in1 );
          if( dist1 != kInfinity && dist1 > EPSILON )
          {
            next_pos = pos + dir*dist1 ;
            trig = next_pos.z() > EPSILON ;  
            // disqualify flat face intersects 

            next_norm = _inner1_solid->SurfaceNormal(next_pos);
            next_mct  = next_norm * dir ; 
            whereAmI  = next_mct < 0. ? kInGlass : kInVacuum ; 
            // against/with normal is Glass/Vacuum
          }
          return trig ;
        }
        const G4double EPSILON = 2e-4 ;
        </pre>

    .. class:: small

        :b:`Use: Distance, SurfaceNormal` -- :r:`NOT Volumes`


.. raw:: html

   <pre class="mypretiny">
    G4bool junoPMTOpticalModel::ModelTrigger(const G4FastTrack &fastTrack)
    {   <span class="r">// GetVolume : NOT RELIABLE AT BORDERS </span> 
      ...
      if(fastTrack.GetPrimaryTrack()->GetVolume() == _inner2_phys){
          return false;
      }   <span class="r">// SIMPLISTIC VIEW OF GEOMETRY </span>
      if(fastTrack.GetPrimaryTrack()->GetVolume() == _inner1_phys){
          whereAmI = kInVacuum;
      }else{
          whereAmI = kInGlass;
          <span class="r">// BUG: REFLECTION FROM dynode/MCP -> kInGlass </span>
      }
      if(whereAmI == kInGlass){ 
          dist1 = _inner1_solid->DistanceToIn(pos, dir);
          <span class="r">dist2 = _inner2_solid->DistanceToIn(pos, dir);</span>
          <span class="r">// BUG: dist2 "Undefined" at reflect inside inner2</span>
          if(dist1 == kInfinity){ return false;
          }else if(dist1>dist2){  return false;
          }else{                  return true;}     
          <span class="r">// BUG: depends on "Undefined" behaviour (+CSG constituents) </span> 
      }else{
          dist1 = _inner1_solid->DistanceToOut(pos, dir);
          dist2 = _inner2_solid->DistanceToIn(pos, dir);
          if(dist2 == kInfinity){ return true;}
          <span class="b"> // reliance on edge handling : not a good approach</span> 
      }
      return false;
    }  
   </pre>

.. class:: small

    * :b:`Need to fix FastSim approach : to have something to validate new natural geometry approach with`


.. s5_talk::

    Straightforward FIX 




:i:`FewPMT_NNVT_ModelTriggerSimple_avoids_issue.png`
-----------------------------------------------------

.. raw:: html

    <p style="margin-bottom:165mm;" />

.. class:: small

    :r:`ModelTriggerSimple` : Avoids **Undefined trig behavior** + Unphysical mid-Vacuum Reflect/Refract/Detect/Absorb, "Tunneling" 


.. s5_talk::

    Using the fixed ModelTrigger avoids the bad triggers




:i:`FewPMT_check_mtd_trig_vacuum_upper_due_to_obliques.png`
------------------------------------------------------------


.. raw:: html

    <p style="margin-bottom:90mm;" />

    <div style="max-width:200mm;background-color:white;" > mtd_trig_vacuum_upper initially seems surprising : but actually it is expected 
        from "oblique" py->vac paths 
    </div>
    <div style="max_width:200mm;background-color:white;"> quiver plot (mtd_pos, mtd_dir) with scatter plot of mtd_pos and mtd_next_pos </div>
     

.. s5_talk::

    This was not presented. Added afterwards prompted by a question from Ziyan.  



:small:`N0_one_pmt_FewPMT_hamaLogicalPMT_rain_line_012last.png`
----------------------------------------------------------------------

.. raw:: html

    <p style="margin-bottom:165mm;" />

.. class:: small

    ``N=0`` Unnatural : HAMA "rain_line" photon positions : 0th:blue 1st:red last:cyan


.. s5_talk::

    Fixing the ModelTrigger now allows a comparison of Unnatural and Natural geometry 



:small:`N1_one_pmt_FewPMT_hamaLogicalPMT_rain_line_012last.png`
----------------------------------------------------------------------


.. raw:: html

    <p style="margin-bottom:165mm;" />

.. class:: small

    ``N=1`` Natural : HAMA "rain_line" photon positions : 0th:blue 1st:red last:cyan


.. s5_talk::
 
   Shows positions of 0th 1st and last photon points 




:small:`NNVT : "rain_line" Example of Statistical History Comparison`
------------------------------------------------------------------------

.. raw:: html

   <pre class="mypretiny">
    ./U4SimulateTest.sh cf ## PMT Geometry : A(N=0) Unnatural+FastSim, B(N=1) Natural+CustomBoundary  
    GEOM/GEOMList/IMPL/LAYOUT/CHECK : FewPMT/nnvtLogicalPMT/ModelTriggerSimple/one_pmt/rain_line 
    <span class="b">c2sum :    60.2333 c2n :    67.0000 c2per:     0.8990  C2CUT:   30 </span>

    np.c_[siq,_quo,siq,sabo2,sc2,sabo1][:25]  ## A-B history frequency chi2 comparison 
    [[' 0' TO BT SD                             ' 37975  37525' ' 2.6821' '  1268   1268']
     [' 1' TO BT SA                             ' 32161  32735' ' 5.0770' '  1174   1200']
     [' 2' TO BT BT SR SA                       '  4980   4998' ' 0.0325' ' 11979  12125']
     [' 3' TO BT BT SA                          '  4392   4362' ' 0.1028' ' 10275  10285']
     [' 4' TO BT BT SR BT BT SA                 '  4366   4366' ' 0.0000' ' 21394  21384']
     [' 5' TO BT BR BT SA                       '  3225   3153' ' 0.8128' '  1286   1269']
     [' 6' TO SA                                '  2281   2283' ' 0.0009' '     0      0']
     [' 7' TO BT BT SR BR SR SA                 '  1185   1280' ' 3.6613' ' 22175  22191']
     [' 8' TO BT BT SR BR SA                    '  1151   1150' ' 0.0004' ' 21484  21399']
     [' 9' TO BR SA                             '  1051   1091' ' 0.7470' '  1154   1154']
     ['10' TO BT BT SR SR SA                    '   742    730' ' 0.0978' ' 11888  11906']
     ['11' TO BT BT SR BR SR BT BT SA           '   714    694' ' 0.2841' ' 22163  22168']
     ['12' TO BT BT SR BR SR SR SA              '   396    324' ' 7.2000' ' 22136  23759']
     ['13' TO BT BT SR SR BT BT SA              '   368    357' ' 0.1669' ' 18370  18360']
     ['14' TO BT AB                             '   341    367' ' 0.9548' '  1483   1417']
     ['15' TO BT BT SR BR SR SR BT BT SA        '   363    338' ' 0.8916' ' 22134  22135']
     ['16' TO BT BT SR SR SR SA                 '   285    276' ' 0.1444' ' 11903  12085']
     ['17' TO BT BT SR SR SR BT BT SA           '   239    238' ' 0.0021' ' 13690  13690']
     ['18' TO BT BT SR BR SR BR SR BT BT SA     '   225    236' ' 0.2625' ' 22345  22388']

                                                      A      B    (A-B)^2   APID[0] BPID[0]
                                                                -------
                                                                  (A+B)        
   </pre>

.. class:: small

    Compare simulations by chi2 comparison of photon history counts 

    * TO:Torch, BT:BoundaryTransmit, SD:SurfDetect, SA:SurfAbsorb, SR:SpecularReflect, BR:FresnelReflect, AB:BulkAbsorb

    * :r:`chi2 value indicates the two simulations have consistent photon histories`


.. s5_talk::

    Chi2 comparison shows the two simulations have consistent photon histories



:small:`HAMA : "rain_line" Example of Statistical History Comparison`
------------------------------------------------------------------------

.. raw:: html

   <pre class="mypretiny">
    ./U4SimulateTest.sh cf ## PMT Geometry : A(N=0) Unnatural+FastSim, B(N=1) Natural+CustomBoundary  
    GEOM/GEOMList/IMPL/LAYOUT/CHECK : FewPMT/hamaLogicalPMT/ModelTriggerSimple/one_pmt/rain_line 
    <span class="b">c2sum :    41.2803 c2n :    43.0000 c2per:     0.9600  C2CUT:   30</span> 

    np.c_[siq,_quo,siq,sabo2,sc2,sabo1][:25]  ## A-B history frequency chi2 comparison 
    [[' 0' 'TO BT SD                        '' 37923  37958' ' 0.0161' '  1262   1274']
     [' 1' 'TO BT SA                        '' 32806  32562' ' 0.9108' '  1185   1207']
     [' 2' 'TO BT BT SA                     '' 12071  12233' ' 1.0798' ' 10532  10430']
     [' 3' 'TO BT BT SR SA                  ''  3757   3741' ' 0.0341' ' 12754  12407']
     [' 4' 'TO BT BR BT SA                  ''  3204   3250' ' 0.3279' '  1465   1464']
     [' 5' 'TO SA                           ''  2277   2274' ' 0.0020' '     1      0']
     [' 6' 'TO BT BT SR SR SA               ''  1857   1859' ' 0.0011' ' 12391  12393']
     [' 7' 'TO BR SA                        ''  1129   1215' ' 3.1553' '  1154   1154']
     [' 8' 'TO BT BT SR SR SR BT BT SA      ''   613    580' ' 0.9128' ' 16112  16120']
     [' 9' 'TO BT BT SR SR SR SA            ''   584    576' ' 0.0552' ' 13493  16172']
     ['10' 'TO BT BT SR BT BT SA            ''   357    375' ' 0.4426' ' 34234  34225']
     ['11' 'TO BT AB                        ''   356    325' ' 1.4112' '  1367   1317']
     ['12' 'TO BT BT SR BR SA               ''   287    305' ' 0.5473' ' 34230  34221']
     ['13' 'TO BT BT SR SR BT BT SA         ''   243    226' ' 0.6162' ' 27497  27530']
     ['14' 'TO BT BT SR SR SR BR SA         ''   232    206' ' 1.5434' ' 16755  16130']
     ['15' 'TO BT BT SR SR SR BR BT BT SA   ''   200    206' ' 0.0887' ' 16715  16760']
     ['16' 'TO BT BT BR SR SA               ''   181    179' ' 0.0111' ' 10909  10984']
     ['17' 'TO BT BT SR SR SR BR SR SA      ''   146    180' ' 3.5460' ' 16223  16205']
     ['18' 'TO BT BT SR SR SR BR BR SR SA   ''   148    131' ' 1.0358' ' 17957  16775']
     ['19' 'TO AB                           ''   147    126' ' 1.6154' '    86     68']
     ['20' 'TO BT BT SR SR SR BR BR SA      ''   113    111' ' 0.0179' ' 16724  16934']

                                                   A      B    (A-B)^2   APID[0] BPID[0]
                                                              -------
                                                               (A+B)        
   </pre>


.. class:: small 

    * Same for NNVT with this check 
    * :r:`chi2 value indicates the two simulations have consistent photon histories`

.. s5_talk::

    Chi2 comparison shows the two simulations have consistent photon histories



:small:`Checks with different initial photon pos/dir/shapes` 
------------------------------------------------------------------

.. class:: small

    **opticks/u4/tests/U4SimulateTest.sh checks** 

    FewPMT/(hama,nnvt)LogicalPMT/ModelTriggerSimple/one_pmt/...  using 100k/50k photons 
    
    +----------------------+-----------------------------------------------------+----------------------------------------------------+
    |                      |                                                     |           c2sum/c2n:c2per(C2CUT)                   |
    |                      |                                                     +----------------------------------------------------+
    |  check               |                                                     |        HAMA               |          NNVT          |
    +======================+=====================================================+===========================+========================+
    |  rain_disc           |   3D beam directly onto PMT front face              |  32.56/41  0.794 (30)     | 41.91/46:0.911 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  rain_line           |   2D line directly onto PMT midline                 |  41.28/43  0.960 (30)     | 28.85/45:0.641 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  up_rain_line        |   2D line shooting PMT from behind                  |  10.80/24  0.450 (30)     | 6.41/12:0.534 (30)     |            
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  rain_dynode         |   2D line from vacuuum directed onto dynode         |  12.08/11  1.098 (30)     | 23.76/35:0.679 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  rain_dynode_diag    |   2D line diagonnally directed from mid-vacuum      |  8.31/26  0.320 (30)      | 42.82/56:0.765 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  lhs_window_line     |   2D line from left directed onto PMT window        |  37.53/34  1.104 (30)     | 26.74/43:0.622 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+
    |  lhs_reflector_line  |   2D line from left directed onto PMT reflector     |  14.35/18  0.797 (30)     | 15.75/19:0.829 (30)    |
    +----------------------+-----------------------------------------------------+---------------------------+------------------------+

    Obtained using ``opticks/u4/tests/cf.sh`` (runs both simulations and compares)

    :r:`Reasonable Chi2 for all checks` => :b:`consistent simulation histories with Unnatural/Natural geometry`


.. s5_talk::

    Various checks all showing consistent simulation histories 



:small:`N0_one_pmt_FewPMT_hamaLogicalPMT_lhs_window_line_inwin.png`
----------------------------------------------------------------------


.. raw:: html

   <p style="margin-bottom:15cm;" />

.. class:: small

   (N=0) Shoot from side to check PMT window : many photons enter PMT 


.. s5_talk::

   Check PMT window



:small:`N1_one_pmt_FewPMT_hamaLogicalPMT_lhs_window_line_inwin.png`
----------------------------------------------------------------------

.. raw:: html

   <p style="margin-bottom:15cm;" />


.. class:: small

   (N=1) Shoot from side to check PMT window : many photons enter PMT 


.. s5_talk::

   Check PMT window



:small:`N0_one_pmt_FewPMT_hamaLogicalPMT_lhs_reflector_line_reflected.png`
---------------------------------------------------------------------------

.. raw:: html

   <p style="margin-bottom:5cm;" />


.. class:: small

   (N=0) Shoot from side to check PMT reflector : no photons get into PMT 

.. s5_talk::

   Check PMT reflector





:small:`N1_one_pmt_FewPMT_hamaLogicalPMT_lhs_reflector_line_reflected.png`
---------------------------------------------------------------------------

.. raw:: html

   <p style="margin-bottom:5cm;" />


.. class:: small

   (N=1) Shoot from side to check PMT reflector : no photons get into PMT 


.. s5_talk::

   Check PMT reflector




:small:`Standalone then Insitu Testing`
------------------------------------------

.. sidebar:: :small:`Standalone vs Insitu Development`

    .. class:: small

          **Standalone**

          * fully controlled environment
          * eg: Opticks executables, scripts
          * development cycle time :b:`< 1s` 

          **Insitu**

          * fit in with general code
          * eg: run ``tut_detsim.py`` 
          * loads of code irrelevant to what is changed
          * long initialization times 
          * development cycle time :r:`> 3 min` 
        
          **Standalone Cycles much cheaper than Insitu**

          * start development standalone
          * only when standalone succeeds -> insitu
          * :b:`more cycles -> better code, less bugs` 



.. class:: small

    **Standalone Test Architecture**

    * small "FewPMT" geometries 
    * Opticks executable such as U4SimulateTest
    
    **j/PMTSim "virtual" package : PMT Geometry+Model**

    * `github.com/simoncblyth/j/blob/main/PMTSim/CMakeLists.txt <https://github.com/simoncblyth/j/blob/main/PMTSim/CMakeLists.txt>`_
    * ``CMakeLists.txt`` references junosw sources


    **No Known Issues In Standalone Tests**
 
    * => move to insitu tests with junosw ``tut_detsim.py`` 


    **Insitu Testing with:** ``--opticks-mode 2``

    * junosw Geant4 simulation
    * integrated with Opticks Instrumentation (U4Recorder, SEvt)  
    * no GPU usage in this mode 


.. s5_talk::

    Development cycles 



:small:`junosw + Opticks : Input Photon Running : ntds bash function`
--------------------------------------------------------------------------------

.. sidebar:: :small:`Opticks AnaMgr + GtOpticksTool`

    .. class:: small

        **js/U4RecorderAnaMgr -> ok/U4Recorder**

        * ``--opticks-anamgr``
        * G4Track, G4Step -> ok/U4Recorder -> ok/SEvt   
        * ok/SEvt -> .npy NumPy arrays 
        * numpy/matplotlib/pyvista analysis+plotting 

        **js/GtOpticksTool : input photons via GenTool**

        * ``opticks`` instead of eg ``gun``
        * ok/ana/input_photons.sh -> .npy (n,4,4) arrays
        * targetting with Opticks frame selection 

        **OPTICKS_INPUT_PHOTON_FRAME**

        ``solidNamePrefix:ordinal:instance``

        * eg Hama:0:1000 NNVT:0:1000

        :r:`Target specific repeat/instance`


.. raw:: html

    <pre class="mypretiny">
    ntds(){
        local opts=""
        opts="$opts --opticks-mode 2"  # G4 with Opticks Instrumentation  

        case $POM in     ## passed into UsePMTOpticalModel
          0) opts="$opts --no-pmt-optical-model"  ;;  
          1) opts="$opts --pmt-optical-model"     ;;  
        esac 

        <span class="r">case $PMT in  ## passed into UsePMTNaturalGeometry
          0) opts="$opts --pmt-unnatural-geometry" ;;  
          1) opts="$opts --pmt-natural-geometry"   ;;  
        esac</span>

        <span class="m">opts="$opts --opticks-anamgr"  ## Full Photon Point recording   
        export OPTICKS_EVENT_MODE=StandardFullDebug
        export OPTICKS_MAX_BOUNCE=31 
        [ "$PMT" == "0" ] && export U4Recorder__FAKES_SKIP=1</span>

        <span class="b">export OPTICKS_INPUT_PHOTON=RainXZ_Z230_10k_f8.npy
        export OPTICKS_INPUT_PHOTON_FRAME=Hama:0:1000 </span>

        python tut_detsim.py $opts opticks  ## GtOpticksTool 
   }
   </pre>

.. class:: small

    Actual ntds bash function : https://github.com/simoncblyth/j/blob/main/jx.bash



.. s5_talk::

    Switching on Opticks instrumentation within tut_detsim running 





Geant4 + Opticks + NVIDIA OptiX 7 : Hybrid Workflow
------------------------------------------------------

.. s5_talk::

    Full Opticks


Geant4 + Opticks Instrumentation (no GPU usage)
--------------------------------------------------------

.. raw:: html

    <p style="margin-bottom:15cm;" />

.. class:: small

   ``U4Recorder`` : uses CPU Opticks to persist ``SEvt`` photons/histories/.. into NumPy .npy files for analysis 



.. s5_talk::

    Partial Opticks used to instrument Geant4 simulation 







:small:`Opticks SEvt loaded into ipython : arrays detailing every photon point`
---------------------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">In [3]: b  
    Out[3]: 
    b.base:/tmp/blyth/opticks/GEOM/V1J008/ntds2/ALL1/000
      : b.genstep                                          :            (1, 6, 4) : 14:01:49.017610 
      : b.seq                                              :       (100000, 2, 2) : 13:59:54.715319 
      : b.pho0                                             :          (100000, 4) : 14:01:40.913446 
      : b.record                                           :   (100000, 32, 4, 4) : 13:59:55.174871 
      : b.junoSD_PMT_v2                                    :                 (1,) : 14:01:44.544258 
      : b.sframe                                           :            (4, 4, 4) : 13:59:54.714881 
      : b.inphoton                                         :       (100000, 4, 4) : 14:01:44.544879 
      : b.pho                                              :          (100000, 4) : 14:01:42.596733 
      : b.flat                                             :         (100000, 64) : 14:01:49.018186 
      : b.prd                                              :   (100000, 32, 2, 4) : 14:01:26.149970 
      : b.photon                                           :       (100000, 4, 4) : 14:01:26.466269 
      : b.gs                                               :               (1, 4) : 14:01:49.017187 
      : b.aux                                              :   (100000, 32, 4, 4) : 14:01:49.191892 
      : b.tag                                              :          (100000, 4) : 13:59:54.705722 
   </pre>

.. class:: normal

    +------------+------------+----------------------------------------------------+
    |  array     | shape      |  notes                                             |  
    +============+============+====================================================+
    | inphoton   | (n,4,4)    | input photons                                      |
    +------------+------------+----------------------------------------------------+
    | photon     | (n,4,4)    | final photon positions (at AB, SA, SD)             |
    +------------+------------+----------------------------------------------------+
    | record     | (n,32,4,4) | photon histories (up to 32 points)                 |
    +------------+------------+----------------------------------------------------+
    | seq        |  (n,2,2)   | uint64 packed histories eg "TO BT BT SD"           |   
    +------------+------------+----------------------------------------------------+
    | aux        | (n,32,4,4) | extra step point info eg A,R,T                     |       
    +------------+------------+----------------------------------------------------+
    | sframe     | (4,4,4)    | target frame with M2W W2M transforms               |
    +------------+------------+----------------------------------------------------+


.. s5_talk::

    NumPy arrays for analysis




:i:`B_V1J008_N1_ip_MOI_Hama:0:1000_yy_target_frame.png`
----------------------------------------------------------


.. raw:: html

    <p style="margin-bottom:40mm;" />

.. class:: small

    ``cd ~/j/ntds ; N=1 GLOBAL=1 MODE=3 ./ntds.sh ana ## interactive 3D pyvista``

.. raw:: html

    <p style="margin-bottom:100mm;" />

.. class:: small

   ``Target Frame Hama:0:1000``

   ``solidName:ordinalIdx:instanceIdx``


.. s5_talk::

    3D visualize photon points with pyvista


:i:`B_V1J008_N1_ip_MOI_Hama:0:1000_yy_frame_close.png`
----------------------------------------------------------

.. raw:: html

    <p style="margin-bottom:130mm;" />

.. class:: small

    ``Green : start position (100k input photons)`` 

    ``Red : end position,  Cyan : other position``


.. s5_talk::

    squares indicates the target frame



Transform photon history points into target frame
---------------------------------------------------

.. class:: small

    NumPy transform all photon positions to target frame (eg Hama:0:1000)

    * target frame m2w w2m transforms persisted within opticks/SEvt folder  

::

    w2m = evt.f.sframe.w2m          # (4,4)         : world-to-model 
    gpos = b.f.record[:,:,0].copy() # (100000,32,4) : global (pos, time)
    gpos[...,3] = 1.                # use 1. : to transform as position  
    lpos = np.dot( gpos, w2m )      # (100000,32,4) : local (pos, 1) 


.. class:: small

    Suitable : input photon shape, position, direction, target frame 

    * -> action mostly in plane -> 2D plotting (often clearer than 3D)

::

    cd ~/j/ntds ; MODE=2 ./ntds.sh ana


.. class:: small

    https://github.com/simoncblyth/j/blob/main/ntds/ntds.sh
      

.. s5_talk::

    Its useful to transform global positions into the target frame  



:i:`A_V0J008_N0_ip_MOI_Hama:0:1000_a_no_skip_fake.png`
-------------------------------------------------------

.. class:: small

   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   ``cd ~/j/ntds ; N=0 ./ntds.sh ana``  

.. raw:: html

    <p style="margin-bottom:150mm;" />

.. class:: small

   :r:`10k : Unnatural Pyrex+Pyrex+Vac+Vac PMT geometry, without` : ``export U4Recorder__FAKES_SKIP=1``
    

.. s5_talk::

    Without fake skipping the fake intersects are visible


:i:`A_V0J008_N0_ip_MOI_Hama:0:1000_a.png`
-------------------------------------------

.. class:: small

   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   ``cd ~/j/ntds ; N=0 ./ntds.sh ana``  


.. raw:: html

    <p style="margin-bottom:150mm;" />

.. class:: small

   :r:`10k : Unnatural Pyrex+Pyrex+Vac+Vac HAMA PMT geometry, with` : ``export U4Recorder__FAKES_SKIP=1``


.. s5_talk::

   Fake skipping just doesnt record those points

    

:i:`B_V1J008_N1_ip_MOI_Hama:0:1000_b.png`
-------------------------------------------

.. class:: small

   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   ``cd ~/j/ntds ; N=1 ./ntds.sh ana``  

.. raw:: html

    <p style="margin-bottom:150mm;" />

.. class:: small

   :b:`10k : Natural Pyrex+Vac HAMA PMT geometry, no fakes, no skipping needed`
 

.. s5_talk::

   Fake skipping enables the simulations to be compared 




:small:`100k Input Photons targetting Hama:0:1000 Chi2 History Comparison`
---------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">cd ~/j/ntds ; ./ntds.sh cf 
    QCF qcf c2sum/c2n:c2per(C2CUT)  <span class="r">103.55/103:1.005</span> (30)
    np.c_[siq,_quo,siq,sabo2,sc2,sabo1][:25]  ## A-B history frequency chi2 comparison 
    [[' 0' 'TO BT BT BT BT SA                                  ' ' 0' ' 37664  37569'  <span class="r"> 0.1200</span> '     2      1']
     [' 1' 'TO BT BT BT BT SD                                  ' ' 1' ' 30711  30904'  <span class="r"> 0.6045</span> '     4      2']
     [' 2' 'TO BT BT BT BT BT SA                               ' ' 2' ' 12432  12470'  <span class="r"> 0.0580</span> '  9199   8859']
     [' 3' 'TO BT BT BT BT BT SR SA                            ' ' 3' '  3824   3761'  <span class="r"> 0.5233</span> ' 11002  11014']
     [' 4' 'TO BT BT BT BT BT SR SR SA                         ' ' 4' '  1984   1967'  <span class="r"> 0.0731</span> ' 10886  10878']
     [' 5' 'TO BT BT AB                                        ' ' 5' '   853    918'  <span class="r"> 2.3857</span> '     8     27']
     [' 6' 'TO BT BT BT BT BT SR SR SR SA                      ' ' 6' '   583    609'  <span class="r"> 0.5671</span> ' 14779  14727']
     [' 7' 'TO BT BT BT BT BR BT BT BT BT BT SA                ' ' 7' '   444    420'  <span class="r"> 0.6667</span> '  1042   1016']
     [' 8' 'TO BT BT BT BT BR BT BT BT BT BT BT AB             ' ' 8' '   435    430'  <span class="r"> 0.0289</span> ' 10280   7615']
     [' 9' 'TO BT BT BT BT BR BT BT BT BT BT SD                ' ' 9' '   354    328'  <span class="r"> 0.9912</span> '  5253   5256']
     ['10' 'TO BT BT BT BT AB                                  ' '10' '   331    341'  <span class="r"> 0.1488</span> '    84    143']
     ['11' 'TO BT BT BT BT BT SR BR SA                         ' '11' '   258    314'  <span class="r"> 5.4825</span> ' 33580  33573']
     ['12' 'TO BT BT BR BT BT BT SA                            ' '12' '   295    250'  <span class="r"> 3.7156</span> '     0      3']
     ['13' 'TO BT BT BT BR BT BT BT BT SA                      ' '13' '   291    259'  <span class="r"> 1.8618</span> '   213    192']
     ['14' 'TO BT BT BT BT BR BT BT BT BT AB                   ' '14' '   289    275'  <span class="r"> 0.3475</span> '  8511   9213']
     ['15' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT SA       ' '15' '   245    276'  <span class="r"> 1.8445</span> '  9353   9360']
     ['16' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT SD       ' '16' '   261    246'  <span class="r"> 0.4438</span> '  9350   9416']
     ['17' 'TO BT BT BT BT BT SR SR SR BR BT BT BT BT BT BT SA ' '17' '   247    199'  <span class="r"> 5.1659</span> ' 15391  15388']
     ['18' 'TO BT BT BT BT BT SR SR SR BR SA                   ' '18' '   246    227'  <span class="r"> 0.7632</span> ' 14754  15177']
     ['19' 'TO BT BT BT BT BT SR SR BT BT BT BT BT BT SA       ' '19' '   215    194'  <span class="r"> 1.0782</span> ' 26564  26588']
                                                                         <span class="b">  A,B counts    Chi2   A,B 1st photon idx <span> 
    </pre>

.. class:: small

    https://github.com/simoncblyth/j/blob/main/ntds/ntds.sh 

    Chi2 comparison of photon histories for A:Unnatural(fakes skipped) B:Natural geometry 
 
    Any bug changing simulation histories -> huge Chi2 -> :b:`USEFUL METRIC` 

    * BUT: does not catch all issues (eg time offsets)
 

.. s5_talk::

   Chi2 shows the two simulations are consistent 



.. comment

    :i:`A_V0J008_N0_ip_MOI_NNVT:0:1000_100k.png`
    -----------------------------------------------



:small:`Instrument junoSD_PMT_v2::ProcessHits : Compare N=0,1 enum counts`
--------------------------------------------------------------------------------------

.. sidebar:: :small:`Enumerate all returns, Collect`

    .. raw:: html

         <pre class="mypretiny">
         359 #ifdef WITH_G4CXOPTICKS
         360 G4bool junoSD_PMT_v2::ProcessHits(G4Step* step,...)
         361 {   
         362     G4bool is_hit = ProcessHits_(step, nullptr) ;
         363     m_jpmt_dbg->add( m_eph, is_hit );
         373     return is_hit ;
         374 }
         382 #endif
         384 #ifdef WITH_G4CXOPTICKS
         385 G4bool junoSD_PMT_v2::ProcessHits_(G4Step* step,...)
         386 #else
         387 G4bool junoSD_PMT_v2::ProcessHits(G4Step* step,...)
         388 #endif
         389 {
         390     if (m_disable) {
         391 #ifdef WITH_G4CXOPTICKS
         392         m_eph = EPH::NDIS ;
         393 #endif
         394         return false;
         395     }
         ...
         </pre>

    .. class:: small

         :r:`Counts stored into SEvt metadata`


.. raw:: html

    <pre class="mypretiny">cd ~/j/ntds ; NEVT=3 ./ntds.sh cfmeta 
    array([[[31967, 31903, 32017],  N=0   0:ProcessHits_count 
            [33305, 33464, 33416]], N=1    
            
           [[ 8732,  8693,  8745],        1:ProcessHits_true 
            [ 8696,  8772,  8717]],        
            
           [[23235, 23210, 23272],        2:ProcessHits_false 
            [24609, 24692, 24699]],        
            
           [[ 8732,  8693,  8745],        3:SaveNormHit_count 
            [ 8696,  8772,  8717]],        
          ...

           [[ 2155,  2149,  2086],        8:NEDEP 
            [ 3443,  3577,  3552]],        
            
           [[  134,   114,   130],        9:NBOUND 
            [  134,   131,   129]],        
           ...

           [[20946, 20947, 21056],       12:NDECULL 
            [21032, 20984, 21018]],        
           ...
            
           [[ 8732,  8693,  8745],       14:YSAVE 
            [ 8696,  8772,  8717]],        
            
           [[    2,     2,     2],       15:opticksMode 
            [    2,     2,     2]],        
            
           [[    0,     1,     2],       16:eventID 
            [    0,     1,     2]],        
            
           [[    0,     0,     0],       17:VERSION 
            [    1,     1,     1]]], dtype=uint64)        
     </pre>

    
.. s5_talk::

    N=1 geometry has more 0:ProcessHits_count but consistent 1:ProcessHits_true 



:small:`HAMA InputPhoton Chi2  (10 evt)` ``~/j/ntds/ntds.sh cfmeta``
-----------------------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">msab.c_itab
    array([[[15617, 15661, 15635, 15890, 15447, 15871, 15500, 15824, 15598, 15627],        0:ProcessHits_count  <span class="b">N=0 </span>
            [18490, 18210, 18490, 18174, 18467, 18069, 18608, 18198, 18291, 18284]],                            <span class="b">N=1 </span>
            
           [[ 3083,  3070,  3035,  2978,  3020,  2966,  2976,  2944,  3044,  3029],        1:ProcessHits_true 
            [ 3042,  3001,  2904,  2958,  2925,  2996,  3023,  3007,  3068,  2991]],        
            
           [[12534, 12591, 12600, 12912, 12427, 12905, 12524, 12880, 12554, 12598],        2:ProcessHits_false 
            [15448, 15209, 15586, 15216, 15542, 15073, 15585, 15191, 15223, 15293]],        
           ...

    msab.c_itab[msab.ik.YSAVE,0].sum()/msab.c_itab[msab.ik.YSAVE,1].sum()   <span class="b">  1.0077  # ratio of YSAVE counts N=0/N=1  </span>
    msab.c_ftab[0,1].sum()/msab.c_ftab[0,0].sum()                           <span class="b">  0.8472  # ratio of durations N=1/N=0  </span>
    np.diff(msab.c_ttab)[0,1].sum()/np.diff(msab.c_ttab)[0,0].sum()         <span class="b">  0.8582  # ratio of evt times N=1/N=0  </span>

    np.diff(msab.c_ttab)/1e6                                                <span class="b">  # seconds between event starts </span>
    array([[[2.589, 2.983, 3.004, 3.01 , 2.994, 2.665, 2.619, 2.641, 2.61 ],         
            [2.304, 2.526, 2.453, 2.443, 2.495, 2.144, 2.179, 2.478, 2.531]]])     <span class="r"> Little difference in durations, evt times</span>

    np.c_[msab.c_ttab[0].T].view('datetime64[us]') # SEvt start times (UTC)  <span style="font-size:25px">opticks/sysrap/stimer.h (std::chrono)</span> 
    array([['2023-04-15T17:35:25.726622', '2023-04-15T17:41:01.654181'],
           ['2023-04-15T17:35:28.315248', '2023-04-15T17:41:03.957860'],
           ...
           ['2023-04-15T17:35:50.840385', '2023-04-15T17:41:23.207810']], dtype='datetime64[us]')

    msab.c2tab  # c2sum, c2n, c2per for each event
    array([[28.08 , 21.765, 24.036, 14.987, 12.353, 29.081, 23.99 , 18.305, 17.485, 20.135],
           [25.   , 25.   , 26.   , 25.   , 25.   , 27.   , 25.   , 25.   , 27.   , 28.   ],
           <span class="r">[ 1.123,  0.871,  0.924,  0.599,  0.494,  1.077,  0.96 ,  0.732,  0.648,  0.719]])</span> <span class="b"> # c2per for 10 evts </span>

    msab.c2tab[0,:].sum()/msab.c2tab[1,:].sum()     <span class="r"> 0.8148 </span>            # c2per_tot
    </pre>


.. class:: small

   :r:`N=0,1 History Chi2 (target HAMA) : Consistent across 10 evt`   Overall Chi2 : 0.8148  


.. s5_talk::

    Comparing ProcessHits statistics across 10 events 



:i:`A_V0J008_N0_ip_MOI_NNVT:0:1000_10k.png`
--------------------------------------------

.. class:: small

   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   ``cd ~/j/ntds ; N=0 ./ntds.sh ana``  


.. raw:: html

    <p style="margin-bottom:150mm;" />

.. class:: small

   :r:`10k : Unnatural Pyrex+Pyrex+Vac+Vac NNVT PMT geometry, with` : ``export U4Recorder__FAKES_SKIP=1``
    

.. s5_talk::

   Similarly with NNVT



.. comment

    :i:`B_V1J008_N1_ip_MOI_NNVT:0:1000_100k.png`
    ------------------------------------------------


:i:`B_V1J008_N1_ip_MOI_NNVT:0:1000_10k.png`
------------------------------------------------

.. class:: small

   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   |emsp| |emsp| |emsp| |emsp| |emsp| 
   ``cd ~/j/ntds ; N=1 ./ntds.sh ana``  

.. raw:: html

    <p style="margin-bottom:150mm;" />

.. class:: small

   :b:`10k : Natural Pyrex+Vacuum NNVT PMT geometry, no fakes, no skipping needed`
 

.. s5_talk::

   Similarly with NNVT








:small:`100k Input Photons targetting NNVT:0:1000 Chi2 History Comparison`
---------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">cd ~/j/ntds ; ./ntds.sh cf 
    QCF qcf : c2sum/c2n:c2per(C2CUT) <span class="r">197.53/194:1.018</span> (30)
    np.c_[siq,_quo,siq,sabo2,sc2,sabo1][:25]  ## A-B history frequency chi2 comparison 
    [[' 0' 'TO BT BT BT BT SD                                          ' ' 0' ' 33025  33400' ' 2.1170' '     0      3']
     [' 1' 'TO BT BT BT BT SA                                          ' ' 1' ' 28317  27980' ' 2.0173' '     3      4']
     [' 2' 'TO BT BT BT BT BT SR SA                                    ' ' 2' '  6205   6328' ' 1.2071' ' 10427  10543']
     [' 3' 'TO BT BT BT BT BT SA                                       ' ' 3' '  4684   4693' ' 0.0086' '  8523   8481']
     [' 4' 'TO BT BT BT BT BT SR BR SR SA                              ' ' 4' '  1188   1174' ' 0.0830' ' 21107  21015']
     [' 5' 'TO BT BT BT BT BR BT BT BT BT BT BT AB                     ' ' 5' '  1008    961' ' 1.1219' '  7713   9959']
     [' 6' 'TO BT BT BT BT BT SR BR SA                                 ' ' 6' '   960    944' ' 0.1345' ' 20304  20311']
     [' 7' 'TO BT BT BT BT BT SR SR SA                                 ' ' 7' '   951    900' ' 1.4052' ' 10387  10424']
     [' 8' 'TO BT BT AB                                                ' ' 8' '   904    828' ' 3.3349' '    14    126']
     [' 9' 'TO BT BT BT BT BT SR BT BT BT BT BT BT BT AB               ' ' 9' '   629    587' ' 1.4507' ' 20503  20814']
     ['10' 'TO BT BT BT BT BR BT BT BT BT AB                           ' '10' '   590    585' ' 0.0213' '    86   8872']
     ['11' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT SD               ' '11' '   445    462' ' 0.3186' '  9137   9101']
     ['12' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT BT BT BT BT SD   ' '12' '   445    435' ' 0.1136' ' 11465   7184']
     ['13' 'TO BT BT BT BT BR BT BT BT BT BT SA                        ' '13' '   445    437' ' 0.0726' '   666    675']
     ['14' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT SA               ' '14' '   423    426' ' 0.0106' '  9090   9118']
     ['15' 'TO BT BT BT BT BR BT BT BT BT BT BT BT BT BT BT BT BT SA   ' '15' '   387    414' ' 0.9101' ' 11478   7091']
     ['16' 'TO BT BT BT BT BR BT BT BT BT BT BT SC BT BT BT BT BT BT SD' '16' '   381    404' ' 0.6739' ' 16538  16757']
     ['17' 'TO BT BT BT BT BT SR BR SR SR SA                           ' '17' '   335    383' ' 3.2089' ' 22766  20996']
     ['18' 'TO BT BT BT BT BR BT BT BT BT BT BT SC BT BT BT BT BT BT SA' '18' '   356    327' ' 1.2313' ' 16336  16142']
     ['19' 'TO BT BT BT BT BT SR SR SR SA                              ' '19' '   354    348' ' 0.0513' ' 10746  10369']
    </pre>
 

.. class:: small

    https://github.com/simoncblyth/j/blob/main/ntds/ntds.sh 
    
    Chi2 comparison of photon histories for:

    A. Unnatural geometry with fakes skipped
    B. Natural geometry  


.. s5_talk::

   Chi2 also consistent with NNVT




:small:`NNVT InputPhoton Chi2  (10 evt)` ``~/j/ntds/ntds.sh cfmeta``
-----------------------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">msab.c_itab
    array([[[22063, 22278, 21789, 21762, 21833, 22246, 21838, 21914, 22052, 21912],        0:ProcessHits_count 
            [25986, 25956, 25693, 25834, 26009, 25528, 25944, 25642, 25787, 25522]],        
            
           [[ 3512,  3517,  3541,  3496,  3576,  3434,  3607,  3484,  3542,  3552],        1:ProcessHits_true 
            [ 3541,  3529,  3510,  3535,  3491,  3534,  3601,  3506,  3562,  3529]],        
            
           [[18551, 18761, 18248, 18266, 18257, 18812, 18231, 18430, 18510, 18360],        2:ProcessHits_false 
            [22445, 22427, 22183, 22299, 22518, 21994, 22343, 22136, 22225, 21993]],        
    ...

    msab.c_itab[msab.ik.YSAVE,0].sum()/msab.c_itab[msab.ik.YSAVE,1].sum()     0.9978       # N=0/N=1
    msab.c_ftab[0,1].sum()/msab.c_ftab[0,0].sum()                             0.8766       # ratio of durations N=1/N=0 
    np.diff(msab.c_ttab)[0,1].sum()/np.diff(msab.c_ttab)[0,0].sum()           0.9107       # ratio of evt times N=1/N=0 

    np.diff(msab.c_ttab)/1e6   # seconds between event starts
    array([[[3.086, 3.643, 3.474, 3.063, 3.012, 3.149, 3.164, 3.192, 3.177],
            [2.942, 2.859, 2.8  , 2.798, 2.788, 2.827, 2.795, 2.8  , 3.767]]])

    np.c_[msab.c_ttab[0].T].view('datetime64[us]') # SEvt start times (UTC)

    array([['2023-04-15T19:18:04.210151', '2023-04-15T19:22:38.213798'],
           ['2023-04-15T19:18:07.296470', '2023-04-15T19:22:41.155448'],
           ...
          ['2023-04-15T19:18:33.170123', '2023-04-15T19:23:04.588021']], dtype='datetime64[us]')

    msab.c2tab  # c2sum, c2n, c2per for each event
    array([[21.007, 30.807, 31.403, 33.485, 14.285, 42.094, 40.497, 21.573, 31.372, 22.241],
           [31.   , 33.   , 33.   , 32.   , 32.   , 31.   , 30.   , 31.   , 34.   , 31.   ],
           [ 0.678,  0.934,  0.952,  1.046,  0.446,  1.358,  1.35 ,  0.696,  0.923,  0.717]])    # >> 1. would indicate bug 

    msab.c2tab[0,:].sum()/msab.c2tab[1,:].sum()                              0.9081         # c2per_tot 
    </pre>

.. class:: small

    :r:`N=0,1 History Chi2 (target NNVT) : Consistent across 10 evt : Overall Chi2 0.9081`


.. s5_talk::

    Checking with 10 evts : no surprises  



:small:`Gun Running N=0,1 Chi2 comparison across 10 evts (opticksMode:2)`
---------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">cd ~/j/ntds ; ./ntds.sh cfmeta 
    c_itab
    array([[[11274, 11012, 10851, 11422, 11372, 11151, 11535, 11250, 11123, 11001],  N=0  ProcessHits_count 
            [13990, 13709, 13649, 13709, 14365, 14609, 13600, 13869, 14686, 14014]], N=1    
            
           [[ 1820,  1724,  1696,  1740,  1806,  1721,  1748,  1745,  1763,  1713],       ProcessHits_true 
            [ 1722,  1654,  1702,  1757,  1791,  1761,  1690,  1769,  1763,  1820]],        
           ...
           [[ 9214,  9051,  8905,  9427,  9326,  9206,  9531,  9242,  9131,  9055],       NEDEP 
            [11990, 11762, 11674, 11658, 12290, 12558, 11621, 11829, 12641, 11923]],        
            
           [[    2,     1,     1,     0,     1,     2,     3,     1,     1,     0],       NBOUND 
            [   21,    31,    29,    28,    33,    36,    26,    34,    32,    32]], ## <span class="r"> More sensitive Pyrex with N=1 </span>       
           ... 
           [[ 1820,  1724,  1696,  1740,  1806,  1721,  1748,  1745,  1763,  1713],       YSAVE 
            [ 1722,  1654,  1702,  1757,  1791,  1761,  1690,  1769,  1763,  1820]],        

    np.diff(c_ttab)/1e6   # seconds between event starts 
    [[[2.76  2.586 3.106 3.033 3.231 2.62  2.772 2.69  3.112]  ## <span class="r"> Little difference, timings dominated by recording overheads however </span>
      [3.026 2.71  2.858 2.842 3.094 2.874 2.836 2.841 2.708]]]

    np.c_[c_ttab[0,0].view('datetime64[us]'),c_ttab[0,1].view('datetime64[us]')] # event start times (UTC)  
    [['2023-04-14T13:16:14.802047' '2023-04-14T13:24:48.696600']
     ['2023-04-14T13:16:17.561901' '2023-04-14T13:24:51.722786']    
     ...

    c2tab  # c2sum, c2n, c2per for each event : Chi2 comparing simulation histories 
    array([[67.968, 54.336, 57.879, 50.578, 68.72 , 64.923, 60.431, 79.85 , 68.574, 60.395],
           [63.   , 62.   , 63.   , 69.   , 60.   , 63.   , 62.   , 66.   , 64.   , 64.   ],
           [ 1.079,  0.876,  0.919,  0.733,  1.145,  1.031,  0.975,  1.21 ,  1.071,  0.944]]) ## <span class="r"> Consistent histories between N=0, N=1 </span>

    c2per_tot:  0.9963   ## <span class="r"> Combined Chi2 over all 10 events : close to 1. </span>
    </pre>

.. class:: small

    * :r:`Default Gun Check : again no surprises`  
    * :b:`N=1 Larger "NBOUND" due to more sensitive Pyrex => more BULK_ABSORB not-at-boundary`  


.. s5_talk::

    Default Gun Check with 10 evts : again no surprises :  




:i:`B_V1J008_N1_OIPF_NNVT:0:1000_gridxy.png`
----------------------------------------------


::

     export OPTICKS_INPUT_PHOTON=GridXY_X1000_Z1000_40k_f8.npy
     export OPTICKS_INPUT_PHOTON_FRAME=NNVT:0:1000

     MODE=3 EDL=1 N=0 EYE=500,0,2300 CHECK=not_first ~/j/ntds/ntds.sh ana


.. raw:: html

    <p style="margin-bottom:110mm;" />
    

::

    Photon step points from grid of input photons target NNVT:0:1000 (POM:1)


.. s5_talk::

    Can distinguish NNVT from HAMA by the size of ring inside 



:i:`B_V1J008_N1_OIPF_NNVT:0:1000_POM0.png`
-------------------------------------------

::

    POM=0 ntds2_cf ## Check No PMT Optical model  


.. raw:: html

    <p style="margin-bottom:130mm;" />
    

::

    Photon step points from grid of input photons target NNVT:0:1000 (POM:0) 


.. s5_talk::

    Photons do not enter PMT 




:small:`Check With PMT Optical Model disabled : N=0,1 => Consistent Simulations`
-----------------------------------------------------------------------------------

.. raw:: html

    <pre class="mypretiny">EVT=001 ~/j/ntds/ntds.sh cf    ## Chi2 history check for 1 evt  
    c2sum/c2n:c2per(C2CUT)  64.20/69:0.930 (30)

    np.c_[siq,_quo,siq,sabo2,sc2,sabo1][:25]  ## A-B history frequency chi2 comparison 
    [[' 0' 'TO BT BT BT BT SD                    ' ' 0' ' 27052  27168' ' 0.2482' '     0      0']
     [' 1' 'TO SA                                ' ' 1' '  3099   3078' ' 0.0714' '    78     77']
     [' 2' 'TO AB                                ' ' 2' '   948    908' ' 0.8621' '    33      2']
     [' 3' 'TO DR BT SA                          ' ' 3' '   872    929' ' 1.8040' '   132    138']
     [' 4' 'TO BT SD                             ' ' 4' '   889    881' ' 0.0362' '  8241   8241']
     [' 5' 'TO BT BT AB                          ' ' 5' '   343    314' ' 1.2801' '    74    223']
     [' 6' 'TO BT BT SA                          ' ' 6' '   278    274' ' 0.0290' '   479   1032']
     [' 7' 'TO DR BT DR BT SA                    ' ' 7' '   239    226' ' 0.3634' '   154    134']
     [' 8' 'TO BT BT BR BT BT SA                 ' ' 8' '   200    229' ' 1.9604' '   128    176']
     [' 9' 'TO BT SA                             ' ' 9' '   181    177' ' 0.0447' '  8439   8240']
     ['10' 'TO DR BT BT BT BT SD                 ' '10' '   162    176' ' 0.5799' '   162    537']

    NEVT=3 ~/j/ntds/ntds.sh cfmeta   ## Compare counts, chi2 for 3 events    
                                                                                                                          
    array([[[31967, 31903, 32017],  N=0   0:ProcessHits_count        array([[[6.679, 6.614, 6.632],        0:SEvt__TimerDone  
            [33305, 33464, 33416]], N=1                                      [6.192, 6.146, 6.107]]])                         
                                                                                                                              
           [[ 8732,  8693,  8745],        1:ProcessHits_true         msab.c2tab  # c2sum, c2n, c2per for each event           
            [ 8696,  8772,  8717]],                                                                                           
                                                                     array([[42.234, 64.198, 51.987],                         
           [[ 2155,  2149,  2086],        8:NEDEP                           [66.   , 69.   , 67.   ],                         
            [ 3443,  3577,  3552]],                                         [ 0.64 ,  0.93 ,  0.776]])                        
                                                             
           [[  134,   114,   130],        9:NBOUND           
            [  134,   131,   129]],                          
    </pre>

.. class:: small

    * POM:0 simpler histories as photons do not enter PMT 
    * More ProcessHits_false for N=1 (from more Sensitive volume)
    * Consistent ProcessHits_true  
    * N=0,1 simulation history Chi2 matching 



.. s5_talk::

    Traditional POM=0 check 


Issue 88, Branch, Merge Request
--------------------------------

.. class:: small


    `junosw/-/issues/88 <https://code.ihep.ac.cn/JUNO/offline/junosw/-/issues/88>`_

        Geant4 FastSim based junoPMTOpticalModel implementation has incorrect polarization and propagation time within PMT and also overcomplex 4 volume PMT geometry 


    `junosw/-/tree/blyth-88-pivot-PMT-optical-model-from-FastSim-to-CustomG4OpBoundaryProcess <https://code.ihep.ac.cn/JUNO/offline/junosw/-/tree/blyth-88-pivot-PMT-optical-model-from-FastSim-to-CustomG4OpBoundaryProcess>`_

        Pivot Branch 


    `junosw/-/merge_requests/180 <https://code.ihep.ac.cn/JUNO/offline/junosw/-/merge_requests/180>`_ 

        Merge Request



.. s5_talk::

    Links


   

Suggested Further Sanity Checks from MR Reviewer
---------------------------------------------------


.. class:: small

    My checks are mostly between the N=0,N=1 implementations in the branch.

    Some sanity checks (eg hit counts, time distribution of hits) between:

    1. current main with the bugs 
    2. branch N=0 
    3. branch N=1 

    Good to check both with and without the PMT Optical Model


.. class:: small

    Aim is to confirm that any differences are small. 

    Small effect expected as:

    * proportion of photons effected is small 
    * QE for "backwards" photons gets set to zero 

      * so need multi-PMT photon history for the bug to change hits  


    Although expect small effect on hits, needs to be fixed
    for Opticks full photon validation to match.   

   

.. s5_talk::

    Suggestions





