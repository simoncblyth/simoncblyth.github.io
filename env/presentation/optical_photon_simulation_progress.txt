

.. comment 

.. raw:: html

    <style type="text/css">
        span.alarm { color: red; } 
        span.warn { color: orange; } 
        span.ok { color: green; } 
        span.i { display: none; } 
        pre.sliteral { class:"literal-block small"; }   
        pre.mypre {
             display: block;
             font-family: monospace;
             font-size: 20px;
             white-space: pre;
             margin: 1em 0;
        }

    </style>

.. role:: i 
.. role:: alarm
.. role:: warn
.. role:: ok
.. role:: sliteral
.. role:: mypre 


.. include:: <s5defs.txt>

.. s5_background_image::

    #
    # slide titles and background image urls, 
    # including server relative urls like /env/geant4/geometry/collada/daeview/20140419-170713.png
    # and protocol relative urls like //localhost/env/test/LANS_AD3_CoverGas_Humidity.png
    #
    # NB1 slide titles here must match those in body precisely, 
    # NB2 also ensure all slide titles are unique
    #
    # first slide id is exceptionally: slide0, not the mangled title
    slide0
    /env/geant4/geometry/collada/g4daeview/20140419-170713.png auto_auto 0px_0px

    g4daeview.py : Fast OpenGL 3D viewer for G4DAE files
    /env/geant4/geometry/collada/g4daeview/20140419-170713.png

    Cerenkov Photons Simulation - Top View
    /env/geant4/geometry/collada/g4daeview/20141224-115923.png

    Cerenkov Photons Simulation - Side View
    /env/geant4/geometry/collada/g4daeview/20141224-115935.png

    Scintillation Photons Simulation - Top View
    /env/geant4/geometry/collada/g4daeview/20141224-121444.png

    Scintillation Photons Simulation - Side View
    /env/geant4/geometry/collada/g4daeview/20141224-121435.png

    Standard Geant4 Workflow
    /env/keynotefigs/G4DAEChroma/G4DAEChroma.001.png

    External Photon Simulation Workflow
    /env/keynotefigs/G4DAEChroma/G4DAEChroma.002.png

    GGeoView
    /env/graphics/ggeoview/ggeoview-cerenkov-001.png 1047px_795px

    GGeoView M1 Points
    /env/graphics/ggeoview/ggeoview-scintillation-points-mat1.png 1435px_848px

    GGeoView Flag Selection 
    /env/graphics/ggeoview/ggeoview-scintillation-flag-seq-select.png 1436px_842px

    GGeoView Cerenkov Geom M1
    /env/graphics/ggeoview/ggeoview-cerenkov-m1-geom.png 1416px_845px
    


.. comment 

    GGeoView image is 2094x1590 1047x795

    GGeoView M1 Points is 2870x1696  1435x848

    GGeoView Flag Selection 2872x1684 1436x842

    GGeoView Cerenkov Geom M1 2832x1690 1416x845


    Generated Scintillation Photons GPU cf Geant4
    /env/g4dae/generated_scintillation_time_wavelength.png

    G4/DetSim Generated Cerenkov Wavelength
    /env/g4dae/g4_cerenkov_wavelength.png







.. comment

   Last 6 weeks

   implemented optical physics in OptiX infrastructure
   squeeze photon record into 128 bit 
   record viz
   photon history/material indexing



======================================================================
Optical Photon Simulation Progress
======================================================================

.. class:: small

    http://simoncblyth.bitbucket.org/env/presentation/optical_photon_simulation_progress.html (October 2015)
    http://simoncblyth.bitbucket.org/env/presentation/optical_photon_simulation_with_nvidia_optix.html (July 2015)
    http://simoncblyth.bitbucket.org/env/presentation/gpu_accelerated_geant4_simulation.html (Jan 2015)

.. class:: small

   **Executive Summary**

   * several large geometry issues solved
   * extreme speed objective looks inevitable
   * matching Geant4 : :blue:`still unclear how long to achieve`   

   **Contents**

   * Handling JUNO geometry 
   * 800x less memory with instancing
   * Analytic PMT geometry : avoiding *disco ball* 
   * IAV, OAV mesh fixing with OpenMesh surgery
   * Photon Torpedo testing 
   * Optical Photons GPU resident
   * Progress Overview

   |  Simon C Blyth, National Taiwan University
   |  **October 2015** 



:small:`Handling JUNO Geometry`
------------------------------------------------------- 

.. class:: small
 
   Implemented OpenGL and OptiX instancing, to allow loading the full JUNO geometry. 

.. image:: /env/graphics/ggeoview/ggeoview-cerenkov-jpmt.png
   :width: 900px
   :align: center

.. class:: tiny

   .. [#hw] MacBook Pro (2013), NVIDIA GeForce GT 750M 2048 MB (384 cores); 
            Workstation GPU performance expected to scale by core count 


:small:`800x less memory due to instancing`
------------------------------------------------------- 

.. class:: small
 
   ~90M triangles, vertex data alone too big for GPU memory,
   mandatory instancing reduces to 0.1M

   *GTreeCheck* algorithm finds repeated geometry, splitting into:

   * one non-instanced mesh
   * 4 instanced meshes corresponding 
     to 20-inch and 3-inch PMTs and support geometry.


   Vertex, face, solid (*transforms*) and instance counts (*itransforms*):

.. raw:: html

    <pre class="mypre">
 
     mm  0 : vertices   47864 faces   95436 transforms  289733 itransforms       0 
     mm  1 : vertices     277 faces     540 transforms       4 itransforms   36572 
     mm  2 : vertices    1759 faces    3502 transforms       4 itransforms   19452 
     mm  3 : vertices     914 faces    1856 transforms       1 itransforms     480 
     mm  4 : vertices    4168 faces    6252 transforms     521 itransforms     124 

       totVertices     54982  totFaces    107586 

      vtotVertices  45349928 vtotFaces  89631348 (virtual: scaling by transforms)

      vfacVertices   824.814 vfacFaces   833.113 (virtual to total ratio)
  
    </pre>


:small:`Analytic PMT geometry`
---------------------------------------

.. class:: small
 
   * triangulated PMT *disco ball* too unrealistic
   * parse detdesc XML to give CSG tree of primitives (boolean intersections, unions)
   * partition 5 CSG solids of PMT into 14 **single primitive** parts 
     at the geometrical intersections
     (avoids implementing general CSG boolean handling on GPU)   

.. image:: /env/nuwa/detdesc/pmt/hemi-pmt-solids.png
   :width: 900px
   :align: center


:small:`Analytic PMT in 14 parts instead of 2928 triangles`
-------------------------------------------------------------

.. class:: small

   Implemented OptiX PMT intersection based on sphere/cylinder part
   intersection: solve quadratic, handle cases  

.. image:: /env/nuwa/detdesc/pmt/hemi-pmt-parts.png
   :width: 900px
   :align: center

.. class:: tiny

   Sphere intersection only 2 cases, Cylinder 10 cases (axial, walls, endcap, outside/inside) 


:small:`OptiX Ray Traced Analytic PMT geometry`
------------------------------------------------

.. class:: small

   Analytic geometry: more realistic, faster, less memory, BUT a lot more effort than triangulated.   

.. image:: /env/nuwa/detdesc/pmt/hemi-pmt-analytic-near-clipped.png
   :width: 900px
   :align: center

.. class:: tiny 

   Near clipped, orthographic projection.


:small:`Analytic PMTs together with triangulated geometry`
----------------------------------------------------------------

.. class:: small

   PMTs analytic, the rest triangulated 

.. image:: /env/nuwa/detdesc/pmt/analytic-pmt-optix-geometry.png
   :width: 900px
   :align: center


:small:`IAV, OAV mesh fixing with OpenMesh surgery`
-----------------------------------------------------

.. class:: small

    Photon material provided by intersection boundary, all top lid photons Acrylic(yellow), not GdLS(red)
    
    Issue: some CSG unions split into multiple meshes with close parallel faces

    * ~25 out of 250 meshes have issues eg Eulers Characteristic ``V - E + F != 2`` 
    * fixed two critical ones: IAV, OAV. 
    * close parallel faces causes flickering OpenGL render

.. image:: /env/graphics/ggeoview/mesh-fix-iav-oav.png
   :width: 900px
   :align: center


:small:`OpenMeshRap package`
------------------------------------------------

.. sidebar:: Exploded Z across the mend

    .. image:: /env/graphics/ggeoview/openmeshrap-fix.png
       :width: 500px
       :align: center

.. class:: small

   Created package *OpenMeshRap* to develop fix

   * based on open source project: **OpenMesh** 

   * extracts real topological meshes
   * finds close parallel faces between the meshes
   * deletes the extra faces
   * stitches the split mesh together with added triangles


:small:`Photon Torpedo 0`
------------------------------------------------
.. raw:: html

    <pre class="mypre">
    ggv.sh --analyticmesh 1 \
          --torchconfig "frame=3199;radius=150;zenith_azimuth=1,0,1,0;source=0,0,1000;target=0,0,0" 
    </pre>

.. image:: /env/graphics/ggeoview/photon-torpedo-3199-0.png
   :width: 900px
   :align: center



:small:`Photon Torpedo 1`
------------------------------------------------

.. class:: small

   Full geometry too complicated. Working on dynamic test box for checking PMTs and optical physics simulation.

.. image:: /env/graphics/ggeoview/photon-torpedo-3199-1.png
   :width: 900px
   :align: center


:small:`Photon Torpedo 2`
------------------------------------------------

.. class:: small

   Select photons according to their history, here just detected ones.

.. image:: /env/graphics/ggeoview/photon-torpedo-3199-2.png
   :width: 900px
   :align: center


:small:`Photon Torpedo Splashback`
------------------------------------------------

.. class:: small

   Here with no geometry represented, just 0.5M *torch* photons 

.. image:: /env/graphics/ggeoview/photon-torpedo-3199-splashback.png
   :width: 900px
   :align: center



:small:`Optical Photons now fully GPU resident`
--------------------------------------------------

.. class:: small

     All photon operations now done on GPU:

     * seeded (assigned gensteps)
     * generated 
     * propagated
     * indexing material/interaction histories 
     
     Only PMT hits are copied back to CPU


.. class:: tiny

     Thrust/CUDA/OptiX interop used to implement
     

:small:`Progress Overview`
-----------------------------

.. class:: small

   **Resolved several large obvious geometry problems**

   * squeezing JUNO geometry onto GPU with instancing
   * fixing bad triangulations using OpenMesh surgery   
   * replace triangulated PMTs with more realistic analytic ones

   **Optical physics problems expected next**

   * need Geant4 comparison to find the next issue 
   * will start validations using simple test geometries

   **Refactoring Material/Surface/Boundary code**

   * enable dynamic simple test geometries, 

     * spheres of each material, surface
     * PMT test black boxes 



