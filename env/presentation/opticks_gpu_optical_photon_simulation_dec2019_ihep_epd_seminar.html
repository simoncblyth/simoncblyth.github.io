<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Opticks : GPU Optical Photon Simulation for Particle Physics with NVIDIA OptiX</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="visible" />
<!-- style sheet links -->
<script src="ui/my-small-white/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/my-small-white/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/my-small-white/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/my-small-white/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/my-small-white/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1><span class="i">Opticks : GPU Optical Photon Simulation for Particle Physics with NVIDIA OptiX</span></h1>

</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title"><span class="i">Opticks : GPU Optical Photon Simulation for Particle Physics with NVIDIA OptiX</span></h1>

<!-- comment

opticks_gpu_optical_photon_simulation_dec2019_ihep_epd_seminar.txt -->
<!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->
<style type="text/css">

    .strike { text-decoration: line-through; }
    .center {text-align: center;}

    span.alarm { color: red; }
    span.warn { color: orange; }
    span.ok { color: green; }
    span.i { display: none; }
    pre.sliteral { class:"literal-block small"; }
    pre.mypre {
         display: block;
         font-family: monospace;
         font-size: 20px;
         white-space: pre;
         margin: 1em 0;
    }

    pre.mypretiny {
         display: block;
         font-family: monospace;
         font-size: 15px;
         white-space: pre;
         margin: 1em 0;
    }

    pre.myfoot {
         display: block;
         font-family: monospace;
         font-size: 18px;
         white-space: pre;
         color: white;
         position: absolute; top:86%; left:4%; width:50%; height:10% ;
    }

    a.mylink {
         display: block;
         font-family: monospace;
         font-size: 18px;
         white-space: pre;
         color: black;
         position: absolute; top:86%; left:4%; width:50%; height:10% ;
    }


    div.mytitle {
         font-size: 20px;
         color: black;
         position: absolute; top:0%; left:5%; width:90%; height:10% ;
    }

    div.mytitle2 {
         font-size: 20px;
         color: black;
         position: absolute; top:5%; left:5%; width:90%; height:10% ;
    }



    div.mycredit {
         font-size: 20px;
         color: black;
         position: absolute; top:90%; left:5%; width:80%; height:10% ;
    }

    div.mysidebar {
        margin: 0 0 0.5em 1em;
        border: medium outset;
        padding: 1em;
        background-color: #ffffee;
        width: 20%;
        float: right;
        clear: right;
    }

    table.mytable th {
         background-color: #ede;
    }
    table.mytable tr:nth-child(even) {
        background-color: #F3F3FF;
    }
    table.mytable tr:nth-child(odd) {
        background-color: #FFFFEE;
    }


</style>
       <style type="text/css">

          div.slide { 
             background-clip: border-box;
             background-repeat: no-repeat;
             height: 100%;
          }
          div.slide#slide0{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-wide_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-benefits{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-wide_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#visualizing-an-optical-photon-simulation{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-wide_crop.png);
             background-size: 640px 360px;
             background-position: 600px 100px;
             
          }
          div.slide#overview{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-wide_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#cerenkov-photons-simulation-top-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-115923.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#cerenkov-photons-simulation-side-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-115935.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#scintillation-photons-simulation-top-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-121444.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#scintillation-photons-simulation-side-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-121435.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#standard-geant4-workflow{
             background-image: url(/env/keynotefigs/G4DAEChroma/G4DAEChroma.001.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#external-photon-simulation-workflow{
             background-image: url(/env/keynotefigs/G4DAEChroma/G4DAEChroma.002.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#geant4opticksworkflow{
             background-image: url(/env/Documents/Geant4OpticksWorkflow/Geant4OpticksWorkflow.001.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#ggeoview{
             background-image: url(/env/graphics/ggeoview/ggeoview-cerenkov-001.png);
             background-size: 1047px 795px;
             background-position: 0px 0px;
             
          }
          div.slide#ggeoview-m1-points{
             background-image: url(/env/graphics/ggeoview/ggeoview-scintillation-points-mat1.png);
             background-size: 1435px 848px;
             background-position: 0px 0px;
             
          }
          div.slide#ggeoview-flag-selection{
             background-image: url(/env/graphics/ggeoview/ggeoview-scintillation-flag-seq-select.png);
             background-size: 1436px 842px;
             background-position: 0px 0px;
             
          }
          div.slide#ggeoview-cerenkov-geom-m1{
             background-image: url(/env/graphics/ggeoview/ggeoview-cerenkov-m1-geom.png);
             background-size: 1416px 845px;
             background-position: 0px 0px;
             
          }
          div.slide#detecting-neutrinos-via-optical-photons-1{
             background-image: url(/env/presentation/dayabay-principal_half.png);
             background-size: 1417px 830px;
             background-position: 0px 0px;
             
          }
          div.slide#detecting-neutrinos-via-optical-photons-2{
             background-image: url(/env/presentation/dayabay-principal_half.png);
             background-size: 1417px 830px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-inside-wide{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-wide_half.png);
             background-size: 1432px 844px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-wide{
             background-image: url(/env/graphics/ggeoview/jpmt-wide_half.png);
             background-size: 1409px 836px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-headview{
             background-image: url(/env/graphics/ggeoview/jpmt-headview_half.png);
             background-size: 1308px 783px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-backview{
             background-image: url(/env/graphics/ggeoview/jpmt-backview_half.png);
             background-size: 1149px 794px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-approach{
             background-image: url(/env/graphics/ggeoview/jpmt-approach_half.png);
             background-size: 1431px 839px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-arrival{
             background-image: url(/env/graphics/ggeoview/jpmt-arrival_half.png);
             background-size: 1427px 841px;
             background-position: 0px 0px;
             
          }
          div.slide#optical-photon-simulation-problem{
             background-image: url(/env/graphics/ggeoview/jpmt-before-contact_half.png);
             background-size: 1430px 844px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-before-contact{
             background-image: url(/env/graphics/ggeoview/jpmt-before-contact_half.png);
             background-size: 1430px 844px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-before-contact-2{
             background-image: url(/env/graphics/ggeoview/jpmt-before-contact_half.png);
             background-size: 1430px 844px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-before-contact-3{
             background-image: url(/env/graphics/ggeoview/jpmt-before-contact_half.png);
             background-size: 1430px 844px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-after-contact{
             background-image: url(/env/graphics/ggeoview/jpmt-after-contact_half.png);
             background-size: 1425px 840px;
             background-position: 0px 0px;
             
          }
          div.slide#jpmt-inside-outside{
             background-image: url(/env/graphics/ggeoview/jpmt-inside-outside_half.png);
             background-size: 1401px 842px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-optix-in-action{
             background-image: url(/env/presentation/optix-in-action_half.png);
             background-size: 966px 646px;
             background-position: 100px 50px;
             
          }
          div.slide#pmtinbox-approach-1{
             background-image: url(/env/graphics/ggeoview/PmtInBox-approach.png);
             background-size: 1069px 769px;
             background-position: 0px 0px;
             
          }
          div.slide#pmtinbox-approach-2{
             background-image: url(/env/graphics/ggeoview/PmtInBox-approach.png);
             background-size: 1069px 769px;
             background-position: 0px 0px;
             
          }
          div.slide#pmtinbox-after-1{
             background-image: url(/env/graphics/ggeoview/PmtInBox-after.png);
             background-size: 1057px 760px;
             background-position: 0px 0px;
             
          }
          div.slide#pmtinbox-after-2{
             background-image: url(/env/graphics/ggeoview/PmtInBox-after.png);
             background-size: 1057px 760px;
             background-position: 0px 0px;
             
          }
          div.slide#daya-bay-pmt-wall-photo-1{
             background-image: url(/env/presentation/gtc2016/dyb-pmt-wall-photo.png);
             background-size: 1329px 798px;
             background-position: 0px 0px;
             
          }
          div.slide#daya-bay-pmt-wall-photo-2{
             background-image: url(/env/presentation/gtc2016/dyb-pmt-wall-photo.png);
             background-size: 1329px 798px;
             background-position: 0px 0px;
             
          }
          div.slide#super-kamiokande-pmts-not-16-9{
             background-image: url(/env/presentation/gtc2016/sk-PH20-water-withboat-apr23-wm.png);
             background-size: 1181px 771px;
             background-position: 0px 0px;
             
          }
          div.slide#super-kamiokande-pmts-1{
             background-image: url(/env/presentation/PH20-water-withboat-apr23-wm_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#super-kamiokande-pmts-2{
             background-image: url(/env/presentation/PH20-water-withboat-apr23-wm_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#super-kamiokande-pmts-3{
             background-image: url(/env/presentation/PH20-water-withboat-apr23-wm_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#super-kamiokande-pmts-4{
             background-image: url(/env/presentation/PH20-water-withboat-apr23-wm_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#kamiokande-ii-1{
             background-image: url(/env/presentation/1987a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#kamiokande-ii-2{
             background-image: url(/env/presentation/1987a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#kamiokande-ii-3{
             background-image: url(/env/presentation/1987a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#fast-optical-photon-simulation{
             background-image: url(/env/presentation/newtons-opticks.png);
             background-size: 374px 684px;
             background-position: 800px 0px;
             
          }
          div.slide#photomultiplier-tubes-pmts{
             background-image: url(/env/presentation/hamamatsu-pmt-16x9.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#photomultiplier-tube-operation{
             background-image: url(/env/presentation/hamamatsu-pmt-16x9.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#old-hamamatsu-photomultiplier-tubes-pmts{
             background-image: url(/env/presentation/hamamatsu-pmt.png);
             background-size: 1099px 734px;
             background-position: 0px 0px;
             
          }
          div.slide#old-photomultiplier-tube-operation{
             background-image: url(/env/presentation/hamamatsu-pmt.png);
             background-size: 1099px 734px;
             background-position: 0px 0px;
             
          }
          div.slide#jiangmen-underground-neutrino-observatory-juno{
             background-image: url(/env/presentation/juno-schematic-5.png);
             background-size: 1391px 734px;
             background-position: 0px 0px;
             
          }
          div.slide#jiangmen-underground-neutrino-observatory-goals{
             background-image: url(/env/presentation/juno-schematic-5.png);
             background-size: 1391px 734px;
             background-position: 0px 0px;
             
          }
          div.slide#dayabay-reactor-neutrino-expt-far-site{
             background-image: url(/env/presentation/DybFar_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#daya-bay-far-site-2{
             background-image: url(/env/presentation/DybFar_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#daya-bay-far-site-3{
             background-image: url(/env/presentation/DybFar_crop.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#geant4-monte-carlo-simulation-toolkit{
             background-image: url(/env/presentation/g4-hep.png);
             background-size: 1025px 621px;
             background-position: 100px 100px;
             
          }
          div.slide#geant4-monte-carlo-simulation-toolkit-generality{
             background-image: url(/env/presentation/g4-hep.png);
             background-size: 1025px 621px;
             background-position: 100px 100px;
             
          }
          div.slide#seeing-neutrinos-via-scintillation-cherenkov-light{
             background-image: url(/env/presentation/cherenkov.png);
             background-size: 316px 203px;
             background-position: 850px 400px;
             
          }
          div.slide#opticks-auto-instancing{
             background-image: url(/env/graphics/ggeoview/ggv-juno-instancing.png);
             background-size: 852px 592px;
             background-position: 450px 80px;
             
          }
          div.slide#nvidia-optix-1{
             background-image: url(/env/presentation/NVIDIAOptiXWebsite_Oct2016.png);
             background-size: 1280px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-optix-2{
             background-image: url(/env/presentation/NVIDIAOptiXWebsite_Oct2016.png);
             background-size: 1280px;
             background-position: 0px 0px;
             
          }
          div.slide#opticksdocs{
             background-image: url(/env/presentation/OpticksDocs.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#daya-bay-antineutrino-detection-via-inverse-beta-decay-1{
             background-image: url(/env/presentation/AntineutrinoDetectionViaIBDJetterSept2014.png);
             background-size: 809px 576px;
             background-position: 100px 100px;
             
          }
          div.slide#daya-bay-antineutrino-detection-via-inverse-beta-decay-2{
             background-image: url(/env/presentation/AntineutrinoDetectionViaIBDJetterSept2014.png);
             background-size: 809px 576px;
             background-position: 100px 100px;
             
          }
          div.slide#daya-bay-energy-response-model-1{
             background-image: url(/env/presentation/ZheTaupDetectorResponseModel.png);
             background-size: 968px 576px;
             background-position: 100px 100px;
             
          }
          div.slide#daya-bay-energy-response-model-2{
             background-image: url(/env/presentation/ZheTaupDetectorResponseModel.png);
             background-size: 968px 576px;
             background-position: 100px 100px;
             
          }
          div.slide#daya-bay-energy-response-model-fit-to-calibration-data-1{
             background-image: url(/env/presentation/EnergyResponseModel.png);
             background-size: 693px 504px;
             background-position: 0px 100px;
             
          }
          div.slide#daya-bay-energy-response-model-fit-to-calibration-data-2{
             background-image: url(/env/presentation/ConstrainingNonLinearity.png);
             background-size: 761px 553px;
             background-position: 0px 80px;
             
          }
          div.slide#daya-bay-ngd-analysis-most-precise-theta13{
             background-image: url(/env/presentation/DYBZheTaup2015Theta13OscillationAnalysis.png);
             background-size: 1057px 625px;
             background-position: 100px 60px;
             
          }
          div.slide#opticks-analytic-daya-bay-near-site-gpu-raytrace-3{
             background-image: url(/env/presentation/op_full_raytrace_3.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-analytic-daya-bay-near-site-gpu-raytrace-1{
             background-image: url(/env/presentation/op_full_raytrace_1.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-analytic-daya-bay-near-site-gpu-raytrace-0{
             background-image: url(/env/presentation/op_full_raytrace_0.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-analytic-daya-bay-near-site-gpu-raytrace-2{
             background-image: url(/env/presentation/op_full_raytrace_2.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-analytic-juno-chimney-gpu-raytrace-0{
             background-image: url(/env/presentation/j1707_chimney_analytic_raytrace.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-analytic-juno-pmt-snap-gpu-raytrace-1{
             background-image: url(/env/presentation/j1707-okop-snap.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#gpu-instance-culling-with-level-of-detail{
             background-image: url(/env/presentation/j1707_lod_oglrap_instcull.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-export-of-g4-geometry-to-gltf-2-0{
             background-image: url(/env/yoctoglrap/dyb_near_venice_half.png);
             background-size: 1020px 737px;
             background-position: 0px 0px;
             
          }
          div.slide#what-are-numpy-arrays{
             background-image: url(/env/presentation/what_are_numpy_arrays.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#what-are-numpy-arrays-2{
             background-image: url(/env/presentation/what_are_numpy_arrays.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#bvh{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_029.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#spatial-index-acceleration-structure{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_029.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#bvh-pascal{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_030.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#bvh-turing{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_031.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#hardware-traversal-of-bvh-spatial-index{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_031.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#siggraph-2018-announcing-worlds-first-ray-tracing-gpu{
             background-image: url(/env/presentation/nvidia/SIGGRAPH_2018_Announcing_Worlds_First_Ray_Tracing_GPU_half.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#siggraph-2019-eric-enderton-rt-cores{
             background-image: url(/env/presentation/nvidia/SIGGRAPH_2019_Eric_Enderton_RT_Cores.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-turing-gpu-72-sm-4608-cuda-cores{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_009.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-turing-gpu-72-sm-4608-cuda-cores-spec{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_009.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#raytrace-vs-raster{
             background-image: url(/env/presentation/nvidia/NV_Turing_Editors_Day_132.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#ray-tracing-vs-rasterization{
             background-image: url(/env/presentation/nvidia/black.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#raytrace-diagram{
             background-image: url(/env/presentation/graphics/1024px-ray_trace_diagram.svg.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#j1808-top-ogl{
             background-image: url(/env/presentation/j1808/j1808_top_ogl.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#j1808-top-rtx{
             background-image: url(/env/presentation/j1808/j1808_top_rtx.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#j1808-escapes{
             background-image: url(/env/presentation/j1808/j1808_escapes.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#geocache-360{
             background-image: url(/env/presentation/geocache_360.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#geocache-360-2{
             background-image: url(/env/presentation/geocache_360.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#juno-360-benchmark-with-optix-6-0-0-rtx-mode{
             background-image: url(/env/presentation/geocache_360.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#absmry-1m{
             background-image: url(/env/presentation/ana/absmry_1M.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#absmry-1m-2{
             background-image: url(/env/presentation/ana/absmry_1M.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#ta34-1m{
             background-image: url(/env/presentation/ana/ta34_1M.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#ta34-1m-2{
             background-image: url(/env/presentation/ana/ta34_1M.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#tv34-1m-a{
             background-image: url(/env/presentation/ana/tv34_1M_a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#tv34-1m-b{
             background-image: url(/env/presentation/ana/tv34_1M_b.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#tv21-1m-a{
             background-image: url(/env/presentation/ana/tv21_1M_a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#tv21-1m-a-2{
             background-image: url(/env/presentation/ana/tv21_1M_a.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#tv21-1m-c{
             background-image: url(/env/presentation/ana/tv21_1M_c.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#rtx-speedup{
             background-image: url(/env/presentation/ana/RTX_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#overheads{
             background-image: url(/env/presentation/ana/Overheads.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-speedup{
             background-image: url(/env/presentation/ana/Opticks_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-vs-geant4{
             background-image: url(/env/presentation/ana/Opticks_vs_Geant4.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-vs-geant4-2{
             background-image: url(/env/presentation/ana/Opticks_vs_Geant4.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nhit{
             background-image: url(/env/presentation/ana/NHit.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#interval-over-launch{
             background-image: url(/env/presentation/ana/Interval_over_Launch.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#titan-rtx-72-raytrace-dedicated-rt-cores-4608-cuda-cores-24gb-vram-2500-usd{
             background-image: url(/env/presentation/nvidia/TITAN_RTX.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#bench-20190526-143808{
             background-image: url(/env/presentation/ana/bench_20190526_143808.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#bench-20190526-143808-2{
             background-image: url(/env/presentation/ana/bench_20190526_143808.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#bench-20190526-202537{
             background-image: url(/env/presentation/ana/bench_20190526_202537.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#bench-20190526-202537-2{
             background-image: url(/env/presentation/ana/bench_20190526_202537.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#tv16-fastener{
             background-image: url(/env/presentation/tv/tv16_Fastener.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#tv20-polycone-neck{
             background-image: url(/env/presentation/tv/tv20_polycone_neck.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#inch-pmt-neck-cylinder-torus-polycone{
             background-image: url(/env/presentation/tv/tv20_polycone_neck.png);
             background-size: auto auto;
             background-position: 0px 0px;
             
          }
          div.slide#genstep-interface{
             background-image: url(/env/presentation/simulation/genstep_interface.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#introducing-optix-7{
             background-image: url(/env/presentation/nvidia/Introducing_OptiX_7.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#where-next-for-opticks{
             background-image: url(/env/presentation/nvidia/Introducing_OptiX_7.png);
             background-size: 640px 360px;
             background-position: 670px 300px;
             
          }
          div.slide#turing-built-for-rtx{
             background-image: url(/env/presentation/nvidia/TURING_Built_for_RTX_half.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#turing-built-for-rtx-2{
             background-image: url(/env/presentation/nvidia/TURING_Built_for_RTX_half.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-rtx-metro-exodus{
             background-image: url(/env/presentation/nvidia/NVIDIA_RTX_Metro_Exodus_half.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#modern-gpu-ray-tracing{
             background-image: url(/env/presentation/nvidia/Modern_GPU_RAY_Tracing.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-optix-programming-model-analogous-to-rasterization-apis-opengl-shaders{
             background-image: url(/env/presentation/nvidia/Modern_GPU_RAY_Tracing.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#nvidia-quadro-rtx-8000-48g{
             background-image: url(/env/presentation/nvidia/NVIDIA_Quadro_RTX.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#siggraph-2010-optix-a-general-purpose-ray-tracing-engine{
             background-image: url(/env/presentation/nvidia/SIGGRAPH_2010_OptiX_A_General_Purpose_Ray_Tracing_Engine.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#useful-speedup-1000x-but-why-not-giga-rays-s-1-photon-10-rays{
             background-image: url(/env/presentation/nvidia/dhart/dhart_siggraph_2019_RTX_traversal_custom_primitives.png);
             background-size: 720px 405px;
             background-position: 10px 210px;
             
          }
          div.slide#juno-intro-1{
             background-image: url(/env/Documents/JUNOIntro/JUNOIntro.001.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#juno-intro-2{
             background-image: url(/env/Documents/JUNOIntro/JUNOIntro.002.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#juno-intro-3{
             background-image: url(/env/Documents/JUNOIntro/JUNOIntro.003.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#juno-intro-4{
             background-image: url(/env/Documents/JUNOIntro/JUNOIntro.004.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#juno-multipurpose-pedro-nufact-2019{
             background-image: url(/env/presentation/juno/JUNO_Multipurpose_Pedro_NuFact_2019.png);
             background-size: 960px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#dhart-siggraph-2019-optix-5-traversal{
             background-image: url(/env/presentation/nvidia/dhart_siggraph_2019_OptiX_5_traversal.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#dhart-siggraph-2019-optix-5-traversal{
             background-image: url(/env/presentation/nvidia/dhart_siggraph_2019_OptiX_5_traversal.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-check-gui-to-bt5-sd{
             background-image: url(/env/presentation/ana/scan-pf-1/scan-pf-check-GUI-TO-BT5-SD.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-check-gui-to-sc-bt5-sd{
             background-image: url(/env/presentation/ana/scan-pf-1/scan-pf-check-GUI-TO-SC-BT5-SD.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-interval-over-launch{
             background-image: url(/env/presentation/ana/scan-pf-0/Interval_over_Launch.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-nhit{
             background-image: url(/env/presentation/ana/scan-pf-0/NHit.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-opticks-speedup{
             background-image: url(/env/presentation/ana/scan-pf-0/Opticks_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-opticks-vs-geant4{
             background-image: url(/env/presentation/ana/scan-pf-0/Opticks_vs_Geant4.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-overheads{
             background-image: url(/env/presentation/ana/scan-pf-0/Overheads.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-rtx-speedup{
             background-image: url(/env/presentation/ana/scan-pf-0/RTX_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-0-rtx-speedup-2{
             background-image: url(/env/presentation/ana/scan-pf-0/RTX_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-interval-over-launch{
             background-image: url(/env/presentation/ana/scan-pf-1/Interval_over_Launch.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-nhit{
             background-image: url(/env/presentation/ana/scan-pf-1/NHit.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-opticks-speedup{
             background-image: url(/env/presentation/ana/scan-pf-1/Opticks_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-opticks-speedup-2{
             background-image: url(/env/presentation/ana/scan-pf-1/Opticks_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-opticks-vs-geant4{
             background-image: url(/env/presentation/ana/scan-pf-1/Opticks_vs_Geant4.png);
             background-size: 1280px 720pxS;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-opticks-vs-geant4-2{
             background-image: url(/env/presentation/ana/scan-pf-1/Opticks_vs_Geant4.png);
             background-size: 1280px 720pxS;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-overheads{
             background-image: url(/env/presentation/ana/scan-pf-1/Overheads.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#scan-pf-1-rtx-speedup{
             background-image: url(/env/presentation/ana/scan-pf-1/RTX_Speedup.png);
             background-size: 1280px 720px;
             background-position: 0px 0px;
             
          }
          div.slide#opticks-translates-g4-geometry-to-gpu-without-approximation{
             background-image: url(/env/presentation/face_view_PMTs.png);
             background-size: 640px 360px;
             background-position: 20px 340px;
             
          }
          div.slide#cupy-numpy-api-some-of-scipy-accelerated-by-nvidia-cuda-curand-cublas-cusolver-cusparse-thrust-nccl{
             background-image: url(/env/presentation/cupy/cupy_is2.png);
             background-size: 1016px 377px;
             background-position: 150px 150px;
             
          }
          div.slide#cupy-easy-interface-to-nvidia-cuda-stack{
             background-image: url(/env/presentation/cupy/cupy_stack.png);
             background-size: 1075px 429px;
             background-position: 100px 100px;
             
          }
          div.slide#c-union-trick-common-with-cuda-mixed-type-arrays-simpler-faster{
             background-image: url(/env/presentation/cuda/float_as_int.png);
             background-size: 600px 89px;
             background-position: 40px 570px;
             
          } 

       </style>
    <!-- comment

Navigate the HTML slides by entering a page number and pressing return


reps-talk opticks-oct2019-dance    # NB underscores to hyphens for latex

   ## slide titles and s5_text directive content are written to /tmp/opticks-oct2019-dance.rst
   ## reps-talk converts that into a PDF document : as an aid to thinking about what to say

opticks_gpu_optical_photon_simulation_dec2019_ihep_epd_seminar.txt

http://www.ihep.cas.cn/xwdt/xshd/201911/t20191126_5443006.html -->
<!-- next

* NumPy np header
* NumPy/CuPy example -->
<div class="mytitle">
<header>
<h1 style="background-color:lightgrey">
     <i>Opticks</i> : GPU Optical Simulation via NVIDIA OptiX <br/> + A Mental Model for Effective Application of GPUs
    <h2 style="background-color:lightgrey;text-align:center"> Open source, https://bitbucket.org/simoncblyth/opticks </h2>
</h1>
</header>
</div>

<div class="mycredit">
<h2 style="background-color:lightgrey"> Simon C Blyth, IHEP, CAS &mdash; December 2019, IHEP EPD/PIFI Seminar</h2>
</div>
        <!--  s5talk  -->
        <br/>
    
</div>
<div class="slide" id="outline">
<h1>Outline</h1>
<img alt="/env/presentation/newtons-opticks.png" class="align-right" src="/env/presentation/newtons-opticks.png" style="width: 299px; height: 547px;" />
<div class="small"><span>&nbsp;</span></div><ul class="small simple">
<li>Context and Problem<ul>
<li>Jiangmen Underground Neutrino Observatory (JUNO)</li>
<li>Optical Photon Simulation Problem...</li>
</ul>
</li>
<li>Tools to create Solution<ul>
<li>Optical Photon Simulation  Ray Traced Image Rendering</li>
<li>Rasterization and Ray tracing</li>
<li>Turing Built for RTX</li>
<li>BVH : Bounding Volume Hierarchy</li>
<li>NVIDIA OptiX Ray Tracing Engine</li>
</ul>
</li>
<li>Opticks : The Solution<ul>
<li>Geant4 + Opticks Hybrid Workflow : External Optical Photon Simulation</li>
<li>Opticks : Translates G4 Optical Physics to CUDA/OptiX</li>
<li>Opticks : Translates G4 Geometry to GPU, Without Approximation</li>
<li>CUDA/OptiX Intersection Functions for ~10 Primitives</li>
<li>CUDA/OptiX Intersection Functions for Arbitrarily Complex CSG Shapes</li>
</ul>
</li>
<li>Validation and Performance<ul>
<li>Random Aligned Bi-Simulation -&gt; Direct Array Comparison</li>
<li>Perfomance Scanning from 1M to 400M Photons</li>
</ul>
</li>
<li>Overview + Links</li>
</ul>
<div class="small"><hr/></div>
        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="outline-of-mental-model">
<h1><span class="i">Outline of Mental Model</span></h1>
<pre>


</pre>

<div class="mytitle2">
<header>
<h1 style="background-color:lightgrey">
     <i>Opticks</i> : GPU Optical Simulation via NVIDIA OptiX <br/> <span style="color:red">+ A Mental Model for Effective Application of GPUs </span>
</h1>
</header>
</div><ul class="small simple">
<li>GPU Mental Model : Context and Constraints<ul>
<li>Understanding GPU Graphical Origins -&gt; Effective GPU Computation</li>
<li>GPU Demands Simplicity (Arrays) -&gt; Big Benefits : NumPy + CuPy</li>
</ul>
</li>
<li>Parallel Processing 0th Step<ul>
<li>Re-shape Data into &quot;Parallel&quot; Array Form</li>
</ul>
</li>
<li>High Level Tools<ul>
<li>Survey of High Level General Purpose CUDA Packages</li>
<li>NumPy + CuPy</li>
</ul>
</li>
<li>Example 1 : NumPy/CuPy Python interface<ul>
<li>Python vs NumPy vs CuPy : Python/NumPy ~ 10,  NumPy/CuPy ~ 1300</li>
</ul>
</li>
<li>Array Mechanics<ul>
<li>NP.hh header + union &quot;trick&quot;</li>
</ul>
</li>
<li>Example 2 : A Taste of Thrust C++<ul>
<li>Photon History Indexing with CUDA Thrust</li>
</ul>
</li>
<li>Summary</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- comment

:i:`JUNO_Intro_1`
- - - - - - - - - - - - - - - - - -

.. s5_talk::

    JUNO is a large neutrino experiment under construction in southern China.
    Its designed to determine the neutrino mass order
    from measurements of oscillated reactor neutrinos from a
    distance of 53km

    Construction is expected to be completed in 2021. -->
</div>
<div class="slide" id="juno-intro-2">
<h1><span class="i">JUNO_Intro_2</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="juno-intro-3">
<h1><span class="i">JUNO_Intro_3</span></h1>

        <!--  s5talk  -->
        <br/>
    <!-- comment

* https://juno.ihep.ac.cn/cgi-bin/Dev_DocDB/ShowDocument?docid=2058

Jilei LLR Tutorial

Muon average track length in CD LS is about 23 m,
suppose 2 MeV/cm energy deposit,
LS optical photon yield is 10k/MeV

20k/cm
2M/m

23*2 = 46M
35*2 = 70M -->
</div>
<div class="slide" id="geant4-monte-carlo-simulation-toolkit">
<h1>Geant4 : Monte Carlo Simulation Toolkit</h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="geant4-monte-carlo-simulation-toolkit-generality">
<h1>Geant4 : Monte Carlo Simulation Toolkit Generality</h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Standard Simulation Tool of HEP</span></p>
<p class="small"><strong>Geant4</strong> simulates particles travelling through matter</p>
<ul class="small simple">
<li>high energy, nuclear and accelerator physics</li>
<li>medical physics : deciding radiotherapy doses/sources</li>
<li>space engineering : satellites</li>
</ul>
<p class="small"><strong>Geant4 Approach</strong></p>
<ul class="small simple">
<li>geometry : <strong>tree of CSG solids</strong></li>
<li>particles : track position and time etc..</li>
<li>processes : nuclear, EM, weak, <strong>optical</strong></li>
</ul>
<p class="small"><strong>Very General and Capable Tool</strong></p>
<ul class="small simple">
<li><strong>mostly unused for optical photon propagation</strong></li>
</ul>
<p class="tiny last"><a class="reference external" href="https://geant4.web.cern.ch">https://geant4.web.cern.ch</a></p>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="optical-photon-simulation-problem">
<h1><span class="incremental">Optical Photon Simulation Problem...</span></h1>
<pre>







</pre><div class="sidebar">
<p class="first sidebar-title"><span class="small">Huge CPU Memory+Time Expense</span></p>
<dl class="small last docutils">
<dt><strong>JUNO Muon Simulation Bottleneck</strong></dt>
<dd>~99% CPU time, memory constraints</dd>
<dt><strong>Ray-Geometry intersection Dominates</strong></dt>
<dd>simulation is not alone in this problem...</dd>
<dt><strong>Optical photons : naturally parallel, simple :</strong></dt>
<dd><ul class="first last simple">
<li>produced by Cherenkov+Scintillation</li>
<li>yield only Photomultiplier hits</li>
</ul>
</dd>
</dl>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="optical-photon-simulation-ray-traced-image-rendering">
<h1><span class="small">Optical Photon Simulation  Ray Traced Image Rendering</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Not a Photo, a Calculation</p>
<img alt="/env/optix/samples/optix-ray-tracing-glasses.png" class="align-right" src="/env/optix/samples/optix-ray-tracing-glasses.png" style="width: 450px;" />
<p class="tiny last"><a class="reference external" href="http://on-demand.gputechconf.com/siggraph/2013/presentation/SG3106-Building-Ray-Tracing-Applications-OptiX.pdf">http://on-demand.gputechconf.com/siggraph/2013/presentation/SG3106-Building-Ray-Tracing-Applications-OptiX.pdf</a></p>
</div>
<p class="small"><strong>Much in common : geometry, light sources, optical physics</strong></p>
<ul class="small simple">
<li><span class="blue">simulation</span> : photon parameters at PMT detectors</li>
<li><span class="blue">rendering</span> : pixel values at image plane</li>
<li><span class="red">both limited by ray geometry intersection, aka ray tracing</span></li>
</ul>
<pre>

</pre><p class="small"><strong>Many Applications of ray tracing</strong> :</p>
<ul class="small simple">
<li>advertising, design, architecture, films, games,...</li>
<li>-&gt; huge efforts to improve hw+sw over 30 yrs</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- skip


**August 2018 : Major Ray Tracing Advance**

* NVIDIA RTX Platform, Turing GPU
* :red:`ray trace dedicated hardware : RT cores`

* SIGGRAPH 2018, announcing RTX
* https://www.youtube.com/watch?v=LP6miCI6-h4 -->
</div>
<div class="slide" id="ray-tracing-vs-rasterization">
<h1><span class="i">Ray-tracing vs Rasterization</span></h1>
<img alt="/env/presentation/nvidia/nv_rasterization.png" class="align-left" src="/env/presentation/nvidia/nv_rasterization.png" style="width: 550px;" />
<img alt="/env/presentation/nvidia/nv_raytrace.png" class="align-right" src="/env/presentation/nvidia/nv_raytrace.png" style="width: 550px;" />

        <!--  s5talk  -->
        <br/>
    <!-- comment

https://www.youtube.com/watch?v=Mrixi27G9yM
RTX Launch -->
</div>
<div class="slide" id="siggraph-2018-announcing-worlds-first-ray-tracing-gpu">
<h1><span class="i">SIGGRAPH_2018_Announcing_Worlds_First_Ray_Tracing_GPU</span></h1>
<pre>







</pre><table border="1" class="huge docutils align-right">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><span class="white">10 Giga Rays/s</span></td>
</tr>
</tbody>
</table>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="turing-built-for-rtx-2">
<h1><span class="i">TURING BUILT FOR RTX 2</span></h1>
<pre>






</pre><div class="sidebar">
<p class="first sidebar-title"><span class="small">Offload Ray Trace to Dedicated HW</span></p>
<ul class="small simple">
<li>RT core : BVH traversal + ray tri. intersection</li>
<li>frees up general purpose SM</li>
</ul>
<p class="tiny">SM : Streaming Multiprocessor</p>
<p class="tiny last">BVH : Bounding Volume Hierarchy</p>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="nvidia-rtx-metro-exodus">
<h1><span class="i">NVIDIA RTX Metro Exodus</span></h1>
<pre>









</pre><div class="sidebar">
<p class="first sidebar-title"><span class="small">RTX Platform : Hybrid Rendering</span></p>
<ul class="small simple">
<li><span class="red">Ray trace (RT cores)</span></li>
<li>AI inference (Tensor cores) -&gt; Denoising</li>
<li>Rasterization (pipeline)</li>
</ul>
<ul class="small simple">
<li>Compute (SM, CUDA cores)</li>
</ul>
<p class="small last">-&gt; <span class="red">real-time photoreal cinematic 3D rendering</span></p>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="spatial-index-acceleration-structure">
<h1><tt class="docutils literal">Spatial Index Acceleration Structure</tt></h1>
<pre>











</pre><div class="sidebar">
<p class="first sidebar-title"><span class="small">Tree of Bounding Boxes (bbox)</span></p>
<ul class="small last simple">
<li>aims to minimize bbox+primitive intersects</li>
<li>accelerates ray-geometry intersection</li>
</ul>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="nvidia-optix-ray-tracing-engine-http-developer-nvidia-com-optix">
<h1><span class="small">NVIDIA OptiX Ray Tracing Engine -- http://developer.nvidia.com/optix</span></h1>
<div class="sidebar">
<p class="first sidebar-title">OptiX Raytracing Pipeline</p>
<p class="small">Analogous to OpenGL rasterization pipeline:</p>
<img alt="/env/optix/docs/optix-model.png" class="last align-right" src="/env/optix/docs/optix-model.png" style="width: 450px;" />
</div>
<p class="small"><strong>OptiX makes GPU ray tracing accessible</strong></p>
<ul class="small simple">
<li><strong>accelerates</strong> ray-geometry intersections</li>
<li>simple : single-ray programming model</li>
<li>&quot;...free to use within any application...&quot;</li>
<li><span class="red">access RT Cores[1] with OptiX 6.0.0+ via RTX mode</span></li>
</ul>
<p class="small"><strong>NVIDIA expertise:</strong></p>
<ul class="small simple">
<li><span class="red">~linear scaling up to 4 GPUs</span></li>
<li>acceleration structure creation + traversal (Blue)</li>
<li>instanced sharing of geometry + acceleration structures</li>
<li>compiler optimized for GPU ray tracing</li>
</ul>
<p class="small"><strong>Opticks provides (Yellow):</strong></p>
<ul class="small simple">
<li>ray generation program</li>
<li><span class="red">ray geometry intersection+bbox programs</span></li>
</ul>
<p class="tiny">[1] Turing RTX GPUs</p>

        <!--  s5talk  -->
        <br/>
    <!-- skip

 * no need for fancy shading, so closest hit is simple, just collecting the normal
   and ray trace distance

* creating renderers is the most common use of OptiX, but it is a general
   intersection API so works fine to do simulation -->
</div>
<div class="slide" id="geant4opticksworkflow">
<h1><span class="i">Geant4OpticksWorkflow</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="opticks-translates-g4-optical-physics-to-cuda-optix">
<h1><span class="small">Opticks : Translates G4 Optical Physics to CUDA/OptiX</span></h1>
<div class="sidebar">
<p class="first sidebar-title">GPU Resident Photons</p>
<dl class="small docutils">
<dt><strong>Seeded on GPU</strong></dt>
<dd>associate photons -&gt; <em>gensteps</em> (via seed buffer)</dd>
<dt><strong>Generated on GPU, using genstep param:</strong></dt>
<dd><ul class="first last simple">
<li>number of photons to generate</li>
<li>start/end position of step</li>
</ul>
</dd>
<dt><strong>Propagated on GPU</strong></dt>
<dd><span class="red">Only photons hitting PMTs copied to CPU</span></dd>
</dl>
<p class="small">Thrust: <strong>high level C++ access to CUDA</strong></p>
<div class="small figure align-right">
<img alt="/env/numerics/thrust/thrust.png" src="/env/numerics/thrust/thrust.png" style="width: 300px;" />
</div>
<ul class="small last simple">
<li><a class="reference external" href="https://developer.nvidia.com/Thrust">https://developer.nvidia.com/Thrust</a></li>
</ul>
</div>
<p class="small"><span class="blue">OptiX : single-ray programming model</span> -&gt; line-by-line translation</p>
<dl class="small docutils">
<dt><strong>CUDA Ports of Geant4 classes</strong></dt>
<dd><ul class="first last simple">
<li>G4Cerenkov (only generation loop)</li>
<li>G4Scintillation (only generation loop)</li>
<li>G4OpAbsorption</li>
<li>G4OpRayleigh</li>
<li>G4OpBoundaryProcess (only a few surface types)</li>
</ul>
</dd>
<dt><strong>Modify Cherenkov + Scintillation Processes</strong></dt>
<dd><ul class="first last simple">
<li>collect <em>genstep</em>, copy to GPU for generation</li>
<li><span class="red">avoids copying millions of photons to GPU</span></li>
</ul>
</dd>
<dt><strong>Scintillator Reemission</strong></dt>
<dd><ul class="first last simple">
<li>fraction of bulk absorbed &quot;reborn&quot; within same thread</li>
<li>wavelength generated by reemission texture lookup</li>
</ul>
</dd>
<dt><strong>Opticks (OptiX/Thrust GPU interoperation)</strong></dt>
<dd><ul class="first last simple">
<li><strong>OptiX</strong> : upload gensteps</li>
<li><strong>Thrust</strong> : seeding, distribute genstep indices to photons</li>
<li><strong>OptiX</strong> : launch photon generation and propagation</li>
<li><strong>Thrust</strong> : pullback photons that hit PMTs</li>
<li><strong>Thrust</strong> : index photon step sequences (optional)</li>
</ul>
</dd>
</dl>

        <!--  s5talk  -->
        <br/>
    <!-- skip

Some further detail is on the reemissio and also
use of CUDA Thrust : which provides a higher level way
of using CUDA -->
</div>
<div class="slide" id="g4solid-cuda-intersect-functions-for-10-primitives">
<h1><span class="small">G4Solid -&gt; CUDA Intersect Functions for ~10 Primitives</span></h1>
<ul class="small simple">
<li>3D parametric ray : <strong>ray(x,y,z;t) = rayOrigin  +  t * rayDirection</strong></li>
<li>implicit equation of primitive : <strong>f(x,y,z) = 0</strong></li>
<li>-&gt; polynomial in <strong>t</strong> , roots: <strong>t &gt; t_min</strong>  -&gt; intersection positions + surface normals</li>
</ul>
<div class="figure align-center">
<img alt="/env/presentation/tboolean_parade_sep2017.png" src="/env/presentation/tboolean_parade_sep2017.png" style="width: 900px;" />
<p class="caption">Sphere, Cylinder, Disc, Cone, Convex Polyhedron, Hyperboloid, <span class="red">Torus</span>, ...</p>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="g4boolean-cuda-optix-intersection-program-implementing-csg">
<h1><span class="small">G4Boolean -&gt; CUDA/OptiX Intersection Program Implementing CSG</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Outside/Inside Unions</p>
<p class="small">dot(normal,rayDir) -&gt; Enter/Exit</p>
<img alt="/env/presentation/kensler_union_of_two_spheres_from_outside.png" class="align-center" src="/env/presentation/kensler_union_of_two_spheres_from_outside.png" style="width: 300px;" />
<img alt="/env/presentation/kensler_union_of_two_spheres_from_inside.png" class="align-center" src="/env/presentation/kensler_union_of_two_spheres_from_inside.png" style="width: 300px;" />
<ul class="small last simple">
<li><strong>A + B</strong> boundary not inside other</li>
<li><strong>A * B</strong> boundary inside other</li>
</ul>
</div>
<p class="small">Complete Binary Tree, pick between pairs of nearest intersects:</p>
<table border="1" class="small docutils">
<colgroup>
<col width="37%" />
<col width="17%" />
<col width="24%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"><em>UNION</em> tA &lt; tB</th>
<th class="head">Enter B</th>
<th class="head">Exit B</th>
<th class="head">Miss B</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><strong>Enter A</strong></td>
<td>ReturnA</td>
<td><span class="blue">LoopA</span></td>
<td>ReturnA</td>
</tr>
<tr><td><strong>Exit A</strong></td>
<td>ReturnA</td>
<td>ReturnB</td>
<td>ReturnA</td>
</tr>
<tr><td><strong>Miss A</strong></td>
<td>ReturnB</td>
<td>ReturnB</td>
<td>ReturnMiss</td>
</tr>
</tbody>
</table>
<ul class="small simple">
<li><em>Nearest hit intersect algorithm</em> [1] avoids state<ul>
<li>sometimes <span class="blue">Loop</span> : advance <strong>t_min</strong> , re-intersect both</li>
<li>classification shows if inside/outside</li>
</ul>
</li>
<li><em>Evaluative</em> [2] implementation emulates recursion:<ul>
<li><span class="red">recursion not allowed</span> in OptiX intersect programs</li>
<li>bit twiddle traversal of complete binary tree</li>
<li>stacks of postorder slices and intersects</li>
</ul>
</li>
<li><span class="red">Identical geometry to Geant4</span><ul>
<li>solving the same polynomials</li>
<li>near perfect intersection match</li>
</ul>
</li>
</ul>
<dl class="tiny docutils">
<dt>[1] Ray Tracing CSG Objects Using Single Hit Intersections, Andrew Kensler (2006)</dt>
<dd>with corrections by author of XRT Raytracer <a class="reference external" href="http://xrt.wikidot.com/doc:csg">http://xrt.wikidot.com/doc:csg</a></dd>
<dt>[2] <a class="reference external" href="https://bitbucket.org/simoncblyth/opticks/src/tip/optixrap/cu/csg_intersect_boolean.h">https://bitbucket.org/simoncblyth/opticks/src/tip/optixrap/cu/csg_intersect_boolean.h</a></dt>
<dd>Similar to binary expression tree evaluation using postorder traverse.</dd>
</dl>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="opticks-translates-g4-geometry-to-gpu-without-approximation">
<h1><span class="small">Opticks : Translates G4 Geometry to GPU, Without Approximation</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Materials/Surfaces -&gt; GPU Texture</span></p>
<p class="small"><strong>Material/Surface/Scintillator properties</strong></p>
<ul class="small simple">
<li>interpolated to standard wavelength domain</li>
<li>interleaved into &quot;boundary&quot; texture</li>
<li>&quot;reemission&quot; texture for wavelength generation</li>
</ul>
<p class="small"><strong>Material/surface boundary : 4 indices</strong></p>
<ul class="small simple">
<li>outer material (parent)</li>
<li>outer surface (inward photons, parent -&gt; self)</li>
<li>inner surface (outward photons, self -&gt; parent)</li>
<li>inner material (self)</li>
</ul>
<p class="small">Primitives labelled with unique boundary index</p>
<ul class="small simple">
<li>ray primitive intersection -&gt; boundary index</li>
<li>texture lookup -&gt; material/surface properties</li>
</ul>
<p class="small last"><span class="red">simple/fast properties + reemission wavelength</span></p>
</div>
<p class="small"><strong>G4 Structure Tree -&gt; Instance+Global Arrays -&gt; OptiX</strong></p>
<p class="small">Group structure into repeated instances + global remainder:</p>
<ul class="small simple">
<li>auto-identify repeated geometry with &quot;progeny digests&quot;<ul>
<li>JUNO : 5 distinct instances + 1 global</li>
</ul>
</li>
<li>instance transforms used in OptiX/OpenGL geometry</li>
</ul>
<p class="small"><span class="red">instancing -&gt; huge memory savings for JUNO PMTs</span></p>
<pre>
</pre><!-- comment

**Automated : Geant4 "World" -> Opticks CSG -> CUDA/OptiX**

**Solids : analytic CSG + triangulated**

* intersection functions for ~10 primitives
* intersection program for arbitrarily complex CSG shapes

  * :red:`automated : G4 -> Opticks -> OptiX` -->

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="j1808-top-rtx">
<h1><span class="i">j1808_top_rtx</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="j1808-top-ogl">
<h1><span class="i">j1808_top_ogl</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="validation-of-opticks-simulation-by-comparison-with-geant4">
<h1><span class="small">Validation of Opticks Simulation by Comparison with Geant4</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Random Aligned Bi-Simulation</span></p>
<p class="small">Same inputs to <em>Opticks</em> and <em>Geant4</em>:</p>
<ul class="small simple">
<li>CPU generated photons</li>
<li>GPU generated randoms, fed to <em>Geant4</em></li>
</ul>
<p class="small">Common recording into <em>OpticksEvents</em>:</p>
<ul class="small simple">
<li>compressed photon step record, up to 16 steps</li>
<li>persisted as <em>NumPy</em> arrays for python analysis</li>
</ul>
<p class="small">Aligned random consumption, direct comparison:</p>
<ul class="small last simple">
<li>~every <strong>scatter, absorb, reflect, transmit</strong>
at matched positions, times, polarization, wavlen</li>
</ul>
</div>
<p class="small"><strong>Bi-simulations of all JUNO solids, with millions of photons</strong></p>
<dl class="small docutils">
<dt>mis-aligned histories</dt>
<dd>mostly &lt; 0.25%, &lt; 0.50% for largest solids</dd>
<dt>deviant photons within matched history</dt>
<dd>&lt; 0.05% (500/1M)</dd>
</dl>
<p class="small"><strong>Primary sources of problems</strong></p>
<ul class="small simple">
<li>grazing incidence, edge skimmers</li>
<li>incidence at constituent solid boundaries</li>
</ul>
<p class="small"><strong>Primary cause : float vs double</strong></p>
<p class="small"><em>Geant4</em> uses <em>double</em> everywhere, <em>Opticks</em> only sparingly (observed <em>double</em> costing 10x slowdown with RTX)</p>
<p class="small"><strong>Conclude</strong></p>
<ul class="small simple">
<li><span class="blue">neatly oriented photons more prone to issues than realistic ones</span></li>
<li>perfect &quot;technical&quot; matching not feasible</li>
<li>instead shift validation to more realistic full detector &quot;calibration&quot; situation</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="scan-pf-check-gui-to-sc-bt5-sd">
<h1><span class="i">scan-pf-check-GUI-TO-SC-BT5-SD</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="recording-the-steps-of-millions-of-photons">
<h1><span class="small">Recording the steps of Millions of Photons</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Compression Essential</p>
<p class="small">Domain compression to fit in VRAM</p>
<ul class="small simple">
<li>16 step records per photon -&gt; 256 bytes/photon</li>
<li>10M photons -&gt; 2.56 GB</li>
</ul>
<p class="small"><strong>4-bit History Flags at Each Step</strong></p>
<pre class="mypretiny">
BT : boundary
BR : boundary reflect
SC : bulk scatter
AB : bulk absorb
SD : surface detect
SA : surface absorb
</pre><dl class="small last docutils">
<dt><strong>seqhis</strong></dt>
<dd><span class="red">64-bit integer history sequence</span></dd>
</dl>
</div>
<p class="small">Up to 16 steps of the photon propagation are recorded.</p>
<p class="small"><strong>Photon Array</strong> : 4 * <em>float4</em> = 512 bits/photon</p>
<ul class="small simple">
<li><em>float4</em>: position, time  [32 * 4 = 128 bits]</li>
<li><em>float4</em>: direction, weight</li>
<li><em>float4</em>: polarization, wavelength</li>
<li><em>float4</em>: flags: material, boundary, history</li>
</ul>
<p class="small"><strong>Step Record Array</strong> : 2 * <em>short4</em> = 2*16*4 = 128 bits/record</p>
<ul class="small simple">
<li><em>short4</em>: position, time (snorm compressed)  [4*16 = 64 bits]</li>
<li><em>uchar4</em>: polarization, wavelength (uchar compressed) [4*8 = 32 bits]</li>
<li><em>uchar4</em>: material, history flags [4*8 = 32 bits]</li>
</ul>
<p class="small">Compression uses known domains of position (geometry center, extent),
time (0:200ns), wavelength, polarization.</p>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="scan-pf-check-gui-to-bt5-sd">
<h1><span class="i">scan-pf-check-GUI-TO-BT5-SD</span></h1>

        <!--  s5talk  -->
        <br/>
    <!-- comment

* DELL Precision 7920T Workstation
* Intel Xeon Silver 4114, 2.2GHz, 40 cores, 65G
* NVIDIA Quadro RTX 8000, 48G

* DELL Precision 7920T Workstation
* Intel Xeon Gold 5118, 2.3GHz, 48 cores, 65G
* NVIDIA TITAN RTX, 24G
* NVIDIA TITAN V, 12G -->
</div>
<div class="slide" id="performance-scanning-from-1m-to-400m-photons">
<h1><span class="small">Performance : Scanning from 1M to 400M Photons</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Test Hardware + Software</span></p>
<p class="small"><strong>Workstation</strong></p>
<ul class="small simple">
<li>DELL Precision 7920T Workstation</li>
<li>Intel Xeon Gold 5118, 2.3GHz, 48 cores, 62G</li>
<li>NVIDIA Quadro RTX 8000 (48G)</li>
</ul>
<p class="small"><strong>Software</strong></p>
<ul class="small simple">
<li>Opticks 0.0.0 Alpha</li>
<li>Geant4 10.4p2</li>
<li>NVIDIA OptiX 6.5.0</li>
<li>NVIDIA Driver 435.21</li>
<li>CUDA 10.1</li>
</ul>
<p class="small"><strong>IHEP GPU Cluster</strong></p>
<ul class="small last simple">
<li>10 nodes of 8x NVIDIA Tesla GV100 (32G)</li>
</ul>
</div>
<p class="small"><strong>Full JUNO Analytic Geometry j1808v5</strong></p>
<ul class="small simple">
<li>&quot;calibration source&quot; genstep at center of scintillator</li>
</ul>
<p class="small"><strong>Production Mode : does the minimum</strong></p>
<ul class="small simple">
<li>only saves hits</li>
<li>skips : genstep, photon, source, record, sequence, index, ..</li>
<li>no <em>Geant4</em> propagation (other than at 1M for extrapolation)</li>
</ul>
<p class="small"><strong>Multi-Event Running, Measure:</strong></p>
<dl class="small docutils">
<dt><span class="red">interval</span></dt>
<dd>avg time between successive launches, including overheads:
(upload gensteps + <span class="blue">launch</span> + download hits)</dd>
<dt><span class="blue">launch</span></dt>
<dd>avg of 10 OptiX launches</dd>
</dl>
<ul class="small simple">
<li>overheads &lt; 10% beyond 20M photons</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- comment

.. sidebar:: :small:`Genstep/Hit Copying Overheads`

     .. class:: small

         **launch**
           time of each OptiX launch (avg of 10)

         **interval, including overhead**
           time between subsequent launches (avg of 9)

         :red:`Mostly < 10% Overhead beyond 20M photons` -->
</div>
<div class="slide" id="nvidia-quadro-rtx-8000-48g">
<h1><tt class="docutils literal">NVIDIA Quadro RTX 8000 (48G)</tt></h1>
<div class="mysidebar" style="position: absolute; top:15%; left:65%; width:22%; height:10% ;" >
   <strong>  NVIDIA China <br> for loaning the card </strong>
</div>
        <!--  s5talk  -->
        <br/>
    <!-- comment

update these profilesmry.py plots with::

    scan-plot     ## on workstation
    scan-pub      ## on laptop with simoncblyth.bitbucket.org clone
    scan-pubrst   ## prepare RST for inclusion at tail -->
</div>
<div class="slide" id="scan-pf-1-nhit">
<h1><span class="i">scan-pf-1_NHit</span></h1>
<pre>








</pre><div class="sidebar">
<p class="first sidebar-title"><span class="small">Photon Launch Size : VRAM Limited</span></p>
<p class="small"><strong>NVIDIA Quadro RTX 8000 (48 GB)</strong></p>
<ul class="small simple">
<li>photon 4*4 floats : 64 bytes</li>
<li>curandState       : 48 bytes</li>
</ul>
<p class="small last"><strong>400M photons</strong> x <span class="blue">112 bytes</span> ~ 45G</p>
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="scan-pf-1-opticks-vs-geant4-2">
<h1><span class="i">scan-pf-1_Opticks_vs_Geant4 2</span></h1>
<pre>




</pre><table border="1" class="small docutils align-center">
<colgroup>
<col width="30%" />
<col width="42%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head" colspan="2">JUNO analytic, 400M photons from center</th>
<th class="head">Speedup</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Geant4 Extrap.</td>
<td>95,600 s (26 hrs)</td>
<td>&nbsp;</td>
</tr>
<tr><td>Opticks RTX ON (i)</td>
<td>58 s</td>
<td>1650x</td>
</tr>
</tbody>
</table>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="scan-pf-1-opticks-speedup-2">
<h1><span class="i">scan-pf-1_Opticks_Speedup 2</span></h1>
<pre>









</pre><table border="1" class="small docutils align-center">
<colgroup>
<col width="41%" />
<col width="30%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head" colspan="2">JUNO analytic, 400M photons from center</th>
<th class="head">Speedup</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Opticks RTX ON (i)</td>
<td>58s</td>
<td>1650x</td>
</tr>
<tr><td>Opticks RTX OFF (i)</td>
<td>275s</td>
<td>350x</td>
</tr>
<tr><td>Geant4 Extrap.</td>
<td>95,600s (26 hrs)</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="scan-pf-1-rtx-speedup">
<h1><span class="i">scan-pf-1_RTX_Speedup</span></h1>
<pre>











</pre><table border="1" class="docutils align-center">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><strong>5x Speedup from RTX with JUNO analytic geometry</strong></td>
</tr>
</tbody>
</table>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="useful-speedup-1000x-but-why-not-giga-rays-s-1-photon-10-rays">
<h1><span class="small">Useful Speedup &gt; 1000x : But Why Not Giga Rays/s ? (1 Photon ~10 Rays)</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">100M photon RTX times, avg of 10</span></p>
<table border="1" class="colwidths-given small docutils">
<colgroup>
<col width="43%" />
<col width="14%" />
<col width="14%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head" colspan="4">Launch times for various geometries</th>
</tr>
<tr><th class="head">Geometry</th>
<th class="head">Launch (s)</th>
<th class="head">Giga Rays/s</th>
<th class="head">Relative
to ana</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>JUNO ana</td>
<td>13.2</td>
<td>0.07</td>
<td>&nbsp;</td>
</tr>
<tr><td>JUNO tri.sw</td>
<td>6.9</td>
<td>0.14</td>
<td>1.9x</td>
</tr>
<tr><td>JUNO tri.hw</td>
<td>2.2</td>
<td>0.45</td>
<td>6.0x</td>
</tr>
<tr><td colspan="4">&nbsp;</td>
</tr>
<tr><td>Boxtest ana</td>
<td>0.59</td>
<td>1.7</td>
<td>&nbsp;</td>
</tr>
<tr><td>Boxtest tri.sw</td>
<td>0.62</td>
<td>1.6</td>
<td>&nbsp;</td>
</tr>
<tr><td>Boxtest tri.hw</td>
<td>0.30</td>
<td>3.3</td>
<td>1.9x</td>
</tr>
</tbody>
</table>
<ul class="small simple">
<li>ana : Opticks analytic CSG (SM)</li>
<li>tri.sw : software triangle intersect (SM)</li>
<li><span class="red">tri.hw : hardware triangle intersect (RT)</span></li>
</ul>
<p class="small">JUNO 15k triangles, 132M without instancing</p>
<p class="small last"><strong>Simple Boxtest geometry gets into ballpark</strong></p>
</div>
<ul class="small simple">
<li>NVIDIA claim : <span class="blue">10 Giga Rays/s with RT Core</span></li>
<li>-&gt; <strong>1 Billion photons per second</strong></li>
<li><strong>RT cores : built-in triangle intersect + 1-level of instancing</strong></li>
<li>flatten scene model to avoid SM&lt;-&gt;RT roundtrips ?</li>
</ul>
<pre>












</pre><p class="small">OptiX Performance Tools and Tricks, David Hart, NVIDIA
<a class="reference external" href="https://developer.nvidia.com/siggraph/2019/video/sig915-vid">https://developer.nvidia.com/siggraph/2019/video/sig915-vid</a></p>

        <!--  s5talk  -->
        <br/>
    <!-- comment

    +- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    |           RTX ON Launch times for 100M photons, (avg of 10)                                             |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | Id  |  Geometry                   |  Launch Time (s) |  GigaRays/s      |  Speedup Relative to analytic |
    +=====+=============================+==================+==================+===============================+
    | pf1 | JUNO analytic CSG           |   13.2           |  0.07            |                               |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | pt0 | JUNO triangulated SW        |    6.9           |  0.14            |   1.9x                        |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | pt0 | JUNO triangulated HW        |    2.2           |  0.45            |   6.0x                        |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    |     |                             |                  |                  |                               |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | ph11| Box-in-box analytic CSG     |    0.59          |  1.7             |                               |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | ph13| Box-in-box tri(4k) SW       |    0.62          |  1.6             |                               |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+
    | ph13| Box-in-box tri(4k) HW       |    0.30          |  3.3             |    1.9x                       |
    +- - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - -+- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -+


.. class:: tiny

    JUNO: j1808v5, box-in-box: tboolean-box -->
</div>
<div class="slide" id="where-next-for-opticks">
<h1><span class="small">Where Next for Opticks ?</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">NVIDIA OptiX 7 : Entirely new API</span></p>
<ul class="small last simple">
<li>introduced August 2019</li>
<li>low-level CUDA-centric thin API</li>
<li><span class="strike">near perfect scaling to 4 GPUs, for free</span></li>
</ul>
</div>
<p class="small"><strong>JUNO+Opticks into Production</strong></p>
<ul class="small simple">
<li>optimize geometry modelling for RTX</li>
<li>full JUNO geometry validation iteration</li>
<li>JUNO offline integration</li>
<li>optimize GPU cluster throughput:<ul>
<li>split/join events to fit VRAM</li>
<li>job/node/multi-GPU strategy</li>
</ul>
</li>
<li>support OptiX 7, find multi-GPU load balancing approach</li>
</ul>
<pre>
</pre><p class="small"><strong>Geant4+Opticks Integration : Work with Geant4 Collaboration</strong></p>
<ul class="small simple">
<li>finalize <em>Geant4+Opticks</em> extended example<ul>
<li>aiming for <em>Geant4</em> distrib</li>
</ul>
</li>
<li>prototype <em>Genstep</em> interface inside <em>Geant4</em><ul>
<li>avoid customizing <em>G4Cerenkov</em> <em>G4Scintillation</em></li>
</ul>
</li>
</ul>
<pre>
</pre><p class="small"><strong>Alpha Development ------&gt;-----------------&gt; Robust Tool</strong></p>
<ul class="small simple">
<li>many more users+developers required (current ~10+1)</li>
<li>if you have an optical photon simulation problem ...<ul>
<li>start by joining : <a class="reference external" href="https://groups.io/g/opticks">https://groups.io/g/opticks</a></li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- comment

* geometry translation help : NEXO, DUNE, LZ
* interest -> usage : SABRE, Baikal GVD, KM3Net, MicroBooNE
* expand interest : scintillator using medical imaging companies
* automated geometry translation, but problems inevitable

* now: sole-developer + ~10 exploratory users from ~5 detectors
* needs users+developers, join https://groups.io/g/opticks -->
</div>
<div class="slide" id="drastically-improved-optical-photon-simulation-performance">
<h1><span class="small">Drastically Improved Optical Photon Simulation Performance...</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">How is &gt;1000x possible ?</span></p>
<p class="small"><strong>Progress over 30 yrs, Billions of Dollars</strong></p>
<ul class="small simple">
<li>industry funded : game, film, design, ...</li>
<li>re-purposed by translating geometry to GPU<ul>
<li>tree of C++ objects -&gt; arrays -&gt; BVH</li>
</ul>
</li>
</ul>
<p class="small"><strong>Photon Simulation ideally suited to GPU</strong></p>
<ul class="small simple">
<li>millions of photons -&gt; abundantly parallel</li>
<li>simple phys. -&gt; small stack -&gt; many in flight</li>
<li>decoupled -&gt; no synchronization</li>
</ul>
<p class="small"><strong>Dynamically generated simulation feasible ?</strong></p>
<ul class="small last simple">
<li>current reconstruction -&gt; custom simulation</li>
<li>no more : limited MC stats in edge cases</li>
</ul>
</div>
<p class="small"><strong>Three revolutions reinforcing each other:</strong></p>
<ul class="small simple">
<li>games -&gt; graphics revolution -&gt; GPU -&gt; cheap TFLOPS</li>
<li>internet scale big datasets -&gt; ML revolution</li>
<li>computer vision revolution for autonomous vehicles</li>
</ul>
<p class="small"><span class="blue">Deep rivers of development, ripe for re-purposing</span></p>
<ul class="small simple">
<li>analogous problems -&gt; solutions</li>
<li><span class="red">experience across fields essential to find+act on analogies</span></li>
</ul>
<p class="small"><strong>Example : DL denoising for faster ray trace convergence</strong></p>
<ul class="small simple">
<li>analogous to hit aggregation</li>
<li>skip the hits, jump straight to DL smoothed probabilities<ul>
<li><span class="red">blurs the line between simulation and reconstruction</span></li>
</ul>
</li>
</ul>
<pre>
</pre><p class="small"><strong>Re-evaluate long held practices in light of new realities:</strong></p>
<ul class="small simple">
<li>large ROOT format (C++ object) MC samples repeatedly converted+uploaded to GPU for DL training ... OR:</li>
<li>small Genstep NumPy arrays uploaded, dynamically simulated into GPU hit arrays in fractions of a second</li>
</ul>
<!-- comment

**Transformative Performance : But how to transform ?**

* graphics : oldest user of GPUs -> rich palette of techniques
* vision spherical CNN -> potential for reconstruction -->

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="summary">
<h1><span class="small">Summary</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Highlights 2019</span></p>
<ul class="small last simple">
<li>Benefit from hardware accelerated ray tracing</li>
<li><strong>Opticks &gt; 1000x Geant4</strong> (one Turing GPU)</li>
</ul>
</div>
<img alt="/env/presentation/1px.png" src="/env/presentation/1px.png" style="width: 500px; height: 50px;" />
<!--  -->
<blockquote>
<p><em>Opticks</em> : state-of-the-art GPU ray tracing applied to optical photon simulation and
integrated with <em>Geant4</em>, giving a leap in performance that eliminates memory and time bottlenecks.</p>
<img alt="/env/presentation/1px.png" src="/env/presentation/1px.png" style="width: 1000px; height: 1px;" />
<ul class="simple">
<li>Drastic speedup -&gt; better detector understanding -&gt; greater precision<ul>
<li><strong>any simulation limited by optical photons can benefit</strong></li>
<li>more photon limited -&gt; more overall speedup (99% -&gt; 100x)</li>
</ul>
</li>
</ul>
<img alt="/env/presentation/1px.png" src="/env/presentation/1px.png" style="width: 1000px; height: 10px;" />
</blockquote>
<table border="1" class="docutils align-center">
<colgroup>
<col width="53%" />
<col width="47%" />
</colgroup>
<tbody valign="top">
<tr><td><a class="reference external" href="https://bitbucket.org/simoncblyth/opticks">https://bitbucket.org/simoncblyth/opticks</a></td>
<td>code repository</td>
</tr>
<tr><td><a class="reference external" href="https://simoncblyth.bitbucket.io">https://simoncblyth.bitbucket.io</a></td>
<td>presentations and videos</td>
</tr>
<tr><td><a class="reference external" href="https://groups.io/g/opticks">https://groups.io/g/opticks</a></td>
<td>forum/mailing list archive</td>
</tr>
<tr><td>email:opticks+subscribe&#64;groups.io</td>
<td>subscribe to mailing list</td>
</tr>
</tbody>
</table>
<!-- comment

*Opticks* uses hardware accelerated GPU ray tracing
via NVIDIA OptiX to give **effectively zero time and zero CPU memory**
optical photon simulation to *Geant4* applications. -->

        <!--  s5talk  -->
        <br/>
    <!-- comment


http://www.ihep.cas.cn/xwdt/xshd/201911/t20191126_5443006.html


NEXT


* Amdahls Law -->
</div>
<div class="slide" id="geocache-360">
<h1><span class="i">geocache_360</span></h1>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="id1">
<h1><span class="i">Outline of Mental Model</span></h1>
<pre>


</pre>

<div class="mytitle2">
<header>
<h1 style="background-color:lightgrey">
     <i>Opticks</i> : GPU Optical Simulation via NVIDIA OptiX <br/> <span style="color:red">+ A Mental Model for Effective Application of GPUs </span>
</h1>
</header>
</div><ul class="small simple">
<li>GPU Mental Model : Context and Constraints<ul>
<li>Understanding GPU Graphical Origins -&gt; Effective GPU Computation</li>
<li>GPU Demands Simplicity (Arrays) -&gt; Big Benefits : NumPy + CuPy</li>
</ul>
</li>
<li>Parallel Processing 0th Step<ul>
<li>Re-shape Data into &quot;Parallel&quot; Array Form</li>
</ul>
</li>
<li>High Level Tools<ul>
<li>Survey of High Level General Purpose CUDA Packages</li>
<li>NumPy + CuPy</li>
</ul>
</li>
<li>Example 1 : NumPy/CuPy Python interface<ul>
<li>Python vs NumPy vs CuPy : Python/NumPy ~ 10,  NumPy/CuPy ~ 1300</li>
</ul>
</li>
<li>Array Mechanics<ul>
<li>NP.hh header + union &quot;trick&quot;</li>
</ul>
</li>
<li>Example 2 : A Taste of Thrust C++<ul>
<li>Photon History Indexing with CUDA Thrust</li>
</ul>
</li>
<li>Summary</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- comment

qq -->
</div>
<div class="slide" id="amdahls-law-expected-speedup-limited-by-serial-processing">
<h1><span class="small">Amdahls &quot;Law&quot; : Expected Speedup Limited by Serial Processing</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">S(n) Expected Speedup</span></p>
<!-- comment

:width: 1176px
:height: 358px
:width: 588px
:height: 179px -->
<img alt="/env/presentation/parallel/amdahl.png" class="align-center" src="/env/presentation/parallel/amdahl.png" style="width: 392px; height: 112px;" />
<dl class="small last docutils">
<dt><em>P</em></dt>
<dd>parallelizable proportion</dd>
<dt><em>1-P</em></dt>
<dd>non-parallelizable portion</dd>
<dt><em>n</em></dt>
<dd>parallel speedup factor</dd>
</dl>
</div>
<p>optical photon simulation, P ~ 99% of CPU time</p>
<ul class="simple">
<li>-&gt; potential overall speedup S(n) is 100x</li>
<li>even with parallel speedup factor &gt;&gt; 1000x</li>
</ul>
<p><strong>Must consider processing &quot;big picture&quot;</strong></p>
<ul class="simple">
<li>remove bottlenecks one by one</li>
<li>re-evaluate &quot;big picture&quot; after each</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="understanding-gpu-graphical-origins-effective-gpu-computation">
<h1><span class="small">Understanding GPU Graphical Origins -&gt; Effective GPU Computation</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">OpenGL Rasterization Pipeline</span></p>
<img alt="/env/presentation/opengl/rasterization_pipeline_rhs.png" class="last align-right" src="/env/presentation/opengl/rasterization_pipeline_rhs.png" style="width: 450px;" />
</div>
<p class="small"><strong>GPUs evolved to rasterize 3D graphics at 30/60 fps</strong></p>
<ul class="small simple">
<li>30/60 &quot;launches&quot; per second, each handling millions of items</li>
<li><span class="red">literally billions of small &quot;shader&quot; programs run per second</span></li>
</ul>
<p class="small"><strong>Simple Array Data Structures (N-million,4)</strong></p>
<ul class="small simple">
<li>millions of vertices, millions of triangles</li>
<li>vertex: <strong>(x y z w)</strong></li>
<li>colors: <strong>(r g b a)</strong></li>
</ul>
<p class="small"><strong>Constant &quot;Uniform&quot; 4x4 matrices : scaling+rotation+translation</strong></p>
<ul class="small simple">
<li>4-component homogeneous coordinates -&gt; easy projection</li>
</ul>
<p class="small"><strong>Graphical Experience Informs Fast Computation on GPUs</strong></p>
<ul class="small simple">
<li>array shapes similar to graphics ones are faster<ul>
<li>&quot;float4&quot; 4*float(32bit) = 128 bit memory reads are favored</li>
<li>Opticks photons use &quot;float4x4&quot; just like 4x4 matrices</li>
</ul>
</li>
<li>GPU Launch frequency &lt; ~30/60 per second<ul>
<li>avoid copy+launch overheads becoming significant</li>
<li>ideally : handle millions of items in each launch</li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="cpu-optimizes-latency-gpu-optimizes-throughput">
<h1><span class="small">CPU Optimizes Latency, GPU Optimizes Throughput</span></h1>
<img alt="/env/presentation/nvidia/cpu_vs_gpu_architecture.png" class="small align-center" src="/env/presentation/nvidia/cpu_vs_gpu_architecture.png" style="width: 800px;" />
<p class="small">Waiting for memory read/write, is major source of latency...</p>
<dl class="small docutils">
<dt><strong>CPU : latency-oriented : Minimize time to complete single task</strong> <span class="classifier-delimiter">:</span> <span class="classifier"><span class="red">avoid latency with caching</span></span></dt>
<dd><ul class="first last simple">
<li>complex : caching system, branch prediction, speculative execution, ...</li>
</ul>
</dd>
<dt><strong>GPU : throughput-oriented : Maximize total work per unit time</strong> <span class="classifier-delimiter">:</span> <span class="classifier"><span class="red">hide latency with parallelism</span></span></dt>
<dd><ul class="first last simple">
<li>many simple processing cores, hardware multithreading, SIMD (single instruction multiple data)</li>
<li>simpler : <span class="green">lots of compute (ALU)</span>, at expense of cache+control</li>
<li>can tolerate latency, by <strong>assuming</strong> abundant other tasks to resume  : <strong>design assumes parallel workload</strong></li>
</ul>
</dd>
<dt><strong>Totally different processor architecture</strong> -&gt; <span class="red">Total reorganization of data and computation</span></dt>
<dd><ul class="first last simple">
<li>major speedups typically require total rethink of data structures and computation</li>
</ul>
</dd>
</dl>
<!-- comment

Understanding Throughput-oriented Architectures
https://cacm.acm.org/magazines/2010/11/100622-understanding-throughput-oriented-architectures/fulltext

Latency hiding works using hardware multi-threading, so when one group of threads is blocked
waiting to read from global memory for example : other groups of thread and be resumed. This
is only effective at hiding latency when there are enough other threads in flight at the same time.

Porting CPU code to run on the GPU : is not a straightforward thing to do, because the archirecture is totally
different.  To make effective use of GPUs requires a total reorganization of data and compute. -->

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="how-to-make-effective-use-of-gpus-parallel-simple-uncoupled">
<h1><span class="small">How to Make Effective Use of GPUs ? Parallel / Simple / Uncoupled</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Optical Photon Simulation</span></p>
<dl class="small docutils">
<dt>Abundant parallelism</dt>
<dd><ul class="first last simple">
<li>Many millions of photons</li>
</ul>
</dd>
<dt>Low register usage</dt>
<dd><ul class="first last simple">
<li>Simple optical physics, texture lookups</li>
</ul>
</dd>
<dt>Little/No synchronization</dt>
<dd><ul class="first last simple">
<li>Independent photons -&gt; None</li>
</ul>
</dd>
<dt>Minimize CPU&lt;-&gt;GPU copies</dt>
<dd><ul class="first last simple">
<li>geometry copied at initialization</li>
<li>gensteps copied once per event</li>
<li>only hits copied back</li>
</ul>
</dd>
</dl>
<p class="small last"><span class="blue">~perfect match for GPU acceleration</span></p>
</div>
<dl class="small docutils">
<dt><strong>Abundant parallelism</strong></dt>
<dd><ul class="first last simple">
<li>many thousands of tasks (ideally millions)</li>
</ul>
</dd>
<dt><strong>Low register usage : otherwise limits concurrent threads</strong></dt>
<dd><ul class="first last simple">
<li>simple kernels, avoid branching</li>
</ul>
</dd>
<dt><strong>Little/No Synchronization</strong></dt>
<dd><ul class="first last simple">
<li>avoid waiting, avoid complex code/debugging</li>
</ul>
</dd>
<dt><strong>Minimize CPU&lt;-&gt;GPU copies</strong></dt>
<dd><ul class="first last simple">
<li>reuse GPU buffers across multiple CUDA launches</li>
</ul>
</dd>
</dl>
<img alt="/env/presentation/1px.png" class="small" src="/env/presentation/1px.png" />
<p class="small"><strong>How Many Threads to Launch ?</strong></p>
<ul class="small simple">
<li>can (and should) launch many millions of threads<ul>
<li><span class="red">largest Opticks launch : 400M threads, at VRAM limit</span></li>
</ul>
</li>
<li>maximum thread launch size : so large its irrelevant</li>
<li>maximum threads inflight : #SM*2048 = 80*2048 ~ 160k<ul>
<li>best latency hiding when launch &gt; ~10x this ~ 1M</li>
</ul>
</li>
</ul>
<p class="tiny">Understanding Throughput-oriented Architectures
<a class="reference external" href="https://cacm.acm.org/magazines/2010/11/100622-understanding-throughput-oriented-architectures/fulltext">https://cacm.acm.org/magazines/2010/11/100622-understanding-throughput-oriented-architectures/fulltext</a></p>
<p class="tiny">NVIDIA Titan V: 80 SM, 5120 CUDA cores</p>
<!-- comment


So how does optical photon simulation stand on these criteria...

* parallelism and synchronization are perfect : with millions of independent photons
  to simulation

* low register usage : not so perfect, work required to fit into small stack size

  * eg GPU textures for property access : does wavelength interpolation in hardware,
    so avoids code and resource consumption -->

        <!--  s5talk  -->
        <br/>
    <!-- comment

https://streamhpc.com/blog/2017-01-24/many-threads-can-run-gpu/

https://devtalk.nvidia.com/default/topic/1028226/how-many-concurrent-threads-are-running-on-my-geforce-gtx-1080-ti-/

The maximum number of threads in flight is 2048 * #SM -->
</div>
<div class="slide" id="gpu-demands-simplicity-arrays-big-benefits-numpy-cupy">
<h1><span class="small">GPU Demands Simplicity (Arrays) -&gt; Big Benefits : NumPy + CuPy</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Array Serialization Benefits</span></p>
<p class="small"><strong>Persist everything to file -&gt; fast development cycle</strong></p>
<ul class="small simple">
<li>data portability into any environment</li>
<li>interactive debug/analysis : <em>NumPy,IPython</em></li>
<li>flexible testing</li>
</ul>
<p class="small"><strong>Can transport everything across network:</strong></p>
<ul class="small simple">
<li>production flexibility : distributed compute</li>
</ul>
<p class="small"><strong>Arrays for Everything -&gt; direct access debug</strong></p>
<ul class="small last simple">
<li>(num_photons,4,4) <em>float32</em></li>
<li>(num_photons,16,2,4) <em>int16</em> : step records</li>
<li>(num_photons,2) <em>uint64</em> : history flags</li>
<li>(num_gensteps,6,4) <em>float32</em></li>
<li>(num_csgnodes,4,4) <em>float32</em></li>
<li>(num_transforms,3,4,4) <em>float32</em></li>
<li>(num_planes,4) <em>float32</em></li>
<li>...</li>
</ul>
</div>
<dl class="small docutils">
<dt><strong>Separate address space -&gt; cudaMemcpy -&gt; Serialization</strong></dt>
<dd><em>upload/download</em> : host(CPU)&lt;-&gt;device(GPU)</dd>
</dl>
<ul class="small simple">
<li><span class="red">Serialize everything</span> -&gt; Arrays</li>
<li>Many small tasks -&gt; Arrays</li>
<li>Random Access/Order undefined -&gt; Arrays</li>
</ul>
<p class="small"><strong>Object-oriented : mixes data and compute</strong></p>
<ul class="small simple">
<li>complicated serialization</li>
<li>good for complex systems, up to ~1000 objects</li>
</ul>
<p class="small"><strong>Array-oriented : separate data from compute</strong></p>
<ul class="small simple">
<li><span class="red">inherent serialization + simplicity</span></li>
<li>good for millions of element systems</li>
</ul>
<p class="small"><strong>NumPy : standard array handling package</strong></p>
<ul class="small simple">
<li>simple .npy serialization</li>
<li>read/write <em>NumPy</em> arrays from C++ <a class="reference external" href="https://github.com/simoncblyth/np/blob/master/NP.hh">https://github.com/simoncblyth/np/blob/master/NP.hh</a></li>
</ul>
<p class="tiny"><a class="reference external" href="https://realpython.com/numpy-array-programming/">https://realpython.com/numpy-array-programming/</a></p>
<!-- comment

:small:`http://www.numpy.org/neps/nep-0001-npy-format.html`

GPU and CPU have separate address spaces, that means
everything copied between them needs serialization/deserialization

Adopting an array-oriented design for all data both
on CPU and GPU is a hugely simplifies work CPU+GPU work

NumPy is leading array-oriented package, but that is a python extension ...
YES : but the NumPy serialization format is very simple, so can easily
read/write NumPy arrays from C++

Benefits : random access to data from arrays -->

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="parallel-processing-0th-step-re-shape-data-into-parallel-array-form">
<h1><span class="small">Parallel Processing 0th Step : Re-shape Data into &quot;Parallel&quot; Array Form</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Look for &quot;long&quot; CPU loops</span></p>
<ul class="small last simple">
<li>loop -&gt; CUDA launch</li>
<li>For example : loops over photons, JUNO PMTs, time series</li>
</ul>
</div>
<p><span class="red">Q1 : What Shape is Your Data ?</span></p>
<ul class="small">
<li><p class="first">longest &quot;parallelization&quot; axis first, eg:</p>
<ul class="simple">
<li>photons <strong>(400M,4,4)</strong></li>
<li>PMT waveforms <strong>(20k,1000,4)</strong></li>
<li>SiPM time series <strong>(24*60*60,40,4)</strong></li>
</ul>
<p><span class="red">longer -&gt; more abundantly parallel -&gt; more speedup</span></p>
</li>
<li><p class="first">cross reference array elements with indices (not pointers)</p>
<ul class="simple">
<li>every photon element has corresponding genstep element</li>
<li>works across address spaces</li>
</ul>
</li>
</ul>
<p><span class="red">Q2 : What are Independent Chunks ?</span></p>
<p class="small">CUDA Thread for each element:</p>
<ul class="small simple">
<li>&quot;owns&quot; single array slot</li>
<li>runs in undefined order -&gt; no problem</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="survey-of-high-level-general-purpose-cuda-packages">
<h1><span class="small">Survey of High Level General Purpose CUDA Packages</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">CuPy : Simplest CUDA Interface</span></p>
<ul class="small simple">
<li><a class="reference external" href="https://cupy.chainer.org/">https://cupy.chainer.org/</a></li>
<li>NumPy API accelerated by CUDA stack</li>
<li>plus some of SciPy API</li>
</ul>
<div class="figure align-center">
<img alt="/env/presentation/cupy/cupy_logo_only.png" src="/env/presentation/cupy/cupy_logo_only.png" style="width: 300px;" />
</div>
<ul class="small simple">
<li>develop processing with NumPy on CPU<ul>
<li>switch <em>numpy-&gt;cupy</em> to test on GPU</li>
<li><span class="red">great for prototyping</span></li>
</ul>
</li>
</ul>
<p class="small"><strong>&quot;Production&quot; CuPy ? Depends on requirements:</strong></p>
<ul class="small last simple">
<li>integrations (eg Geant4, OpenGL, ...)</li>
<li>control + performance</li>
</ul>
</div>
<ul class="small simple">
<li>Learn CUDA basics (kernels, thread+memory hierarchy, ...)<ul>
<li><span class="red">BUT: base development on higher level libs -&gt; faster start</span></li>
</ul>
</li>
</ul>
<p class="small"><strong>C++ Based Interfaces to CUDA</strong></p>
<ul class="small simple">
<li>Thrust : <a class="reference external" href="https://developer.nvidia.com/Thrust">https://developer.nvidia.com/Thrust</a><ul>
<li>C++ interface to CUDA performance</li>
<li>high-level abstraction : reduce, scan, sort</li>
</ul>
</li>
<li>CUB : <a class="reference external" href="http://nvlabs.github.io/cub/">http://nvlabs.github.io/cub/</a><ul>
<li>CUDA C++ specific, GPU less hidden</li>
</ul>
</li>
<li>MGPU : <a class="reference external" href="https://github.com/moderngpu/moderngpu">https://github.com/moderngpu/moderngpu</a><ul>
<li>teaching tool : examples of CUDA algorithms</li>
</ul>
</li>
</ul>
<p class="small"><strong>Mature NVIDIA Basis Libraries</strong></p>
<ul class="small simple">
<li>cuRAND, cuFFT, cuBLAS, cuSOLVER, cuTENSOR, ...<ul>
<li><span class="blue">https://developer.nvidia.com/gpu-accelerated-libraries</span></li>
</ul>
</li>
</ul>
<p class="small"><strong>RAPIDS : New NVIDIA &quot;Suite&quot; of open source data science libs</strong></p>
<ul class="small simple">
<li>GPU-accelerated open source data science suite<ul>
<li>&quot;... end-to-end data science workflows...&quot;  <a class="reference external" href="http://rapids.ai/">http://rapids.ai/</a></li>
<li>cuDF : GPU dataframe library, Pandas-on-GPU</li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    <!-- comment

I highlight two: CuPy and Thrust

* Thrust is part of every CUDA installation just include headers into
  your C++ and compile with nvcc

  * avoids many of the hassles of using CUDA, including memory heirarchy,
    and deciding on block/grid sizes

Its not an either/or, you can easily combine ordinary low level CUDA with Thrust.

* Python interfaces to CUDA are a good way to prototype and get you started.
* Once you gain experience from these, you may find it easier to adopt
  other tools like Thrust for ease of integration


 After hearing about the performance that CuPy can give you with very little
 effort from the comfort of python :

 * You might wonder if you can avoid developing your C/C++/CMake and CUDA skills ?
   to benefit from GPU performance

 That depends on:

 * what your developments needs to integrate with ?
 * how much control/performance do you need ?
 * how expert do you want to become ?

 Opticks, needs to integrate with Geant4 libraries and detector simulation
 frameworks : so a standard approach of mostly C++ implemented libraries

 * ~20 C++ libs
 * CUDA/OptiX programs for geometry
 * python NumPy analysis/debugging code -->
<!-- comment

.. sidebar:: :small:`Development Always Iterative`

   .. class:: small

       **Prototyping Priority : Learn Domain + Tools**

       * **demonstrate array structure "works"**
       * fast development cycle

         * Python, NumPy, CuPy

       * jumpstart learning : try many tools

         * Thrust, ModernGPU

       **Production Priority : Fulfil Requiremnts**

       * ease of integration, maintainability (C/C++)
       * performance

         * CUDA kernels
         * CUB, https://nvlabs.github.io/cub/
         * :red:`optimize bottlenecks` -->
</div>
<div class="slide" id="numpy-foundation-of-python-data-ecosystem">
<h1><span class="small">NumPy : Foundation of Python Data Ecosystem</span></h1>
<p class="small"><a class="reference external" href="https://bitbucket.org/simoncblyth/intro_to_numpy">https://bitbucket.org/simoncblyth/intro_to_numpy</a></p>
<p class="small">Very terse, array-oriented (no-loop) python interface to C performance</p>
<img alt="/env/presentation/numpy_ecosystem.png" class="align-right" src="/env/presentation/numpy_ecosystem.png" style="width: 700px;" />
<ul class="small simple">
<li>C speed, python brevity + ease</li>
<li><strong>array-oriented</strong></li>
<li><strong>vectorized</strong> : no python loops</li>
<li>efficiently work with large arrays</li>
</ul>
<dl class="small docutils">
<dt>Recommended paper:</dt>
<dd><em>The NumPy array: a structure for efficient numerical computation</em>
<a class="reference external" href="https://hal.inria.fr/inria-00564007">https://hal.inria.fr/inria-00564007</a></dd>
</dl>
<div class="tiny"><span>&nbsp;</span></div><p class="tiny"><a class="reference external" href="https://docs.scipy.org/doc/numpy/user/quickstart.html">https://docs.scipy.org/doc/numpy/user/quickstart.html</a></p>
<p class="tiny"><a class="reference external" href="http://www.scipy-lectures.org/intro/index.html">http://www.scipy-lectures.org/intro/index.html</a></p>
<p class="tiny"><a class="reference external" href="https://github.com/donnemartin/data-science-ipython-notebooks">https://github.com/donnemartin/data-science-ipython-notebooks</a></p>

        <!--  s5talk  -->
        <br/>
    <!-- comment

Familiarity with NumPy fundmentals makes use of all these packages more straightforward.

http://luispedro.org/files/talks/2014/09-pyss/pyss14.html -->
</div>
<div class="slide" id="cupy-numpy-api-some-of-scipy-accelerated-by-nvidia-cuda-curand-cublas-cusolver-cusparse-thrust-nccl">
<h1><span class="small">CuPy : NumPy API (+ some of SciPy) accelerated by NVIDIA CUDA : cuRAND/cuBLAS/cuSOLVER/cuSPARSE/Thrust/NCCL</span></h1>
<pre>













</pre><ul class="small simple">
<li><em>CuPy</em> is GPU backend of <em>Chainer</em> : python deep learning framework developed by Preferred Networks (Japanese startup)</li>
<li><a class="reference external" href="https://cupy.chainer.org/">https://cupy.chainer.org/</a>   (<strong>pip install cupy-cuda101</strong> OR <strong>conda install cupy</strong>)</li>
<li><a class="reference external" href="https://github.com/cupy/cupy">https://github.com/cupy/cupy</a></li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="cupy-easy-interface-to-nvidia-cuda-stack">
<h1><span class="small">CuPy : Easy Interface to NVIDIA CUDA stack</span></h1>
<pre>














</pre><ul class="small simple">
<li>CuPy : potential for big speedups with little effort, if processing can adopt covered API:<ul>
<li><a class="reference external" href="https://docs-cupy.chainer.org/en/stable/reference/comparison.html">https://docs-cupy.chainer.org/en/stable/reference/comparison.html</a></li>
<li>easy introduction to CUDA libraries  <a class="reference external" href="https://docs.nvidia.com/cuda-libraries/index.html">https://docs.nvidia.com/cuda-libraries/index.html</a></li>
<li>source shows : CUB, cuTENSOR on the way, CuPy is based on Cython</li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="numpy-cupy-example-closest-approach-of-ellipse-to-a-point">
<h1><span class="small">NumPy + CuPy Example : closest approach of Ellipse to a Point</span></h1>
<pre class="mypretiny">
import numpy as np, <b><span class="alarm">cupy as cp</span></b>

def ellipse_closest_approach_to_point( <b><span class="alarm">xp</span></b>, ex, ez, _c, N ):
    """ex, ez: ellipse semi-axes, c: coordinates of point in ellipse frame"""
    c = xp.asarray( _c )  ; assert c.shape == (2,)

    t = xp.linspace( 0, 2*np.pi, N )     <b><span class="alarm"> # t: array of N angles [0,2pi] </span></b>
    e = xp.zeros( [len(t), 2] )
    e[:,0] = ex*xp.cos(t)
    e[:,1] = ez*xp.sin(t)                      <b><span class="alarm"> # e: N parametric [x,z] points on the ellipse </span></b>

    return  e[xp.sum((e-c)**2, axis=1).argmin()]   <b><span class="alarm"> # point on ellipse closest to c </span></b>
</pre><ul class="small simple">
<li>first argument <em>xp</em> is python module : <em>np</em> or <em>cp</em> : switching between NumPy and CuPy, CPU and GPU implementations</li>
<li>interactively debug numpy code in <em>ipython</em> : check array shapes at every stage</li>
</ul>
<table border="1" class="small docutils">
<colgroup>
<col width="33%" />
<col width="15%" />
<col width="52%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">expression</th>
<th class="head">shape</th>
<th class="head">note</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">e</tt></td>
<td><tt class="docutils literal">(10000000,2)</tt></td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">c</tt></td>
<td><tt class="docutils literal">(2,)</tt></td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">e-c</span></tt></td>
<td><tt class="docutils literal">(10000000,2)</tt></td>
<td><em>c</em> is <strong>broadcast</strong> over <em>e</em> : must be compatible shape</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">np.sum((e-c)**2,</span> 1)</tt></td>
<td><tt class="docutils literal">(10000000,)</tt></td>
<td><tt class="docutils literal">axis=1</tt> : summing over the axis of length 2</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">np.sum((e-c)**2,</span> 0)</tt></td>
<td><tt class="docutils literal">(2,)</tt></td>
<td><tt class="docutils literal">axis=0</tt> : summing over axis of length 10M</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">np.sum((e-c)**2,</span> None)</tt></td>
<td><tt class="docutils literal">()</tt></td>
<td><tt class="docutils literal">axis=None</tt> : summing over all elements, yielding scalar</td>
</tr>
</tbody>
</table>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="python-vs-numpy-vs-cupy">
<h1><span class="small">Python vs NumPy vs CuPy</span></h1>
<p class="small"><a class="reference external" href="https://bitbucket.org/simoncblyth/intro_to_numpy/src/default/python_vs_numpy_vs_cupy/ellipse_closest_approach_to_point.py">https://bitbucket.org/simoncblyth/intro_to_numpy/src/default/python_vs_numpy_vs_cupy/ellipse_closest_approach_to_point.py</a></p>
<pre class="mypretiny">

 17 import numpy as np, cupy as cp
 ...
 67 if __name__ == '__main__':
 68
 69     N = 10000000    <b> # 10M is large enough to make overheads negligible  </b>
 70     M = 8           <b> # repeat timings  </b>
 71
 72     ex,ey = 10,20     <b> # parameters of ellipse </b>
 73     c = [100,100]      <b> # point to check </b>
 74
 75     r = {}              <b> # python dict for results </b>
 76     t = np.zeros(M)     <b> # numpy array for timings  </b>
 77
 78     for i in range(M):
 79         if i == 0:
 80             r[i],t[i] = timed(pure_python_ellipse_closest_approach_to_point_DO_NOT_DO_THIS)(ex,ey,c,N)
 81         else:
 82             xp = np if i < M/2 else cp   # <b><span class="alarm">switch between NumPy and CuPy implementations of same API </span></b>
 83             r[i],t[i] = timed(ellipse_closest_approach_to_point)( xp, ex,ey,c, N )
 84         pass
 85     pass
 86     for k in r.keys():
 87         if k == M/2: print("")
 88         print(k, r[k], t[k])
 89     pass

</pre>
        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="python-vs-numpy-vs-cupy-python-numpy-10-numpy-cupy-1300-cuda-10-1-nvidia-titan-v">
<h1><span class="small">Python vs NumPy vs CuPy : Python/NumPy ~ 10,  NumPy/CuPy ~ 1300 (CUDA 10.1, NVIDIA TITAN V)</span></h1>
<pre class="mypretiny">
[blyth@localhost python_vs_numpy_vs_cupy]$ ipython -i ellipse_closest_approach_to_point.py
                    <b> # "ipython -i" : run python script leaving context for interactive examination </b>

Python 2.7.15 |Anaconda, Inc.| (default, May  1 2018, 23:32:55)
IPython 5.7.0 -- An enhanced Interactive Python.
...
(0, (4.983054096206095, 17.34003135802051), '6.266726970672607')
(1, array([ 4.9830541 , 17.34003136]), '0.674299955368042')
(2, array([ 4.9830541 , 17.34003136]), '0.6548769474029541')
(3, array([ 4.9830541 , 17.34003136]), '0.6450159549713135')

(4, array([ 4.9830541 , 17.34003136]), '0.4854261875152588')    <b> # 1st CuPy run CUDA compiles populating cache </b>
(5, array([ 4.9830541 , 17.34003136]), '0.000415802001953125')
(6, array([ 4.9830541 , 17.34003136]), '0.0003409385681152344')
(7, array([ 4.9830541 , 17.34003136]), '0.000762939453125')

In [1]: tpy = t[0]
In [2]: tnp = np.average(t[1:M/2])
In [3]: tcp = np.average(t[M/2+1:])

In [4]: tpy/tnp
Out[4]: 9.522970786915796     # <b> NumPy ~ 10x Python </b>

In [5]: tnp/tcp
Out[5]: 1299.0845622842799    # <b> CuPy > 1000x NumPy : with almost zero effort can apply the CUDA stack </b>
</pre><ul class="small simple">
<li><em>CuPy</em> looks great for prototyping</li>
<li>mirroring <em>NumPy</em> API is <strong>extremely convenient/flexible</strong> (unlike PyCUDA, Numba.cuda)</li>
<li><strong>develop with NumPy without GPU, occasionally checking identical code gets expected CuPy speedup</strong></li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="persist-numpy-arrays-to-npy-files-from-python-examine-file-format">
<h1><span class="small">Persist NumPy Arrays to .npy Files from Python, Examine File Format</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Load NumPy array into C/C++</span></p>
<p class="small"><strong>Straightforward to parse NPY files</strong></p>
<p class="small"><a class="reference external" href="http://github.com/simoncblyth/np/">http://github.com/simoncblyth/np/</a></p>
<p class="small"><strong>NP::Load</strong></p>
<ul class="small simple">
<li>parses file header, array shape + type</li>
<li>reads array data into std::vector</li>
</ul>
<div class="last"><hr/><pre class="mypretiny">
// gcc NPMinimal.cc -lstdc++ && ./a.out /tmp/a.npy
&#35;include "NP.hh"
int main(int argc, char** argv)
{
    assert( argc > 1 && argv[1] ) ;
    NP<long>* a = NP<long>::Load(argv[1]) ;
    a->dump();
    return 0 ;
}
</pre>
<hr/></div></div>
<p class="small">IPython persisting NumPy arrays:</p>
<pre class="mypretiny">
In [1]: a = np.arange(10)          <b> # array of 10 long (int64) </b>
In [2]: a
Out[2]: array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])

In [3]: np.save("/tmp/a.npy", a )  <b> # serialize array to file </b>

In [4]: a2 = np.load("/tmp/a.npy") <b> # load array into memory </b>
In [5]: assert np.all( a == a2 )   <b> # check all elements the same </b>
</pre><p class="small">IPython examine NPY file format:</p>
<pre class="mypretiny">
In [6]: !xxd /tmp/a.npy            <b> # xxd hexdump file contents </b>
                                   <b> # minimal header : type and shape </b>

<b><span class="alarm">00000000: 934e 554d 5059 0100 7600 7b27 6465 7363  .NUMPY..v.{'desc
00000010: 7227 3a20 273c 6938 272c 2027 666f 7274  r': '&lt;i8', 'fort
00000020: 7261 6e5f 6f72 6465 7227 3a20 4661 6c73  ran_order': Fals
00000030: 652c 2027 7368 6170 6527 3a20 2831 302c  e, 'shape': (10,
00000040: 292c 207d 2020 2020 2020 2020 2020 2020  ), }
00000050: 2020 2020 2020 2020 2020 2020 2020 2020
00000060: 2020 2020 2020 2020 2020 2020 2020 2020
00000070: 2020 2020 2020 2020 2020 2020 2020 200a                 .</span></b>
00000080: 0000 0000 0000 0000 0100 0000 0000 0000  ................
00000090: 0200 0000 0000 0000 0300 0000 0000 0000  ................
..
</pre>
        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="create-and-write-npy-array-from-c-c-with-np-hh-header-no-python">
<h1><span class="small">Create and Write .npy Array from C/C++ with NP.hh header (No Python)</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Create 3D NumPy Array from C/C++</span></p>
<pre class="mypretiny">// gcc NPMiniMake.cc -lstdc++ && ./a.out 3 2 4
&#35;include "NP.hh"
int main(int argc, char** argv)
{
    int ni = argc > 1 ? atoi(argv[1]) : 10  ;
    int nj = argc > 2 ? atoi(argv[2]) : 1   ;
    int nk = argc > 3 ? atoi(argv[3]) : 4   ;

    NP<float>* a = new NP<float>(ni,nj,nk) ;

    for(int i=0 ; i < ni ; i++ ){
    for(int j=0 ; j < nj ; j++ ){
    for(int k=0 ; k < nk ; k++ ){

        int index = i*nj*nk + j*nk + k ; // 3d -> 1d
        a->data[index] = float(index) ;  // dummy value
    }
    }
    }
    a->save("/tmp/a.npy") ;
    return 0 ;
}
</pre><p class="small last"><a class="reference external" href="http://github.com/simoncblyth/np/">http://github.com/simoncblyth/np/</a></p>
</div>
<ul class="small simple">
<li><strong>NP.hh</strong> :  <a class="reference external" href="https://github.com/simoncblyth/np/blob/master/NP.hh">https://github.com/simoncblyth/np/blob/master/NP.hh</a></li>
</ul>
<p class="small"><strong>Check C++ created NumPy array from commandline:</strong></p>
<pre class="mypretiny">
$ python -c "import numpy as np ; print(np.load('/tmp/a.npy'))"
[[[ 0.  1.  2.  3.]
  [ 4.  5.  6.  7.]]

 [[ 8.  9. 10. 11.]
  [12. 13. 14. 15.]]

 [[16. 17. 18. 19.]
  [20. 21. 22. 23.]]]
</pre><p class="small"><strong>Access/Create Array Data Anywhere</strong></p>
<ul class="small simple">
<li>Python : <em>np.load</em> <em>np.array</em> <em>np.save</em> ...</li>
<li>C/C++ : NP.hh <strong>NP struct</strong> methods</li>
<li>CUDA : <em>cudaMemcpy()</em> Arrays to/from GPU<ul>
<li>OR via CuPy <em>cp.load</em> <em>cp.save</em> <em>cp.array</em></li>
</ul>
</li>
</ul>
<p class="small">google:&quot;parse NumPy file with Java/Rust/R/Swift/Android/...&quot;</p>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="c-union-trick-mixed-type-arrays-simpler-faster-cuda-usage">
<h1><span class="small">C Union &quot;Trick&quot; Mixed Type Arrays -&gt; Simpler + Faster CUDA Usage</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Store int/uint bits into float array</span></p>
<pre class="mypretiny">&#35;include &lt;iostream&gt;
&#35;include &lt;cassert&gt;
&#35;include "uif.h"

int main(int argc, char** argv)
{
    int value = argc > 1 ? atoi(argv[1]) : -10 ;
    uif_t uif ;
    uif.i = value ;

    float a[3] = { 1.f, 1.f, 1.f } ;
    a[1] = uif.f ; <b><span class="alarm">// plant int bits into float array </span></b>

    uif_t uif2 ;
    uif2.f = a[1] ; <b><span class="alarm">// float copy </span></b>

    assert( uif2.i == value ) ; <b><span class="alarm">// recover int  </span></b>
    // std::cout << ... elided for brevity
    return 0 ;
}
<hr>$ gcc uifDemo.cc -lstdc++ && ./a.out -10
uif.u  4294967286 uif.i  -10 uif.f  nan
uif2.u 4294967286 uif2.i -10 uif2.f nan
</pre><ul class="small last simple">
<li><em>Opticks</em> photon arrays : mostly float + int flags</li>
</ul>
</div>
<p class="small"><span class="blue">http://bitbucket.org/simoncblyth/intro_to_numpy/src/tip/union_trick/</span></p>
<pre class="mypretiny"><hr>//uif.h
&#35;pragma once
union uif_t {  <b><span class="alarm">// store three 32-bit types at same location </span></b>
    unsigned u;
    int i ;
    float f;
} ;

<hr>In [1]: import numpy as np
In [2]: a = np.ones(3, dtype=np.float32)

In [3]: a.view(np.int32)[1] = -10   # int32 inside float32 array
 <b><span class="alarm">// NumPy view reinterprets same bits as different type </span></b>

In [4]: a
Out[4]: array([ 1., nan,  1.], dtype=float32)

In [5]: a.view(np.int32)
Out[5]: array([1065353216,        -10, 1065353216], dtype=int32)<hr></pre><p class="small">CUDA <strong>reinterpret</strong> device functions, also <strong>__int_as_float</strong>:</p>

        <!--  s5talk  -->
        <br/>
    <!-- comment

:small:`CUDA Complications`
- - - - - - - - - - - - - - - - - - - - - - - - - - - - -

.. class:: small

    **Kernel Launch**

    **Thread Hierarchy**

    num_threads_per_block (up to 1024)
         all threads in block share resources of one processor core

    num_blocks (effectively no limit, VRAM will limit you first)

    **Memory Hierarchy**

    1. local registers of thread (fastest, very limited)
    2. memory shared with block of threads (small, needs syncronization)
    3. constant memory
    4. global memory (slowest, largest)

    **Coalesced Reading**

    * threads of a

    * Structure-of-Arrays (SoA) usually faster than Array-of-Structs (AoS)

    **SIMT: Single Instruction, Multiple Thread**

    * warps (groups of 32 parallel threads) run in SIMT
    * common instructions issued to arbitrary data -->
</div>
<div class="slide" id="example-2-opengl-interactive-photon-history-selection">
<h1><span class="small">Example 2 : OpenGL Interactive Photon History Selection</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">OpenGL Geometry Shaders</span></p>
<ul class="small simple">
<li>typically : vertices -&gt; primitives</li>
<li>can also emit nothing : unlike other shaders</li>
<li>use this flexibility for history selection</li>
</ul>
<p class="small">-&gt; <strong>need &quot;popularity&quot; index for each photon</strong></p>
<p class="small"><strong>Photon History Sequence (64-bit int)</strong></p>
<ul class="small last simple">
<li>eg: 0x7cc6d &quot;TO SC BT BT SD&quot;</li>
</ul>
</div>
<p class="small">Photon record renderer, OpenGL geometry shader extracts:</p>
<pre class="mypretiny">

 01 &#35;version 410 core
 ..
 37 uniform ivec4 RecSelect ;  // <b><span class="alarm"> constant input to the "launch" </span></b>
 ..
 44 in ivec4 sel[];            // <b><span class="alarm"> input array </span></b>
 ..
 46
 47 layout (lines) in;
 48 layout (points, max_vertices = 1) out;
 ..
 52 void main ()
 53 {
 54     uint seqhis = sel[0].x ;
 55     uint seqmat = sel[0].y ;
 56     if( RecSelect.x > 0 && RecSelect.x != seqhis )  return ;
 57     if( RecSelect.y > 0 && RecSelect.y != seqmat )  return ;
 ..     //<b><span class="alarm"> History and Material Selection </span></b>
 63     vec4 p0 = gl_in[0].gl_Position  ;
 64     vec4 p1 = gl_in[1].gl_Position  ;
 65     float tc = Param.w / TimeDomain.y ;
 66     //<b><span class="alarm"> for interpolation of photon position at uniform input time  </span></b>

 ..
</pre><ul class="small simple">
<li><a class="reference external" href="https://bitbucket.org/simoncblyth/opticks/src/default/oglrap/gl/rec/geom.glsl">https://bitbucket.org/simoncblyth/opticks/src/default/oglrap/gl/rec/geom.glsl</a></li>
</ul>
<!-- comment -->

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="example-2-photon-history-indexing-with-cuda-thrust">
<h1><span class="small">Example 2 : Photon History Indexing with CUDA Thrust</span></h1>
<p class="small"><span class="blue">https://bitbucket.org/simoncblyth/opticks/src/default/thrustrap/TSparse_.cu</span></p>
<pre class="mypretiny">
089 template &lt;typename T&gt;
 90 void TSparse&lt;T&gt;::count_unique()
 91 {
 ///     preparation of src with strided range iterator elided for bevity
 97
 98     thrust::device_vector&lt;T&gt; data(src.begin(), src.end());  // GPU copy to avoid sorting original
 99
100     <b><span class="alarm">thrust::sort</span></b>(data.begin(), data.end());  // GPU sort of millions of integers
101
102     // inner_product of sorted data with shifted by one self finds "edges" between values
103     m_num_unique = <b><span class="alarm">thrust::inner_product</span></b>(
104                                   data.begin(),data.end() - 1,   // first1, last1
105                                              data.begin() + 1,   // first2
106                                                        int(1),   // output type init
107                                           thrust::plus<int>(),   // reduction operator
108                                     thrust::not_equal_to<T>()    // pair-by-pair operator, returning 1 at edges
109                                       );
116     m_values.resize(m_num_unique);
117     m_counts.resize(m_num_unique);
118
119     // find all unique key values with their counts
120     <b><span class="alarm">thrust::reduce_by_key</span></b>(
121                                 data.begin(),    // keys_first
122                                   data.end(),    // keys_last
123            thrust::constant_iterator<int>(1),    // values_first
124                             m_values.begin(),    // keys_output
125                             m_counts.begin()     // values_output
126                          );
///     sort into descending key order elided for brevity
147 }
</pre><p class="small"><span class="red">Using Thrust will improve your C++ skills</span></p>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="applying-cuda-thrust-translate-task-into-processing-primitives">
<h1><span class="small">Applying CUDA Thrust -&gt; Translate Task into Processing &quot;Primitives&quot;</span></h1>
<div class="sidebar">
<p class="first sidebar-title"><span class="small">Flavor of Thrust &quot;Primitives&quot;</span></p>
<pre class="mypretiny">
adjacent_difference
copy_if
exclusive_scan
exclusive_scan_by_key
for_each
gather
generate
inclusive_scan
inner_product
max_element
merge_by_key
min_element
minmax_element
reduce
reduce_by_key
scatter
sort
tabulate
transform
transform_inclusive_scan
transform_reduce
unique_by_key
</pre><ul class="small last simple">
<li><a class="reference external" href="https://thrust.github.io/doc/index.html">https://thrust.github.io/doc/index.html</a></li>
</ul>
</div>
<p class="small"><strong>Benefit from highly optimized GPU implementations</strong></p>
<ul class="small simple">
<li>number of unique values<ul>
<li>-&gt; <strong>thrust::inner_product</strong> with sorted self shifted by one</li>
</ul>
</li>
<li>find all unique keys with their counts<ul>
<li>-&gt; <strong>thrust::reduce_by_key</strong></li>
</ul>
</li>
<li>sorted counts for each value<ul>
<li>-&gt; <strong>thrust::sort_by_key</strong></li>
</ul>
</li>
</ul>
<p class="small"><strong>Thrust Hides GPU Details</strong></p>
<ul class="small simple">
<li>helpful when starting, can reach thru to lower level</li>
<li>easy interoperation with<ul>
<li>CUDA, OpenGL, NVIDIA OptiX</li>
</ul>
</li>
</ul>
<p class="small"><strong>Thrust : High level C++ interface to CUDA</strong></p>
<div class="small figure align-left">
<img alt="/env/presentation/nvidia/thrust_logo.png" src="/env/presentation/nvidia/thrust_logo.png" style="width: 350px;" />
</div>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="thrust-inner-product">
<h1><span class="small">thrust::inner_product</span></h1>
<!-- comment

:width: 1992px
:height: 1002px -->
<img alt="/env/presentation/thrust/inner_product.png" class="align-center" src="/env/presentation/thrust/inner_product.png" style="width: 996px; height: 501px;" />
<p class="small">An example of Thrust documentation</p>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="thrust-reduce-by-key">
<h1><span class="small">thrust::reduce_by_key</span></h1>
<!-- comment

:width: 2074px
:height: 824px -->
<img alt="/env/presentation/thrust/reduce_by_key.png" class="align-center" src="/env/presentation/thrust/reduce_by_key.png" style="width: 1037px; height: 412px;" />
<p class="small"><span class="red">Best way to learn Thrust API is exercise it by writing small tests</span></p>
<ul class="small simple">
<li><a class="reference external" href="https://bitbucket.org/simoncblyth/opticks/src/default/thrustrap/tests/">https://bitbucket.org/simoncblyth/opticks/src/default/thrustrap/tests/</a></li>
<li>Thrust implemented with template metaprogramming<ul>
<li>-&gt; quite slow compilation</li>
<li>thousands of lines of compilation errors when mis-using API</li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="summary-of-a-mental-model-for-effective-gpu-usage">
<h1><span class="small">Summary of a Mental Model for Effective GPU Usage</span></h1>
<ul class="simple">
<li>GPU Constraints -&gt; Simplicity -&gt; Arrays -&gt; Advantages<ul>
<li>Remember graphical origins</li>
<li>Easy Serialization : access data anywhere</li>
<li>Standard Tools :  NumPy, CuPy</li>
</ul>
</li>
<li>Parallel Processing 0th Step : Re-shape Data into &quot;Parallel&quot; Array Form<ul>
<li>most important thing for effective GPU usage :<ul>
<li><span class="red">shape of your data</span></li>
</ul>
</li>
</ul>
</li>
<li>High Level Tools<ul>
<li><span class="red">CuPy + NumPy are the best way to prototype GPU processing</span></li>
</ul>
</li>
<li>Array Mechanics<ul>
<li>array simplicity makes them easy to handle<ul>
<li>once you know a few tricks</li>
</ul>
</li>
</ul>
</li>
<li>When Python not appropriate:<ul>
<li>try first CUDA Thrust</li>
</ul>
</li>
</ul>

        <!--  s5talk  -->
        <br/>
    </div>
<div class="slide" id="geocache-360-2">
<h1><span class="i">geocache_360 2</span></h1>

        <!--  s5talk  -->
        <br/>
    <!-- comment

:i:`Full Outline of Mental Model`
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

.. raw:: html

    <pre>


    </pre>

    <div class="mytitle2">
    <header>
    <h1 style="background-color:lightgrey">
         <i>Opticks</i> : GPU Optical Simulation via NVIDIA OptiX <br/> <span style="color:red">+ A Mental Model for Effective Application of GPUs </span>
    </h1>
    </header>
    </div>


.. class:: tiny

    * GPU Mental Model : Context and Constraints

      * Amdahls Law
      * Understanding GPU Graphical Origins -> Effective GPU Computation
      * CPU Optimizes Latency, GPU Optimizes Throughput
      * How to Make Effective Use of GPUs ? Parallel / Simple / Uncoupled
      * GPU Demands Simplicity (Arrays) -> Big Benefits : NumPy + CuPy

    * Parallel Processing 0th Step : Re-shape Data into "Parallel" Array Form

    * High Level Tools

      * Survey of High Level General Purpose CUDA Packages
      * NumPy : Foundation of Python Data Ecosystem
      * CuPy : NumPy API (+ some of SciPy) accelerated by NVIDIA CUDA : cuRAND/cuBLAS/cuSOLVER/cuSPARSE/Thrust/NCCL
      * CuPy : Easy Interface to NVIDIA CUDA stack

    * Example 1 : NumPy/CuPy Python interface

      * NumPy + CuPy Example : closest approach of Ellipse to a Point
      * Python vs NumPy vs CuPy
      * Python vs NumPy vs CuPy : Python/NumPy ~ 10,  NumPy/CuPy ~ 1300

    * Array Mechanics

      * Persist NumPy Arrays to .npy Files from Python, Examine File Format
      * Create and Write .npy Array from C/C++ with NP.hh header (No Python)
      * C Union "Trick" Mixed Type Arrays -> Simpler + Faster CUDA Usage

    * Example 2 : A Taste of Thrust C++

      * OpenGL Interactive Photon History Selection
      * Photon History Indexing with CUDA Thrust
      * Applying CUDA Thrust -> Translate Task into Processing "Primitives"

    * Summary



.. s5_talk::

    As this is too small to read, its consigned to offline consumption. -->
</div>
</div>
</body>
</html>
