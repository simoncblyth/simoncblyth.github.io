<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>GPU Accelerated Geant4 Simulation with G4DAE and Chroma</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="visible" />
<!-- style sheet links -->
<script src="ui/my-small-white/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/my-small-white/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/my-small-white/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/my-small-white/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/my-small-white/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>GPU Accelerated Geant4 Simulation with G4DAE and Chroma</h1>

</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">GPU Accelerated Geant4 Simulation with G4DAE and Chroma</h1>

<!-- comment

Title:

    GPU Acceleration of Geant4 Simulations of
    the Daya Bay Anti-Neutrino Detector

Abstract:

    Studies of the acceleration of Geant4 based Monte Carlo Simulations
    of the Daya Bay anti-neutrino detector using the Chroma GPU
    optical photon simulation package are presented.

    Original open source developments made to bring the
    Geant4 simulation context to the GPU are described.
    They include a Geant4 geometry exporter package (G4DAE)
    and a bridging package (G4DAEChroma) that integrates
    external optical photon propagation with standard
    Geant4 simulations. The G4DAE geometry exporter
    package is planned to be incorporated with the 2015
    release of the Geant4 simulation toolkit.

    The export of triangulated geometry data into XML files
    following the standard COLLADA 3D specification was
    found to allow both massively parallel CUDA based optical
    photon propagation and high performance OpenGL
    visualizations of geometry and event data.


12 Jan 2015, Monday 17:05 -->
<style type="text/css">
    span.alarm { color: red; }
    span.warn { color: orange; }
    span.ok { color: green; }
    span.i { display: none; }
</style><!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->

       <style type="text/css">

          div.slide { 
             background-clip: border-box;
             background-repeat: no-repeat;
             height: 100%;
          }
          div.slide#slide0{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#cerenkov-photons-simulation-top-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-115923.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#cerenkov-photons-simulation-side-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-115935.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#scintillation-photons-simulation-top-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-121444.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#scintillation-photons-simulation-side-view{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20141224-121435.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#standard-geant4-workflow{
             background-image: url(/env/keynotefigs/G4DAEChroma/G4DAEChroma.001.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#external-photon-simulation-workflow{
             background-image: url(/env/keynotefigs/G4DAEChroma/G4DAEChroma.002.png);
             background-size: auto auto;
             background-position: 0px 0px;
          } 

       </style>
    <!-- comment

Generated Scintillation Photons GPU cf Geant4
/env/g4dae/generated_scintillation_time_wavelength.png

G4/DetSim Generated Cerenkov Wavelength
/env/g4dae/g4_cerenkov_wavelength.png -->
<p class="small"><a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_accelerated_geant4_simulation.html">http://simoncblyth.bitbucket.org/env/presentation/gpu_accelerated_geant4_simulation.html</a>
<a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html">http://simoncblyth.bitbucket.org/env/presentation/g4dae_geometry_exporter.html</a>
<a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html">http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html</a></p>
<div class="sidebar">
<p class="first sidebar-title">Drastic 200x Potential Speedup</p>
<p class="last">Chroma project claims 200x speedup of optical
photon (OP) propagation compared to Geant4.
<strong>A goal worthwhile chasing</strong>.</p>
</div>
<ul class="small simple">
<li>Geometry Model Implications</li>
<li>Introducing Chroma</li>
<li>Geant4 &lt;-&gt; Chroma Integration</li>
<li>G4DAE Geometry Exporter</li>
<li>Validating GPU Geometry</li>
<li>G4DAEChroma bridge</li>
<li>Chroma Forked</li>
<li>Validating Chroma Generated Photons</li>
<li>Next Steps</li>
<li>Visualizations</li>
</ul>
<div class="small line-block">
<div class="line">Simon C Blyth, National Taiwan University</div>
<div class="line"><strong>January 2015</strong></div>
</div>
<!-- comment

Title
    00 : GPU Accelerated Geant4 Simulation with G4DAE and Chroma

Geometry Model Implications
    01 : implications of geometry model choice

Introducing Chroma
    02 : chroma : ultra-fast photon mc, developed by stan seibert, university of pennsylvania

Geant4 <-> Chroma Integration
    03 : standard geant4 workflow
    04 : geant4 <-> chroma integration
    05 : external photon simulation workflow

G4DAE Geometry Exporter
    06 : https://bitbucket.org/simoncblyth/g4dae
    07 : collada : standard for 3d digital asset exchange (dae)
    08 : liberated geometry allows ubiquitous high peformance visualization
    09 : g4daeview.py : fast opengl 3d viewer for g4dae files

Validating GPU Geometry
    10 : compare dae exports to gdml and vrml2(wrl)
    11 : chroma raycasting : exercises geometry intersection
    12 : chroma raycast with entire geometry in view

G4DAEChroma bridge
    13 : g4daechroma : bridging from geant4 to chroma
    14 : g4daechroma : for implementation details...

Chroma Forked
    15 : https://bitbucket.org/simoncblyth/chroma forked:

Validating Chroma Generated Photons
    16 : chroma generated scintillation photons cf geant4
    17 : chroma generated cerenkov photons cf geant4

Next steps

Visualizations
    17 : cerenkov photons simulation - side view
    18 : cerenkov photons simulation - top view
    19 : scintillation photons simulation - top view
    20 : scintillation photons simulation - side view

Extras

    21 : extra slides
    22 : g4 generated cerenkov wavelengths in material categories
    23 : refractive index interpolation explains jump at 200nm
    24 : comparison of generated scintillation photon distributions
    25 : comparison of generated cerenokov photon distributions
    13 : g4daeview.py : dayabay chroma photon propagation (1) -->

</div>
<div class="slide" id="implications-of-geometry-model-choice">
<h1><span class="small">Implications of Geometry Model Choice</span></h1>
<p><span class="red">Track &gt; Geometry intersection</span> typically limits
simulation performance. Geometry model determines
techniques (and hardware) available to accelerate intersection.</p>
<p><span class="green">Geant4</span> Geometry Model (<span class="blue">solid based</span>, <span class="red">locked in</span>)</p>
<blockquote>
<em>Tree of nested solids composed of materials,
each shape represented by different C++ class</em></blockquote>
<p><span class="green">Chroma</span> Geometry Model (<span class="blue">surface based</span>, <span class="red">extremely simple &gt; portable</span>)</p>
<blockquote>
<em>List of oriented triangles, each representing
boundary between inside and outside materials.</em></blockquote>
<p>3D industry focusses on surface models &gt;&gt; frameworks and GPU
hardware designed to work with surface based geometries.</p>
</div>
<div class="slide" id="chroma-ultra-fast-photon-mc-developed-by-stan-seibert-university-of-pennsylvania">
<h1><span class="small">Chroma : Ultra-fast Photon MC, Developed by Stan Seibert, University of Pennsylvania</span></h1>
<ul class="small simple">
<li><a class="reference external" href="http://chroma.bitbucket.org">http://chroma.bitbucket.org</a></li>
</ul>
<blockquote class="small">
Chroma tracks photons through a <span class="red">triangle-mesh detector geometry</span>,
simulating processes like diffuse and specular reflections,
refraction, Rayleigh scattering and absorption. Using triangle meshes
eliminate geometry code as <span class="red">just one code path</span>.</blockquote>
<div class="sidebar">
<p class="first sidebar-title">Original Motivation for G4DAE exporter</p>
<p class="last">Allow use of Chroma GPU accelerated optical photon propagation
with existing DayaBay Geant4 geometry.</p>
</div>
<p class="small">200x performance claim:</p>
<blockquote>
<em>With a CUDA GPU Chroma has propagated 2.5M photons per second
in a detector with 29k photomultiplier tubes. This is
200x faster than GEANT4.</em></blockquote>
<p class="small"><strong>BUT</strong> Chroma needs : <span class="red">triangles + inside/outside materials</span></p>
<p class="tiny"><a class="reference external" href="http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf">http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf</a></p>
<p class="tiny"><a class="reference external" href="https://bitbucket.org/chroma/chroma">https://bitbucket.org/chroma/chroma</a></p>
<p class="tiny"><a class="reference external" href="https://bitbucket.org/simoncblyth/chroma">https://bitbucket.org/simoncblyth/chroma</a>  (my fork)</p>
</div>
<div class="slide" id="standard-geant4-workflow">
<h1>Standard Geant4 Workflow</h1>
<p class="small"><span class="i">Some invisible vertical space</span></p>
<p class="large"><span class="i">.</span></p>
<blockquote class="large">
<p><span class="i">.</span></p>
<blockquote>
<p><span class="i">.</span></p>
<blockquote>
OP Generated in Cerenkov and Scintillation G4VProcess,
some reach PMTs and form hits.</blockquote>
</blockquote>
</blockquote>
<p class="tiny"><span class="i">.</span></p>
<blockquote class="tiny">
<p><span class="i">.</span></p>
<blockquote>
<p><span class="i">.</span></p>
<blockquote>
<p><span class="i">.</span></p>
<blockquote>
<p><span class="i">.</span></p>
<blockquote>
<pre class="literal-block">
// G4VProcess subclass
PostStepDoIt(const G4Track&amp;, const G4Step&amp;)
{
    // calculate NumPhotons
    aParticleChange.SetNumberOfSecondaries(NumPhotons);

    // generate and collect secondaries
    for (G4int i = 0; i &lt; NumPhotons; i++)
    {
        ...
        aParticleChange.AddSecondary(aSecondaryTrack);
    }
}

// G4VSensitiveDetector subclass
bool ProcessHits(G4Step* step, ...)
{
    // form hits from step information
}
</pre>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</div>
<div class="slide" id="geant4-chroma-integration">
<h1>Geant4 &lt;-&gt; Chroma Integration</h1>
<div class="sidebar">
<p class="first sidebar-title">Bridging to external OP simulation</p>
<p class="small last">Optical photons (modulo reemission) are the
leaves of the simulation tree, allowing external
simulation to be integrated rather simply.</p>
</div>
<p class="small">Recreate Geometry info on GPU (<span class="blue">G4DAE</span>)</p>
<ul class="small simple">
<li>export triangulated geometry as COLLADA/DAE files</li>
<li>export PMT identifiers associating sensors with volumes</li>
<li>import geometry and identity files into Chroma and upload to GPU</li>
</ul>
<p class="small"><span class="red">Runtime bridge</span> via message queue (<span class="blue">G4DAEChroma</span>)</p>
<ul class="small simple">
<li>collect generation step parameters and prevent
photon processing by not forming secondaries</li>
<li>send generation steps to Chroma and receive hits in reply</li>
<li>include hits into standard Geant4 hit collections,
subsequent simulation proceeds normally</li>
</ul>
<p class="small">GPU Optical Photon simulation (<span class="blue">Chroma</span>)</p>
<ul class="small simple">
<li>receive generation steps from message queue</li>
<li>copy generation steps to GPU and allocate GPU memory for photons</li>
<li>invoke generation and propagation CUDA kernel</li>
<li>copy propagated photons back to CPU</li>
<li>send reply with hits back to <span class="blue">G4DAEChroma</span></li>
</ul>
</div>
<div class="slide" id="external-photon-simulation-workflow">
<h1>External Photon Simulation Workflow</h1>
</div>
<div class="slide" id="https-bitbucket-org-simoncblyth-g4dae">
<h1><a class="reference external" href="https://bitbucket.org/simoncblyth/g4dae">https://bitbucket.org/simoncblyth/g4dae</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Inclusion into Geant4</p>
<p class="small last">Geometry exporter presented at
Sept 2014 Geant4 Collaboration Meeting.
Proposal to contribute was accepted, intended
to be included with 2015 Geant4 release.</p>
</div>
<p class="small">Exports <em>Geant4</em> Geometry into COLLADA/DAE standard 3D files,
based on <em>GDML writer</em> code, same <em>XercesC</em> dependency for XML handling. Export includes:</p>
<ul class="small simple">
<li>volume tree: solid/physical volume/logical volume heirarchy</li>
<li>geometry: vertices, triangles+quads   (triangulation from <em>G4Polyhedron</em>)</li>
<li>materials and surfaces with properties as function of wavelength
(using DAE <em>extra</em> XML elements)</li>
</ul>
<img alt="/env/geant4/geometry/collada/g4dae/g4dae_bitbucket.png" class="align-center" src="/env/geant4/geometry/collada/g4dae/g4dae_bitbucket.png" style="width: 700px;" />
</div>
<div class="slide" id="collada-standard-for-3d-digital-asset-exchange-dae">
<h1><span class="small">COLLADA : Standard for 3D Digital Asset Exchange (DAE)</span></h1>
<ul class="small simple">
<li><a class="reference external" href="https://www.khronos.org/collada/">https://www.khronos.org/collada/</a></li>
</ul>
<img alt="/env/graphics/collada/collada_khronos.png" class="align-center" src="/env/graphics/collada/collada_khronos.png" style="width: 900px;" />
</div>
<div class="slide" id="liberated-geometry-allows-ubiquitous-high-peformance-visualization">
<h1><span class="small">Liberated Geometry allows Ubiquitous High Peformance Visualization</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Geometry Set Free</p>
<p class="small last">Liberating geometry data from Geant4/ROOT
gives free choice of visualization packages.
Many commercial, open source apps/libs
provide high performance visualization of DAE files
using GPU efficient OpenGL techniques.
<span class="red">=&gt; Shockingly Smooth Visualization performance</span></p>
</div>
<p class="small">Commercial:</p>
<ul class="small simple">
<li><em>Finder/Quicklook/Preview/Xcode</em> (standard OSX 10.8+)<ul>
<li><span class="blue">Xcode : useful effect tweaking interface</span></li>
<li><span class="blue">Preview : set black background for visibility</span></li>
</ul>
</li>
<li><em>Sketchup 8</em> free (OSX) [also Windows]</li>
<li><em>ESKO Studio Viewer</em> free (iOS on iPad)</li>
</ul>
<p class="small">Open source:</p>
<ul class="small simple">
<li><em>Meshlab</em> (OSX/Linux), slow DAE loading, OK interface [also Windows]</li>
<li><em>Blender</em> (OSX), painful GUI  [also Windows/Linux]</li>
<li><em>g4daeview</em> (OSX/Linux), <span class="red">extremely useful for debugging</span></li>
</ul>
<p class="small">Frameworks:</p>
<ul class="small simple">
<li><em>pycollada</em>, Python COLLADA parsing/construction, <span class="red">lxml + numpy powered fast parsing</span></li>
<li><em>threejs</em>, Javascript COLLADA loading, renders HTML canvas with WebGL</li>
<li><em>SceneKit</em>, Objective C Framework used by OSX apps</li>
</ul>
<p class="small">Many more applications and frameworks listed <a class="reference external" href="http://en.wikipedia.org/wiki/COLLADA">http://en.wikipedia.org/wiki/COLLADA</a></p>
<p class="tiny"><a class="reference external" href="http://meshlab.sourceforge.net">http://meshlab.sourceforge.net</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/meshlab">https://bitbucket.org/simoncblyth/meshlab</a> (fork improves COLLADA loading speed)</p>
</div>
<div class="slide" id="g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files">
<h1><span class="small">g4daeview.py : Fast OpenGL 3D viewer for G4DAE files</span></h1>
<div class="sidebar">
<p class="first sidebar-title">PyOpenGL Based</p>
<p class="small last">Easy to extend due to fast python development, yet access to
highly efficient OpenGL techniques such as
VBOs, PBOs and GLSL shaders.</p>
</div>
<p class="small">G4DAE visualization <a class="footnote-reference" href="#g4daeview-usage" id="id1">[1]</a> implemented with PyCollada, <strong>PyOpenGL</strong> and Glumpy</p>
<ul class="small simple">
<li>very fast/responsive 3D OpenGL visualization <a class="footnote-reference" href="#vbo" id="id2">[2]</a></li>
<li>flexible tree/list based partial geometry loading</li>
<li>intuitive virtual trackball translate/rotate</li>
<li>parallel or perspective projections</li>
<li>interactive fov and near/far plane clipping</li>
<li>persistent viewpoint bookmarks</li>
<li>animation by interpolation between bookmarks or orbiting</li>
<li>numerical control via UDP remote messaging</li>
<li>live Geant4 connection, photon, genstep visualization, single stepping</li>
<li>easily extensible python implementation <a class="footnote-reference" href="#g4daeview-code" id="id3">[3]</a></li>
<li>photon picking interface, with property inspection</li>
</ul>
<p class="small">Also used for testing GPU photon propagation with Chroma project</p>
<ul class="small simple">
<li>interactive raycasting, including animated</li>
<li>propagation visualization, with time slider</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="g4daeview-usage" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="vbo" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Implemented with single OpenGL Vertex Buffer Object (VBO) for entire geometry</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="g4daeview-code" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="compare-dae-exports-to-gdml-and-vrml2-wrl">
<h1><span class="small">Compare DAE Exports to GDML and VRML2(WRL)</span></h1>
<p class="small">Export validation:</p>
<blockquote class="small">
<ul class="simple">
<li>Comparison of all vertices/faces reveals <span class="red">boolean solids are discrepant</span>.</li>
<li>Perfect <a class="footnote-reference" href="#perfect" id="id4">[4]</a> DAE WRL agreement achieved by <em>cheating</em> : <span class="blue">perform triangulation once and reuse</span>.</li>
<li>Boolean solid triangulation sensitivity must be kept in mind as a potential systematic
for computational uses</li>
<li><strong>DAE not much bigger than GDML</strong>, despite including all triangles/vertices <a class="footnote-reference" href="#not-repeating" id="id5">[5]</a></li>
</ul>
</blockquote>
<table border="1" class="small docutils">
<colgroup>
<col width="23%" />
<col width="20%" />
<col width="16%" />
<col width="21%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Qty</th>
<th class="head">DayaBay</th>
<th class="head">Lingao</th>
<th class="head">Far</th>
<th class="head">Juno x0.5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Volumes</td>
<td>12,229</td>
<td>12,229</td>
<td>18,903</td>
<td>25,000</td>
</tr>
<tr><td>Triangles</td>
<td>2,448,064</td>
<td>2,448,064</td>
<td>4,189,680</td>
<td>21,886,158</td>
</tr>
<tr><td>Vertices</td>
<td>1,245,996</td>
<td>1,245,996</td>
<td>2,128,208</td>
<td>10,993,079</td>
</tr>
<tr><td>DAE/GDML/WRL (MB)</td>
<td><strong>6.9</strong>/4.0/98</td>
<td><strong>6.9</strong>/4.0/96</td>
<td><strong>8.6</strong>/6.0/167</td>
<td><strong>6.1</strong>/-/-</td>
</tr>
</tbody>
</table>
<p class="tiny"><tt class="docutils literal">VGDX_20140414</tt> counts using <tt class="docutils literal">g4daeview.py <span class="pre">-g</span> 0: <span class="pre">--with-chroma</span></tt>, Juno geometry truncated</p>
<table class="tiny docutils footnote" frame="void" id="perfect" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Maximum DAE WRL offset &lt; 0.13 mm, after patching VRML2 export precision bug (fixed in current G4).
Details: <a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="not-repeating" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>Geometry is not repeated, instead the COLLADA format uses geometry instancing and a tree of transforms,
just like GDML</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="chroma-raycasting-exercises-geometry-intersection">
<h1><span class="small">Chroma Raycasting : exercises geometry intersection</span></h1>
<p class="small">Raycasting exercises slowest part of optical photon propagation: <span class="red">geometry intersection</span>.</p>
<img alt="/env/chroma/chroma_camera/chroma_raycast_illustration.png" class="align-center" src="/env/chroma/chroma_camera/chroma_raycast_illustration.png" style="width: 600px;" />
<ul class="small simple">
<li>Shoot rays thru every pixel out into geometry, 1 CUDA thread for each, typically &gt;1M rays</li>
<li>Find triangle intersections using BVH <a class="footnote-reference" href="#bvh" id="id6">[6]</a> acceleration structure</li>
<li>Determine color based on ray to triangle normal angle</li>
<li>Alpha blend nearest 10 surfaces, providing transparency effect</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="bvh" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>Boundary Volume Heirarchy, a tree of bounding boxes with triangles inside leaf nodes</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="chroma-raycast-with-entire-geometry-in-view">
<h1><span class="small">Chroma Raycast with entire geometry in view</span></h1>
<p class="small">Render Split into 3x3 CUDA kernel launches, 1 thread per pixel, ~1.8s for 1.23M pixels, 2.4M tris (with <a class="footnote-reference" href="#hw" id="id7">[7]</a>)</p>
<img alt="/env/chroma/chroma_camera/20140423-162109.png" class="align-center" src="/env/chroma/chroma_camera/20140423-162109.png" style="width: 800px;" />
<table class="tiny docutils footnote" frame="void" id="hw" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>MacBook Pro (2013), NVIDIA GeForce GT 750M 2048 MB ;
Workstation GPUs such as NVIDIA Kepler K20 expected at least ~5x faster</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daechroma-bridging-from-geant4-to-chroma">
<h1><span class="small">G4DAEChroma : Bridging from Geant4 to Chroma</span></h1>
<p class="small"><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/chroma/G4DAEChroma/G4DAEChroma/">https://bitbucket.org/simoncblyth/env/src/tip/chroma/G4DAEChroma/G4DAEChroma/</a></p>
<div class="sidebar">
<p class="first sidebar-title">Transport Infrastructure</p>
<p class="small last">Collects generation steps from Geant4, sends to Chroma, receives
hits in reply, integrates into G4 Hit Collections.
<span class="red">Implemented with core of ~20 C++ classes</span></p>
</div>
<ul class="small simple">
<li><span class="green">Two detector specific subclasses required eg</span> <em>DybG4DAECollector</em> <em>DybG4DAEGeometry</em></li>
<li>NumPy array creation from C++, transport via ZeroMQ</li>
<li>JSON metadata communication C++/Python, <em>map&lt;string,string&gt; &lt;-&gt; dict</em></li>
<li>Geant4 hit integration using additional <em>G4VSensitiveDetector</em>
that steals hit collection pointers from existing one</li>
<li>Transform Cache to obtain PMT local coordinates from global hit coordinates</li>
<li>SQLite DB integation for monitoring/control</li>
</ul>
<img alt="/env/chroma/G4DAEChroma/G4DAEChroma_bitbucket.png" class="align-center" src="/env/chroma/G4DAEChroma/G4DAEChroma_bitbucket.png" style="width: 700px;" />
</div>
<div class="slide" id="g4daechroma-for-implementation-details">
<h1><span class="small">G4DAEChroma : For implementation details...</span></h1>
<p class="small"><a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/chroma/G4DAEChroma/G4DAEChroma/G4DAEChroma_implementation/">http://simoncblyth.bitbucket.org/env/notes/chroma/G4DAEChroma/G4DAEChroma/G4DAEChroma_implementation/</a></p>
<img alt="/env/chroma/G4DAEChroma/G4DAEChroma_implementation.png" class="align-center" src="/env/chroma/G4DAEChroma/G4DAEChroma_implementation.png" style="width: 700px;" />
</div>
<div class="slide" id="https-bitbucket-org-simoncblyth-chroma-forked">
<h1><a class="reference external" href="https://bitbucket.org/simoncblyth/chroma">https://bitbucket.org/simoncblyth/chroma</a> <span class="small">Forked:</span></h1>
<p class="small">Changes in my fork of Chroma:</p>
<ul class="small simple">
<li>stability + efficiency improvements, enabling mobile development</li>
<li>OpenGL/CUDA interoperation, using VBOs</li>
<li>add recording of propagation steps into VBO datastructure</li>
<li>more efficient Raycasting using 4x4 matrix uniforms and PBOs</li>
<li>animated photon propagation visualization</li>
<li>change serialization approach from ROOT/TObject to NumPy (NPY)</li>
<li><span class="red">generation of Cerenkov and Scintillation Photons based
on Geant4 Generation Step inputs</span></li>
</ul>
<img alt="/env/chroma/chroma_fork_jan2015.png" class="align-center" src="/env/chroma/chroma_fork_jan2015.png" style="width: 700px;" />
</div>
<div class="slide" id="chroma-generated-scintillation-photons-cf-geant4">
<h1><span class="small">Chroma Generated Scintillation Photons cf Geant4</span></h1>
<p class="small">Chroma interpolates all properties in 20nm bins, stair artifacts
in wavelength distribution can be reduced by using eg 10nm property interpolation bins.</p>
<img alt="/env/g4dae/generated_scintillation_time_wavelength.png" class="align-center" src="/env/g4dae/generated_scintillation_time_wavelength.png" style="width: 800px;" />
</div>
<div class="slide" id="chroma-generated-cerenkov-photons-cf-geant4">
<h1><span class="small">Chroma Generated Cerenkov Photons cf Geant4</span></h1>
<p class="small">Geant4/DetSim wavelength distribution has a blip at 200nm, corresponding to edge of water
refractive index properties. (see the extra slides)</p>
<img alt="/env/g4dae/generated_cerenkov_time_wavelength.png" class="align-center" src="/env/g4dae/generated_cerenkov_time_wavelength.png" style="width: 800px;" />
</div>
<div class="slide" id="next-steps">
<h1>Next Steps</h1>
<p class="small">G4DAE Geometry Exporter</p>
<ul class="small simple">
<li>implement parametrized/replica geometry handling, following GDML</li>
<li>investigate issue inherited from GDML of a skipped
edge case (when a volume is shared between multiple volume pairs)
resulting in missing <em>G4LogicalBorderSurface</em></li>
<li>investigate improving default export appearance in common viewers</li>
<li>test with newer and latest versions of Geant4</li>
<li>test on more detector geometries</li>
<li>incorporate into Geant4 codebase</li>
</ul>
<p class="small">G4DAEChroma bridge</p>
<ul class="small simple">
<li>refactor to remove duplication in <em>G4DAEHit</em> <em>G4DAEHitList</em></li>
<li>eliminate use of <em>cnpy</em> external in favor of <em>numpy.hpp</em></li>
</ul>
<p class="small">Chroma</p>
<ul class="small simple">
<li>Port Cerenkov <em>ApplyWaterQE</em> to Chroma (expect quick)</li>
<li>Port <em>DsPmtSensDet::ProcessHits</em> QE gymnastics to Chroma</li>
<li>Implement double sided surfaces, to match <em>G4LogicalBorderSurface</em></li>
<li>Compare PMT Hit distributions between <em>NuWa/DetSimChroma</em> and <em>NuWa/DetSim</em><ul>
<li><span class="red">iterate until match achieved or discrepancies explained</span></li>
</ul>
</li>
<li>Find desktop GPU on which can test operation and performance</li>
</ul>
</div>
<div class="slide" id="cerenkov-photons-simulation-side-view">
<h1><span class="i">Cerenkov Photons Simulation - Side View</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Cerenkov Photons</p>
<p class="tiny last">Simulated Cerenkov shock front from an 100 GeV muon travelling
from right to left across Dayabay AD.
Primaries are simulated by Geant4, Cerenkov &quot;steps&quot; of the primaries
are transferred to the GPU where <strong>photons are generated, propagated and PMT hits formed</strong>.
Photon colors indicate reemission (green), absorption(red), specular reflection (magenta), scattering(blue), no history (white).</p>
</div>
</div>
<div class="slide" id="scintillation-photons-simulation-side-view">
<h1><span class="i">Scintillation Photons Simulation - Side View</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Scintillation Photons</p>
<p class="tiny last">Simulated Scintillation photons from an 100 GeV muon travelling
from right to left across Dayabay AD.
Primaries are simulated by Geant4, Scintillation &quot;steps&quot; of the primaries
are transferred to the GPU where <strong>photons are generated, propagated and PMT hits formed</strong>.
Photon colors indicate reemission (green), absorption(red), specular reflection (magenta), scattering(blue), no history (white).</p>
</div>
</div>
<div class="slide" id="cerenkov-photons-simulation-top-view">
<h1>Cerenkov Photons Simulation - Top View</h1>
</div>
<div class="slide" id="scintillation-photons-simulation-top-view">
<h1>Scintillation Photons Simulation - Top View</h1>
</div>
<div class="slide" id="extra-slides">
<h1>Extra Slides</h1>
</div>
<div class="slide" id="g4daeview-py-opengl-view-of-juno-geometry">
<h1><span class="small">g4daeview.py : OpenGL view of Juno Geometry</span></h1>
<p class="tiny">External view of Juno geometry with cutaway. The extreme size of the Juno geometry (50 million nodes in Chroma representation)
provides a challenge for development on mobile GPUs.
As my developments operate at the Geant4 level wherever possible it
was relatively straightforward to apply the machinery developed for
Dayabay to the Juno detector. In collaboration with
Juno simulation experts the geometry was exported from
Geant4 and GPU visualized in under a days work.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-194144.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-194144.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-chroma-raycast-of-juno-geometry">
<h1><span class="small">g4daeview.py : Chroma Raycast of Juno Geometry</span></h1>
<p class="tiny">External view of Juno geometry. The extreme size of the  Juno geometry (50 million nodes in Chroma representation)
provides a challenge for development on mobile GPUs. The black rectangle arises due to aborts to avoid GPU
crashes.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-191232.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-191232.png" style="height: 650px;" />
</div>
<div class="slide" id="g4-generated-cerenkov-wavelengths-in-material-categories">
<h1><span class="small">G4 Generated Cerenkov Wavelengths in material categories</span></h1>
<p class="small">Blip caused by 200nm edge in water refractive index</p>
<img alt="/env/g4dae/g4_cerenkov_wavelength.png" class="align-center" src="/env/g4dae/g4_cerenkov_wavelength.png" style="width: 700px;" />
</div>
<div class="slide" id="refractive-index-interpolation-explains-jump-at-200nm">
<h1><span class="small">Refractive Index Interpolation Explains Jump at 200nm</span></h1>
<p class="small">DeadWater, IwsWater, OwsWater have same RINDEX starting from 200nm.
Chroma interpolates properties onto a standard set of wavelengths,
getting rid of the jump.</p>
<img alt="/env/g4dae/plot_refractive_index_comparison.png" class="align-center" src="/env/g4dae/plot_refractive_index_comparison.png" style="width: 900px;" />
</div>
<div class="slide" id="comparison-of-generated-scintillation-photon-distributions">
<h1><span class="small">Comparison of Generated Scintillation Photon Distributions</span></h1>
<p class="small">Position, direction, polarization XYZ  + time, wavelength, weight</p>
<img alt="/env/g4dae/generated_scintillation_3xyzw.png" class="align-center" src="/env/g4dae/generated_scintillation_3xyzw.png" style="width: 700px;" />
</div>
<div class="slide" id="comparison-of-generated-cerenokov-photon-distributions">
<h1><span class="small">Comparison of Generated Cerenokov Photon Distributions</span></h1>
<p class="small">Position, direction, polarization XYZ  + time, wavelength, weight</p>
<img alt="/env/g4dae/generated_cerenkov_3xyzw.png" class="align-center" src="/env/g4dae/generated_cerenkov_3xyzw.png" style="width: 700px;" />
</div>
<div class="slide" id="g4daeview-py-dayabay-chroma-photon-propagation-1">
<h1><span class="small">g4daeview.py : Dayabay Chroma Photon Propagation (1)</span></h1>
<p class="tiny">Chroma GPU photon propagation at 12 nanoseconds.  The photons are generated by Geant4
simulation of a 100 GeV muon travelling from right to left.
Photon colors indicate reemission (green), absorption(red),
specular reflection (magenta), scattering(blue), no history (white).</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" style="height: 600px;" />
</div>
</div>
</body>
</html>
