<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>200x Faster Optical Photon Propagation with NuWa + Chroma ?</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="visible" />
<!-- style sheet links -->
<script src="ui/my-small-white/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/my-small-white/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/my-small-white/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/my-small-white/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/my-small-white/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>200x Faster Optical Photon Propagation with NuWa + Chroma ?</h1>

</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">200x Faster Optical Photon Propagation with NuWa + Chroma ?</h1>

<!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->

       <style type="text/css">

          div.slide { 
             background-clip: border-box;
             background-repeat: no-repeat;
             height: 100%;
          }
          div.slide#slide0{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#full-screen{
             background-image: url(images/chroma/chroma_dayabay_adlid.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#full-screen-2{
             background-image: url(images/chroma/chroma_dayabay_pool_pmts.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170713.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#g4dae-viewer-pool-bottom{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-170957.png);
             background-size: auto auto;
             background-position: 0px 0px;
          }
          div.slide#g4dae-viewer-pool-bottom-chroma-raycast{
             background-image: url(/env/geant4/geometry/collada/g4daeview/20140419-171014.png);
             background-size: auto auto;
             background-position: 0px 0px;
          } 

       </style>
    <p class="small"><a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html">http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.html</a>
<a class="reference external" href="http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.txt">http://simoncblyth.bitbucket.org/env/presentation/gpu_optical_photon_simulation.txt</a>
<a class="reference external" href="https://www.dropbox.com/s/3a6ty8frtmohm06/gpu_optical_photon_simulation.pdf?dl=0">https://www.dropbox.com/s/3a6ty8frtmohm06/gpu_optical_photon_simulation.pdf?dl=0</a>
<a class="reference external" href="https://www.dropbox.com/s/3a6ty8frtmohm06/gpu_optical_photon_simulation.pdf?dl=1">https://www.dropbox.com/s/3a6ty8frtmohm06/gpu_optical_photon_simulation.pdf?dl=1</a></p>
<div class="sidebar">
<p class="first sidebar-title">Objective</p>
<p class="last">Make GPU accelerated Optical Photon Propagation <strong>routine</strong></p>
</div>
<p>Introducing Chroma</p>
<ul class="simple">
<li><a class="reference external" href="http://chroma.bitbucket.org">http://chroma.bitbucket.org</a></li>
</ul>
<p>Fivefold path:</p>
<ol class="arabic simple">
<li><span class="green">Export G4 Geometry as DAE</span></li>
<li><span class="green">Convert DAE to Chroma</span></li>
<li><span class="green">Chroma Validation, raycasting</span></li>
<li><span class="blue">G4/Chroma Integration</span></li>
<li><span class="red">Chroma vs G4 Validation</span></li>
</ol>

</div>
<div class="slide" id="chroma-ultra-fast-photon-mc">
<h1>Chroma : Ultra-fast Photon MC</h1>
<p><strong>Developed by Stan Seibert, University of Pennsylvania.</strong></p>
<p>Chroma tracks photons through a <span class="red">triangle-mesh detector geometry</span>,
simulating processes like diffuse and specular reflections,
refraction, Rayleigh scattering and absorption. Using triangle meshes
eliminate geometry code as <span class="red">just one code path</span>.</p>
<p>200x performance claim:</p>
<blockquote>
<em>With a CUDA GPU Chroma has propagated 2.5M photons per second
in a detector with 29k photomultiplier tubes. This is
200x faster than GEANT4.</em></blockquote>
<p><strong>BUT:</strong> Chroma needs : <span class="red">triangles + inside/outside materials</span></p>
<p class="small"><a class="reference external" href="http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf">http://on-demand.gputechconf.com/gtc/2013/presentations/S3304-Particle-Physics-With-PyCUDA.pdf</a></p>
</div>
<div class="slide" id="https-bitbucket-org-simoncblyth-g4dae-exporter">
<h1><a class="reference external" href="https://bitbucket.org/simoncblyth/g4dae">https://bitbucket.org/simoncblyth/g4dae</a> <span class="small">Exporter</span></h1>
<p class="small">Export any Geant4 Geometry into COLLADA/DAE standard 3D files, including:</p>
<ul class="small simple">
<li>volume tree: physical volume/logical volume heirarchy</li>
<li>geometry: vertices, triangles+quads</li>
<li>materials and surfaces with properties as function of wavelength</li>
</ul>
<img alt="images/bitbucket-g4dae.png" class="align-center" src="images/bitbucket-g4dae.png" style="width: 700px;" />
</div>
<div class="slide" id="g4dae-dayabay-nuwa-integration">
<h1><span class="small">G4DAE : DayaBay/NuWa integration</span></h1>
<p><span class="small">G4DAE capable NuWa</span>: <tt class="docutils literal">./dybinst <span class="pre">-X</span> geant4_with_dae trunk all</tt></p>
<p class="small">Greenfield dybinstallation required</p>
<ul class="small simple">
<li>builds Geant4 with G4DAE exporter and other necessary patches</li>
<li>Details on patching <a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/nuwa/">http://simoncblyth.bitbucket.org/env/notes/geant4/nuwa/</a></li>
</ul>
<p class="tiny">NuWa LCG_builder grabs g4dae from bitbucket see
NuWa-trunk/lcgcmt/LCG_Builders/geant4/scripts/geant4_config.sh</p>
</div>
<div class="slide" id="g4dae-export-compared-to-vrml2-wrl">
<h1><span class="small">G4DAE : Export Compared to VRML2(WRL)</span></h1>
<ul class="small simple">
<li>Comparison of all vertices/faces reveals <span class="red">boolean solids are discrepant</span>.</li>
<li>Perfect <a class="footnote-reference" href="#perfect" id="id1">[1]</a> agreement only achieved by <em>cheating</em> : <span class="blue">perform triangulation once and reuse</span>.</li>
</ul>
<table border="1" class="small docutils">
<colgroup>
<col width="26%" />
<col width="18%" />
<col width="14%" />
<col width="19%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Qty</th>
<th class="head">DayaBay</th>
<th class="head">Lingao</th>
<th class="head">Far</th>
<th class="head">Juno x0.5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Volumes</td>
<td>12,229</td>
<td>12,229</td>
<td>18,903</td>
<td>25,000</td>
</tr>
<tr><td>Triangles</td>
<td>2,448,064</td>
<td>2,448,064</td>
<td>4,189,680</td>
<td>21,886,158</td>
</tr>
<tr><td>Vertices</td>
<td>1,245,996</td>
<td>1,245,996</td>
<td>2,128,208</td>
<td>10,993,079</td>
</tr>
<tr><td>DAE/GDML/WRL (MB)</td>
<td>6.9/4.0/98</td>
<td>6.9/4.0/96</td>
<td>8.6/6.0/167</td>
<td>6.1M/-/-</td>
</tr>
</tbody>
</table>
<p class="tiny"><tt class="docutils literal">VGDX_20140414</tt> counts using <tt class="docutils literal">g4daeview.py <span class="pre">-g</span> 0: <span class="pre">--with-chroma</span></tt>, Juno geometry truncated</p>
<ul class="small simple">
<li>Triangulation sensitivity impact <span class="red">needs checking</span></li>
<li>DAE not much bigger than GDML, but includes all triangles/vertices</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="perfect" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Maximum DAE WRL offset &lt; 0.13 mm, after patching VRML2 export precision bug.
Details: <a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/dae_cf_wrl/</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4dae-triangular-advantage">
<h1><span class="small">G4DAE : Triangular Advantage</span></h1>
<p class="small">Surface representation simplicity (vertices+triangles) and COLLADA standard
file format means many tools/libraries available, allowing high level development.
Basis libraries used for developments:</p>
<ul class="small">
<li><p class="first"><tt class="docutils literal">daenode.py</tt> : G4DAE =&gt; Chroma geometry</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="https://github.com/pycollada/pycollada">https://github.com/pycollada/pycollada</a>  numpy based DAE parsing</li>
<li><a class="reference external" href="http://www.numpy.org">http://www.numpy.org</a></li>
</ul>
</blockquote>
</li>
<li><p class="first"><tt class="docutils literal">daeserver.py</tt> : 3D WebGL interface to G4DAE geometry</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mrdoob/three.js/">https://github.com/mrdoob/three.js/</a>  Javascript 3D</li>
</ul>
</blockquote>
</li>
<li><p class="first"><tt class="docutils literal">g4daeview.py</tt> : Fast OpenGL 3D viewer/navigator</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="http://pyopengl.sourceforge.net">http://pyopengl.sourceforge.net</a>   OpenGL from python</li>
<li><a class="reference external" href="https://code.google.com/p/glumpy/">https://code.google.com/p/glumpy/</a>  pyopengl+numpy integration</li>
</ul>
</blockquote>
</li>
</ul>
<p class="small"><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/daenode.py">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/daenode.py</a>
<a class="reference external" href="http://belle7.nuu.edu.tw/dae/tree/3148.html">http://belle7.nuu.edu.tw/dae/tree/3148.html</a></p>
</div>
<div class="slide" id="https-bitbucket-org-simoncblyth-chroma-forked">
<h1><a class="reference external" href="https://bitbucket.org/simoncblyth/chroma">https://bitbucket.org/simoncblyth/chroma</a> <span class="small">Forked:</span></h1>
<ul class="small simple">
<li>Stability + efficiency improvements, enabling mobile development <a class="footnote-reference" href="#hw" id="id2">[2]</a></li>
<li>Add recording of propagation steps into VBO <a class="footnote-reference" href="#vbo" id="id3">[9]</a> datastructure</li>
<li>Animated visualization</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="hw" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>MacBook Pro (2013), NVIDIA GeForce GT 750M 2048 MB ;
Workstation GPUs such as NVIDIA Kepler K20 expected at least ~3x faster</td></tr>
</tbody>
</table>
<img alt="/env/chroma/chroma_fork.png" class="align-center" src="/env/chroma/chroma_fork.png" style="width: 700px;" />
</div>
<div class="slide" id="chroma-raycasting-exercises-geometry-intersection">
<h1><span class="small">Chroma Raycasting : exercises geometry intersection</span></h1>
<p class="small">Raycasting exercises slowest part of optical photon propagation: <span class="red">geometry intersection</span>.</p>
<img alt="/env/chroma/chroma_camera/chroma_raycast_illustration.png" class="align-center" src="/env/chroma/chroma_camera/chroma_raycast_illustration.png" style="width: 600px;" />
<ul class="small simple">
<li>Shoot rays thru every pixel out into geometry, 1 CUDA thread for each, typically &gt;1M rays</li>
<li>Find triangle intersections using BVH <a class="footnote-reference" href="#bvh" id="id4">[3]</a> acceleration structure</li>
<li>Determine color based on ray to triangle normal angle</li>
<li>Alpha blend nearest 10 surfaces, providing transparency effect</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="bvh" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Boundary Volume Heirarchy, a tree of bounding boxes with triangles inside leaf nodes</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="chroma-stability-efficiency-improvements-made">
<h1><span class="small">Chroma Stability/Efficiency Improvements Made</span></h1>
<p class="small"><span class="green">Split work into multiple CUDA kernel launch, arranged in 2D pattern</span> <a class="footnote-reference" href="#cuda2d" id="id5">[4]</a></p>
<ul class="small simple">
<li>avoids kernel launch times exceeding 5 seconds</li>
<li>2D equalizes thread workload across CUDA warp(32 threads)</li>
</ul>
<p class="small"><span class="green">Reduced CPU load by reducing transfers</span></p>
<ul class="small simple">
<li>create pixels on GPU, share between OpenGL and CUDA/Chroma <a class="footnote-reference" href="#pbo" id="id6">[5]</a></li>
<li>compute photon directions via 4x4 uniform matrix rather than passing arrays</li>
<li>change matrix to navigate, rather than array manipulating kernel launches</li>
</ul>
<p class="small">These improvements were necessary as <em>Chroma Camera</em> <a class="footnote-reference" href="#presume" id="id7">[6]</a> with Dayabay geometry had</p>
<ul class="small simple">
<li>very heavy CPU load <a class="footnote-reference" href="#burn" id="id8">[7]</a> and unusably laggy GUI</li>
<li>frequent GPU panic, GUI freeze, hard system crash forcing reboot</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="cuda2d" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/cuda/cuda_launch.py">https://bitbucket.org/simoncblyth/env/src/tip/cuda/cuda_launch.py</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="pbo" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td>Using OpenGL pixel buffer objects (PBO) and CUDA-OpenGL interoperability techniques,
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/pycuda/pycuda_pyopengl_interop/pixel_buffer.py">https://bitbucket.org/simoncblyth/env/src/tip/pycuda/pycuda_pyopengl_interop/pixel_buffer.py</a>
<a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/chroma/chroma_camera/pbo_renderer.py">https://bitbucket.org/simoncblyth/env/src/tip/chroma/chroma_camera/pbo_renderer.py</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="presume" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[6]</a></td><td>Presumably Chroma was developed using fast Linux desktop GPUs where the kernel time limit can be avoided.</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="burn" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[7]</a></td><td><span class="red">burning CPU errors</span> in system log</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="chroma-raycast-worst-case-entire-geometry-example">
<h1><span class="small">Chroma Raycast Worst Case (~entire geometry) Example</span></h1>
<p class="small">Render Split into 3x3 CUDA kernel launches, 1 thread per pixel, ~1.8s for 1.23M pixels, 2.4M tris.</p>
<img alt="/env/chroma/chroma_camera/20140423-162109.png" class="align-center" src="/env/chroma/chroma_camera/20140423-162109.png" style="width: 800px;" />
<p class="tiny">g4daeview.py --target=.. --eye=&quot;-0.3,-1.1,1.7&quot; --look=&quot;0.1,0.4,-0.6&quot; --up=&quot;1.2,2.0,1.6&quot; --size=1440,852 --near=30.00000 --far=10000.0 --yfov=50.0 --with-chroma</p>
<!-- wrk (1440, 852) [1226880]  lch  [3, 3, 1] [9]  blk [16, 16, 1] [256]  0.03,0.26,0.12,0.15,0.79,0.20,0.06,0.20,0.04 TOT 1.84 -->
<!-- http://dayabay.phys.ntu.edu.tw/env/geant4/geometry/export/DayaBay_VGDX_20140414-1300/ -->
</div>
<div class="slide" id="chroma-raycast-triangle-count-dyb-with-rpc">
<h1><span class="small">Chroma Raycast Triangle count (Dyb with RPC)</span></h1>
<p class="tiny">g4daeview.py --with-chroma --metric tri --flags 1,0    # tri/time/intersect</p>
<img alt="/env/chroma/chroma_camera/pmt-tri-count-hotspots.png" class="align-center" src="/env/chroma/chroma_camera/pmt-tri-count-hotspots.png" style="height: 500px;" />
<p><span class="small">All triangle intersections made, even when no visible contribution to render. (Potential for optimisation?)</span></p>
</div>
<div class="slide" id="g4daeview-py-fast-opengl-3d-viewer-for-g4dae-files">
<h1><span class="small">g4daeview.py : Fast OpenGL 3D viewer for G4DAE files</span></h1>
<p class="small">G4DAE visualization <a class="footnote-reference" href="#g4daeview-usage" id="id9">[8]</a> and &quot;backbone&quot; application for Chroma testing.</p>
<ul class="small simple">
<li>very fast/responsive 3D OpenGL visualization <a class="footnote-reference" href="#vbo" id="id10">[9]</a></li>
<li>flexible tree/list based partial geometry loading</li>
<li>intuitive virtual trackball translate/rotate</li>
<li>parallel or perspective projections</li>
<li>interactive fov and near/far plane clipping</li>
<li>persistent viewpoint bookmarks</li>
<li>animation by interpolation between bookmarks or orbiting</li>
<li>numerical control via UDP remote messaging</li>
<li>Chroma interactive raycasting, including animated</li>
<li>live Geant4 connection, photon visualization, single stepping</li>
<li>easily extensible python implementation <a class="footnote-reference" href="#g4daeview-code" id="id11">[10]</a></li>
<li>Chroma propagation visualization, with time slider</li>
<li>photon picking interface, with property inspection</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="g4daeview-usage" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[8]</a></td><td><a class="reference external" href="http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/">http://simoncblyth.bitbucket.org/env/notes/geant4/geometry/collada/g4daeview/g4daeview_usage/</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="vbo" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[9]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id10">2</a>)</em> Implemented with single OpenGL Vertex Buffer Object (VBO) for entire geometry</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="g4daeview-code" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[10]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="g4daeview-py-dayabay-chroma-photon-propagation">
<h1><span class="small">g4daeview.py : Dayabay Chroma Photon Propagation</span></h1>
<p class="tiny">Chroma GPU photon propagation at 12 nanoseconds.  The photons are generated by Geant4
simulation of a 100 GeV muon travelling from right to left.
Photon colors indicate reemission (green), absorption(red),
specular reflection (magenta), scattering(blue), no history (white).</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-161445.png" style="height: 600px;" />
</div>
<div class="slide" id="id12">
<h1><span class="small">g4daeview.py : Dayabay Chroma Photon Propagation</span></h1>
<p class="tiny">Chroma GPU photon propagation at 14 nanoseconds.
The interface provides interactive control of the propagation time
allowing any stage of the propagation to be viewed by
scrubbing time backwards/forwards. The speed of this visualization
is achieved by interoperation of CUDA kernels and OpenGL shaders accessing
the same GPU resident photon propagation data.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-163403.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-163403.png" style="height: 600px;" />
</div>
<div class="slide" id="g4daeview-py-photon-selection-interface">
<h1><span class="small">g4daeview.py : Photon Selection Interface</span></h1>
<p class="tiny">Propagation steps OR photons can be selected by materials, propagation history, or special selection by photon identifier.
Photons can be selected by clicking their 3D representations allowing inspection of the
propagation history of individual photons.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/grab_glut_menu.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/grab_glut_menu.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-propagation-step-selection-interface">
<h1><span class="small">g4daeview.py : Propagation Step Selection Interface</span></h1>
<p class="tiny">Photon propagation steps with material pair GdDopedLS,Acrylic. The larger
squares represent selected photons, providing access to numerical details of propagation history.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-183318.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-183318.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-individual-photon-selection">
<h1><span class="small">g4daeview.py : Individual Photon Selection</span></h1>
<p class="tiny">Propagation steps of a single photon, the steps at either sides of the inner
and outer acrylic vessels are visible. The line color represents the photon
history starting white and turning magenta following a specular reflection.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-184148.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-184148.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-initial-photon-positions">
<h1><span class="small">g4daeview.py : Initial Photon Positions</span></h1>
<p class="tiny">Initial photon positions of a Geant4 simulated muon that crosses
between the Dayabay Near hall ADs. Colors represent photon wavelengths.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140518-174941.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140518-174941.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-opengl-view-of-juno-geometry">
<h1><span class="small">g4daeview.py : OpenGL view of Juno Geometry</span></h1>
<p class="tiny">External view of Juno geometry with cutaway. The extreme size of the Juno geometry (50 million nodes in Chroma representation)
provides a challenge for development on mobile GPUs.
As my developments operate at the Geant4 level wherever possible it
was relatively straightforward to apply the machinery developed for
Dayabay to the Juno detector. In collaboration with
Juno simulation experts the geometry was exported from
Geant4 and GPU visualized in under a days work.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-194144.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-194144.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-chroma-raycast-of-juno-geometry">
<h1><span class="small">g4daeview.py : Chroma Raycast of Juno Geometry</span></h1>
<p class="tiny">External view of Juno geometry. The extreme size of the  Juno geometry (50 million nodes in Chroma representation)
provides a challenge for development on mobile GPUs. The black rectangle arises due to aborts to avoid GPU
crashes.</p>
<img alt="/env/geant4/geometry/collada/g4daeview/20140716-191232.png" class="align-center" src="/env/geant4/geometry/collada/g4daeview/20140716-191232.png" style="height: 650px;" />
</div>
<div class="slide" id="g4daeview-py-video-tour">
<h1><span class="small">g4daeview.py : Video Tour</span></h1>

        <div style="text-align: center;" >
        <video id="s5video_1" src="https://www.dropbox.com/s/6jmcqxphnc8qhkg/g4daeview_001.m4v?dl=1" controls height="480" width="60%" poster="/env/geant4/geometry/collada/g4daeview/20140419-170713.png" >
            <p> Your Browser does not support HTML5 Video </p>
        </video>
        </div>
    </div>
<div class="slide" id="runtime-geant4-chroma-integration-with-zmqroot">
<h1><span class="small">Runtime Geant4/Chroma integration with ZMQRoot</span></h1>
<p class="small"><tt class="docutils literal">ZMQRoot</tt> <a class="footnote-reference" href="#zmqroot" id="id13">[11]</a> sends/receives <tt class="docutils literal">ChromaPhotonList</tt>, 3 node <a class="footnote-reference" href="#topology" id="id14">[12]</a></p>
<dl class="small docutils">
<dt><strong>client</strong></dt>
<dd><tt class="docutils literal">nuwa.py/Geant4</tt> <a class="footnote-reference" href="#client" id="id15">[13]</a> live collect/send/receive photons</dd>
<dt><strong>broker</strong></dt>
<dd><tt class="docutils literal">czmq_broker.sh</tt> <a class="footnote-reference" href="#broker" id="id16">[14]</a> routes requests, returns replies</dd>
<dt><strong>worker</strong></dt>
<dd><tt class="docutils literal">g4daeview.py/Chroma</tt> <a class="footnote-reference" href="#worker" id="id17">[15]</a> photon visualization/Chroma stepping</dd>
</dl>
<table class="tiny docutils footnote" frame="void" id="zmqroot" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id13">[11]</a></td><td>ROOT+ZeroMQ messaging <a class="reference external" href="http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Utilities/ZMQRoot">http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Utilities/ZMQRoot</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="topology" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id14">[12]</a></td><td>Workaround for a network blockage, server/client or threaded also possible</td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="client" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[13]</a></td><td><a class="reference external" href="http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Simulation/DetSimChroma/src/DsChromaStackAction.cc">http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Simulation/DetSimChroma/src/DsChromaStackAction.cc</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="broker" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[14]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/zeromq/czmq/czmq_broker.c">https://bitbucket.org/simoncblyth/env/src/tip/zeromq/czmq/czmq_broker.c</a></td></tr>
</tbody>
</table>
<table class="tiny docutils footnote" frame="void" id="worker" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id17">[15]</a></td><td><a class="reference external" href="https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/daeresponder.py">https://bitbucket.org/simoncblyth/env/src/tip/geant4/geometry/collada/g4daeview/daeresponder.py</a></td></tr>
</tbody>
</table>
</div>
<div class="slide" id="status-issues-for-steps-1-2-3">
<h1><span class="small">Status/Issues for Steps 1,2,3</span></h1>
<p class="small"><span class="green">Export G4 Geometry as DAE</span></p>
<ul class="small simple">
<li>boolean solid triangulation sensitivity <span class="blue">a future systematic</span></li>
<li>pointer addresses used in identifiers <span class="red">attempt to eliminate</span></li>
</ul>
<p class="small"><span class="green">DAE to Chroma</span></p>
<ul class="small simple">
<li>material/surface properties, <span class="red">mapping choices validation</span>,</li>
<li>Geant4/Chroma model mismatch causes all 8 bordersurfaces including ESR mirrors to be omitted
<span class="red">add double sided surfaces to Chroma model</span> <a class="footnote-reference" href="#g4logicalbordersurface" id="id18">[16]</a></li>
<li><span class="red">remove GPU geometry duplication</span> between OpenGL and Chroma, mandatory
for Juno (less so for Dayabay)</li>
</ul>
<p class="small"><span class="green">Chroma Validation</span></p>
<ul class="small simple">
<li>raycasting: <span class="green">stability issue resolved</span> using OpenGL/CUDA interop</li>
<li><span class="green">propagation visualization</span> provides qualitative confidence</li>
<li>also the visualization provides a working environment within which the details
of matching Geant4/Chroma models can be done</li>
</ul>
<table class="tiny docutils footnote" frame="void" id="g4logicalbordersurface" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id18">[16]</a></td><td>G4LogicalBorderSurface class comprises an <strong>ordered pair of volume references</strong> and surface properties</td></tr>
</tbody>
</table>
</div>
<div class="slide" id="status-issues-for-step-4-g4-chroma-runtime-integration">
<h1><span class="small">Status/Issues for Step 4 : G4/Chroma Runtime Integration</span></h1>
<p class="small"><span class="blue">Geant4 -&gt; Chroma</span> in development, 1/1000 photon scaledown</p>
<ul class="small simple">
<li>messaging <span class="blue">operational</span></li>
<li><span class="red">add compression</span></li>
<li><span class="red">push to full photon operation</span></li>
</ul>
<p class="small"><span class="red">Chroma -&gt; Geant4</span></p>
<ul class="small simple">
<li>photon information returned from Chroma to Geant4 is <span class="blue">technically operational</span></li>
<li>various techniques of merging detected
photon info back into Geant4/NuWa <span class="red">need to be investigated</span>.</li>
</ul>
</div>
<div class="slide" id="g4dae-dayabay-near-site">
<h1>G4DAE Dayabay Near Site</h1>
<img alt="images/osx_preview/osx_preview_g4dae_dayabay.png" class="align-center" src="images/osx_preview/osx_preview_g4dae_dayabay.png" style="height: 700px;" />
<p class="small">OSX Preview.app render</p>
</div>
<div class="slide" id="g4dae-dayabay-ad">
<h1>G4DAE Dayabay AD</h1>
<img alt="images/osx_preview/osx_preview_g4dae_dayabay_ad.png" class="align-center" src="images/osx_preview/osx_preview_g4dae_dayabay_ad.png" style="width: 800px;" />
<p class="small">OSX Preview.app render</p>
</div>
<div class="slide" id="chroma-ray-tracing-dayabay-geometry-1">
<h1>Chroma Ray Tracing Dayabay Geometry (1)</h1>
<img alt="images/chroma/chroma_dayabay_pmt_peek.png" class="align-center" src="images/chroma/chroma_dayabay_pmt_peek.png" style="width: 800px;" />
</div>
<div class="slide" id="chroma-ray-tracing-dayabay-geometry-2">
<h1>Chroma Ray Tracing Dayabay Geometry (2)</h1>
<img alt="images/chroma/chroma_dayabay_wall_pmts.png" class="align-center" src="images/chroma/chroma_dayabay_wall_pmts.png" style="width: 800px;" />
</div>
<div class="slide" id="chroma-ray-tracing-dayabay-geometry-3">
<h1>Chroma Ray Tracing Dayabay Geometry (3)</h1>
<img alt="images/chroma/chroma_dayabay_pool_pmts.png" class="align-center" src="images/chroma/chroma_dayabay_pool_pmts.png" style="width: 800px;" />
</div>
<div class="slide" id="chroma-ray-tracing-dayabay-geometry-4">
<h1>Chroma Ray Tracing Dayabay Geometry (4)</h1>
<img alt="images/chroma/chroma_dayabay_adlid.png" class="align-center" src="images/chroma/chroma_dayabay_adlid.png" style="width: 800px;" />
</div>
<div class="slide" id="g4dae-viewer-pool-bottom">
<h1><tt class="docutils literal">G4DAE viewer : Pool Bottom</tt></h1>
</div>
<div class="slide" id="g4dae-viewer-pool-bottom-chroma-raycast">
<h1><tt class="docutils literal">G4DAE viewer : Pool Bottom, Chroma Raycast</tt></h1>
</div>
<div class="slide" id="chroma-hardware-requirements">
<h1><span class="small">Chroma : Hardware requirements</span></h1>
<div class="sidebar">
<p class="first sidebar-title">Suitable GPUs only ~250-350 USD</p>
<p class="last">eg NVIDIA GeForce GTX 680 (1536 CUDA cores, 2048 MB, Compute Capability 3.0) ~ 330 USD</p>
</div>
<ul class="small simple">
<li>NVIDIA GPU with CUDA Compute Capability (CCC) 2.0 at least</li>
<li>1.5G of GPU memory (estimated minimum for Dayabay geometry)</li>
</ul>
</div>
</div>
</body>
</html>
