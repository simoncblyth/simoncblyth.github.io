<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>NAN Abort Photon &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../numpy/">numpy</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/g4daeview/g4daeview_nan_abort_photon.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="nan-abort-photon">
<h1>NAN Abort Photon<a class="headerlink" href="#nan-abort-photon" title="Permalink to this headline">Â¶</a></h1>
<ul class="simple">
<li>Resolved by special casing perfect normal incidence</li>
</ul>
<p>Initially was numbering as index 279, but that is with time ordering sort on load,
which with all mock photons starting at 1ns means randomly ordered.
Actially is mock photon index 513 when lpos is (0,0,1500) ie shoot from 1.5m infront of PMT:</p>
<div class="highlight-python"><pre>index 511 pos (-19104.3,-796636,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051910
index 512 pos (-17737.6,-801707,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051911

index 513 pos (-16650.4,-803385,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051912

index 514 pos (-15302.4,-802513,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051913
index 515 pos (-16389.6,-800835,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051914
index 516 pos (-16520,-802110,-9297.4) dir (-0,0,-1) pol (0,0,1) _t 1 _wavelength 550 _pmtid 0x1051915</pre>
</div>
<p>The PMT 0x1051912 is in water shield on mid-line between ADs and underneath. The
Looks like photon getting stuck on AD table ?</p>
<div class="highlight-python"><pre>delta:~ blyth$ udp.py --target 0x1051912
sending [--target 0x1051912] to host:port delta.local:15006</pre>
</div>
<div class="highlight-python"><pre>In [8]: np.where(a.history &amp; 1&lt;&lt;31)
Out[8]: (array([513]),)

In [9]: a.dump(513)
[[ -16650.424 -803385.25    -9610.          2.404]
 [        nan         nan         nan     550.   ]
 [      0.          0.          1.          1.   ]
 [      0.          0.         -0.          0.   ]]
photonid:  513
history:  2147483713
pmtid:  0</pre>
</div>
<div class="highlight-python"><pre>g4daeview.sh --debugkernel --debugphoton 279  ## wrong one
udp.py --debugphoton 513  # nope not handled


g4daeview.sh --debugkernel --debugphoton 513   ## restart with correct one

mocknuwa-- MOCK                                ## sling the MOCK photons at it</pre>
</div>
<div class="highlight-python"><pre>2014-11-26 17:13:11,863 INFO    env.geant4.geometry.collada.g4daeview.daephotonspropagator:149 nwork 684 step 0 max_steps 30 nsteps 30
2014-11-26 17:13:11,863 INFO    env.geant4.geometry.collada.g4daeview.daephotonspropagator:157 prepared_call first_photon 0 photons_this_round 684 nsteps 30
2014-11-26 17:13:11,863 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:262 _get_rng_states
2014-11-26 17:13:11,863 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:226 setup_rng_states using seed 0
[  1]    513 material_code 421004288 inner 25 outer 24 si 4 ri1 1.346476 ri2 1.000000 abs 15077.077148 sca 1000000.000000 rem 0.000000 ncdf 38 w0 60.000000 st 20.000000 cdf lo/up 0.000000 0.000000
FILL_STATE       START    [   513] slot  1 steps  1 lht 1799018 tpos    1.000  -16650.42 -803385.25   -9297.40    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
TO_BOUNDARY      PASS     [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
AT_SURFACE       CONTINUE [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir      nan      nan      nan pol    0.000    0.000    1.000 REFLECT_SPECULAR
2014-11-26 17:13:12,577 INFO    env.geant4.geometry.collada.g4daeview.daephotonspropagator:185 launch sequence times [0.28745388793945315]</pre>
</div>
<div class="highlight-python"><pre>630        if (s.surface_index != -1)
631        {
632            // **propagate_at_surface**  for default surface model
633            //
634            // #. SURFACE_ABSORB(BREAK)
635            // #. SURFACE_DETECT(BREAK)
636            // #. REFLECT_DIFFUSE(CONTINUE) .direction .polarization
637            // #. REFLECT_SPECULAR(CONTINUE) .direction
638            // #. NO other option, so never PASS?
639            //
640            command = propagate_at_surface(p, s, rng, g, use_weights);
641            status = STATUS_AT_SURFACE ;
642
643            PDUMP( p, photon_id, status, steps, command, -1);
644
645            if (command == BREAK) break ;
646            if (command == CONTINUE) continue;
647
648            status = STATUS_AT_SURFACE_UNEXPECTED ;
649            PDUMP_ALL( p, photon_id, status, steps, command, -1);
650        }</pre>
</div>
<p>Problem is the AD table is horizontal and photon direction vertically down
so arrives at normal incidence with incident_angle zero.</p>
<div class="highlight-python"><pre>464 __device__ int
465 propagate_at_specular_reflector(Photon &amp;p, State &amp;s)
466 {
467     float incident_angle = get_theta(s.surface_normal, -p.direction);
468     float3 incident_plane_normal = cross(p.direction, s.surface_normal);
469     incident_plane_normal /= norm(incident_plane_normal);
470
471     p.direction = rotate(s.surface_normal, incident_angle, incident_plane_normal);
472
473     p.history |= REFLECT_SPECULAR;
474
475
476 #ifdef VBO_DEBUG
477     if( p.id == 513 )
478     {
479         printf("id %d incident_angle %f    %f %f %f \n", p.id, incident_angle, s.surface_normal.x, s.surface_normal.y, s.surface_normal.z );
480     }
481 #endif
482
483
484     return CONTINUE;
485 } // propagate_at_specular_reflector</pre>
</div>
<div class="highlight-python"><pre>014-11-26 17:37:48,041 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:262 _get_rng_states
2014-11-26 17:37:48,042 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:226 setup_rng_states using seed 0
[  1]    513 material_code 421004288 inner 25 outer 24 si 4 ri1 1.346476 ri2 1.000000 abs 15077.077148 sca 1000000.000000 rem 0.000000 ncdf 38 w0 60.000000 st 20.000000 cdf lo/up 0.000000 0.000000
FILL_STATE       START    [   513] slot  1 steps  1 lht 1799018 tpos    1.000  -16650.42 -803385.25   -9297.40    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
TO_BOUNDARY      PASS     [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
id 513 incident_angle 0.000000    0.000000 -0.000000 1.000000
AT_SURFACE       CONTINUE [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir      nan      nan      nan pol    0.000    0.000    1.000 REFLECT_SPECULAR
2014-11-26 17:37:48,981 INFO    env.geant4.geometry.collada.g4daeview.daephotonspropagator:185 launch sequence times [0.46804925537109376]</pre>
</div>
<div class="highlight-python"><pre>2014-11-26 18:03:03,368 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:262 _get_rng_states
2014-11-26 18:03:03,368 INFO    env.geant4.geometry.collada.g4daeview.daechromacontext:226 setup_rng_states using seed 0
[  1]    513 material_code 421004288 inner 25 outer 24 si 4 ri1 1.346476 ri2 1.000000 abs 15077.077148 sca 1000000.000000 rem 0.000000 ncdf 38 w0 60.000000 st 20.000000 cdf lo/up 0.000000 0.000000
FILL_STATE       START    [   513] slot  1 steps  1 lht 1799018 tpos    1.000  -16650.42 -803385.25   -9297.40    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
TO_BOUNDARY      PASS     [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir    -0.00     0.00    -1.00 pol    0.000    0.000    1.000
id 513 incident_angle          0.000000
id 513 s.surface_normal        0.000000 -0.000000 1.000000
id 513 p.direction             -0.000000 0.000000 -1.000000
id 513 incident_plane_normal   0.000000 0.000000 0.000000
id 513 norm(incident_plane_..) 0.000000
id 513 incident_plane_normal   nan nan nan
id 513 p.direction             nan nan nan
AT_SURFACE       CONTINUE [   513] slot -1 steps  1 lht 1799018 tpos    2.404  -16650.42 -803385.25   -9610.00    w  550.00   dir      nan      nan      nan pol    0.000    0.000    1.000 REFLECT_SPECULAR
2014-11-26 18:03:04,376 INFO    env.geant4.geometry.collada.g4daeview.daephotonspropagator:185 launch sequence times [0.5438138427734375]
2014-11-26 18:03:04,382 WARNING env.geant4.geometry.collada.g4daeview.daephotonsanalyzer:450 cannot write_propagated with event that has not been saved to file and subsequently loaded
2014-11-26 18:03:04,383 INFO    env.geant4.geometry.collada.g4daeview.daephotonsanalyzer:201 _last_index</pre>
</div>
<div class="sidebar">
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>