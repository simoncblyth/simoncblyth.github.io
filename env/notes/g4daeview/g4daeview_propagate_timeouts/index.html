<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Propagate Timeouts &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../numpy/">numpy</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/g4daeview/g4daeview_propagate_timeouts.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="propagate-timeouts">
<h1>Propagate Timeouts<a class="headerlink" href="#propagate-timeouts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>robustify propagation</li>
<li>bookkeeping<ul>
<li>local worker lockfile to prevent two propagators running simultaneously on same node</li>
<li>python metadata dict containing propagator name and parameters : could be the lockfile</li>
<li>how to do this remotely? multipart zmq message with 2nd frame containing metadata ?<ul>
<li>probably json <a class="reference external" href="https://github.com/vivkin/gason">https://github.com/vivkin/gason</a> as easy to
translate from python dict and parsers available in every language : speed
is not a great concern as not much metadata</li>
</ul>
</li>
<li>sqlite based recording of<ul>
<li>propagation parameters and times</li>
<li>photon/hits/hitlist digests</li>
</ul>
</li>
<li>exercise bookkeeping by checking dependency on params like max_steps and cohort size</li>
</ul>
</li>
<li>hit checking<ul>
<li>flag analysis : NAN_ABORT trace</li>
<li>many slot 22 : suggests truncation : check just storage truncation, not step truncation</li>
<li>correlate the photons with the hits</li>
<li>hit time distributions</li>
<li>hit wavelength distributions</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="mock001-normal-incidence-nan-abort">
<h2>mock001 : normal incidence NAN_ABORT<a class="headerlink" href="#mock001-normal-incidence-nan-abort" title="Permalink to this headline">¶</a></h2>
<p>Perfect normal incidence resulted in an NAN_ABORT. Observed
with a vertical photon incident on the horizontal AD table,
on which the ADs sit. Worked around by special casing normal incidence.</p>
</div>
<div class="section" id="mock001-axis-aligned-photons-issue">
<h2>mock001 : axis aligned photons issue<a class="headerlink" href="#mock001-axis-aligned-photons-issue" title="Permalink to this headline">¶</a></h2>
<p>Need to login GPU machine in &#8220;&gt;console&#8221; only  mode in order to use the debugger.
Most convenient to do that over ssh, for multiple connections and copy and pasting.</p>
<div class="highlight-python"><pre>(chroma_env)delta:g4daeview blyth$ g4daechroma.sh --cuda-gdb</pre>
</div>
<p>Suspect a handful of stuck threads:</p>
<div class="highlight-python"><pre>(cuda-gdb) info threads
  4 Thread 0x261b of process 44071  0x00007fff9292664a in -[PAStackshot initWithGlobalTrace].tracebuf () from /usr/lib/system/libsystem_kernel.dylib
  3 Thread 0x240b of process 44071  0x00007fff9292664a in -[PAStackshot initWithGlobalTrace].tracebuf () from /usr/lib/system/libsystem_kernel.dylib
  2 Thread 0x23f7 of process 44071  0x00007fff92921a1a in -[PAStackshot initWithGlobalTrace].tracebuf () from /usr/lib/system/libsystem_kernel.dylib
* 1 Thread 0x2203 of process 44071  0x00007fff89fc1b2d in pthread_threadid_np () from /usr/lib/system/libsystem_pthread.dylib
(cuda-gdb) kill
Kill the program being debugged? (y or n) y
[Termination of CUDA Kernel 9 (init_rng&lt;&lt;&lt;(1025,1,1),(64,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 8 (reduce_kernel_stage2&lt;&lt;&lt;(1,1,1),(512,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 7 (reduce_kernel_stage1&lt;&lt;&lt;(3,1,1),(512,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 5 (init_rng&lt;&lt;&lt;(1025,1,1),(64,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 4 (write_size&lt;&lt;&lt;(1,1,1),(1,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 3 (write_size&lt;&lt;&lt;(1,1,1),(1,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 2 (write_size&lt;&lt;&lt;(1,1,1),(1,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 1 (write_size&lt;&lt;&lt;(1,1,1),(1,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 0 (write_size&lt;&lt;&lt;(1,1,1),(1,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 10 (propagate_hit&lt;&lt;&lt;(2,1,1),(64,1,1)&gt;&gt;&gt;) on Device 0]
[Termination of CUDA Kernel 6 (propagate_hit&lt;&lt;&lt;(66,1,1),(64,1,1)&gt;&gt;&gt;) on Device 0]
(cuda-gdb)</pre>
</div>
<p>Suspicion turned out to be correct, axis aligned (actually z-aligned vertical photons)
were not reaching intersection.  They were just continuously testing against boxes, this was due
to some infinities meaning that the x,y info was effectively not used.  Workaround
was to special case axis aligned photons.</p>
</div>
<div class="section" id="code-improvements">
<h2>Code Improvements<a class="headerlink" href="#code-improvements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>provide high level API for ease of use<ul>
<li>single header &#8220;G4DAEChroma.hh&#8221;</li>
<li>all normal operations through &#8220;chroma&#8221; instance ?</li>
<li>reposition photons and hits outside transport</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>eliminate cnpy to avoid dependency duplication<ul>
<li>need to migrate G4DAETransformCache to numpy.hpp</li>
</ul>
</li>
<li>cordon ROOT + ZMQRoot + ChromaPhotonList usage behind a definition</li>
</ul>
</div>
<div class="section" id="done">
<h2>DONE<a class="headerlink" href="#done" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>reproducibility/seeding : reproducibility established by reset_rng_states that does reset for every propagation</li>
<li>compare vbo to non-vbo propagation : match made</li>
<li>move propagation relevant constants into daedirectconfig.py so both propagations use the same</li>
<li>getting sensor ids back to caller</li>
<li>is the transform to local yielding expected coordinates ?  yep small</li>
</ul>
<div class="highlight-python"><pre># vbo propagation
# photon_id / slot / history / pmtid

In [23]: h[:,3,:4].view(np.int32)
Out[23]:
array([[      62,       22,       68, 16844311],
       [      74,       22,       84, 16844311],
       [      82,       22,       68, 16844810],
       [      93,       22,      580, 16843276],
       [     164,       22,       68, 16843021],
       [     170,       11,       68, 16844291],
       [     194,        5,      516, 16844033],
       [     248,        6,      516, 16843800],</pre>
</div>
</div>
<div class="section" id="issues">
<h2>Issues<a class="headerlink" href="#issues" title="Permalink to this headline">¶</a></h2>
<div class="section" id="timeouts">
<h3>timeouts<a class="headerlink" href="#timeouts" title="Permalink to this headline">¶</a></h3>
<p>Some photon lists like mock001 succeed to propagate,
some like mock007 causing timeouts.</p>
<p>pycuda errors that manifest as timeouts can be due to the GPU equivalent
of a segfault which kills the context, and subsequently causes the
timeout as the host has no context to talk to on device.</p>
<p>Are certain photon parameters causing &#8220;segfaults&#8221; on GPU ?</p>
<div class="highlight-python"><pre> File "/usr/local/env/chroma_env/lib/python2.7/site-packages/env/geant4/geometry/collada/g4daeview/daephotons.py", line 222, in propagate
    self.propagator.interop_propagate( vbo, max_steps=max_steps, max_slots=max_slots )
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/env/geant4/geometry/collada/g4daeview/daephotonspropagator.py", line 192, in interop_propagate
    self.propagate( vbo_dev_ptr, max_steps=max_steps, max_slots=max_slots )
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/env/geant4/geometry/collada/g4daeview/daephotonspropagator.py", line 160, in propagate
    t = get_time()
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py", line 453, in get_call_time
    end.synchronize()
pycuda._driver.LaunchError: cuEventSynchronize failed: launch timeout
PyCUDA WARNING: a clean-up operation failed (dead context maybe?)
cuEventDestroy failed: launch timeout
PyCUDA WARNING: a clean-up operation failed (dead context maybe?)
cuEventDestroy failed: launch timeout
PyCUDA WARNING: a clean-up operation failed (dead context maybe?)
cuGLUnmapBufferObject failed: launch timeout
(chroma_env)delta:g4daeview blyth$
(chroma_env)delta:g4daeview blyth$
(chroma_env)delta:g4daeview blyth$ g4daeview.sh --load mock007</pre>
</div>
</div>
</div>
<div class="section" id="mock-photons">
<h2>mock photons<a class="headerlink" href="#mock-photons" title="Permalink to this headline">¶</a></h2>
<p>Using the transform cache, samples of photons were prepared with
directions oriented with respect to the PMTs. Eg bullseye photons.</p>
<p>To visualize initial photons load with <cite>-P/&#8211;nopropagate</cite></p>
<div class="highlight-python"><pre>g4daeview.sh --load mock002 --nopropagate --geometry-regexp PmtHemiCathode</pre>
</div>
<div class="highlight-python"><pre>//transport-&gt;GetPhotons()-&gt;Save("mock002");  // ldir +y
//transport-&gt;GetPhotons()-&gt;Save("mock003");  // ldir +x
//transport-&gt;GetPhotons()-&gt;Save("mock004");  // ldir +z
//transport-&gt;GetPhotons()-&gt;Save("mock005");  // lpos (0,0,100) ldir (0,0,-1)  try to shoot directly at PMT
//transport-&gt;GetPhotons()-&gt;Save("mock006");  // lpos (0,0,500) ldir (0,0,-1)  try to shoot directly at PMT
//transport-&gt;GetPhotons()-&gt;Save("mock007");  // lpos (0,0,1500) ldir (0,0,-1)  try to shoot directly at PMT</pre>
</div>
</div>
<div class="section" id="vbo-vs-non-vbo-hit-count-difference">
<h2>vbo vs non-vbo hit count difference<a class="headerlink" href="#vbo-vs-non-vbo-hit-count-difference" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [36]: h.shape
Out[36]: (146, 4, 4)

In [37]: h = ph("h1")

In [38]: h.shape
Out[38]: (33, 4, 4)</pre>
</div>
</div>
<div class="section" id="mocknuwa-propagation-testing-over-network">
<h2>mocknuwa propagation testing over network<a class="headerlink" href="#mocknuwa-propagation-testing-over-network" title="Permalink to this headline">¶</a></h2>
<p>While running:</p>
<div class="highlight-python"><pre># non-vbo  propagation using propagate_hit.cu gpu/photon_hit.py GPUPhotonsHit
g4daechroma.sh

# vbo propagation with the GUI
g4daeview.sh --live
g4daeview.sh --zmqendpoint=tcp://localhost:5002

# the broker
czmq-;czmq-broker-local</pre>
</div>
<p>Provoke a propagation with:</p>
<div class="highlight-python"><pre>mocknuwa.sh 1</pre>
</div>
</div>
<div class="section" id="file-based-propagation-testing">
<h2>file based propagation testing<a class="headerlink" href="#file-based-propagation-testing" title="Permalink to this headline">¶</a></h2>
<p>debug propagation with:</p>
<div class="highlight-python"><pre>daedirectpropagation.sh mock001</pre>
</div>
</div>
<div class="section" id="visualize-initial-positions-by-holding-propagation">
<h2>visualize initial positions by holding propagation<a class="headerlink" href="#visualize-initial-positions-by-holding-propagation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>g4daeview.sh --load mock002 --nopropagate --geometry-regexp PmtHemiCathode
udp.py --load mock002
udp.py --load mock003
udp.py --propagate</pre>
</div>
</div>
<div class="section" id="vbo-propagation">
<h2>vbo propagation<a class="headerlink" href="#vbo-propagation" title="Permalink to this headline">¶</a></h2>
<p>Kernel invoked from interop_propagate  <cite>daephotons.py</cite>:</p>
<div class="highlight-python"><pre>182     def propagate(self, max_steps=100):
...
216         vbo = self.renderer.pbuffer
217
218         self.propagator.update_constants()
219
220         if not self.config.args.propagate:
221             log.warn("propagation is inhibited by config: -P/--nopropagate ")
222         else:
223             log.warn("propagation proceeding")
224             self.propagator.interop_propagate( vbo, max_steps=max_steps, max_slots=max_slots )
225         pass
226
227         propagated = vbo.read()</pre>
</div>
<p>kernel call <cite>daephotonspropagator.py</cite>:</p>
<div class="highlight-python"><pre>.92     def propagate(self,
 93                   vbo_dev_ptr,
 94                   max_steps=100,
 95                   max_slots=30,
 96                   use_weights=False,
 97                   scatter_first=0):
 98         """
...
145                     grid=(blocks, 1)
146                     args = ( np.int32(first_photon),
147                              np.int32(photons_this_round),
148                              self.input_queue_gpu[1:].gpudata,
149                              self.output_queue_gpu.gpudata,
150                              self.ctx.rng_states,
151                              vbo_dev_ptr,
152                              np.int32(nsteps),
153                              np.int32(max_slots),
154                              np.int32(use_weights),
155                              np.int32(scatter_first),
156                              self.ctx.gpu_geometry.gpudata)
157
158                     get_time = self.kernel.prepared_timed_call( grid, block, *args )</pre>
</div>
<p><cite>cuda/propagate_vbo.cu</cite>:</p>
<div class="highlight-python"><pre>488 __global__ void
489 propagate_vbo( int first_photon,
490                int nthreads,
491                unsigned int *input_queue,
492                unsigned int *output_queue,
493                curandState *rng_states,
494                float4 *vbo,
495                int max_steps,
496                int max_slots,
497                int use_weights,
498                int scatter_first,
499                Geometry *g)
500 {</pre>
</div>
<p>Hmm, can i access the maps from the Geometry struct GPU side ? Nope not there:</p>
<div class="highlight-python"><pre>54 struct Geometry
55 {
56     float3 *vertices;
57     uint3 *triangles;
58     unsigned int *material_codes;
59     unsigned int *colors;
60     uint4 *primary_nodes;
61     uint4 *extra_nodes;
62     Material **materials;
63     Surface **surfaces;
64     float3 world_origin;
65     float world_scale;
66     int nprimary_nodes;
67 };

 4 struct Detector
 5 {
 6     // Order in decreasing size to avoid alignment problems
 7     int *solid_id_to_channel_index;</pre>
</div>
</div>
<div class="section" id="non-vbo-propagation">
<h2>non-vbo propagation<a class="headerlink" href="#non-vbo-propagation" title="Permalink to this headline">¶</a></h2>
<p>Must use GPUDetector (not GPUGeometry) to have the mapping arrays.</p>
<p><cite>gpu/detector.py</cite>:</p>
<div class="highlight-python"><pre>16 class GPUDetector(GPUGeometry):
17     def __init__(self, detector, wavelengths=None, print_usage=False):
18         GPUGeometry.__init__(self, detector, wavelengths=wavelengths, print_usage=False)
19
20         self.solid_id_to_channel_index_gpu = \
21             ga.to_gpu(detector.solid_id_to_channel_index.astype(np.int32))
22         self.solid_id_to_channel_id_gpu = \
23             ga.to_gpu(detector.solid_id_to_channel_id.astype(np.int32))
24</pre>
</div>
<p><cite>gpu/photon_hit.py</cite>:</p>
<div class="highlight-python"><pre>176         solid_id_map_gpu = gpu_geometry.solid_id_map
177         solid_id_to_channel_id_gpu = gpu_geometry.solid_id_to_channel_id_gpu
178
...
197                     grid = (blocks, 1)
198                     args = (
199                         np.int32(first_photon),
200                         np.int32(photons_this_round),
201                         self.input_queue_gpu[1:].gpudata,
202                         self.output_queue_gpu.gpudata,
203                         rng_states,
204                         self.pos.gpudata,
205                         self.dir.gpudata,
206                         self.wavelengths.gpudata,
207                         self.pol.gpudata,
208                         self.t.gpudata,
209                         self.flags.gpudata,
210                         self.last_hit_triangles.gpudata,
211                         self.weights.gpudata,
212                         np.int32(nsteps),
213                         np.int32(use_weights),
214                         np.int32(scatter_first),
215                         gpu_geometry.gpudata,
216                         solid_id_map_gpu.gpudata,
217                         solid_id_to_channel_id_gpu.gpudata,
218                             )
219                     get_time = self.propagate_hit_kernel.prepared_timed_call( grid, block, *args )
220                     t = get_time()</pre>
</div>
<p><cite>cuda/propagate_hit.cu</cite>:</p>
<div class="highlight-python"><pre>118 // iiPPPPPPPPPPPiiiP
119
120 __global__ void
121 propagate_hit(
122       int first_photon,
123       int nthreads,
124       unsigned int *input_queue,
125       unsigned int *output_queue,
126       curandState *rng_states,
127       float3 *positions,
128       float3 *directions,
129       float *wavelengths,
130       float3 *polarizations,
131       float *times,
132       unsigned int *histories,
133       int *last_hit_triangles,
134       float *weights,
135       int max_steps,
136       int use_weights,
137       int scatter_first,
138       Geometry *g,
139       int* solid_map,
140       int* solid_id_to_channel_id )
141 {
...
233     if ((p.history &amp; SURFACE_DETECT) != 0) {
234
235         //
236         // kludgy mis-use of lht for outputting
237         // various things like
238         //       solid_id:    index like, zero based
239         //       channel_id:  the pmtid, encoding site/ad/ring/...
240         //
241         int triangle_id = last_hit_triangles[photon_id];
242         if (triangle_id &gt; -1) {
243             int solid_id = solid_map[triangle_id];
244             int channel_id = solid_id_to_channel_id[solid_id];
245             last_hit_triangles[photon_id] = channel_id ;
246         } else {
247             last_hit_triangles[photon_id] = -2 ;
248         }</pre>
</div>
</div>
<div class="section" id="threading-sensor-ids-back-to-caller-vbo">
<h2>threading sensor ids back to caller (vbo)<a class="headerlink" href="#threading-sensor-ids-back-to-caller-vbo" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [7]: h = ph("h1")

In [8]: a = h[:,3,0].view(np.int32)

In [9]: b = h[:,3,1].view(np.int32)

In [10]: c = h[:,3,2].view(np.int32)

In [11]: a[a != 0]
Out[11]:
array([ 750,  276,  816,  342,  486,  702, 1044,  936,  696,  696, 1050,
       1194,  372,  390,  756, 1086,  762, 1134,  786,  726, 1026,  408,
        912,   48,  102,   78,  756,  942,  954, 1164,  108,  876, 1092,
        702,  504,  414,  702,  498,  522,  546,  768,  324, 1086, 1008,

        ...

In [13]: np.set_printoptions(formatter={'int':hex})

In [14]: b[b != 0]
Out[14]:
array([0x1010516, 0x101020f, 0x1010609, 0x1010302, 0x1010402, 0x101050e,
       0x1010717, 0x1010705, 0x101050d, 0x101050d, 0x1010718, 0x1010818,
       0x1010307, 0x101030a, 0x1010517, 0x1010806, 0x1010518, 0x101080e,
       0x1010604, 0x1010512, 0x1010714, 0x101030d, 0x1010701, 0x1010101,
       ...


In [16]: np.set_printoptions(formatter={'int':None})

In [17]: c[c != 0]
Out[17]: array([888, 888, 888, ..., 888, 888, 888], dtype=int32)</pre>
</div>
</div>
<div class="section" id="threading-sensor-ids-back-to-caller-non-vbo">
<h2>threading sensor ids back to caller (non-vbo)<a class="headerlink" href="#threading-sensor-ids-back-to-caller-non-vbo" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [12]: a = ph("1")

In [13]: h = ph("h1")

In [14]: a.shape
Out[14]: (4165, 4, 4)

In [15]: h.shape
Out[15]: (52, 4, 4)

In [16]: np.set_printoptions(formatter={'int':hex})

In [17]: h[:,3,3]
Out[17]:
array([ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.], dtype=float32)

In [18]: h[:,3,3].view(np.int32)
Out[18]:
array([0x1010516, 0x1010302, 0x1010402, 0x1010717, 0x1010718, 0x1010517,
       0x1010518, 0x1010701, 0x1010106, 0x1010706, 0x1010708, 0x101010b,
       0x101050e, 0x101040c, 0x1010601, 0x1010201, 0x101020d, 0x101020d,
       0x1010502, 0x1010209, 0x101070d, 0x1010602, 0x1010715, 0x1010108,
       0x1010407, 0x1010418, 0x101040b, 0x101060c, 0x1010709, 0x1010409,
       0x101050d, 0x101050d, 0x1010613, 0x1010707, 0x1010516, 0x101020d,
       0x1010201, 0x1010308, 0x101040f, 0x101010e, 0x1010109, 0x1010417,
       0x101050c, 0x1010309, 0x1010213, 0x101050c, 0x1010402, 0x101040e,
       0x1010716, 0x1010315, 0x101010f, 0x1010416], dtype=int32)</pre>
</div>
<p>Hmm for comparison need photon index in the hits array</p>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>