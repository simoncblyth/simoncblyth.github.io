<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Analytic Geometry &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../" />
    <link rel="up" title="enhancement" href="../" />
    <link rel="next" title="Instance Identity" href="../instance_identity/" />
    <link rel="prev" title="enhancement" href="../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../instance_identity/" title="Instance Identity"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../" title="enhancement"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../" >Graphics</a> &raquo;</li>
          <li><a href="../../" >ggeoview</a> &raquo;</li>
          <li><a href="../" accesskey="U">enhancement</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../llvm/">llvm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../">Graphics</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../">ggeoview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../oglrap/">oglrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../meshlab/">meshlab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../collada/">collada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cgal/">CGAL Computational Geometry Algorithms Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mesh/">mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vrml/">vrml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opengl/">opengl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../transformations/">transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../panda3d/">panda3d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pipeline/">pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math/">math</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../glumpy/">glumpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scenekit/">scenekit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyopengl/">pyopengl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../unity/">unity</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../_sources/graphics/ggeoview/enhancement/analytic_geometry.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../"
                        title="previous chapter">enhancement</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../instance_identity/"
                        title="next chapter">Instance Identity</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="analytic-geometry">
<h1>Analytic Geometry<a class="headerlink" href="#analytic-geometry" title="Permalink to this headline">¶</a></h1>
<div class="section" id="principal">
<h2>Principal<a class="headerlink" href="#principal" title="Permalink to this headline">¶</a></h2>
<p>Triangle meshes are a convenient initial step to the GPU
as all geometry can be treated with the same code.
Special treatment of important geometry (PMTs) however
is expected to have large performance gains.</p>
<p>Ray intersection with CSG solids boils down to
analytic solving quadratic/cubic polynomials. There is
a technique to handle union intersections by applying boolean operations
to intersection segments of the sub volumes.</p>
</div>
<div class="section" id="aligning-three-geometries">
<h2>Aligning three geometries<a class="headerlink" href="#aligning-three-geometries" title="Permalink to this headline">¶</a></h2>
<p>Actually not 2 but 3 geometries:</p>
<dl class="docutils">
<dt>OpenGL</dt>
<dd><p class="first">GMergedMesh triangulated geometry, to first order only impacts visualization not propagation/tracing,
but the solid identity infomation including boundary indices comes from GMergedMesh.</p>
<p class="last">Geometry is modified by <em>&#8211;box</em>  option according to <em>&#8211;boxconfig</em>. The orignal instance-1
GMergedMesh is combined with the GSolid fabricated by GTestBox</p>
</dd>
<dt>OptiX Triangulated</dt>
<dd>translation of GMergedMesh triangulated into OptiX</dd>
<dt>OptiX Analytic</dt>
<dd>somewhat manual addon entering via GPmt and created in python by <em>pmt-parts</em></dd>
</dl>
</div>
<div class="section" id="containment-box-handling">
<h2>Containment Box Handling<a class="headerlink" href="#containment-box-handling" title="Permalink to this headline">¶</a></h2>
<p>Actually the parameters of the containment bbox should be obtained from GMergedMesh.1,
it should be enlarged according to input parameter and the resulting gbbox
should then be fed down via GGeo::modifyGeometry to:</p>
<dl class="docutils">
<dt>GTestBox</dt>
<dd>to fabricate the GSolid</dd>
<dt>GPmt</dt>
<dd>to create a <em>Part</em> struct to tack on to the parts buffer</dd>
</dl>
<ul class="simple">
<li>Avoids mal-duplication.</li>
<li>allows pslice to apply to content and not the containment box
(but pslicing is a low level Analytic Part debug thing,
as it cannot be applied at triangulated level)</li>
</ul>
</div>
<div class="section" id="gpmt-operation">
<h2>GPmt Operation<a class="headerlink" href="#gpmt-operation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>reads <em>pmt-parts</em> written float parts buffer, deriving a solid buffer from it
using solid or node indices which are embedded into the parts buffer</li>
<li>these five indices 0:4 hail from the detdesc tree parse of <em>hemi-pmt.xml</em>
and these must match the indices from the GMergedMesh identity buffer</li>
<li>for debug want to skip some solids, eg to see behavior with a solid lump of Pyrex/Vacuum/Bialkali
but at the moment the identity would then be misaligned ?</li>
</ul>
</div>
<div class="section" id="photocathode">
<h2>Photocathode<a class="headerlink" href="#photocathode" title="Permalink to this headline">¶</a></h2>
<p>Geant4/detdesc model is with seperate very thin spherical parts, including
a shared boundary with the inside of the pyrex.</p>
<p>For surface based geometry coincident boundaries are unhealthy, so instead model it
similar to how Pyrex/Vacuum modelling of the pyrex envelope is done.</p>
<p>Again this might entail adding solids, which will mess up identity.  Seems</p>
</div>
<div class="section" id="test-box-debugging">
<h2>Test Box Debugging<a class="headerlink" href="#test-box-debugging" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>ggv-box(){
   ggv --box \
        --animtimemax 7 \
        --boxconfig "size=2;boundary=MineralOil/Rock//;" \
        --torchconfig "source=0,0,400;target=0,0,0;radius=150;zenith_azimuth=1,0,1,0" \
         $*
}</pre>
</div>
<ul class="simple">
<li>need to sort out analytic boundary identity labelling, the missers
think they are in Pyrex, when should be MO
[FIXED]</li>
<li>GGeo/GMergedMesh should be orchestrating the analytic PMT for commality,
currently OGeo/GPmt just grabbing from GCache
[FIXED]</li>
<li>where do i set the boundary of the analytic test box ?
again need to bring control of triangulated and analytic together
to avoid confusion
[FIXED]</li>
</ul>
<p>From OptiX point of view there 5 (or 6 with the container) primitives.
These need to line up with the triangulated solids for identity to work.
Each primitive has a small numbers of parts (up to 4).
Total of 16 parts.</p>
<p>When put the container at the end in pmt-parts the material mapping
works better as that aligns with GMergedMesh::combine order.
This is brittle, will fail when slicing.</p>
<div class="highlight-python"><pre>[2015-Nov-05 19:50:49.364081]:info: OGeo::makeAnalyticGeometry identity buffer BufferId   -1 BufferTarget    0 NumBytes      96 ItemSize      16 NumElements       4 NumItems       6 NumElementsTotal      24

(  0)        3199          47          27           0
(  1)        3200          46          28           0
(  2)        3201          43          29           3
(  3)        3202          44          30           0
(  4)        3203          45          30           0
(  5)           5        1000         123           0</pre>
</div>
<div class="highlight-python"><pre>[2015-11-05 19:53:00.317306] [0x000007fff7448031] [info]    GBndLib::dump
 (  0) im:                   Vacuum om:                   Vacuum is:                          os:
 ...
 ( 27) im:                    Pyrex om:               MineralOil is:                          os:
 ( 28) im:                   Vacuum om:                    Pyrex is:                          os:
 ( 29) im:                 Bialkali om:                   Vacuum is:                          os:lvPmtHemiCathodeSensorSurface
 ( 30) im:             OpaqueVacuum om:                   Vacuum is:                          os:
 ...
 (122) im:                  RadRock om:                     Rock is:                          os:</pre>
</div>
<p>Implementing container making C++ side ?</p>
<div class="highlight-python"><pre>simon:pmt blyth$ ggv --pmt 0:15
[2015-Nov-05 20:44:09.782958]:info: 0:/usr/local/env/optix/ggeo/bin/GPmtTest
[2015-Nov-05 20:44:09.783831]:info: 1:0:15
[2015-Nov-05 20:44:09.784031]:info: NPY::make_slice from 16 -&gt; 15 slice NSlice      0 :    15 :     1
[2015-Nov-05 20:44:09.784205]:info: GPmt::loadFromCache slicing partBuf  origBuf 16,4,4 partBuf 15,4,4
GPmt::make_container pbb min   -101.168   -101.168    -23.838  max    101.168    101.168     56.000
...
GPmt::make_container pbb min    -27.500    -27.500   -164.500  max     27.500     27.500      1.500
GPmt::make_container bb min   -101.168   -101.168   -169.000  max    101.168    101.168    131.000
GPmt::make_container bb factor 3.0  min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
[2015-Nov-05 20:44:09.784475]:info: parts shape: 15,4,4
     0.0000      0.0000     69.0000    102.0000</pre>
</div>
<div class="highlight-python"><pre>simon:pmt blyth$ ggv --pmt 0:16
[2015-Nov-05 20:44:54.266290]:info: 0:/usr/local/env/optix/ggeo/bin/GPmtTest
[2015-Nov-05 20:44:54.266963]:info: 1:0:16
[2015-Nov-05 20:44:54.267173]:info: NPY::make_slice from 16 -&gt; 16 slice NSlice      0 :    16 :     1
[2015-Nov-05 20:44:54.267336]:info: GPmt::loadFromCache slicing partBuf  origBuf 16,4,4 partBuf 16,4,4
GPmt::make_container pbb min   -101.168   -101.168    -23.838  max    101.168    101.168     56.000
GPmt::make_container pbb min   -101.168   -101.168     56.000  max    101.168    101.168    100.070
GPmt::make_container pbb min    -84.540    -84.540    100.070  max     84.540     84.540    131.000
...
GPmt::make_container pbb min    -98.143    -98.143    -30.000  max     98.143     98.143     56.000
GPmt::make_container pbb min    -97.151    -97.151    -29.000  max     97.151     97.151     56.131
GPmt::make_container pbb min    -27.500    -27.500   -164.500  max     27.500     27.500      1.500
GPmt::make_container pbb min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
GPmt::make_container bb min   -551.168   -551.168   -619.000  max    551.168    551.168    581.000
GPmt::make_container bb factor 3.0  min  -2351.168  -2351.168  -2419.000  max   2351.168   2351.168   2381.000
[2015-Nov-05 20:44:54.267608]:info: parts shape: 16,4,4</pre>
</div>
</div>
<div class="section" id="fixing-box-normals">
<h2>Fixing box normals<a class="headerlink" href="#fixing-box-normals" title="Permalink to this headline">¶</a></h2>
<p>After fixing ray box normals, get very pretty Lambertian render of PMT in box with <em>ggv-pmt</em> ie:</p>
<div class="highlight-python"><pre>ggv-pmt ()
{
    ggv.sh --tracer --restrictmesh 1 --analyticmesh 1 --islice 0 --target 3199 $*
}</pre>
</div>
<p>But the OptiX mode of <em>ggv-box</em> is far less pretty with nasty black faces, thats with:</p>
<div class="highlight-python"><pre>ggv-box ()
{
    ggv --box --animtimemax 7 --boxconfig "size=2;boundary=MineralOil/Rock//;" --torchconfig "source=0,0,400;target=0,0,0;radius=102;zenith_azimuth=1,0,1,0" $*
}</pre>
</div>
<p>Also photon reflections show non-symmetric behaviour, discriminating againt two of the box faces.</p>
<p>How is that possible ?</p>
<ul class="simple">
<li>different code in propagator and tracer ?</li>
<li>different geometry ?</li>
<li>normal issue or iimpinging other geometry ?</li>
</ul>
<div class="highlight-python"><pre>ggv.sh --tracer  --analyticmesh 1 --islice 0 --target 3199 $*
# not restricting to instanced, see pretty render of analytic PMT with no extra box ?

ggv.sh --tracer  --islice 0 --target 3199 $*
# triangulated PMT</pre>
</div>
<p>After fixing <em>ggv-box</em> mismatch, changing to <em>size=3</em> get the pretty render in OptiX mode and symmetric reflections:</p>
<div class="highlight-python"><pre>ggv-box ()
{
    ggv --box --animtimemax 7 --boxconfig "size=3;boundary=MineralOil/Rock//;" --torchconfig "source=0,0,400;target=0,0,0;radius=102;zenith_azimuth=1,0,1,0" $*
}</pre>
</div>
<ul class="simple">
<li>Explain that ?</li>
<li>Also, still material colors seem wrong.</li>
</ul>
</div>
<div class="section" id="face-slicing">
<h2>Face Slicing<a class="headerlink" href="#face-slicing" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>ggv-pmt --fslice 0:720
ggv-pmt --fslice 720:1392
ggv-pmt --fslice 1392:2352
ggv-pmt --fslice 2352:2832
ggv-pmt --fslice 2832:2928

    # selecting faces of single solids, nodeinfo.npy provides the face index ranges</pre>
</div>
<div class="highlight-python"><pre>In [1]: ni = np.load("GMergedMesh/1/nodeinfo.npy")

In [2]: ni
Out[2]:
array([[ 720,  362, 3199, 3155],
       [ 672,  338, 3200, 3199],
       [ 960,  482, 3201, 3200],
       [ 480,  242, 3202, 3200],
       [  96,   50, 3203, 3200]], dtype=uint32)

In [3]: np.cumsum(ni[:,0])
Out[3]: array([ 720, 1392, 2352, 2832, 2928], dtype=uint64)</pre>
</div>
</div>
<div class="section" id="id1">
<h2>Photocathode<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>pmt-parts   # move to writing full partition file, and pslicing as needed

ggv-pmt --fslice 1392:2352 --pslice 8:10

ggv-pmt --fslice 1392:2352 --pslice 8:12   # after add inner spheres</pre>
</div>
</div>
<div class="section" id="first-and-second-solids-pyrex-and-contained-vacuum">
<h2>First and Second Solids, Pyrex and contained vacuum<a class="headerlink" href="#first-and-second-solids-pyrex-and-contained-vacuum" title="Permalink to this headline">¶</a></h2>
<p>OptiX render is as would expect, with pyrex and vacuum very thinly separated,
to make the inner volume visible adjust near to control the ray trace epsilon</p>
<p>OpenGL render not as would expect, much fatter to the back.
As if pushed out by the dynode ?</p>
<div class="highlight-python"><pre>pmt-parts 0:8
ggv-pmt --fslice 0:1392</pre>
</div>
</div>
<div class="section" id="tubs-issue-fixed-was-caused-by-cylinder-poking-outside-its-bbox">
<h2>Tubs Issue FIXED, was caused by cylinder poking outside its bbox<a class="headerlink" href="#tubs-issue-fixed-was-caused-by-cylinder-poking-outside-its-bbox" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>enable ENDCAP_P only in pmt-/dd.py and regen with</li>
</ul>
<div class="highlight-python"><pre>pmt-parts 3:4</pre>
</div>
<ul class="simple">
<li>setup coloring in cu/pinhole_camera.cu</li>
</ul>
<div class="highlight-python"><pre>100   // BGRA
101   uchar4 color = prd.flag == HP_PCAP_I ? RED :  make_color( prd.result );</pre>
</div>
<ul class="simple">
<li>get expected behavior for outer and inner HP_PCAP_O and HP_PCAP_I</li>
<li>PCAP endcap is to the right(in default initial ggv-pmt viewpoint)</li>
<li>doing the same for QCAP see view dependent shape mis-behaviour, but disabling the
partition_union resetting of bbox avoids it</li>
<li>the problem was the bbox was clipped in at the 3spehere interseciton plane
but ZSize was not changed</li>
<li>from point of view of cylinder rendering the relevant PQ vector is not (0,0,sizeZ)
but rather (0,0,clipped_sizeZ)</li>
</ul>
<div class="highlight-python"><pre>194 static __device__
195 void intersect_ztubs(quad&amp; q0, quad&amp; q1, quad&amp; q2, quad&amp; q3, const uint4&amp; identity )
196 {
197 /*
198 Position shift below is to match between different cylinder Z origin conventions
199
200 * Ericson calc implemented below has cylinder origin at endcap P
201 * detdesc/G4 Tubs has cylinder origin in the center
202
203 */
204     float sizeZ = q1.f.x ;
205     float z0 = q0.f.z - sizeZ/2.f ;
206     float3 position = make_float3( q0.f.x, q0.f.y, z0 );  // 0,0,-169.
207     float clipped_sizeZ = q3.f.z - q2.f.z ;
208
209     float radius = q0.f.w ;
210     int flags = q1.i.w ;
211
212     bool PCAP = flags &amp; ENDCAP_P ;
213     bool QCAP = flags &amp; ENDCAP_Q ;
214
215     //rtPrintf("intersect_ztubs position %10.4f %10.4f %10.4f \n", position.x, position.y, position.z );
216     //rtPrintf("intersect_ztubs flags %d PCAP %d QCAP %d \n", flags, PCAP, QCAP);
217
218     float3 m = ray.origin - position ;
219     float3 n = ray.direction ;
220     float3 d = make_float3(0.f, 0.f, clipped_sizeZ );
221
222     float rr = radius*radius ;
223     float3 dnorm = normalize(d);
224</pre>
</div>
</div>
<div class="section" id="just-tubs">
<h2>Just Tubs<a class="headerlink" href="#just-tubs" title="Permalink to this headline">¶</a></h2>
<p>Some funny straight lines as rotate around:</p>
<div class="highlight-python"><pre>pmt-parts 3:4   # just tubs

ggv-pmt</pre>
</div>
<p>Either a bug or maybe optical illusion due to:</p>
<ul class="simple">
<li>perspective projection</li>
<li>no depth/inside/outside queues</li>
</ul>
<p>Perhaps Z cut happening in wrong frame ?</p>
<p>TODO:</p>
<ul class="simple">
<li>get orthographic projection working for OptiX raygen</li>
<li>matplotlib projection plot of points of the mesh</li>
</ul>
<div class="highlight-python"><pre>In [4]: v = np.load("GMergedMesh/1/vertices.npy")

In [5]: v
Out[5]:
array([[   0.   ,    0.   ,  131.   ],
       [  33.905,    0.   ,  126.536],
       [  32.75 ,    8.775,  126.536],
       ...,
       [  26.563,   -7.118,    1.5  ],
       [   0.   ,    0.   ,    1.5  ],
       [   0.   ,    0.   , -164.5  ]], dtype=float32)

In [6]: v.shape
Out[6]: (1474, 3)

In [7]: ni[:,1].sum()  ## sum of vertices, it matches as these are fixed meshes with no dupes
Out[7]: 1474


In [10]: i = np.load("GMergedMesh/1/indices.npy").reshape(-1,3)

In [11]: i.shape
Out[11]: (2928, 3)

In [15]: np.unique(i[:720]).min()
Out[15]: 0

In [16]: np.unique(i[:720]).max()
Out[16]: 361

n [12]: ni[:,0].sum()
Out[12]: 2928

In [19]: np.unique(i[:720]).size    # hmm no need for doing indices look up into the vertices, its all contiguous
Out[19]: 362</pre>
</div>
</div>
<div class="section" id="just-tracing-a-single-instance">
<h2>Just Tracing a single instance<a class="headerlink" href="#just-tracing-a-single-instance" title="Permalink to this headline">¶</a></h2>
<p>Using OTracerTest with the below is much faster than with
full context (including all those propagate buffers) and full geometry:</p>
<div class="highlight-python"><pre>pmt-parts 0:4   # 3sphere + tubs


ggv --tracer --restrictmesh 1 --analyticmesh 1 --islice 0 --target 3199

ggv-pmt    # abbreviation for above

ggv-allpmt --stack $((1024 + 512))      # stack can be reduced a bit with just the tracer


ggv --tracer --restrictmesh 1 --analyticmesh 1

ggv-allpmt</pre>
</div>
</div>
<div class="section" id="plumbing-check">
<h2>Plumbing check<a class="headerlink" href="#plumbing-check" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>ggv --restrictmesh 1 --analyticmesh 1 --torchconfig "radius=300;frame=3199;source=0,0,1000;target=0,0,0"</pre>
</div>
</div>
<div class="section" id="how-to-optix-intersect-with-csg-solid">
<h2>How to OptiX intersect with CSG solid ?<a class="headerlink" href="#how-to-optix-intersect-with-csg-solid" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>simon:OptiX_380_sdk blyth$ find . -name '*.cu'  -exec grep -l intersect {} \;
./ambocc/parallelogram.cu
./ambocc/sphere.cu
./buffersOfBuffers/parallelogram.cu
./buffersOfBuffers/sphere_texcoord.cu
./cook/clearcoat.cu
./cook/dof_camera.cu
./cook/parallelogram.cu
./cook/sphere.cu
./cook/sphere_texcoord.cu
./cuda/triangle_mesh.cu
./cuda/triangle_mesh_small.cu
./device_exceptions/device_exceptions.cu
./displacement/geometry_programs.cu
./glass/glass.cu
./glass/triangle_mesh_iterative.cu
./heightfield/heightfield.cu
./hybridShadows/triangle_mesh_fat.cu
./isgReflections/parallelogram.cu
./isgReflections/triangle_mesh_fat.cu
./isgShadows/triangle_mesh_fat.cu
./julia/block_floor.cu
./julia/julia.cu
...

simon:OptiX_380_sdk blyth$ find . -type f -exec grep -l union {} \;
./julia/block_floor.cu
./julia/distance_field.h</pre>
</div>
<p>Julia sample has lots of non-trivial intersection examples</p>
<p>julia/block_floor.cu:</p>
<div class="highlight-python"><pre>538 RT_PROGRAM void intersect(int primIdx)
539 {
540   object_factory&lt;false&gt;::Object obj;
541   object_factory&lt;false&gt;::make_object(obj, ray.direction);
542
543   // first check for intersection between the ray and aabb
544   optix::Ray tmp_ray = ray;
545   if(intersect_aabb(tmp_ray, obj)) {
546     float epsilon = 1.25e-3f;
547     float max_epsilon = 2.5e-2f;
548
549     float3 hit_point;
550     float t = adaptive_sphere_trace&lt;1000&gt;(tmp_ray, make_distance_to_primitive(obj), hit_point, epsilon, max_epsilon);
551     if(t &lt; tmp_ray.tmax)
552     {
553       if(rtPotentialIntersection(t))</pre>
</div>
<p>julia/distance_field.h:</p>
<div class="highlight-python"><pre>216 // The union of two primitives
217 template&lt;typename Primitive1, typename Primitive2&gt;
218   class PrimitiveUnion
219 {
220   public:
221     // null constructor creates an undefined DistanceUnion
222     HD_DECL
223     PrimitiveUnion(void){}
224
225     HD_DECL
226     PrimitiveUnion(Primitive1 p1, Primitive2 p2):m_prim1(p1),m_prim2(p2){}
227
228     HD_DECL
229     float distance(const float3 &amp;x) const
230     {
231       return fminf(m_prim1.distance(x), m_prim2.distance(x));
232     }
...</pre>
</div>
<p>shadeTree/parallelogram.cu:</p>
<div class="highlight-python"><pre>37 RT_PROGRAM void intersect(int primIdx)
38 {
39   float3 n = make_float3( plane );
40   float dt = dot(ray.direction, n );
41   float t = (plane.w - dot(n, ray.origin))/dt;
42   if( t &gt; ray.tmin &amp;&amp; t &lt; ray.tmax ) {
43     float3 p = ray.origin + ray.direction * t;
44     float3 vi = p - anchor;
45     float a1 = dot(v1, vi);
46     if(a1 &gt;= 0 &amp;&amp; a1 &lt;= 1){
47       float a2 = dot(v2, vi);
48       if(a2 &gt;= 0 &amp;&amp; a2 &lt;= 1){
49         if( rtPotentialIntersection( t ) ) {
50           geometric_normal = n;
51           shading_normal = n;
52           uv = make_float2(a1, a2);
53           rtReportIntersection( 0 );
54         }
55       }
56     }
57   }
58 }</pre>
</div>
<p>tutorial.cpp:</p>
<div class="highlight-python"><pre>238 float4 make_plane( float3 n, float3 p )
239 {
240   n = normalize(n);
241   float d = -dot(n, p);
242   return make_float4( n, d );
243 }</pre>
</div>
<p>tutorial10.cu:</p>
<div class="highlight-python"><pre>313 //
314 // Intersection program for programmable convex hull primitive
///
///     https://en.wikipedia.org/wiki/Line–plane_intersection
///     http://geomalgorithms.com/index.html
///
315 //
316 rtBuffer&lt;float4&gt; planes;
317 RT_PROGRAM void chull_intersect(int primIdx)
318 {
319   int n = planes.size();
320   float t0 = -FLT_MAX;
321   float t1 = FLT_MAX;
322   float3 t0_normal = make_float3(0);
323   float3 t1_normal = make_float3(0);
324   for(int i = 0; i &lt; n &amp;&amp; t0 &lt; t1; ++i ) {
325     float4 plane = planes[i];
326     float3 n = make_float3(plane);
327     float  d = plane.w;
328
329     float denom = dot(n, ray.direction);
330     float t = -(d + dot(n, ray.origin))/denom;
///
///  Plane eqn, p0 is point in plane, n is normal
///     (p - p0).n = 0
///
///  Line
///      p = ray.origin + t * ray.direction
///
///  Intersect
///
///    (ray.origin + t * ray.direction - p0 ).n = 0
///
///     dot(n, ray.origin) + t * dot(n, ray.direction) - dot(p0, n) = 0
///
///                  dot(p0,n) - dot(n, ray.origin)
///            t =  --------------------------------
///                     dot(n, ray.direction)
///
///

331     if( denom &lt; 0){
332       // enter
333       if(t &gt; t0){
334         t0 = t;
335         t0_normal = n;
336       }
337     } else {
338       //exit
339       if(t &lt; t1){
340         t1 = t;
341         t1_normal = n;
342       }
343     }
344   }
345
346   if(t0 &gt; t1)
347     return;
348
349   if(rtPotentialIntersection( t0 )){
350     shading_normal = geometric_normal = t0_normal;
351     rtReportIntersection(0);
352   } else if(rtPotentialIntersection( t1 )){
353     shading_normal = geometric_normal = t1_normal;
354     rtReportIntersection(0);
355   }
356 }</pre>
</div>
</div>
<div class="section" id="how-to-proceed">
<h2>How to proceed ?<a class="headerlink" href="#how-to-proceed" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>on revisiting G4DAE include GDML G4 CSG model description together
with the triangulated COLLADA</li>
</ul>
</div>
<div class="section" id="detdesc-pmt-is-involved">
<h2>detdesc PMT is involved<a class="headerlink" href="#detdesc-pmt-is-involved" title="Permalink to this headline">¶</a></h2>
<p>Complicated assemblies of CSG solids. Implementing analytic is non-trivial.</p>
<p>G5:/home/blyth/local/env/dyb/NuWa-trunk/dybgaudi/Detector/XmlDetDesc/DDDB/PMT/geometry.xml:</p>
<div class="highlight-python"><pre>08   &lt;catalog name="PMT"&gt;
09
10     &lt;logvolref href="hemi-pmt.xml#lvPmtHemiFrame"/&gt;
11     &lt;logvolref href="hemi-pmt.xml#lvPmtHemi"/&gt;
12     &lt;logvolref href="hemi-pmt.xml#lvPmtHemiwPmtHolder"/&gt;
13     &lt;logvolref href="hemi-pmt.xml#lvAdPmtCollar"/&gt;
14     &lt;logvolref href="hemi-pmt.xml#lvPmtHemiCathode"/&gt;
15     &lt;logvolref href="hemi-pmt.xml#lvPmtHemiVacuum"/&gt;
16     &lt;logvolref href="hemi-pmt.xml#lvPmtHemiBottom"/&gt;
..</pre>
</div>
<p>dybgaudi/Detector/XmlDetDesc/DDDB/PMT/hemi-pmt.xml:</p>
<div class="highlight-python"><pre>37   &lt;!-- The PMT glass --&gt;
38   &lt;logvol name="lvPmtHemi" material="Pyrex"&gt;
39     &lt;union name="pmt-hemi"&gt;
40       &lt;intersection name="pmt-hemi-glass-bulb"&gt;
41           &lt;sphere name="pmt-hemi-face-glass"
42                 outerRadius="PmtHemiFaceROC"/&gt;
43
44           &lt;sphere name="pmt-hemi-top-glass"
45                outerRadius="PmtHemiBellyROC"/&gt;
46           &lt;posXYZ z="PmtHemiFaceOff-PmtHemiBellyOff"/&gt;
47
48           &lt;sphere name="pmt-hemi-bot-glass"
49                 outerRadius="PmtHemiBellyROC"/&gt;
50           &lt;posXYZ z="PmtHemiFaceOff+PmtHemiBellyOff"/&gt;
51
52       &lt;/intersection&gt;
53       &lt;tubs name="pmt-hemi-base"
54         sizeZ="PmtHemiGlassBaseLength"
55         outerRadius="PmtHemiGlassBaseRadius"/&gt;
56       &lt;posXYZ z="-0.5*PmtHemiGlassBaseLength"/&gt;
57     &lt;/union&gt;
58
59     &lt;physvol name="pvPmtHemiVacuum"
60          logvol="/dd/Geometry/PMT/lvPmtHemiVacuum"/&gt;
61
62   &lt;/logvol&gt;</pre>
</div>
<div class="highlight-python"><pre>118   &lt;!-- The Photo Cathode --&gt;
119   &lt;!-- use if limit photocathode to a face on diameter gt 167mm. --&gt;
120   &lt;logvol name="lvPmtHemiCathode" material="Bialkali" sensdet="DsPmtSensDet"&gt;
121     &lt;union name="pmt-hemi-cathode"&gt;
122       &lt;sphere name="pmt-hemi-cathode-face"
123           outerRadius="PmtHemiFaceROCvac"
124           innerRadius="PmtHemiFaceROCvac-PmtHemiCathodeThickness"
125           deltaThetaAngle="PmtHemiFaceCathodeAngle"/&gt;
126       &lt;sphere name="pmt-hemi-cathode-belly"
127           outerRadius="PmtHemiBellyROCvac"
128           innerRadius="PmtHemiBellyROCvac-PmtHemiCathodeThickness"
129           startThetaAngle="PmtHemiBellyCathodeAngleStart"
130           deltaThetaAngle="PmtHemiBellyCathodeAngleDelta"/&gt;
131       &lt;posXYZ z="PmtHemiFaceOff-PmtHemiBellyOff"/&gt;
132     &lt;/union&gt;
133   &lt;/logvol&gt;</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../instance_identity/" title="Instance Identity"
             >next</a> |</li>
        <li class="right" >
          <a href="../" title="enhancement"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../" >Graphics</a> &raquo;</li>
          <li><a href="../../" >ggeoview</a> &raquo;</li>
          <li><a href="../" >enhancement</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>