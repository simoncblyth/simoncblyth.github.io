<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Meshlab Collada Importer Abysmal Speed &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="meshlab" href="../" />
    <link rel="next" title="MeshLab Collada Materials" href="../meshlab_collada_materials/" />
    <link rel="prev" title="Meshlab Plugins" href="../meshlabplugins/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../meshlab_collada_materials/" title="MeshLab Collada Materials"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../meshlabplugins/" title="Meshlab Plugins"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >Graphics</a> &raquo;</li>
          <li><a href="../" accesskey="U">meshlab</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">Graphics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../ggeoview/">ggeoview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../oglrap/">oglrap</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">meshlab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../collada/">collada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cgal/">CGAL Computational Geometry Algorithms Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mesh/">mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vrml/">vrml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../opengl/">opengl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../transformations/">transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../panda3d/">panda3d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pipeline/">pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math/">math</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glumpy/">glumpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scenekit/">scenekit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pyopengl/">pyopengl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unity/">unity</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/graphics/meshlab/meshlab_collada.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../meshlabplugins/"
                        title="previous chapter">Meshlab Plugins</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../meshlab_collada_materials/"
                        title="next chapter">MeshLab Collada Materials</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="meshlab-collada-importer-abysmal-speed">
<h1>Meshlab Collada Importer Abysmal Speed<a class="headerlink" href="#meshlab-collada-importer-abysmal-speed" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#collader-import-takes-41-min-for-full-geometry-on-g" id="id1">Collader Import takes 41 min for full geometry on G</a><ul>
<li><a class="reference internal" href="#min-after-geometry-cache-addition-but-exploded" id="id2">11 min after Geometry Cache addition, but exploded!</a></li>
</ul>
</li>
<li><a class="reference internal" href="#why-is-collada-importer-so-slow" id="id3">Why is collada importer so slow ?</a></li>
<li><a class="reference internal" href="#separate-plugin-build-output" id="id4">Separate plugin build output</a></li>
<li><a class="reference internal" href="#before-profiling-optimising-need-to-check-the-svn-future-of-meshlab-vcglib" id="id5">Before profiling/optimising need to check the SVN future of meshlab/vcglib</a></li>
<li><a class="reference internal" href="#fix-by-addition-of-a-geometry-cache" id="id6">Fix by addition of a geometry cache</a><ul>
<li><a class="reference internal" href="#exploded-due-to-updateposition" id="id7">Exploded due to UpdatePosition</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="collader-import-takes-41-min-for-full-geometry-on-g">
<h2><a class="toc-backref" href="#id1">Collader Import takes 41 min for full geometry on G</a><a class="headerlink" href="#collader-import-takes-41-min-for-full-geometry-on-g" title="Permalink to this headline">¶</a></h2>
<p>Pycollada using numpy takes maybe 40 s.  C++ Qt meshlab taking 41 min.</p>
<div class="highlight-python"><pre>In [50]: 2494335./1000./60.
Out[50]: 41.572250000000004</pre>
</div>
<div class="highlight-python"><pre>====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '0.707107 -0.707107 0 6603.82 0.707107 0.707107 0 3603.82 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '6.12303e-17 -1 0 0 1 6.12303e-17 0 5150 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '-0.707107 -0.707107 0 -6603.82 0.707107 -0.707107 0 3603.82 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '-1 -1.22461e-16 0 -8150 1.22461e-16 -1 0 0 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '-0.707107 0.707107 0 -6603.82 -0.707107 -0.707107 0 -3603.82 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '6.12303e-17 1 0 0 -1 6.12303e-17 0 -5150 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '0.707107 0.707107 0 6603.82 -0.707107 0.707107 0 -3603.82 0 0 1 0 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
Parsing matrix node; text value is '1 0 0 0 0 1 0 0 0 0 1 -5150 0.0 0.0 0.0 1.0'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
====== searching among library_effects the effect with id '__dd__Materials__RadRock_fx_0xca9e180'
LOG: 0 Opened mesh /usr/local/env/geant4/geometry/gdml/20131119-1632/g4_00.dae in 2494335 msec
LOG: 0 All files opened in 2518742 msec</pre>
</div>
<div class="section" id="min-after-geometry-cache-addition-but-exploded">
<h3><a class="toc-backref" href="#id2">11 min after Geometry Cache addition, but exploded!</a><a class="headerlink" href="#min-after-geometry-cache-addition-but-exploded" title="Permalink to this headline">¶</a></h3>
<p>Hmm, its faster but geometry is &#8220;exploded&#8221; into little pieces.</p>
<div class="highlight-python"><pre>******                 Reading face[ 95].V(0) =   45  (570-th of the index list) (face has 3 vertices)
*******                 Reading face[ 95].V(1) =   43  (572-th of the index list) (face has 3 vertices)
*******                 Reading face[ 95].V(2) =   40  (574-th of the index list) (face has 3 vertices)
****** LoadPolygonalListMesh (final  mesh size vn 50 vertsize 50 - fn 192 facesize 192)
**** Loading a Geometry Mesh **** (final   mesh size 50 50 - 192 192)
** instance_geometry with url #near-radslab-box-90xc8e73c0 (final mesh size 1246046 1246046 - 2452916 2452916)
LOG: 0 Opened mesh /usr/local/env/geant4/geometry/gdml/VDGX_20131121-1957/g4_00.dae in 657315 msec
LOG: 0 All files opened in 663948 msec</pre>
</div>
<div class="highlight-python"><pre>In [7]: 2518742./663948.
Out[7]: 3.7935832324218164

In [8]: 663948./1000./60.
Out[8]: 11.065799999999999</pre>
</div>
</div>
</div>
<div class="section" id="why-is-collada-importer-so-slow">
<h2><a class="toc-backref" href="#id3">Why is collada importer so slow ?</a><a class="headerlink" href="#why-is-collada-importer-so-slow" title="Permalink to this headline">¶</a></h2>
<p>/usr/local/env/graphics/meshlab/meshlab/src/meshlabplugins/io_collada/io_collada.cpp:</p>
<div class="highlight-python"><pre>104 bool ColladaIOPlugin::open(const QString &amp;formatName, const QString &amp;fileName, MeshModel &amp;m, int&amp; mask, const RichParameterSet &amp;, CallBackPos *cb, QWidget *parent)
...
118     if(formatName.toUpper() == tr("DAE"))
119     {
...
121         tri::io::InfoDAE  info;
122         if (!tri::io::ImporterDAE&lt;CMeshO&gt;::LoadMask(filename.c_str(), info))
123             return false;
...
129         int result = vcg::tri::io::ImporterDAE&lt;CMeshO&gt;::Open(m.cm, filename.c_str(),info);</pre>
</div>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/io_trimesh/import_dae.h:</p>
<div class="highlight-python"><pre>25 #define __VCGLIB_IMPORTERDAE
26
27 //importer for collada's files
28
29 #include &lt;wrap/dae/util_dae.h&gt;
30
31 // uncomment one of the following line to enable the Verbose debugging for the parsing
32 #define QDEBUG if(1) ; else {assert(0);}
33 //#define QDEBUG qDebug
34
35 namespace vcg {
36 namespace tri {
37 namespace io {
38     template&lt;typename OpenMeshType&gt;
39     class ImporterDAE : public UtilDAE
40     {
41   public:</pre>
</div>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/io_trimesh/import_dae.h:</p>
<div class="highlight-python"><pre>713         //merge all meshes in the collada's file in the templeted mesh m
714         //I assume the mesh
715
716         static int Open(OpenMeshType&amp; m,const char* filename, InfoDAE&amp; info, CallBackPos *cb=0)
717         {
718             (void)cb;
719
720             QDEBUG("----- Starting the processing of %s ------",filename);
721             //AdditionalInfoDAE&amp; inf = new AdditionalInfoDAE();
722             //info = new InfoDAE();
723
724             QDomDocument* doc = new QDomDocument(filename);
725             info.doc = doc;</pre>
</div>
<p>Code looks like it is not doing any caching, repeatedly searching DOM for for every refernence.</p>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/dae:</p>
<div class="highlight-python"><pre>478         /* Very important procedure
479             it has the task to finde the name of the image node corresponding to a given material id,
480             it assuemes that the material name that is passed have already been bound with the current bindings
481         */
482
483         inline static QDomNode textureFinder(QString&amp; boundMaterialName, QString &amp;textureFileName, const QDomDocument doc)
484         {
485             boundMaterialName.remove('#');
486             //library_material -&gt; material -&gt; instance_effect
487             QDomNodeList lib_mat = doc.elementsByTagName("library_materials");
488             if (lib_mat.size() != 1)
489                 return QDomNode();
490             QDomNode material = findNodeBySpecificAttributeValue(lib_mat.at(0),QString("material"),QString("id"),boundMaterialName);
491             if (material.isNull())
492                 return QDomNode();
493             QDomNodeList in_eff = material.toElement().elementsByTagName("instance_effect");
494             if (in_eff.size() == 0)
495                 return QDomNode();
496             QString url = in_eff.at(0).toElement().attribute("url");
497             if ((url.isNull()) || (url == ""))
498                 return QDomNode();
499             url = url.remove('#');
500       qDebug("====== searching among library_effects the effect with id '%s' ",qPrintable(url));
501             //library_effects -&gt; effect -&gt; instance_effect
502             QDomNodeList lib_eff = doc.elementsByTagName("library_effects");
503             if (lib_eff.size() != 1)
504                 return QDomNode();
505             QDomNode effect = findNodeBySpecificAttributeValue(lib_eff.at(0),QString("effect"),QString("id"),url);
506             if (effect.isNull())
507                 return QDomNode();
508             QDomNodeList init_from = effect.toElement().elementsByTagName("init_from");
509             if (init_from.size() == 0)
510                 return QDomNode();
511             QString img_id = init_from.at(0).toElement().text();
512             if ((img_id.isNull()) || (img_id == ""))
513                 return QDomNode();
514
515             //library_images -&gt; image
516             QDomNodeList libraryImageNodeList = doc.elementsByTagName("library_images");
517             qDebug("====== searching among library_images the effect with id '%s' ",qPrintable(img_id));
518             if (libraryImageNodeList.size() != 1)
519                 return QDomNode();
520             QDomNode imageNode = findNodeBySpecificAttributeValue(libraryImageNodeList.at(0),QString("image"),QString("id"),img_id);
521             QDomNodeList initfromNode = imageNode.toElement().elementsByTagName("init_from");
522             textureFileName= initfromNode.at(0).firstChild().nodeValue();
523             qDebug("====== the image '%s' has a %i init_from nodes text '%s'",qPrintable(img_id),initfromNode.size(),qPrintable(textureFileName));
524
525             return imageNode;
526         }</pre>
</div>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/dae/util_dae.h:</p>
<div class="highlight-python"><pre>249         inline static QDomNode findNodeBySpecificAttributeValue(const QDomNodeList&amp; ndl,const QString&amp; attrname,const QString&amp; attrvalue)
250         {
251             int ndl_size = ndl.size();
252             int ind = 0;
253             while(ind &lt; ndl_size)
254             {
255                 QString st = ndl.at(ind).toElement().attribute(attrname);
256                 if (st == attrvalue)
257                     return ndl.at(ind);
258                 ++ind;
259             }
260             return QDomNode();
261         }
262
263         inline static QDomNode findNodeBySpecificAttributeValue(const QDomNode n,const QString&amp; tag,const QString&amp; attrname,const QString&amp; attrvalue)
264         {
265             return findNodeBySpecificAttributeValue(n.toElement().elementsByTagName(tag),attrname,attrvalue);
266         }
267
268         inline static QDomNode findNodeBySpecificAttributeValue(const QDomDocument n,const QString&amp; tag,const QString&amp; attrname,const QString&amp; attrvalue)
269         {
270             return findNodeBySpecificAttributeValue(n.elementsByTagName(tag),attrname,attrvalue);
271         }</pre>
</div>
</div>
<div class="section" id="separate-plugin-build-output">
<h2><a class="toc-backref" href="#id4">Separate plugin build output</a><a class="headerlink" href="#separate-plugin-build-output" title="Permalink to this headline">¶</a></h2>
<p>First section all in the <tt class="docutils literal"><span class="pre">Open(</span></tt>  /usr/local/env/graphics/meshlab/vcglib/wrap/io_trimesh/import_dae.h:</p>
<div class="highlight-python"><pre>----- Starting the processing of /usr/local/env/geant4/geometry/gdml/VDGX_20131121-1957/g4_00.dae ------
File Contains 1 Scenes
Scene 0 contains 1 instance_visual_scene
instance_visual_scene 0 refers DefaultScene
instance_visual_scene DefaultScene has 1 children
Processing Visual Scene child 0 - of type 'node'</pre>
</div>
<p>Subsequentluy goes recursive /usr/local/env/graphics/meshlab/vcglib/wrap/io_trimesh/import_dae.h</p>
<div class="highlight-python"><pre>806                         if(node.toElement().tagName()=="node")
807                         {
808                             ColladaMesh newMesh;
809                             AddNodeToMesh(node.toElement(), newMesh, baseTr,info);
810                             tri::Append&lt;OpenMeshType,ColladaMesh&gt;::Mesh(m,newMesh);
811                         }</pre>
</div>
<div class="highlight-python"><pre>590         static void AddNodeToMesh(QDomElement node,
591                                                             ColladaMesh&amp; m, Matrix44f curTr,
592                                                             InfoDAE&amp; info)
593         {
594                 QDEBUG("Starting processing &lt;node&gt; with id %s",qPrintable(node.attribute("id")));
595
596                 curTr = curTr * getTransfMatrixFromNode(node);
597
598                 QDomNodeList geomNodeList = node.elementsByTagName("instance_geometry");
599                 for(int ch = 0;ch &lt; geomNodeList.size();++ch)
600                 {
601                     QDomElement instGeomNode= geomNodeList.at(ch).toElement();
602                     if(instGeomNode.parentNode()==node) // process only direct child
603                     {
604                         QDEBUG("** instance_geometry with url %s (intial mesh size %i %i T = %i)",qPrintable(instGeomNode.attribute("url")),m.vn,m.fn,m.textures.size());
605                         //assert(m.textures.size()&gt;0 == HasPerWedgeTexCoord(m));
606                         QString geomNode_url;
607                         referenceToANodeAttribute(instGeomNode,"url",geomNode_url);
608                         QDomNode refNode = findNodeBySpecificAttributeValue(*(info.doc),"geometry","id",geomNode_url);
609                         QDomNodeList bindingNodes = instGeomNode.toElement().elementsByTagName("bind_material");
610                         QMap&lt;QString,QString&gt; materialBindingMap;
611                         if( bindingNodes.size()&gt;0) {
612                             QDEBUG("**    instance_geometry has a material binding");
613                             GenerateMaterialBinding(instGeomNode,materialBindingMap);
614                         }
615

////  this is the place to cache the mesh keyed by refNode , is ColladaMesh up to living in a container ?

616                         ColladaMesh newMesh;
617 //                      newMesh.face.EnableWedgeTex();
618                         LoadGeometry(newMesh, info, refNode.toElement(),materialBindingMap);
619                         tri::UpdatePosition&lt;ColladaMesh&gt;::Matrix(newMesh,curTr);
620                         tri::Append&lt;ColladaMesh,ColladaMesh&gt;::Mesh(m,newMesh);
621                         QDEBUG("** instance_geometry with url %s (final mesh size %i %i - %i %i)",qPrintable(instGeomNode.attribute("url")),m.vn,m.vert.size(),m.fn,m.face.size());
622                     }
623                 }</pre>
</div>
<p>/usr/local/env/graphics/meshlab/vcglib/vcg/complex/complex.h:</p>
<div class="highlight-python"><pre>415 private:
416     // TriMesh cannot be copied. Use Append (see vcg/complex/append.h)
417   TriMesh operator =(const TriMesh &amp;  /*m*/){assert(0);return TriMesh();}
418     TriMesh(const TriMesh &amp; ){}
419</pre>
</div>
<div class="highlight-python"><pre>Starting processing &lt;node&gt; with id top
getTrans form node with tag node
Found a instance_node with url 'World0xc7ba680'
Starting processing &lt;node&gt; with id World0xc7ba680
getTrans form node with tag node
** instance_geometry with url #WorldBox0xc8e27e0 (intial mesh size 0 0 T = 0)
**    instance_geometry has a material binding
++++ Found 1 instance_material binding
++++++ WHITE -&gt; #__dd__Materials__Vacuum0xbd75258
**** Loading a Geometry Mesh **** (initial mesh size 0 0)
****** LoadPolygonalListMesh (initial mesh size 8 0)
******    material id 'WHITE' -&gt; '#__dd__Materials__Vacuum0xbd75258'
====== searching among library_effects the effect with id '__dd__Materials__Vacuum_fx_0xbd75258'
******   but we were not able to find the corresponding image node
*******                 Start Reading faces. Attributes Offsets: offtx 0 - offnm 1 - offcl 0
*******                 Reading face[  0].V(0) =    0  (0-th of the index list) (face has 4 vertices)
*******                 Reading face[  0].V(1) =    3  (2-th of the index list) (face has 4 vertices)
*******                 Reading face[  0].V(2) =    2  (4-th of the index list) (face has 4 vertices)
*******                 Reading face[  0].V(3) =    1  (6-th of the index list) (face has 4 vertices)
*******                 Reading face[  1].V(0) =    4  (8-th of the index list) (face has 4 vertices)
*******                 Reading face[  1].V(1) =    7  (10-th of the index list) (face has 4 vertices)</pre>
</div>
</div>
<div class="section" id="before-profiling-optimising-need-to-check-the-svn-future-of-meshlab-vcglib">
<h2><a class="toc-backref" href="#id5">Before profiling/optimising need to check the SVN future of meshlab/vcglib</a><a class="headerlink" href="#before-profiling-optimising-need-to-check-the-svn-future-of-meshlab-vcglib" title="Permalink to this headline">¶</a></h2>
<p>Sourceforge yuck.</p>
<ul class="simple">
<li><a class="reference external" href="http://sourceforge.net/p/meshlab/code/6239/log/?path=/trunk">http://sourceforge.net/p/meshlab/code/6239/log/?path=/trunk</a></li>
</ul>
<p>Slow code is actually in vcglib</p>
<ul class="simple">
<li><a class="reference external" href="http://vcg.isti.cnr.it/~cignoni/newvcglib/html/">http://vcg.isti.cnr.it/~cignoni/newvcglib/html/</a></li>
<li><a class="reference external" href="http://sourceforge.net/projects/vcg/">http://sourceforge.net/projects/vcg/</a></li>
<li><a class="reference external" href="http://svn.code.sf.net/p/vcg/code/trunk/vcglib/">http://svn.code.sf.net/p/vcg/code/trunk/vcglib/</a></li>
</ul>
<div class="highlight-python"><pre>simon:dae blyth$ vcglib-cd
simon:vcglib_trunk blyth$ pwd
/usr/local/env/graphics/vcglib_trunk
simon:vcglib_trunk blyth$ cd wrap/dae
simon:dae blyth$
simon:dae blyth$ svn log . -v
------------------------------------------------------------------------
r4985 | granzuglia | 2013-10-25 04:51:03 +0800 (Fri, 25 Oct 2013) | 1 line
Changed paths:
   M /trunk/vcglib/wrap/dae/poly_triangulator.h

- added missing include file
------------------------------------------------------------------------
r4983 | granzuglia | 2013-10-25 00:18:13 +0800 (Fri, 25 Oct 2013) | 1 line
Changed paths:
   M /trunk/vcglib/wrap/dae/colladaformat.h
   A /trunk/vcglib/wrap/dae/poly_triangulator.h
   M /trunk/vcglib/wrap/dae/util_dae.h

- updated collada format in order to manage alpha channel colour
------------------------------------------------------------------------
r4861 | granzuglia | 2013-03-25 03:51:43 +0800 (Mon, 25 Mar 2013) | 2 lines
Changed paths:
   M /trunk/vcglib/wrap/dae/util_dae.h
   M /trunk/vcglib/wrap/dae/xmldocumentmanaging.h

- small changes for qt5.0 compatibility

------------------------------------------------------------------------
r4752 | cignoni | 2012-11-28 06:31:48 +0800 (Wed, 28 Nov 2012) | 1 line
Changed paths:
   M /trunk/vcglib/wrap/dae/colladaformat.h
   M /trunk/vcglib/wrap/io_trimesh/export_idtf.h

Added a few missing const specifiers
------------------------------------------------------------------------
r4180 | cignoni | 2011-10-05 23:04:40 +0800 (Wed, 05 Oct 2011) | 1 line
Changed paths:
   A /trunk/vcglib (from /trunk/vcglib:4178)
   R /trunk/vcglib/apps (from /trunk/vcglib/apps:4178)
   R /trunk/vcglib/apps/metro (from /trunk/vcglib/apps/metro:4178)
   R /trunk/vcglib/apps/metro/defs.h (from /trunk/vcglib/apps/metro/defs.h:4178)
   R /trunk/vcglib/apps/metro/history.txt (from /trunk/vcglib/apps/metro/history.txt:4178)</pre>
</div>
<div class="highlight-python"><pre>simon:meshlab blyth$ diff -r --brief $(meshlab-dir)/../../vcglib/wrap/dae $(vcglib-dir)/wrap/dae
Files /usr/local/env/graphics/meshlab/meshlab/src/../../vcglib/wrap/dae/colladaformat.h and /usr/local/env/graphics/vcglib_trunk/wrap/dae/colladaformat.h differ
Only in /usr/local/env/graphics/vcglib_trunk/wrap/dae: poly_triangulator.h
Files /usr/local/env/graphics/meshlab/meshlab/src/../../vcglib/wrap/dae/util_dae.h and /usr/local/env/graphics/vcglib_trunk/wrap/dae/util_dae.h differ
Files /usr/local/env/graphics/meshlab/meshlab/src/../../vcglib/wrap/dae/xmldocumentmanaging.h and /usr/local/env/graphics/vcglib_trunk/wrap/dae/xmldocumentmanaging.h differ
simon:meshlab blyth$</pre>
</div>
</div>
<div class="section" id="fix-by-addition-of-a-geometry-cache">
<h2><a class="toc-backref" href="#id6">Fix by addition of a geometry cache</a><a class="headerlink" href="#fix-by-addition-of-a-geometry-cache" title="Permalink to this headline">¶</a></h2>
<p>Using a <tt class="docutils literal"><span class="pre">QCache</span></tt> would have been nice for eviction control to restrict memory usage,
but the ColladaMesh type structure is too contorted to be usable
outside of its definition class, hence the <tt class="docutils literal"><span class="pre">void*</span></tt> cheating.</p>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/dae/util_dae.h:</p>
<div class="highlight-python"><pre>52 #if defined SCB_COLLADA_GEOMETRY_CACHE
53 #include &lt;QHash&gt;
54 #endif
55
56 namespace vcg {
57 namespace tri {
58 namespace io {
59
60
61
62     class InfoDAE  : public AdditionalInfo
63     {
64         public:
65
66         InfoDAE() :AdditionalInfo(){
67             doc = NULL;
68             textureIdMap.clear();
69         }
70
71         ~InfoDAE(){
72             if(doc!=NULL) delete doc;
73 #if defined SCB_COLLADA_GEOMETRY_CACHE
74             geometry_cache.clear() ;
75 #endif
76         }
77
78         QDomDocument* doc;
79         QMap&lt;QString,int&gt; textureIdMap;
80
81 #if defined SCB_COLLADA_GEOMETRY_CACHE
82        QHash&lt;QString, void* &gt; geometry_cache ;
83 #endif
84
85
86     };</pre>
</div>
<p>/usr/local/env/graphics/meshlab/vcglib/wrap/io_trimesh/import_dae.h:</p>
<div class="highlight-python"><pre>591         static void AddNodeToMesh(QDomElement node,
592                                                             ColladaMesh&amp; m, Matrix44f curTr,
593                                                             InfoDAE&amp; info)
594         {
595                 QDEBUG("Starting processing &lt;node&gt; with id %s",qPrintable(node.attribute("id")));
596
597                 curTr = curTr * getTransfMatrixFromNode(node);
598
599                 QDomNodeList geomNodeList = node.elementsByTagName("instance_geometry");
600                 for(int ch = 0;ch &lt; geomNodeList.size();++ch)
601                 {
602                     QDomElement instGeomNode= geomNodeList.at(ch).toElement();
603                     if(instGeomNode.parentNode()==node) // process only direct child
604                     {
605                         QDEBUG("** instance_geometry with url %s (intial mesh size %i %i T = %i)",qPrintable(instGeomNode.attribute("url")),m.vn,m.fn,m.textures.size());
606                         //assert(m.textures.size()&gt;0 == HasPerWedgeTexCoord(m));
607                         QString geomNode_url;
608                         referenceToANodeAttribute(instGeomNode,"url",geomNode_url);
609
610 #if defined SCB_COLLADA_GEOMETRY_CACHE
611                        // cache them for reuse
612                         bool geometry_cached = info.geometry_cache.contains(geomNode_url) ;
613                         ColladaMesh* newMeshPtr ;
614
615                         if( geometry_cached )
616                         {
617                             QDEBUG("**   instance_geometry cache hit %s ", qPrintable(geomNode_url));
618                             newMeshPtr = (ColladaMesh*)info.geometry_cache.value(geomNode_url) ;
619                         }
620                         else
621                         {
622                             QDEBUG("**   instance_geometry CACHE MISS %s ", qPrintable(geomNode_url));
623                             newMeshPtr = new ColladaMesh ;
624
625                             QDomNode refNode = findNodeBySpecificAttributeValue(*(info.doc),"geometry","id",geomNode_url);
626                             QDomNodeList bindingNodes = instGeomNode.toElement().elementsByTagName("bind_material");
627                             QMap&lt;QString,QString&gt; materialBindingMap;
628                             if( bindingNodes.size()&gt;0) {
629                                 QDEBUG("**    instance_geometry has a material binding");
630                                 GenerateMaterialBinding(instGeomNode,materialBindingMap);
631                              }
632
633                              LoadGeometry(*newMeshPtr, info, refNode.toElement(),materialBindingMap);
634                              info.geometry_cache.insert(geomNode_url, (void*)newMeshPtr) ;
635                         }
636                         ColladaMesh&amp; newMesh = *newMeshPtr ;
637 #else
638
639                         QDomNode refNode = findNodeBySpecificAttributeValue(*(info.doc),"geometry","id",geomNode_url);
640                         QDomNodeList bindingNodes = instGeomNode.toElement().elementsByTagName("bind_material");
641                         QMap&lt;QString,QString&gt; materialBindingMap;
642                         if( bindingNodes.size()&gt;0) {
643                             QDEBUG("**    instance_geometry has a material binding");
644                             GenerateMaterialBinding(instGeomNode,materialBindingMap);
645                         }
646                         ColladaMesh newMesh;
647 //                      newMesh.face.EnableWedgeTex();
648                         LoadGeometry(newMesh, info, refNode.toElement(),materialBindingMap);
649 #endif
650                         tri::UpdatePosition&lt;ColladaMesh&gt;::Matrix(newMesh,curTr);
651                         tri::Append&lt;ColladaMesh,ColladaMesh&gt;::Mesh(m,newMesh);
652                         QDEBUG("** instance_geometry with url %s (final mesh size %i %i - %i %i)",qPrintable(instGeomNode.attribute("url")),m.vn,m.vert.size(),m.fn,m.face.size());</pre>
</div>
<p>Build this from <tt class="docutils literal"><span class="pre">graphics/meshlab/meshlabplugins/io_collada</span></tt> with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">meshlab</span><span class="o">-</span><span class="n">collada</span><span class="o">-</span><span class="n">make</span>
</pre></div>
</div>
<p>Install into the separately built meshlabserver with:</p>
<div class="highlight-python"><pre>simon:io_collada blyth$ t meshlab-collada-install
meshlab-collada-install is a function
meshlab-collada-install ()
{
    cd_func $(env-home)/graphics/meshlab/meshlabplugins/io_collada;
    local dest=../../distrib/plugins/;
    mkdir -p $dest;
    local plug=libio_collada.dylib;
    local target=$dest/$plug;
    rm -rf $target;
    [ -f $plug ] &amp;&amp; cp $plug $target
}</pre>
</div>
<div class="section" id="exploded-due-to-updateposition">
<h3><a class="toc-backref" href="#id7">Exploded due to UpdatePosition</a><a class="headerlink" href="#exploded-due-to-updateposition" title="Permalink to this headline">¶</a></h3>
<p>Contrary to assumption that this was just setting a matrix, it is actually iterating
over all vertices and multiplying by the matrix.:</p>
<div class="highlight-python"><pre>650                         tri::UpdatePosition&lt;ColladaMesh&gt;::Matrix(newMesh,curTr);</pre>
</div>
<p>Thus the cached <tt class="docutils literal"><span class="pre">newMesh</span></tt> position keeps changing for each use.
Isolate the cache from its usage with Append, there is no copy ctor:</p>
<div class="highlight-python"><pre>636                         ColladaMesh newMesh ;   // avoid exploding the geometry by keeping the cached mesh and newMesh distinct
637                         tri::Append&lt;ColladaMesh,ColladaMesh&gt;::Mesh(newMesh,*cacheMeshPtr);</pre>
</div>
<div class="highlight-python"><pre>****** LoadPolygonalListMesh (final  mesh size vn 50 vertsize 50 - fn 192 facesize 192)
**** Loading a Geometry Mesh **** (final   mesh size 50 50 - 192 192)
** instance_geometry with url #near-radslab-box-90xc8e73c0 (final mesh size 1246046 1246046 - 2452916 2452916)
LOG: 0 Opened mesh /usr/local/env/geant4/geometry/gdml/VDGX_20131121-1957/g4_00.dae in 587294 msec
LOG: 0 All files opened in 594080 msec</pre>
</div>
<p>Thats better, geometry looks OK, and loading in less than 10 min on ancient laptop:</p>
<div class="highlight-python"><pre>In [9]: 594080./1000./60.
Out[9]: 9.9013333333333335</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../meshlab_collada_materials/" title="MeshLab Collada Materials"
             >next</a> |</li>
        <li class="right" >
          <a href="../meshlabplugins/" title="Meshlab Plugins"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >Graphics</a> &raquo;</li>
          <li><a href="../" >meshlab</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>