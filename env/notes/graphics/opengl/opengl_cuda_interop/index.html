<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenGL CUDA Interop &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="opengl" href="../" />
    <link rel="next" title="OpenGL GLUT" href="../opengl_glut/" />
    <link rel="prev" title="OpenGL Vertex Buffer Object VBO" href="../opengl_vertex_buffer_object/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../opengl_glut/" title="OpenGL GLUT"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../opengl_vertex_buffer_object/" title="OpenGL Vertex Buffer Object VBO"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >Graphics</a> &raquo;</li>
          <li><a href="../" accesskey="U">opengl</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">Graphics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../meshlab/">meshlab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../collada/">collada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cgal/">CGAL Computational Geometry Algorithms Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mesh/">mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vrml/">vrml</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">opengl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../transformations/">transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../panda3d/">panda3d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pipeline/">pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math/">math</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glumpy/">glumpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scenekit/">scenekit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pyopengl/">pyopengl</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/graphics/opengl/opengl_cuda_interop.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../opengl_vertex_buffer_object/"
                        title="previous chapter">OpenGL Vertex Buffer Object VBO</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../opengl_glut/"
                        title="next chapter">OpenGL GLUT</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="opengl-cuda-interop">
<h1>OpenGL CUDA Interop<a class="headerlink" href="#opengl-cuda-interop" title="Permalink to this headline">¶</a></h1>
<div class="section" id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Present OpenGL projected geometry (probably wireframes) on top of PyCUDA/Chroma ray-traced images</li>
<li>visualize Chroma/CUDA calculated photon propagations</li>
<li>sharing to avoid duplication in GPU memory</li>
</ol>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Two aspects:</p>
<ol class="arabic simple">
<li>getting CUDA and OpenGL to work together</li>
<li>finding useful way of presenting CUDA and OpenGL pixels together</li>
</ol>
</div>
<div class="section" id="what-can-be-shared">
<h2>What can be shared ?<a class="headerlink" href="#what-can-be-shared" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>vertex and face arrays</li>
<li>pixel array results from Chroma/CUDA ray tracing</li>
<li>photon propagation position histories</li>
<li>TODO: tot up memory usage from Chroma, how much from BVH nodes, vertices, faces (materials and surfaces expected to be negligible)</li>
</ul>
</div>
<div class="section" id="pbo-interop">
<h2>PBO interop<a class="headerlink" href="#pbo-interop" title="Permalink to this headline">¶</a></h2>
<p>Pixel Buffer Objects, seem to be the way to handover CUDA derived pixels to OpenGL without
taking the slow route via the host. Pixels always stay on the GPU, unless need to write
an image file.</p>
<ul class="simple">
<li><a class="reference external" href="http://www.drdobbs.com/architecture-and-design/cuda-supercomputing-for-the-masses-part/222600097">http://www.drdobbs.com/architecture-and-design/cuda-supercomputing-for-the-masses-part/222600097</a></li>
</ul>
</div>
<div class="section" id="vbo-interop">
<h2>VBO interop<a class="headerlink" href="#vbo-interop" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.icp.uni-stuttgart.de/~icp/CUDA_examples">http://www.icp.uni-stuttgart.de/~icp/CUDA_examples</a></li>
</ul>
<p>Ideal gas with direct OpenGL visualization, uses the CUDA-OpenGL-binding to render an ideal gas in a rotating box.
An OpenGL vertex buffer is written directly from CUDA, which runs the ideal gas as a very simple kernel.</p>
<div class="highlight-python"><pre>simon:t blyth$ curl -L -O http://www.icp.uni-stuttgart.de/~icp/mediawiki/images/b/bf/PyGL.tar.gz
simon:t blyth$ tar ztvf PyGL.tar.gz
drwxr-xr-x arnolda/icp       0 2011-02-08 01:09:50 pygl/
-rw-r--r-- arnolda/icp    5359 2011-02-08 01:03:54 pygl/pygl.py
-rw-r--r-- arnolda/icp   35147 2011-02-08 01:08:11 pygl/COPYING
-rw-r--r-- arnolda/icp     324 2011-02-08 01:09:44 pygl/README</pre>
</div>
<p>CUDA calculates point positions, from pygl.py:</p>
<div class="highlight-python"><pre>057     def GLInit(self):
...
106         self.gas_kernel = gpu_code.get_function("gas_kernel")
107         self.gas_kernel.prepare("PPPi", (512,1,1))
108
109         # create vbo buffer
110         self.vbo = glGenBuffers(1)
111         glBindBuffer(GL_ARRAY_BUFFER, self.vbo)
112         glBufferData(GL_ARRAY_BUFFER,
113                      np.random.random(4*n_particles).astype(np.float32), GL_DYNAMIC_DRAW)
114         glBindBuffer(GL_ARRAY_BUFFER, 0)
115         # CudaGL interop for the VBO
116         self.resource = cudagl.BufferObject(int(self.vbo))
117
118     def calculate_vertices(self):
119         # map 1 VBO given by vbo_resource, synchronize with stream 0
120         map = self.resource.map()
121         g_vbo = map.device_ptr()
122         self.gas_kernel.prepared_call(
123             ((n_particles+511)/512,1),
124             g_vbo, self.g_positions, self.g_velocities, np.intc(n_particles))
125         # unmap again
126         map.unmap()
127
128     def GLDraw(self):
129         self.sim_time += 0.1
130
131         self.calculate_vertices()
...
...         OpenGL setup matrices etc..
...
142         # render vbo as buffer of points
143         glBindBuffer(GL_ARRAY_BUFFER, self.vbo)
144         glVertexPointer(4, GL_FLOAT, 0, None)
145
146         glEnableClientState(GL_VERTEX_ARRAY)
147         glColor3f(0.0, 0.0, 1.0)
148         glDrawArrays(GL_POINTS, 0, n_particles)
149         glDisableClientState(GL_VERTEX_ARRAY)
150</pre>
</div>
<p>In summary to get from an OpenGL VBO name to a CUDA usable pointer into the mapped buffer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span> <span class="o">=</span> <span class="n">cudagl</span><span class="o">.</span><span class="n">BufferObject</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbo</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">()</span>
<span class="n">g_vbo</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">device_ptr</span><span class="p">()</span>
<span class="c"># now pass that as parameter to the CUDA prepared kernel call</span>
<span class="nb">map</span><span class="o">.</span><span class="n">unmap</span><span class="p">()</span>    <span class="c"># presumably says that are done with it, allowing OpenGL to resume control</span>
</pre></div>
</div>
<div class="section" id="adapt-to-visualize-chroma-photons">
<h3>Adapt to visualize Chroma photons<a class="headerlink" href="#adapt-to-visualize-chroma-photons" title="Permalink to this headline">¶</a></h3>
<p>This looks to be a good way for visualizing simulated photons, but not ray traced pixels.</p>
</div>
</div>
<div class="section" id="presenting-cuda-derived-pixels-together-with-opengl-ones">
<h2>Presenting CUDA derived pixels together with OpenGL ones<a class="headerlink" href="#presenting-cuda-derived-pixels-together-with-opengl-ones" title="Permalink to this headline">¶</a></h2>
<div class="section" id="texture-pinned-to-the-far-plane">
<h3>Texture pinned to the far plane ?<a class="headerlink" href="#texture-pinned-to-the-far-plane" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://www.opengl.org/discussion_boards/showthread.php/174191-texture-as-a-background">http://www.opengl.org/discussion_boards/showthread.php/174191-texture-as-a-background</a></li>
</ul>
</div>
<div class="section" id="glut-overlay">
<h3>GLUT Overlay<a class="headerlink" href="#glut-overlay" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://pyopengl.sourceforge.net/documentation/manual-3.0/glutEstablishOverlay.html">http://pyopengl.sourceforge.net/documentation/manual-3.0/glutEstablishOverlay.html</a></li>
<li><a class="reference external" href="http://www.davidwparker.com/2011/12/02/opengl-screencast-video-18-overlays/">http://www.davidwparker.com/2011/12/02/opengl-screencast-video-18-overlays/</a></li>
</ul>
</div>
<div class="section" id="glsl-shader-texture-overlay">
<h3>GLSL shader texture overlay<a class="headerlink" href="#glsl-shader-texture-overlay" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/12218419/overlay-an-image-over-video-using-opengl-es-shaders">http://stackoverflow.com/questions/12218419/overlay-an-image-over-video-using-opengl-es-shaders</a></li>
<li><a class="reference external" href="http://www.clockworkcoders.com/oglsl/tutorial8.htm">http://www.clockworkcoders.com/oglsl/tutorial8.htm</a></li>
<li><a class="reference external" href="http://antongerdelan.net/opengl/overlays.html">http://antongerdelan.net/opengl/overlays.html</a></li>
</ul>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../opengl_glut/" title="OpenGL GLUT"
             >next</a> |</li>
        <li class="right" >
          <a href="../opengl_vertex_buffer_object/" title="OpenGL Vertex Buffer Object VBO"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >Graphics</a> &raquo;</li>
          <li><a href="../" >opengl</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>