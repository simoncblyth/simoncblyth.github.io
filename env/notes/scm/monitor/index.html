<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Monitor &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="SCM" href="../" />
    <link rel="next" title="HKU (hub HKU)" href="hku/" />
    <link rel="prev" title="Notes" href="../notes/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hku/" title="HKU (hub HKU)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../notes/" title="Notes"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">SCM</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">SCM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../history/">SCM History</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scm-backup/">SCM BACKUP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/">Notes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/">Dev notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../svn2git/svn2git/">SVN2GIT via <em>git svn clone</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../altbackup/">Altbackup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../altbackup/#bash-wrapper-for-altbackup-py">bash wrapper for <em>altbackup.py</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../altquery/">Bitten Querying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bitbucket/">bitbucket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../github/">github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sourceforge/">SourceForge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hosting/">SCM Hosting Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binary_handling/">Binary releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/scm/monitor/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../notes/"
                        title="previous chapter">Notes</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="hku/"
                        title="next chapter">HKU (hub HKU)</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="monitor">
<h1>Monitor<a class="headerlink" href="#monitor" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#setup" id="id1">Setup</a></li>
<li><a class="reference internal" href="#how-the-plotting-work" id="id2">How the plotting work</a></li>
<li><a class="reference internal" href="#configuring-the-monitoring" id="id3">Configuring the monitoring</a></li>
<li><a class="reference internal" href="#manual-testing" id="id4">Manual Testing</a></li>
<li><a class="reference internal" href="#automation" id="id5">Automation</a></li>
<li><a class="reference internal" href="#improvement-ideas" id="id6">Improvement Ideas</a></li>
</ul>
</div>
<p>Plots monitoring tarball sizes and counts for Trac and Subversion instances
that reside on <strong>hub</strong> servers at various institutions. Typically each hub has multiple backup nodes
with the corresponding plots being presented by hub.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="hku/">HKU (hub HKU)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hku/#d8r-dayabay8core">D8R : dayabay8core</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ihep/">IHEP (hub ZZ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ihep/#sdu-shandong-university-backup">SDU : Shandong University Backup</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="setup">
<h2><a class="toc-backref" href="#id1">Setup</a><a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>To setup the auto-monitoring script on a new node requires the below
steps as described on this page.</p>
<ol class="arabic simple">
<li>configuring</li>
<li>manual testing</li>
<li>automation</li>
</ol>
</div>
<div class="section" id="how-the-plotting-work">
<h2><a class="toc-backref" href="#id2">How the plotting work</a><a class="headerlink" href="#how-the-plotting-work" title="Permalink to this headline">¶</a></h2>
<p>A globbed toctree directive is used to pull in all rst pages from <cite>env/scm/monitor/</cite>
These pages use the sphinx extension <cite>env.sphinxext.stockchart</cite> to embed raw html
containing javascript and a single div element into the html output derived from
the reStructuredText source (use show source to see this).</p>
<p>On page load the javascript runs an ajax query to pull in the plot data and options from
static JSON files for each remote node residing in <a class="reference external" href="/data/">/data/</a>.
These static files are created by the <tt class="docutils literal"><span class="pre">scm-backup-monitor</span></tt> which uses <strong>fabric</strong>
to gather info from remote nodes and updates an SQLite DB.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the plots are rendered on the client, this approach as it stands is thus limited to small numbers of things to monitor</p>
</div>
</div>
<div class="section" id="configuring-the-monitoring">
<h2><a class="toc-backref" href="#id3">Configuring the monitoring</a><a class="headerlink" href="#configuring-the-monitoring" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">update env checkout in <strong>root</strong> home directory</p>
</li>
<li><p class="first">copy two config files into <strong>root</strong> home:</p>
<div class="highlight-python"><pre>cd
cp ~blyth/.scm_monitor.cnf .
cp ~blyth/.libfab.cnf .</pre>
</div>
</li>
</ol>
<p>The ZZ section of <cite>.scm_monitor.cnf</cite> configures where
a database file and output json files are stored.:</p>
<div class="highlight-python"><pre>[dayabay] /home/blyth/e &gt; cat ~blyth/.scm_monitor.cnf

[ZZ]
srvnode = dayabay
dbpath = $LOCAL_BASE/env/scm/scm_backup_monitor.db
jspath = $APACHE_HTDOCS/data/scm_backup_monitor_%(node)s.json
select = svn/dybsvn tracs/dybsvn svn/dybaux tracs/dybaux
reporturl = http://dayabay.ihep.ac.cn:8080/e/scm/monitor/%(srvnode)s/

[WW]
message = "query the cms02 hub backup on cms01, as I do not have access to the SDU one "
srvnode = cms02
dbpath = $LOCAL_BASE/env/scm/scm_backup_monitor.db
jspath = $HOME/local/nginx/html/data/scm_backup_monitor_%(node)s.json
select = repos/env tracs/env repos/aberdeen tracs/aberdeen repos/tracdev tracs/tracdev repos/heprez tracs/heprez
reporturl = http://dayabay.ihep.ac.cn:8080/e/scm/monitor/%(srvnode)s/</pre>
</div>
<p>The <cite>ZZ = SDU</cite> in the <strong>HUB</strong> section of <cite>.libfab.cnf</cite>  configures
the node tags of remote nodes on which to look for tarballs, using the <strong>fabric</strong> python module
to run commands over ssh:</p>
<div class="highlight-python"><pre>[dayabay] /home/blyth/e &gt; cat ~blyth/.libfab.cnf

[HUB]
ZZ = SDU
G = Z9:229
C2 = C H1
WW = C

[ENV]
verbose = True
timeout = 2</pre>
</div>
</div>
<div class="section" id="manual-testing">
<h2><a class="toc-backref" href="#id4">Manual Testing</a><a class="headerlink" href="#manual-testing" title="Permalink to this headline">¶</a></h2>
<p>To manually test operation run the <cite>monitor.py</cite> script as shown below:</p>
<div class="highlight-python"><pre>mkdir -p /var/www/html/data    ## create output dir for json plot data if not already existing

## have to use local python to pickup needed modules : fabric, converter, ...

env-
scm-backup-
                 ## setup environment, eg APACHE_HTDOCS, LOCAL_BASE referred to in the config

export LOCAL_PYTHON=/home/blyth/local/python/Python-2.5.6
export LD_LIBRARY_PATH=$LOCAL_PYTHON/lib
export PATH=$LOCAL_PYTHON/bin:$PATH

~/env/scm/monitor.py</pre>
</div>
</div>
<div class="section" id="automation">
<h2><a class="toc-backref" href="#id5">Automation</a><a class="headerlink" href="#automation" title="Permalink to this headline">¶</a></h2>
<p>The running of the <cite>monitor.py</cite> is done as part of the standard <cite>scm-backup-nightly</cite> function which can
be invoked via a crontab line such as the below:</p>
<div class="highlight-python"><pre>[root@cms02 env]# crontab -l
SHELL = /bin/bash
16 18 * * *  ( export HOME=/root ; export NODE=cms02 ; export MAILTO=blyth@hep1.phys.ntu.edu.tw ; export ENV_HOME=/home/blyth/env ; . /home/blyth/env/env.bash ; env-  ; scm-backup- ; scm-backup-nightly ) &gt;  /var/scm/log/scm-backup-nightly-$(date +"\%a").log 2&gt;&amp;1</pre>
</div>
<p>When adding a new node, the <cite>scm-backup-nightly</cite> needs updating to add the running of the monitor script.:</p>
<div class="highlight-python"><pre>[root@cms02 env]# scm-backup-
[root@cms02 env]# t scm-backup-nightly
scm-backup-nightly is a function
scm-backup-nightly ()
{
    local msg="=== $FUNCNAME :";
    echo;
    echo $msg $(date) @@@ scm-backup-checkscp;
    scm-backup-checkscp;
    echo;
    echo $msg $(date) @@@ scm-backup-all;
    scm-backup-all;
    echo;
    echo $msg $(date) @@@ scm-backup-rsync ... performing transfers that i control;
    scm-backup-rsync;
    echo;
    echo $msg $(date) @@@ scm-backup-parasitic ... monitoring transfers that i do not control... i just receive the tarballs;
    case $NODE_TAG in
        C2 | C2R)
            scm-backup-parasitic ZZ C
        ;;
        *)
            echo $msg no parasitic monitoring is configured on NODE_TAG $NODE_TAG
        ;;
    esac;
    echo;
    echo $msg $(date) @@@ scm-backup-monitor ... fabric remote tarball checking;
    case $NODE_TAG in
        G)
            scm-backup-monitor- G
        ;;
        C2 | C2R)
            scm-backup-monitor- C2
        ;;
        *)
            echo $msg scm-backup-monitor not yet implemented on $NODE_TAG
        ;;
    esac;
    echo;
    echo $msg $(date) @@@ scm-backup-nightly ... completed;
    echo
}
[root@cms02 env]#</pre>
</div>
</div>
<div class="section" id="improvement-ideas">
<h2><a class="toc-backref" href="#id6">Improvement Ideas</a><a class="headerlink" href="#improvement-ideas" title="Permalink to this headline">¶</a></h2>
<p>The inclusion of inline RST status tables (indicating what caused problems)
in the output means that the html must be updated after each monitoring run.
This is done by <cite>scm-backup-monitor-</cite> and is a potential source of fragility as documentation is
updated for the project.
Prior to adding these RST tables it was not necessary to update the html every time as the plots
are dynamically included by the javascript loading the json on page load. Possibly a javascript
library for rendering tables might avoid the need to regenerate the html every time allowing the
table content to be pulled in from static json files.</p>
<p>Somewhat conversly it is limiting that precisely the same plots are re-rendered
for every client in the browser. It would be more efficient to render plots once when data is updated
and have the clients simply load an image.  Doing this in a manner that benefits from
the javascript library code is non trivial. Google V8 Javascript engine tied with node.js for
javascript on the server is a likely way this might be done in future.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://blog.davidpadbury.com/2010/10/03/using-nodejs-to-render-js-charts-on-server/">http://blog.davidpadbury.com/2010/10/03/using-nodejs-to-render-js-charts-on-server/</a></li>
</ul>
</div></blockquote>
<p>For this to work smoothly needs effort from js library authors, basically it is porting the
js to a non-standard <strong>browser</strong> that can live on the server.</p>
<blockquote>
<div><ul>
<li><p class="first"><a class="reference external" href="http://highslide.com/forum/viewtopic.php?f=12&amp;t=16380">http://highslide.com/forum/viewtopic.php?f=12&amp;t=16380</a></p>
<blockquote>
<div><ul class="simple">
<li>some noise indicating might happen by version 3.0 of highcharts</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><a class="reference external" href="http://www.highcharts.com/support/roadmap">http://www.highcharts.com/support/roadmap</a></p>
<blockquote>
<div><ul class="simple">
<li>not in offical roadmap</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<div class="sidebar">
modified : 2012-07-10 08:42:54+00:00 tags : Sphinx </div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hku/" title="HKU (hub HKU)"
             >next</a> |</li>
        <li class="right" >
          <a href="../notes/" title="Notes"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >SCM</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>