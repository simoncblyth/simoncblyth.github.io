<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SCM BACKUP &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="SCM" href="../" />
    <link rel="next" title="Notes" href="../notes/" />
    <link rel="prev" title="SCM History" href="../history/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../notes/" title="Notes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../history/" title="SCM History"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">SCM</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">SCM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../history/">SCM History</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">SCM BACKUP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitor/">Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/">Dev notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../svn2git/svn2git/">SVN2GIT via <em>git svn clone</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../altbackup/">Altbackup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../altbackup/#bash-wrapper-for-altbackup-py">bash wrapper for <em>altbackup.py</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../altquery/">Bitten Querying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bitbucket/">bitbucket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../github/">github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sourceforge/">SourceForge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hosting/">SCM Hosting Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binary_handling/">Binary releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/scm/scm-backup.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../history/"
                        title="previous chapter">SCM History</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../notes/"
                        title="next chapter">Notes</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="scm-backup">
<h1>SCM BACKUP<a class="headerlink" href="#scm-backup" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#functions" id="id1">FUNCTIONS</a></li>
<li><a class="reference internal" href="#state-of-lock-additions" id="id2">STATE OF LOCK ADDITIONS</a></li>
<li><a class="reference internal" href="#about-locking-global-and-rsync-locks" id="id3">ABOUT LOCKING : GLOBAL AND RSYNC LOCKS</a></li>
<li><a class="reference internal" href="#integrity-checks" id="id4">INTEGRITY CHECKS</a></li>
<li><a class="reference internal" href="#during-an-rsync-transfer-both-size-and-digest-differ" id="id5">DURING AN RSYNC TRANSFER, BOTH SIZE AND DIGEST DIFFER</a></li>
<li><a class="reference internal" href="#issue-rsync-not-woking-tarballs-not-getting-purged" id="id6">ISSUE : rsync not woking, tarballs not getting purged ?</a></li>
<li><a class="reference internal" href="#issue-fabric-run-fails" id="id7">ISSUE : fabric run fails</a></li>
<li><a class="reference internal" href="#issues-with-new-integrity-tests" id="id8">ISSUES WITH NEW INTEGRITY TESTS</a></li>
<li><a class="reference internal" href="#ihep-cron-running-of-the-backups" id="id9">IHEP CRON RUNNING OF THE BACKUPS</a></li>
<li><a class="reference internal" href="#potential-scm-backup-repo-issue-at-2gb" id="id10">POTENTIAL scm-backup-repo ISSUE AT 2GB</a></li>
<li><a class="reference internal" href="#how-to-recover-dayabay-tarballs-onto-cms02-run-from-c2-sudo-is-used" id="id11">HOW TO RECOVER dayabay TARBALLS ONTO cms02, run from C2 (sudo is used)</a></li>
<li><a class="reference internal" href="#how-to-test-some-improved-error-checking-with-single-repo-trac-backups" id="id12">HOW TO TEST SOME IMPROVED ERROR CHECKING WITH SINGLE REPO/TRAC BACKUPS</a></li>
<li><a class="reference internal" href="#testing-full-backup-into-tmp-directory" id="id13">TESTING FULL BACKUP INTO TMP DIRECTORY</a></li>
<li><a class="reference internal" href="#slimming-the-trac-tgz-all-those-bitten-logs" id="id14">SLIMMING THE TRAC TGZ ... ALL THOSE BITTEN LOGS</a></li>
<li><a class="reference internal" href="#common-issues" id="id15">Common issues</a><ul>
<li><a class="reference internal" href="#backups-stopped" id="id16">backups stopped</a></li>
<li><a class="reference internal" href="#backups-done-but-not-synced-off-box" id="id17">backups done but not synced off box</a></li>
</ul>
</li>
<li><a class="reference internal" href="#todo" id="id18">TODO</a></li>
</ul>
</div>
<div class="section" id="functions">
<h2><a class="toc-backref" href="#id1">FUNCTIONS</a><a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><em>scm-backup-du</em></dt>
<dd>local  backup .gz sizes  in $SCM_FOLD</dd>
<dt><em>scm-backup-rls</em></dt>
<dd>remote ls the .gz on the paired backup node $BACKUP_TAG</dd>
<dt><em>scm-backup-mail</em></dt>
<dd>send mail with the remote list</dd>
<dt><em>scm-backup-check</em></dt>
<dd>find tarballs on all backup nodes</dd>
<dt><em>scm-backup-df</em></dt>
<dd>check freespace on server and all backup nodes</dd>
</dl>
<p><em>scm-backup-postfix-start</em></p>
<dl class="docutils">
<dt><em>scm-backup-bootstrap</em></dt>
<dd>rsync the tarballs from the backup node of the designated server node
for this node and recover from them</dd>
<dt><em>scm-backup-nightly-as-root</em></dt>
<dd>does it as root ... as done in the crontab</dd>
<dt><em>scm-backup-all-as-root</em></dt>
<dd>does the below as root ... as done in the crontab</dd>
<dt><em>scm-backup-all</em></dt>
<dd><p class="first">invokes the below:</p>
<div class="last highlight-python"><pre>scm-backup-repo
scm-backup-trac
scm-backup-folder   for the apache-confdir
scm-backup-purge   : retain the backups from the last 7 days only</pre>
</div>
</dd>
</dl>
<p><em>scm-recover-all fromnode</em></p>
<blockquote>
<div>In addition to the Trac and SVN repos this also now
recovers the users.conf and authz.conf with <em>scm-recover-config</em>
in a careful manner prompting for confirmation before replacing this
critial apache/svn/Trac config files.</div></blockquote>
<p><em>scm-recover-config fromnode</em></p>
<blockquote>
<div><p>Extracts the users.conf and authz.conf from the svnsetup.tar.gz backup file
into a temporary location. Compares these temporaries with the corresponding
config files within <em>apache-confdir</em>. If there are preexisting config files, the
diffs are show and a confirmation dialog is required to replace them with the
extractions.</p>
<p>This calls:</p>
<blockquote>
<div>scm-recover-folders   # contrary to the name this just places a last link to identify the last tarball folder
scm-recover-users
scm-recover-authz</div></blockquote>
</div></blockquote>
<p><em>scm-recover-users fromnode</em></p>
<blockquote>
<div><p>extract the users file from the last svnsetup tarball,
called by <em>scm-recover-all</em>
NB the other svnsetup files are sourced from the repository
and contain system specific paths ... so more direct to re-generate
them rather than using the backups</p>
<p>The users file is different because it is edited thru the webadmin
interface</p>
</div></blockquote>
<p><em>scm-recover-authz fromnode</em></p>
<blockquote>
<div>Analogous to <em>scm-recover-users</em> for the authz file</div></blockquote>
<dl class="docutils">
<dt><em>scm-recover-folders fromnode</em></dt>
<dd><p class="first">still experimental .. NEEDS FURTHER CHECKING PRIOR TO REAL USAGE</p>
<p class="last">recovers the users and permissions files from the last backup</p>
</dd>
</dl>
<p><em>scm-recover-lastlinks typ</em></p>
<blockquote>
<div><p>typ defaults to tar.gz</p>
<p>this must be run from the backup folder that should contain
the &#8220;last&#8221; link eg:</p>
<div class="highlight-python"><pre>/var/scm/backup/cms01/tracs/env
last -&gt; 2008/08/14/174749</pre>
</div>
<p>if the &#8220;last&#8221; link exists then exit without doing anything,
however if the last link has been collapsed into a folder
(eg by web transfers or non-careful copying)
then delete that folder and attempt to recreate the
&#8220;last&#8221; link to the directory containing the last file of type</p>
</div></blockquote>
<p><em>scm-backup-purge from-node number-to-keep</em></p>
<p><em>scm-backup-rsync</em></p>
<blockquote>
<div><p>to the paired node
to override and send the backup to non-standard destination,
eg while not inside home internal network need to use G3R:</p>
<div class="highlight-python"><pre>BACKUP_TAG=G3R scm-backup-rsync</pre>
</div>
</div></blockquote>
<p><em>scm-backup-rsync-from-node</em></p>
<blockquote>
<div>rsync the backups from a remote node</div></blockquote>
<p><em>scm-backup-dybsvn-from-node</em></p>
<blockquote>
<div>copy over the reps for a specific day</div></blockquote>
<p><em>scm-backup-eup</em></p>
<blockquote>
<div><p>updates the env sphinx docs, including the SCM backup tarball monitoring pages and plots.</p>
<p>On repo node C2, this is done automatically via root crontab running <em>scm-backup-monitor</em>
This means that in order to update env docs on C2, must do so as root:</p>
<div class="highlight-python"><pre>ssh C2 /data/env/system/svn/subversion-1.4.6/bin/svn up \~/env
ssh C2R
         scm-backup-
         scm-backup-eup</pre>
</div>
</div></blockquote>
</div>
<div class="section" id="state-of-lock-additions">
<h2><a class="toc-backref" href="#id2">STATE OF LOCK ADDITIONS</a><a class="headerlink" href="#state-of-lock-additions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>cannot incorp the <em>scm-backup-rsync</em> LOCKS in the IHEP to NTU transfers due to
lack of permissions : working with Q to incorp the <em>scm-backup-rsync</em> into the root cron task
by reviving the ssh-agent hook up</li>
</ul>
</div>
<div class="section" id="about-locking-global-and-rsync-locks">
<h2><a class="toc-backref" href="#id3">ABOUT LOCKING : GLOBAL AND RSYNC LOCKS</a><a class="headerlink" href="#about-locking-global-and-rsync-locks" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>during <em>scm-backup-all</em> the &#8220;global&#8221; LOCKED directory $SCM_FOLD/LOCKED is created</li>
<li><em>scm-backup-rsync</em> pays attention to this LOCKED, and will abort if present</li>
<li>during <em>scm-backup-rsync</em> both the global LOCKED as described above and additional rsync LOCKED
are planted in eg $SCM_FOLD/backup/cms02/LOCKED/ during each transfer to partnered remote nodes</li>
<li>following rsync completion the rsync LOCKED is removed and a quick re-rsync is done to remove the LOCKED</li>
</ul>
<p>Note that the rsync LOCKED status is propagated to the remote directory during the rsync transfer, thus
avoiding usage during transfers.</p>
</div>
<div class="section" id="integrity-checks">
<h2><a class="toc-backref" href="#id4">INTEGRITY CHECKS</a><a class="headerlink" href="#integrity-checks" title="Permalink to this headline">¶</a></h2>
<p>Locking now prevents backup/rsync/recover functions both locally and remotely from touching partials.
The backup procedures are purported to be hotcopy of themselves although mismatches
between what gets into the trac instance backup and the svn repo backup are possible.
Such mismatches would not cause corruption however, probably just warnings from Trac syncing.</p>
<p>The DNA check ensures that the tarball content immediately after creation corresponds
precisely to the tarball at the other end of the transfers.</p>
<ul>
<li><p class="first">scm-backup-trac</p>
<blockquote>
<div><ul class="simple">
<li>scm-tgzcheck-trac  : does a ztvf to /dev/null, extracts trac.db from tgz, dumps trac sql using sqlite3</li>
<li>scm-backup-dna     : writes python dict containing md5 digest and size of tgz in sidecar .dna file</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">scm-backup-repo</p>
<blockquote>
<div><ul class="simple">
<li>scm-tgzcheck-ztvf  : does a ztvf to /dev/null</li>
<li>scm-backup-dna     : as above</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">scm-backup-rsync</p>
<blockquote>
<div><ul class="simple">
<li>performs remote DNA check for each paired backup node with scm-backup-dnachecktgzs :
finds .tar.gz.dna and looks for mutants (by comparing sidecar DNA with recomputed)</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="during-an-rsync-transfer-both-size-and-digest-differ">
<h2><a class="toc-backref" href="#id5">DURING AN RSYNC TRANSFER, BOTH SIZE AND DIGEST DIFFER</a><a class="headerlink" href="#during-an-rsync-transfer-both-size-and-digest-differ" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[dayabay] /home/blyth/env &gt; ~/e/base/digestpath.py  /home/scm/backup/dayabay/svn/dybaux/2011/10/19/100802/dybaux-5086.tar.gz
{'dig': '7b87e78cc03ea544e2ad3abae46eecd1', 'size': 1915051630L}

[blyth@cms01 ~]$  ~/e/base/digestpath.py  /data/var/scm/backup/dayabay/svn/dybaux/2011/10/18/100802/dybaux-5083.tar.gz
{'dig': 'da39aee61a748602a15c98e3db25d008', 'size': 1915004348L}

[blyth@cms01 ~]$  ~/e/base/digestpath.py  /data/var/scm/backup/dayabay/svn/dybaux/2011/10/18/100802/dybaux-5083.tar.gz
{'dig': 'da39aee61a748602a15c98e3db25d008', 'size': 1915004348L}
              sometime later, there is no change : transfer stalled  ?</pre>
</div>
</div>
<div class="section" id="issue-rsync-not-woking-tarballs-not-getting-purged">
<h2><a class="toc-backref" href="#id6">ISSUE : rsync not woking, tarballs not getting purged ?</a><a class="headerlink" href="#issue-rsync-not-woking-tarballs-not-getting-purged" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Aug 19, 2014 : observe that tarballs on C have not been purged since July 20 ?</li>
</ol>
<p>Checking logs see error:</p>
<div class="highlight-python"><pre>=== scm-backup-rsync : quick re-transfer /var/scm/backup/cms02 to C:/data/var/scm/backup/ after unlock
=== scm-backup-rsync : time rsync -e "ssh" --delete-after --stats -razvt /var/scm/backup/cms02 C:/data/var/scm/backup/ --timeout 10
Scientific Linux CERN SLC release 4.8 (Beryllium)
building file list ... done
rsync: mkdir "/data/var/scm/backup" failed: No such file or directory (2)
rsync error: error in file IO (code 11) at main.c(576) [receiver=3.0.6]
rsync: connection unexpectedly closed (8 bytes received so far) [sender]
rsync error: error in rsync protocol data stream (code 12) at io.c(359)
real    0m1.153s</pre>
</div>
<p>Repeating the rsync command manually works, deleting the backlog of unpurged tarballs:</p>
<div class="highlight-python"><pre>[root@cms02 log]# rsync -e "ssh" --delete-after --stats -razvt /var/scm/backup/cms02 C:/data/var/scm/backup/ --timeout 10</pre>
</div>
</div>
<div class="section" id="issue-fabric-run-fails">
<h2><a class="toc-backref" href="#id7">ISSUE : fabric run fails</a><a class="headerlink" href="#issue-fabric-run-fails" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>INFO:env.tools.libfab:ENV setting (key,val)  (timeout,2)
INFO:__main__:to check db:  echo .dump tgzs | sqlite3 /data/env/local/env/scm/scm_backup_monitor.db
INFO:env.scm.tgz:opening DB /data/env/local/env/scm/scm_backup_monitor.db
INFO:ssh.transport:Connected (version 1.99, client OpenSSH_4.3p2-6.cern-hpn-CERN-4.3p2-6.cern)
INFO:ssh.transport:Authentication (publickey) successful!
INFO:ssh.transport:Secsh channel 1 opened.
monitor cfg: {'HOST': 'C',
 'HUB': 'C2',
 'dbpath': '$LOCAL_BASE/env/scm/scm_backup_monitor.db',
 'email': 'blyth@hep1.phys.ntu.edu.tw simon.c.blyth@gmail.com',
 'jspath': '$APACHE_HTDOCS/data/scm_backup_monitor_%(node)s.json',
 'reporturl': 'http://dayabay.phys.ntu.edu.tw/e/scm/monitor/%(srvnode)s/',
 'select': 'repos/env tracs/env repos/aberdeen tracs/aberdeen repos/tracdev tracs/tracdev repos/heprez tracs/heprez',
 'srvnode': 'cms02'}
[C] run: find $SCM_FOLD/backup/cms02 -name '*.gz' -exec du --block-size=1M {} \;
[C] out: /home/blyth/.bash_profile: line 32: /data/env/local/env/home/env.bash: No such file or directory^M
[C] out: /home/blyth/.bash_profile: line 313: sv-: command not found^M
[C] out: /home/blyth/.bash_profile: line 315: python-: command not found^M
[C] out: find: /backup/cms02: No such file or directory^M

Fatal error: run() received nonzero return code 1 while executing!</pre>
</div>
</div>
<div class="section" id="issues-with-new-integrity-tests">
<h2><a class="toc-backref" href="#id8">ISSUES WITH NEW INTEGRITY TESTS</a><a class="headerlink" href="#issues-with-new-integrity-tests" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>SCM_BACKUP_TEST_FOLD  ignored by scm-backup-purge</li>
<li>expensive</li>
<li>temporarily take loadsa disk space ~4GB (liable to cause non-interesting problems)</li>
</ul>
</div>
<div class="section" id="ihep-cron-running-of-the-backups">
<h2><a class="toc-backref" href="#id9">IHEP CRON RUNNING OF THE BACKUPS</a><a class="headerlink" href="#ihep-cron-running-of-the-backups" title="Permalink to this headline">¶</a></h2>
<p>changed Aug 2011 :  Cron jobs time changed to 15pm(Beijing Time) and 09am(beijing).</p>
</div>
<div class="section" id="potential-scm-backup-repo-issue-at-2gb">
<h2><a class="toc-backref" href="#id10">POTENTIAL scm-backup-repo ISSUE AT 2GB</a><a class="headerlink" href="#potential-scm-backup-repo-issue-at-2gb" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://subversion.apache.org/faq.html#hotcopy-large-repos">http://subversion.apache.org/faq.html#hotcopy-large-repos</a></li>
</ul>
<p>Early versions of APR on its 0.9 branch, which Apache 2.0.x and Subversion 1.x use,
have no support for copying large files (2Gb+).
A fix which solves the &#8216;svnadmin hotcopy&#8217; problem has been applied and
is included in APR 0.9.5+ and Apache 2.0.50+.
The fix doesn&#8217;t work on all platforms, but works on Linux.</p>
<p>On C2 are using source apache  /data/env/system/apache/httpd-2.0.63</p>
</div>
<div class="section" id="how-to-recover-dayabay-tarballs-onto-cms02-run-from-c2-sudo-is-used">
<h2><a class="toc-backref" href="#id11">HOW TO RECOVER dayabay TARBALLS ONTO cms02, run from C2 (sudo is used)</a><a class="headerlink" href="#how-to-recover-dayabay-tarballs-onto-cms02-run-from-c2-sudo-is-used" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>from C2 : scm-backup-rsync-dayabay-pull-from-cms01</li>
<li>from C2 : scm-recover-all dayabay</li>
</ol>
<p>Note potential issue of incomplete tarballs, to reduce change</p>
</div>
<div class="section" id="how-to-test-some-improved-error-checking-with-single-repo-trac-backups">
<h2><a class="toc-backref" href="#id12">HOW TO TEST SOME IMPROVED ERROR CHECKING WITH SINGLE REPO/TRAC BACKUPS</a><a class="headerlink" href="#how-to-test-some-improved-error-checking-with-single-repo-trac-backups" title="Permalink to this headline">¶</a></h2>
<p>Run as root, eg from C2R:</p>
<div class="highlight-python"><pre>scm-backup-         ## pick up changes
t scm-backup-repo   ## check the function

mkdir -p /tmp/bkp
scm-backup-repo newtest /var/scm/repos/newtest /tmp/bkp dummystamp

export LD_LIBRARY_PATH=/data/env/system/sqlite/sqlite-3.3.16/lib:$LD_LIBRARY_PATH   ## for the right sqlite, otherwise aborts
scm-backup-trac newtest /var/scm/tracs/newtest /tmp/bkp dummystamp</pre>
</div>
</div>
<div class="section" id="testing-full-backup-into-tmp-directory">
<h2><a class="toc-backref" href="#id13">TESTING FULL BACKUP INTO TMP DIRECTORY</a><a class="headerlink" href="#testing-full-backup-into-tmp-directory" title="Permalink to this headline">¶</a></h2>
<p>Run as root, eg from C2R:</p>
<div class="highlight-python"><pre>scm-backup-
t scm-backup-all   ## check the function

rm -rf /tmp/bkptest ; mkdir -p /tmp/bkptest
export LD_LIBRARY_PATH=/data/env/system/sqlite/sqlite-3.3.16/lib:$LD_LIBRARY_PATH
cd /tmp ; SCM_BACKUP_TEST_FOLD=/tmp/bkptest scm-backup-all</pre>
</div>
</div>
<div class="section" id="slimming-the-trac-tgz-all-those-bitten-logs">
<h2><a class="toc-backref" href="#id14">SLIMMING THE TRAC TGZ ... ALL THOSE BITTEN LOGS</a><a class="headerlink" href="#slimming-the-trac-tgz-all-those-bitten-logs" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://bitten.edgewall.org/ticket/519">http://bitten.edgewall.org/ticket/519</a></li>
</ul>
<div class="highlight-python"><pre>DELETE FROM bitten_log_message WHERE log IN (SELECT id FROM bitten_log WHERE build IN (SELECT id FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk'))
DELETE FROM bitten_log WHERE build IN (SELECT id FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk')
DELETE FROM bitten_error WHERE build IN (SELECT id FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk')
DELETE FROM bitten_step WHERE build IN (SELECT id FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk')
DELETE FROM bitten_slave WHERE build IN (SELECT id FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk')
DELETE FROM bitten_build WHERE rev &lt; 23000 AND config = 'trunk'</pre>
</div>
</div>
<div class="section" id="common-issues">
<h2><a class="toc-backref" href="#id15">Common issues</a><a class="headerlink" href="#common-issues" title="Permalink to this headline">¶</a></h2>
<div class="section" id="backups-stopped">
<h3><a class="toc-backref" href="#id16">backups stopped</a><a class="headerlink" href="#backups-stopped" title="Permalink to this headline">¶</a></h3>
<p>compare:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">scm</span><span class="o">-</span><span class="n">backup</span><span class="o">-</span><span class="n">du</span>
<span class="n">scm</span><span class="o">-</span><span class="n">backup</span><span class="o">-</span><span class="n">rls</span>
</pre></div>
</div>
<p>check base/cron.bash ... usually some environment change has broken the env setup for cron
after modifications reset the cron backups:</p>
<div class="highlight-python"><pre>cron-
cron-usage
cron-backup-reset
cron-list root
cron-list blyth</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Usage of cron fabrication is deprecated, its easier to do this manually</p>
</div>
</div>
<div class="section" id="backups-done-but-not-synced-off-box">
<h3><a class="toc-backref" href="#id17">backups done but not synced off box</a><a class="headerlink" href="#backups-done-but-not-synced-off-box" title="Permalink to this headline">¶</a></h3>
<p>Probably the agent needs restarting.. this is needs to be done manually after a reboot see:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ssh</span><span class="o">--</span><span class="n">usage</span>
<span class="n">ssh</span><span class="o">--</span><span class="n">agent</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>then check offbox passwordless access with:</p>
<div class="highlight-python"><pre>scm-backup-
scm-backup-rls</pre>
</div>
<p>Do an emergency backup and rsync, with:</p>
<div class="highlight-python"><pre>scm-backup-all-as-root
scm-backup-rsync
scm-backup-rls      ## check the remote tgz</pre>
</div>
</div>
</div>
<div class="section" id="todo">
<h2><a class="toc-backref" href="#id18">TODO</a><a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>divided reposnsibilities between here and cron.bash is a mess</li>
<li>not easy to add things to crontab because of this morass</li>
</ol>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../notes/" title="Notes"
             >next</a> |</li>
        <li class="right" >
          <a href="../history/" title="SCM History"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >SCM</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>