<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SOP : for servers &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="Sys Admin Docs" href="../" />
    <link rel="next" title="cms01" href="../cms01/" />
    <link rel="prev" title="Trac2Github" href="../migration/trac2github/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../cms01/" title="cms01"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../migration/trac2github/" title="Trac2Github"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">Sys Admin Docs</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Sys Admin</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../monitoring/">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mars/">Mars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migration/">Migration from Trac/SVN</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">SOP : for servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cms01/">cms01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cms02/">CMS02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dns/">cms01 DNS HTTP 10 seconds delay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network_troubleshooting/">Network Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/sysadmin/SOP.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../migration/trac2github/"
                        title="previous chapter">Trac2Github</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../cms01/"
                        title="next chapter">cms01</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="sop-for-servers">
<h1>SOP : for servers<a class="headerlink" href="#sop-for-servers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general">
<h2>general<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@cms01 env]$ sudo /sbin/shutdown now
Broadcast message from root (pts/0) (Sat Mar 23 15:49:21 2013):
The system is going down to maintenance mode NOW!</pre>
</div>
<p>Its taking a long while to stop though:</p>
<div class="highlight-python"><pre>blyth     7679  0.0  0.0  8960 1792 ?        S    13:22   0:00 sshd: blyth@pts/0
blyth     7680  0.0  0.1  7336 3576 pts/0    Ss   13:22   0:07 -bash
root     14566  0.0  0.0  5984 1324 ?        Ss   15:49   0:00 /bin/bash /etc/rc.d/rc 1
root     14690  0.0  0.0  4460  740 ?        S    15:49   0:00 initlog -q -c /etc/rc1.d/K20sv-blyth stop
root     14691  0.0  0.0  4832 1272 ?        S    15:49   0:00 /bin/sh /etc/rc1.d/K20sv-blyth stop
root     14697  0.2  0.3 11716 6440 ?        S    15:49   0:00 /data/env/system/python/Python-2.5.1/bin/python /data/env/system/python/Python-2.5.1/bin/supervisorctl -c /data/env/local/env/sv/ctl/C.ini shutdown
blyth    14705  0.0  0.0  3480  780 pts/0    R+   15:51   0:00 ps aux
root</pre>
</div>
</div>
<div class="section" id="hfag">
<h2>hfag<a class="headerlink" href="#hfag" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@hfag blyth]$ sudo /sbin/service tomcat status
Password:
Tomcat is stopped...
[blyth@hfag blyth]$ sudo /sbin/service tomcat status
Tomcat is stopped...

[blyth@hfag blyth]$ sudo /sbin/service exist status
eXist Native XML Database is running (1771).
[blyth@hfag blyth]$ sudo /sbin/service exist stop
Stopping eXist Native XML Database...
Stopped eXist Native XML Database.
[blyth@hfag blyth]$</pre>
</div>
<p>It takes a little while to issue all the stops:</p>
<div class="highlight-python"><pre>[blyth@hfag blyth]$ sudo /sbin/shutdown now

Broadcast message from root (pts/0) (Sat Mar 23 14:58:28 2013):

The system is going down to maintenance mode NOW!

[blyth@hfag blyth]$ ps aux
USER       PID %CPU %MEM   VSZ  RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.1  1516  504 ?        S     2012   0:10 init
root         2  0.0  0.0     0    0 ?        SW    2012   0:00 [keventd]
root         3  0.0  0.0     0    0 ?        SW    2012   0:00 [kapmd]
root         4  0.0  0.0     0    0 ?        SWN   2012   0:00 [ksoftirqd/0]
root         7  0.0  0.0     0    0 ?        SW    2012   0:00 [bdflush]
root         5  0.0  0.0     0    0 ?        SW    2012  16:20 [kswapd]
root         6  0.0  0.0     0    0 ?        SW    2012  24:29 [kscand]
root         8  0.0  0.0     0    0 ?        SW    2012   0:27 [kupdated]
root         9  0.0  0.0     0    0 ?        SW    2012   0:00 [mdrecoveryd]
root        13  0.0  0.0     0    0 ?        SW    2012   0:03 [kjournald]
root        68  0.0  0.0     0    0 ?        SW    2012   0:00 [khubd]
root      1041  0.0  0.0     0    0 ?        SW    2012   0:00 [kjournald]
root      1042  0.0  0.0     0    0 ?        SW    2012   3:49 [kjournald]
root      1043  0.0  0.0     0    0 ?        SW    2012   0:32 [kjournald]
root      1433  0.0  0.2  1580  548 ?        S     2012   0:06 syslogd -m 0
root      1437  0.0  0.1  1524  460 ?        S     2012   0:00 klogd -x
root       834  0.0  0.7  6856 1880 ?        S    14:52   0:00 sshd: blyth [priv]
blyth      836  0.0  0.8  7012 2132 ?        S    14:52   0:00 sshd: blyth@pts/0
blyth      838  0.1  0.9  6416 2432 pts/0    S    14:52   0:00 -bash
root      1740  0.3  0.5  5344 1288 ?        S    14:58   0:00 /bin/bash /etc/rc.d/rc 1
root      1980  0.0  0.5  5344 1280 ?        S    14:58   0:00 /bin/bash /etc/rc1.d/K88syslog stop
root      1984  0.0  0.2  4932  560 ?        S    14:58   0:00 sleep 1
blyth     1985  0.0  0.2  2732  700 pts/0    R    14:58   0:00 ps aux
[blyth@hfag blyth]$</pre>
</div>
<div class="section" id="hfag-restart-requires-manual-f2-keypress">
<h3>hfag restart requires manual F2 keypress<a class="headerlink" href="#hfag-restart-requires-manual-f2-keypress" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="hfag-nginx-reverse-proxy">
<h3>hfag nginx reverse proxy<a class="headerlink" href="#hfag-nginx-reverse-proxy" title="Permalink to this headline">¶</a></h3>
<p>Used as reverse proxy for SVN on C2, allowing NUU nodes that are routinely
blocked from accessing node C2 apache (for SVN) to have access to the repositories.
The NUU blocks are assumed to be due to C2s habit of transferring
gigabytes per day of backup tarballs.</p>
<p><em>Not auto-started on reboot</em>, to start:</p>
<div class="highlight-python"><pre>nginx-
nginx-sstart

[blyth@hfag blyth]$ t nginx-sstart
nginx-sstart is a function
nginx-sstart ()
{
    $SUDO nginx
}</pre>
</div>
<p>Without this get:</p>
<div class="highlight-python"><pre>[blyth@belle7 e]$ svn up
svn: OPTIONS of 'http://hfag.phys.ntu.edu.tw:90/repos/env/trunk': could not connect to server (http://hfag.phys.ntu.edu.tw:90)</pre>
</div>
</div>
</div>
<div class="section" id="cms02-as-repo-server-this-one-goes-last">
<h2>cms02  : as repo server this one goes last<a class="headerlink" href="#cms02-as-repo-server-this-one-goes-last" title="Permalink to this headline">¶</a></h2>
<p>Hmm, considered doing an extra backup. But have stopped two of the targets
already. Anyhow working copy is uptodate on G, so would not loose significantly
if needed to restore from yesterdays backup.</p>
</div>
<div class="section" id="cms02-restarting-scm-backup-system-after-a-reboot">
<h2>cms02 : restarting scm backup system after a reboot<a class="headerlink" href="#cms02-restarting-scm-backup-system-after-a-reboot" title="Permalink to this headline">¶</a></h2>
<div class="section" id="check-remove-locked-backup-dirs">
<h3>check/remove LOCKED backup dirs<a class="headerlink" href="#check-remove-locked-backup-dirs" title="Permalink to this headline">¶</a></h3>
<p>Do this first, as tends to be otherwise forgotten causing subsequent backup failures:</p>
<div class="highlight-python"><pre>[root@cms02 ~]# cd /var/scm
[root@cms02 scm]# ls -l
total 64
drwxr-xr-x   4 blyth  blyth  4096 Sep 18  2012 backup
drwxr-xr-x   2 nobody nobody 4096 Mar 19 12:45 conf
drwxr-xr-x   3 blyth  blyth  4096 May  8  2012 foreign
drwxr-xr-x   2 root   root   4096 Apr  1 21:19 LOCKED
drwxr-xr-x   2 root   root   4096 Apr  1 15:50 log
drwxr-xr-x   8 nobody nobody 4096 May  7  2012 repos
drwxr-xr-x   2 nobody nobody 4096 May  4  2012 svn
drwxr-xr-x  11 nobody nobody 4096 May  7  2012 tracs
[root@cms02 scm]# ll LOCKED
total 4
-rw-r--r--  1 root root 0 Apr  1 21:19 scm-backup-rsync-started-2013-04-01@21:19:28
[root@cms02 scm]# date
Tue Apr  2 12:11:21 CST 2013
[root@cms02 scm]# rm -rf LOCKED
[root@cms02 scm]#</pre>
</div>
</div>
<div class="section" id="restore-ssh-agent">
<h3>restore ssh agent<a class="headerlink" href="#restore-ssh-agent" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>simon:~ blyth$ ssh C2R
Last login: Tue Mar 12 20:47:07 2013 from simon.phys.ntu.edu.tw
[root@cms02 ~]# . .bash_profile
[root@cms02 ~]# sas
===== sourcing the info for the agent /root/.ssh-agent-info-C2R
===== adding identities to the agent
[root@cms02 ~]# exit</pre>
</div>
</div>
<div class="section" id="check-edit-crontab-times">
<h3>check/edit crontab times<a class="headerlink" href="#check-edit-crontab-times" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[root@cms02 ~]# crontab -l
SHELL = /bin/bash
15 21 * * *  ( export HOME=/root ; export NODE=cms02 ; export MAILTO=blyth@hep1.phys.ntu.edu.tw ; export ENV_HOME=/home/blyth/env ; . /home/blyth/env/env.bash ; env-  ; scm-backup- ; scm-backup-nightly ) &gt;  /var/scm/log/scm-backup-nightly-$(date +"\%d").log 2&gt;&amp;1
15 22 * * *  ( export HOME=/root ; export NODE=cms02 ; export MAILTO=blyth@hep1.phys.ntu.edu.tw ; export ENV_HOME=/home/blyth/env ; . /home/blyth/env/env.bash ; env-  ; scm-backup- ; scm-backup-tgzmon ) &gt;  /var/scm/log/scm-backup-tgzmon-$(date +"\%d").log 2&gt;&amp;1
50 * * * * ( export HOME=/root ; LD_LIBRARY_PATH=/data/env/system/python/Python-2.5.6/lib /data/env/system/python/Python-2.5.6/bin/python /home/blyth/env/db/valmon.py -s oomon rec ; ) &gt; /var/scm/log/oomon.log 2&gt;&amp;1</pre>
</div>
</div>
</div>
<div class="section" id="cms01">
<h2>cms01<a class="headerlink" href="#cms01" title="Permalink to this headline">¶</a></h2>
<div class="section" id="heprez-servers-exist-httpd-tomcat">
<h3>heprez servers : exist httpd tomcat<a class="headerlink" href="#heprez-servers-exist-httpd-tomcat" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="supervisord-and-contained-mysql">
<h3>supervisord and contained mysql<a class="headerlink" href="#supervisord-and-contained-mysql" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@cms01 cronlog]$ sv
mysql                            RUNNING    pid 9604, uptime 191 days, 21:08:16
C&gt; stop mysql
mysql: stopped

C&gt; shutdown
Really shut the remote supervisord process down y/N? y
Shut down
C&gt;
[blyth@cms01 cronlog]$</pre>
</div>
</div>
<div class="section" id="rabbitmq-server">
<h3>rabbitmq-server<a class="headerlink" href="#rabbitmq-server" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@cms01 env]$ sudo /sbin/service rabbitmq-server status
Status of all running nodes...
Node 'rabbit@cms01' with Pid 3131: running
done.
[blyth@cms01 env]$ sudo /sbin/service rabbitmq-server stop
Stopping rabbitmq-server: rabbitmq-server.
[blyth@cms01 env]$
[blyth@cms01 env]$ ll /etc/init.d/</pre>
</div>
</div>
<div class="section" id="xinetd">
<h3>xinetd<a class="headerlink" href="#xinetd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@cms01 env]$ sudo /sbin/service xinetd stop
Stopping xinetd:                                           [  OK  ]</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../cms01/" title="cms01"
             >next</a> |</li>
        <li class="right" >
          <a href="../migration/trac2github/" title="Trac2Github"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >Sys Admin Docs</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>