<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>DetSim Parallel Cerenkov and Scintillation &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="detsim" href="../" />
    <link rel="next" title="eventdisplay" href="../../eventdisplay/" />
    <link rel="prev" title="Detsim Hits Comparison" href="../detsim_hits/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../eventdisplay/" title="eventdisplay"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../detsim_hits/" title="Detsim Hits Comparison"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >nuwa</a> &raquo;</li>
          <li><a href="../" accesskey="U">detsim</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">nuwa</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../dybinst_mavericks/">NuWa on Mavericks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">detsim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../eventdisplay/">eventdisplay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nuwa_cmt_debugging/">NuWa CMT Debugging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentation/">Muon Simulation Presentation</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/nuwa/detsim/detsim_parallel_cerenkov_scintillation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../detsim_hits/"
                        title="previous chapter">Detsim Hits Comparison</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../eventdisplay/"
                        title="next chapter">eventdisplay</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="detsim-parallel-cerenkov-and-scintillation">
<h1>DetSim Parallel Cerenkov and Scintillation<a class="headerlink" href="#detsim-parallel-cerenkov-and-scintillation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Can the photon loops be parallelized by moving
generation onto the GPU ?</li>
<li>This would largely avoid transport overheads.</li>
</ul>
<p>Everything that is constant from the point of view of the
photon cohort needs to be collected into the &#8220;G4DAEStep&#8221;
object. Although some things could potentially
be looked up from material props on GPU no point doing that
when are constant for all photons, just do it once
and present as parameter to the kernel launch.</p>
<div class="section" id="cerenkov-refs">
<h2>Cerenkov Refs<a class="headerlink" href="#cerenkov-refs" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://large.stanford.edu/courses/2014/ph241/alaeian2/">http://large.stanford.edu/courses/2014/ph241/alaeian2/</a></li>
<li><a class="reference external" href="http://math.ucr.edu/home/baez/physics/Relativity/SpeedOfLight/cherenkov.html">http://math.ucr.edu/home/baez/physics/Relativity/SpeedOfLight/cherenkov.html</a></li>
<li><a class="reference external" href="https://thespectrumofriemannium.wordpress.com/tag/tamm-frank-formula/">https://thespectrumofriemannium.wordpress.com/tag/tamm-frank-formula/</a></li>
</ul>
</div>
<div class="section" id="rejection-sampling">
<h2>Rejection Sampling<a class="headerlink" href="#rejection-sampling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.youtube.com/watch?v=wRdjeCtc8d0&amp;feature=youtube_gdata_player">http://www.youtube.com/watch?v=wRdjeCtc8d0&amp;feature=youtube_gdata_player</a></li>
</ul>
</div>
<div class="section" id="check-generation-consistency">
<h2>Check Generation Consistency<a class="headerlink" href="#check-generation-consistency" title="Permalink to this headline">¶</a></h2>
<p>Three files to check for each process (Scintillation and Cerenkov):</p>
<ul class="simple">
<li>CERENKOV, the step file</li>
<li>GOPCERENKOV, g4 optical photons generated from those steps</li>
<li>OPCERENKOV, chroma optical photons generated from the steps on GPU</li>
<li>SCINTILLATION, the step file</li>
<li>GOPSCINTILLATION, g4 optical photons generated from those steps</li>
<li>OPSCINTILLATION, chroma optical photons generated from the steps on GPU</li>
</ul>
<p>No longer need to manually copy any files,
the GPU generated photons are now &#8220;sidesaved&#8221; under
types opcerenkov and opscintillation
and the Geant4 equivalents are &#8220;onlycopied&#8221; from <cite>DsChromaEventAction::EndOfEventAction</cite>
via metadata control such as <cite>ctrl:noreturn:1</cite> and <cite>ctrl:onlycopy:1</cite> applied to processing of all species.</p>
</div>
<div class="section" id="revisit-with-new-type-names">
<h2>Revisit With New Type Names<a class="headerlink" href="#revisit-with-new-type-names" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [1]: cf('wavelength', tag=1, typs='gopcerenkov opcerenkovgen')

 ## improved by shifting low wavelength to match G4 change 60:801:20 to 80:801:20

In [3]: cf('3xyzw', tag=1, typs='gopcerenkov opcerenkovgen', legend=False)


In [1]: cf('3xyzw', tag=1, typs='gopscintillation opscintillationgen', legend=False)

In [2]: cf('wavelength', tag=1, typs='gopscintillation opscintillationgen', log=True)</pre>
</div>
</div>
<div class="section" id="count-checking">
<h2>Count Checking<a class="headerlink" href="#count-checking" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Cerenkov counts are matching only as ApplyWaterQE killing (via continue in photon loop) is still disabled</li>
</ul>
<p>Check counts from ipython:</p>
<div class="highlight-python"><pre>In [2]: genconsistency(1)
INFO:env.g4dae:g4c : GOPCERENKOV    (612841, 4, 4)
INFO:env.g4dae:chc :  OPCERENKOV    (612841, 4, 4)
INFO:env.g4dae:stc :    CERENKOV    (7836, 6, 4) ==&gt; N 612841
INFO:env.g4dae:g4s : GOPSCINTILLATION    (2817543, 4, 4)
INFO:env.g4dae:chs :  OPSCINTILLATION    (2817543, 4, 4)
INFO:env.g4dae:sts :    SCINTILLATION    (13898, 6, 4) ==&gt; N 2817543</pre>
</div>
</div>
<div class="section" id="cerenkov">
<h2>Cerenkov<a class="headerlink" href="#cerenkov" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tee-up-the-arrays">
<h3>tee up the arrays<a class="headerlink" href="#tee-up-the-arrays" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>In [1]: chc, g4c, tst = NPY.mget(1,"opcerenkov","gopcerenkov","test")</pre>
</div>
</div>
<div class="section" id="wavelength">
<h3>wavelength<a class="headerlink" href="#wavelength" title="Permalink to this headline">¶</a></h3>
<p>Initially had very different wavelength, with chroma flat
due to use of uniform wavelength draw, fixed by moving to
uniform in reciprocal of wavelenth:</p>
<div class="highlight-python"><pre>In [1]: cf('wavelength', tag=1, typs="gopcerenkov opcerenkov test")</pre>
</div>
<p>Create some new &#8220;test&#8221; arrays with modified standard wavelengths:</p>
<div class="highlight-python"><pre>g4daechroma.sh --wavelengths 80:801:20

npysend.sh -t1 -icerenkov -otest</pre>
</div>
<ul class="simple">
<li>need to split test into testcerenkov and testscintillation, otherwise write stomping potential ?</li>
</ul>
<p>G4 distrib has step at 200nm, an artifact of RINDEX edge of quoted range:</p>
<div class="highlight-python"><pre>In [105]: chroma_refractive_index(cg)
[ 0]        LiquidScintillator    (18, 2)     wl   79.99 :  799.90          1.454 :      1.793
[ 3]                 GdDopedLS    (18, 2)     wl   79.99 :  799.90          1.454 :      1.793
[ 5]                   Acrylic    (18, 2)     wl   79.99 :  799.90          1.462 :      1.793
[10]                MineralOil    (18, 2)     wl   79.99 :  799.90          1.434 :      1.759
[24]                  IwsWater    (34, 2)     wl  199.97 :  799.90          1.333 :      1.390
[27]                  OwsWater    (34, 2)     wl  199.97 :  799.90          1.333 :      1.390
[28]                 DeadWater    (34, 2)     wl  199.97 :  799.90          1.333 :      1.390</pre>
</div>
<div class="highlight-python"><pre>In [6]: plot_refractive_index()

In [7]: plot_refractive_index(standard=True)

In [130]: for i in np.unique(im):print "%2d : %5d : %s " % ( i, bc[i], cg.unique_materials[i].name[17:-9] )

 0 :  1133 : LiquidScintillator
 3 :  4220 : GdDopedLS
 5 :    88 : Acrylic
10 :  1046 : MineralOil
24 :   791 : IwsWater
27 :   530 : OwsWater
28 :    28 : DeadWater</pre>
</div>
</div>
<div class="section" id="time">
<h3>time<a class="headerlink" href="#time" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>In [9]: cf('time', tag=1, typs="gopcerenkov opcerenkov test")</pre>
</div>
<ul class="simple">
<li>with ApplyWaterQE killing enabled<ul>
<li>very closely matched up to 18ns, beyond that much less g4</li>
</ul>
</li>
<li>without ApplyWaterQE<ul>
<li>almost perfect match</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="xyz-pos-dir-pol">
<h3>xyz pos,dir,pol<a class="headerlink" href="#xyz-pos-dir-pol" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>In [9]: cf('3xyz', g4c, chc)</pre>
</div>
<ul class="simple">
<li>with ApplyWaterQE killing enabled<ul>
<li>pos : clear spatial discrepancy, less at extremes of x and y</li>
</ul>
</li>
<li>without ApplyWaterQE<ul>
<li>pos : almost perfect</li>
<li>dir : vgood agreement, except that chroma spikes are more spiky</li>
<li>pol : same as dir with chroma spikes more spiky</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="investigate-cerenkov-wavelength">
<h3>investigate cerenkov wavelength<a class="headerlink" href="#investigate-cerenkov-wavelength" title="Permalink to this headline">¶</a></h3>
<p><cite>chroma/chroma/cuda/cerenkov.h</cite>:</p>
<div class="highlight-python"><pre>202 __device__ void
203 generate_cerenkov_photon(Photon&amp; p, CerenkovStep&amp; cs, curandState &amp;rng)
204 {
205      float cosTheta ;
206      float sin2Theta ;
207      float wavelength ;
208      float sampledRI ;
209
210      //
211      //  sampling to get wavelength and cone angle
212      //
213      // pick random wavelength inside the range,
214      // lookup refractive index
215      // calculate cosTheta and sinTheta for the refractive index
216      //
217      do {
218
219         wavelength = sample_value(cs.material, curand_uniform(&amp;rng));
220
221         sampledRI = interp_property(cs.material, wavelength, cs.material-&gt;refractive_index);
222
223         cosTheta = cs.BetaInverse / sampledRI;
224
225         sin2Theta = (1.0 - cosTheta)*(1.0 + cosTheta);
226
227       } while ( curand_uniform(&amp;rng)*cs.maxSin2 &gt; sin2Theta);
228
229
230       p.wavelength = wavelength ;
231</pre>
</div>
<div class="highlight-python"><pre>296        G4double Pmin = Rindex-&gt;GetMinPhotonEnergy();
297        G4double Pmax = Rindex-&gt;GetMaxPhotonEnergy();
298        G4double dp = Pmax - Pmin;



405     for (G4int i = 0; i &lt; NumPhotons; i++) {
406       // Determine photon energy
407       G4double rand=0;
408       G4double sampledEnergy=0, sampledRI=0;
409       G4double cosTheta=0, sin2Theta=0;
410
411       // sample an energy
412       do {
413         rand = G4UniformRand();
414         sampledEnergy = Pmin + rand * dp;
415         sampledRI = Rindex-&gt;GetProperty(sampledEnergy);
416         cosTheta = BetaInverse / sampledRI;
417
418         sin2Theta = (1.0 - cosTheta)*(1.0 + cosTheta);
419         rand = G4UniformRand();
420
421       } while (rand*maxSin2 &gt; sin2Theta);
422</pre>
</div>
<div class="highlight-python"><pre>In [48]: cls.refractive_index
Out[48]:
array([[  79.99 ,    1.454],
       [ 120.023,    1.454],
       [ 129.99 ,    1.554],
       [ 139.984,    1.664],
       [ 149.975,    1.783],
       [ 159.98 ,    1.793],
       [ 169.981,    1.554],
       [ 179.974,    1.527],
       [ 189.985,    1.618],
       [ 199.975,    1.618],
       [ 300.   ,    1.526],
       [ 404.7  ,    1.499],
       [ 435.8  ,    1.495],
       [ 486.001,    1.492],
       [ 546.001,    1.486],
       [ 589.002,    1.484],
       [ 690.701,    1.48 ],
       [ 799.898,    1.478]], dtype=float32)

In [49]: cls.name
Out[49]: '__dd__Materials__LiquidScintillator0xc2308d0'

In [50]: ri = cls.refractive_index

In [51]: plt.scatter(ri[:,0],ri[:,1])
Out[51]: &lt;matplotlib.collections.PathCollection at 0x125b76a90&gt;

In [52]: plt.show()</pre>
</div>
<div class="highlight-python"><pre>In [53]: _stc = stc(1)

In [56]: BetaInverse = _stc[:,4,0]
Out[56]: array([ 1.,  1.,  1., ...,  1.,  1.,  1.], dtype=float32)

In [57]: BetaInverse.min()
Out[57]: 1.0000062

In [58]: BetaInverse.max()
Out[58]: 1.4531251

In [64]: plt.hist(BetaInverse, bins=100,log=True)    # mainly 1.000  with small tail out to 1.45</pre>
</div>
<div class="highlight-python"><pre>In [107]: _stc[:,0].view(np.int32)
Out[107]:
array([[   -1,     1,    24,    80],
       [   -2,     1,    24,   108],
       [   -3,     1,    24,    77],
       ...,
       [-7834,     1,    28,    91],
       [-7835,     1,    28,    83],
       [-7836,     1,    28,    48]], dtype=int32)

In [108]: _stc[:,0,2].view(np.int32)
Out[108]: array([24, 24, 24, ..., 28, 28, 28], dtype=int32)

In [110]: im
Out[110]: array([24, 24, 24, ..., 28, 28, 28], dtype=int32)

In [111]: np.unique(im)
Out[111]: array([ 0,  3,  5, 10, 24, 27, 28], dtype=int32)

In [129]: bc = np.bincount(im)

In [130]: for i in np.unique(im):print "%2d : %5d : %s " % ( i, bc[i], cg.unique_materials[i].name[17:-9] )

 0 :  1133 : LiquidScintillator
 3 :  4220 : GdDopedLS
 5 :    88 : Acrylic
10 :  1046 : MineralOil
24 :   791 : IwsWater
27 :   530 : OwsWater
28 :    28 : DeadWater</pre>
</div>
<p><cite>G4DAEChroma/G4DAECerenkovStep.hh</cite>:</p>
<div class="highlight-python"><pre>13     enum {
14
15        _Id,                      //  0
16        _ParentID,
17        _Material,
18        _NumPhotons,
19
20        _x0_x,                    //  1
21        _x0_y,
22        _x0_z,
23        _t0,
24
25        _DeltaPosition_x,         // 2
26        _DeltaPosition_y,
27        _DeltaPosition_z,
28        _step_length,
29
30        _code,                    // 3
31        _charge,
32        _weight,
33        _MeanVelocity,
34
35        _BetaInverse,             //  4
36        _Pmin,
37        _Pmax,
38        _maxCos,
39
40        _maxSin2,                 // 5
41        _MeanNumberOfPhotons1,
42        _MeanNumberOfPhotons2,
43        _BialkaliMaterialIndex,</pre>
</div>
<div class="highlight-python"><pre>In [73]: maxSin2 = _stc[:,5,0]

In [76]: plt.hist(maxSin2, bins=100, log=True)   ## mostly flat with few spikes at high end

In [82]: maxSin2.min()
Out[82]: 0.00065323891

In [83]: maxSin2.max()
Out[83]: 0.53214556</pre>
</div>
<p>BialkaliMaterialIndex:</p>
<div class="highlight-python"><pre>n [69]: _stc[:,5,3].view(np.int32).min()
Out[69]: 7

In [70]: _stc[:,5,3].view(np.int32).max()
Out[70]: 7

In [71]: cg.unique_materials[7]
Out[71]: &lt;chroma.geometry.Material at 0x125a9a950&gt;

In [72]: cg.unique_materials[7].name
Out[72]: '__dd__Materials__Bialkali0xc2f2428'</pre>
</div>
</div>
<div class="section" id="cerenkov-review">
<h3>cerenkov review<a class="headerlink" href="#cerenkov-review" title="Permalink to this headline">¶</a></h3>
<p>TODO: settle on standard wavelenth range to match G4 better:</p>
<div class="highlight-python"><pre>In [4]: cf('3xyzw', tag=1, typs='gopcerenkov opcerenkov', legend=False, log=True)</pre>
</div>
</div>
</div>
<div class="section" id="scintillation">
<h2>Scintillation<a class="headerlink" href="#scintillation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>tee up the arrays<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>In [8]: g4s, chs = NPY.mget(1, "gopscintillation opscintillation")</pre>
</div>
</div>
<div class="section" id="id2">
<h3>wavelength<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>In [6]: cf('wavelength', typs="gopscintillation opscintillation",tag=1, log=True, range=(100,900) )   ## hmm clear chroma cut at 600nm ???</pre>
</div>
<p>Scintillation wavelength, chroma distrib is faithfully representing
a &#8220;histogram&#8221; stepping shape with &#8220;bins&#8221; of about 25nm.
Looks like a problem of mismatched histogram ranges in the chroma
sampling and the input histogram</p>
<ul class="simple">
<li>not quite, just a case of coarse interpolation</li>
</ul>
<p><cite>chroma/chroma/geometry.py</cite>:</p>
<div class="highlight-python"><pre>25 # all material/surface properties are interpolated at these
26 # wavelengths when they are sent to the gpu
27 standard_wavelengths = np.arange(60, 810, 20).astype(np.float32)
28</pre>
</div>
<div class="highlight-python"><pre>In [45]: standard_wavelengths = np.arange(60, 810, 20).astype(np.float32)

In [46]: standard_wavelengths
Out[46]:
array([  60.,   80.,  100.,  120.,  140.,  160.,  180.,  200.,  220.,
        240.,  260.,  280.,  300.,  320.,  340.,  360.,  380.,  400.,
        420.,  440.,  460.,  480.,  500.,  520.,  540.,  560.,  580.,
        600.,  620.,  640.,  660.,  680.,  700.,  720.,  740.,  760.,
        780.,  800.], dtype=float32)

In [47]: len(standard_wavelengths)
Out[47]: 38</pre>
</div>
<ul class="simple">
<li>what to do about that ?<ul>
<li>tighten the range to a more relevant one, and reduce bin size to
keep roughly the same number of bins</li>
<li>reduce bin size</li>
<li>variable bin size ? bad performance impact presumably<ul>
<li>could use a coarse and a fine</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="closer-look-at-scintillation-wavelength">
<h3>closer look at scintillation wavelength<a class="headerlink" href="#closer-look-at-scintillation-wavelength" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>chroma has sharp cutoff at 600nm and less clear drop down at around 350nm</li>
</ul>
<p>The cdf becomes flat above 600nm:</p>
<div class="highlight-python"><pre>In [41]: np.set_printoptions(precision=10)

In [42]: s_reemission_cdf
Out[42]:
array([[  60.          ,    0.          ],
       [  80.          ,    0.          ],
       [ 100.          ,    0.          ],
       [ 120.          ,    0.          ],
       [ 140.          ,    0.          ],
       [ 160.          ,    0.          ],
       [ 180.          ,    0.          ],
       [ 200.          ,    0.0000000205],
       [ 220.          ,    0.0000161953],
       [ 240.          ,    0.00003237  ],
       [ 260.          ,    0.0000485448],
       [ 280.          ,    0.0000647195],
       [ 300.          ,    0.0000808943],
       [ 320.          ,    0.000097069 ],
       [ 340.          ,    0.0009699235],
       [ 360.          ,    0.003526893 ],
       [ 380.          ,    0.0114005441],
       [ 400.          ,    0.1889369488],
       [ 420.          ,    0.5017676353],
       [ 440.          ,    0.7646831274],
       [ 460.          ,    0.9037991762],
       [ 480.          ,    0.9602615237],
       [ 500.          ,    0.9843546748],
       [ 520.          ,    0.9931191802],
       [ 540.          ,    0.9967452288],
       [ 560.          ,    0.9983744621],
       [ 580.          ,    0.99932307  ],
       [ 600.          ,    0.9999999404],
       [ 620.          ,    1.          ],
       [ 640.          ,    1.          ],
       [ 660.          ,    1.          ],
       [ 680.          ,    1.          ],
       [ 700.          ,    1.          ],
       [ 720.          ,    1.          ],
       [ 740.          ,    1.          ],
       [ 760.          ,    1.          ],
       [ 780.          ,    1.          ],
       [ 800.          ,    1.          ]], dtype=float32)

In [43]: s_reemission_cdf.shape
Out[43]: (38, 2)</pre>
</div>
<div class="highlight-python"><pre>171 __device__ void
172 generate_scintillation_photon(Photon&amp; p, ScintillationStep&amp; ss, curandState &amp;rng)
173 {
174     float ScintillationTime = ss.ScintillationTime ;
175     if(ss.scnt == 2)
176     {
177         ScintillationTime = ss.slowTimeConstant ;
178         if(curand_uniform(&amp;rng) &lt; ss.slowerRatio)
179         {
180             ScintillationTime = ss.slowerTimeConstant ;
181         }
182     }
183
184     p.wavelength = sample_cdf(&amp;rng, ss.material-&gt;n,
185                                     ss.material-&gt;wavelength0,
186                                     ss.material-&gt;step,
187                                     ss.material-&gt;reemission_cdf); // reemission_cdf poorly named, intensity_cdf better
188</pre>
</div>
<p><cite>random.h</cite>:</p>
<div class="highlight-python"><pre>25 // Draw a random sample given a cumulative distribution function
26 // Assumptions: ncdf &gt;= 2, cdf_y[0] is 0.0, and cdf_y[ncdf-1] is 1.0
27 __device__ float
28 sample_cdf(curandState *rng, int ncdf, float *cdf_x, float *cdf_y)
29 {
30     return interp(curand_uniform(rng),ncdf,cdf_y,cdf_x);
31 }
32
33 // Sample from a uniformly-sampled CDF
34 __device__ float
35 sample_cdf(curandState *rng, int ncdf, float x0, float delta, float *cdf_y)
36 {
37     float u = curand_uniform(rng);
38
39     int lower = 0;
40     int upper = ncdf - 1;     // far left, right bin numbers
41
42     while(lower &lt; upper-1)    // still not settled on a bin
43     {
44         int half = (lower + upper) / 2;
45
46         if (u &lt; cdf_y[half])
                                 // cdf is normalized to 1 at rhs, so this is appropriate
47             upper = half;
48         else
49             lower = half;
50     }
51
52     float delta_cdf_y = cdf_y[upper] - cdf_y[lower];
53
54     return x0 + delta*lower + delta*(u-cdf_y[lower])/delta_cdf_y;
55 }</pre>
</div>
<p>Bins (ie wavelengths) beyond where the CDF reaches 1 will never get sampled. The
source distribution is SLOWCOMPONENT (same as FASTCOMPONENT):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plt_gdls</span><span class="p">()</span>
</pre></div>
</div>
<p>Wavelength comes from sampling:</p>
<div class="highlight-python"><pre>In [31]: np.allclose( cg.unique_materials[3].reemission_cdf, cg.unique_materials[0].reemission_cdf )
Out[31]: True

In [32]: reemission_cdf = cg.unique_materials[3].reemission_cdf

In [33]: s_reemission_cdf = standardize(reemission_cdf)</pre>
</div>
</div>
<div class="section" id="investigate-g4-scintillation-wavelength">
<h3>investigate G4 scintillation wavelength<a class="headerlink" href="#investigate-g4-scintillation-wavelength" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>catplot(g4s, log=True, range=(100,900))


catplot(g4s, val='wavelength', cat='pdg', log=True, range=(100,900))   ## edges at 200, 800 nm

In [7]: g4s.wavelength.min()
Out[7]: G4ScintillationPhoton(199.97593688964844, dtype=float32)

In [8]: g4s.wavelength.max()
Out[8]: G4ScintillationPhoton(799.8797607421875, dtype=float32)</pre>
</div>
<p>Where did those edges come from:</p>
<div class="highlight-python"><pre>In [11]: gdls.extra.properties['SLOWCOMPONENT']
Out[11]:
array([[  79.99 ,    0.   ],
       [ 120.023,    0.   ],
       [ 199.975,    0.   ],     ## note 130nm jump to zero bin
       [ 330.   ,    0.006],
       [ 331.   ,    0.006],
       [ 332.   ,    0.005],
       [ 333.   ,    0.005],
       ...
       [ 598.001,    0.002],
       [ 599.001,    0.002],
       [ 600.001,    0.002],
       [ 799.898,    0.   ]])    ## note 200nm jump to zero bin</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">catplot</span><span class="p">(</span><span class="n">g4s</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s">&#39;scnt&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><pre>[blyth@ntugrid5 geant4.9.2.p01]$ find $PWD -name 'G4PhysicsVector.hh'
/home/blyth/local/env/dyb/external/build/LCG/geant4.9.2.p01/include/G4PhysicsVector.hh
/home/blyth/local/env/dyb/external/build/LCG/geant4.9.2.p01/source/global/management/include/G4PhysicsVector.hh

[blyth@ntugrid5 geant4.9.2.p01]$ find $PWD -name 'G4PhysicsOrderedFreeVector.hh'
/home/blyth/local/env/dyb/external/build/LCG/geant4.9.2.p01/include/G4PhysicsOrderedFreeVector.hh
/home/blyth/local/env/dyb/external/build/LCG/geant4.9.2.p01/source/global/management/include/G4PhysicsOrderedFreeVector.hh
[blyth@ntugrid5 geant4.9.2.p01]$</pre>
</div>
<p>Grab the scintillation integrals using G4DAEPropList:</p>
<div class="highlight-python"><pre>G4DAEArray::Allocate nitems 275 nfloat 550
G4DAEArray::Allocate nitems 275 nfloat 550
G4DAEArray::Allocate nitems 28 nfloat 56
G4DAEArray::SavePath [/home/blyth/local/env/prop/ls_fast.npy] itemcount 275 itemshape 2
G4DAEArray::SavePath [/home/blyth/local/env/prop/ls_slow.npy] itemcount 275 itemshape 2
G4DAEArray::SavePath [/home/blyth/local/env/prop/ls_reem.npy] itemcount 28 itemshape 2
G4DAEArray::Allocate nitems 275 nfloat 550
G4DAEArray::Allocate nitems 275 nfloat 550
G4DAEArray::Allocate nitems 28 nfloat 56
G4DAEArray::SavePath [/home/blyth/local/env/prop/gdls_fast.npy] itemcount 275 itemshape 2
G4DAEArray::SavePath [/home/blyth/local/env/prop/gdls_slow.npy] itemcount 275 itemshape 2
G4DAEArray::SavePath [/home/blyth/local/env/prop/gdls_reem.npy] itemcount 28 itemshape 2
physicsList-&gt;setCut() start.</pre>
</div>
<div class="highlight-python"><pre>delta:~ blyth$ export-prop-rget | sh
gdls_fast.npy                                                                                                                           100% 2280     2.2KB/s   00:00
ls_slow.npy                                                                                                                             100% 2280     2.2KB/s   00:00
gdls_slow.npy                                                                                                                           100% 2280     2.2KB/s   00:00
gdls_reem.npy                                                                                                                           100%  304     0.3KB/s   00:00
ls_reem.npy                                                                                                                             100%  304     0.3KB/s   00:00
ls_fast.npy                                                                                                                             100% 2280     2.2KB/s   00:00</pre>
</div>
<p>Energy is xscaled to be in reciprocal wavelength (1/nm) and yscale is 1e9:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ls</span> <span class="o">=</span> <span class="n">pro_</span><span class="p">(</span><span class="s">&quot;ls_fast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">ls</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;r+&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Establish connection between scintillation step and the transported scintillation integeral:</p>
<div class="highlight-python"><pre>In [3]: g4s = ScintillationStep.get(1)

 In [13]: np.unique(g4s[:,5,1]).item()*1e9
 Out[13]: 410.0278374608024</pre>
</div>
<p>Cheat by using purloined ScintillationIntegral in gdct- test_ScintillationIntegral succeeds
to reproduce the scintillation wavelengths.
But this is essentially using the same G4 code so no surprise:</p>
<div class="highlight-python"><pre>int test_ScintillationIntegral()
{
    G4DAEPropList* cdf = G4DAEPropList::Load("gdls_fast");
    cdf-&gt;Print();
    G4PhysicsOrderedFreeVector* ScintillationIntegral = G4DAEProp::CreatePOFV(cdf);
    G4double MaxValue = ScintillationIntegral-&gt;GetMaxValue() ;

    //size_t size = 1e6 ;
    size_t size = 2817543 ;  // match the count to current evt "1"

    G4DAEArrayHolder* holder = new G4DAEArrayHolder( size, NULL, "2" );
    for(size_t n=0 ; n&lt;size ; n++ )
    {
        G4double CIIvalue = G4UniformRand()*MaxValue;
        G4double sampledEnergy = ScintillationIntegral-&gt;GetEnergy(CIIvalue);

        float* prop = holder-&gt;GetNextPointer();
        prop[G4DAEProp::_binEdge]  = float(CIIvalue) ;
        prop[G4DAEProp::_binValue] = float(sampledEnergy) ;
    }

    G4DAEPropList dist(holder);
    dist.Save("1");  // sampledEnergy

    //
    //  cf('wavelength', typs="gopscintillation opscintillation prop",tag=1,  log=True, range=(100,900) )
    //   succeeds to match G4 Scintillation photon distrib
    //
    return 0 ;
}</pre>
</div>
<p>What about numpy level:</p>
<div class="highlight-python"><pre>In [13]: cdf = pro_("gdls_fast")

In [16]: mx = cdf[:,1].max()

In [17]: mx
Out[17]: 410.02786

In [18]: u = np.random.rand( 2817543 )

In [19]: u.shape
Out[19]: (2817543,)</pre>
</div>
<p>Need to invert x to have wavelength ordinate, but that makes CDF back to front:</p>
<div class="highlight-python"><pre>In [32]: plt.plot(1/cdf[:,0],cdf[:,1])
Out[32]: [&lt;matplotlib.lines.Line2D at 0x11645d5d0&gt;]</pre>
</div>
<p>So interpolate in 1/wavelength land and invert afterwards,
this avoids the question of how to deal with infinite wavelength:</p>
<div class="highlight-python"><pre>In [46]: wi = np.interp( u*cdf[:,1].max(), cdf[:,1], cdf[:,0] )  ## NB x-y flip

In [47]: w = 1/wi

In [51]: plt.hist(w, bins=100, log=True, range=(100,900)) ## looking good</pre>
</div>
</div>
<div class="section" id="compare-cdfs">
<h3>compare cdfs<a class="headerlink" href="#compare-cdfs" title="Permalink to this headline">¶</a></h3>
<p>So how does the purloined scintillation integral compare with what have been using.</p>
<div class="highlight-python"><pre>In [3]: cg = cg_get()

In [7]: ls = cg.unique_materials[0]

In [13]: rcdf = ls.reemission_cdf

In [14]: plt.plot(rcdf[:,0], rcdf[:,1])
Out[14]: [&lt;matplotlib.lines.Line2D at 0x116369050&gt;]

In [15]: plt.show()</pre>
</div>
<div class="highlight-python"><pre>In [41]: plt.plot( 1/rcdf[:,0], rcdf[:,1], 'b+')
Out[41]: [&lt;matplotlib.lines.Line2D at 0x10ccc4310&gt;]

In [45]: plt.plot( cdf[:,0], 1 - cdf[:,1]/cdf[:,1].max(), 'r+')
Out[45]: [&lt;matplotlib.lines.Line2D at 0x126e99650&gt;]</pre>
</div>
<div class="highlight-python"><pre>In [48]: plt.plot( cdf[:,0], 1 - cdf[:,1]/cdf[:,1].max(), 'r+',   1/rcdf[:,0], rcdf[:,1], 'b+'  )

In [50]: plt.plot( 1/cdf[:,0], 1 - cdf[:,1]/cdf[:,1].max(), 'r+',   rcdf[:,0], rcdf[:,1], 'b+'  )

In [64]: plt.plot( 1/cdf[:,0], 1 - cdf[:,1]/cdf[:,1].max(), 'r+-',   rcdf[:,0], rcdf[:,1], 'b+-'  )</pre>
</div>
<div class="highlight-python"><pre>In [52]: ls = get_ls()

In [57]: fast = ls.extra.properties['FASTCOMPONENT'].astype(np.float64)

cy = np.cumsum(fast[:,1], dtype=np.float64)   ## cumulative in wavelength land

fcdf = np.vstack([fast[:,0],cy/cy[-1]]).T     ## cdf in wavelength

In [112]: np.allclose(fcdf, rcdf)
Out[112]: True</pre>
</div>
<p>Try duplicating BuildPhysicsTable, fiddly bin averaging:</p>
<div class="highlight-python"><pre>In [129]: rfast = fast[::-1]   # reverse order to be in ascending energy

In [130]: rfast[0]
Out[130]: array([ 799.898,    0.   ])</pre>
</div>
<div class="highlight-python"><pre>In [146]: x = 1/rfast[:,0]     # work in inverse wavelength 1/nm

In [147]: y = rfast[:,1]

(y[1:]+y[:-1])/2      # sum of bins

np.cumsum( (y[1:]+y[:-1])/2 * np.diff(x) )*1e6

In [168]: bcdf = np.vstack( [x[1:], cy/cy[-1]] ).T

In [175]: xcdf = cdf.copy()

In [176]: xcdf[:,1] = xcdf[:,1]/xcdf[:,1].max()

In [180]: np.allclose( xcdf[1:], bcdf )
Out[180]: True</pre>
</div>
<p>Avoid loosing the bin:</p>
<div class="highlight-python"><pre>In [185]: bcdf = np.empty( fast.shape )

In [194]: bcdf[0] = 1/fast[-1,0], 0

bcdf[:,0] = x

np.cumsum(ymid*xdif, out=bcdf[1:,1])

bcdf[1:,1] = bcdf[1:,1]/bcdf[1:,1].max()

In [216]: np.allclose(bcdf, xcdf)
Out[216]: True</pre>
</div>
<p>Lay this down in collada_to_chroma:construct_cdf_energywise</p>
</div>
<div class="section" id="test-with-energywise-cdf">
<h3>test with energywise cdf<a class="headerlink" href="#test-with-energywise-cdf" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g4daechroma</span><span class="o">.</span><span class="n">sh</span> <span class="o">--</span><span class="n">nogeocache</span>

<span class="n">npysend</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">iscintillation</span> <span class="o">-</span><span class="n">otest</span>
</pre></div>
</div>
<p>Getting the energywise CDF onto GPU is complicated
by chroma wavelength standardization, which does an interpolation
to that standard wavelengths. As interpolation requires
ascending &#8220;x&#8221; need to flip order.</p>
<p>Some success with handling energywise cdf, but suspect getting
back to front wavelength distrib:</p>
<div class="highlight-python"><pre>67         def interp_material_property(wavelengths, prop):
68             # note that it is essential that the material properties be
69             # interpolated linearly. this fact is used in the propagation
70             # code to guarantee that probabilities still sum to one.
71
72             ascending = np.all(np.diff(prop[:,0]) &gt;= 0)
73             descending = np.all(np.diff(prop[:,0]) &lt;= 0)
74
75             if ascending:
76                 return np.interp(wavelengths, prop[:,0], prop[:,1]).astype(np.float32)
77             elif descending:
78                 # the interpolation needs ascending so reverse here, then reverse back after
79                 iprop = np.interp(wavelengths, prop[::-1,0], prop[::-1,1]).astype(np.float32)
80                 return iprop[::-1].copy()
81             else:
82                 assert 0, "needs to be all ascending or all descending "
83                 return None</pre>
</div>
<p>Access test wavelengths:</p>
<div class="highlight-python"><pre>In [1]: t = ttt_(1)

In [4]: w = t[:,1,3]</pre>
</div>
<p>Getting some infinites, probably LS material index shift:</p>
<div class="highlight-python"><pre>In [26]: w[w==np.inf].shape
Out[26]: (598018,)

In [27]: w[w!=np.inf].shape
Out[27]: (2219525,)</pre>
</div>
<p>The non infinities look like a wavelength distrib:</p>
<div class="highlight-python"><pre>In [7]: ww=w[w!=np.Inf]

In [9]: plt.hist(ww, bins=100)   ## wavelength flipped distribution, maybe need to "1 - cdf"</pre>
</div>
<p>Succeed to get rid of infinities by establishing order of chroma
materials and surfaces to be based on names with pointer address excluded.</p>
<p>After adjusting to use 1/wavelength[::-1] domain reemission_cdf
and using kernel sampling that takes that into account,</p>
<p><cite>chroma/cuda/scintillation.h</cite>:</p>
<div class="highlight-python"><pre>194     p.wavelength = sample_reciprocal_cdf(&amp;rng, ss.material-&gt;n,
195                                                ss.material-&gt;wavelength0,
196                                                ss.material-&gt;step,
197                                                ss.material-&gt;reemission_cdf);</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">cf</span><span class="p">(</span><span class="s">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">typs</span><span class="o">=</span><span class="s">&#39;gopscintillation opscintillation&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>time<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Scintillation time, almost perfect close match:</p>
<div class="highlight-python"><pre>In [7]: cf('time', g4s , chs )     ## very long tail

In [30]: cf('time', g4s , chs, range=(0,100))</pre>
</div>
</div>
<div class="section" id="id4">
<h3>xyz pos,dir,pol<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Position, direction and polarization all almost perfect matches, wavelength needs some attention:</p>
<div class="highlight-python"><pre>In [32]: cf('3xyzw', g4s, chs, legend=False)</pre>
</div>
</div>
<div class="section" id="scintillation-review">
<h3>scintillation review<a class="headerlink" href="#scintillation-review" title="Permalink to this headline">¶</a></h3>
<p>Looking good:</p>
<div class="highlight-python"><pre>In [3]: cf('3xyzw', tag=1, typs='gopscintillation opscintillation', legend=False, log=True)</pre>
</div>
</div>
</div>
<div class="section" id="properties">
<h2>Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>delta:~ blyth$ export-
delta:~ blyth$ export-export
delta:~ blyth$ find $DAE_NAME_DYB_CHROMACACHE -name reemission_cdf.npy | grep Gd
/usr/local/env/geant4/geometry/export/DayaBay_VGDX_20140414-1300/g4_00.dae.29c299d81706c62884caf5c3dbdea5c1/chroma_geometry/chroma.detector:Detector:0x11ca48510/unique_materials/003/chroma.geometry:Material:__dd__Materials__GdDopedLS0xc2a8ed0/reemission_cdf.npy
delta:~ blyth$</pre>
</div>
</div>
<div class="section" id="lookups-for-cerenkov">
<h2>Lookups for Cerenkov<a class="headerlink" href="#lookups-for-cerenkov" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [1]: ri = np.load("./chroma.detector:Detector:0x11ca48510/unique_materials/000/chroma.geometry:Material:__dd__Materials__LiquidScintillator0xc2308d0/refractive_index.npy")

In [2]: ri
Out[2]:
array([[  79.99 ,    1.454],
       [ 120.023,    1.454],
       [ 129.99 ,    1.554],
       [ 139.984,    1.664],
       [ 149.975,    1.783],
       [ 159.98 ,    1.793],
       [ 169.981,    1.554],
       [ 179.974,    1.527],
       [ 189.985,    1.618],
       [ 199.975,    1.618],
       [ 300.   ,    1.526],
       [ 404.7  ,    1.499],
       [ 435.8  ,    1.495],
       [ 486.001,    1.492],
       [ 546.001,    1.486],
       [ 589.002,    1.484],
       [ 690.701,    1.48 ],
       [ 799.898,    1.478]], dtype=float32)</pre>
</div>
</div>
<div class="section" id="material-properties-for-scintillation-cerenkov-gpu-generation">
<h2>Material Properties for Scintillation/Cerenkov GPU generation<a class="headerlink" href="#material-properties-for-scintillation-cerenkov-gpu-generation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>delta:~ blyth$ collada_to_chroma.sh
INFO:env.geant4.geometry.collada.idmap:np.genfromtxt /usr/local/env/geant4/geometry/export/DayaBay_VGDX_20140414-1300/g4_00.idmap
INFO:env.geant4.geometry.collada.idmap:found 685 unique ids
INFO:env.geant4.geometry.collada.g4daenode:idmap exists /usr/local/env/geant4/geometry/export/DayaBay_VGDX_20140414-1300/g4_00.idmap entries 12230
INFO:env.geant4.geometry.collada.g4daenode:index linking DAENode with boundgeom 12230 volumes
INFO:env.geant4.geometry.collada.g4daenode:linking DAENode with idmap 12230 identifiers
INFO:env.geant4.geometry.collada.g4daenode:add_sensitive_surfaces matid __dd__Materials__Bialkali qeprop EFFICIENCY
INFO:env.geant4.geometry.collada.g4daenode:sensitize 684 nodes with matid __dd__Materials__Bialkali and channel_id &gt; 0, uniques 684
INFO:env.geant4.geometry.collada.collada_to_chroma:convert_opticalsurfaces
INFO:env.geant4.geometry.collada.collada_to_chroma:convert_opticalsurfaces creates 44 from 726
WARNING:env.geant4.geometry.collada.collada_to_chroma:setting parent_material to __dd__Materials__Vacuum0xbf9fcc0 as parent is None for node top.0
INFO:env.geant4.geometry.collada.collada_to_chroma:channel_count (nodes with channel_id &gt; 0) : 6888  uniques 684
INFO:env.geant4.geometry.collada.collada_to_chroma:convert_geometry DONE timing_report:
INFO:env.base.timing:timing_report
ColladaToChroma
__init__                       :      0.000          1      0.000
convert_flatten                :      2.429          1      2.429
convert_geometry_traverse      :      4.475          1      4.475
convert_make_maps              :      0.000          1      0.000
convert_materials              :      0.009          1      0.009
convert_opticalsurfaces        :      0.233          1      0.233
INFO:env.geant4.geometry.collada.collada_to_chroma:dropping into IPython.embed() try: cg.&lt;TAB&gt;
Python 2.7.8 (default, Jul 13 2014, 17:11:32)
Type "copyright", "credits" or "license" for more information.

IPython 1.2.1 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython's features.
%quickref -&gt; Quick reference.
help      -&gt; Python's own help system.
object?   -&gt; Details about 'object', use 'object??' for extra details.

In [1]: gdls
Out[1]: &lt;chroma.geometry.Material at 0x10dd0cc50&gt;

In [3]: self = cc

In [5]: collada = self.nodecls.orig

In [6]: collada.materials
Out[6]:
[&lt;Material id=__dd__Materials__PPE0xc12f008 effect=__dd__Materials__PPE_fx_0xc12f008&gt;,
 &lt;Material id=__dd__Materials__MixGas0xc21d930 effect=__dd__Materials__MixGas_fx_0xc21d930&gt;,
 &lt;Material id=__dd__Materials__Air0xc032550 effect=__dd__Materials__Air_fx_0xc032550&gt;,
 &lt;Material id=__dd__Materials__Bakelite0xc2bc240 effect=__dd__Materials__Bakelite_fx_0xc2bc240&gt;,
 &lt;Material id=__dd__Materials__Foam0xc558e28 effect=__dd__Materials__Foam_fx_0xc558e28&gt;,
 &lt;Material id=__dd__Materials__Aluminium0xc542070 effect=__dd__Materials__Aluminium_fx_0xc542070&gt;,
 &lt;Material id=__dd__Materials__Iron0xc542700 effect=__dd__Materials__Iron_fx_0xc542700&gt;,
 &lt;Material id=__dd__Materials__GdDopedLS0xc2a8ed0 effect=__dd__Materials__GdDopedLS_fx_0xc2a8ed0&gt;,
 &lt;Material id=__dd__Materials__Acrylic0xc02ab98 effect=__dd__Materials__Acrylic_fx_0xc02ab98&gt;,
 &lt;Material id=__dd__Materials__Teflon0xc129f90 effect=__dd__Materials__Teflon_fx_0xc129f90&gt;,
 &lt;Material id=__dd__Materials__LiquidScintillator0xc2308d0 effect=__dd__Materials__LiquidScintillator_fx_0xc2308d0&gt;,
 &lt;Material id=__dd__Materials__Bialkali0xc2f2428 effect=__dd__Materials__Bialkali_fx_0xc2f2428&gt;,
 &lt;Material id=__dd__Materials__OpaqueVacuum0xbf5d600 effect=__dd__Materials__OpaqueVacuum_fx_0xbf5d600&gt;,
 &lt;Material id=__dd__Materials__Vacuum0xbf9fcc0 effect=__dd__Materials__Vacuum_fx_0xbf9fcc0&gt;,
 &lt;Material id=__dd__Materials__Pyrex0xc1005e0 effect=__dd__Materials__Pyrex_fx_0xc1005e0&gt;,
 &lt;Material id=__dd__Materials__UnstStainlessSteel0xc5c11e8 effect=__dd__Materials__UnstStainlessSteel_fx_0xc5c11e8&gt;,
 &lt;Material id=__dd__Materials__PVC0xc25cfe8 effect=__dd__Materials__PVC_fx_0xc25cfe8&gt;,
 &lt;Material id=__dd__Materials__StainlessSteel0xc2adc00 effect=__dd__Materials__StainlessSteel_fx_0xc2adc00&gt;,
 &lt;Material id=__dd__Materials__ESR0xbf9f438 effect=__dd__Materials__ESR_fx_0xbf9f438&gt;,
 &lt;Material id=__dd__Materials__Nylon0xc3aa360 effect=__dd__Materials__Nylon_fx_0xc3aa360&gt;,
 &lt;Material id=__dd__Materials__MineralOil0xbf5c830 effect=__dd__Materials__MineralOil_fx_0xbf5c830&gt;,
 &lt;Material id=__dd__Materials__BPE0xc0ad360 effect=__dd__Materials__BPE_fx_0xc0ad360&gt;,
 &lt;Material id=__dd__Materials__Ge_680xc2d7e60 effect=__dd__Materials__Ge_68_fx_0xc2d7e60&gt;,
 &lt;Material id=__dd__Materials__Co_600xc3cf0c0 effect=__dd__Materials__Co_60_fx_0xc3cf0c0&gt;,
 &lt;Material id=__dd__Materials__C_130xc3d0ab0 effect=__dd__Materials__C_13_fx_0xc3d0ab0&gt;,
 &lt;Material id=__dd__Materials__Silver0xc3d1370 effect=__dd__Materials__Silver_fx_0xc3d1370&gt;,
 &lt;Material id=__dd__Materials__Nitrogen0xc031fd0 effect=__dd__Materials__Nitrogen_fx_0xc031fd0&gt;,
 &lt;Material id=__dd__Materials__Water0xc176e30 effect=__dd__Materials__Water_fx_0xc176e30&gt;,
 &lt;Material id=__dd__Materials__NitrogenGas0xc17d300 effect=__dd__Materials__NitrogenGas_fx_0xc17d300&gt;,
 &lt;Material id=__dd__Materials__IwsWater0xc288f98 effect=__dd__Materials__IwsWater_fx_0xc288f98&gt;,
 &lt;Material id=__dd__Materials__ADTableStainlessSteel0xc177178 effect=__dd__Materials__ADTableStainlessSteel_fx_0xc177178&gt;,
 &lt;Material id=__dd__Materials__Tyvek0xc246ca0 effect=__dd__Materials__Tyvek_fx_0xc246ca0&gt;,
 &lt;Material id=__dd__Materials__OwsWater0xbf90c10 effect=__dd__Materials__OwsWater_fx_0xbf90c10&gt;,
 &lt;Material id=__dd__Materials__DeadWater0xbf8a548 effect=__dd__Materials__DeadWater_fx_0xbf8a548&gt;,
 &lt;Material id=__dd__Materials__RadRock0xcd2f508 effect=__dd__Materials__RadRock_fx_0xcd2f508&gt;,
 &lt;Material id=__dd__Materials__Rock0xc0300c8 effect=__dd__Materials__Rock_fx_0xc0300c8&gt;]

In [7]: collada.materials[7]
Out[7]: &lt;Material id=__dd__Materials__GdDopedLS0xc2a8ed0 effect=__dd__Materials__GdDopedLS_fx_0xc2a8ed0&gt;

In [8]: collada.materials[7].extra
Out[8]: &lt;MaterialProperties keys=['SLOWTIMECONSTANT', 'GammaFASTTIMECONSTANT', 'ReemissionSLOWTIMECONSTANT', 'REEMISSIONPROB', 'AlphaFASTTIMECONSTANT', 'ReemissionFASTTIMECONSTANT', 'SLOWCOMPONENT', 'YIELDRATIO', 'FASTCOMPONENT', 'RINDEX', 'NeutronFASTTIMECONSTANT', 'ReemissionYIELDRATIO', 'RAYLEIGH', 'NeutronYIELDRATIO', 'GammaYIELDRATIO', 'SCINTILLATIONYIELD', 'AlphaYIELDRATIO', 'RESOLUTIONSCALE', 'GammaSLOWTIMECONSTANT', 'AlphaSLOWTIMECONSTANT', 'NeutronSLOWTIMECONSTANT', 'ABSLENGTH', 'FASTTIMECONSTANT'] &gt;

In [9]:

In [11]: collada.materials[7].extra.properties
Out[11]:
{'ABSLENGTH': array([[  79.9898,    0.001 ],
       [ 120.0235,    0.001 ],
       [ 199.9746,    0.001 ],
       ...,
       [ 897.916 ,  328.4   ],
       [ 898.8925,  306.2   ],
       [ 899.8711,  299.6   ]]),
 'AlphaFASTTIMECONSTANT': array([[ 0.0012,  1.    ],
       [-0.0012,  1.    ]]),
 'AlphaSLOWTIMECONSTANT': array([[  0.0012,  35.    ],
       [ -0.0012,  35.    ]]),
 'AlphaYIELDRATIO': array([[ 0.0012,  0.65  ],
       [-0.0012,  0.65  ]]),
 'FASTCOMPONENT': array([[  79.9898,    0.    ],
       [ 120.0235,    0.    ],
       [ 199.9746,    0.    ],
       ...,
       [ 599.0011,    0.0017],
       [ 600.0012,    0.0018],
       [ 799.8984,    0.    ]]),
 'FASTTIMECONSTANT': array([[ 0.0012,  3.64  ],
       [-0.0012,  3.64  ]]),
 'GammaFASTTIMECONSTANT': array([[ 0.0012,  7.    ],
       [-0.0012,  7.    ]]),
 'GammaSLOWTIMECONSTANT': array([[  0.0012,  31.    ],
       [ -0.0012,  31.    ]]),
 'GammaYIELDRATIO': array([[ 0.0012,  0.805 ],
       [-0.0012,  0.805 ]]),
 'NeutronFASTTIMECONSTANT': array([[ 0.0012,  1.    ],
       [-0.0012,  1.    ]]),
 'NeutronSLOWTIMECONSTANT': array([[  0.0012,  34.    ],
       [ -0.0012,  34.    ]]),
 'NeutronYIELDRATIO': array([[ 0.0012,  0.65  ],
       [-0.0012,  0.65  ]]),
 'RAYLEIGH': array([[     79.9898,     850.    ],
       [    120.0235,     850.    ],
       [    199.9746,     850.    ],
       ...,
       [    589.8394,  170000.    ],
       [    699.9223,  300000.    ],
       [    799.8984,  500000.    ]]),
 'REEMISSIONPROB': array([[  79.9898,    0.4   ],
       [ 120.0235,    0.4   ],
       [ 159.9797,    0.4   ],
       ...,
       [ 575.8273,    0.0587],
       [ 712.6064,    0.    ],
       [ 799.8984,    0.    ]]),
 'RESOLUTIONSCALE': array([[ 0.0012,  1.    ],
       [-0.0012,  1.    ]]),
 'RINDEX': array([[  79.9898,    1.4536],
       [ 120.0235,    1.4536],
       [ 129.9898,    1.5545],
       ...,
       [ 589.0016,    1.4842],
       [ 690.7008,    1.48  ],
       [ 799.8984,    1.4781]]),
 'ReemissionFASTTIMECONSTANT': array([[ 0.0012,  1.5   ],
       [-0.0012,  1.5   ]]),
 'ReemissionSLOWTIMECONSTANT': array([[ 0.0012,  1.5   ],
       [-0.0012,  1.5   ]]),
 'ReemissionYIELDRATIO': array([[ 0.0012,  1.    ],
       [-0.0012,  1.    ]]),
 'SCINTILLATIONYIELD': array([[     0.0012,  11522.    ],
       [    -0.0012,  11522.    ]]),
 'SLOWCOMPONENT': array([[  79.9898,    0.    ],
       [ 120.0235,    0.    ],
       [ 199.9746,    0.    ],
       ...,
       [ 599.0011,    0.0017],
       [ 600.0012,    0.0018],
       [ 799.8984,    0.    ]]),
 'SLOWTIMECONSTANT': array([[  0.0012,  12.2   ],
       [ -0.0012,  12.2   ]]),
 'YIELDRATIO': array([[ 0.0012,  0.86  ],
       [-0.0012,  0.86  ]])}

In [12]:





In [12]: collada.materials[7].extra.properties['SLOWCOMPONENT']
Out[12]:
array([[  79.9898,    0.    ],
       [ 120.0235,    0.    ],
       [ 199.9746,    0.    ],
       ...,
       [ 599.0011,    0.0017],
       [ 600.0012,    0.0018],
       [ 799.8984,    0.    ]])

In [13]: collada.materials[7].extra.properties['FASTCOMPONENT']
Out[13]:
array([[  79.9898,    0.    ],
       [ 120.0235,    0.    ],
       [ 199.9746,    0.    ],
       ...,
       [ 599.0011,    0.0017],
       [ 600.0012,    0.0018],
       [ 799.8984,    0.    ]])

In [14]: collada.materials[7].extra.properties['REEMISSIONPROB']
Out[14]:
array([[  79.9898,    0.4   ],
       [ 120.0235,    0.4   ],
       [ 159.9797,    0.4   ],
       ...,
       [ 575.8273,    0.0587],
       [ 712.6064,    0.    ],
       [ 799.8984,    0.    ]])

In [15]:


In [15]: np.allclose( collada.materials[7].extra.properties['SLOWCOMPONENT'], collada.materials[7].extra.properties['FASTCOMPONENT'] )
Out[15]: True</pre>
</div>
</div>
<div class="section" id="wavelength-ranges-from-g4-to-chroma">
<h2>Wavelength Ranges from G4 to Chroma<a class="headerlink" href="#wavelength-ranges-from-g4-to-chroma" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [15]: _gdls = gdls()

In [18]: _gdls.__class__
Out[18]: collada.material.Material

In [21]: slow = _gdls.extra.properties['SLOWCOMPONENT']

In [22]: plt.scatter(slow[:,0],slow[:,1])
Out[22]: &lt;matplotlib.collections.PathCollection at 0x115e406d0&gt;

In [23]: plt.show()</pre>
</div>
<p>Wide range, but very few entries at extremes and near zero anyhow, all action in middle:</p>
<div class="highlight-python"><pre>In [20]: _gdls.extra.properties['SLOWCOMPONENT']
Out[20]:
array([[  79.99 ,    0.   ],
       [ 120.023,    0.   ],
       [ 199.975,    0.   ],
       [ 330.   ,    0.006],
       [ 331.   ,    0.006],
       [ 332.   ,    0.005],
       [ 333.   ,    0.005],
       ...
       [ 598.001,    0.002],
       [ 599.001,    0.002],
       [ 600.001,    0.002],
       [ 799.898,    0.   ]])


In [24]: slow[:,0].min()
Out[24]: 79.989835277575907

In [25]: slow[:,0].max()
Out[25]: 799.89835277575912</pre>
</div>
<p>Chopping the extremes:</p>
<div class="highlight-python"><pre>In [28]: plt.scatter(slow[10:-10,0],slow[10:-10,1])
Out[28]: &lt;matplotlib.collections.PathCollection at 0x124b8f110&gt;

In [29]: plt.show()</pre>
</div>
<p>The wide range feeds forward into chroma:</p>
<div class="highlight-python"><pre>In [33]: cg = chroma_geometry()

In [37]: cg.unique_materials[0].name
Out[37]: '__dd__Materials__LiquidScintillator0xc2308d0'

In [38]: cls = cg.unique_materials[0]

In [40]: cls.reemission_cdf.shape
Out[40]: (275, 2)

In [41]: slow.shape
Out[41]: (275, 2)

In [44]: np.allclose( cls.reemission_cdf[:,0], slow[:,0] )
Out[44]: True</pre>
</div>
<p><cite>chroma/chroma/geometry.py</cite>:</p>
<div class="highlight-python"><pre>25 # all material/surface properties are interpolated at these
26 # wavelengths when they are sent to the gpu
27 standard_wavelengths = np.arange(60, 810, 20).astype(np.float32)
28</pre>
</div>
<p>Hmm thats pretty coarse, this explains the generated scintillation wavelength distrib.</p>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../eventdisplay/" title="eventdisplay"
             >next</a> |</li>
        <li class="right" >
          <a href="../detsim_hits/" title="Detsim Hits Comparison"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >nuwa</a> &raquo;</li>
          <li><a href="../" >detsim</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>