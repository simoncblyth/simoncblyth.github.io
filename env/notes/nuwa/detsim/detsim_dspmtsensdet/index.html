<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>DetSim DsPmtSensDet &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="detsim" href="../" />
    <link rel="next" title="DetSim Configuration" href="../detsim_configuration/" />
    <link rel="prev" title="DetSim GiGa Geant4 Handoff" href="../detsim_giga_geant4_handoff/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../detsim_configuration/" title="DetSim Configuration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../detsim_giga_geant4_handoff/" title="DetSim GiGa Geant4 Handoff"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >nuwa</a> &raquo;</li>
          <li><a href="../" accesskey="U">detsim</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">nuwa</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../dybinst_mavericks/">NuWa on Mavericks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">detsim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nuwa_cmt_debugging/">NuWa CMT Debugging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../numpy/">numpy</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/nuwa/detsim/detsim_dspmtsensdet.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../detsim_giga_geant4_handoff/"
                        title="previous chapter">DetSim GiGa Geant4 Handoff</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../detsim_configuration/"
                        title="next chapter">DetSim Configuration</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="detsim-dspmtsensdet">
<h1>DetSim DsPmtSensDet<a class="headerlink" href="#detsim-dspmtsensdet" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><cite>DsPmtSensDet::ProcessHits</cite> hit formation has messy detector specific code, but not too extensive<ul>
<li>expect GPU doable without extreme efforts</li>
<li>PMT identification is the most involved aspect, did this within idmap</li>
</ul>
</li>
</ol>
<div class="section" id="questions">
<h3>Questions<a class="headerlink" href="#questions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>At what juncture to merge GPU formed hits back into Geant4/NuWa/DetSim ?<ul>
<li>maybe form hits in NewStage and fill the appropriate hit collection,
then there should be nothing else to do</li>
</ul>
</li>
<li>where is the GiGa/Geant4/DetSim handoff happening ?  DsPullEvent</li>
<li>where are SensDet identified ?<ul>
<li>DetDesc <strong>sensdet</strong> attribute on <strong>logvol</strong> elements, just yields two SD: <cite>DsRpcSensDet</cite> and <cite>DsPmtSensDet</cite></li>
</ul>
</li>
<li>GiGa takes the detdesc geometry and converts into Geant4,
where exactly does that happen</li>
</ul>
</div>
<div class="section" id="testing-gpu-hit-formation">
<h3>Testing GPU Hit Formation<a class="headerlink" href="#testing-gpu-hit-formation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>running <cite>csa.sh</cite> takes too long to initialize to be a suitable way to test,
need to get sending dummy ChromaPhotonList working again, and then enhance it to
send real CPL sourced from a .root file<ul>
<li>see <cite>czrt-</cite></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="first-try">
<h3>First Try<a class="headerlink" href="#first-try" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>currently now QE, test without first</li>
</ol>
<div class="highlight-python"><pre>[blyth@belle7 dybgaudi]$ svn ci -m "minor: trying Geant4/Chroma integration via effectively forming hits on GPU and placing batches of them into hit collections in StackAction  "
Sending        Simulation/DetSimChroma/cmt/requirements
Sending        Simulation/DetSimChroma/src/DsChromaStackAction.cc
Sending        Simulation/DetSimChroma/src/DsChromaStackAction.h
Sending        Utilities/Chroma/Chroma/ChromaPhotonList.hh
Sending        Utilities/Chroma/cmt/requirements
Sending        Utilities/Chroma/src/ChromaPhotonList.cc
Transmitting file data ......
Committed revision 23251.</pre>
</div>
</div>
<div class="section" id="factor-for-clarity">
<h3>Factor for clarity<a class="headerlink" href="#factor-for-clarity" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@belle7 dybgaudi]$ svn --username blyth ci -m "minor: pull out Chroma photon collection, propagation into G4DAEChroma for more flexible usage, add all volume transform cache "
Sending        Simulation/DetSimChroma/cmt/requirements
Sending        Simulation/DetSimChroma/src/DsChromaStackAction.cc
Sending        Simulation/DetSimChroma/src/DsChromaStackAction.h
Adding         Utilities/G4DAEChroma
Adding         Utilities/G4DAEChroma/G4DAEChroma
Adding         Utilities/G4DAEChroma/G4DAEChroma/G4DAEChroma.h
Adding         Utilities/G4DAEChroma/cmt
Adding         Utilities/G4DAEChroma/cmt/requirements
Adding         Utilities/G4DAEChroma/cmt/version.cmt
Adding         Utilities/G4DAEChroma/src
Adding         Utilities/G4DAEChroma/src/G4DAEChroma.cc
Transmitting file data ......
Committed revision 23415.
[blyth@belle7 dybgaudi]$</pre>
</div>
</div>
<div class="section" id="where-does-g4-call-processhits">
<h3>Where does G4 call ProcessHits ?<a class="headerlink" href="#where-does-g4-call-processhits" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Via the header implemented <cite>Hit</cite> method of <cite>G4VSensitiveDetector</cite></li>
</ul>
<p><cite>geant4.10.00.p01/source/tracking/src/G4SteppingManager.cc</cite>:</p>
<div class="highlight-python"><pre>116 G4StepStatus G4SteppingManager::Stepping()
117 //////////////////////////////////////////
118 {
...
217 //-------
218 // Finale
219 //-------
220
221 // Update 'TrackLength' and remeber the Step length of the current Step
222    fTrack-&gt;AddTrackLength(fStep-&gt;GetStepLength());
223    fPreviousStepSize = fStep-&gt;GetStepLength();
224    fStep-&gt;SetTrack(fTrack);
...
230 // Send G4Step information to Hit/Dig if the volume is sensitive
231    fCurrentVolume = fStep-&gt;GetPreStepPoint()-&gt;GetPhysicalVolume();
232    StepControlFlag =  fStep-&gt;GetControlFlag();
233    if( fCurrentVolume != 0 &amp;&amp; StepControlFlag != AvoidHitInvocation) {
234       fSensitive = fStep-&gt;GetPreStepPoint()-&gt;
235                                    GetSensitiveDetector();
236       if( fSensitive != 0 ) {
237         fSensitive-&gt;Hit(fStep);
238       }
239    }</pre>
</div>
</div>
<div class="section" id="g4vsensitivedetector">
<h3>G4VSensitiveDetector<a class="headerlink" href="#g4vsensitivedetector" title="Permalink to this headline">¶</a></h3>
<p><cite>geant4.10.00.p01/source/digits_hits/detector/include/G4VSensitiveDetector.hh</cite>:</p>
<div class="highlight-python"><pre>113   public: // with description
114       inline G4bool Hit(G4Step*aStep)
115       {
116         G4TouchableHistory* ROhis = 0;
117         if(!isActive()) return false;
118         if(filter)
119         { if(!(filter-&gt;Accept(aStep))) return false; }
120         if(ROgeometry)
121         { if(!(ROgeometry-&gt;CheckROVolume(aStep,ROhis))) return false; }
122         return ProcessHits(aStep,ROhis);
123       }
124       //  This is the public method invoked by G4SteppingManager for generating
125       // hit(s). The actual user's implementation for generating hit(s) must be
126       // implemented in GenerateHits() virtual protected method. This method
127       // MUST NOT be overrided.</pre>
</div>
<p><cite>geant4.10.00.p01/source/digits_hits/detector/src/G4VSensitiveDetector.cc</cite>:</p>
<div class="highlight-python"><pre>100 G4int G4VSensitiveDetector::GetCollectionID(G4int i)
101 {
102    return G4SDManager::GetSDMpointer()-&gt;GetCollectionID(SensitiveDetectorName+"/"+collectionName[i]);
103 }
104
105 //----- following methoods are abstract methods to be
106 //----- implemented in the concrete classes
107
108 void G4VSensitiveDetector::Initialize(G4HCofThisEvent*)
109 {
110 }
111
112 void G4VSensitiveDetector::EndOfEvent(G4HCofThisEvent*)
113 {
114 }</pre>
</div>
</div>
</div>
<div class="section" id="dspmtsensdet">
<h2>DsPmtSensDet<a class="headerlink" href="#dspmtsensdet" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dspmtsensdet-initialize-create-hc-for-each-site-det-for-each-event">
<h3>DsPmtSensDet::Initialize create HC for each (site,det) for each event<a class="headerlink" href="#dspmtsensdet-initialize-create-hc-for-each-site-det-for-each-event" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>195 void DsPmtSensDet::Initialize(G4HCofThisEvent* hce)
196 {
197     m_hc.clear();
198
199     G4DhHitCollection* hc = new G4DhHitCollection(SensitiveDetectorName,collectionName[0]);
200     m_hc[0] = hc;
201     int hcid = G4SDManager::GetSDMpointer()-&gt;GetCollectionID(hc);
202     hce-&gt;AddHitsCollection(hcid,hc);
203
204     for (int isite=0; site_ids[isite] &gt;= 0; ++isite) {
205         for (int idet=0; detector_ids[idet] &gt;= 0; ++idet) {
206             DayaBay::Detector det(site_ids[isite],detector_ids[idet]);
207
208             if (det.bogus()) continue;
209
210             string name=det.detName();
211             G4DhHitCollection* hc = new G4DhHitCollection(SensitiveDetectorName,name.c_str());
212             short int id = det.siteDetPackedData();
213             m_hc[id] = hc;
214
215             int hcid = G4SDManager::GetSDMpointer()-&gt;GetCollectionID(hc);
216             hce-&gt;AddHitsCollection(hcid,hc);
217             debug() &lt;&lt; "Add hit collection with hcid=" &lt;&lt; hcid &lt;&lt; ", cached ID="
218                     &lt;&lt; (void*)id
219                     &lt;&lt; " name= \"" &lt;&lt; SensitiveDetectorName &lt;&lt; "/" &lt;&lt; name &lt;&lt; "\""
220                     &lt;&lt; endreq;
221         }
222     }
223
224     debug() &lt;&lt; "DsPmtSensDet Initialize, made "
225            &lt;&lt; hce-&gt;GetNumberOfCollections() &lt;&lt; " collections"
226            &lt;&lt; endreq;
227
228 }</pre>
</div>
</div>
</div>
<div class="section" id="detdesc-sensdet-identification">
<h2>DetDesc SensDet Identification<a class="headerlink" href="#detdesc-sensdet-identification" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@belle7 DDDB]$ find . -name '*.xml' -exec grep -H Sens {} \;
./RPC/RPCStrip.xml:  &lt;logvol name="lvRPCStrip" material="MixGas" sensdet="DsRpcSensDet"&gt;
./PMT/headon-pmt.xml:  &lt;logvol name="lvHeadonPmtCathode" material="Bialkali" sensdet="DsPmtSensDet"&gt;
./PMT/hemi-pmt.xml:  &lt;logvol name="lvPmtHemiCathode" material="Bialkali" sensdet="DsPmtSensDet"&gt;</pre>
</div>
<p><cite>DDDB/PMT/headon-pmt.xml</cite>:</p>
<div class="highlight-python"><pre>72   &lt;!-- The Photo Cathode --&gt;
73   &lt;logvol name="lvHeadonPmtCathode" material="Bialkali" sensdet="DsPmtSensDet"&gt;
74     &lt;tubs name="headon-pmt-cath"
75           sizeZ="HeadonPmtCathodeThickness"
76       outerRadius="HeadonPmtGlassRadius-HeadonPmtGlassWallThick"/&gt;
77   &lt;/logvol&gt;</pre>
</div>
<p><cite>DDDB/PMT/hemi-pmt.xml</cite>:</p>
<div class="highlight-python"><pre>118   &lt;!-- The Photo Cathode --&gt;
119   &lt;!-- use if limit photocathode to a face on diameter gt 167mm. --&gt;
120   &lt;logvol name="lvPmtHemiCathode" material="Bialkali" sensdet="DsPmtSensDet"&gt;
121     &lt;union name="pmt-hemi-cathode"&gt;
122       &lt;sphere name="pmt-hemi-cathode-face"
123           outerRadius="PmtHemiFaceROCvac"
124           innerRadius="PmtHemiFaceROCvac-PmtHemiCathodeThickness"
125           deltaThetaAngle="PmtHemiFaceCathodeAngle"/&gt;
126       &lt;sphere name="pmt-hemi-cathode-belly"
127           outerRadius="PmtHemiBellyROCvac"
128           innerRadius="PmtHemiBellyROCvac-PmtHemiCathodeThickness"
129           startThetaAngle="PmtHemiBellyCathodeAngleStart"
130           deltaThetaAngle="PmtHemiBellyCathodeAngleDelta"/&gt;
131       &lt;posXYZ z="PmtHemiFaceOff-PmtHemiBellyOff"/&gt;
132     &lt;/union&gt;
133   &lt;/logvol&gt;</pre>
</div>
</div>
<div class="section" id="how-does-gaudi-go-from-sensdet-attribute-value-dspmtsensdet-to-instance">
<h2>How does gaudi go from sensdet attribute value DsPmtSensDet to instance<a class="headerlink" href="#how-does-gaudi-go-from-sensdet-attribute-value-dspmtsensdet-to-instance" title="Permalink to this headline">¶</a></h2>
<p>Looks like a GiGa hack:</p>
<div class="highlight-python"><pre>[blyth@belle7 lhcb]$ find . -name '*.cpp' -exec grep -H SensitiveDetectorName {} \;
./Sim/GiGa/src/Lib/GiGaSensDetBase.cpp:        G4VSensitiveDetector::SensitiveDetectorName = tmp ;  /// ATTENTION !!!
./Sim/GiGa/src/Lib/GiGaSensDetBase.cpp:        G4VSensitiveDetector::SensitiveDetectorName = tmp              ;
./Sim/GiGa/src/Lib/GiGaSensDetBase.cpp:        G4VSensitiveDetector::SensitiveDetectorName.remove(0,pos+1)    ;
./Sim/GiGa/src/Lib/GiGaSensDetBase.cpp:      G4VSensitiveDetector::SensitiveDetectorName;</pre>
</div>
<div class="section" id="mimic-dspmtsensdet-within-chromastackaction">
<h3>Mimic DsPmtSensDet within ChromaStackAction ?<a class="headerlink" href="#mimic-dspmtsensdet-within-chromastackaction" title="Permalink to this headline">¶</a></h3>
<p>Need to pass along the solid index from the GPU, so can do a lookup into a volume store.
Not needed for the pmtid, but do need to get the transform.
NB this is more than just a global position, the preStepPoint knows
which place its at in the geometry tree</p>
<div class="highlight-python"><pre>const G4TouchableHistory* hist =
    dynamic_cast&lt;const G4TouchableHistory*&gt;(preStepPoint-&gt;GetTouchable());

if (!hist or !hist-&gt;GetHistoryDepth()) {
    error() &lt;&lt; "ProcessHits: step has no or empty touchable history" &lt;&lt; endreq;
    return false;</pre>
</div>
<div class="highlight-python"><pre>068 class G4StepPoint
 69 /////////////////
 70 {
...
195    G4TouchableHandle fpTouchable;
196       //  Touchable Handle</pre>
</div>
<p><cite>geant4.10.00.p01/source/track/include/G4StepPoint.icc</cite>:</p>
<div class="highlight-python"><pre>140 inline
141  const G4VTouchable* G4StepPoint::GetTouchable() const
142  { return fpTouchable(); }
143</pre>
</div>
</div>
<div class="section" id="can-i-use-dspmtsensdet-methods-from-stackaction">
<h3>Can I use DsPmtSensDet methods from StackAction ?<a class="headerlink" href="#can-i-use-dspmtsensdet-methods-from-stackaction" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Service lookup only provides access to the minimal standard <cite>IGiGaSensDet</cite> interface,</li>
<li>seems not:<ul>
<li>so need to operate at Geant4 level and duplicate
some of what DsPmtSensDet does to access the same
hit collections</li>
</ul>
</li>
</ol>
<div class="highlight-python"><pre>[blyth@belle7 lhcb]$ find . -name '*.cpp'  -exec grep -H sensdet {} \;
./Det/DetDescCnv/src/component/XmlLVolumeCnv.cpp:  sensdetString = xercesc::XMLString::transcode("sensdet");
./Det/DetDescCnv/src/component/XmlLVolumeCnv.cpp:  xercesc::XMLString::release((XMLCh**)&amp;sensdetString);
./Det/DetDescCnv/src/component/XmlLVolumeCnv.cpp:  std::string sensDetName = dom2Std (element-&gt;getAttribute (sensdetString));</pre>
</div>
</div>
<div class="section" id="lvolume-attribute">
<h3>LVolume attribute<a class="headerlink" href="#lvolume-attribute" title="Permalink to this headline">¶</a></h3>
<p><cite>NuWa-trunk/lhcb/Det/DetDescCnv/src/component/XmlLVolumeCnv.cpp</cite>:</p>
<div class="highlight-python"><pre>405     // if there is a solid, creates a logical volume and stores the solid inside
406     dataObj = new LVolume(volName,
407                           solid,
408                           materialName,
409                           sensDetName,
410                           magFieldName);</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Det/DetDesc/DetDesc/LVolume.h</cite>:</p>
<div class="highlight-python"><pre>20 class LVolume: public LogVolBase
21 {
22   /// friend factory for instantiation
23   friend class DataObjectFactory&lt;LVolume&gt;;
24
25 public:
26
27   /** constructor, pointer to ISolid* must be valid!,
28    *  overvise constructor throws LogVolumeException!
29    *  @exception LVolumeException for wrong parameters set
30    *  @param name         name of logical volume
31    *  @param Solid        pointer to ISolid object
32    *  @param material     name of the material
33    *  @param sensitivity  name of sensitive detector object (for simulation)
34    *  @param magnetic     name of magnetic field object (for simulation)
35    */
36   LVolume( const std::string&amp; name             ,
37            ISolid*            Solid            ,
38            const std::string&amp; material         ,
39            const std::string&amp; sensitivity = "" ,
40            const std::string&amp; magnetic    = "" );
41
42   /// destructor
43   virtual ~LVolume();</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Det/DetDesc/DetDesc/LogVolBase.h</cite>:</p>
<div class="highlight-python"><pre>035 class LogVolBase:
 36   public virtual ILVolume   ,
 37   public         ValidDataObject
 38 {
 39
 40 protected:
 41
 42   /** constructor
 43    *  @exception LVolumeException wrong paramaters value
 44    *  @param name name of logical volume
 45    *  @param sensitivity  name of sensitive detector object (for simulation)
 46    *  @param magnetic  nam eof magnetic field object (for simulation)
 47    */
 48   LogVolBase( const std::string&amp; name        = "" ,
 49               const std::string&amp; sensitivity = "" ,
 50               const std::string&amp; magnetic    = "" );

192   /** name of sensitive "detector" - needed for simulation
193    *  @see ILVolume
194    *  @return name of sensitive "detector"
195    */
196   inline virtual const std::string&amp; sdName () const { return m_sdName; } ;</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGaCnv/src/component/GiGaLVolumeCnv.cpp</cite>:</p>
<div class="highlight-python"><pre>185   // sensitivity
186   if( !lv-&gt;sdName().empty() ) {
187     if( 0 == G4LV-&gt;GetSensitiveDetector() ) {
188       IGiGaSensDet* det = 0 ;
189       StatusCode sc = geoSvc()-&gt;sensitive( lv-&gt;sdName(), det );
190       if( sc.isFailure() ) {
191         return Error("updateRep:: Could no create SensDet ", sc );
192       }
193       if( 0 == det ) {
194         return Error("updateRep:: Could no create SensDet ");
195       }
196       // set sensitive detector
197       G4LV-&gt;SetSensitiveDetector( det );
198     } else {
199       Warning( "SensDet is already defined to be '" +
200                GiGaUtil::ObjTypeName( G4LV-&gt;GetSensitiveDetector() ) +"'");
201     }
202   }</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/IGiGaSensDet.h</cite>:</p>
<div class="highlight-python"><pre>22 class IGiGaSensDet: public virtual G4VSensitiveDetector,
23                     public virtual IGiGaInterface
24 {
25 public:
26
27   /** Retrieve the unique interface ID (static)
28    *  @see IInterface
29    */
30   static const InterfaceID&amp; interfaceID();
31
32   /** Method for being a member of a GiGaSensDetSequence
33    *  Implemented by base class, does not need reimplementation!
34    */
35   virtual bool processStep( G4Step* step, G4TouchableHistory* history ) = 0;</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Det/DetDesc/src/Lib/LVolume.cpp</cite>:</p>
<div class="highlight-python"><pre>36 // ===========================================================================
37 /*  constructor, pointer to ISolid* must be valid!,
38  *  overvise constructor throws LVolumeException!
39  *  @exception LVolumeException wrong paramaters value
40  *  @param name         name of logical volume
41  *  @param Solid        pointer to ISolid object
42  *  @param material     name of the material
43  *  @param sensitivity  name of sensitive detector object (for simulation)
44  *  @param magnetic     name of magnetic field object (for simulation)
45  */
46 // ===========================================================================
47 LVolume::LVolume
48 ( const std::string&amp; name        ,
49   ISolid*            Solid       ,
50   const std::string&amp; material    ,
51   const std::string&amp; sensitivity ,
52   const std::string&amp; magnetic    )
53   : LogVolBase     ( name        ,
54                      sensitivity ,
55                      magnetic    )
56   , m_solid        ( Solid       )
57   , m_materialName ( material    )
58   , m_material     (    0        )
59 {
60   if( 0 == m_solid )
61     { throw LogVolumeException("LVolume: ISolid* points to NULL ") ; }
62 }</pre>
</div>
</div>
</div>
<div class="section" id="where-is-top-volume-setup">
<h2>Where is top volume setup ?<a class="headerlink" href="#where-is-top-volume-setup" title="Permalink to this headline">¶</a></h2>
<p>Annoyingly difficult to searchable API</p>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/src/component/GiGa.h</cite>:</p>
<div class="highlight-python"><pre>215   /** set new world wolume
216    *               implementation of IGiGaSetUpSvc abstract interface
217    *
218    *  NB: errors are reported through exception thrown
219    *
220    *  @param  world  pointer to  new world volume
221    *  @return self-reference ot IGiGaSetUpSvc interface
222    */
223   virtual IGiGaSetUpSvc&amp;
224   operator &lt;&lt; ( G4VPhysicalVolume             * world         ) ;</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/IGiGaSetUpSvc.h</cite>:</p>
<div class="highlight-python"><pre>49 class IGiGaSetUpSvc : virtual public IService
50 {
..
75
76   /** set new world wolume
77    *
78    *  @param  world  pointer to  new world volume
79    *  @return self-reference ot IGiGaSetUpSvc interface
80    */
81   virtual IGiGaSetUpSvc&amp; operator &lt;&lt; ( G4VPhysicalVolume             * ) = 0 ;</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/src/component/GiGaIGiGaSetUpSvc.cpp</cite>:</p>
<div class="highlight-python"><pre>085 // ============================================================================
086 /** set new world wolume
087  *               implementation of IGiGaSetUpSvc abstract interface
088  *
089  *  NB: errors are reported through exception thrown
090  *
091  *  @param  obj    pointer to  new world volume
092  *  @return self-reference ot IGiGaSetUpSvc interface
093  */
094 // ============================================================================
095 IGiGaSetUpSvc&amp; GiGa::operator &lt;&lt; ( G4VPhysicalVolume             * obj )
096 {
097   try
098     {
099       StatusCode sc = StatusCode::SUCCESS;
100       if( 0 == runMgr  () ) { sc = retrieveRunManager()       ; }
101       if( sc.isFailure () ) { Exception("Unable to create IGiGaRunManager!");}
102       sc = runMgr()-&gt;declare( obj ) ;
103       if( sc.isFailure () ) { Exception("Unable to declare" +
104                                         GiGaUtil::ObjTypeName( obj ) ); }
105     }
106   catch ( const GaudiException&amp; Excpt )
107     { Exception( "operator&lt;&lt;(G4VPhysicalVolume*)" , Excpt ) ; }
108   catch ( const std::exception&amp; Excpt )
109     { Exception( "operator&lt;&lt;(G4VPhysicalVolume*)" , Excpt ) ; }
110   catch(...)
111     { Exception( "operator&lt;&lt;(G4VPhysicalVolume*)"         ) ; }
112   ///
113   return *this;
114 };</pre>
</div>
</div>
<div class="section" id="gigarunmanager-also-handles-geometry-too">
<h2>GiGaRunManager also handles geometry too<a class="headerlink" href="#gigarunmanager-also-handles-geometry-too" title="Permalink to this headline">¶</a></h2>
<p>Good for understanding GiGa action and source of breakpoints</p>
<ul class="simple">
<li><cite>NuWa-trunk/lhcb/Sim/GiGa/src/component/GiGaRunManager.cpp</cite></li>
</ul>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/src/component/GiGaRunManager.h</cite>:</p>
<div class="highlight-python"><pre>047 class GiGaRunManager: public  virtual IGiGaRunManager  ,
048                       public  virtual  GiGaBase        ,
049                       private virtual G4RunManager
050 {
...
075   /** declare the top level ("world") physical volume
076    *  @see IGiGaRunManager
077    *  @param obj pointer  to top level ("world") physical volume
078    *  @return  status code
079    */
080   virtual StatusCode declare( G4VPhysicalVolume              * obj ) ;
081
...
269 private:
270
271   bool                       m_krn_st          ;
272   bool                       m_run_st          ;
273   bool                       m_pre_st          ;
274   bool                       m_pro_st          ;
275   bool                       m_uis_st          ;
276
277   G4VPhysicalVolume*         m_rootGeo         ;
278   IGiGaGeoSrc*               m_geoSrc          ;
279   G4UIsession*               m_g4UIsession     ;
280
281   bool                       m_delDetConstr    ;
282   bool                       m_delPrimGen      ;
283   bool                       m_delPhysList     ;</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/src/component/GiGaRunManagerG4RM.cpp</cite>:</p>
<div class="highlight-python"><pre>57 void GiGaRunManager::InitializeGeometry()
58 {
59   /// get root of geometry tree
60   G4VPhysicalVolume* root = 0;
61   if      ( 0 != m_rootGeo                  )
62     {
63       Print(" Already converted geometry will be used!");
64       root = m_rootGeo ;
65     }
66   else if ( 0 != geoSrc()                  )
67     {
68       Print(" Geometry will be extracted from " +
69             GiGaUtil::ObjTypeName( geoSrc() ) );
70       root = geoSrc()-&gt;world ();
71     }
72   else if ( 0 != G4RunManager::userDetector )
73     {
74       Print(" Geometry will be constructed using " +
75             GiGaUtil::ObjTypeName( G4RunManager::userDetector ) );
76       root = G4RunManager::userDetector-&gt;Construct() ;
77     }
78   else
79     { Error(" There are NO known sources of Geometry information!"); }
80   //
81   if( 0 == root )
82     { Exception("InitializeGeometry: NO 'geometry sources' abvailable");}
83   ///
84   DefineWorldVolume( root ) ;
85   G4RunManager::geometryInitialized = true;
86 };</pre>
</div>
</div>
<div class="section" id="giga-conversion-of-intermediary-lvolume-into-g4logicalvolume">
<h2>GiGa conversion of intermediary LVolume into G4LogicalVolume<a class="headerlink" href="#giga-conversion-of-intermediary-lvolume-into-g4logicalvolume" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@belle7 GiGaCnv]$ find . -name '*.cpp' -exec grep -H sens {} \;
./src/component/GiGaLAssemblyCnv.cpp:  /// sensitivity
./src/component/GiGaLAssemblyCnv.cpp:    { return Error("LAssembly could not be sensitive (now)"            ) ; }
./src/component/GiGaLVolumeCnv.cpp:  // sensitivity
./src/component/GiGaLVolumeCnv.cpp:      StatusCode sc = geoSvc()-&gt;sensitive( lv-&gt;sdName(), det );
./src/component/GiGaLVolumeCnv.cpp:      // set sensitive detector
./src/component/GiGaLVolumeCnv.cpp:    // set sensitive detector
./src/component/GiGaGeo.cpp:  // manually finalize all created sensitive detectors
./src/component/GiGaGeo.cpp:StatusCode   GiGaGeo::sensitive
./src/component/GiGaGeo.cpp:  // inform Geant4 sensitive detector manager
./src/component/GiGaGeo.cpp:StatusCode GiGaGeo::sensDet
./src/component/GiGaGeo.cpp:  Warning(" sensDet() is the obsolete method, use sensitive()!");
./src/component/GiGaGeo.cpp:  return sensitive( TypeNick , SD ) ;
./src/component/GiGaGeo.cpp:      StatusCode sc = sensitive( m_budget , budget );
[blyth@belle7 GiGaCnv]$ pwd
/data1/env/local/dyb/NuWa-trunk/lhcb/Sim/GiGaCnv</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGaCnv/src/component/GiGaLVolumeCnv.cpp</cite>:</p>
<div class="highlight-python"><pre>185   // sensitivity
186   if( !lv-&gt;sdName().empty() ) {
187     if( 0 == G4LV-&gt;GetSensitiveDetector() ) {
188       IGiGaSensDet* det = 0 ;
189       StatusCode sc = geoSvc()-&gt;sensitive( lv-&gt;sdName(), det );
190       if( sc.isFailure() ) {
191         return Error("updateRep:: Could no create SensDet ", sc );
192       }
193       if( 0 == det ) {
194         return Error("updateRep:: Could no create SensDet ");
195       }
196       // set sensitive detector
197       G4LV-&gt;SetSensitiveDetector( det );
198     } else {
199       Warning( "SensDet is already defined to be '" +
200                GiGaUtil::ObjTypeName( G4LV-&gt;GetSensitiveDetector() ) +"'");
201     }
202   }</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGaCnv/src/component/GiGaGeo.cpp</cite>:</p>
<div class="highlight-python"><pre>751 //=============================================================================
752 // Instantiate the Sensitive Detector Object
753 //=============================================================================
754 StatusCode   GiGaGeo::sensitive
755 ( const std::string&amp; name  ,
756   IGiGaSensDet*&amp;     det   )
757 {
758   // reset the output value
759   det = 0 ;
760   // locate the detector
761   det = tool( name , det , this );
762   if( 0 == det )
763     { return Error( "Could not locate Sensitive Detector='" + name + "'" ) ; }
764   // inform Geant4 sensitive detector manager
765   if( m_SDs.end() == std::find( m_SDs.begin() , m_SDs.end  () , det ) )
766     {
767       G4SDManager* SDman = G4SDManager::GetSDMpointer();
768       if( 0 == SDman ) { return Error( "Could not locate G4SDManager" ) ; }
769       SDman -&gt; AddNewDetector( det );
770     }
771   // keep local copy
772   m_SDs.push_back( det );
773   ///
774   return StatusCode::SUCCESS;
775 };</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/IGiGaSensDet.h</cite>:</p>
<div class="highlight-python"><pre>22 class IGiGaSensDet: public virtual G4VSensitiveDetector,
23                     public virtual IGiGaInterface
24 {
25 public:
26
27   /** Retrieve the unique interface ID (static)
28    *  @see IInterface
29    */
30   static const InterfaceID&amp; interfaceID();
31
32   /** Method for being a member of a GiGaSensDetSequence
33    *  Implemented by base class, does not need reimplementation!
34    */
35   virtual bool processStep( G4Step* step, G4TouchableHistory* history ) = 0;
36
37 protected:
38
39   virtual ~IGiGaSensDet(); ///&lt; virtual destructor
40   IGiGaSensDet() ;         ///&lt; default constructor
41
42 };</pre>
</div>
<div class="highlight-python"><pre>58 //=============================================================================
59 // initialize the sensitive detector (Gaudi)
60 //=============================================================================
61 StatusCode GiGaSensDetBase::initialize()
62 {
63   StatusCode sc = GiGaBase::initialize() ;
64   if( sc.isFailure() ) {
65     return Error("Could not initialize base class GiGaBase");
66   }
67
68   // Correct the names!
69   {
70
71     std::string detname(name());
72     std::string::size_type posdot = detname.find(".");
73     detname.erase(0,posdot+1);
74
75     std::string tmp( m_detPath + "/" + detname );
76     std::string::size_type pos = tmp.find("//") ;
77     while( std::string::npos != pos )
78       { tmp.erase( pos , 1 ) ; pos = tmp.find("//") ; }
79
80     // attention!!! direct usage of G4VSensitiveDetector members!!!!
81     pos = tmp.find_last_of('/') ;
82     if( std::string::npos == pos )
83       {
84         G4VSensitiveDetector::SensitiveDetectorName = tmp ;  /// ATTENTION !!!
85         G4VSensitiveDetector::thePathName           = "/" ;  /// ATTENTION !!!
86       }
87     else
88       {
89         G4VSensitiveDetector::SensitiveDetectorName = tmp              ;
90         G4VSensitiveDetector::SensitiveDetectorName.remove(0,pos+1)    ;
91         G4VSensitiveDetector::thePathName           = tmp              ;
92         G4VSensitiveDetector::thePathName.remove(pos+1,tmp.length()-1) ;
93         if( '/' != G4VSensitiveDetector::thePathName[(unsigned int)(0)] )
94           { G4VSensitiveDetector::thePathName.insert(0,"/"); }
95       }
96     ///
97     G4VSensitiveDetector::fullPathName =
98       G4VSensitiveDetector::thePathName +
99       G4VSensitiveDetector::SensitiveDetectorName;
...</pre>
</div>
</div>
<div class="section" id="generalisable-identifier-heist">
<h2>Generalisable Identifier Heist ?<a class="headerlink" href="#generalisable-identifier-heist" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>hmm, maybe can do something generalisable for SD by grabbing identifiers from Geant4
and persisting them into COLLADA export ?
Are the identifiers there to be grabbed though ?<ul>
<li>Nope, the PMTID live as UserParam associated with DETDESC DetectorElement, it
seems these param are not propagated down into the Geant4 representation</li>
</ul>
</li>
</ul>
<p><cite>source/geometry/management/include/G4LogicalVolume.hh</cite>:</p>
<div class="highlight-python"><pre>281     inline G4VSensitiveDetector* GetSensitiveDetector() const;
282       // Gets current SensitiveDetector.
283     inline void SetSensitiveDetector(G4VSensitiveDetector *pSDetector);
284       // Sets SensitiveDetector (can be 0).

Dayabay has only two SensDet for Pmt and Rpc</pre>
</div>
</div>
<div class="section" id="how-to-persist-the-pmtid-in-collada">
<h2>How to persist the PMTID in COLLADA<a class="headerlink" href="#how-to-persist-the-pmtid-in-collada" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>hmm adopt something like <cite>G4GDMLAuxMapType</cite> for G4DAE Export ?</li>
</ol>
<p><cite>geant4.10.00.p01/examples/extended/persistency/gdml/G04/gdml_det.cc</cite>:</p>
<div class="highlight-python"><pre>103    // Example how to retrieve Auxiliary Information for sensitive detector
104    //
105    const G4GDMLAuxMapType* auxmap = parser.GetAuxMap();
...
124    // The same as above, but now we are looking for
125    // sensitive detectors setting them for the volumes
126
127    for(G4GDMLAuxMapType::const_iterator iter=auxmap-&gt;begin();
128        iter!=auxmap-&gt;end(); iter++)
129    {
130      G4cout &lt;&lt; "Volume " &lt;&lt; ((*iter).first)-&gt;GetName()
131             &lt;&lt; " has the following list of auxiliary information: "
132             &lt;&lt; G4endl &lt;&lt; G4endl;
133      for (G4GDMLAuxListType::const_iterator vit=(*iter).second.begin();
134           vit!=(*iter).second.end();vit++)
135      {
136        if ((*vit).type=="SensDet")
137        {
138          G4cout &lt;&lt; "Attaching sensitive detector " &lt;&lt; (*vit).value
139                 &lt;&lt; " to volume " &lt;&lt; ((*iter).first)-&gt;GetName()
140                 &lt;&lt;  G4endl &lt;&lt; G4endl;</pre>
</div>
</div>
<div class="section" id="giga-manual">
<h2>GiGa Manual<a class="headerlink" href="#giga-manual" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://lhcb-comp.web.cern.ch/lhcb-comp/Frameworks/Gaudi/Documents/GiGa.pdf">http://lhcb-comp.web.cern.ch/lhcb-comp/Frameworks/Gaudi/Documents/GiGa.pdf</a></li>
</ul>
<div class="section" id="section-3-2-3-conversion-of-geometry-objects">
<h3>Section 3.2.3 Conversion of Geometry Objects<a class="headerlink" href="#section-3-2-3-conversion-of-geometry-objects" title="Permalink to this headline">¶</a></h3>
<p>Geometry description in DETDESC package is made through 3 types of identifiable
objects <cite>LVolume</cite>, <cite>DetectorElement</cite> and <cite>Surface</cite>.
The simplified class diagrams for 3 corresponding Converter classes <cite>GiGaLVolumeCnv</cite>, <cite>GiGaDetectorElementCnv</cite>
and <cite>GiGaSurfaceCnv</cite> are shown on figure 3.2. Call-backs from geometry Converters
to <cite>IGiGaGeomCnvSvc</cite> interface are explicitly indicated.</p>
<p>These classes are converted into GEANT4 classes <cite>G4LogicalVolume</cite>, <cite>G4PVPlacement</cite>,
<cite>G4LogicalSkinSurface</cite> and <cite>G4LogicalBorderSurface</cite>.</p>
<div class="section" id="naming-convention">
<h4>naming convention<a class="headerlink" href="#naming-convention" title="Permalink to this headline">¶</a></h4>
<p>Logical volume (of type <cite>G4LogicalVolume</cite>) in GEANT4 get its name from <cite>name()</cite>
method from <cite>ILVolume</cite> interface, which is the full address of
logical volume in transient store, e.g. <cite>/dd/Geometry/LHCb/lvLHCb</cite>.</p>
<p>Situation with naming of physical volumes (of type <cite>G4PVPlacement</cite>) is a little
bit more complicated. Physical volume gets the name of the form
<cite>&lt;MotherLVName&gt;#PVname</cite>
if it is created during conversion of its mother logical volume
or <cite>FullPathForDetectorElement</cite> if it corresponds to detector element,
which is converted in a separate way without conversion of higher
level detector elements.</p>
<p>Surfaces (of types <cite>G4LogicalSkinSurface</cite> and <cite>G4LogicalBorderSurface</cite>) get their
name from <cite>fullpath()</cite> method of Surface class, e.g. <cite>/dd/Geometry/Rich1/MirrorSurface</cite>.
The corresponding <cite>G4OpticalSurface</cite> class gets the same name.</p>
</div>
</div>
</div>
<div class="section" id="giga-geometry-configuration">
<h2>GiGa geometry configuration<a class="headerlink" href="#giga-geometry-configuration" title="Permalink to this headline">¶</a></h2>
<p>The global magnetic field is the property of GiGaGeomCnvSvc and could be configured through e.g job options technique:</p>
<div class="highlight-python"><pre>/// ...
/// declare constant magnetic field as global field
GiGaGeomCnvSvc.WorldMagneticField = "GiGaMagFieldUniform/Uniform"; /// confiugure magnetic field
Uniform.Bx = 0.0;
Uniform.By = 10.0;
Uniform.Bz = 10.0;
/// ...</pre>
</div>
</div>
<div class="section" id="top-down-trace-from-nuwa-py-g-detector">
<h2>Top Down Trace from nuwa.py <cite>-G/&#8211;detector</cite><a class="headerlink" href="#top-down-trace-from-nuwa-py-g-detector" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@belle7 DybPython]$ grep detector *.py
cmdline.py:    parser.add_argument("-G", "--detector",default= "",
Control.py:        if self.opts.detector:
Control.py:            XmlDetDesc.Configure(self.opts.detector)
Control.py:                + self.opts.detector + " is loaded."
DybPythonAlg.py:        detectorId = inputHeaders[0].context().GetDetId()
DybPythonAlg.py:            # Extend time/detector range if needed
DybPythonAlg.py:            if detectorId != DetectorId.kAll and detectorId != inputDetId:
DybPythonAlg.py:                detectorId = DetectorId.kAll
gaudiutil.py:            dec = "%2d %2d %2d %2d %d" % (pp.site(), pp.detectorId(), pp.inwardFacing(), pp.wallNumber(), pp.wallSpot())
[blyth@belle7 DybPython]$</pre>
</div>
<p><cite>NuWa-trunk/dybgaudi/Detector/XmlDetDesc/python/XmlDetDesc/__init__.py</cite>:</p>
<div class="highlight-python"><pre>36         from XmlTools.XmlToolsConf import XmlCnvSvc, XmlParserSvc
37         xmlcnv = XmlCnvSvc()
38         xmlcnv.AllowGenericConversion = True
39         xmlparser = XmlParserSvc()
40
41         from Gaudi.Configuration import ApplicationMgr, DetectorPersistencySvc, DetectorDataSvc
42
43         app = ApplicationMgr()
44         app.ExtSvc += [ xmlcnv , xmlparser ]
45
46         detper = DetectorPersistencySvc()
47         detper.CnvServices.append(xmlcnv)
48
49         detdat = DetectorDataSvc()
50         detdat.UsePersistency = True
51         detdat.DetDbRootName  = "dd"
52         detdat.DetStorageType = 7
53         detdat.DetDbLocation  = xmlfile</pre>
</div>
</div>
<div class="section" id="detectordatasvc">
<h2>DetectorDataSvc<a class="headerlink" href="#detectordatasvc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@belle7 lhcb]$ find . -name '*.cpp' -exec grep -l DetectorDataSvc {} \;
./Tools/XmlTools/src/component/XmlParserSvc.cpp
./Sim/GiGaCnv/src/Lib/GiGaCnvBase.cpp
./Sim/GiGaCnv/src/Lib/GiGaCnvSvcBase.cpp
./Sim/GiGaCnv/src/component/GiGaGeo.cpp
./Det/DetDescSvc/src/EventClockSvc.cpp
./Det/DetDescSvc/src/PreloadGeometryTool.cpp
./Det/DetDescSvc/src/UpdateManagerSvc.cpp
./Det/DetDescSvc/src/TransportSvc.cpp
./Det/DetDescSvc/src/DetElemFinder.cpp
./Det/DetDesc/src/Lib/Services.cpp
./Vis/OnXSvc/src/OnXSvc.cpp


[blyth@belle7 lhcb]$ cd ../gaudi
[blyth@belle7 gaudi]$ find . -name '*.cpp' -exec grep -l DetectorDataSvc {} \;
./GaudiSvc/src/ApplicationMgr/ApplicationMgr.cpp
./GaudiSvc/src/DetectorDataSvc/DetDataSvc.cpp
./GaudiAlg/src/lib/GaudiTool.cpp
./GaudiKernel/src/Lib/Algorithm.cpp
./GaudiExamples/src/Properties/PropertyAlg.cpp</pre>
</div>
<p><cite>NuWa-trunk/gaudi/GaudiSvc/src/DetectorDataSvc/DetDataSvc.cpp</cite> looks to be lazy:</p>
<div class="highlight-python"><pre>207 /// Standard Constructor
208 DetDataSvc::DetDataSvc(const std::string&amp; name,ISvcLocator* svc) :
209   DataSvc(name,svc), m_eventTime(0)  {
210   declareProperty("DetStorageType",  m_detStorageType = XML_StorageType );
211   declareProperty("DetDbLocation",   m_detDbLocation  = "empty" );
212   declareProperty("DetDbRootName",   m_detDbRootName  = "dd" );
213   declareProperty("UsePersistency",  m_usePersistency = false );
214   declareProperty("PersistencySvc",  m_persistencySvcName = "DetectorPersistencySvc" );
215   m_rootName = "/dd";
216   m_rootCLID = CLID_Catalog;
217   m_addrCreator = 0;
218 }</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="https://lhcb-comp.web.cern.ch/lhcb-comp/Frameworks/Gaudi/Gaudi_v9/GUG/Output/GUG_DetDescription.html">https://lhcb-comp.web.cern.ch/lhcb-comp/Frameworks/Gaudi/Gaudi_v9/GUG/Output/GUG_DetDescription.html</a></li>
</ul>
</div>
<div class="section" id="gigageo-hunting-control-of-detdesc-to-geant4-conversion">
<h2>GiGaGeo : hunting control of DetDesc to Geant4 conversion<a class="headerlink" href="#gigageo-hunting-control-of-detdesc-to-geant4-conversion" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/python/DetSim/Default.py</cite>:</p>
<div class="highlight-python"><pre>75         from GiGa.GiGaConf import GiGa
76         giga = GiGa()
77         giga.PhysicsList = physics_list
78
79         # Start empty step action sequence to hold historian/unobserver
80         from GaussTools.GaussToolsConf import GiGaStepActionSequence
81         sa = GiGaStepActionSequence('GiGa.GiGaStepActionSequence')
82         giga.SteppingAction = sa
83
84         self.giga = giga
85
86         # Tell GiGa the size of the world.
87         # Set default world material to be vacuum to speed propagation of
88         # particles in regions of little interest.
89         from GiGaCnv.GiGaCnvConf import GiGaGeo
90         giga_geom = GiGaGeo()
91         giga_geom.XsizeOfWorldVolume = 2.4*units.kilometer
92         giga_geom.YsizeOfWorldVolume = 2.4*units.kilometer
93         giga_geom.ZsizeOfWorldVolume = 2.4*units.kilometer
94         giga_geom.WorldMaterial = "/dd/Materials/Vacuum"
95         self.gigageo = giga_geom
96
97         # Set up for telling GiGa what geometry to use, but don't
98         # actually set that.
..
..         set below GiGaInputStream section creating self.giga_items
..
13
14         # Make sequencer alg to run all this stuff as subalgs
15         from GaudiAlg.GaudiAlgConf import GaudiSequencer
16         giga_sequence = GaudiSequencer()
17         giga_sequence.Members = [ self.giga_items ]
18         self.giga_sequence=giga_sequence
19         if use_push_algs:
20             # DetSim's algs
21             from DetSim.DetSimConf import DsPushKine, DsPullEvent
22             self.detsim_push_kine = DsPushKine()
23             self.detsim_pull_event = DsPullEvent()
24             giga_sequence.Members += [self.detsim_push_kine,
25                                       self.detsim_pull_event]
26             pass
27
28         if not use_sim_subseq:
29             from Gaudi.Configuration import ApplicationMgr
30             theApp = ApplicationMgr()
31             theApp.TopAlg.append(giga_sequence)</pre>
</div>
</div>
<div class="section" id="gigainputstream">
<h2>GiGaInputStream<a class="headerlink" href="#gigainputstream" title="Permalink to this headline">¶</a></h2>
<div class="section" id="config">
<h3>config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h3>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/python/DetSim/Default.py</cite>:</p>
<div class="highlight-python"><pre>99         from GaussTools.GaussToolsConf import GiGaInputStream
00         giga_items = GiGaInputStream()
01         giga_items.ExecuteOnce = True
02         giga_items.ConversionSvcName = "GiGaGeo"
03         giga_items.DataProviderSvcName = "DetectorDataSvc"
04         giga_items.StreamItems = [ ]
05         site = site.lower()
06         if "far" in site:
07             giga_items.StreamItems += self.giga_far_items
08         if "dayabay" in site:
09             giga_items.StreamItems += self.giga_dayabay_items
10         if "lingao" in site:
11             giga_items.StreamItems += self.giga_lingao_items
12         self.giga_items = giga_items</pre>
</div>
</div>
<div class="section" id="gigainputstream-execute">
<h3>GiGaInputStream::execute<a class="headerlink" href="#gigainputstream-execute" title="Permalink to this headline">¶</a></h3>
<p>Load objects (top level <cite>/dd/Structure</cite> paths) and apply GiGaGeo conversion</p>
<ol class="arabic simple">
<li>add handful of top level <cite>/dd/Structure</cite> path for the simulated site to PreLoad list</li>
<li>DataSvc preload from DetDesc XML</li>
<li>run the <cite>LoadObject</cite> for each</li>
<li><cite>m_cnvSvc-&gt;createRep</cite></li>
</ol>
<p><cite>NuWa-trunk/lhcb/Sim/GaussTools/src/Components/GiGaInputStream.cpp</cite>:</p>
<div class="highlight-python"><pre>47 StatusCode GiGaInputStream::execute()
48 {
49   ///
50   if( !m_execute ) { return StatusCode::SUCCESS; }
51   ///
52   MsgStream log( msgSvc() , name() );
53   log &lt;&lt; MSG::VERBOSE &lt;&lt; " execute:: start" &lt;&lt; endreq;
54   ///
55   if( m_executeOnce      ) { m_execute  = false; }
56   ///
57   /// preload data
58   Items::const_iterator item = m_items.begin() ;
59   while( item != m_items.end() )
60     { m_dataSvc-&gt;addPreLoadItem( *item++ ); }
61   m_dataSvc-&gt;preLoad();
62   ///
63   StatusCode status = StatusCode::SUCCESS;
64   m_dataSelector.clear();
65   item = m_items.begin() ;
66   while( item != m_items.end() &amp;&amp; status.isSuccess() )
67     { status = LoadObject( *item++, &amp;m_dataSelector) ; }
68   ///
69   if( status.isFailure() )
70     { return Error("Execute::Could not load Object="+item-&gt;path(), status); }
71   /// create the representation
72   for( IDataSelector::iterator obj1 = m_dataSelector.begin() ;
73        m_dataSelector.end() != obj1 ; ++obj1 )
74     {
75       IOpaqueAddress* Address = 0 ;
76       status = m_cnvSvc-&gt;createRep( *obj1 , Address ) ;
77       if( status.isFailure() )
78         { return Error(" Error in creation of representation!"); }
79       // update the registry
80       (*obj1)-&gt;registry()-&gt;setAddress( Address );
81     }
82   /// create the references
83   for( IDataSelector::iterator obj2 = m_dataSelector.begin() ;
84        m_dataSelector.end() != obj2 ; ++obj2 )
85     {
86       status = m_cnvSvc-&gt;
87         fillRepRefs( (*obj2)-&gt;registry()-&gt;address(),  *obj2 ) ;
88       if( status.isFailure() )
89         { return Error(" Error in creation of references!"); }
90     }
91   ///
92   if( status.isFailure() )
93     { return Error("Execute::Could not convert the IDataSelector*", status);}
94   ///
95   m_dataSelector.clear();
96   ///
97   log &lt;&lt; MSG::VERBOSE &lt;&lt; "Execute::end" &lt;&lt; endreq;
98   ///
99   return status;
00   ///
01 };</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGaCnv/src/component/GiGaGeo.h</cite>:</p>
<div class="highlight-python"><pre>29 /** @class GiGaGeo GiGaGeo.h
30  *
31  *  Conversion service for transforming Gaudi detector
32  *  and geometry description into Geant4 geometry and
33  *  detector description
34  *
35  *  @author  Vanya Belyaev
36  *  @author  Gonzalo Gracia
37  *  @author  Sajan Easo, Gloria Corti
38  *  @date    2000-08-07, Last modified: 2007-07-10
39  */
40
41 class GiGaGeo : public virtual  IGiGaGeomCnvSvc,
42                 public           GiGaCnvSvcBase {
43</pre>
</div>
<div class="highlight-python"><pre>144   /** Retrieve the pointer to top-level "world" volume,
145    *  @see IGiGaGeo
146    *  needed for Geant4 - root for the whole Geant4 geometry tree
147    *  @see class IGiGaGeoSrc
148    *  @return pointer to constructed(converted) geometry tree
149    */
150   virtual G4VPhysicalVolume* world();</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGaCnv/src/component/GiGaGeo.cpp</cite>:</p>
<div class="highlight-python"><pre>79 //=============================================================================
80 // Standard constructor, initializes variables
81 //=============================================================================
82 GiGaGeo::GiGaGeo( const std::string&amp; serviceName,
83                   ISvcLocator* serviceLocator )
84   : GiGaCnvSvcBase( serviceName, serviceLocator, GiGaGeom_StorageType )
85   , m_worldPV( 0 )
86   , m_worldMagField( "" )   // check below for double properties
87   , m_SDs()
88   , m_MFs()
89   , m_FMs()
90 {
91
92   setNameOfDataProviderSvc("DetectorDataSvc");
93
94   declareProperty( "WorldPhysicalVolumeName", m_worldNamePV = "Universe" );
95   declareProperty( "WorldLogicalVolumeName",  m_worldNameLV = "World" );
96   declareProperty( "WorldMaterial",   m_worldMaterial = "/dd/Materials/Air");
97
98   declareProperty( "XsizeOfWorldVolume" , m_worldX = 50. * m );
99   declareProperty( "YsizeOfWorldVolume" , m_worldY = 50. * m );
00   declareProperty( "ZsizeOfWorldVolume" , m_worldZ = 50. * m );
01
02   declareProperty( "GlobalSensitivity" , m_budget = "");
03   // Probably obsolete: need to check if WorldMagneticField can be removed
04   declareProperty( "WorldMagneticField", m_worldMagField );
05   declareProperty( "FieldManager"      , m_worldMagField );
06
07   declareProperty( "ClearStores", m_clearStores = true );
08
09   declareProperty ( "UseAlignment",      m_useAlignment = false ) ;
10   declareProperty ( "AlignAllDetectors", m_alignAll = false );
11   m_alignDets.clear();
12   declareProperty ( "AlignDetectors",    m_alignDets );
13
14 };</pre>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>DsPmtSensDet<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/GiGaSensDetBase.h</cite>:</p>
<div class="highlight-python"><pre>22 class GiGaSensDetBase: virtual public IGiGaSensDet ,
23                        public GiGaBase
24 {
25
26 public:
27
28   /** standard constructor
29    *  @see GiGaBase
30    *  @see AlgTool
31    *  @param type type of the object (?)
32    *  @param name name of the object
33    *  @param parent  pointer to parent object
34    */
35   GiGaSensDetBase ( const std::string&amp; type   ,
36                     const std::string&amp; name   ,
37                     const IInterface*  parent );</pre>
</div>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/src/DsPmtSensDet.h</cite>:</p>
<div class="highlight-python"><pre>26 class DsPmtSensDet : public GiGaSensDetBase {
27 public:
28     DsPmtSensDet(const std::string&amp; type,
29                  const std::string&amp; name,
30                  const IInterface*  parent);
31     virtual ~DsPmtSensDet();
32
33     // G4VSensitiveDetector interface
34     virtual void Initialize( G4HCofThisEvent* HCE ) ;
35     virtual void EndOfEvent( G4HCofThisEvent* HCE ) ;
36     virtual bool ProcessHits(G4Step* step,
37                              G4TouchableHistory* history);
38
39     // Tool interface
40     virtual StatusCode initialize();
41     virtual StatusCode finalize();
42
43 private:
44     /// Properties:
45
46     /// CathodeLogicalVolumes : name of logical volumes in which this
47     /// sensitive detector is operating.
48     std::vector&lt;std::string&gt; m_cathodeLogVols;
49
50     /// SensorStructures : names of paths in TDS in which to search
51     /// for sensor detector elements using this sensitive detector.
52     std::vector&lt;std::string&gt; m_sensorStructures;
53
54     /// PackedIdParameterName : name of user paramater of the counted
55     /// detector element which holds the packed, globally unique PMT
56     /// ID.
57     std::string m_idParameter;
58
59     /// TouchableToDetelem : the ITouchableToDetectorElement to use to
60     /// resolve sensor ID.
61     std::string m_t2deName;
62     ITouchableToDetectorElement* m_t2de;
63
64     /// QEScale: Upward adjustment of DetSim efficiency to allow
65     /// PMT-to-PMT efficiency variation in the electronics simulation.
66     /// The value should be the inverse of the mean PMT efficiency
67     /// applied in ElecSim.
68     double m_qeScale;
69
70     ///
71     bool m_ConvertWeightToEff;
72
73     /// QEffParameterName : name of user parameter in the photo
74     /// cathode volume that holds the quantum efficiency tabproperty.
75     std::string m_qeffParamName;
76
77     // Store hit in a hit collection
78     void StoreHit(DayaBay::SimPmtHit* hit, int trackid);
79</pre>
</div>
</div>
<div class="section" id="dspmtsensdet-dspmtsensdet">
<h2>DsPmtSensDet::DsPmtSensDet<a class="headerlink" href="#dspmtsensdet-dspmtsensdet" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>56 DsPmtSensDet::DsPmtSensDet(const std::string&amp; type,
57                            const std::string&amp; name,
58                            const IInterface*  parent)
59     : G4VSensitiveDetector(name)
60     , GiGaSensDetBase(type,name,parent)
61     , m_t2de(0)
62 {
63     info() &lt;&lt; "DsPmtSensDet (" &lt;&lt; type &lt;&lt; "/" &lt;&lt; name &lt;&lt; ") created" &lt;&lt; endreq;
64
65     declareProperty("CathodeLogicalVolume",
66                     m_cathodeLogVols,
67                     "Photo-Cathode logical volume to which this SD is attached.");
68
69     declareProperty("TouchableToDetelem", m_t2deName = "TH2DE",
70                     "The ITouchableToDetectorElement to use to resolve sensor.");
71
72     declareProperty("SensorStructures",m_sensorStructures,
73                     "TDS Paths in which to look for sensor detector elements"
74                     " using this sensitive detector");
75
76     declareProperty("PackedIdPropertyName",m_idParameter="PmtID",
77                     "The name of the user property holding the PMT ID.");
78
79     declareProperty("QEffParameterName",m_qeffParamName="EFFICIENCY",
80                     "name of user parameter in the photo cathode volume that"
81                     " holds the quantum efficiency tabproperty");
82
83     declareProperty("QEScale",m_qeScale=1.0 / 0.9,
84                     "Upward scaling of the quantum efficiency by inverse of mean PMT-to-PMT efficiency in electronics simulation.");
85
86     declareProperty("ConvertWeightToEff", m_ConvertWeightToEff=false,
87                     "Treat to the optical photon weight as to preliminary applied QE."
88                     "Will affect only the primary photons (GtDiffuserBallTool, etc.).");
89
90     m_cathodeLogVols.push_back("/dd/Geometry/PMT/lvPmtHemiCathode");
91     m_cathodeLogVols.push_back("/dd/Geometry/PMT/lvHeadonPmtCathode");
92 }</pre>
</div>
<div class="highlight-python"><pre>[blyth@belle7 dybgaudi]$ find . -name '*.cc' -exec grep -H SensorStructures  {} \;
./Simulation/DetSim/src/DsPmtSensDet.cc:    declareProperty("SensorStructures",m_sensorStructures,
./Simulation/DetSim/src/DsRpcSensDet.cc:    declareProperty("SensorStructures",m_sensorStructures,</pre>
</div>
</div>
<div class="section" id="dspmtsensdet-processhits-simpmthit-formation-from-g4step-stored-into-hit-collections">
<h2>DsPmtSensDet::ProcessHits SimPmtHit formation from G4Step, stored into hit collections<a class="headerlink" href="#dspmtsensdet-processhits-simpmthit-formation-from-g4step-stored-into-hit-collections" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/src/DsPmtSensDet.cc</cite>:</p>
<div class="highlight-python"><pre>318 bool DsPmtSensDet::ProcessHits(G4Step* step,
319                                G4TouchableHistory* /*history*/)
320 {
321     //if (!step) return false; just crash for now if not defined
322
323     // Find out what detector we are in (ADx, IWS or OWS)
324     G4StepPoint* preStepPoint = step-&gt;GetPreStepPoint();
325
326     double energyDep = step-&gt;GetTotalEnergyDeposit();
327
328     if (energyDep &lt;= 0.0) {
329         //debug() &lt;&lt; "Hit energy too low: " &lt;&lt; energyDep/CLHEP::eV &lt;&lt; endreq;
330         return false;
331     }
332
333     const G4TouchableHistory* hist =
334         dynamic_cast&lt;const G4TouchableHistory*&gt;(preStepPoint-&gt;GetTouchable());
335     if (!hist or !hist-&gt;GetHistoryDepth()) {
336         error() &lt;&lt; "ProcessHits: step has no or empty touchable history" &lt;&lt; endreq;
337         return false;
338     }
339
340     const DetectorElement* de = this-&gt;SensDetElem(*hist);
341     if (!de) return false;
342
343     // wangzhe QE calculation starts here.
344     int pmtid = this-&gt;SensDetId(*de);
345     DayaBay::Detector detector(pmtid);
346     G4Track* track = step-&gt;GetTrack();
347     double weight = track-&gt;GetWeight();
...
459     DayaBay::SimPmtHit* sphit = new DayaBay::SimPmtHit();
460
461     // base hit
462
463     // Time since event created
464     sphit-&gt;setHitTime(preStepPoint-&gt;GetGlobalTime());
465
466     //#include "G4NavigationHistory.hh"
467
468     const G4AffineTransform&amp; trans = hist-&gt;GetHistory()-&gt;GetTopTransform();
469     const G4ThreeVector&amp; global_pos = preStepPoint-&gt;GetPosition();
470     G4ThreeVector pos = trans.TransformPoint(global_pos);
471     sphit-&gt;setLocalPos(pos);
472     sphit-&gt;setSensDetId(pmtid);
...
505     int trackid = track-&gt;GetTrackID();
506     this-&gt;StoreHit(sphit,trackid);
507     debug() &lt;&lt; "Stored photon " &lt;&lt; trackid &lt;&lt; " weight " &lt;&lt; weight &lt;&lt; " pmtid " &lt;&lt; (void*)pmtid &lt;&lt; " wavelength(nm) " &lt;&lt; wavelength/CLHEP::nm &lt;&lt; e    ndreq;
508     return true;
509 }
...
511 void DsPmtSensDet::StoreHit(DayaBay::SimPmtHit* hit, int trackid)
512 {
513     int did = hit-&gt;sensDetId();
514     DayaBay::Detector det(did);
515     short int sdid = det.siteDetPackedData();
516
517     G4DhHitCollection* hc = m_hc[sdid];
518     if (!hc) {
519         warning() &lt;&lt; "Got hit with no hit collection.  ID = " &lt;&lt; (void*)did
520                   &lt;&lt; " which is detector: \"" &lt;&lt; DayaBay::Detector(did).detName()
521                   &lt;&lt; "\". Storing to the " &lt;&lt; collectionName[0] &lt;&lt; " collection"
522                   &lt;&lt; endreq;
523         sdid = 0;
524         hc = m_hc[sdid];
525     }
526
527 #if 1
528     verbose() &lt;&lt; "Storing hit PMT: " &lt;&lt; (void*)did
529               &lt;&lt; " from " &lt;&lt; DayaBay::Detector(did).detName()
530               &lt;&lt; " in hc #"&lt;&lt;  sdid &lt;&lt; " = "
531               &lt;&lt; hit-&gt;hitTime()/CLHEP::ns &lt;&lt; "[ns] "
532               &lt;&lt; hit-&gt;localPos()/CLHEP::cm &lt;&lt; "[cm] "
533               &lt;&lt; hit-&gt;wavelength()/CLHEP::nm &lt;&lt; "[nm]"
534               &lt;&lt; endreq;
535 #endif
536
537     hc-&gt;insert(new G4DhHit(hit,trackid));
538 }</pre>
</div>
</div>
<div class="section" id="totalenergydeposit">
<h2>TotalEnergyDeposit<a class="headerlink" href="#totalenergydeposit" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/src</cite>:</p>
<div class="highlight-python"><pre>[blyth@belle7 src]$ grep TotalEnergyDeposit *.cc
DsG4Scintillation.cc:// necessary information resides in aStep.GetTotalEnergyDeposit()
DsG4Scintillation.cc:    G4double TotalEnergyDeposit = aStep.GetTotalEnergyDeposit();
DsG4Scintillation.cc:      G4cout &lt;&lt; " TotalEnergyDeposit " &lt;&lt; TotalEnergyDeposit
DsG4Scintillation.cc:    if (TotalEnergyDeposit &lt;= 0.0 &amp;&amp; !flagReemission) {
DsG4Scintillation.cc:        G4double dE = TotalEnergyDeposit;
DsG4Scintillation.cc:        G4double QuenchedTotalEnergyDeposit
DsG4Scintillation.cc:            = TotalEnergyDeposit/(1+birk1*delta+birk2*delta*delta);
DsG4Scintillation.cc:        G4double MeanNumberOfPhotons= ScintillationYield * QuenchedTotalEnergyDeposit;
DsPmtModel.cc:    fastStep.ProposeTotalEnergyDeposited(energy);
DsPmtSensDet.cc:    double energyDep = step-&gt;GetTotalEnergyDeposit();
DsRpcModel.cc:    fastStep.ProposeTotalEnergyDeposited(energy);
DsRpcSensDet.cc:    double energyDep = step-&gt;GetTotalEnergyDeposit();</pre>
</div>
<p><cite>NuWa-trunk/dybgaudi/Simulation/DetSim/src/DsPmtModel.cc</cite>:</p>
<div class="highlight-python"><pre>61 void DsPmtModel::DoIt(const G4FastTrack&amp; fastTrack, G4FastStep&amp; fastStep)
62 {
63     const G4Track* track = fastTrack.GetPrimaryTrack();
64     double energy = track-&gt;GetKineticEnergy();
65
66     fastStep.ProposeTrackStatus(fStopAndKill);
67     fastStep.ProposePrimaryTrackPathLength(0.0);
68     fastStep.ProposeTotalEnergyDeposited(energy);
69 }</pre>
</div>
</div>
<div class="section" id="gigasensdetbase">
<h2>GiGaSensDetBase<a class="headerlink" href="#gigasensdetbase" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/GiGaSensDetBase.h</cite>:</p>
<div class="highlight-python"><pre>22 class GiGaSensDetBase: virtual public IGiGaSensDet ,
23                        public GiGaBase
24 {
..
60   /** Method for being a member of a GiGaSensDetSequence
61    *  Implemented by base class, does not need reimplementation!
62    */
63   virtual bool processStep( G4Step* step,
64                             G4TouchableHistory* history );
..
75   bool                m_active  ;  ///&lt; Active Flag
76   std::string         m_detPath ;
77 };</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/GiGa/IGiGaSensDet.h</cite>:</p>
<div class="highlight-python"><pre>22 class IGiGaSensDet: public virtual G4VSensitiveDetector,
23                     public virtual IGiGaInterface
24 {
25 public:
..
35   virtual bool processStep( G4Step* step, G4TouchableHistory* history ) = 0;
36</pre>
</div>
<p><cite>NuWa-trunk/lhcb/Sim/GiGa/src/Lib/GiGaSensDetBase.cpp</cite>:</p>
<div class="highlight-python"><pre>152 // ============================================================================
153 bool GiGaSensDetBase::processStep( G4Step* step,
154                                    G4TouchableHistory* history ) {
155   // delegate to ProcessHits
156   return ProcessHits( step, history );
157
158 }</pre>
</div>
</div>
<div class="section" id="id2">
<h2>G4VSensitiveDetector<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><cite>geant4.10.00.p01/source/digits_hits/detector/include/G4VSensitiveDetector.hh</cite>:</p>
<div class="highlight-python"><pre>50 class G4VSensitiveDetector
51 {
52
53   public: // with description
54       G4VSensitiveDetector(G4String name);
..
68   public: // with description
69       virtual void Initialize(G4HCofThisEvent*);
70       virtual void EndOfEvent(G4HCofThisEvent*);
71       //  These two methods are invoked at the begining and at the end of each
72       // event. The hits collection(s) created by this sensitive detector must
73       // be set to the G4HCofThisEvent object at one of these two methods.
74       virtual void clear();
75       //  This method is invoked if the event abortion is occured. Hits collections
76       // created but not beibg set to G4HCofThisEvent at the event should be deleted.
77       // Collection(s) which have already set to G4HCofThisEvent will be deleted
78       // automatically.
..
84   protected: // with description
85       virtual G4bool ProcessHits(G4Step*aStep,G4TouchableHistory*ROhist) = 0;
86       //  The user MUST implement this method for generating hit(s) using the
87       // information of G4Step object. Note that the volume and the position
88       // information is kept in PreStepPoint of G4Step.
89       //  Be aware that this method is a protected method and it sill be invoked
90       // by Hit() method of Base class after Readout geometry associated to the
91       // sensitive detector is handled.
92       //  "ROhist" will be given only is a Readout geometry is defined to this
93       // sensitive detector. The G4TouchableHistory object of the tracking geometry
94       // is stored in the PreStepPoint object of G4Step.
95       virtual G4int GetCollectionID(G4int i);
96       //  This is a utility method which returns the hits collection ID of the
97       // "i"-th collection. "i" is the order (starting with zero) of the collection
98       // whose name is stored to the collectionName protected vector.
99       G4CollectionNameVector collectionName;
00       //  This protected name vector must be filled at the constructor of the user's
01       // concrete class for registering the name(s) of hits collection(s) being
02       // created by this particular sensitive detector.</pre>
</div>
</div>
<div class="section" id="gdb-session-probe-g4sdmanager">
<h2>GDB Session Probe G4SDManager<a class="headerlink" href="#gdb-session-probe-g4sdmanager" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(gdb) p G4SDManager::GetSDMpointer()
[Switching to Thread -1208218944 (LWP 11466)]
$1 = (G4SDManager *) 0xb24d3d0
Current language:  auto; currently c++
(gdb) p G4SDManager::GetSDMpointer()-&gt;ListTree()
$2 = void</pre>
</div>
<p>stdout from the ListTree:</p>
<div class="highlight-python"><pre>/
/DsRpcSensDet   *** Active
/DsPmtSensDet   *** Active</pre>
</div>
<div class="highlight-python"><pre>(gdb) p G4SDManager::GetSDMpointer()-&gt;GetCollectionCapacity()
Cannot evaluate function -- may be inlined
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCTable()
Couldn't find method G4SDManager::GetHCTable
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()
$3 = (G4HCtable *) 0xb330d38
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;entries()
$4 = 23</pre>
</div>
<div class="highlight-python"><pre>(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;GetSDname(0)
Cannot evaluate function -- may be inlined
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;GetHCname(0)
Cannot evaluate function -- may be inlined
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;GetHCname(1)
Cannot evaluate function -- may be inlined

(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;SDlist[4]
$11 = (const G4String &amp;) @0xb267230: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb36b6d4 "DsPmtSensDet"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;SDlist[5]
$12 = (const G4String &amp;) @0xb267234: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb36b6d4 "DsPmtSensDet"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;SDlist[6]
$13 = (const G4String &amp;) @0xb267238: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb36b6d4 "DsPmtSensDet"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;SDlist[7]
$14 = (const G4String &amp;) @0xb26723c: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb36b6d4 "DsPmtSensDet"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;HClist[7]
$15 = (const G4String &amp;) @0xb147254: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb32aea4 "DayaBayAD3"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;HClist[8]
$16 = (const G4String &amp;) @0xb147258: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb32aec4 "DayaBayAD4"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;HClist[9]
$17 = (const G4String &amp;) @0xb14725c: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb32aee4 "DayaBayIWS"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;GetHCtable()-&gt;HClist[10]
$18 = (const G4String &amp;) @0xb147260: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb32af04 "DayaBayOWS"}}, &lt;No data fields&gt;}
(gdb)</pre>
</div>
<p><cite>source/digits_hits/detector/include/G4SDManager.hh</cite>:</p>
<div class="highlight-python"><pre>50 class G4SDManager
51 {
52   public: // with description
53       static G4SDManager* GetSDMpointer();
54       // Returns the pointer to the singleton object.
55   public:
56       static G4SDManager* GetSDMpointerIfExist();
57
58   protected:
59       G4SDManager();
60
61   public:
62       ~G4SDManager();
63
64   public: // with description
65       void AddNewDetector(G4VSensitiveDetector*aSD);
66       //  Registors the user's sensitive detector. This method must be invoked
67       // when the user construct his/her sensitive detector.
68       void Activate(G4String dName, G4bool activeFlag);
69       //  Activate/inactivate the registered sensitive detector. For the inactivated
70       // detectors, hits collections will not be stored to the G4HCofThisEvent object.
71       G4int GetCollectionID(G4String colName);
72       G4int GetCollectionID(G4VHitsCollection * aHC);
73       //  These two methods return the ID number of the sensitive detector.
74
75   public:
76       G4VSensitiveDetector* FindSensitiveDetector(G4String dName, G4bool warning = true);
77       G4HCofThisEvent* PrepareNewEvent();
78       void TerminateCurrentEvent(G4HCofThisEvent* HCE);
79       void AddNewCollection(G4String SDname,G4String DCname);
80
81
82   private:
83       static G4ThreadLocal G4SDManager * fSDManager;
84       G4SDStructure * treeTop;
85       G4int verboseLevel;
86       G4HCtable* HCtable;
87       G4SDmessenger* theMessenger;
88</pre>
</div>
<p><cite>source/digits_hits/detector/src/G4SDManager.cc</cite>:</p>
<div class="highlight-python"><pre>67 void G4SDManager::AddNewDetector(G4VSensitiveDetector*aSD)
68 {
69   G4int numberOfCollections = aSD-&gt;GetNumberOfCollections();
70   G4String pathName = aSD-&gt;GetPathName();
71   if( pathName(0) != '/' ) pathName.prepend("/");
72   if( pathName(pathName.length()-1) != '/' ) pathName += "/";
73   treeTop-&gt;AddNewDetector(aSD,pathName);
74   if(numberOfCollections&lt;1) return;
75   for(G4int i=0;i&lt;numberOfCollections;i++)
76   {
77     G4String SDname = aSD-&gt;GetName();
78     G4String DCname = aSD-&gt;GetCollectionName(i);
79     AddNewCollection(SDname,DCname);
80   }
81   if( verboseLevel &gt; 0 )
82   {
83     G4cout &lt;&lt; "New sensitive detector &lt;" &lt;&lt; aSD-&gt;GetName()
84          &lt;&lt; "&gt; is registored at " &lt;&lt; pathName &lt;&lt; G4endl;
85   }
86 }</pre>
</div>
<div class="highlight-python"><pre>47 class G4SDStructure
48 {
49   public:
50       G4SDStructure(G4String aPath);
51       ~G4SDStructure();
52
53       G4int operator==(const G4SDStructure &amp;right) const;
54
55       void AddNewDetector(G4VSensitiveDetector*aSD, G4String treeStructure);
56       void Activate(G4String aName, G4bool sensitiveFlag);
57       void Initialize(G4HCofThisEvent*HCE);
58       void Terminate(G4HCofThisEvent*HCE);
59       G4VSensitiveDetector* FindSensitiveDetector(G4String aName, G4bool warning = true);
60       G4VSensitiveDetector* GetSD(G4String aName);
61       void ListTree();
62
63   private:
64       G4SDStructure* FindSubDirectory(G4String subD);
65       G4String ExtractDirName(G4String aPath);
66       void RemoveSD(G4VSensitiveDetector*);
67
68   private:
69       std::vector&lt;G4SDStructure*&gt; structure;
70       std::vector&lt;G4VSensitiveDetector*&gt; detector;
71       G4String pathName;
72       G4String dirName;
73       G4int verboseLevel;</pre>
</div>
<p>Hmm nothing there, killed all photons ? Might be true, but empty implementations anyhow:</p>
<div class="highlight-python"><pre>(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[0]-&gt;PrintAll()
$24 = void
(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;PrintAll()
$25 = void


(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;collectionName.size()
$30 = 19

(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;collectionName[0]
$31 = (const G4String &amp;) @0xb3ce458: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb248be4 "unknown"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;collectionName[1]
$32 = (const G4String &amp;) @0xb3ce45c: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb248bfc "DayaBayAD1"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;collectionName[2]
$33 = (const G4String &amp;) @0xb3ce460: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb32ae84 "DayaBayAD2"}}, &lt;No data fields&gt;}
(gdb) p G4SDManager::GetSDMpointer()-&gt;treeTop-&gt;detector[1]-&gt;collectionName[18]
$34 = (const G4String &amp;) @0xb3ce4a0: {&lt;std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;&gt; = {static npos = 4294967295,
    _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0xb3ce4ec "FarOWS"}}, &lt;No data fields&gt;}
(gdb)</pre>
</div>
<p><cite>source/digits_hits/detector/src/G4HCtable.cc</cite>:</p>
<div class="highlight-python"><pre>37 G4int G4HCtable::Registor(G4String SDname,G4String HCname)
38 {
39   for(size_t i=0;i&lt;HClist.size();i++)
40   { if(HClist[i]==HCname &amp;&amp; SDlist[i]==SDname) return -1; }
41   HClist.push_back(HCname);
42   SDlist.push_back(SDname);
43   return HClist.size();
44 }
45
46 G4int G4HCtable::GetCollectionID(G4String HCname) const
//
//   Collection list index of:
//
//        HCname          "DayaBayIWS"
//        SDname/HCname   "DsPmtSensDet/DayaBayAD4"
//
47 {
48   G4int i = -1;
49   if(HCname.index("/")==std::string::npos) // HCname only
50   {
51     for(size_t j=0;j&lt;HClist.size();j++)
52     {
53       if(HClist[j]==HCname)
54       {
55         if(i&gt;=0) return -2;
56         i = j;
57       }
58     }
59   }
60   else
61   {
62     for(size_t j=0;j&lt;HClist.size();j++)
63     {
64       G4String tgt = SDlist[j];
65       tgt += "/";
66       tgt += HClist[j];
67       if(tgt==HCname)
68       {
69         if(i&gt;=0) return -2;
70         i = j;
71       }
72     }
73   }
74   return i;
75 }</pre>
</div>
</div>
<div class="section" id="de-to-pmtid">
<h2>DE to PMTID<a class="headerlink" href="#de-to-pmtid" title="Permalink to this headline">¶</a></h2>
<p><cite>DetectorElement*-&gt;PmtId integer</cite></p>
<ul class="simple">
<li><a class="reference external" href="http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Detector/XmlDetDescChecks/src/DeDumpAlg.cc">http://dayabay.ihep.ac.cn/tracs/dybsvn/browser/dybgaudi/trunk/Detector/XmlDetDescChecks/src/DeDumpAlg.cc</a></li>
</ul>
</div>
<div class="section" id="collada-id">
<h2>COLLADA ID<a class="headerlink" href="#collada-id" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>COLLADA ID can be reproduced by<ul>
<li>full Geant4 geometry traverse accessing logical/physical names
and duplicating the <cite>daenode.py</cite> de-duping technique and encoding
for XML identifier</li>
<li>this will by necessity visit all the PV in the traverse order</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="collada-id-to-detectorelement">
<h2>COLLADA id to DetectorElement*<a class="headerlink" href="#collada-id-to-detectorelement" title="Permalink to this headline">¶</a></h2>
<p><cite>NuWa-trunk/dybgaudi/Simulation/G4DataHelpers/src/components/TH2DE.h</cite>:</p>
<div class="highlight-python"><pre>19 class TH2DE : public GaudiTool, virtual ITouchableToDetectorElement
20 {
21 public:
22     TH2DE(const std::string&amp; type,
23          const std::string&amp; name,
24          const IInterface* parent);
25     virtual ~TH2DE();
26
27     virtual StatusCode GetBestDetectorElement(const G4TouchableHistory* inHistory,
28                                               const std::vector&lt;std::string&gt;&amp; /*ignored*/,
29                                               const IDetectorElement* &amp;outElement,
30                                               int&amp; outCompatibility);
31
32     virtual StatusCode G4VolumeToDetDesc(const G4VPhysicalVolume* inVol,
33                                          const IPVolume* &amp;outVol);
34
35     virtual StatusCode ClearCache();</pre>
</div>
<p><cite>NuWa-trunk/Simulation/G4DataHelpers/src/components/TouchableToDetectorElementFast.h</cite>:</p>
<div class="highlight-python"><pre>13 class TouchableToDetectorElementFast : public GaudiTool, virtual ITouchableToDetectorElement
14 {
15   public:
16   TouchableToDetectorElementFast(const std::string&amp; type,
17                              const std::string&amp; name,
18                             const IInterface* parent);
19   virtual ~TouchableToDetectorElementFast() {};
20
21   /// Do the conversion.
22   virtual StatusCode GetBestDetectorElement(
23                           const G4TouchableHistory* inHistory,  // The current particle location
24                           const std::vector&lt;std::string&gt;&amp; inPath,// Name(s) of specific detElements, or paths to be searched
25                           const IDetectorElement* &amp;outElement,  // output: The best element (may be zero!)
26                           int&amp; outCompatibility );              // output: the goodness of the match (lower is better, &lt;=0 means no match.)
27
28   /// Utility to do a simpler conversion: find the IPVolume from a G4PhysicalVolume.
29   virtual StatusCode G4VolumeToDetDesc( const G4VPhysicalVolume* inVol,     ///&lt; Input G4 volume
30                                         const IPVolume* &amp;outVol             ///&lt; Output DetDesc volume
31                                        );
32
33   /// Clear caches in case of geometry change.
34  virtual StatusCode ClearCache();
35
36  private:
37
38    // Things to store in the cache:
39    struct Relation {
40      Relation() : mLogVol(0), mPhysVol(0), mRpath(0) {};
41      bool isNull() const { return mLogVol==0; };
42      const ILVolume*          mLogVol; // The supporting volume
43      const IPVolume*          mPhysVol;
44      ILVolume::ReplicaPath    mRpath;  // Empty if it is not under the mWorldElement.
45    };
46
47    // The Cache:
48    const IDetectorElement* mWorldElement;   // From recent calls. Changing this causes cache flushing.
49    std::string             mWorldElementName; // The name of above.
50    typedef std::map&lt;const G4VPhysicalVolume*,Relation&gt; G4ToRelationMap_t;
51    typedef std::map&lt;const IDetectorElement* ,Relation&gt; DetElemToRelationMap_t;
52    typedef std::list&lt;const IDetectorElement*&gt;          ElementList_t;
53    G4ToRelationMap_t      mG4ToRelationMap;
54    DetElemToRelationMap_t mDetElemToRelationMap;
55    std::vector&lt;std::string&gt;             mLastSearchPaths;
56    ElementList_t                        mElementList;
57
58    StatusCode GetRelation(const G4VPhysicalVolume* inVol, Relation* &amp;outRelation );
59    StatusCode GetRelation(const IDetectorElement* inElem, Relation* &amp;outRelation );
60
61   /// Returns -1 if incompatible, returns number that increases the better the container describes the place.
62   int        Compatability(const ILVolume::ReplicaPath&amp; inPlace, const ILVolume::ReplicaPath&amp; inContainer);
63
64   template &lt; class T  &gt;
65   StatusCode FindObjectsInDirectory(const std::string&amp; dirname, std::list&lt;const T*&gt;&amp; outList);
66
67 };</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../detsim_configuration/" title="DetSim Configuration"
             >next</a> |</li>
        <li class="right" >
          <a href="../detsim_giga_geant4_handoff/" title="DetSim GiGa Geant4 Handoff"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >nuwa</a> &raquo;</li>
          <li><a href="../" >detsim</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>