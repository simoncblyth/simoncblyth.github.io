<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Geant4 StackManager &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="Geant4 Event" href="../" />
    <link rel="next" title="Geant4 TrackingAction" href="../geant4_trackingaction/" />
    <link rel="prev" title="Geant4 StackingAction" href="../geant4_stackingaction/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../geant4_trackingaction/" title="Geant4 TrackingAction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../geant4_stackingaction/" title="Geant4 StackingAction"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >geant4</a> &raquo;</li>
          <li><a href="../" accesskey="U">Geant4 Event</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">geant4</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geant4_gpu/">Geant4 GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geant4_profiling/">Geant4 Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../verbosity/">Verbosity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../docs/">Geant4 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../giga/">GiGa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/">Geant4 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../opticalphoton/">Geant4 Optical Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processes/">Geant4 Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../medical/">Medical Communities Using Geant4 (esp. optical photon)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geometry/">Geant4 Geometry Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../g4py/">g4py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">Geant4 Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geant4_future_doe/">Geant4</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/geant4/event/geant4_stackmanager.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../geant4_stackingaction/"
                        title="previous chapter">Geant4 StackingAction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../geant4_trackingaction/"
                        title="next chapter">Geant4 TrackingAction</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="geant4-stackmanager">
<h1>Geant4 StackManager<a class="headerlink" href="#geant4-stackmanager" title="Permalink to this headline">¶</a></h1>
<p>Comments below aim at developing an external
Optical Photon Propagation Stategy</p>
<div class="section" id="g4stackmanager-hh">
<h2>G4StackManager.hh<a class="headerlink" href="#g4stackmanager-hh" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>the stacks are private, with no accessors</li>
<li>can setup multiple waiting stacks : that could be useful if need to multipart ZMQ message</li>
</ol>
<p><cite>source/event/include/G4StackManager.hh</cite>:</p>
<div class="highlight-python"><pre>049 // class description:
050 //
051 // This is the manager class of handling stacks of G4Track objects.
052 // This class must be a singleton and be constructed by G4EventManager.
053 // Almost all methods must be invoked exclusively by G4EventManager.
054 // Especially, some Clear() methods MUST NOT be invoked by the user.
055 // Event abortion is handled by G4EventManager.
056 //
057 // This G4StackingManager has three stacks, the urgent stack, the
058 // waiting stack, and the postpone to next event stack. The meanings
059 // of each stack is descrived in the Geant4 user's manual.
060 //
061
062 class G4StackManager
063 {
064   public:
065       G4StackManager();
066       ~G4StackManager();
067
068   private:
069       const G4StackManager&amp; operator=(const G4StackManager &amp;right);
070       G4int operator==(const G4StackManager &amp;right) const;
071       G4int operator!=(const G4StackManager &amp;right) const;
072
073   public:
074       G4int PushOneTrack(G4Track *newTrack, G4VTrajectory *newTrajectory = 0);
075       G4Track * PopNextTrack(G4VTrajectory**newTrajectory);
076       G4int PrepareNewEvent();
077
078   public: // with description
079       void ReClassify();
080       //  Send all tracks stored in the Urgent stack one by one to
081       // the user's concrete ClassifyNewTrack() method. This method
082       // can be invoked from the user's G4UserStackingAction concrete
083       // class, especially fron its NewStage() method. Be aware that
084       // when the urgent stack becomes empty, all tracks in the waiting
085       // stack are send to the urgent stack and then the user's NewStage()
086       // method is invoked.
087
088       void SetNumberOfAdditionalWaitingStacks(G4int iAdd);
089       //  Set the number of additional (optional) waiting stacks.
090       // This method must be invoked at PreInit, Init or Idle states.
091       // Once the user set the number of additional waiting stacks,
092       // he/she can use the corresponding ENUM in G4ClassificationOfNewTrack.
093       // The user should invoke G4RunManager::SetNumberOfAdditionalWaitingStacks
094       // method, which invokes this method.
095
096       void TransferStackedTracks(G4ClassificationOfNewTrack origin, G4ClassificationOfNewTrack destination);
097       //  Transfter all stacked tracks from the origin stack to the destination stack.
098       // The destination stack needs not be empty.
099       // If the destination is fKill, tracks are deleted.
100       // If the origin is fKill, nothing happen.
101
102       void TransferOneStackedTrack(G4ClassificationOfNewTrack origin, G4ClassificationOfNewTrack destination);
103       //  Transfter one stacked track from the origin stack to the destination stack.
104       // The transfered track is the one which came last to the origin stack.
105       // The destination stack needs not be empty.
106       // If the destination is fKill, the track is deleted.
107       // If the origin is fKill, nothing happen.
108
109   private:
110       G4UserStackingAction * userStackingAction;
111       G4int verboseLevel;
112 #ifdef G4_USESMARTSTACK
113       G4SmartTrackStack * urgentStack;
114 #else
115       G4TrackStack * urgentStack;
116 #endif
117       G4TrackStack * waitingStack;
118       G4TrackStack * postponeStack;
119       G4StackingMessenger* theMessenger;
120       std::vector&lt;G4TrackStack*&gt; additionalWaitingStacks;
121       G4int numberOfAdditionalWaitingStacks;
122
123   public:
124       void clear();
125       void ClearUrgentStack();
126       void ClearWaitingStack(int i=0);
127       void ClearPostponeStack();
128       G4int GetNTotalTrack() const;
129       G4int GetNUrgentTrack() const;
130       G4int GetNWaitingTrack(int i=0) const;
131       G4int GetNPostponedTrack() const;
132       void SetVerboseLevel( G4int const value );
133       void SetUserStackingAction(G4UserStackingAction* value);
134
135   private:
136      G4ClassificationOfNewTrack DefaultClassification(G4Track *aTrack);
137 };
138
139 #endif</pre>
</div>
</div>
<div class="section" id="g4stackmanager-g4stackmanager">
<h2>G4StackManager::G4StackManager<a class="headerlink" href="#g4stackmanager-g4stackmanager" title="Permalink to this headline">¶</a></h2>
<p><cite>source/event/src/G4StackManager.cc</cite>:</p>
<div class="highlight-python"><pre>39 G4StackManager::G4StackManager()
40 :userStackingAction(0),verboseLevel(0),numberOfAdditionalWaitingStacks(0)
41 {
42   theMessenger = new G4StackingMessenger(this);
43 #ifdef G4_USESMARTSTACK
44   urgentStack = new G4SmartTrackStack;
45  // G4cout&lt;&lt;"+++ G4StackManager uses G4SmartTrackStack. +++"&lt;&lt;G4endl;
46 #else
47   urgentStack = new G4TrackStack(5000);
48 //  G4cout&lt;&lt;"+++ G4StackManager uses ordinary G4TrackStack. +++"&lt;&lt;G4endl;
49 #endif
50   waitingStack = new G4TrackStack(1000);
51   postponeStack = new G4TrackStack(1000);
52 }
..</pre>
</div>
<div class="section" id="g4trackstack">
<h3>G4TrackStack<a class="headerlink" href="#g4trackstack" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>45 // This is a stack class used by G4StackManager. This class object
46 // stores G4StackedTrack class objects in the form of bi-directional
47 // linked list.
48
49 class G4TrackStack : public std::vector&lt;G4StackedTrack&gt;
50 {
51 public:
52     G4TrackStack() : safetyValve1(0), safetyValve2(0), nstick(0) {}
53   G4TrackStack(size_t n) : safetyValve1(4*n/5), safetyValve2(4*n/5-100), nstick(100) { reserve(n);}
54   ~G4TrackStack();
55</pre>
</div>
</div>
<div class="section" id="g4stackedtrack">
<h3>G4StackedTrack<a class="headerlink" href="#g4stackedtrack" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><strong>simple</strong> holder for track and trajectory pointers<ul>
<li>this might provide an opportunity to avoid keeping huge wait stacks of photons
waiting around, whilst there Chroma copies are externally propagated</li>
<li>maybe can get away with deleting the track (and not creating the trajectory)
and just keeping the G4StackedTrack alive as a placeholder</li>
<li>the place holder can then be repopulated with tracks created from the
results of the external propagation</li>
</ul>
</li>
</ul>
<p><cite>source/event/include/G4StackedTrack.hh</cite>:</p>
<div class="highlight-python"><pre>41 //
42 // This class is exclusively used by G4StackManager and G4TrackStack
43 // classes for storing a G4Track object.
44
45 class G4StackedTrack
46 {
47 public:
48   G4StackedTrack() : track(0), trajectory(0) {}
49   G4StackedTrack(G4Track* aTrack, G4VTrajectory* aTraj = 0) : track(aTrack), trajectory(aTraj) {}
50   ~G4StackedTrack() {}
51
52 private:
53   G4Track* track;
54   G4VTrajectory* trajectory;
55
56 public:
57   G4Track* GetTrack() const { return track; }
58   G4VTrajectory* GetTrajectory() const { return trajectory; }
59 };
60
61 #endif</pre>
</div>
</div>
<div class="section" id="g4track">
<h3>G4Track<a class="headerlink" href="#g4track" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>its fat</li>
</ul>
<p><cite>source/track/include/G4Track.hh</cite>:</p>
<div class="highlight-python"><pre>072 //////////////
073 class G4Track
074 //////////////
075 {
076
077 //--------
078 public: // With description
079
080 // Constructor
081    G4Track();
082    G4Track(G4DynamicParticle* apValueDynamicParticle,
083            G4double aValueTime,
084            const G4ThreeVector&amp; aValuePosition);
085       // aValueTime is a global time
086    G4Track(const G4Track&amp;);
087    // Copy Constructor copys members other than tracking information
088
...
114    G4int GetTrackID() const;
115    void SetTrackID(const G4int aValue);
116
117    G4int GetParentID() const;
118    void SetParentID(const G4int aValue);
119
120   // dynamic particle
121    const G4DynamicParticle* GetDynamicParticle() const;</pre>
</div>
<p><cite>source/track/src/G4Track.cc</cite>:</p>
<div class="highlight-python"><pre>094 //////////////////
095 G4Track::G4Track()
096 //////////////////
097   : fCurrentStepNumber(0),
098     fGlobalTime(0),           fLocalTime(0.),
099     fTrackLength(0.),
100     fParentID(0),             fTrackID(0),
101     fVelocity(c_light),
102     fpDynamicParticle(0),
103     fTrackStatus(fAlive),
104     fBelowThreshold(false),   fGoodForTracking(false),
105     fStepLength(0.0),         fWeight(1.0),
106     fpStep(0),
107     fVtxKineticEnergy(0.0),
108     fpLVAtVertex(0),          fpCreatorProcess(0),
109     fCreatorModelIndex(-1),
110     fpUserInformation(0),
111     prev_mat(0),  groupvel(0),
112     prev_velocity(0.0), prev_momentum(0.0),
113     is_OpticalPhoton(false),
114     useGivenVelocity(false)
115 {
116 }

/// default ctor : not so fat</pre>
</div>
</div>
<div class="section" id="g4dynamicparticle">
<h3>G4DynamicParticle<a class="headerlink" href="#g4dynamicparticle" title="Permalink to this headline">¶</a></h3>
<p><cite>source/particles/management/include/G4DynamicParticle.hh</cite>:</p>
<div class="highlight-python"><pre>73 class G4DynamicParticle
74 {
75   // Class Description
76   //  The dynamic particle is a class which contains the purely
77   //  dynamic aspects of a moving particle. It also has a
78   //  pointer to a G4ParticleDefinition object, which holds
79   //  all the static information.
80   //</pre>
</div>
</div>
</div>
<div class="section" id="g4stackmanager-pushonetrack">
<h2>G4StackManager::PushOneTrack<a class="headerlink" href="#g4stackmanager-pushonetrack" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>92 G4int G4StackManager::PushOneTrack(G4Track *newTrack,G4VTrajectory *newTrajectory)
93 {
...
166   G4ClassificationOfNewTrack classification = DefaultClassification( newTrack );
167   if(userStackingAction)
168   { classification = userStackingAction-&gt;ClassifyNewTrack( newTrack ); }

///     Maybe could in ClassifyNewTrack:
///
///          * collect OP trackinfo into ChromaPhotonList
///          * delete the OP track, set pointer to NULL   (hmm its called `const G4Track*`, maybe need some patching)
///            [this would avoid pointlessly holding large memory expensive stacks of OPs ]
///          * return fWaiting for OPs
///

169
170   if(classification==fKill)   // delete newTrack without stacking
171   {
...
180     delete newTrack;
181     delete newTrajectory;
182   }
183   else
184   {
185     G4StackedTrack newStackedTrack( newTrack, newTrajectory );
186     switch (classification)
187     {
188       case fUrgent:
189         urgentStack-&gt;PushToStack( newStackedTrack );
190         break;
191       case fWaiting:
192         waitingStack-&gt;PushToStack( newStackedTrack );
///                  newTrack could be NULL here without harm
193         break;
194       case fPostpone:
195         postponeStack-&gt;PushToStack( newStackedTrack );
196         break;
197       default:
198         G4int i = classification - 10;
199         if(i&lt;1||i&gt;numberOfAdditionalWaitingStacks) {
200           G4ExceptionDescription ED;
201           ED &lt;&lt; "invalid classification " &lt;&lt; classification &lt;&lt; G4endl;
202           G4Exception("G4StackManager::PushOneTrack","Event0051",
203           FatalException,ED);
204         } else {
205           additionalWaitingStacks[i-1]-&gt;PushToStack( newStackedTrack );
206         }
207         break;
208     }
209   }
210
211   return GetNUrgentTrack();
212 }</pre>
</div>
</div>
<div class="section" id="g4stackmanager-popnexttrack">
<h2>G4StackManager::PopNextTrack<a class="headerlink" href="#g4stackmanager-popnexttrack" title="Permalink to this headline">¶</a></h2>
<div class="section" id="external-propagation-intervention-possibilities">
<h3>External Propagation Intervention Possibilities<a class="headerlink" href="#external-propagation-intervention-possibilities" title="Permalink to this headline">¶</a></h3>
<p>At <cite>NewStage</cite>:</p>
<ul class="simple">
<li>have collected all the OPs</li>
<li>have also seen all other tracks, so can judge whether the event is interesting to proceed with</li>
</ul>
<p>Thus within <cite>NewStage</cite> for interesting events:</p>
<ul class="simple">
<li>send ZMQ REQ message with serialized ChromaPhotonList  to Chroma server,</li>
<li>block until get REP, in the form of propagated ChromaPhotonList<ul>
<li>propagated till where ? OP subset ? enter PMT/hit Bialkali</li>
</ul>
</li>
<li>then call <cite>ReClassify</cite> to revisit the track placeholders<ul>
<li>when receive NULL tracks, switch them for propagated tracks and classify <cite>fUrgent</cite></li>
<li>for the extra NULLs (as only a subset of photons will come back) create a
sacrificial track and classify <cite>fKill</cite></li>
</ul>
</li>
</ul>
<p>Maybe:</p>
<ul class="simple">
<li>do i need to match <cite>trackID,parentID</cite>  to keep G4 fooled ?<ul>
<li>probably not useful</li>
</ul>
</li>
<li>how involved is creating tracks ?</li>
</ul>
</div>
<div class="section" id="standard-operation">
<h3>Standard Operation<a class="headerlink" href="#standard-operation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>084       // when the urgent stack becomes empty, all tracks in the waiting
085       // stack are send to the urgent stack and then the user's NewStage()
086       // method is invoked.</pre>
</div>
<ul>
<li><p class="first">pops from urgent until thats empty</p>
</li>
<li><p class="first">then waiting stack transferred to urgent</p>
</li>
<li><p class="first">additional waiting stacks are shunted to one higher priority notch</p>
</li>
<li><p class="first"><cite>userStackingAction::NewStage</cite> then gives opportunity to</p>
<blockquote>
<div><ul class="simple">
<li><cite>ReClassify</cite> OR <cite>clear</cite></li>
<li>the <cite>ReClassify</cite> calls <cite>ClassifyNewTrack</cite> for each track that has been waiting</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-python"><pre>215 G4Track * G4StackManager::PopNextTrack(G4VTrajectory**newTrajectory)
216 {
225   while( GetNUrgentTrack() == 0 )
226   {
...
231     waitingStack-&gt;TransferTo(urgentStack);
232     if(numberOfAdditionalWaitingStacks&gt;0) {
233       for(int i=0;i&lt;numberOfAdditionalWaitingStacks;i++) {
234         if(i==0) {
235           additionalWaitingStacks[0]-&gt;TransferTo(waitingStack);
236         } else {
237           additionalWaitingStacks[i]-&gt;TransferTo(additionalWaitingStacks[i-1]);
238         }
239       }
240     }
241     if(userStackingAction) userStackingAction-&gt;NewStage();
...
247     if( ( GetNUrgentTrack()==0 ) &amp;&amp; ( GetNWaitingTrack()==0 ) ) return 0;
248   }
249
250   G4StackedTrack selectedStackedTrack = urgentStack-&gt;PopFromStack();
251   G4Track * selectedTrack = selectedStackedTrack.GetTrack();
252   *newTrajectory = selectedStackedTrack.GetTrajectory();
...
265   return selectedTrack;
266 }</pre>
</div>
</div>
</div>
<div class="section" id="g4stackmanager-reclassify">
<h2>G4StackManager::ReClassify<a class="headerlink" href="#g4stackmanager-reclassify" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>268 void G4StackManager::ReClassify()
269 {
270   G4StackedTrack aStackedTrack;
271   G4TrackStack tmpStack;
272
273   if( !userStackingAction ) return;
274   if( GetNUrgentTrack() == 0 ) return;
275
276   urgentStack-&gt;TransferTo(&amp;tmpStack);
277   while( tmpStack.GetNTrack() &gt; 0 )
278   {
279     aStackedTrack=tmpStack.PopFromStack();
280     G4ClassificationOfNewTrack classification =
281     userStackingAction-&gt;ClassifyNewTrack( aStackedTrack.GetTrack() );
282     switch (classification)
283     {
284       case fKill:
285         delete aStackedTrack.GetTrack();
286         delete aStackedTrack.GetTrajectory();
287         break;
288       case fUrgent:
289         urgentStack-&gt;PushToStack( aStackedTrack );
290         break;
291       case fWaiting:
292         waitingStack-&gt;PushToStack( aStackedTrack );
293         break;
294       case fPostpone:
295         postponeStack-&gt;PushToStack( aStackedTrack );
296         break;
297       default:
298         G4int i = classification - 10;
299         if(i&lt;1||i&gt;numberOfAdditionalWaitingStacks) {
300           G4ExceptionDescription ED;
301           ED &lt;&lt; "invalid classification " &lt;&lt; classification &lt;&lt; G4endl;
302           G4Exception("G4StackManager::ReClassify","Event0052",
303                       FatalException,ED);
304         } else {
305           additionalWaitingStacks[i-1]-&gt;PushToStack( aStackedTrack );
306         }
307         break;
308     }
309   }
310 }</pre>
</div>
</div>
<div class="section" id="preparenewevent">
<h2>PrepareNewEvent<a class="headerlink" href="#preparenewevent" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>312 G4int G4StackManager::PrepareNewEvent()
313 {
314   if(userStackingAction) userStackingAction-&gt;PrepareNewEvent();
315
316   urgentStack-&gt;clearAndDestroy(); // Set the urgentStack in a defined state. Not doing it would affect reproducibility.
317
318   G4int n_passedFromPrevious = 0;
319
320   if( GetNPostponedTrack() &gt; 0 )
321   {
...
379   }
380
381   return n_passedFromPrevious;
382 }</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../geant4_trackingaction/" title="Geant4 TrackingAction"
             >next</a> |</li>
        <li class="right" >
          <a href="../geant4_stackingaction/" title="Geant4 StackingAction"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >geant4</a> &raquo;</li>
          <li><a href="../" >Geant4 Event</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>