<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>DAEVertexBuffer Dev Notes &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../../" />
    <link rel="up" title="g4daeview" href="../" />
    <link rel="next" title="DAEPhotonsShader" href="../daephotonsshader/" />
    <link rel="prev" title="Daeview Dev Notes" href="../g4daeview_devnotes/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../daephotonsshader/" title="DAEPhotonsShader"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../g4daeview_devnotes/" title="Daeview Dev Notes"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" accesskey="U">g4daeview</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../">geant4</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_gpu/">Geant4 GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_profiling/">Geant4 Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../verbosity/">Verbosity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../docs/">Geant4 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../giga/">GiGa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/">Geant4 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../opticalphoton/">Geant4 Optical Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../processes/">Geant4 Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../medical/">Medical Communities Using Geant4 (esp. optical photon)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../">Geant4 Geometry Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../g4py/">g4py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../event/">Geant4 Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_future_doe/">Geant4</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../../_sources/geant4/geometry/collada/g4daeview/daevertexbuffer.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../g4daeview_devnotes/"
                        title="previous chapter">Daeview Dev Notes</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../daephotonsshader/"
                        title="next chapter">DAEPhotonsShader</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="daevertexbuffer-dev-notes">
<h1>DAEVertexBuffer Dev Notes<a class="headerlink" href="#daevertexbuffer-dev-notes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="interop">
<h2>Interop<a class="headerlink" href="#interop" title="Permalink to this headline">¶</a></h2>
<p>Motivation:</p>
<blockquote>
<div>To avoid buffer recreation for visualization need to get Chroma/CUDA to
use the OpenGL buffers.</div></blockquote>
<p>Interop steps gleaned from raycaster PBO usage:</p>
<ol class="arabic simple">
<li>import pycuda.gl as cuda_gl                  # special GL enabled CUDA context  (handle in DAEChromaContext)</li>
<li>cuda_pbo = cuda_gl.BufferObject(long(pbo))   # needs CUDA context, pbo is OpenGL buffer id</li>
<li>cuda_pbo.unregister()                        # ends CUDA responsibility, allows OpenGL access for drawing</li>
<li>pbo_mapping = cuda_pbo.map()                 # CUDA takes responsibility</li>
<li>pbo_device_ptr = pbo_mapping.device_ptr()    # pointer to device memory to pass as kernel call argument</li>
<li>pbo_mapping.unmap()                          # after the kernel call, declares end of CUDA usage</li>
</ol>
<p>Currently are using the simple and inefficient technique
of recreating the VBOs whenever need to change anything.</p>
<p>Ruminations</p>
<ol class="arabic">
<li><p class="first">having separate VBOs for drawing lines and points is inconvenient, especially
when have CUDA in the mix</p>
<ul>
<li><p class="first">should be able to draw points from the lines VBO via indices control
(ie have one vertex array and which is used with two different indices arrays)</p>
</li>
<li><p class="first">how about flag control photon selections ? glumpy VertexBuffer glues together
vertices and indices as pair of ctor arguments : they do not need to go together.</p>
<p>ie could split that off and do the indices selection on CPU in similar manner
to current ? But what about on GPU selection, it just needs bit field comparison to
uniform argument mask or history bitfield ... hmm but still would need to
pull out the selection bits CPU side to setup the OpenGL indices ? So little gain.
Does OpenGL have some concept of a mask array ?</p>
<p>Can control color in the kernel, so make unselected invisible (set alpha to 0)</p>
<ul class="simple">
<li><a class="reference external" href="http://www.google.com/search?q=OpenGL CUDA vertex selection">google:OpenGL CUDA vertex selection</a></li>
<li><a class="reference external" href="http://www.opengl.org/wiki/Vertex_Rendering">http://www.opengl.org/wiki/Vertex_Rendering</a></li>
</ul>
</li>
<li><p class="first">2nd point of line pair can be calculated in the kernel following CUDA propagation,
with line length being a uniform
NB need to keep the slot, initially fill it from numpy for the non-CUDA installs</p>
</li>
</ul>
</li>
<li><p class="first">need to retain drawing of initial photon positions/directions for non-chroma installs</p>
</li>
</ol>
<div class="section" id="too-many-moving-parts">
<h3>Too Many Moving parts<a class="headerlink" href="#too-many-moving-parts" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>OpenGL vertex attributes description of initial numpy ndarray</li>
<li>shader attribute binding to access them from shaders</li>
<li>what is PyCUDA GPUArray actually doing, as using OpenGL buffers
direct from PyCUDA replaces this</li>
<li>visualization gymnastics should not substantially impact
without-vis propagation</li>
</ol>
</div>
<div class="section" id="aos-or-soa">
<h3>AoS or SoA<a class="headerlink" href="#aos-or-soa" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/17924705/structure-of-arrays-vs-array-of-structures-in-cuda">http://stackoverflow.com/questions/17924705/structure-of-arrays-vs-array-of-structures-in-cuda</a></li>
</ul>
</div>
<div class="section" id="data-flow">
<h3>Data flow<a class="headerlink" href="#data-flow" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>ROOT deserializes the ChromaPhotonList bytes arriving from file or ZMQ into a ChromaPhotonList
instance (a collection std::vector&lt;float&gt; and std::vector&lt;int&gt;)</li>
<li>copy <cite>pos</cite>, <cite>dir</cite>, <cite>wavelength</cite>, <cite>t</cite> etc into numpy arrays inside a chroma.event.Photons instance</li>
<li>copy subset of those arrays into &#8220;pdata&#8221; numpy ndarray</li>
</ol>
<p>The underlying data is coming from a numpy ndarray. Perhaps pycuda has
solved the problem already ? <a class="reference external" href="http://documen.tician.de/pycuda/array.html">http://documen.tician.de/pycuda/array.html</a>
Maybe, but for interop need to make pycuda use the OpenGL buffers.</p>
</div>
<div class="section" id="what-needs-to-be-shared-between-cuda-and-opengl">
<h3>What needs to be shared between CUDA and OpenGL ?<a class="headerlink" href="#what-needs-to-be-shared-between-cuda-and-opengl" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>position</li>
<li>momdir (for lines)</li>
<li>wavelength</li>
<li>propagation flags, for selection/history</li>
</ol>
</div>
<div class="section" id="single-vbo-approach-array-of-structs">
<h3>Single VBO approach (array-of-structs)<a class="headerlink" href="#single-vbo-approach-array-of-structs" title="Permalink to this headline">¶</a></h3>
<p>This approach bangs into CUDA alignment/padding complexities device side and arriving
at the struct that matches the OpenGL buffer layout.</p>
<ul class="simple">
<li><a class="reference external" href="http://www.igorsevo.com/Article.aspx?article=Million+particles+in+CUDA+and+OpenGL">http://www.igorsevo.com/Article.aspx?article=Million+particles+in+CUDA+and+OpenGL</a></li>
<li><a class="reference external" href="http://on-demand.gputechconf.com/gtc/2013/presentations/S3477-GPGPU-In-Film-Production.pdf">http://on-demand.gputechconf.com/gtc/2013/presentations/S3477-GPGPU-In-Film-Production.pdf</a></li>
</ul>
<div class="highlight-python"><pre>glBindBuffer(GL_ARRAY_BUFFER, vbo);
glVertexPointer(3, GL_FLOAT, 16, 0);
glColorPointer(4,GL_UNSIGNED_BYTE,16,(GLvoid*)12);</pre>
</div>
<p>In CUDA stuffs the colors into a float using a union:</p>
<div class="highlight-python"><pre>union Color
{
    float c;
    uchar4 components;
};

Color temp;
temp.components = make_uchar4(128/length,(int)(255/(velocity*51)),255,10);
pos[y*width+x].w = temp.c;</pre>
</div>
<p>Ahha, users of OpenGL compute shaders face the same issues</p>
<ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/21342814/rendering-data-in-opengl-vertices-and-compute-shaders">http://stackoverflow.com/questions/21342814/rendering-data-in-opengl-vertices-and-compute-shaders</a></li>
<li><a class="reference external" href="http://www.opengl.org/registry/doc/glspec43.core.20130214.pdf">http://www.opengl.org/registry/doc/glspec43.core.20130214.pdf</a><ul>
<li>7.6.2.2 - Standard Uniform Block Layout</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="nvidia-example">
<h3>NVIDIA Example<a class="headerlink" href="#nvidia-example" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>/usr/local/env/cuda/NVIDIA_CUDA-5.5_Samples/2_Graphics/simpleGL</li>
</ul>
</div>
<div class="section" id="targetted-googling">
<h3>Targetted googling<a class="headerlink" href="#targetted-googling" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://www.google.com/search?q=cuda kernel float4* VBO">google:cuda kernel float4* VBO</a></li>
</ul>
<div class="section" id="andyswarm">
<h4>andyswarm<a class="headerlink" href="#andyswarm" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>color and position both as float4 with colors offset after position</li>
<li>Advantage is can use <cite>float4 *dptr</cite> just like simpleGL example.</li>
</ol>
<ul class="simple">
<li><a class="reference external" href="http://www.evl.uic.edu/aej/525/code/andySwarm.cu">http://www.evl.uic.edu/aej/525/code/andySwarm.cu</a></li>
<li><a class="reference external" href="http://www.evl.uic.edu/aej/525/code/andySwarm_kernel.cu">http://www.evl.uic.edu/aej/525/code/andySwarm_kernel.cu</a></li>
</ul>
<div class="highlight-python"><pre>// render from the vbo
glBindBuffer(GL_ARRAY_BUFFER, vbo);
glVertexPointer(4, GL_FLOAT, 0, 0);
glColorPointer(4, GL_FLOAT, 0, (GLvoid *) (mesh_width * mesh_height * sizeof(float)*4));</pre>
</div>
</div>
</div>
<div class="section" id="separate-vbo-approach-struct-of-arrays">
<h3>Separate VBO approach (struct-of-arrays)<a class="headerlink" href="#separate-vbo-approach-struct-of-arrays" title="Permalink to this headline">¶</a></h3>
<p>This approach avoids the struct problems at expense of high level
bookkeeping for the multiple VBOs. Potentially an OpenGL draw performance hit
too.</p>
<ul class="simple">
<li><a class="reference external" href="http://www.drdobbs.com/parallel/cuda-supercomputing-for-the-masses-part/225200412?pgno=6">http://www.drdobbs.com/parallel/cuda-supercomputing-for-the-masses-part/225200412?pgno=6</a></li>
</ul>
<p>Example uses separate VBOs for position and color and does
manual linear addressing to change them from CUDA.
Then OpenGL draws by binding to the multiple different VBO.</p>
<p>This is nice and simple at expense of lots of VBOs</p>
<div class="highlight-python"><pre>__global__ void kernel(float4* pos, uchar4 *colorPos,
           unsigned int width, unsigned int height, float time)
{
    unsigned int x = blockIdx.x*blockDim.x + threadIdx.x;
    unsigned int y = blockIdx.y*blockDim.y + threadIdx.y;
    ...

    // write output vertex
    pos[y*width+x] = make_float4(u, w, v, 1.0f);
    colorPos[y*width+x].w = 0;
    colorPos[y*width+x].x = 255.f *0.5*(1.f+sinf(w+x));
    colorPos[y*width+x].y = 255.f *0.5*(1.f+sinf(x)*cosf(y));
    colorPos[y*width+x].z = 255.f *0.5*(1.f+sinf(w+time/10.f));
}</pre>
</div>
<p>The splitting between arrays is done at glBindBuffer:</p>
<div class="highlight-python"><pre>void renderCuda(int drawMode)
{
  glBindBuffer(GL_ARRAY_BUFFER, vertexVBO.vbo);
  glVertexPointer(4, GL_FLOAT, 0, 0);
  glEnableClientState(GL_VERTEX_ARRAY);

  glBindBuffer(GL_ARRAY_BUFFER, colorVBO.vbo);
  glColorPointer(4, GL_UNSIGNED_BYTE, 0, 0);
  glEnableClientState(GL_COLOR_ARRAY);</pre>
</div>
</div>
<div class="section" id="glbindbuffer">
<h3>glBindBuffer<a class="headerlink" href="#glbindbuffer" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://www.khronos.org/opengles/sdk/docs/man/xhtml/glBindBuffer.xml">http://www.khronos.org/opengles/sdk/docs/man/xhtml/glBindBuffer.xml</a></li>
</ul>
<p>glBindBuffer lets you create or use a named buffer object. Calling glBindBuffer
with target set to GL_ARRAY_BUFFER or GL_ELEMENT_ARRAY_BUFFER and buffer set to
the name of the new buffer object binds the buffer object name to the target.
When a buffer object is bound to a target, the previous binding for that target
is automatically broken.</p>
<p>When vertex array pointer state is changed by a call to glVertexAttribPointer,
the current buffer object binding (GL_ARRAY_BUFFER_BINDING) is copied into the
corresponding client state for the vertex attrib array being changed, one of
the indexed GL_VERTEX_ATTRIB_ARRAY_BUFFER_BINDINGs. While a non-zero buffer
object is bound to the GL_ARRAY_BUFFER target, the vertex array pointer
parameter that is traditionally interpreted as a pointer to client-side memory
is instead interpreted as an offset within the buffer object measured in basic
machine units.</p>
</div>
</div>
<div class="section" id="opengl-drawing-techniques">
<h2>OpenGL Drawing Techniques<a class="headerlink" href="#opengl-drawing-techniques" title="Permalink to this headline">¶</a></h2>
<div class="section" id="gldrawelements">
<h3>glDrawElements<a class="headerlink" href="#gldrawelements" title="Permalink to this headline">¶</a></h3>
<p>Buffer offset default of 0 corresponds to glumpy original None, (ie (void*)0 )
the integer value is converted with <cite>ctypes.c_void_p(offset)</cite>
allowing partial buffer drawing.</p>
<ul class="simple">
<li><a class="reference external" href="http://pyopengl.sourceforge.net/documentation/manual-3.0/glDrawElements.html">http://pyopengl.sourceforge.net/documentation/manual-3.0/glDrawElements.html</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/11132716/how-to-specify-buffer-offset-with-pyopengl">http://stackoverflow.com/questions/11132716/how-to-specify-buffer-offset-with-pyopengl</a></li>
<li><a class="reference external" href="http://pyopengl.sourceforge.net/documentation/pydoc/OpenGL.arrays.vbo.html">http://pyopengl.sourceforge.net/documentation/pydoc/OpenGL.arrays.vbo.html</a></li>
<li><a class="reference external" href="http://www.opengl.org/discussion_boards/showthread.php/151386-VBO-BUFFER_OFFSET-and-glDrawElements-broken">http://www.opengl.org/discussion_boards/showthread.php/151386-VBO-BUFFER_OFFSET-and-glDrawElements-broken</a></li>
</ul>
<p>A C example of glDrawElements from /Developer/NVIDIA/CUDA-5.5/samples/5_Simulations/smokeParticles/SmokeRenderer.cpp:</p>
<div class="highlight-python"><pre>glDrawElements(GL_POINTS, count, GL_UNSIGNED_INT, (void *)(start*sizeof(unsigned int)));    # start is an int</pre>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="59%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">&nbsp;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GL_UNSIGNED_BYTE</td>
<td>0:255</td>
</tr>
<tr class="row-odd"><td>GL_UNSIGNED_SHORT,</td>
<td>0:65535</td>
</tr>
<tr class="row-even"><td>GL_UNSIGNED_INT</td>
<td>0:4.295B</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">mode</th>
<th class="head">&nbsp;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GL_POINTS</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>GL_LINE_STRIP</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>GL_LINE_LOOP</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>GL_LINES</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>GL_TRIANGLE_STRIP</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>GL_TRIANGLE_FAN</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>GL_TRIANGLES</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>GL_QUAD_STRIP</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>GL_QUADS</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>GL_POLYGON</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>The what letters, &#8216;pnctesf&#8217; define the meaning of the arrays via
enabling appropriate attributes.</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="31%" />
<col width="31%" />
<col width="8%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">gl***Pointer</th>
<th class="head">GL_***_ARRAY</th>
<th class="head">Att names</th>
<th class="head"><ul class="first last simple">
<li></li>
</ul>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Color</td>
<td>COLOR</td>
<td>color</td>
<td>c</td>
</tr>
<tr class="row-odd"><td>EdgeFlag</td>
<td>EDGE_FLAG</td>
<td>edge_flag</td>
<td>e</td>
</tr>
<tr class="row-even"><td>FogCoord</td>
<td>FOG_COORD</td>
<td>fog_coord</td>
<td>f</td>
</tr>
<tr class="row-odd"><td>Normal</td>
<td>NORMAL</td>
<td>normal</td>
<td>n</td>
</tr>
<tr class="row-even"><td>SecondaryColor</td>
<td>SECONDARY_COLOR</td>
<td>secondary_color</td>
<td>s</td>
</tr>
<tr class="row-odd"><td>TexCoord</td>
<td>TEXTURE_COORD</td>
<td>tex_coord</td>
<td>t</td>
</tr>
<tr class="row-even"><td>Vertex</td>
<td>VERTEX</td>
<td>position</td>
<td>p</td>
</tr>
<tr class="row-odd"><td>VertexAttrib</td>
<td>N/A</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="gldrawelements-offset">
<h3>glDrawElements offset<a class="headerlink" href="#gldrawelements-offset" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><strong>glDrawElements offset applies to the entire indices array</strong>,<ul>
<li>ie it controls where to start getting indices from.</li>
<li>for offsets within each element have to use VertexAttrib offsets.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="glpushclientattrib">
<h3>glPushClientAttrib<a class="headerlink" href="#glpushclientattrib" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.opengl.org/sdk/docs/man2/xhtml/glPushClientAttrib.xml">http://www.opengl.org/sdk/docs/man2/xhtml/glPushClientAttrib.xml</a></p>
<div class="highlight-python"><pre>void glPushClientAttrib(GLbitfield mask);</pre>
</div>
<p>glPushClientAttrib takes one argument, a mask that indicates which groups of
client-state variables to save on the client attribute stack. Symbolic
constants are used to set bits in the mask. mask is typically constructed by
specifying the bitwise-or of several of these constants together. The special
mask GL_CLIENT_ALL_ATTRIB_BITS can be used to save all stackable client state.</p>
<p>The symbolic mask constants and their associated GL client state are as follows
(the second column lists which attributes are saved):</p>
<p>GL_CLIENT_PIXEL_STORE_BIT   Pixel storage modes
GL_CLIENT_VERTEX_ARRAY_BIT  Vertex arrays (and enables)</p>
</div>
<div class="section" id="glmultidrawelements">
<h3>glMultiDrawElements<a class="headerlink" href="#glmultidrawelements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/11286964/glmultidrawelements-values-to-pass-to-indices-parameter-glvoid">http://stackoverflow.com/questions/11286964/glmultidrawelements-values-to-pass-to-indices-parameter-glvoid</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/5354710/drawing-polygons-with-varying-vertex-count-in-opengl-es">http://stackoverflow.com/questions/5354710/drawing-polygons-with-varying-vertex-count-in-opengl-es</a><ul>
<li>not in OpenGL ES 3.0 (highest in iOS so far), is there an alternate that avoids looping over draw calls ?</li>
</ul>
</li>
<li><a class="reference external" href="https://www.opengl.org/discussion_boards/showthread.php/176891-glMultiDrawElements-VBO">https://www.opengl.org/discussion_boards/showthread.php/176891-glMultiDrawElements-VBO</a><ul>
<li>MultiDraw with VBO</li>
<li>indices and counts arrays are client side, but the indices array holds byte offsets into device side buffer</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="read-opengl-buffer-back-into-numpy-arrays">
<h2>Read OpenGL buffer back into numpy arrays<a class="headerlink" href="#read-opengl-buffer-back-into-numpy-arrays" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">read_array_buffer_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * http://www.opengl.org/sdk/docs/man2/xhtml/glMapBuffer.xml</span>
<span class="sd">    * http://mail.scipy.org/pipermail/numpy-discussion/2008-September/037131.html</span>

<span class="sd">    ctypes.sizeof(ctypes.c_float) == 4</span>

<span class="sd">    numpy.ctypeslib.as_array</span>

<span class="sd">    Writing into a mapped OpenGL VBO without pyopengl sugar ?</span>

<span class="sd">    * http://comments.gmane.org/gmane.comp.python.opengl.user/2069</span>

<span class="sd">    ::</span>

<span class="sd">         # Map the buffer object to a pointer</span>
<span class="sd">         vbo_pointer = ctypes.cast(gl.glMapBuffer(gl.GL_ARRAY_BUFFER, gl.GL_WRITE_ONLY), ctypes.POINTER(ctypes.c_ubyte))</span>
<span class="sd">         vbo_array = numpy.ctypeslib.as_array(vbo_pointer, (buffer_size,))  # numpy array from pointer</span>
<span class="sd">         vbo_array[0:data_size_to_copy] = data.view(dtype=&#39;uint8&#39;).ravel()</span>
<span class="sd">         gl.glUnmapBuffer(gl.GL_ARRAY_BUFFER)</span>

<span class="sd">    ::</span>

<span class="sd">         data = ctypes.string_at(gl.glMapBuffer(gl.GL_ARRAY_BUFFER, gl.GL_READ_ONLY), self.vertices.nbytes )</span>
<span class="sd">         x = np.frombuffer(int_asbuffer(ctypes.addressof(data.contents), n*8))</span>


<span class="sd">    * http://stackoverflow.com/questions/7543675/how-to-convert-pointer-to-c-array-to-python-array</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;read_array_buffer&quot;</span><span class="p">)</span>

    <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices_copy</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">itemsize</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">nbytes</span><span class="o">//</span><span class="n">itemsize</span>   <span class="c"># integer</span>
    <span class="k">assert</span> <span class="n">nbytes</span> <span class="o">==</span> <span class="n">count</span> <span class="o">*</span> <span class="n">itemsize</span>

    <span class="n">ptr</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">glMapBuffer</span><span class="p">(</span><span class="n">gl</span><span class="o">.</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">,</span> <span class="n">gl</span><span class="o">.</span><span class="n">GL_READ_ONLY</span><span class="p">)</span>

    <span class="n">ArrayType</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span> <span class="o">*</span> <span class="n">count</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ArrayType</span><span class="p">))</span>

    <span class="c">#vbo_data = ctypes.string_at(ptr, nbytes )</span>
    <span class="c">#x = np.frombuffer(int_asbuffer(ctypes.addressof(vbo_data),nbytes),dtype=dtype)</span>
    <span class="c">#print x</span>

    <span class="n">gl</span><span class="o">.</span><span class="n">glUnmapBuffer</span><span class="p">(</span><span class="n">gl</span><span class="o">.</span><span class="n">GL_ARRAY_BUFFER</span><span class="p">)</span>

    <span class="c">#buffer_size = self.vertices_copy.nbytes</span>
    <span class="c">#vbo_pointer = ctypes.cast(gl.glMapBuffer(gl.GL_ARRAY_BUFFER, gl.GL_READ_ONLY), ctypes.POINTER(ctypes.c_ubyte))</span>
    <span class="c">#vbo_array = np.ctypeslib.as_array(vbo_pointer, (buffer_size,))  # numpy array from pointer</span>
    <span class="c">#vbo_array[0:data_size_to_copy] = data.view(dtype=&#39;uint8&#39;).ravel()</span>
    <span class="c">#gl.glUnmapBuffer(gl.GL_ARRAY_BUFFER)</span>

<span class="k">def</span> <span class="nf">read_array_buffer</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * :google:`glMapBuffer numpy`</span>

<span class="sd">      * http://blog.vrplumber.com/b/2009/09/01/hack-to-map-vertex/</span>

<span class="sd">    Map the given buffer into a numpy array...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;read_array_buffer&quot;</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GL_ARRAY_BUFFER</span>
    <span class="n">access</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GL_READ_ONLY</span>
    <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">nbytes</span>

    <span class="n">func</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pythonapi</span><span class="o">.</span><span class="n">PyBuffer_FromMemory</span>
    <span class="n">func</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span>

    <span class="n">ptr</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">glMapBuffer</span><span class="p">(</span> <span class="n">target</span><span class="p">,</span> <span class="n">access</span> <span class="p">)</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">nbytes</span> <span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#39;B&#39;</span> <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagated</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">gl</span><span class="o">.</span><span class="n">glUnmapBuffer</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../daephotonsshader/" title="DAEPhotonsShader"
             >next</a> |</li>
        <li class="right" >
          <a href="../g4daeview_devnotes/" title="Daeview Dev Notes"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" >g4daeview</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>