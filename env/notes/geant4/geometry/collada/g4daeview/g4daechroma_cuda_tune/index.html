<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>G4DAEChroma CUDA tune &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../../" />
    <link rel="up" title="g4daeview" href="../" />
    <link rel="next" title="Visualizing GenSteps" href="../g4daeview_gensteps/" />
    <link rel="prev" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call" href="../g4daechroma_cpp/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../g4daeview_gensteps/" title="Visualizing GenSteps"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_cpp/" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" accesskey="U">g4daeview</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../">geant4</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_gpu/">Geant4 GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_profiling/">Geant4 Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../verbosity/">Verbosity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../docs/">Geant4 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../giga/">GiGa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/">Geant4 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../opticalphoton/">Geant4 Optical Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../processes/">Geant4 Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../medical/">Medical Communities Using Geant4 (esp. optical photon)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../">Geant4 Geometry Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../g4py/">g4py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../event/">Geant4 Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_future_doe/">Geant4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_multi_threading/">Geant4 Multi Threading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../../_sources/geant4/geometry/collada/g4daeview/g4daechroma_cuda_tune.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../g4daechroma_cpp/"
                        title="previous chapter">G4DAEChroma.cpp : ZMQResponder, CUDA kernel call</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../g4daeview_gensteps/"
                        title="next chapter">Visualizing GenSteps</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="g4daechroma-cuda-tune">
<h1>G4DAEChroma CUDA tune<a class="headerlink" href="#g4daechroma-cuda-tune" title="Permalink to this headline">¶</a></h1>
<div class="section" id="small-problem-size">
<h2>Small Problem Size<a class="headerlink" href="#small-problem-size" title="Permalink to this headline">¶</a></h2>
<p>For small problem size there is clear pattern of improving performance
as increase <cite>threads_per_block</cite> from too small 32 out to 256
(about half the work size) where a minimum is reached.
Beyond the minimum there is only a very slight degradation
as increase further.</p>
<p>Does that mean having two active blocks is the most efficient config ?</p>
<div class="highlight-python"><pre>In [2]: scatter("select threads_per_block,tottime from log, ctrl on log.ctrl_id = ctrl.id where log.id&gt;307;")


sqlite&gt; select batch.nwork, threads_per_block,tottime from log, ctrl, batch  on log.ctrl_id = ctrl.id and log.batch_id = batch.id where log.id&gt;307;
nwork       threads_per_block  tottime
----------  -----------------  ----------
445         32                 0.105339
445         64                 0.069023
445         96                 0.066592
445         128                0.059896
445         160                0.052635
445         192                0.049819
445         224                0.046049
445         256                0.045372
445         288                0.045148
445         320                0.045277
445         352                0.045376
445         384                0.045921
445         416                0.045918
445         448                0.045956
445         480                0.045953
445         512                0.045972
sqlite&gt;</pre>
</div>
</div>
<div class="section" id="large-problem-size">
<h2>Large problem size<a class="headerlink" href="#large-problem-size" title="Permalink to this headline">¶</a></h2>
<p>Seems pretty much flat across threads_per_block from 32 to 512.
Attempts to push beyond 512 cause crashes.</p>
<div class="highlight-python"><pre>sqlite&gt; select batch.nwork, threads_per_block,tottime from log, ctrl, batch  on log.ctrl_id = ctrl.id and log.batch_id = batch.id where batch.nwork &gt; 3200  ;
nwork       threads_per_block  tottime
----------  -----------------  ----------
4585        64                 0.359394
4585        128                0.351535
4585        192                0.369758
4585        256                0.371362
4585        320                0.376655
4585        384                0.377518
4585        448                0.378556
4585        512                0.384698

3201        64                 0.227585
3201        128                0.220926
3201        192                0.224383
3201        256                0.228088
3201        320                0.221011
3201        384                0.279568
3201        448                0.222894
3201        512                0.226172
sqlite&gt;</pre>
</div>
</div>
<div class="section" id="variation-of-time-with-workload">
<h2>Variation of time with workload<a class="headerlink" href="#variation-of-time-with-workload" title="Permalink to this headline">¶</a></h2>
<p>Time per 1000 work items is slightly increasing as increase workload,
and would correspond to 80s for 1M : that cannot be correct.
Perhaps as are in straggler mode, with small workloads so far.</p>
<div class="highlight-python"><pre>sqlite&gt; select batch.nwork, threads_per_block,tottime, tottime/batch.nwork*1000 from log, ctrl, batch  on log.ctrl_id = ctrl.id and log.batch_id = batch.id where batch.nwork &gt; 100 and threads_per_block = 256 order by batch.nwork  ;
nwork       threads_per_block  tottime     tottime/batch.nwork*1000
----------  -----------------  ----------  ------------------------
233         256                0.064202    0.275545064377682
445         256                0.045276    0.101743820224719
445         256                0.045372    0.101959550561798
1869        256                0.143624    0.0768453718566078
1888        256                0.141632    0.0750169491525424
2025        256                0.124308    0.0613866666666667
2053        256                0.132408    0.0644948855333658
2053        256                0.132172    0.0643799318071115
2463        256                0.173663    0.0705087291920422
2553        256                0.259664    0.101709361535448
2779        256                0.208306    0.0749571788413098
2979        256                0.247615    0.0831201745552199
3095        256                0.268925    0.0868901453957997
3095        256                0.269127    0.0869554119547657
3159        256                0.241424    0.0764241848686293
3201        256                0.228088    0.0712552327397688
4585        256                0.371362    0.0809949836423119
sqlite&gt;</pre>
</div>
</div>
<div class="section" id="larger-than-512">
<h2>Larger than 512 ?<a class="headerlink" href="#larger-than-512" title="Permalink to this headline">¶</a></h2>
<p>768 and 1024 are giving error in <cite>upload_queues</cite>:</p>
<div class="highlight-python"><pre>  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/env/geant4/geometry/collada/g4daeview/daedirectpropagator.py", line 61, in propagate
    self.chroma.parameters)
  File "/usr/local/env/chroma_env/src/chroma/chroma/gpu/photon_hit.py", line 234, in propagate_hit
    self.upload_queues( nwork )
  File "/usr/local/env/chroma_env/src/chroma/chroma/gpu/photon_hit.py", line 175, in upload_queues
    self.input_queue_gpu = ga.to_gpu(input_queue)
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/gpuarray.py", line 865, in to_gpu
    result = GPUArray(ary.shape, ary.dtype, allocator, strides=ary.strides)
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/gpuarray.py", line 187, in __init__
    self.gpudata = self.allocator(self.size * self.dtype.itemsize)
pycuda._driver.LaunchError: cuMemAlloc failed: launch timeout
_finish_up : cuda cleanup
PyCUDA WARNING: a clean-up operation failed (dead context maybe?)
cuModuleUnload failed: launch timeout</pre>
</div>
</div>
<div class="section" id="straggler-mode">
<h2>Straggler Mode<a class="headerlink" href="#straggler-mode" title="Permalink to this headline">¶</a></h2>
<p>For higher workloads chroma does single stepping with multiple kernel
launches. The small workloads have been checking with so far fit into
small remainder stragglers and are all done in a single launch.</p>
<div class="highlight-python"><pre>239         small_remainder = nthreads_per_block * 16 * 8
240         block=(nthreads_per_block,1,1)
241
242         results = {}
243         results['name'] = "propagate_hit"
244         results['nphotons'] = nphotons
245         results['nwork'] = nwork
246         results['nsmall'] = small_remainder
247         results['COLUMNS'] = "name:s,nphotons:i,nwork:i,nsmall:i"
...
254
255         while step &lt; max_steps:
256             npass += 1
257             if nwork &lt; small_remainder or use_weights:
258                 nsteps = max_steps - step
259                 log.debug("increase nsteps for stragglers: small_remainder %s nwork %s nsteps %s max_steps %s " % (small_remainder, nwork, nsteps, max_steps))
260             else:
261                 nsteps = 1 # Just finish the rest of the steps if the # of photons is low
262             pass
263             log.info("nwork %s step %s max_steps %s nsteps %s " % (nwork, step,max_steps, nsteps) )
264
265             abort = False
266             for first_photon, photons_this_round, blocks in chunk_iterator(nwork, nthreads_per_block, max_blocks):
267                 if abort:
268                     nabort += 1
269                 else:
270                     grid = (blocks, 1)
271                     args = (
272                         np.int32(first_photon),
273                         np.int32(photons_this_round),
274                         self.input_queue_gpu[1:].gpudata,</pre>
</div>
</div>
<div class="section" id="propagate-queues">
<h2>Propagate Queues<a class="headerlink" href="#propagate-queues" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>propagation of <cite>first_photon + blockIdx.x*blockDim.x + threadIdx.x</cite>  ie the launch set starting at <cite>first_photon</cite></li>
</ol>
<div class="highlight-python"><pre>120 __global__ void
121 propagate_hit(
122       int first_photon,
123       int nthreads,
124       unsigned int *input_queue,
125       unsigned int *output_queue,
126       curandState *rng_states,
127       float3 *positions,
128       float3 *directions,
129       float *wavelengths,
130       float3 *polarizations,
131       float *times,
132       unsigned int *histories,
133       int *last_hit_triangles,
134       float *weights,
135       int max_steps,
136       int use_weights,
137       int scatter_first,
138       Geometry *g,
139       int* solid_map,
140       int* solid_id_to_channel_id )
141 {
142     __shared__ Geometry sg;
143
144     if (threadIdx.x == 0)
145     sg = *g;
146
147     __syncthreads();
148
149     int id = blockIdx.x*blockDim.x + threadIdx.x;
150
151     if (id &gt;= nthreads)
152     return;
153
154     g = &amp;sg;
155
156     curandState rng = rng_states[id];
157
158     int photon_id = input_queue[first_photon + id];
159
160     Photon p;
161     p.position = positions[photon_id];

...

230     // Not done, put photon in output queue
231     if ((p.history &amp; (NO_HIT | BULK_ABSORB | SURFACE_DETECT | SURFACE_ABSORB | NAN_ABORT)) == 0)
232     {
233         int out_idx = atomicAdd(output_queue, 1);  // atomic add 1 to slot zero value, returns non-incremented original value, pulling a queue ticket
234         output_queue[out_idx] = photon_id;
235     }</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../g4daeview_gensteps/" title="Visualizing GenSteps"
             >next</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_cpp/" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" >g4daeview</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>