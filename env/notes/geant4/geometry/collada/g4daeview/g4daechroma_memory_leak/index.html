<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>G4DAEChroma Memory Leak &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../../" />
    <link rel="up" title="g4daeview" href="../" />
    <link rel="next" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call" href="../g4daechroma_cpp/" />
    <link rel="prev" title="G4DAECHROMA transport testing" href="../g4daechroma_transport_testing/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_cpp/" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_transport_testing/" title="G4DAECHROMA transport testing"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" accesskey="U">g4daeview</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../">geant4</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_gpu/">Geant4 GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_profiling/">Geant4 Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../verbosity/">Verbosity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../docs/">Geant4 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../giga/">GiGa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/">Geant4 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../opticalphoton/">Geant4 Optical Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../processes/">Geant4 Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../medical/">Medical Communities Using Geant4 (esp. optical photon)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../">Geant4 Geometry Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../g4py/">g4py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../event/">Geant4 Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_future_doe/">Geant4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../geant4_multi_threading/">Geant4 Multi Threading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../presentation/">Muon Simulation Presentation</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../../_sources/geant4/geometry/collada/g4daeview/g4daechroma_memory_leak.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../g4daechroma_transport_testing/"
                        title="previous chapter">G4DAECHROMA transport testing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../g4daechroma_cpp/"
                        title="next chapter">G4DAEChroma.cpp : ZMQResponder, CUDA kernel call</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="g4daechroma-memory-leak">
<h1>G4DAEChroma Memory Leak<a class="headerlink" href="#g4daechroma-memory-leak" title="Permalink to this headline">¶</a></h1>
<div class="section" id="executive-summary">
<h2>Executive Summary<a class="headerlink" href="#executive-summary" title="Permalink to this headline">¶</a></h2>
<p>Initial concerns over large VSIZE appear unfounded, just the
way OSX does its totting up.
Question remains: why is CPU usage so high ?
The GPU should be doing the work, CPU just
doing copies and marshalling ?</p>
</div>
<div class="section" id="initial-observation-of-30g-vsize">
<h2>Initial Observation of 30G VSIZE<a class="headerlink" href="#initial-observation-of-30g-vsize" title="Permalink to this headline">¶</a></h2>
<p>Running a mocknuwa scan matrix of 16(configs)x48(batches)
reveals the python g4daechroma.py
propagating process to balloon in VSIZE shown by top.
Got to 30G and the machine became sluggish before interrupting
it at config 11.</p>
<div class="highlight-python"><pre>mocknuwa-scan(){
   mocknuwa-runenv
   MockNuWa 1:49 1:17
}</pre>
</div>
</div>
<div class="section" id="large-vsize">
<h2>Large VSIZE<a class="headerlink" href="#large-vsize" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://manytricks.com/blog/?p=2471">http://manytricks.com/blog/?p=2471</a></li>
</ul>
</div>
<div class="section" id="not-ballooning-to-30g">
<h2>Not ballooning to 30G<a class="headerlink" href="#not-ballooning-to-30g" title="Permalink to this headline">¶</a></h2>
<p>VSIZE is steady at 30G, and starts there even before
doing any propagations.</p>
<p>Doing an activity monitor sample gives a hint of how it gets to 30G.
All the dependencies of chroma, even although they are not
being used are presumably contributing to the 30G.</p>
<ul class="simple">
<li>pygame</li>
<li>opengl</li>
<li>geant4</li>
<li>avoiding kitchen sink <cite>__init__.py</cite> gets to 30.75 G
by avoiding unused dependencies like pygame and geant4</li>
</ul>
</div>
<div class="section" id="vmmap">
<h2>vmmap<a class="headerlink" href="#vmmap" title="Permalink to this headline">¶</a></h2>
<p>28G listed under VM_ALLOCATE</p>
<div class="highlight-python"><pre>(chroma_env)delta:~ blyth$ pgrep python
45624
(chroma_env)delta:~ blyth$ vmmap 45624
Virtual Memory Map of process 45624 (python)
Output report format:  2.2  -- 64-bit process

==== Non-writable regions for process 45624
__TEXT                 0000000105b60000-0000000105b62000 [    8K] r-x/rwx SM=COW  /usr/local/env/chroma_env/bin/python
__LINKEDIT             0000000105b63000-0000000105b64000 [    4K] r--/rwx SM=COW  /usr/local/env/chroma_env/bin/python

...

__LINKEDIT             0000000117408000-000000011740b000 [   12K] r--/rwx SM=COW  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/_pvt_struct.so
STACK GUARD            000000011f216000-000000011f217000 [    4K] ---/rwx SM=NUL  stack guard for thread 2
STACK GUARD            000000011f299000-000000011f29a000 [    4K] ---/rwx SM=NUL  stack guard for thread 3
VM_ALLOCATE            0000000200000000-0000000900000000 [ 28.0G] ---/rwx SM=NUL
STACK GUARD            00007fff560a0000-00007fff598a0000 [ 56.0M] ---/rwx SM=NUL  stack guard for thread 0
__TEXT                 00007fff65ccf000-00007fff65d03000 [  208K] r-x/rwx SM=COW  /usr/lib/dyld
__LINKEDIT             00007fff65d42000-00007fff65d56000 [   80K] r--/rwx SM=COW  /usr/lib/dyld
__TEXT                 00007fff87ef7000-00007fff87f09000 [   72K] r-x/r-x SM=COW  /usr/lib/libz.1.2.5.dylib
...

==== Summary for process 45624
ReadOnly portion of Libraries: Total=146.2M resident=59.2M(40%) swapped_out_or_unallocated=87.1M(60%)
Writable regions: Total=404.6M written=108.9M(27%) resident=361.6M(89%) swapped_out=0K(0%) unallocated=43.0M(11%)

REGION TYPE                      VIRTUAL
===========                      =======
IOKit                             109.2M
IOKit (reserved)                      8K        reserved VM address space (unallocated)
Kernel Alloc Once                     4K
MALLOC                            194.8M        see MALLOC ZONE table below
MALLOC (admin)                       44K
MALLOC freed, no zone              13.9M
MALLOC_LARGE                       70.7M
STACK GUARD                        56.0M
Stack                              9752K
VM_ALLOCATE                        28.0G
__DATA                             31.3M
__LINKEDIT                         71.7M
__NV_CUDA                          6504K
__TEXT                             74.5M
__UNICODE                           544K
shared memory                         4K
===========                      =======
TOTAL                              28.6G
TOTAL, minus reserved VM space     28.6G</pre>
</div>
</div>
<div class="section" id="vmmap-resident">
<h2>vmmap -resident<a class="headerlink" href="#vmmap-resident" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(chroma_env)delta:~ blyth$ vmmap -resident 45624
Virtual Memory Map of process 45624 (python)
Output report format:  2.2  -- 64-bit process

==== Non-writable regions for process 45624
__TEXT                 0000000105b60000-0000000105b62000 [    8K     8K] r-x/rwx SM=COW  /usr/local/env/chroma_env/bin/python
__LINKEDIT             0000000105b63000-0000000105b64000 [    4K     4K] r--/rwx SM=COW  /usr/local/env/chroma_env/bin/python

...
__TEXT                 0000000117402000-0000000117406000 [   16K    16K] r-x/rwx SM=COW  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/_pvt_struct.so
__LINKEDIT             0000000117408000-000000011740b000 [   12K    12K] r--/rwx SM=COW  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/_pvt_struct.so
STACK GUARD            000000011f216000-000000011f217000 [    4K     0K] ---/rwx SM=NUL  stack guard for thread 2
STACK GUARD            000000011f299000-000000011f29a000 [    4K     0K] ---/rwx SM=NUL  stack guard for thread 3
VM_ALLOCATE            0000000200000000-0000000900000000 [ 28.0G     0K] ---/rwx SM=NUL
STACK GUARD            00007fff560a0000-00007fff598a0000 [ 56.0M     0K] ---/rwx SM=NUL  stack guard for thread 0
__TEXT                 00007fff65ccf000-00007fff65d03000 [  208K   208K] r-x/rwx SM=COW  /usr/lib/dyld
__LINKEDIT             00007fff65d42000-00007fff65d56000 [   80K    80K] r--/rwx SM=COW  /usr/lib/dyld


==== Legend
SM=sharing mode:
    COW=copy_on_write PRV=private NUL=empty ALI=aliased
    SHM=shared ZER=zero_filled S/A=shared_alias

==== Summary for process 45624
ReadOnly portion of Libraries: Total=146.2M resident=59.2M(40%) swapped_out_or_unallocated=87.1M(60%)
Writable regions: Total=414.6M written=108.9M(26%) resident=361.7M(87%) swapped_out=0K(0%) unallocated=53.0M(13%)

REGION TYPE                      VIRTUAL RESIDENT
===========                      ======= ========
IOKit                             109.2M   109.2M
IOKit (reserved)                      8K       0K        reserved VM address space (unallocated)
Kernel Alloc Once                     4K       4K
MALLOC                            204.8M   166.6M        see MALLOC ZONE table below
MALLOC (admin)                       44K      12K
MALLOC freed, no zone              13.9M    13.9M
MALLOC_LARGE                       70.7M    70.7M
STACK GUARD                        56.0M       0K
Stack                              9752K     112K
VM_ALLOCATE                        28.0G      12K
__DATA                             31.3M    6116K
__LINKEDIT                         71.7M    18.3M
__NV_CUDA                          6504K       8K
__TEXT                             74.5M    40.9M
__UNICODE                           544K     544K
shared memory                         4K       4K
===========                      ======= ========
TOTAL                              28.6G   426.2M
TOTAL, minus reserved VM space     28.6G   426.2M


                                 VIRTUAL   RESIDENT ALLOCATION      BYTES
MALLOC ZONE                         SIZE       SIZE      COUNT  ALLOCATED  % FULL
===========                      =======  =========  =========  =========  ======
DefaultMallocZone_0x105b64000     204.4M     166.5M      23534     166.1M     81%
GFXMallocZone_0x1093a9000             0K         0K          0         0K
===========                      =======  =========  =========  =========  ======
TOTAL                             204.4M     166.5M      23534     166.1M     81%</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_cpp/" title="G4DAEChroma.cpp : ZMQResponder, CUDA kernel call"
             >next</a> |</li>
        <li class="right" >
          <a href="../g4daechroma_transport_testing/" title="G4DAECHROMA transport testing"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../../" >geant4</a> &raquo;</li>
          <li><a href="../../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry in Collada</a> &raquo;</li>
          <li><a href="../" >g4daeview</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>