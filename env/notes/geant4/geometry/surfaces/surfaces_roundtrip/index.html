<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Surfaces Roundtrip &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../" />
    <link rel="up" title="surfaces" href="../" />
    <link rel="next" title="g4py" href="../../../g4py/" />
    <link rel="prev" title="G4OpticalSurface" href="../opticalsurface/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../g4py/" title="g4py"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../opticalsurface/" title="G4OpticalSurface"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../" >geant4</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../" accesskey="U">surfaces</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../">geant4</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../geant4_gpu/">Geant4 GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../geant4_profiling/">Geant4 Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../release_notes/">Geant4 Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../verbosity/">Verbosity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/">Geant4 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../giga/">GiGa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/">Geant4 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opticalphoton/">Geant4 Optical Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../processes/">Geant4 Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../medical/">Medical Communities Using Geant4 (esp. optical photon)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../">Geant4 Geometry Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../g4py/">g4py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../event/">Geant4 Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../geant4_future_doe/">Geant4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../geant4_multi_threading/">Geant4 Multi Threading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../_sources/geant4/geometry/surfaces/surfaces_roundtrip.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../opticalsurface/"
                        title="previous chapter">G4OpticalSurface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../../g4py/"
                        title="next chapter">g4py</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="surfaces-roundtrip">
<h1>Surfaces Roundtrip<a class="headerlink" href="#surfaces-roundtrip" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#info-flow" id="id1">Info flow</a></li>
<li><a class="reference internal" href="#issue-model-mismatch" id="id2">Issue : Model mismatch</a></li>
<li><a class="reference internal" href="#issue-missing-bordersurface" id="id3">Issue : Missing bordersurface</a><ul>
<li><a class="reference internal" href="#detdesc-level" id="id4">detdesc level</a></li>
<li><a class="reference internal" href="#xmldae-level-raw-dae-xml" id="id5">xmldae level (raw DAE XML)</a></li>
<li><a class="reference internal" href="#daenode-level" id="id6">daenode level</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-of-surfaces-by-chroma" id="id7">Use of surfaces by Chroma</a><ul>
<li><a class="reference internal" href="#surface-association" id="id8">surface association</a></li>
<li><a class="reference internal" href="#propagate-at-surface" id="id9">propagate_at_surface</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="info-flow">
<h2><a class="toc-backref" href="#id1">Info flow</a><a class="headerlink" href="#info-flow" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>NuWa-trunk/dybgaudi/Detector/XmlDetDesc/DDDB detdesc into Geant4 objects via GiGa</li>
<li>G4DAE persisted from Geant4 memory into DAE extras</li>
<li>ColladaToChroma : pycollada read of extras via DAENode DAEGeometry into Chroma objects</li>
<li>Chroma push to GPU</li>
</ol>
</div>
<div class="section" id="issue-model-mismatch">
<h2><a class="toc-backref" href="#id2">Issue : Model mismatch</a><a class="headerlink" href="#issue-model-mismatch" title="Permalink to this headline">¶</a></h2>
<p>Sensdet Geant4/NuWa vs Chroma model difference</p>
<ol class="arabic simple">
<li>Chroma is expecting sensitive detectors to have associated surfaces
with all the requisite props to furnish SURFACE_DETECT <strong>hits</strong>.</li>
<li>Geant4/NuWa expecting sensitive volumes to...</li>
</ol>
</div>
<div class="section" id="issue-missing-bordersurface">
<h2><a class="toc-backref" href="#id3">Issue : Missing bordersurface</a><a class="headerlink" href="#issue-missing-bordersurface" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>All 8 bordersurface are missing</li>
</ol>
<div class="highlight-python"><pre>{'border': ['ESRAirSurfaceTop',
            'ESRAirSurfaceBot',
            'NearIWSCurtain',
            'NearOWSLiner',
            'NearDeadLiner',
            'SSTWaterSurfaceNear1',
            'SSTWaterSurfaceNear2',
            'SSTOil'],</pre>
</div>
<ol class="arabic simple">
<li>pv pairing ambiguity is apparent</li>
<li>also need to add 2nd surface index to chroma model
and pick which one based on in-to-out or out-to-in</li>
</ol>
<div class="highlight-python"><pre>In [9]: bordersurface['SSTOil']    # inside border of SST and MineralOil it contains
Out[9]:
&lt;BorderSurface AdDetails__AdSurfacesAll__SSTOilSurface &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (2) AD__lvSST--pvOIL0xc241510
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.0             __dd__Materials__MineralOil0xbf5c830
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.1             __dd__Materials__MineralOil0xbf5c830
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00


In [10]: bordersurface['SSTWaterSurfaceNear1']   # outside of SST and surrounding water
Out[10]:
&lt;BorderSurface AdDetails__AdSurfacesNear__SSTWaterSurfaceNear1 &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (1) Pool__lvNearPoolIWS--pvNearADE10xc2cf528
       __dd__Geometry__Pool__lvNearPoolIWS--pvNearADE10xc2cf528.0             __dd__Materials__IwsWater0xc288f98
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00

In [11]: bordersurface['SSTWaterSurfaceNear2']   # huh
Out[11]:
&lt;BorderSurface AdDetails__AdSurfacesNear__SSTWaterSurfaceNear2 &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (1) Pool__lvNearPoolIWS--pvNearADE20xc0479c8
       __dd__Geometry__Pool__lvNearPoolIWS--pvNearADE20xc0479c8.0             __dd__Materials__IwsWater0xc288f98
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00</pre>
</div>
<p>Seeing how event number 1 photons gets propagated with partial geometry is interesting:</p>
<div class="highlight-python"><pre>g4daeview.sh --geometry-regexp ADE1 --load 1                     ## not many photons escape the water ?
g4daeview.sh --geometry-regexp pvNearADE10xc2cf528.0 --load 1    ## seemingly no photons escape the water column

g4daeview.sh --geometry-regexp ADE2 --load 1                     ## backspill
g4daeview.sh --geometry-regexp pvNearADE20xc0479c8.0  --load 1   ## lots of backspill manage to enter water though</pre>
</div>
<div class="section" id="detdesc-level">
<h3><a class="toc-backref" href="#id4">detdesc level</a><a class="headerlink" href="#detdesc-level" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>perusing DDDB would suggest some surfaces are missing</li>
</ul>
</div>
<div class="section" id="xmldae-level-raw-dae-xml">
<h3><a class="toc-backref" href="#id5">xmldae level (raw DAE XML)</a><a class="headerlink" href="#xmldae-level-raw-dae-xml" title="Permalink to this headline">¶</a></h3>
<p>Comparing ChromaSurfaceMap and raw xml with <cite>xmldae.sh &#8211;ipy &#8211;surface</cite>  missing marked with <cite>-</cite>:</p>
<div class="highlight-python"><pre>delta:~ blyth$ xmldae.sh --ipy --surface
...
[ 11] __dd__Geometry__PoolDetails__NearPoolSurfaces__

     +NearInnOutPiper
     -NearPoolCover
     +TopShortCableTray
     +NearInnInPiper
     +NearOutOutPiper
     -NearIWSCurtain
     -NearOWSLiner
     -NearDeadLiner
     +UnistrutRib7
     +NearOutInPiper
     +UnistrutRib6

[  5] __dd__Geometry__AdDetails__AdSurfacesAll__

     +AdCableTray
     -ESRAirSurfaceTop
     -ESRAirSurfaceBot
     +RSOil
     -SSTOil

[  2] __dd__Geometry__AdDetails__AdSurfacesNear__

     -SSTWaterSurfaceNear1
     -SSTWaterSurfaceNear2

[ 24] __dd__Geometry__PoolDetails__PoolSurfacesAll__

     +PmtMtRib2
     +TopCornerCableTray
     +TablePanel
     +UnistrutRib2
     +UnistrutRib3
     +UnistrutRib8
     +LegInOWSTub
     +SlopeRib5
     +PmtMtBaseRing
     +LegInDeadTub
     +PmtMtRib1
     +SupportRib5
     +PmtMtRib3
     +UnistrutRib1
     +LegInIWSTub
     +ADVertiCableTray
     +UnistrutRib9
     +VertiCableTray
     +ShortParCableTray
     +SlopeRib1
     +PmtMtTopRing
     +SupportRib1
     +UnistrutRib4
     +UnistrutRib5

2014-07-11 17:03:04,859 env.geant4.geometry.collada.xmldae INFO     found 42 raw opticalsurface elements, 9 of which are missing from csm</pre>
</div>
<p>Initially all 8 bordersurface are missing and 1 skinsurface is missing (&#8216;NearPoolCover&#8217;).
Maybe NearPoolCover missing from CSM as default geometry selection excludes it:</p>
<div class="highlight-python"><pre>In [6]: print ET.tostring(raw['skin']['NearPoolCover'])
&lt;skinsurface xmlns="http://www.collada.org/2005/11/COLLADASchema" name="__dd__Geometry__PoolDetails__NearPoolSurfaces__NearPoolCoverSurface" surfaceproperty="__dd__Geometry__PoolDetails__NearPoolSurfaces__NearPoolCoverSurface"&gt;
        &lt;volumeref ref="__dd__Geometry__PoolDetails__lvNearTopCover0xc137060"/&gt;
      &lt;/skinsurface&gt;</pre>
</div>
<p>Yep, after adding a more complete <strong>dybf</strong> geometry and using that get:</p>
<div class="highlight-python"><pre>not_in_csm:
{'border': ['ESRAirSurfaceTop',
            'ESRAirSurfaceBot',
            'NearIWSCurtain',
            'NearOWSLiner',
            'NearDeadLiner',
            'SSTWaterSurfaceNear1',
            'SSTWaterSurfaceNear2',
            'SSTOil'],
 'optical': ['ESRAirSurfaceTop',
             'ESRAirSurfaceBot',
             'NearIWSCurtain',
             'NearOWSLiner',
             'NearDeadLiner',
             'SSTWaterSurfaceNear1',
             'SSTWaterSurfaceNear2',
             'SSTOil'],
 'skin': []}


In [3]: not_in_csm['border'] == not_in_csm['optical']
Out[3]: True</pre>
</div>
</div>
<div class="section" id="daenode-level">
<h3><a class="toc-backref" href="#id6">daenode level</a><a class="headerlink" href="#daenode-level" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>delta:~ blyth$ daenode.sh --ipy
2014-07-11 17:38:53,158 env.geant4.geometry.collada.daenode:1763 INFO     /Users/blyth/env/bin/daenode.py
2014-07-11 17:38:54,914 env.geant4.geometry.collada.daenode:1806 INFO     drop into embedded IPython
Python 2.7.6 (default, Nov 18 2013, 15:12:51)
Type "copyright", "credits" or "license" for more information.

IPython 1.2.1 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython's features.
%quickref -&gt; Quick reference.
help      -&gt; Python's own help system.
object?   -&gt; Details about 'object', use 'object??' for extra details.

In [1]: DAENode.extra
Out[1]: DAEExtra skinsurface 34 bordersurface 8 opticalsurface 42 skinmap 34 bordermap 13

In [2]: DAENode.extra.__class__
Out[2]: env.geant4.geometry.collada.daenode.DAEExtra


In [2]: DAENode.extra.bordersurface
Out[2]:
[&lt;BorderSurface AdDetails__AdSurfacesAll__ESRAirSurfaceTop &lt;OpticalSurface f0 m1 t0 v0 pREFLECTIVITY:31 &gt; &gt;
     pv1 (2) AdDetails__lvTopReflector--pvTopRefGap0xc266468
       __dd__Geometry__AdDetails__lvTopReflector--pvTopRefGap0xc266468.0             __dd__Materials__Air0xc032550
       __dd__Geometry__AdDetails__lvTopReflector--pvTopRefGap0xc266468.1             __dd__Materials__Air0xc032550
     pv2 (2) AdDetails__lvTopRefGap--pvTopESR0xc4110d0
       __dd__Geometry__AdDetails__lvTopRefGap--pvTopESR0xc4110d0.0             __dd__Materials__ESR0xbf9f438
       __dd__Geometry__AdDetails__lvTopRefGap--pvTopESR0xc4110d0.1             __dd__Materials__ESR0xbf9f438 ,
 &lt;BorderSurface AdDetails__AdSurfacesAll__ESRAirSurfaceBot &lt;OpticalSurface f0 m1 t0 v0 pREFLECTIVITY:31 &gt; &gt;
     pv1 (2) AdDetails__lvBotReflector--pvBotRefGap0xbfa6458
       __dd__Geometry__AdDetails__lvBotReflector--pvBotRefGap0xbfa6458.0             __dd__Materials__Air0xc032550
       __dd__Geometry__AdDetails__lvBotReflector--pvBotRefGap0xbfa6458.1             __dd__Materials__Air0xc032550
     pv2 (2) AdDetails__lvBotRefGap--pvBotESR0xbf9bd08
       __dd__Geometry__AdDetails__lvBotRefGap--pvBotESR0xbf9bd08.0             __dd__Materials__ESR0xbf9f438
       __dd__Geometry__AdDetails__lvBotRefGap--pvBotESR0xbf9bd08.1             __dd__Materials__ESR0xbf9f438 ,
 &lt;BorderSurface AdDetails__AdSurfacesAll__SSTOilSurface &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (2) AD__lvSST--pvOIL0xc241510
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.0             __dd__Materials__MineralOil0xbf5c830
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.1             __dd__Materials__MineralOil0xbf5c830
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00 ,


In [9]: bordersurface['SSTOil']
Out[9]:
&lt;BorderSurface AdDetails__AdSurfacesAll__SSTOilSurface &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (2) AD__lvSST--pvOIL0xc241510
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.0             __dd__Materials__MineralOil0xbf5c830
       __dd__Geometry__AD__lvSST--pvOIL0xc241510.1             __dd__Materials__MineralOil0xbf5c830
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00

In [10]: bordersurface['SSTWaterSurfaceNear1']
Out[10]:
&lt;BorderSurface AdDetails__AdSurfacesNear__SSTWaterSurfaceNear1 &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (1) Pool__lvNearPoolIWS--pvNearADE10xc2cf528
       __dd__Geometry__Pool__lvNearPoolIWS--pvNearADE10xc2cf528.0             __dd__Materials__IwsWater0xc288f98
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00

In [11]: bordersurface['SSTWaterSurfaceNear2']
Out[11]:
&lt;BorderSurface AdDetails__AdSurfacesNear__SSTWaterSurfaceNear2 &lt;OpticalSurface f3 m1 t0 v1 pREFLECTIVITY:4 &gt; &gt;
     pv1 (1) Pool__lvNearPoolIWS--pvNearADE20xc0479c8
       __dd__Geometry__Pool__lvNearPoolIWS--pvNearADE20xc0479c8.0             __dd__Materials__IwsWater0xc288f98
     pv2 (2) AD__lvADE--pvSST0xc128d90
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.0             __dd__Materials__StainlessSteel0xc2adc00
       __dd__Geometry__AD__lvADE--pvSST0xc128d90.1             __dd__Materials__StainlessSteel0xc2adc00</pre>
</div>
</div>
</div>
<div class="section" id="use-of-surfaces-by-chroma">
<h2><a class="toc-backref" href="#id7">Use of surfaces by Chroma</a><a class="headerlink" href="#use-of-surfaces-by-chroma" title="Permalink to this headline">¶</a></h2>
<p>Without associated surface_index never get SURFACE_ABSORB, SURFACE_DETECT, REFLECT_DIFFUSE?</p>
<p><cite>chroma/cuda/propagate_vbo.cu</cite>:</p>
<div class="highlight-python"><pre>616        // PASS goes on to either at_surface/at_boundary handling
617        // depending on surface association
621        if (s.surface_index != -1)
622        {
625            // #. SURFACE_ABSORB(BREAK)
626            // #. SURFACE_DETECT(BREAK)
627            // #. REFLECT_DIFFUSE(CONTINUE) .direction .polarization
628            // #. REFLECT_SPECULAR(CONTINUE) .direction
629            // #. NO other option, so never PASS?
631            command = propagate_at_surface(p, s, rng, g, use_weights);
636            if (command == BREAK) break ;
637            if (command == CONTINUE) continue;
641        }
642
643        // **propagate_at_boundary**
644        // depending on materials refractive indices and incidence angle
645        //
646        // #. "CONTINUE" REFLECT_SPECULAR  .direction .polarization
647        // #. "CONTINUE" "REFRACT"         .direction .polarization
648        // #. NO other option
649
650        propagate_at_boundary(p, s, rng);
654</pre>
</div>
<div class="section" id="surface-association">
<h3><a class="toc-backref" href="#id8">surface association</a><a class="headerlink" href="#surface-association" title="Permalink to this headline">¶</a></h3>
<p>Triangle material_codes lookup: <cite>g-&gt;material_codes[p.last_hit_triangle]</cite>
gives materials and maybe surface associated.</p>
<div class="highlight-python"><pre>165 __device__ void
166 fill_state(State &amp;s, Photon &amp;p, Geometry *g)
167 {
168     p.last_hit_triangle = intersect_mesh(p.position, p.direction, g,
169                                          s.distance_to_boundary,
170                                          p.last_hit_triangle);
...
179     Triangle t = get_triangle(g, p.last_hit_triangle);
180
181     unsigned int material_code = g-&gt;material_codes[p.last_hit_triangle];
182
183     int inner_material_index = convert(0xFF &amp; (material_code &gt;&gt; 24));
184     int outer_material_index = convert(0xFF &amp; (material_code &gt;&gt; 16));
185     s.surface_index = convert(0xFF &amp; (material_code &gt;&gt; 8));
186
...    convert just makes -1 if needed</pre>
</div>
</div>
<div class="section" id="propagate-at-surface">
<h3><a class="toc-backref" href="#id9">propagate_at_surface</a><a class="headerlink" href="#propagate-at-surface" title="Permalink to this headline">¶</a></h3>
<p>Wavelength dependant surface props needed by <cite>propagate_at_surface</cite></p>
<ul class="simple">
<li>detect</li>
<li>absorb</li>
<li>reflect_diffuse</li>
<li>reflect_specular</li>
</ul>
<p><cite>chroma/cuda/photon.h</cite>:</p>
<div class="highlight-python"><pre>701 __device__ int
702 propagate_at_surface(Photon &amp;p, State &amp;s, curandState &amp;rng, Geometry *geometry,
703                      bool use_weights=false)
704 {
705     Surface *surface = geometry-&gt;surfaces[s.surface_index];
706
707     if (surface-&gt;model == SURFACE_COMPLEX)
708         return propagate_complex(p, s, rng, surface, use_weights);
709     else if (surface-&gt;model == SURFACE_WLS)
710         return propagate_at_wls(p, s, rng, surface, use_weights);
711     else
712     {
713         // use default surface model: do a combination of specular and
714         // diffuse reflection, detection, and absorption based on relative
715         // probabilties
716
717         // since the surface properties are interpolated linearly, we are
718         // guaranteed that they still sum to 1.0.
719         float detect = interp_property(surface, p.wavelength, surface-&gt;detect);
720         float absorb = interp_property(surface, p.wavelength, surface-&gt;absorb);
721         float reflect_diffuse = interp_property(surface, p.wavelength, surface-&gt;reflect_diffuse);
722         float reflect_specular = interp_property(surface, p.wavelength, surface-&gt;reflect_specular);
723</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../g4py/" title="g4py"
             >next</a> |</li>
        <li class="right" >
          <a href="../opticalsurface/" title="G4OpticalSurface"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../../" >geant4</a> &raquo;</li>
          <li><a href="../../" >Geant4 Geometry Export</a> &raquo;</li>
          <li><a href="../" >surfaces</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>