<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Optical Photon Propagation Times need to use GROUPVEL &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../../_sources/ggeoview/issues/groupvel/intro.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="optical-photon-propagation-times-need-to-use-groupvel">
<h1>Optical Photon Propagation Times need to use GROUPVEL<a class="headerlink" href="#optical-photon-propagation-times-need-to-use-groupvel" title="Permalink to this headline">¶</a></h1>
<p>GROUPVEL material property is auto added by Geant4 (calulated from RINDEX)
at the first <em>G4MaterialPropertiesTable::GetProperty</em></p>
<div class="section" id="where-when-how-to-bring-into-ggeo">
<h2>Where/when/how to bring into GGeo ?<a class="headerlink" href="#where-when-how-to-bring-into-ggeo" title="Permalink to this headline">¶</a></h2>
<div class="section" id="another-material-property-added-to-the-g4dae-export">
<h3>Another material property added to the G4DAE export ?<a class="headerlink" href="#another-material-property-added-to-the-g4dae-export" title="Permalink to this headline">¶</a></h3>
<p>Just need to call <em>mpt-&gt;GetProperty(&#8220;GROUPVEL&#8221;)</em>  on all G4 materials
before (or as part of) the export for the property to be created
and thus seen by the exporter.</p>
<p>Thus approach is simple but somewhat arduous, if the calulation can
easily be reproduced can do so on RINDEX at later stage.</p>
<div class="highlight-python"><pre>ggv-;ggv-pmt-test --cdetector --export --exportconfig /tmp/test.dae

delta:issues blyth$ grep GROUPVEL /tmp/test.dae
        &lt;matrix coldim="2" name="GROUPVEL0x7f8f5147a3d0"&gt;1.512e-06 205.619 1.5498e-06 205.619 1.58954e-06 205.619 1.63137e-06 205.619 1.67546e-06 205.619 1.722e-06 205.619 1.7712e-06 205.619 1.8233e-06 205.619 1.87855e-06 205.619 1.93725e-06 205.619 1.99974e-06 205.619 2.0664e-06 205.619 2.13766e-06 205.619 2.214e-06 205.619 2.296e-06 205.619 2.38431e-06 205.619 2.47968e-06 205.619 2.583e-06 205.619 2.69531e-06 205.619 2.81782e-06 205.619 2.952e-06 205.619 3.0996e-06 205.619 3.26274e-06 205.619 3.44401e-06 205.619 3.64659e-06 205.619 3.87451e-06 205.619 4.13281e-06 205.619 4.42801e-06 205.619 4.76862e-06 205.619 5.16601e-06 205.619 5.63564e-06 205.619 6.19921e-06 205.619 6.88801e-06 205.619 7.74901e-06 205.619 8.85601e-06 205.619 1.0332e-05 205.619 1.23984e-05 205.619 1.5498e-05 205.619 2.0664e-05 205.619&lt;/matrix&gt;
        &lt;property name="GROUPVEL" ref="GROUPVEL0x7f8f5147a3d0"/&gt;
...</pre>
</div>
<p><em>AssimpGGeo::convertMaterials</em>:</p>
<div class="highlight-python"><pre>430
431             //printf("AssimpGGeo::convertMaterials aiScene materialIndex %u (GMaterial) name %s \n", i, name);
432             GMaterial* gmat = new GMaterial(name, index);
433             gmat-&gt;setStandardDomain(standard_domain);
434             addProperties(gmat, mat );
435             gg-&gt;add(gmat);
436
437             {
438                 // without standard domain applied
439                 GMaterial* gmat_raw = new GMaterial(name, index);
440                 addProperties(gmat_raw, mat );
441                 gg-&gt;addRaw(gmat_raw);
442             }
443


All properties get incorporated into the pmap by AssimpGGeo

void AssimpGGeo::addPropertyVector(GPropertyMap&lt;float&gt;* pmap, const char* k, aiMaterialProperty* property )</pre>
</div>
</div>
</div>
<div class="section" id="groupvel-in-geant4">
<h2>GROUPVEL in Geant4<a class="headerlink" href="#groupvel-in-geant4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.google.com/search?q=geant4 bug report 741">google:geant4 bug report 741</a></li>
<li><a class="reference external" href="http://bugzilla-geant4.kek.jp/show_bug.cgi?id=741">http://bugzilla-geant4.kek.jp/show_bug.cgi?id=741</a></li>
</ul>
<p>Optical photons were incorrectly propagating at phase velocity, should be group velocity</p>
</div>
<div class="section" id="g-horton-smith-2005-04-14">
<h2>G. Horton-Smith, 2005/04/14<a class="headerlink" href="#g-horton-smith-2005-04-14" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://neutrino.phys.ksu.edu/~gahs/G4_GROUPVEL_fix/">http://neutrino.phys.ksu.edu/~gahs/G4_GROUPVEL_fix/</a></li>
<li><a class="reference external" href="http://neutrino.phys.ksu.edu/~gahs/G4_GROUPVEL_fix/G4Track.patch">http://neutrino.phys.ksu.edu/~gahs/G4_GROUPVEL_fix/G4Track.patch</a></li>
</ul>
<p>As described in Geant4 bug report #741, optical photons in Geant4 release 7.0
propagate at the phase velocity c/n(E), where E is the energy of the photon.
This is a bug because photons in real life propagate at the group velocity
vg = c/(n(E)+dn/d(log(E)).</p>
</div>
<div class="section" id="geant4-fix-into-4-7-1">
<h2>Geant4 fix into 4.7.1<a class="headerlink" href="#geant4-fix-into-4-7-1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://geant4.web.cern.ch/geant4/support/ReleaseNotes4.7.1.html">http://geant4.web.cern.ch/geant4/support/ReleaseNotes4.7.1.html</a></li>
</ul>
<p>Added SetGROUPVEL() to G4MaterialPropertiesTable. Addresses problem report #741.</p>
</div>
<div class="section" id="observe">
<h2>Observe<a class="headerlink" href="#observe" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://www.physicsforums.com/threads/trying-to-derive-a-group-velocity-equation.441274/">https://www.physicsforums.com/threads/trying-to-derive-a-group-velocity-equation.441274/</a></li>
</ul>
<p>Is that the same ?</p>
<div class="highlight-python"><pre> d(log(E))     1
---------  =  --
   dE          E</pre>
</div>
<ul>
<li><p class="first"><a class="reference external" href="https://en.wikipedia.org/wiki/Dispersion_(optics">https://en.wikipedia.org/wiki/Dispersion_(optics</a>)</p>
<blockquote>
<div><p>vg = c / ( n - w dn/dw )</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="g4materialpropertiestable-setgroupvel">
<h2>G4MaterialPropertiesTable::SetGROUPVEL<a class="headerlink" href="#g4materialpropertiestable-setgroupvel" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>034 // File: G4MaterialPropertiesTable.cc
 35 // Version:     1.0
 36 // Created:     1996-02-08
 37 // Author:      Juliet Armstrong
 38 // Updated:     2005-05-12 add SetGROUPVEL(), courtesy of
 39 //              Horton-Smith (bug report #741), by P. Gumplinger


119 G4MaterialPropertyVector* G4MaterialPropertiesTable::SetGROUPVEL()
120 {
...
141   G4MaterialPropertyVector* groupvel = new G4MaterialPropertyVector();
142
143   // fill GROUPVEL vector using RINDEX values
144   // rindex built-in "iterator" was advanced to first entry above
145   //
146   G4double E0 = rindex-&gt;Energy(0);
147   G4double n0 = (*rindex)[0];
...
160     G4double E1 = rindex-&gt;Energy(1);
161     G4double n1 = (*rindex)[1];
168
169     G4double vg;
170
171     // add entry at first photon energy
172     //
173     vg = c_light/(n0+(n1-n0)/std::log(E1/E0));
174
175     // allow only for 'normal dispersion' -&gt; dn/d(logE) &gt; 0
176     //
177     if((vg&lt;0) || (vg&gt;c_light/n0))  { vg = c_light/n0; }
178
179     groupvel-&gt;InsertValues( E0, vg );
180
181     // add entries at midpoints between remaining photon energies
182     //
183
184     for (size_t i = 2; i &lt; rindex-&gt;GetVectorLength(); i++)
185     {
186       vg = c_light/( 0.5*(n0+n1)+(n1-n0)/std::log(E1/E0));
187
188       // allow only for 'normal dispersion' -&gt; dn/d(logE) &gt; 0
189       //
190       if((vg&lt;0) || (vg&gt;c_light/(0.5*(n0+n1))))  { vg = c_light/(0.5*(n0+n1)); }
191       groupvel-&gt;InsertValues( 0.5*(E0+E1), vg );
192
193       // get next energy/value pair, or exit loop
194       //
195       E0 = E1;
196       n0 = n1;
197       E1 = rindex-&gt;Energy(i);
198       n1 = (*rindex)[i];
199
200       if (E1 &lt;= 0.)
201       {
202         G4Exception("G4MaterialPropertiesTable::SetGROUPVEL()", "mat205",
203                     FatalException, "Optical Photon Energy &lt;= 0");
204       }
205     }
206
207     // add entry at last photon energy
208     //
209     vg = c_light/(n1+(n1-n0)/std::log(E1/E0));
210
211     // allow only for 'normal dispersion' -&gt; dn/d(logE) &gt; 0
212     //
213     if((vg&lt;0) || (vg&gt;c_light/n1))  { vg = c_light/n1; }
214     groupvel-&gt;InsertValues( E1, vg );
215   }
216   else // only one entry in RINDEX -- weird!
217   {
218     groupvel-&gt;InsertValues( E0, c_light/n0 );
219   }
220
221   this-&gt;AddProperty( "GROUPVEL", groupvel );
222
223   return groupvel;
224 }</pre>
</div>
</div>
<div class="section" id="recreate-the-calc">
<h2>Recreate the calc ?<a class="headerlink" href="#recreate-the-calc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>In [22]: np.dstack([w, n])
Out[22]:
array([[[  60.   ,    1.434],
        [  79.737,    1.434],
        [  99.474,    1.434],
        [ 119.211,    1.434],
        [ 138.947,    1.642],</pre>
</div>
<p>Negative is normal dispersion (n down and w up):</p>
<div class="highlight-python"><pre>In [26]: 1000.*dn/dw
Out[26]:
array([  0.   ,   0.   ,   0.   ,  10.542,   5.896, -12.743,   4.491,
        -0.933,  -0.933,  -0.933,  -0.933,  -0.933,  -0.264,  -0.264,
        -0.264,  -0.264,  -0.264,  -0.144,  -0.105,  -0.095,  -0.095,
        -0.072,  -0.062,  -0.062,  -0.06 ,  -0.059,  -0.048,  -0.039,
        -0.039,  -0.039,  -0.039,  -0.028,  -0.016,  -0.016,  -0.016,
        -0.016,  -0.016,   0.   ])

In [27]: n
Out[27]:
array([ 1.434,  1.434,  1.434,  1.434,  1.642,  1.758,  1.507,  1.596,
        1.577,  1.559,  1.54 ,  1.522,  1.503,  1.498,  1.493,  1.488,
        1.483,  1.477,  1.475,  1.473,  1.471,  1.469,  1.467,  1.466,
        1.465,  1.464,  1.463,  1.462,  1.461,  1.46 ,  1.459,  1.459,
        1.458,  1.458,  1.457,  1.457,  1.457,  1.456,  1.456], dtype=float32)</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Talk%3ADispersion_(optics">https://en.wikipedia.org/wiki/Talk%3ADispersion_(optics</a>)</li>
<li><a class="reference external" href="http://hypernews.slac.stanford.edu/HyperNews/geant4/get/opticalphotons/420/1.html">http://hypernews.slac.stanford.edu/HyperNews/geant4/get/opticalphotons/420/1.html</a></li>
<li><a class="reference external" href="https://indico.fnal.gov/contributionDisplay.py?sessionId=18&amp;contribId=41&amp;confId=4535">https://indico.fnal.gov/contributionDisplay.py?sessionId=18&amp;contribId=41&amp;confId=4535</a></li>
</ul>
</div>
<div class="section" id="bringing-groupvel-into-opticks">
<h2>Bringing GROUPVEL into Opticks<a class="headerlink" href="#bringing-groupvel-into-opticks" title="Permalink to this headline">¶</a></h2>
<p>Properties are fed in via the boundary texture:</p>
<div class="highlight-python"><pre>705 void App::prepareOptiX()
706 {
...
723     m_olib = new OBndLib(context,m_ggeo-&gt;getBndLib());
724     m_olib-&gt;convert();


23 void OBndLib::makeBoundaryTexture(NPY&lt;float&gt;* buf)
24 {
25     //  eg (123, 4, 39, 4)   boundary, imat-omat-isur-osur, wavelength-samples, 4-props
26
27     unsigned int ni = buf-&gt;getShape(0);
28     unsigned int nj = buf-&gt;getShape(1);
29     unsigned int nk = buf-&gt;getShape(2);
30     unsigned int nl = buf-&gt;getShape(3);
31
32     assert(ni == m_lib-&gt;getNumBnd()) ;
33     assert(nj == GPropertyLib::NUM_QUAD &amp;&amp; nk == Opticks::DOMAIN_LENGTH &amp;&amp; nl == GPropertyLib::NUM_PROP );
34
35     unsigned int nx = nk ;
36     unsigned int ny = ni*nj ;   // not nl as using float4
37
38     LOG(debug) &lt;&lt; "OBndLib::makeBoundaryTexture buf "
39               &lt;&lt; buf-&gt;getShapeString()
40               &lt;&lt; " ---&gt; "
41               &lt;&lt; " nx " &lt;&lt; nx
42               &lt;&lt; " ny " &lt;&lt; ny
43               ;
44
45     optix::TextureSampler tex = makeTexture(buf, RT_FORMAT_FLOAT4, nx, ny);
46


Source Bnd buffer is a memcpy interweave of Material and Surface buffers

393 NPY&lt;float&gt;* GBndLib::createBuffer()
394 {
395     NPY&lt;float&gt;* mat = m_mlib-&gt;getBuffer();
396     NPY&lt;float&gt;* sur = m_slib-&gt;getBuffer();
397
398     unsigned int ni = getNumBnd();
399     unsigned int nj = NUM_QUAD ;       // im-om-is-os
400     unsigned int nk = Opticks::DOMAIN_LENGTH ;
401     unsigned int nl = NUM_PROP ;       // 4 interweaved props
        // for materials the 4 props are refractive_index, scattering_length, absorption_length, reemission_probability


60 static __device__ __inline__ float4 wavelength_lookup(float nm, unsigned int line )
61 {
62     // x:low y:high z:step w:mid   tex coords are offset by 0.5
63     // texture lookups benefit from hardware interpolation
64     float nmi = (nm - boundary_domain.x)/boundary_domain.z + 0.5f ;
65
66     if( line &gt; boundary_bounds.w )
67     {
68         rtPrintf("wavelength_lookup OUT OF BOUNDS line %4d nmi %10.4f \n", line, nmi );
69     }
70
71     return line &lt;= boundary_bounds.w ?
72                   tex2D(boundary_texture, nmi, line + 0.5f ) :
73                   make_float4(1.123456789f, 123456789.f, 123456789.f, 1.0f )    ;    // some obnoxious values for debug
74
75     // refractive_index, absorption_length, scattering_length, reemission_prob
76     // DEBUG KLUDGE
77 }

27 __device__ void fill_state( State&amp; s, int boundary, uint4 identity, float wavelength )
28 {
29     // boundary : 1 based code, signed by cos_theta of photon direction to outward geometric normal
30     // &gt;0 outward going photon
31     // &lt;0 inward going photon
32
33     int line = boundary &gt; 0 ? (boundary - 1)*BNUMQUAD : (-boundary - 1)*BNUMQUAD  ;
34
35     // pick relevant lines depening on boundary sign, ie photon direction relative to normal
36     //
37     int m1_line = boundary &gt; 0 ? line + IMAT : line + OMAT ;
38     int m2_line = boundary &gt; 0 ? line + OMAT : line + IMAT ;
39     int su_line = boundary &gt; 0 ? line + ISUR : line + OSUR ;
40
41     //  consider photons arriving at PMT cathode surface
42     //  geometry normals are expected to be out of the PMT
43     //
44     //  boundary sign will be -ve : so line+3 outer-surface is the relevant one
45
46     s.material1 = wavelength_lookup( wavelength, m1_line );
47     s.material2 = wavelength_lookup( wavelength, m2_line ) ;
48     s.surface   = wavelength_lookup( wavelength, su_line );

define.h:#define BNUMQUAD 4  // quads per boundary in wavelength texture</pre>
</div>
<p>Would need to increase NUM_PROP(nl) and BNUMQUAD from 4 to 8
Extra props could then be accessed at:</p>
<div class="highlight-python"><pre>int m1x_line = m1_line + 4 ;</pre>
</div>
<p>This approach did not work as the buffer layout must did not match that of the 2d float4 texture,
instead used float buffer shape with the 2 in the middle:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-handle-groupvel-in-comparison-against-cfg4">
<h2>How to handle GROUPVEL in comparison against cfg4- ?<a class="headerlink" href="#how-to-handle-groupvel-in-comparison-against-cfg4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>have extended the texture to accomodate GROUPVEL property, but
without redoing the original G4DAE export only have placeholder GROUPVEL property values
in the materials buffer (and hence bnd buffer and texture)</li>
<li>could just live with the GROUPVEL kludge of using phase velocity for now</li>
</ul>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../../">Env  documentation</a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>