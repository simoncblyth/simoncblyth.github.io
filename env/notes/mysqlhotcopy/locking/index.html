<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Locking used by mysqlhotcopy &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="MySQL hotcopy" href="../" />
    <link rel="next" title="Repair Table" href="../mysql_repair_table/" />
    <link rel="prev" title="mysqlhotcopy.py script" href="../mysqlhotcopy/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../mysql_repair_table/" title="Repair Table"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../mysqlhotcopy/" title="mysqlhotcopy.py script"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">MySQL hotcopy</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../mysqlhotcopy/"><cite>mysqlhotcopy.py</cite> script</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Locking used by mysqlhotcopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql_repair_table/">Repair Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql_repair_table_live/">MySQL repair table live</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lessons/">Lessons from MySQL corruption incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../steps/">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/mysqlhotcopy/locking.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../mysqlhotcopy/"
                        title="previous chapter"><cite>mysqlhotcopy.py</cite> script</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../mysql_repair_table/"
                        title="next chapter">Repair Table</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="locking-used-by-mysqlhotcopy">
<h1>Locking used by mysqlhotcopy<a class="headerlink" href="#locking-used-by-mysqlhotcopy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="following-mysql-log">
<h2>Following mysql log<a class="headerlink" href="#following-mysql-log" title="Permalink to this headline">¶</a></h2>
<p>A default run of <em>mysqlhotcopy</em> results in the below activity in the mysql log, as followed by <cite>mysql-tail</cite></p>
<div class="highlight-python"><pre>130516 12:03:24 2400342 Connect     root@localhost on information_schema
                2400342 Query       set autocommit=1
                2400342 Query       show variables like 'datadir'
                2400342 Query       SHOW TABLES FROM `tmp_offline_db`
                2400342 Query       LOCK TABLES `tmp_offline_db`.`CableMap` READ,
                                                `tmp_offline_db`.`CableMapVld` READ,
                                                ...
                2400342 Query       FLUSH TABLES /\*!32323 `tmp_offline_db`.`CableMap`,
                                                           `tmp_offline_db`.`CableMapVld`,
                                                  ...


130516 12:03:25 2400342 Query       UNLOCK TABLES
                2400342 Quit</pre>
</div>
</div>
<div class="section" id="table-locking">
<h2>Table locking<a class="headerlink" href="#table-locking" title="Permalink to this headline">¶</a></h2>
<p>Checking the <cite>/usr/bin/mysqlhotcopy</cite> perl script source</p>
<p>The official docs are not very explicit, but imply:</p>
<blockquote>
<div><ul class="simple">
<li>with a READ lock, any connection can read from the table, but no connection can write to the table</li>
</ul>
</div></blockquote>
<ol class="arabic">
<li><p class="first"><cite>lock tables &lt;name&gt; READ</cite></p>
<blockquote>
<div><ul>
<li><p class="first"><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/lock-tables.html">http://dev.mysql.com/doc/refman/5.0/en/lock-tables.html</a></p>
</li>
<li><p class="first">A table lock protects only against inappropriate reads or writes by other sessions.
The session holding the lock, even a read lock, can perform table-level operations such as DROP TABLE.</p>
</li>
<li><p class="first"><em>READ</em> locks mean :</p>
<blockquote>
<div><ul class="simple">
<li>The session that holds the lock can read the table (but not write it).</li>
<li>Multiple sessions can acquire a READ lock for the table at the same time.</li>
<li>Other sessions can read the table without explicitly acquiring a READ lock.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><em>WRITE</em> lock</p>
<blockquote>
<div><ul class="simple">
<li>The session that holds the lock can read and write the table.</li>
<li>Only the session that holds the lock can access the table. No other session can access it until the lock is released.</li>
<li>Lock requests for the table by other sessions block while the WRITE lock is held.</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><cite>flush tables</cite> ensures whats is on disk is the latest state of the tables</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/flush.html">http://dev.mysql.com/doc/refman/5.0/en/flush.html</a></li>
<li>Closes all open tables, forces all tables in use to be closed, and flushes the query cache</li>
</ul>
</div></blockquote>
</li>
</ol>
<p>From the first session:</p>
<div class="highlight-python"><pre>mysql&gt; CREATE TABLE t1 (ID INT NOT NULL);
Query OK, 0 rows affected (0.02 sec)

mysql&gt; INSERT INTO t1 VALUES (101);
Query OK, 1 row affected (0.00 sec)

mysql&gt; LOCK TABLE t1 READ;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; INSERT INTO t1 VALUES (102);
ERROR 1099 (HY000): Table 't1' was locked with a READ lock and can't be updated

mysql&gt; LOCK TABLE t1 WRITE;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; INSERT INTO t1 VALUES (102);
Query OK, 1 row affected (0.00 sec)

mysql&gt; INSERT INTO t1 VALUES (103);
Query OK, 1 row affected (0.00 sec)

mysql&gt; /* at this point startup another session and do a select, its blocked */

mysql&gt; LOCK TABLE t1 READ ;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; /* over in the other session downgrading the lock from WRITE to READ allowed the select to complete */

mysql&gt; /* an insert from the other session is hanging around blocked */

mysql&gt; UNLOCK TABLES ;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; /* the insert from the other session proceeded when the unlock was done */</pre>
</div>
<p>Other session:</p>
<div class="highlight-python"><pre>mysql&gt; select * from t1 ;
+-----+
| ID  |
+-----+
| 101 |
| 102 |
| 103 |
+-----+
3 rows in set (1 min 9.29 sec)

mysql&gt; INSERT INTO t1 VALUES (201);
Query OK, 1 row affected (3 min 40.96 sec)</pre>
</div>
<p>Checking processlist while one session is locked out, and has hung around for 2607 seconds:</p>
<div class="highlight-python"><pre>mysql&gt; show processlist ;
+---------+------+-------------------------+----------------+---------+------+--------+-----------------------------+
| Id      | User | Host                    | db             | Command | Time | State  | Info                        |
+---------+------+-------------------------+----------------+---------+------+--------+-----------------------------+
| 2400340 | root | belle7.nuu.edu.tw:34227 | tmp_offline_db | Sleep   | 2657 |        | NULL                        |
| 2400343 | root | belle7.nuu.edu.tw:34148 | tmp_offline_db | Query   |    0 | NULL   | show processlist            |
| 2400344 | root | belle7.nuu.edu.tw:49003 | tmp_offline_db | Query   | 2607 | Locked | INSERT INTO t1 VALUES (301) |
+---------+------+-------------------------+----------------+---------+------+--------+-----------------------------+
3 rows in set (0.00 sec)</pre>
</div>
<p>On accidentally closing the session that held the read lock the lock was releases and the other
session proceeded with the insert after 46min of hanging around:</p>
<div class="highlight-python"><pre>mysql&gt; INSERT INTO t1 VALUES (301);
Query OK, 1 row affected (46 min 16.92 sec)</pre>
</div>
<div class="section" id="locking-timeouts">
<h3>Locking Timeouts<a class="headerlink" href="#locking-timeouts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>mysql&gt; select @@hostname ;
+-------------------+
| @@hostname        |
+-------------------+
| belle7.nuu.edu.tw |
+-------------------+
1 row in set (0.00 sec)

mysql&gt; show variables like '%timeout' ;
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| connect_timeout            | 10    |
| delayed_insert_timeout     | 300   |
| innodb_lock_wait_timeout   | 50    |
| innodb_rollback_on_timeout | OFF   |
| interactive_timeout        | 28800 |
| net_read_timeout           | 30    |
| net_write_timeout          | 60    |
| slave_net_timeout          | 3600  |
| table_lock_wait_timeout    | 50    |
| wait_timeout               | 28800 |
+----------------------------+-------+
10 rows in set (0.00 sec)</pre>
</div>
<p>Apparently <cite>table_lock_wait_timeout</cite> is unused, <a class="reference external" href="http://bugs.mysql.com/bug.php?id=41949">http://bugs.mysql.com/bug.php?id=41949</a> by observation the
locks wait around much longer then 50s</p>
<p>The effective timeout maybe <cite>wait_timeout</cite> which defaults to 8 hrs
* <a class="reference external" href="http://dev.mysql.com/doc/refman/5.1/en/server-system-variables.html#sysvar_wait_timeout">http://dev.mysql.com/doc/refman/5.1/en/server-system-variables.html#sysvar_wait_timeout</a></p>
<div class="highlight-python"><pre>mysql&gt; select @@hostname, @@wait_timeout/60/60 ;
+-------------------+----------------------+
| @@hostname        | @@wait_timeout/60/60 |
+-------------------+----------------------+
| belle7.nuu.edu.tw |           8.00000000 |
+-------------------+----------------------+
1 row in set (0.00 sec)</pre>
</div>
</div>
<div class="section" id="external-file-level-locking">
<h3>External (file level locking)<a class="headerlink" href="#external-file-level-locking" title="Permalink to this headline">¶</a></h3>
<p>External locking is the use of file system locking to manage contention for MyISAM database tables by multiple processes.</p>
<ul class="simple">
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/external-locking.html">http://dev.mysql.com/doc/refman/5.0/en/external-locking.html</a></li>
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/myisamchk.html">http://dev.mysql.com/doc/refman/5.0/en/myisamchk.html</a></li>
</ul>
<p>With external locking disabled, to use myisamchk, you must either stop the
server while myisamchk executes or else lock and flush the tables before
running myisamchk. To avoid this requirement, use the CHECK TABLE and REPAIR TABLE
statements to check and repair MyISAM tables.</p>
<ul class="simple">
<li><em>lock and flush is what hotcopy does</em></li>
</ul>
<div class="highlight-python"><pre>mysql&gt; show variables like '%locking' ;
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| skip_external_locking | ON    |
+-----------------------+-------+
1 row in set (0.00 sec)

mysql&gt; select @@hostname ;
+-------------------+
| @@hostname        |
+-------------------+
| belle7.nuu.edu.tw |
+-------------------+
1 row in set (0.00 sec)</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../mysql_repair_table/" title="Repair Table"
             >next</a> |</li>
        <li class="right" >
          <a href="../mysqlhotcopy/" title="mysqlhotcopy.py script"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>