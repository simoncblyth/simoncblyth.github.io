<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mysqlhotcopy.py script &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="MySQL hotcopy" href="../" />
    <link rel="next" title="Locking used by mysqlhotcopy" href="../locking/" />
    <link rel="prev" title="MySQL hotcopy" href="../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../locking/" title="Locking used by mysqlhotcopy"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../" title="MySQL hotcopy"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">MySQL hotcopy</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href=""><cite>mysqlhotcopy.py</cite> script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../locking/">Locking used by mysqlhotcopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql_repair_table/">Repair Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql_repair_table_live/">MySQL repair table live</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lessons/">Lessons from MySQL corruption incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../steps/">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/mysqlhotcopy/mysqlhotcopy.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../"
                        title="previous chapter">MySQL hotcopy</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../locking/"
                        title="next chapter">Locking used by mysqlhotcopy</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-env.mysqlhotcopy.mysqlhotcopy">
<span id="mysqlhotcopy-py-script"></span><h1><cite>mysqlhotcopy.py</cite> script<a class="headerlink" href="#module-env.mysqlhotcopy.mysqlhotcopy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="mysql-hotcopy-wrapper">
<h2>MySQL Hotcopy wrapper<a class="headerlink" href="#mysql-hotcopy-wrapper" title="Permalink to this headline">¶</a></h2>
<p>Provides a higher level wrapper on top of <em>mysqlhotcopy</em> adding 
features like</p>
<ol class="arabic simple">
<li>archive tarball creation/restoration/organization/transfers in dated folders</li>
<li>disk space estimation by DB queries and file system free space checking before performing <em>hotcopy</em></li>
</ol>
<div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>Checkout directory from <strong>env</strong> repo with:</p>
<div class="highlight-python"><pre>svn co http://dayabay.phys.ntu.edu.tw/repos/env/trunk/mysqlhotcopy 
cd mysqlhotcopy</pre>
</div>
<p>Test runs to ensure pre-requisite <cite>MySQL-python</cite> is present:</p>
<div class="highlight-python"><pre>./mysqlhotcopy.py --help
./mysqlhotcopy.py --dryrun tmp_ligs_offline_db hotcopy   # dryrun check of space available etc..</pre>
</div>
</div>
<div class="section" id="pre-requisites-for-mysqlhotcopy-py">
<h3>Pre-requisites for mysqlhotcopy.py<a class="headerlink" href="#pre-requisites-for-mysqlhotcopy-py" title="Permalink to this headline">¶</a></h3>
<p>Requires MySQLdb, check that and operating env with:</p>
<div class="highlight-python"><pre>sudo python -c "import MySQLdb"</pre>
</div>
<p>If that gives errors will need to:</p>
<div class="highlight-python"><pre>sudo yum install MySQL-python</pre>
</div>
<p>Intended to be used in system python from sudo, operating from non-pristine 
env may cause errors related to setuptools.</p>
</div>
<div class="section" id="pre-requisites-for-mysqlhotcopy">
<h3>Pre-requisites for mysqlhotcopy<a class="headerlink" href="#pre-requisites-for-mysqlhotcopy" title="Permalink to this headline">¶</a></h3>
<div class="section" id="perl-module-dbd-mysql">
<h4>Perl module <cite>DBD::mysql</cite><a class="headerlink" href="#perl-module-dbd-mysql" title="Permalink to this headline">¶</a></h4>
<p>Without this perl module errors like the below are observed:</p>
<div class="highlight-python"><pre>install_driver(mysql) failed: Can't locate DBD/mysql.pm 

[root@belle1 ~]# perl -mDBD::mysql -e ''
Can't locate DBD/mysql.pm in @INC (@INC contains: /usr/lib/perl5/site_perl/5.8.8/i386-linux-thread-multi /usr/lib/perl5/site_perl/5.8.8 /usr/lib/perl5/site_perl /usr/lib/perl5/vendor_perl/5.8.8/i386-linux-thread-multi /usr/lib/perl5/vendor_perl/5.8.8 /usr/lib/perl5/vendor_perl /usr/lib/perl5/5.8.8/i386-linux-thread-multi /usr/lib/perl5/5.8.8 .).
BEGIN failed--compilation aborted.</pre>
</div>
</div>
</div>
<div class="section" id="features-of-mysqlhotcopy">
<h3>Features of mysqlhotcopy<a class="headerlink" href="#features-of-mysqlhotcopy" title="Permalink to this headline">¶</a></h3>
<p>mysqlhotcopy does low level file copying, making version closeness important</p>
<div class="highlight-python"><pre>dybdb1.ihep.ac.cn        5.0.45-community-log MySQL Community Edition (GPL)
belle7.nuu.edu.tw        5.0.77-log Source distribution
cms01.phys.ntu.edu.tw    4.1.22-log</pre>
</div>
</div>
<div class="section" id="commands">
<h3>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h3>
<p>The first argument of the <cite>mysqlhotcopy.py</cite> script specifies the name of a mysql database
to operate upon.  Subsequent arguments specify actions to take. Order is important.</p>
<dl class="docutils">
<dt><cite>hotcopy</cite></dt>
<dd>use <em>mysqlhotcopy</em> to copy the mysql datadir for a single database into a dated folder under <cite>backupdir</cite>, 
with path of form <cite>/var/dbbackup/mysqlhotcopy/belle1.nuu.edu.tw/channelquality_db/20130530_1954</cite>
the folder and its parent folders are created if necessary</dd>
<dt><cite>coldcopy</cite></dt>
<dd>Manual file system copy <strong>without locking</strong> the DB. Used for investigating crashed DBs, DO NOT USE FOR RELIABLE BACKUPS. TREAT WITH CAUTION</dd>
<dt><cite>archive</cite></dt>
<dd>archives the dated folder into a tarball and deletes the dated folder</dd>
<dt><cite>examine</cite></dt>
<dd>examines the paths within the tarball and determines their common prefix path and classifies as flattop or otherwise
<cite>examine</cite> must be run before doing <cite>extract</cite></dd>
<dt><cite>transfer</cite></dt>
<dd>uses <em>scp</em> to copy a tarball to a remote node</dd>
<dt><cite>extract</cite></dt>
<dd>extracts the content from a tarball into the mysql datadir, <strong>CAUTION THIS IS DANGEROUS</strong> test on non-critical servers first</dd>
<dt><cite>ls</cite></dt>
<dd>list the tarballs for a database</dd>
<dt><cite>purge</cite></dt>
<dd>purge the tarballs for a database, keeping the configured number</dd>
</dl>
</div>
<div class="section" id="usage-steps">
<h3>Usage steps<a class="headerlink" href="#usage-steps" title="Permalink to this headline">¶</a></h3>
<p>Examples of usage:</p>
<div class="highlight-python"><pre>cd env/mysqlhotbackup
./mysqlhotbackup.py --help

./mysqlhotbackup.py tmp_ligs_offline_db  hotcopy archive transfer 

      # 1st argument is DB name, subsequent are the actions to take
      # the **hotcopy** action is the one during which the DB tables are locked


./mysqlhotbackup.py -t 20130516_1711 tmp_ligs_offline_db transfer 

      # if need to transfer or archive separately from the hotcopy 
      # then must specify the time tag corresponding to the hotcopy and archive 
      # to be transferred

./mysqlhotcopy.py --regex './^\(DqChannelStatus\|DqChannelStatusVld\)/'  tmp_ligs_offline_db hotcopy archive transfer      

      # using regex to only include 2 tables, this regex is tacked on to the mysqhotcopy 
      # database argument and subsequently interpreted as a perl regular expression 

./mysqlhotcopy.py -l debug --regex "^DqChannelPacked" tmp_offline_db coldcopy 

      # NB when using coldcopy the regex must be a python compatible regexp to select tables to include

./mysqlhotcopy.py --regex './^\(DqChannelPacked\|DqChannelPackedVld\)/'  tmp_offline_db hotcopy       

      # have to escape the brackets and pipe symbol to protect from shell interpretation

./mysqlhotcopy.py -C --regex './^LOCALSEQNO/' tmp_offline_db hotcopy archive 

      # for quick machinery testing, restrict to just handling a small table and disable interactive confirmations
      # note that hotcopy will delete a pre-existing same minute folder however

./mysqlhotcopy.py -l debug --flattop --remotenode S --regex '^(DqChannelStatus|DqChannelStatusVld)\.[^.]*$'  tmp_ligs_offline_db_0  coldcopy 

     # more realistic coldcopy python regex to just handle a single pair of DBI tables, note that the pattern has to match that of 
     # names of the internal mysql files ie `.MYI` `.MYD` `.frm`

rm -rf /tmp/tmp_offline_db &amp;&amp; mysqlhotcopy.py --regex "^LOCALSEQNO"  -l debug --ALLOWEXTRACT -x /tmp -C tmp_offline_db coldcopy archive examine extract  

      # quick full coldcopy chain testing 

rm -rf /tmp/tmp_offline_db &amp;&amp; mysqlhotcopy.py --regex "./^LOCALSEQNO/"  -l debug --ALLOWEXTRACT -x /tmp -C tmp_offline_db hotcopy archive examine extract  

      # quick full hotcopy chain testing 

mysqlhotcopy.py --regex "^DqChannelPacked"  -l debug --ALLOWEXTRACT --flattop -C --rename tmp_offline_db_ext tmp_offline_db coldcopy archive examine extract  

      # after this, can immediately "use tmp_offline_db_ext" and query against the coldcopied tables </pre>
</div>
<div class="section" id="ownership-issue-fixed">
<h4>Ownership issue FIXED<a class="headerlink" href="#ownership-issue-fixed" title="Permalink to this headline">¶</a></h4>
<p>During development the ownership of <cite>coldcopy</cite> directories was initially not preserved, until r3745:</p>
<div class="highlight-python"><pre>rm -rf /tmp/tmp_offline_db &amp;&amp; mysqlhotcopy.py --regex "./^LOCALSEQNO/"  -l debug --ALLOWEXTRACT -x /tmp --flattop -C tmp_offline_db hotcopy archive examine extract  &amp;&amp; ll tmp_offline_db/ &amp;&amp;  [ $(id -u mysql) -eq $(stat -c %u /tmp) ] &amp;&amp; echo OK || echo NOPE

    # succeeds  </pre>
</div>
</div>
<div class="section" id="hotcopy-archive-transfer">
<h4>hotcopy, archive, transfer<a class="headerlink" href="#hotcopy-archive-transfer" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>create mysqlhotcopy section in <tt class="file docutils literal"><span class="pre">~/.my.cnf</span></tt> ie <cite>/root/.my.cnf</cite> as this must be 
run as root in order to have access to the mysql DB files</li>
</ol>
<div class="highlight-python"><pre>[mysqlhotcopy]
socket    = /var/lib/mysql/mysql.sock
# if somehow the socket config is ignored by mysqlhotcopy then use option `--socket /tmp/mysql.sock`
host      = localhost
user      = root
password  = ***
database = information_schema
# 
# NB needs a database specified to allow DB connection to make the locks, 
# but database to backup is provided as an argument to mysqlhotbackup 
# mitigate the duplicity by using the system metadata databse `information_schema` </pre>
</div>
<p>The hotcopy is very fast compared to the tgz creation, these 
are done separated (not in a pipe for example) so the time the DB is locked is 
kept to a minimum:</p>
<div class="highlight-python"><pre>[root@belle7 blyth]# mysqlhotcopy.py tmp_offline_db hotcopy archive transfer
2013-05-16 17:11:16,649 env.mysqlhotcopy.mysqlhotcopy INFO     /home/blyth/env/bin/mysqlhotcopy.py tmp_offline_db hotcopy archive transfer
2013-05-16 17:11:16,653 env.mysqlhotcopy.mysqlhotcopy INFO     backupdir /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db 
2013-05-16 17:11:16,673 env.mysqlhotcopy.mysqlhotcopy INFO     db size in MB 152.27 
2013-05-16 17:11:16,673 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== hotcopy 
2013-05-16 17:11:16,673 env.mysqlhotcopy.mysqlhotcopy INFO     sufficient free space,      required 380.675 MB less than    free 497384.726562 MB 
2013-05-16 17:11:16,673 env.mysqlhotcopy.mysqlhotcopy INFO     hotcopy of database tmp_offline_db into outd /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711 
2013-05-16 17:11:16,685 env.mysqlhotcopy.mysqlhotcopy INFO     proceed with MySQLHotCopy /usr/bin/mysqlhotcopy tmp_offline_db /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711   
2013-05-16 17:11:17,256 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_hotcopy': 0.58285903930664062} 
2013-05-16 17:11:17,257 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== archive 
2013-05-16 17:11:17,257 env.mysqlhotcopy.mysqlhotcopy INFO     sufficient free space,      required 380.675 MB less than    free 497231.179688 MB 
2013-05-16 17:11:17,257 env.mysqlhotcopy.mysqlhotcopy INFO     tagd /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711  into Tar /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz tmp_offline_db gz  
2013-05-16 17:11:17,258 env.mysqlhotcopy.tar INFO     creating /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz from /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711/tmp_offline_db 
2013-05-16 17:15:35,201 env.mysqlhotcopy.tar WARNING  deleting src /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711/tmp_offline_db directory following archive creation 
2013-05-16 17:15:35,241 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_hotcopy': 0.58285903930664062, 'archive': 257.98302602767944, '_archive': 257.98317098617554} 
2013-05-16 17:15:35,241 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== transfer 
2013-05-16 17:15:35,241 env.mysqlhotcopy.mysqlhotcopy INFO     sufficient free space,      required 380.675 MB less than    free 497335.757812 MB 
2013-05-16 17:15:35,241 env.mysqlhotcopy.mysqlhotcopy INFO     transfer Tar /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz tmp_offline_db gz  to remotenode C   
2013-05-16 17:15:35,242 env.mysqlhotcopy.common INFO     transfer /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz C  
ssh C "mkdir -p /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db " 
ssh: connect to host 140.112.101.190 port 22: Connection timed out
time scp /var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz C:/var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db/20130516_1711.tar.gz 
ssh: connect to host 140.112.101.190 port 22: Connection timed out
lost connection

real    3m9.056s
user    0m0.000s
sys     0m0.007s
2013-05-16 17:21:53,351 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'transfer': 378.10944199562073, '_hotcopy': 0.58285903930664062, '_transfer': 378.10959100723267, 'archive': 257.98302602767944, '_archive': 257.98317098617554} 
[root@belle7 blyth]# </pre>
</div>
<p>When doing <cite>archive</cite>, <cite>transfer</cite> (or <cite>extract</cite>) separately from the <cite>hotcopy</cite> specifying the timestamp
is required as shown below.</p>
</div>
<div class="section" id="extract-dryrun">
<h4>extract dryrun<a class="headerlink" href="#extract-dryrun" title="Permalink to this headline">¶</a></h4>
<p>Due to the potential for damage from tampering with the mysql datadir, <strong>extraction</strong> requres a few options</p>
<p>Extraction of the <cite>dybdb1.ihep.ac.cn</cite> tarball onto belle7.  As no DB called <cite>tmp_ligs_offline_db</cite> 
exists on <cite>belle7</cite> it is necessary to provide the appropriate datadir for the node 
with <cite>&#8211;containerdir /var/lib/mysql</cite></p>
<p>This is a dryrun due to option <cite>-n</cite> in order to check the paths are as expected:</p>
<div class="highlight-python"><pre>[root@belle7 ~]# mysqlhotcopy.py -t 20130522_1541 --node dybdb1.ihep.ac.cn --rename tmp_ligs_offline_db_0 --containerdir /var/lib/mysql --ALLOWEXTRACT -n tmp_ligs_offline_db examine extract
2013-05-23 12:01:37,782 env.mysqlhotcopy.mysqlhotcopy INFO     /home/blyth/env/bin/mysqlhotcopy.py -t 20130522_1541 --node dybdb1.ihep.ac.cn --rename tmp_ligs_offline_db_0 --containerdir /var/lib/mysql --ALLOWEXTRACT -n tmp_ligs_offline_db examine extract
2013-05-23 12:01:37,782 env.mysqlhotcopy.mysqlhotcopy INFO     backupdir /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db 
2013-05-23 12:01:37,794 env.mysqlhotcopy.mysqlhotcopy INFO     failed to instanciate connection to database tmp_ligs_offline_db with exception Error 1049: Unknown database 'tmp_ligs_offline_db'  
2013-05-23 12:01:37,794 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== examine 
2013-05-23 12:01:37,794 env.mysqlhotcopy.tar INFO     examining /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz 
2013-05-23 12:02:13,057 env.mysqlhotcopy.tar INFO     archive contains 7 items with commonprefix "" flattop True 
2013-05-23 12:02:13,057 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_examine': 35.262603998184204, 'examine': 35.262594938278198} 
2013-05-23 12:02:13,057 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== extract 
2013-05-23 12:02:13,057 env.mysqlhotcopy.mysqlhotcopy WARNING  no valid db connection using static opts.mb_required 2000 
2013-05-23 12:02:13,058 env.mysqlhotcopy.mysqlhotcopy INFO     sufficient free space,      required 2000 MB less than    free 494499.9375 MB 
2013-05-23 12:02:13,058 env.mysqlhotcopy.mysqlhotcopy INFO     proceeding
2013-05-23 12:02:13,058 env.mysqlhotcopy.mysqlhotcopy INFO     extract Tar /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz tmp_ligs_offline_db gz  into containerdir /var/lib/mysql   
2013-05-23 12:02:13,058 env.mysqlhotcopy.tar INFO     _flat_extract opening tarfile /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz 
2013-05-23 12:02:48,471 env.mysqlhotcopy.tar INFO     dryrun: _flat_extract into target /var/lib/mysql/tmp_ligs_offline_db_0 for 7 members with toplevelname tmp_ligs_offline_db_0 
2013-05-23 12:02:48,472 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_examine': 35.262603998184204, 'examine': 35.262594938278198, 'extract': 35.413694858551025, '_extract': 35.414549112319946} 
[root@belle7 ~]# </pre>
</div>
</div>
<div class="section" id="actual-extraction">
<h4>actual extraction<a class="headerlink" href="#actual-extraction" title="Permalink to this headline">¶</a></h4>
<p>An interactive confirmation of <strong>YES</strong> is required before the extraction is done.</p>
<div class="highlight-python"><pre>[root@belle7 ~]# mysqlhotcopy.py -t 20130522_1541 --node dybdb1.ihep.ac.cn --rename tmp_ligs_offline_db_0 --containerdir /var/lib/mysql --ALLOWEXTRACT  tmp_ligs_offline_db examine extract
2013-05-23 12:06:33,546 env.mysqlhotcopy.mysqlhotcopy INFO     /home/blyth/env/bin/mysqlhotcopy.py -t 20130522_1541 --node dybdb1.ihep.ac.cn --rename tmp_ligs_offline_db_0 --containerdir /var/lib/mysql --ALLOWEXTRACT tmp_ligs_offline_db examine extract
2013-05-23 12:06:33,546 env.mysqlhotcopy.mysqlhotcopy INFO     backupdir /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db 
2013-05-23 12:06:33,561 env.mysqlhotcopy.mysqlhotcopy INFO     failed to instanciate connection to database tmp_ligs_offline_db with exception Error 1049: Unknown database 'tmp_ligs_offline_db'  
2013-05-23 12:06:33,561 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== examine 
2013-05-23 12:06:33,562 env.mysqlhotcopy.tar INFO     examining /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz 
2013-05-23 12:07:08,913 env.mysqlhotcopy.tar INFO     archive contains 7 items with commonprefix "" flattop True 
2013-05-23 12:07:08,913 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_examine': 35.351444005966187, 'examine': 35.35143518447876} 
2013-05-23 12:07:08,913 env.mysqlhotcopy.mysqlhotcopy INFO     ================================== extract 
2013-05-23 12:07:08,914 env.mysqlhotcopy.mysqlhotcopy WARNING  no valid db connection using static opts.mb_required 2000 
2013-05-23 12:07:08,914 env.mysqlhotcopy.mysqlhotcopy INFO     sufficient free space,      required 2000 MB less than    free 494499.882812 MB 
DO YOU REALLY WANT TO extract Tar /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz tmp_ligs_offline_db gz  into containerdir /var/lib/mysql    ? ENTER "YES" TO PROCEED : YES
2013-05-23 12:07:48,589 env.mysqlhotcopy.mysqlhotcopy INFO     proceeding
2013-05-23 12:07:48,589 env.mysqlhotcopy.mysqlhotcopy INFO     extract Tar /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz tmp_ligs_offline_db gz  into containerdir /var/lib/mysql   
2013-05-23 12:07:48,589 env.mysqlhotcopy.tar INFO     _flat_extract opening tarfile /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130522_1541.tar.gz 
2013-05-23 12:08:23,906 env.mysqlhotcopy.tar INFO     _flat_extract into target /var/lib/mysql/tmp_ligs_offline_db_0 for 7 members with toplevelname tmp_ligs_offline_db_0 
2013-05-23 12:09:06,346 env.mysqlhotcopy.tar INFO     total 2429412
-rw-rw---- 1 mysql mysql       8746 Feb  4 16:07 DqChannelStatus.frm
-rw-rw---- 1 mysql mysql 1439608104 May 16 19:15 DqChannelStatus.MYD
-rw-rw---- 1 mysql mysql 1024402432 May 16 19:42 DqChannelStatus.MYI
-rw-rw---- 1 mysql mysql       8908 May 13 13:16 DqChannelStatusVld.frm
-rw-rw---- 1 mysql mysql   17397375 May 20 06:26 DqChannelStatusVld.MYD
-rw-rw---- 1 mysql mysql    3826688 May 20 06:26 DqChannelStatusVld.MYI

2013-05-23 12:09:06,347 env.mysqlhotcopy.mysqlhotcopy INFO     seconds {'_examine': 35.351444005966187, 'examine': 35.35143518447876, 'extract': 77.757769107818604, '_extract': 117.43390297889709} 
[root@belle7 ~]# </pre>
</div>
</div>
</div>
<div class="section" id="mysqlhotcopy-options">
<h3>mysqlhotcopy options<a class="headerlink" href="#mysqlhotcopy-options" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><cite>&#8211;allowold</cite></dt>
<dd><p class="first">Move any existing version of the destination to a backup directory
for the duration of the copy. If the copy successfully completes, the backup
directory is deleted - unless the &#8211;keepold flag is set.  If the copy fails,
the backup directory is restored.</p>
<p class="last">The backup directory name is the original name with &#8220;_old&#8221; appended.
Any existing versions of the backup directory are deleted.</p>
</dd>
</dl>
</div>
<div class="section" id="size-estimation">
<h3>Size estimation<a class="headerlink" href="#size-estimation" title="Permalink to this headline">¶</a></h3>
<p>Size of hotcopy directory close to that estimated from DB, tgz is factor of 3 smaller:</p>
<div class="highlight-python"><pre>[blyth@belle7 DybPython]$ echo "select round(sum((data_length+index_length-data_free)/1024/1024),2) as TOT_MB from information_schema.tables where table_schema = 'tmp_offline_db' " | mysql -t 
+--------+
| TOT_MB |
+--------+
| 152.27 | 
+--------+

[blyth@belle7 mysqlhotcopy]$ sudo du -h 20130514_1832        
154M    20130514_1832/tmp_offline_db
154M    20130514_1832

[blyth@belle7 mysqlhotcopy]$ sudo du -h 20130514_1832.tar.gz 
49M     20130514_1832.tar.gz</pre>
</div>
</div>
<div class="section" id="prepare-directories-on-target-for-the-transfer">
<h3>Prepare directories on target for the transfer<a class="headerlink" href="#prepare-directories-on-target-for-the-transfer" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@cms01 dbbackup]$ sudo mkdir -p /data/var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/
[blyth@cms01 dbbackup]$ sudo mkdir -p /data/var/dbbackup/mysqlhotcopy/dybdb2.ihep.ac.cn/tmp_ligs_offline_db/
[blyth@cms01 dbbackup]$ sudo chown -R dayabayscp /data/var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/
[blyth@cms01 dbbackup]$ sudo chown -R dayabayscp /data/var/dbbackup/mysqlhotcopy/dybdb2.ihep.ac.cn/tmp_ligs_offline_db/</pre>
</div>
<p>And for testing N to H transfers:</p>
<div class="highlight-python"><pre>[blyth@hfag data]$ sudo mkdir -p /data/var/dbbackup/mysqlhotcopy/belle7.nuu.edu.tw/tmp_offline_db </pre>
</div>
</div>
<div class="section" id="table-by-table-hotcopy-to-minimise-table-lock-time">
<h3>Table-by-table hotcopy, to minimise table lock time ?<a class="headerlink" href="#table-by-table-hotcopy-to-minimise-table-lock-time" title="Permalink to this headline">¶</a></h3>
<p>Whilst possible to handle DBI tables in separate hotcopies of payload+validity pairs 
using <cite>&#8211;addtodest</cite> option this might not be a consistent backup, and there is the LOCALSEQNO
too to cause problems.</p>
<dl class="docutils">
<dt><cite>&#8211;addtodest</cite></dt>
<dd><p class="first">Don&#8217;t rename target directory if it already exists, just add the copied files into it.</p>
<p>This is most useful when backing up a database with many large tables and
you don&#8217;t want to have all the tables locked for the whole duration.</p>
<p class="last">In this situation, if you are happy for groups of tables to be backed up
separately (and thus possibly not be logically consistant with one another)
then you can run mysqlhotcopy several times on the same database each with
different db_name./table_regex/.  All but the first should use the &#8211;addtodest
option so the tables all end up in the same directory.</p>
</dd>
</dl>
</div>
<div class="section" id="behaviour-with-crashed-tables">
<h3>Behaviour with crashed tables<a class="headerlink" href="#behaviour-with-crashed-tables" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://www.databasejournal.com/features/mysql/article.php/3300511/Repairing-Database-Corruption-in-MySQL.htm">http://www.databasejournal.com/features/mysql/article.php/3300511/Repairing-Database-Corruption-in-MySQL.htm</a></li>
</ul>
<div class="highlight-python"><pre>[root@dybdb1 mysqlhotcopy]#   ./mysqlhotcopy.py -l debug tmp_ligs_offline_db hotcopy archive  
2013-05-20 11:15:01,291 __main__ INFO     ./mysqlhotcopy.py -l debug tmp_ligs_offline_db hotcopy archive
2013-05-20 11:15:01,294 __main__ INFO     backupdir /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db 
2013-05-20 11:15:01,311 __main__ INFO     db size in MB 3760.22 
2013-05-20 11:15:01,312 __main__ INFO     ================================== hotcopy 
2013-05-20 11:15:01,312 __main__ INFO     sufficient free space,      required 9400.55 MB less than    free 20069.015625 MB 
2013-05-20 11:15:01,312 __main__ INFO     hotcopy of database tmp_ligs_offline_db into outd /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130520_1115 
2013-05-20 11:15:01,333 __main__ INFO     proceed with MySQLHotCopy /usr/bin/mysqlhotcopy  tmp_ligs_offline_db /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130520_1115   
DBD::mysql::db do failed: Table './tmp_ligs_offline_db/DqChannelStatus' is marked as crashed and should be repaired at /usr/bin/mysqlhotcopy line 467.
2013-05-20 11:15:01,828 __main__ INFO     seconds {'_hotcopy': 0.51553797721862793} 
2013-05-20 11:15:01,828 __main__ INFO     ================================== archive 
2013-05-20 11:15:01,828 __main__ INFO     sufficient free space,      required 9400.55 MB less than    free 20069.0078125 MB 
2013-05-20 11:15:01,828 __main__ INFO     tagd /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130520_1115  into Tar /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130520_1115.tar.gz tmp_ligs_offline_db gz  
enter "YES" to confirm deletion of sourcedir /var/dbbackup/mysqlhotcopy/dybdb1.ihep.ac.cn/tmp_ligs_offline_db/20130520_1115 :YES
2013-05-20 11:15:42,169 __main__ INFO     seconds {'_hotcopy': 0.51553797721862793, 'archive': 40.34028697013855, '_archive': 40.340435981750488}</pre>
</div>
</div>
<div class="section" id="todo">
<h3>TODO:<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>tarball purging</li>
</ol>
</div>
</div>
<div class="sidebar">
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../locking/" title="Locking used by mysqlhotcopy"
             >next</a> |</li>
        <li class="right" >
          <a href="../" title="MySQL hotcopy"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>