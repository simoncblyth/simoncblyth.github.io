<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Repair Table &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="MySQL hotcopy" href="../" />
    <link rel="next" title="MySQL repair table live" href="../mysql_repair_table_live/" />
    <link rel="prev" title="Locking used by mysqlhotcopy" href="../locking/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../mysql_repair_table_live/" title="MySQL repair table live"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../locking/" title="Locking used by mysqlhotcopy"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">MySQL hotcopy</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../mysqlhotcopy/"><cite>mysqlhotcopy.py</cite> script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../locking/">Locking used by mysqlhotcopy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Repair Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql_repair_table_live/">MySQL repair table live</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lessons/">Lessons from MySQL corruption incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../steps/">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/mysqlhotcopy/mysql_repair_table.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../locking/"
                        title="previous chapter">Locking used by mysqlhotcopy</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../mysql_repair_table_live/"
                        title="next chapter">MySQL repair table live</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="repair-table">
<h1>Repair Table<a class="headerlink" href="#repair-table" title="Permalink to this headline">¶</a></h1>
<p>Explore corruption on belle7.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#references" id="id1">References</a></li>
<li><a class="reference internal" href="#mysql-versions-and-use-frm-option" id="id2">MySQL Versions and <cite>USE_FRM</cite> option</a></li>
<li><a class="reference internal" href="#repairs-and-replication" id="id3">Repairs and replication</a></li>
<li><a class="reference internal" href="#myisam-repairs" id="id4">MyISAM repairs</a></li>
<li><a class="reference internal" href="#following-sections-stage-3-difficult-repair-and-stage-2-easy-safe-repair" id="id5">Following sections <cite>Stage 3: Difficult repair</cite> and <cite>Stage 2: Easy safe repair</cite></a><ul>
<li><a class="reference internal" href="#move-myi-and-myd-into-keep" id="id6">move MYI and MYD into keep</a></li>
<li><a class="reference internal" href="#truncate-the-moved-table-recreating-a-1024-byte-myi-and-empty-myd" id="id7">truncate the moved table, recreating a 1024 byte MYI and empty MYD</a></li>
<li><a class="reference internal" href="#copy-the-myd-back-from-keep-ontop-of-the-empty-myd" id="id8">Copy the MYD back from keep ontop of the empty MYD</a></li>
<li><a class="reference internal" href="#repopulate-the-index-with-myisamchk-r-q" id="id9">Repopulate the index with <cite>myisamchk -r -q</cite></a></li>
<li><a class="reference internal" href="#check-the-table-survived-this-trauma" id="id10">Check the table survived this trauma</a></li>
</ul>
</li>
<li><a class="reference internal" href="#myisamcheck-memory" id="id11">myisamcheck memory</a></li>
<li><a class="reference internal" href="#create-a-throwaway-db" id="id12">Create a throwaway DB</a></li>
<li><a class="reference internal" href="#verify-accessible-before-being-detructive" id="id13">Verify accessible before being detructive</a></li>
<li><a class="reference internal" href="#be-destructive-delete-the-myi-index-file-for-a-table" id="id14">Be destructive, delete the MYI index file for a table</a></li>
<li><a class="reference internal" href="#repairing-the-damage" id="id15">Repairing the damage</a></li>
</ul>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#id1">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.google.com/search?q=mysql repair corruption">google:mysql repair corruption</a></li>
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/repair-table.html">http://dev.mysql.com/doc/refman/5.0/en/repair-table.html</a></li>
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.1/en/repair-table.html">http://dev.mysql.com/doc/refman/5.1/en/repair-table.html</a></li>
</ul>
</div>
<div class="section" id="mysql-versions-and-use-frm-option">
<h2><a class="toc-backref" href="#id2">MySQL Versions and <cite>USE_FRM</cite> option</a><a class="headerlink" href="#mysql-versions-and-use-frm-option" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>dybdb1.ihep.ac.cn        5.0.45-community-log MySQL Community Edition (GPL)
belle7.nuu.edu.tw        5.0.77-log Source distribution
cms01.phys.ntu.edu.tw    4.1.22-log</pre>
</div>
<p>From <a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/repair-table.html">http://dev.mysql.com/doc/refman/5.0/en/repair-table.html</a></p>
<p>As of MySQL 5.0.62, if you use <cite>USE_FRM</cite> for a table that was created by a
different version of the MySQL server than the one you are currently running,
REPAIR TABLE will not attempt to repair the table. In this case, the result set
returned by REPAIR TABLE contains a line with a <cite>Msg_type</cite> value of <cite>error</cite> and a
<cite>Msg_text</cite> value of <cite>Failed repairing incompatible .FRM file</cite>.</p>
<blockquote>
<div><ul class="simple">
<li>so on belle7 I cannot use <cite>USE_FRM</cite> to repair the table from dybdb1</li>
</ul>
</div></blockquote>
<p>Prior to MySQL 5.0.62, do not use <cite>USE_FRM</cite> if your table was created by a
different version of the MySQL server. Doing so risks the loss of all rows in
the table. It is particularly dangerous to use <cite>USE_FRM</cite> after the server returns
this message:</p>
<blockquote>
<div><ul class="simple">
<li>the tables appear have been created <cite>2013-02-04</cite> so seems no issue with version differences for dybdb1 repair using <cite>USE_FRM</cite></li>
</ul>
</div></blockquote>
<div class="highlight-python"><pre>mysql&gt; select table_name, table_type, engine, version, table_rows, data_length, max_data_length, index_length, data_free, create_time, update_time, check_time from information_schema.tables where table_schema = 'tmp_ligs_offline_db' ;
+-----------------------+------------+-----------+---------+------------+-------------+-------------------+--------------+-----------+---------------------+---------------------+---------------------+
| table_name            | table_type | engine    | version | table_rows | data_length | max_data_length   | index_length | data_free | create_time         | update_time         | check_time          |
+-----------------------+------------+-----------+---------+------------+-------------+-------------------+--------------+-----------+---------------------+---------------------+---------------------+
| ChannelQuality        | BASE TABLE | MyISAM    |      10 |    1745856 |    24441984 |  3940649673949183 |     25170944 |         0 | 2013-04-22 12:50:10 | 2013-04-22 23:32:27 | NULL                |
| ChannelQualityVld     | BASE TABLE | MyISAM    |      10 |       9093 |      463743 | 14355223812243455 |        96256 |         0 | 2013-04-22 12:50:10 | 2013-04-22 23:32:27 | NULL                |
| DaqRawDataFileInfo    | BASE TABLE | FEDERATED |      10 |     310821 |    70867188 |                 0 |            0 |         0 | NULL                | 1970-01-01 08:33:33 | NULL                |
| DaqRawDataFileInfoVld | BASE TABLE | FEDERATED |      10 |     310821 |    13986945 |                 0 |            0 |         0 | NULL                | 1970-01-01 08:33:33 | NULL                |
| DqChannel             | BASE TABLE | MyISAM    |      10 |   65489088 |  2750541696 | 11821949021847551 |   1015181312 |         0 | 2013-02-04 16:07:51 | 2013-05-20 06:26:54 | NULL                |
| DqChannelStatus       | BASE TABLE | NULL      |    NULL |       NULL |        NULL |              NULL |         NULL |      NULL | NULL                | NULL                | NULL                |
| DqChannelStatusVld    | BASE TABLE | MyISAM    |      10 |     341125 |    17397375 | 14355223812243455 |      3826688 |         0 | 2013-02-04 16:07:56 | 2013-05-20 06:26:55 | 2013-05-13 13:16:02 |
| DqChannelVld          | BASE TABLE | MyISAM    |      10 |     341089 |    17395539 | 14355223812243455 |      3606528 |         0 | 2013-02-04 16:07:51 | 2013-05-20 06:26:54 | NULL                |
| LOCALSEQNO            | BASE TABLE | MyISAM    |      10 |          4 |         276 | 19421773393035263 |         2048 |         0 | 2013-02-04 16:09:33 | 2013-05-20 06:26:54 | NULL                |
+-----------------------+------------+-----------+---------+------------+-------------+-------------------+--------------+-----------+---------------------+---------------------+---------------------+
9 rows in set (0.09 sec)</pre>
</div>
</div>
<div class="section" id="repairs-and-replication">
<h2><a class="toc-backref" href="#id3">Repairs and replication</a><a class="headerlink" href="#repairs-and-replication" title="Permalink to this headline">¶</a></h2>
<p>From <a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/repair-table.html">http://dev.mysql.com/doc/refman/5.0/en/repair-table.html</a></p>
<p>By default, the server writes <cite>REPAIR TABLE</cite> statements to the binary log so that
they replicate to replication slaves. To suppress logging, specify the optional
<cite>NO_WRITE_TO_BINLOG</cite> keyword or its alias <cite>LOCAL</cite>.</p>
<ul class="simple">
<li>this DB is skipped from replication, so presumably no problem BUT should perhaps use <cite>REPAIR LOCAL TABLE DqChannelStatus</cite></li>
</ul>
</div>
<div class="section" id="myisam-repairs">
<h2><a class="toc-backref" href="#id4">MyISAM repairs</a><a class="headerlink" href="#myisam-repairs" title="Permalink to this headline">¶</a></h2>
<p>From <a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html">http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html</a></p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# man myisamchk
[root@belle7 tmp_offline_db_ext]# myisamchk -vvv *.MYI
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Checking MyISAM file: DqChannelPacked.MYI
Data records:  323000   Deleted blocks:       0
- check file-size
- check record delete-chain
No recordlinks
- check key delete-chain
block_size 1024:
- check index reference
- check data record references index: 1

---------

Checking MyISAM file: DqChannelPackedVld.MYI
Data records:  323000   Deleted blocks:       0
- check file-size
- check record delete-chain
No recordlinks
- check key delete-chain
block_size 1024:
- check index reference
- check data record references index: 1
[root@belle7 tmp_offline_db_ext]#</pre>
</div>
</div>
<div class="section" id="following-sections-stage-3-difficult-repair-and-stage-2-easy-safe-repair">
<h2><a class="toc-backref" href="#id5">Following sections <cite>Stage 3: Difficult repair</cite> and <cite>Stage 2: Easy safe repair</cite></a><a class="headerlink" href="#following-sections-stage-3-difficult-repair-and-stage-2-easy-safe-repair" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html">http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html</a></li>
</ul>
<div class="section" id="move-myi-and-myd-into-keep">
<h3><a class="toc-backref" href="#id6">move MYI and MYD into keep</a><a class="headerlink" href="#move-myi-and-myd-into-keep" title="Permalink to this headline">¶</a></h3>
<p>Simulate a missing MYI:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# mkdir ../tmp_offline_db_ext_keep
[root@belle7 tmp_offline_db_ext]# mv DqChannelPacked.MYI DqChannelPacked.MYD ../tmp_offline_db_ext_keep
[root@belle7 tmp_offline_db_ext]# ll  ../tmp_offline_db_ext_keep
total 19072
-rw-rw----  1 mysql mysql 14858000 May 21 13:43 DqChannelPacked.MYD
-rw-rw----  1 mysql mysql  4621312 May 21 13:46 DqChannelPacked.MYI
drwxr-xr-x 41 mysql mysql     4096 May 22 18:56 ..
drwxr-xr-x  2 root  root      4096 May 22 18:57 .</pre>
</div>
</div>
<div class="section" id="truncate-the-moved-table-recreating-a-1024-byte-myi-and-empty-myd">
<h3><a class="toc-backref" href="#id7">truncate the moved table, recreating a 1024 byte MYI and empty MYD</a><a class="headerlink" href="#truncate-the-moved-table-recreating-a-1024-byte-myi-and-empty-myd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>mysql&gt; show tables ;
+------------------------------+
| Tables_in_tmp_offline_db_ext |
+------------------------------+
| DqChannelPacked              |
| DqChannelPackedVld           |
+------------------------------+
2 rows in set (0.00 sec)

mysql&gt; SET autocommit=1;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; truncate table DqChannelPacked  ;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; quit
Bye</pre>
</div>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# ll
total 19392
-rw-rw----  1 mysql mysql     8908 May 10 18:18 DqChannelPackedVld.frm
-rw-rw----  1 mysql mysql     8896 May 10 18:18 DqChannelPacked.frm
-rw-rw----  1 mysql mysql 16473000 May 11 20:18 DqChannelPackedVld.MYD
-rw-rw----  1 mysql mysql  3314688 May 14 15:04 DqChannelPackedVld.MYI
drwxr-xr-x 41 mysql mysql     4096 May 22 18:56 ..
-rw-rw----  1 mysql mysql     1024 May 22 18:59 DqChannelPacked.MYI
-rw-rw----  1 mysql mysql        0 May 22 18:59 DqChannelPacked.MYD
drwxr-x---  2 mysql mysql     4096 May 22 18:59 .</pre>
</div>
</div>
<div class="section" id="copy-the-myd-back-from-keep-ontop-of-the-empty-myd">
<h3><a class="toc-backref" href="#id8">Copy the MYD back from keep ontop of the empty MYD</a><a class="headerlink" href="#copy-the-myd-back-from-keep-ontop-of-the-empty-myd" title="Permalink to this headline">¶</a></h3>
<p>Copy the old data file back onto the newly created data file. (Do not just move
the old file back onto the new file. You want to retain a copy in case
something goes wrong.)</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# cp ../tmp_offline_db_ext_keep/DqChannelPacked.MYD .
cp: overwrite `./DqChannelPacked.MYD'? y

[root@belle7 tmp_offline_db_ext]# ll
total 33924
-rw-rw----  1 mysql mysql     8908 May 10 18:18 DqChannelPackedVld.frm
-rw-rw----  1 mysql mysql     8896 May 10 18:18 DqChannelPacked.frm
-rw-rw----  1 mysql mysql 16473000 May 11 20:18 DqChannelPackedVld.MYD
-rw-rw----  1 mysql mysql  3314688 May 14 15:04 DqChannelPackedVld.MYI
drwxr-xr-x 41 mysql mysql     4096 May 22 18:56 ..
-rw-rw----  1 mysql mysql     1024 May 22 18:59 DqChannelPacked.MYI
drwxr-x---  2 mysql mysql     4096 May 22 18:59 .
-rw-rw----  1 mysql mysql 14858000 May 22 19:06 DqChannelPacked.MYD</pre>
</div>
<p>The result so far is a drastically shrunk MYI.</p>
</div>
<div class="section" id="repopulate-the-index-with-myisamchk-r-q">
<h3><a class="toc-backref" href="#id9">Repopulate the index with <cite>myisamchk -r -q</cite></a><a class="headerlink" href="#repopulate-the-index-with-myisamchk-r-q" title="Permalink to this headline">¶</a></h3>
<p>From <cite>Stage 2: Easy safe repair</cite> of <a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html">http://dev.mysql.com/doc/refman/5.0/en/myisam-repair.html</a></p>
<p>This attempts to repair the index file without touching the data file. If the
data file contains everything that it should and the delete links point at the
correct locations within the data file, this should work, and the table is
fixed.</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# myisamchk -r -q DqChannelPacked
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
- check record delete-chain
- recovering (with sort) MyISAM-table 'DqChannelPacked'
Data records: 0
- Fixing index 1
Data records: 323000
[root@belle7 tmp_offline_db_ext]#</pre>
</div>
<p>Those warnings are a know bug <a class="reference external" href="http://bugs.mysql.com/bug.php?id=33785">http://bugs.mysql.com/bug.php?id=33785</a>  reported for 5.0.54 fixed in 5.0 series at 5.0.87
The values adjusted to are 4G:</p>
<div class="highlight-python"><pre>In [86]: ( 1 &lt;&lt; 32 ) - 1
Out[86]: 4294967295L

In [21]: (4294967295+1)/1024/1024/1024
Out[21]: 4L</pre>
</div>
<p>From <cite>Stage 2: Easy safe repair</cite></p>
<p>If you want a repair operation to go much faster, you should set the values of
the <cite>sort_buffer_size</cite> and <cite>key_buffer_size</cite> variables each to about 25% of your
available memory when running myisamchk.</p>
<p>Unfortunately I do not have 16G of memory, so potentially a repair will run out of memory with these settings.</p>
<p>After that succeed to create MYI of precisely the prior size, but different content:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# ll DqChannelPacked.MYI ../tmp_offline_db_ext_keep/DqChannelPacked.MYI
-rw-rw---- 1 mysql mysql 4621312 May 21 13:46 ../tmp_offline_db_ext_keep/DqChannelPacked.MYI
-rw-rw---- 1 mysql mysql 4621312 May 22 19:08 DqChannelPacked.MYI
[root@belle7 tmp_offline_db_ext]#
[root@belle7 tmp_offline_db_ext]# diff -b  DqChannelPacked.MYI ../tmp_offline_db_ext_keep/DqChannelPacked.MYI
Binary files DqChannelPacked.MYI and ../tmp_offline_db_ext_keep/DqChannelPacked.MYI differ
[root@belle7 tmp_offline_db_ext]#</pre>
</div>
<p>Hexdump comparison:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# xxd -c 64 DqChannelPacked.MYI &gt; /tmp/s/DqChannelPacked_MYI_recreated.xxd
[root@belle7 tmp_offline_db_ext]# xxd -c 64 ../tmp_offline_db_ext_keep/DqChannelPacked.MYI &gt; /tmp/s/DqChannelPacked_MYI_original.xxd</pre>
</div>
<p>Shows differences only within first 4 lines of the dump (256 bytes of the MYI). Just header differences perhaps:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# diff  /tmp/s/DqChannelPacked_MYI_original.xxd /tmp/s/DqChannelPacked_MYI_recreated.xxd
1,4c1,4
&lt; 0000000: fefe 0701 0000 01b0 00b0 0064 00c8 0002 0000 0100 0801 0000 0000 20ff 0000 0000 0004 edb8 0000 0000 0000 0000 0000 0000 0004 edb8 ffff ffff ffff ffff 0000 0000  ...........d.............. .....................................
&lt; 0000040: 0046 8400 0000 0000 00e2 b710 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 ef79 cdce 0000 615b 0000 0011 0000 0000 0000 0001 0000 0000  .F.......................................y....a[................
&lt; 0000080: 0046 8000 ffff ffff ffff ffff 0000 0000 0000 0000 519b 0976 0000 0000 0000 0001 0000 0000 519b 0975 0000 0000 0000 0000 0000 0000 519b 0a20 0000 0000 0004 edb8  .F..................Q..v............Q..u............Q.. ........
&lt; 00000c0: 0000 0001 0000 0001 0000 0000 0000 0400 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 002e 0000 002e 0000 002e  ................................................................
---
&gt; 0000000: fefe 0701 0000 01b0 00b0 0064 00c8 0002 0000 0100 0801 0000 0000 28ff 0000 0000 0004 edb8 0000 0000 0000 0000 0000 0000 0004 edb8 ffff ffff ffff ffff 0000 0000  ...........d..............(.....................................
&gt; 0000040: 0046 8400 0000 0000 00e2 b710 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1a2b 0000 0004 0000 0000 0000 0001 0000 0000  .F.............................................+................
&gt; 0000080: 0046 8000 ffff ffff ffff ffff 0000 0000 0000 0000 519c a52f 0000 0000 0000 0001 0000 0000 519c a52f 0000 0000 0000 0000 0000 0000 519c a74b 0000 0000 0004 edb8  .F..................Q../............Q../............Q..K........
&gt; 00000c0: 0000 0000 0000 0000 0000 0000 0000 0400 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 002e 0000 002e 0000 002e  ................................................................</pre>
</div>
</div>
<div class="section" id="check-the-table-survived-this-trauma">
<h3><a class="toc-backref" href="#id10">Check the table survived this trauma</a><a class="headerlink" href="#check-the-table-survived-this-trauma" title="Permalink to this headline">¶</a></h3>
<p>Seems so:</p>
<div class="highlight-python"><pre>mysql&gt; show tables ;
+------------------------------+
| Tables_in_tmp_offline_db_ext |
+------------------------------+
| DqChannelPacked              |
| DqChannelPackedVld           |
+------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select count(*) from DqChannelPacked   ;
+----------+
| count(*) |
+----------+
|   323000 |
+----------+
1 row in set (0.00 sec)

mysql&gt; select * from DqChannelPacked where SEQNO=101010 ;
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
| SEQNO  | ROW_COUNTER | RUNNO | FILENO | MASK0      | MASK1      | MASK2      | MASK3      | MASK4      | MASK5      | MASK6 |
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
| 101010 |           1 | 21520 |    245 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 |    63 |
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
1 row in set (0.00 sec)</pre>
</div>
</div>
</div>
<div class="section" id="myisamcheck-memory">
<h2><a class="toc-backref" href="#id11">myisamcheck memory</a><a class="headerlink" href="#myisamcheck-memory" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/myisamchk-memory.html">http://dev.mysql.com/doc/refman/5.0/en/myisamchk-memory.html</a></li>
</ul>
<p>On N have 4G of memory, so need to restrict to 1G:</p>
<div class="highlight-python"><pre>[blyth@belle7 ~]$ free -m
             total       used       free     shared    buffers     cached
Mem:          4052       1639       2412          0        576        684
-/+ buffers/cache:        378       3673
Swap:         1983          0       1983</pre>
</div>
<div class="highlight-python"><pre>myisamchk --sort_buffer_size=256M --key_buffer_size=512M --read_buffer_size=64M --write_buffer_size=64M       # suggestion for 512MB available
myisamchk --sort_buffer_size=512M --key_buffer_size=1024M --read_buffer_size=128M --write_buffer_size=128M     # suggestion for 512MB available doubled</pre>
</div>
<p>No speed difference, but maybe as nothing to fix:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# time myisamchk --sort_buffer_size=512M --key_buffer_size=1024M --read_buffer_size=128M --write_buffer_size=128M    -r -q DqChannelPacked
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
- check record delete-chain
- recovering (with sort) MyISAM-table 'DqChannelPacked'
Data records: 323000
- Fixing index 1

real    0m0.291s
user    0m0.235s
sys     0m0.050s

[root@belle7 tmp_offline_db_ext]# time myisamchk  -r -q DqChannelPacked
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
- check record delete-chain
- recovering (with sort) MyISAM-table 'DqChannelPacked'
Data records: 323000
- Fixing index 1

real    0m0.290s
user    0m0.242s
sys     0m0.048s</pre>
</div>
<p>Help variable dumping suggests it gets the message despite the warnings:</p>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# myisamchk --help | grep size
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
key_buffer_size                   520192
key_cache_block_size              1024
myisam_block_size                 1024
read_buffer_size                  262136
write_buffer_size                 262136
sort_buffer_size                  2097144
[root@belle7 tmp_offline_db_ext]#
[root@belle7 tmp_offline_db_ext]#
[root@belle7 tmp_offline_db_ext]# myisamchk --sort_buffer_size=512M --key_buffer_size=1024M --read_buffer_size=128M --write_buffer_size=128M  | grep size
Warning: option 'key_buffer_size': unsigned value 18446744073709551615 adjusted to 4294963200
Warning: option 'read_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'write_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
Warning: option 'sort_buffer_size': unsigned value 18446744073709551615 adjusted to 4294967295
key_buffer_size                   1073741824
key_cache_block_size              1024
myisam_block_size                 1024
read_buffer_size                  134217728
write_buffer_size                 134217728
sort_buffer_size                  536870912
[root@belle7 tmp_offline_db_ext]#</pre>
</div>
</div>
<div class="section" id="create-a-throwaway-db">
<h2><a class="toc-backref" href="#id12">Create a throwaway DB</a><a class="headerlink" href="#create-a-throwaway-db" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>mysqlhotcopy.py --regex "^DqChannelPacked"  -l debug --ALLOWEXTRACT --flattop -C --rename tmp_offline_db_ext tmp_offline_db coldcopy archive examine extract</pre>
</div>
</div>
<div class="section" id="verify-accessible-before-being-detructive">
<h2><a class="toc-backref" href="#id13">Verify accessible before being detructive</a><a class="headerlink" href="#verify-accessible-before-being-detructive" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>mysql&gt; use  tmp_offline_db_ext
Database changed
mysql&gt; show tables ;
+------------------------------+
| Tables_in_tmp_offline_db_ext |
+------------------------------+
| DqChannelPacked              |
| DqChannelPackedVld           |
+------------------------------+
2 rows in set (0.00 sec)

mysql&gt; select count(*) from DqChannelPacked ;
+----------+
| count(*) |
+----------+
|   323000 |
+----------+
1 row in set (0.00 sec)

mysql&gt; select count(*) from DqChannelPackedVld ;
+----------+
| count(*) |
+----------+
|   323000 |
+----------+
1 row in set (0.00 sec)

mysql&gt; select * from DqChannelPackedVld order by SEQNO desc limit 5 ;
+--------+---------------------+---------------------+----------+---------+---------+------+-------------+---------------------+---------------------+
| SEQNO  | TIMESTART           | TIMEEND             | SITEMASK | SIMMASK | SUBSITE | TASK | AGGREGATENO | VERSIONDATE         | INSERTDATE          |
+--------+---------------------+---------------------+----------+---------+---------+------+-------------+---------------------+---------------------+
| 323000 | 2013-04-27 23:07:43 | 2013-04-27 23:29:31 |        4 |       1 |       2 |    0 |          -1 | 2013-04-27 23:07:43 | 2013-05-11 12:18:46 |
| 322999 | 2013-04-27 23:07:43 | 2013-04-27 23:29:31 |        4 |       1 |       4 |    0 |          -1 | 2013-04-27 23:07:43 | 2013-05-11 12:18:45 |
| 322998 | 2013-04-27 23:44:38 | 2013-04-27 23:54:30 |        1 |       1 |       1 |    0 |          -1 | 2013-04-27 23:44:38 | 2013-05-11 12:18:45 |
| 322997 | 2013-04-27 23:44:38 | 2013-04-27 23:54:30 |        1 |       1 |       2 |    0 |          -1 | 2013-04-27 23:44:38 | 2013-05-11 12:18:44 |
| 322996 | 2013-04-28 00:10:09 | 2013-04-28 00:22:35 |        2 |       1 |       1 |    0 |          -1 | 2013-04-28 00:10:09 | 2013-05-11 12:18:44 |
+--------+---------------------+---------------------+----------+---------+---------+------+-------------+---------------------+---------------------+
5 rows in set (0.00 sec)

mysql&gt; select * from DqChannelPacked order by SEQNO desc limit 5 ;
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
| SEQNO  | ROW_COUNTER | RUNNO | FILENO | MASK0      | MASK1      | MASK2      | MASK3      | MASK4      | MASK5      | MASK6 |
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
| 323000 |           1 | 38878 |    115 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 |    63 |
| 322999 |           1 | 38878 |    115 | 2147483647 | 2147483647 | 2139095039 | 2147483647 | 2147483647 | 2147483647 |    63 |
| 322998 |           1 | 38886 |    229 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 |    63 |
| 322997 |           1 | 38886 |    229 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 |    63 |
| 322996 |           1 | 38860 |    198 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 | 2147483647 |    63 |
+--------+-------------+-------+--------+------------+------------+------------+------------+------------+------------+-------+
5 rows in set (0.00 sec)</pre>
</div>
</div>
<div class="section" id="be-destructive-delete-the-myi-index-file-for-a-table">
<h2><a class="toc-backref" href="#id14">Be destructive, delete the MYI index file for a table</a><a class="headerlink" href="#be-destructive-delete-the-myi-index-file-for-a-table" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[root@belle7 tmp_offline_db_ext]# pwd
/var/lib/mysql/tmp_offline_db_ext
[root@belle7 tmp_offline_db_ext]# ll
total 38484
-rw-rw----  1 mysql mysql     8908 May 10 18:18 DqChannelPackedVld.frm
-rw-rw----  1 mysql mysql     8896 May 10 18:18 DqChannelPacked.frm
-rw-rw----  1 mysql mysql 16473000 May 11 20:18 DqChannelPackedVld.MYD
-rw-rw----  1 mysql mysql 14858000 May 11 20:18 DqChannelPacked.MYD
-rw-rw----  1 mysql mysql  4658176 May 13 13:08 DqChannelPacked.MYI
-rw-rw----  1 mysql mysql  3314688 May 14 15:04 DqChannelPackedVld.MYI
drwxr-x---  2 mysql mysql     4096 May 16 17:11 .
drwxr-xr-x 40 mysql mysql     4096 May 20 19:54 ..
[root@belle7 tmp_offline_db_ext]# rm DqChannelPacked.MYI
rm: remove regular file `DqChannelPacked.MYI'? y
[root@belle7 tmp_offline_db_ext]#</pre>
</div>
</div>
<div class="section" id="repairing-the-damage">
<h2><a class="toc-backref" href="#id15">Repairing the damage</a><a class="headerlink" href="#repairing-the-damage" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.google.com/search?q=repair mysql corruption">google:repair mysql corruption</a></li>
<li><a class="reference external" href="http://www.databasejournal.com/features/mysql/article.php/10897_3300511_2/Repairing-Database-Corruption-in-MySQL.htm">http://www.databasejournal.com/features/mysql/article.php/10897_3300511_2/Repairing-Database-Corruption-in-MySQL.htm</a></li>
</ul>
<p>Appears to work OK for a while (memory cache ?) then after flushing:</p>
<div class="highlight-python"><pre>mysql&gt; flush tables ;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; select count(*) from DqChannelPacked    ;
ERROR 1017 (HY000): Can't find file: 'DqChannelPacked' (errno: 2)</pre>
</div>
<p>Check table repeats that error and repair table fails to clear it:</p>
<div class="highlight-python"><pre>mysql&gt; check table  DqChannelPacked    ;
+------------------------------------+-------+----------+-----------------------------------------------+
| Table                              | Op    | Msg_type | Msg_text                                      |
+------------------------------------+-------+----------+-----------------------------------------------+
| tmp_offline_db_ext.DqChannelPacked | check | Error    | Can't find file: 'DqChannelPacked' (errno: 2) |
| tmp_offline_db_ext.DqChannelPacked | check | error    | Corrupt                                       |
+------------------------------------+-------+----------+-----------------------------------------------+
2 rows in set (0.00 sec)

mysql&gt; REPAIR TABLE DqChannelPacked    ;
+------------------------------------+--------+----------+-----------------------------------------------+
| Table                              | Op     | Msg_type | Msg_text                                      |
+------------------------------------+--------+----------+-----------------------------------------------+
| tmp_offline_db_ext.DqChannelPacked | repair | Error    | Can't find file: 'DqChannelPacked' (errno: 2) |
| tmp_offline_db_ext.DqChannelPacked | repair | error    | Corrupt                                       |
+------------------------------------+--------+----------+-----------------------------------------------+
2 rows in set (0.00 sec)

mysql&gt;
mysql&gt; check table  DqChannelPacked    ;
+------------------------------------+-------+----------+-----------------------------------------------+
| Table                              | Op    | Msg_type | Msg_text                                      |
+------------------------------------+-------+----------+-----------------------------------------------+
| tmp_offline_db_ext.DqChannelPacked | check | Error    | Can't find file: 'DqChannelPacked' (errno: 2) |
| tmp_offline_db_ext.DqChannelPacked | check | error    | Corrupt                                       |
+------------------------------------+-------+----------+-----------------------------------------------+
2 rows in set (0.00 sec)</pre>
</div>
<p>With the <cite>USE_FRM</cite> succeed to repair the table, which recreated the MYI index that I deleted.
Ordinarily <cite>USE_FRM</cite> is not advised unless the other repair techniques fail, see <a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/repair-table.html">http://dev.mysql.com/doc/refman/5.0/en/repair-table.html</a></p>
<div class="highlight-python"><pre>mysql&gt; REPAIR TABLE  DqChannelPacked USE_FRM ;
+------------------------------------+--------+----------+-----------------------------------------+
| Table                              | Op     | Msg_type | Msg_text                                |
+------------------------------------+--------+----------+-----------------------------------------+
| tmp_offline_db_ext.DqChannelPacked | repair | warning  | Number of rows changed from 0 to 323000 |
| tmp_offline_db_ext.DqChannelPacked | repair | status   | OK                                      |
+------------------------------------+--------+----------+-----------------------------------------+
2 rows in set (0.42 sec)

mysql&gt; check table DqChannelPacked ;
+------------------------------------+-------+----------+----------+
| Table                              | Op    | Msg_type | Msg_text |
+------------------------------------+-------+----------+----------+
| tmp_offline_db_ext.DqChannelPacked | check | status   | OK       |
+------------------------------------+-------+----------+----------+
1 row in set (0.14 sec)</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../mysql_repair_table_live/" title="MySQL repair table live"
             >next</a> |</li>
        <li class="right" >
          <a href="../locking/" title="Locking used by mysqlhotcopy"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >MySQL hotcopy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>