<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Value Monitoring &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="DB scripts" href="../" />
    <link rel="next" title="SQLite3" href="../sqlite3/" />
    <link rel="prev" title="DB scripts" href="../" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../sqlite3/" title="SQLite3"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../" title="DB scripts"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">DB scripts</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">DB scripts</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">Value Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sqlite3/">SQLite3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bdbxml/qxml/">QXML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chroma/">chroma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/db/valmon.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../"
                        title="previous chapter">DB scripts</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../sqlite3/"
                        title="next chapter">SQLite3</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-env.db.valmon">
<span id="value-monitoring"></span><h1>Value Monitoring<a class="headerlink" href="#module-env.db.valmon" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>Value Monitoring<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Keeping this operational with ancient python23 is advantageous</p>
</div>
<p>Simple monitoring and recording the output of commands that 
return a single value or a dict string. 
The results are stored with a timestamp in a sqlite DB</p>
<p>Usage with <cite>diskmon</cite> section is shown below. 
The section must correspond to a section name in the config file, which defaults to <tt class="file docutils literal"><span class="pre">~/.env.cnf</span></tt>:</p>
<div class="highlight-python"><pre>valmon.py -s diskmon rec rep mon </pre>
</div>
<p>Usage from cron:</p>
<div class="highlight-python"><pre>52 * * * * ( valmon.py -s diskmon rec rep mon ) &gt; $CRONLOG_DIR/diskmon.log 2&gt;&amp;1 </pre>
</div>
<div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>Usage of the <cite>valmon.py</cite> script and the <strong>env</strong> python modules that 
it is based upon requires these to be installed as described at <a class="reference internal" href="../../install/"><em>Installing env</em></a>.
Essentially this just requires a symbolic link from python <cite>site-packages</cite> and 
a PATH setting to give easy access to scripts from eg <cite>/root/env/bin</cite></p>
</div>
<div class="section" id="separation-of-concerns">
<h3>Separation of concerns<a class="headerlink" href="#separation-of-concerns" title="Permalink to this headline">¶</a></h3>
<p>The value monitoring in <cite>valmon.py</cite> is kept generic, with all the specifics 
of obtaining the values handled within the command called and choosing constraints 
to apply to them within the config.</p>
<p>For example the <cite>diskmon</cite> section uses the <cite>disk_usage.py</cite> script which returns a dict string:</p>
<div class="highlight-python"><pre>[blyth@cms01 e]$ disk_usage.py 
{'gb_total': '131.74', 'gb_free': '24.90', 'percent_free': '18.90', 'percent_used': '76.02'}</pre>
</div>
<p>Other sections like <cite>oomon</cite> monitors the single integer returned by the below command:</p>
<div class="highlight-python"><pre>[root@cms02 ~]# grep oom /var/log/messages | wc -l 
0 </pre>
</div>
<p>This approach allows the value monitoring and persistence framework to be reused for
monitoring any quantity which commands or scripts can be written to obtain.</p>
</div>
<div class="section" id="command-arguments">
<h3>Command arguments<a class="headerlink" href="#command-arguments" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><cite>rec</cite></dt>
<dd>record status into the SQLite DB, but running the configured command and storing results</dd>
<dt><cite>mon</cite> </dt>
<dd>check if the last entry in the DB table conforms to the expectations, if not set notification email</dd>
<dt><cite>rep</cite></dt>
<dd>status report based on the DB entries</dd>
<dt><cite>msg</cite></dt>
<dd>show what the notification email and subject would be without sending email, 
a blank msg indicates that no email would be sent</dd>
<dt><cite>ls</cite></dt>
<dd>a simple query against the table for the configured section, for debugging</dd>
</dl>
</div>
<div class="section" id="schema-versions">
<h3>Schema Versions<a class="headerlink" href="#schema-versions" title="Permalink to this headline">¶</a></h3>
<p>The variables available in context which may be constrained correspond to the 
fields in the table.  These have changed through various versions.</p>
<dl class="docutils">
<dt><cite>0.1</cite></dt>
<dd><cite>date</cite>, <cite>val</cite></dd>
<dt><cite>0.2</cite></dt>
<dd><cite>date</cite>, <cite>val</cite>, <cite>runtime</cite>, <cite>rc</cite>, <cite>ret</cite></dd>
</dl>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>The command to run and the constraints applied to what it returns 
are obtained from config.  This approach is taken to allow most typical 
changes of varying constraints to be done via configuration only.</p>
<p>Examples:</p>
<div class="highlight-python"><pre>[oomon]

note = despite notification being enabled this failed to notify me, apparently the C2 OOM issue made the machine incapable of sending email ?
cmd = grep oom /var/log/messages | wc -l  
return = int
constraints = ( val == 0, )
dbpath = ~/.env/oomon.sqlite
tn = oomon

[diskmon]

note = stores the dict returned by the command as a string in the DB without interpretation
cmd = disk_usage.py /data
valmon_version = 0.2 
return = dict
constraints = ( gb_free &gt; 10, )
dbpath = ~/.env/envmon.sqlite
tn = diskmon

[sshagent_mon]

note = require an sshagent process is running by constraining the return code from the pgrep command 
valmon_version = 0.2
email = blyth@hep1.phys.ntu.edu.tw
cmd = pgrep ssh-agent 
return = int 
constraints = ( rc == 0, )
dbpath = ~/.env/sshagent_mon.sqlite
tn = sshagent_mon

[dbsrvmon]

note = currently set to fail via age
chdir = /var/dbbackup/dbsrv/belle7.nuu.edu.tw/channelquality_db_belle7/archive/10000
cmd = digestpath.py 
valmon_version = 0.2 
return = dict
constraints = ( tarball_count &gt;= 34, dna_mismatch == 0, age &lt; 86400 , age &lt; 1000, )
dbpath = ~/.env/dbsrvmon.sqlite
tn = channelquality_db


[envmon]

note = check C2 server from cron on other nodes
hostport = dayabay.phys.ntu.edu.tw
# from N need to get to C2 via nginx reverse proxy on H
#hostport = hfag.phys.ntu.edu.tw:90  
cmd = curl -s --connect-timeout 3 http://%(hostport)s/repos/env/ | grep trunk | wc -l
return = int
constraints = ( val == 1, )
instruction = require a single trunk to be found, verifying that the apache interface to SVN is working 
observations = may 16, 2013 observing variable response times that triggering notifications with a 3s timeout    
dbpath = ~/.env/envmon.sqlite
tn = envmon

[envmon_demo]

note = check C2 server from cron on C, 
cmd = curl -s --connect-timeout 3 http://dayabay.phys.ntu.edu.tw/repos/env/ | grep trunk | wc -l
return = int
valmin = -100
valmax = 100 
constraints = ( val == 1 and val &lt; valmax, val &gt; valmin , val &lt; valmax )
instruction = 
    the simple python `constraints` expression is evaluated within the scope of 
    the section config values (with things that can be coerced to floats so coerced)
    the constraint needs to evaluate to a tuple of one or more bools. 
    To specify a one element tuple a trailing comma is needed, eg "( val &gt; valmin, )"

dbpath = ~/.env/envmon.sqlite
tn = envmon</pre>
</div>
<div class="section" id="source-python-cron">
<h4>Source python cron<a class="headerlink" href="#source-python-cron" title="Permalink to this headline">¶</a></h4>
<p>When forced to use source rather than system python 2.3 on C2 had to 
setup the cron environment accordingly:</p>
<div class="highlight-python"><pre>SHELL=/bin/bash
HOME=/home/blyth
ENV_HOME=/home/blyth/env
CRONLOG_DIR=/home/blyth/cronlog
PATH=/home/blyth/env/bin:/data/env/system/python/Python-2.5.1/bin:/usr/bin:/bin
LD_LIBRARY_PATH=/data/env/system/python/Python-2.5.1/lib
42 * * * * * ( valmon.py -s envmon rec rep mon ) &gt; $CRONLOG_DIR/envmon.log 2&gt;&amp;1 </pre>
</div>
<p>Avoided this complication by <cite>yum install python-sqlite2</cite>, see simtab for notes on this.</p>
</div>
</div>
</div>
<div class="sidebar">
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../sqlite3/" title="SQLite3"
             >next</a> |</li>
        <li class="right" >
          <a href="../" title="DB scripts"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >DB scripts</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>