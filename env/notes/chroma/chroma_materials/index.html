<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chroma Materials &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../" />
    <link rel="up" title="chroma" href="../" />
    <link rel="next" title="Photon Propagation" href="../chroma_propagate/" />
    <link rel="prev" title="Chroma Geometry Source Overview" href="../chroma_geometry/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../chroma_propagate/" title="Photon Propagation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../chroma_geometry/" title="Chroma Geometry Source Overview"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" accesskey="U">chroma</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">chroma</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../chroma_issues/">Chroma Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma/">CHROMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_chroma_works/">How Chroma Works ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/">Chroma Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../refs/">Chroma Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_prerequisites/">Chroma Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_geant4_integration/">Chroma Geant4 Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_nuwa_geant4_integration/">Chroma/NuWa/Geant4 Integration with ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_nuwa_integration/">Chroma NuWa Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_cuda_photon/">Chroma CUDA Photon handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_collada/">Chroma COLLADA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_pycuda/">Getting to know how Chroma uses PyCUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_geometry/">Chroma Geometry Source Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Chroma Materials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_propagate/">Photon Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_physics/">Chroma Physics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_detector/">Chroma Modeling of Sensitive Detectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_server/">Chroma Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_zeromq/">Chroma ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_camera/">chroma_camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_sim/">chroma_sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_cuda_freeze/">Chroma CUDA Freeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_cuda/">Chroma CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_visualisation/">Chroma Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geant4_background/">Geant4 Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_background/">Cuda Threads and Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bvh_background/">Bounding Volume Hierarchy (BVH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware/">Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_install/">install issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chroma_tests/">tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ChromaZMQRootTest/">ChromaZMQRootTest</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/chroma/chroma_materials.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../chroma_geometry/"
                        title="previous chapter">Chroma Geometry Source Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../chroma_propagate/"
                        title="next chapter">Photon Propagation</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chroma-materials">
<h1>Chroma Materials<a class="headerlink" href="#chroma-materials" title="Permalink to this headline">¶</a></h1>
<div class="section" id="material-handling-in-chroma">
<h2>Material handling in Chroma<a class="headerlink" href="#material-handling-in-chroma" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ grep -l material *.py
detector.py   # passing mention, hands parameter to Geometry subclass of Detector
sim.py        # passing mention, hands detector.detector_material to G4ParallelGenerator
pmt.py        # pmt Solid construction using material arguments to build funcs
geometry.py   # implementation of Solid and Material</pre>
</div>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ find . -name '*.py' -exec grep -l material {} \;
./demo/optics.py
./demo/pmt.py
./detector.py
./generator/g4gen.py    # using Material to create G4Material instances, for photon generation within the material
./generator/photon.py
./geometry.py
./gpu/geometry.py
./pmt.py
./sim.py</pre>
</div>
</div>
<div class="section" id="chroma-geometry-py">
<h2>chroma/geometry.py<a class="headerlink" href="#chroma-geometry-py" title="Permalink to this headline">¶</a></h2>
<div class="section" id="solid">
<h3>Solid<a class="headerlink" href="#solid" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>constant or iterator inner/outer material parameters</li>
</ul>
</div>
<div class="section" id="material">
<h3>Material<a class="headerlink" href="#material" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>constant or over standard wavelengths properties</li>
</ul>
<div class="highlight-python"><pre>015 # all material/surface properties are interpolated at these
016 # wavelengths when they are sent to the gpu
017 standard_wavelengths = np.arange(60, 810, 20).astype(np.float32)
...
200 class Material(object):
201     """Material optical properties."""
202     def __init__(self, name='none'):
203         self.name = name
204
205         self.refractive_index = None
206         self.absorption_length = None
207         self.scattering_length = None
208         self.set('reemission_prob', 0)
209         self.set('reemission_cdf', 0)
210         self.density = 0.0 # g/cm^3
211         self.composition = {} # by mass
212
213     def set(self, name, value, wavelengths=standard_wavelengths):
214         if np.iterable(value):
215             if len(value) != len(wavelengths):
216                 raise ValueError('shape mismatch')
217         else:
218             value = np.tile(value, len(wavelengths))
219
220         self.__dict__[name] = np.array(zip(wavelengths, value), dtype=np.float32)
221
222 # Empty material
223 vacuum = Material('vacuum')
224 vacuum.set('refractive_index', 1.0)
225 vacuum.set('absorption_length', 1e6)
226 vacuum.set('scattering_length', 1e6)</pre>
</div>
</div>
<div class="section" id="surface">
<h3>Surface<a class="headerlink" href="#surface" title="Permalink to this headline">¶</a></h3>
<p>Wavelength dependent surface properties handled similarly:</p>
<div class="highlight-python"><pre>229 class Surface(object):
230     """Surface optical properties."""
231     def __init__(self, name='none', model=0):
232         self.name = name
233         self.model = model
234
235         self.set('detect', 0)
236         self.set('absorb', 0)
237         self.set('reemit', 0)
238         self.set('reflect_diffuse', 0)
239         self.set('reflect_specular', 0)
240         self.set('eta', 0)
241         self.set('k', 0)
242         self.set('reemission_cdf', 0)
243
244         self.thickness = 0.0
245         self.transmissive = 0</pre>
</div>
</div>
</div>
<div class="section" id="chroma-gpu-geometry-py">
<h2>chroma/gpu/geometry.py<a class="headerlink" href="#chroma-gpu-geometry-py" title="Permalink to this headline">¶</a></h2>
<p>Material properties passed over to GPU side</p>
<ol class="arabic simple">
<li>refractive_index</li>
<li>absorption_length</li>
<li>scattering_length</li>
<li>reemission_prob</li>
<li>reemission_cdf</li>
</ol>
<p>Looks like (from chroma/sim.py) have just one GPUGeometry.</p>
<div class="highlight-python"><pre>13 class GPUGeometry(object):
14     def __init__(self, geometry, wavelengths=None, print_usage=False, min_free_gpu_mem=300e6):
15         if wavelengths is None:
16             wavelengths = standard_wavelengths
17
18         try:
19             wavelength_step = np.unique(np.diff(wavelengths)).item()
20         except ValueError:
21             raise ValueError('wavelengths must be equally spaced apart.')
22
23         geometry_source = get_cu_source('geometry_types.h')
24         material_struct_size = characterize.sizeof('Material', geometry_source)
25         surface_struct_size = characterize.sizeof('Surface', geometry_source)
26         geometry_struct_size = characterize.sizeof('Geometry', geometry_source)
27
28         self.material_data = []
29         self.material_ptrs = []
30
31         def interp_material_property(wavelengths, property):
32             # note that it is essential that the material properties be
33             # interpolated linearly. this fact is used in the propagation
34             # code to guarantee that probabilities still sum to one.
35             return np.interp(wavelengths, property[:,0], property[:,1]).astype(np.float32)
36
37         for i in range(len(geometry.unique_materials)):
38             material = geometry.unique_materials[i]
39
40             if material is None:
41                 raise Exception('one or more triangles is missing a material.')
42
43             refractive_index = interp_material_property(wavelengths, material.refractive_index)
44             refractive_index_gpu = ga.to_gpu(refractive_index)
45             absorption_length = interp_material_property(wavelengths, material.absorption_length)
46             absorption_length_gpu = ga.to_gpu(absorption_length)
47             scattering_length = interp_material_property(wavelengths, material.scattering_length)
48             scattering_length_gpu = ga.to_gpu(scattering_length)
49             reemission_prob = interp_material_property(wavelengths, material.reemission_prob)
50             reemission_prob_gpu = ga.to_gpu(reemission_prob)
51             reemission_cdf = interp_material_property(wavelengths, material.reemission_cdf)
52             reemission_cdf_gpu = ga.to_gpu(reemission_cdf)
..</pre>
</div>
<p>NB all five material properties are linearly interpolated onto the same standard (or provided) wavelengths.</p>
<p>Same class also passes surface properties</p>
<ol class="arabic simple">
<li>detect</li>
<li>absorb</li>
<li>reemit</li>
<li>reflect_diffuse</li>
<li>reflect_specular</li>
<li>eta</li>
<li>k</li>
<li>reemission_cdf</li>
</ol>
<div class="highlight-python"><pre>78         for i in range(len(geometry.unique_surfaces)):
79             surface = geometry.unique_surfaces[i]
80
81             if surface is None:
82                 # need something to copy to the surface array struct
83                 # that is the same size as a 64-bit pointer.
84                 # this pointer will never be used by the simulation.
85                 self.surface_ptrs.append(np.uint64(0))
86                 continue
87
88             detect = interp_material_property(wavelengths, surface.detect)
89             detect_gpu = ga.to_gpu(detect)
90             absorb = interp_material_property(wavelengths, surface.absorb)
91             absorb_gpu = ga.to_gpu(absorb)
92             reemit = interp_material_property(wavelengths, surface.reemit)
93             reemit_gpu = ga.to_gpu(reemit)
94             reflect_diffuse = interp_material_property(wavelengths, surface.reflect_diffuse)
95             reflect_diffuse_gpu = ga.to_gpu(reflect_diffuse)
96             reflect_specular = interp_material_property(wavelengths, surface.reflect_specular)
97             reflect_specular_gpu = ga.to_gpu(reflect_specular)
98             eta = interp_material_property(wavelengths, surface.eta)
99             eta_gpu = ga.to_gpu(eta)
100             k = interp_material_property(wavelengths, surface.k)
101             k_gpu = ga.to_gpu(k)
102             reemission_cdf = interp_material_property(wavelengths, surface.reemission_cdf)
103             reemission_cdf_gpu = ga.to_gpu(reemission_cdf)
104
105             self.surface_data.append(detect_gpu)
106             self.surface_data.append(absorb_gpu)
107             self.surface_data.append(reemit_gpu)
108             self.surface_data.append(reflect_diffuse_gpu)
109             self.surface_data.append(reflect_specular_gpu)
110             self.surface_data.append(eta_gpu)
111             self.surface_data.append(k_gpu)
112             self.surface_data.append(reemission_cdf_gpu)
113
114             surface_gpu = \
115                 make_gpu_struct(surface_struct_size,
116                                 [detect_gpu, absorb_gpu, reemit_gpu,
117                                  reflect_diffuse_gpu,reflect_specular_gpu,
118                                  eta_gpu, k_gpu, reemission_cdf_gpu,
119                                  np.uint32(surface.model),
120                                  np.uint32(len(wavelengths)),
121                                  np.uint32(surface.transmissive),
122                                  np.float32(wavelength_step),
123                                  np.float32(wavelengths[0]),
124                                  np.float32(surface.thickness)])
125
126             self.surface_ptrs.append(surface_gpu)</pre>
</div>
</div>
<div class="section" id="chroma-cuda-propagate-cu">
<h2>chroma/cuda/propagate.cu<a class="headerlink" href="#chroma-cuda-propagate-cu" title="Permalink to this headline">¶</a></h2>
<div class="section" id="propagate">
<h3>propagate<a class="headerlink" href="#propagate" title="Permalink to this headline">¶</a></h3>
<p>Within the propagate stepping the <cite>fill_state(s, p, g)</cite> state, photon, geometry
sets material props with the state.</p>
<div class="highlight-python"><pre>152     if (p.history &amp; (NO_HIT | BULK_ABSORB | SURFACE_DETECT | SURFACE_ABSORB | NAN_ABORT))
153     return;
///
///     FLAGGED AS A DEAD PHOTON ALREADY, NOTHING TO DO
///
154
155     State s;
156
157     int steps = 0;
158     while (steps &lt; max_steps) {
159     steps++;
160
161     int command;
162
163     // check for NaN and fail
164     if (isnan(p.direction.x*p.direction.y*p.direction.z*p.position.x*p.position.y*p.position.z)) {
165         p.history |= NO_HIT | NAN_ABORT;
166         break;
167     }
168
169     fill_state(s, p, g);
170
171     if (p.last_hit_triangle == -1)
172         break;
173
174     command = propagate_to_boundary(p, s, rng, use_weights, scatter_first);
175     scatter_first = 0; // Only use the scatter_first value once
176
177     if (command == BREAK)
178         break;
179
180     if (command == CONTINUE)
181         continue;
182
183     if (s.surface_index != -1) {
184       command = propagate_at_surface(p, s, rng, g, use_weights);
185
186         if (command == BREAK)
187         break;
188
189         if (command == CONTINUE)
190         continue;
191     }
192
193     propagate_at_boundary(p, s, rng);
194
195     } // while (steps &lt; max_steps)</pre>
</div>
</div>
</div>
<div class="section" id="chroma-cuda-photon-h">
<h2>chroma/cuda/photon.h<a class="headerlink" href="#chroma-cuda-photon-h" title="Permalink to this headline">¶</a></h2>
<div class="section" id="state">
<h3>State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>30 struct State
31 {
32     bool inside_to_outside;
33
34     float3 surface_normal;
35
36     float refractive_index1, refractive_index2;
37     float absorption_length;
38     float scattering_length;
39     float reemission_prob;
40     Material *material1;
41
42     int surface_index;
43
44     float distance_to_boundary;
45 };</pre>
</div>
</div>
<div class="section" id="fill-state">
<h3>fill_state<a class="headerlink" href="#fill-state" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>79 __device__ void
80 fill_state(State &amp;s, Photon &amp;p, Geometry *g)
81 {
82     p.last_hit_triangle = intersect_mesh(p.position, p.direction, g,
83                                          s.distance_to_boundary,
84                                          p.last_hit_triangle);
85
86     if (p.last_hit_triangle == -1) {
87         p.history |= NO_HIT;
88         return;
89     }
90
91     Triangle t = get_triangle(g, p.last_hit_triangle);
92
93     unsigned int material_code = g-&gt;material_codes[p.last_hit_triangle];
94
95     int inner_material_index = convert(0xFF &amp; (material_code &gt;&gt; 24));
96     int outer_material_index = convert(0xFF &amp; (material_code &gt;&gt; 16));
97     s.surface_index = convert(0xFF &amp; (material_code &gt;&gt; 8));
98
99     float3 v01 = t.v1 - t.v0;
100     float3 v12 = t.v2 - t.v1;
101
102     s.surface_normal = normalize(cross(v01, v12));
103
104     Material *material1, *material2;
105     if (dot(s.surface_normal,-p.direction) &gt; 0.0f) {
106         // outside to inside
107         material1 = g-&gt;materials[outer_material_index];
108         material2 = g-&gt;materials[inner_material_index];
109
110         s.inside_to_outside = false;
111     }
112     else {
113         // inside to outside
114         material1 = g-&gt;materials[inner_material_index];
115         material2 = g-&gt;materials[outer_material_index];
116         s.surface_normal = -s.surface_normal;
117
118         s.inside_to_outside = true;
119     }
120
121     s.refractive_index1 = interp_property(material1, p.wavelength,
122                                           material1-&gt;refractive_index);
123     s.refractive_index2 = interp_property(material2, p.wavelength,
124                                           material2-&gt;refractive_index);
125     s.absorption_length = interp_property(material1, p.wavelength,
126                                           material1-&gt;absorption_length);
127     s.scattering_length = interp_property(material1, p.wavelength,
128                                           material1-&gt;scattering_length);
129     s.reemission_prob = interp_property(material1, p.wavelength,
130                                         material1-&gt;reemission_prob);
131
132     s.material1 = material1;
133 } // fill_state</pre>
</div>
<ol class="arabic simple">
<li>for COLLADA integration need to implement the GDML G4 material (and surface)
wavelength array properties into COLLADA extra tags</li>
</ol>
</div>
<div class="section" id="material-codes">
<h3>material_codes<a class="headerlink" href="#material-codes" title="Permalink to this headline">¶</a></h3>
<p>packed in <cite>chroma/geometry.py</cite> 4 bytes, high to low: <cite>material1/material2/surface/blank</cite></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">material_codes</span> <span class="o">=</span> <span class="p">(((</span><span class="n">geometry</span><span class="o">.</span><span class="n">material1_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">((</span><span class="n">geometry</span><span class="o">.</span><span class="n">material2_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">((</span><span class="n">geometry</span><span class="o">.</span><span class="n">surface_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">material_codes</span> <span class="o">=</span> <span class="n">ga</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">(</span><span class="n">material_codes</span><span class="p">)</span>
</pre></div>
</div>
<p>unpacked:</p>
<div class="highlight-python"><pre>92
93     unsigned int material_code = g-&gt;material_codes[p.last_hit_triangle];
94
95     int inner_material_index = convert(0xFF &amp; (material_code &gt;&gt; 24));
96     int outer_material_index = convert(0xFF &amp; (material_code &gt;&gt; 16));
97     s.surface_index = convert(0xFF &amp; (material_code &gt;&gt; 8));</pre>
</div>
<p>suggests correspondence:</p>
<ul class="simple">
<li>material1 is inner</li>
<li>material2 is outer</li>
</ul>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../chroma_propagate/" title="Photon Propagation"
             >next</a> |</li>
        <li class="right" >
          <a href="../chroma_geometry/" title="Chroma Geometry Source Overview"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../">Env  documentation</a> &raquo;</li>

          <li><a href="../" >chroma</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>