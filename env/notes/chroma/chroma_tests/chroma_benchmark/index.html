<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>chroma benchmark &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="tests" href="../" />
    <link rel="next" title="bin/chroma-cam" href="../chroma_cam/" />
    <link rel="prev" title="Unittests" href="../chroma_tests/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../chroma_cam/" title="bin/chroma-cam"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../chroma_tests/" title="Unittests"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >chroma</a> &raquo;</li>
          <li><a href="../" accesskey="U">tests</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">chroma</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../chroma_issues/">Chroma Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma/">CHROMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how_chroma_works/">How Chroma Works ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/">Chroma Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../refs/">Chroma Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_prerequisites/">Chroma Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_geant4_integration/">Chroma Geant4 Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_nuwa_geant4_integration/">Chroma/NuWa/Geant4 Integration with ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_nuwa_integration/">Chroma NuWa Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda_photon/">Chroma CUDA Photon handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_collada/">Chroma COLLADA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_pycuda/">Getting to know how Chroma uses PyCUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_geometry/">Chroma Geometry Source Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_materials/">Chroma Materials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_propagate/">Photon Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_physics/">Chroma Physics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_detector/">Chroma Modeling of Sensitive Detectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_server/">Chroma Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_zeromq/">Chroma ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_camera/">chroma_camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_sim/">chroma_sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda_freeze/">Chroma CUDA Freeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda/">Chroma CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_visualisation/">Chroma Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geant4_background/">Geant4 Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cuda_background/">Cuda Threads and Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bvh_background/">Bounding Volume Hierarchy (BVH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware/">Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_install/">install issues</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ChromaZMQRootTest/">ChromaZMQRootTest</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/chroma/chroma_tests/chroma_benchmark.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../chroma_tests/"
                        title="previous chapter">Unittests</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../chroma_cam/"
                        title="next chapter">bin/chroma-cam</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chroma-benchmark">
<h1>chroma benchmark<a class="headerlink" href="#chroma-benchmark" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#gzip-issue" id="id1">gzip issue</a></li>
<li><a class="reference internal" href="#io-module-shadowing" id="id2">io module shadowing</a></li>
<li><a class="reference internal" href="#hg-rename-did-not-delete-the-io-folder" id="id3">hg rename did not delete the io folder</a></li>
<li><a class="reference internal" href="#cumemalloc-failed-with-demo-detector" id="id4">cuMemAlloc failed with <cite>demo.detector()</cite></a></li>
<li><a class="reference internal" href="#with-demo-tiny-detector" id="id5">with <cite>demo.tiny()</cite> detector</a></li>
<li><a class="reference internal" href="#update-for-changed-api" id="id6">Update for changed API</a></li>
<li><a class="reference internal" href="#after-uncertainties-refactor" id="id7">After uncertainties refactor</a></li>
</ul>
</div>
<div class="section" id="gzip-issue">
<h2><a class="toc-backref" href="#id1">gzip issue</a><a class="headerlink" href="#gzip-issue" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python benchmark.py
Traceback (most recent call last):
  File "benchmark.py", line 10, in &lt;module&gt;
    from chroma import gpu
  File "/usr/local/env/chroma_env/src/chroma/chroma/__init__.py", line 2, in &lt;module&gt;
    from chroma.camera import Camera, EventViewer, view, build
  File "/usr/local/env/chroma_env/src/chroma/chroma/camera.py", line 15, in &lt;module&gt;
    from chroma.geometry import Mesh, Solid, Geometry, vacuum
  File "/usr/local/env/chroma_env/src/chroma/chroma/geometry.py", line 6, in &lt;module&gt;
    import gzip
  File "/opt/local/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/gzip.py", line 36, in &lt;module&gt;
    class GzipFile(io.BufferedIOBase):
AttributeError: 'module' object has no attribute 'BufferedIOBase'
(chroma_env)delta:chroma blyth$</pre>
</div>
</div>
<div class="section" id="io-module-shadowing">
<h2><a class="toc-backref" href="#id2">io module shadowing</a><a class="headerlink" href="#io-module-shadowing" title="Permalink to this headline">¶</a></h2>
<p>Module implemented <cite>chroma/io/__init__.py</cite>  is problematic for gzip import:</p>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$
(chroma_env)delta:chroma blyth$ python -c "from chroma.geometry import Mesh, Solid, Geometry, vacuum"
Traceback (most recent call last):
  File "&lt;string&gt;", line 1, in &lt;module&gt;
  File "/usr/local/env/chroma_env/src/chroma/chroma/__init__.py", line 2, in &lt;module&gt;
    from chroma.camera import Camera, EventViewer, view, build
  File "/usr/local/env/chroma_env/src/chroma/chroma/camera.py", line 16, in &lt;module&gt;
    from chroma.geometry import Mesh, Solid, Geometry, vacuum
  File "/usr/local/env/chroma_env/src/chroma/chroma/geometry.py", line 6, in &lt;module&gt;
    import gzip
  File "/opt/local/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/gzip.py", line 36, in &lt;module&gt;
    class GzipFile(io.BufferedIOBase):
AttributeError: 'module' object has no attribute 'BufferedIOBase'
(chroma_env)delta:chroma blyth$
(chroma_env)delta:chroma blyth$ pwd
/usr/local/env/chroma_env/src/chroma/chroma
(chroma_env)delta:chroma blyth$
(chroma_env)delta:chroma blyth$
(chroma_env)delta:chroma blyth$ cd /tmp
(chroma_env)delta:tmp blyth$ python -c "from chroma.geometry import Mesh, Solid, Geometry, vacuum"
(chroma_env)delta:tmp blyth$</pre>
</div>
<p>Rename to <cite>io_</cite> and change sole usage in <cite>chroma/camera.py</cite>:</p>
<div class="highlight-python"><pre>670 class EventViewer(Camera):
671     # Constants for display_mode
672     CHARGE = 0
673     TIME = 1
674     HIT = 2
675
676     def __init__(self, geometry, filename, **kwargs):
677         Camera.__init__(self, geometry, **kwargs)
678         # This is really slow, so we do it here in the constructor to
679         # avoid slowing down the import of this module
680         from chroma.io_.root import RootReader
681         self.rr = RootReader(filename)
682         self.display_mode = EventViewer.CHARGE
683         self.sum_mode = False
684         self.photon_display_iter = itertools.cycle(['beg','end'])
685         self.photon_display_mode = self.photon_display_iter.next()
686</pre>
</div>
</div>
<div class="section" id="hg-rename-did-not-delete-the-io-folder">
<h2><a class="toc-backref" href="#id3">hg rename did not delete the io folder</a><a class="headerlink" href="#hg-rename-did-not-delete-the-io-folder" title="Permalink to this headline">¶</a></h2>
<p>Due to the pesky pyc:</p>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ l io/
total 32
-rw-r--r--  1 blyth  staff  9073 Apr  4 13:13 root.pyc
-rw-r--r--  1 blyth  staff   145 Apr  4 13:13 __init__.pyc
(chroma_env)delta:chroma blyth$</pre>
</div>
<p>So still shadowing:</p>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python -c "import gzip"
Traceback (most recent call last):
  File "&lt;string&gt;", line 1, in &lt;module&gt;
  File "/opt/local/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/gzip.py", line 36, in &lt;module&gt;
    class GzipFile(io.BufferedIOBase):
AttributeError: 'module' object has no attribute 'BufferedIOBase'
(chroma_env)delta:chroma blyth$</pre>
</div>
<p>Until manually remove:</p>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ rm -rf io
(chroma_env)delta:chroma blyth$ python -c "import gzip"
(chroma_env)delta:chroma blyth$</pre>
</div>
</div>
<div class="section" id="cumemalloc-failed-with-demo-detector">
<h2><a class="toc-backref" href="#id4">cuMemAlloc failed with <cite>demo.detector()</cite></a><a class="headerlink" href="#cumemalloc-failed-with-demo-detector" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>MemoryError: cuMemAlloc failed: out of memory</pre>
</div>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python benchmark.py
Expanding 72673 parent nodes
Merging 59444320 nodes to 18942711 parents
Expanding 80 parent nodes
Merging 19034296 nodes to 5999243 parents
Merging 5999323 nodes to 1658271 parents
Merging 1658271 nodes to 482893 parents
Expanding 1181 parent nodes
Merging 482893 nodes to 120973 parents
Merging 122154 nodes to 31993 parents
Merging 31993 nodes to 6305 parents
Merging 6305 nodes to 1341 parents
Merging 1341 nodes to 272 parents
Merging 272 nodes to 56 parents
Merging 56 nodes to 16 parents
Merging 16 nodes to 4 parents
Merging 4 nodes to 1 parent
Traceback (most recent call last):
  File "benchmark.py", line 247, in &lt;module&gt;
    detector = create_geometry_from_obj(demo.detector())
  File "/usr/local/env/chroma_env/src/chroma/chroma/loader.py", line 189, in create_geometry_from_obj
    cuda_device=cuda_device)
  File "/usr/local/env/chroma_env/src/chroma/chroma/loader.py", line 151, in load_bvh
    bvh = make_recursive_grid_bvh(geometry.mesh, target_degree=3)
  File "/usr/local/env/chroma_env/src/chroma/chroma/bvh/grid.py", line 91, in make_recursive_grid_bvh
    nodes, layer_bounds = concatenate_layers(layers)
  File "/usr/local/env/chroma_env/src/chroma/chroma/gpu/bvh.py", line 266, in concatenate_layers
    grid=(nblocks_this_iter,1))
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py", line 355, in function_call
    handlers, arg_buf = _build_arg_buf(args)
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py", line 125, in _build_arg_buf
    arg_data.append(int(arg.get_device_alloc()))
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py", line 59, in get_device_alloc
    self.dev_alloc = mem_alloc_like(self.array)
  File "/usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py", line 608, in mem_alloc_like
    return mem_alloc(ary.nbytes)
MemoryError: cuMemAlloc failed: out of memory

&gt; /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py(608)mem_alloc_like()
-&gt; return mem_alloc(ary.nbytes)
(Pdb) p ary
array([(1057635393L, 1093418857L, 682436037L, 26470L),
       (1067793635L, 1063992748L, 696133269L, 26670L),
       (1023752832L, 949171942L, 825044518L, 27472L), ...,
       (3258629873L, 3428829884L, 3524907020L, 11971L),
       (3271081900L, 3401500949L, 3540373746L, 12171L),
       (3283796054L, 3260137618L, 3647395662L, 13170L)],
      dtype=[('x', '&lt;u4'), ('y', '&lt;u4'), ('z', '&lt;u4'), ('w', '&lt;u4')])
(Pdb) p ary.nbytes
951109120
(Pdb) p ary.nbytes/1E6
951.10912
(Pdb)
(Pdb) list
603         return result
604
605     # }}}
606
607     def mem_alloc_like(ary):
608  -&gt;     return mem_alloc(ary.nbytes)
609
610     # {{{ array handling
611
612     def dtype_to_array_format(dtype):
613         if dtype == np.uint8:
(Pdb) bt
  /usr/local/env/chroma_env/src/chroma/chroma/benchmark.py(247)&lt;module&gt;()
-&gt; detector = create_geometry_from_obj(demo.detector())
  /usr/local/env/chroma_env/src/chroma/chroma/loader.py(189)create_geometry_from_obj()
-&gt; cuda_device=cuda_device)
  /usr/local/env/chroma_env/src/chroma/chroma/loader.py(151)load_bvh()
-&gt; bvh = make_recursive_grid_bvh(geometry.mesh, target_degree=3)
  /usr/local/env/chroma_env/src/chroma/chroma/bvh/grid.py(91)make_recursive_grid_bvh()
-&gt; nodes, layer_bounds = concatenate_layers(layers)
  /usr/local/env/chroma_env/src/chroma/chroma/gpu/bvh.py(266)concatenate_layers()
-&gt; grid=(nblocks_this_iter,1))
  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py(355)function_call()
-&gt; handlers, arg_buf = _build_arg_buf(args)
  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py(125)_build_arg_buf()
-&gt; arg_data.append(int(arg.get_device_alloc()))
  /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py(59)get_device_alloc()
-&gt; self.dev_alloc = mem_alloc_like(self.array)
&gt; /usr/local/env/chroma_env/lib/python2.7/site-packages/pycuda/driver.py(608)mem_alloc_like()
-&gt; return mem_alloc(ary.nbytes)
(Pdb)</pre>
</div>
</div>
<div class="section" id="with-demo-tiny-detector">
<h2><a class="toc-backref" href="#id5">with <cite>demo.tiny()</cite> detector</a><a class="headerlink" href="#with-demo-tiny-detector" title="Permalink to this headline">¶</a></h2>
<p>Use a smaller detector to benchmark.</p>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python benchmark.py
Expanding 5701 parent nodes
Merging 392512 nodes to 109652 parents
Expanding 1011 parent nodes
Merging 116190 nodes to 29325 parents
Expanding 1 parent nodes
Merging 30428 nodes to 8372 parents
Merging 8373 nodes to 2304 parents
Merging 2304 nodes to 558 parents
Merging 558 nodes to 110 parents
Merging 110 nodes to 32 parents
Merging 32 nodes to 8 parents
Merging 8 nodes to 2 parents
Merging 2 nodes to 1 parent
[ . . . . . . . . . . ]

benchmark.py:48: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))
/usr/local/env/chroma_env/src/chroma/chroma/tools.py:19: UserWarning: Obsolete: the std_dev attribute should not be called anymore: use .std_dev instead of .std_dev(). Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  msd = -int(math.floor(math.log10(x.std_dev())))
/usr/local/env/chroma_env/src/chroma/chroma/tools.py:21: UserWarning: Obsolete: the std_dev attribute should not be called anymore: use .std_dev instead of .std_dev(). Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  msd, round(x.std_dev(), msd))

5000000 +/- 1000000 ray intersections/sec.
[ . . . . . . . . . . ]

benchmark.py:70: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))

32000000 +/- 2000000 photons loaded/sec.
[ . . . . . . . . . . ]

benchmark.py:98: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))

2440000 +/- 50000 photons propagated/sec.
[ . . . . . . . . . . ]

benchmark.py:156: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nevents*nreps*ndaq/ufloat((np.mean(run_times),np.std(run_times)))

79 +/- 2 100 MeV events histogrammed/s

Traceback (most recent call last):
  File "benchmark.py", line 278, in &lt;module&gt;
    tools.ufloat_to_str(pdf_eval(gpu_detector))
  File "benchmark.py", line 190, in pdf_eval
    gpu_daq.acquire(gpu_photons, rng_states, nthreads_per_block, max_blocks).get()
AttributeError: 'NoneType' object has no attribute 'get'

&gt; /usr/local/env/chroma_env/src/chroma/chroma/benchmark.py(190)pdf_eval()
-&gt; gpu_daq.acquire(gpu_photons, rng_states, nthreads_per_block, max_blocks).get()
(Pdb)

(Pdb) p gpu_daq
&lt;chroma.gpu.daq.GPUDaq object at 0x10bc05ed0&gt;

(Pdb) p gpu_photons
&lt;chroma.gpu.photon.GPUPhotons object at 0x10bbd1710&gt;

(Pdb) p rng_states
&lt;pycuda._driver.DeviceAllocation object at 0x10ca47fa0&gt;

(Pdb) p nthreads_per_block
64
(Pdb) p max_blocks
1024
(Pdb) p gpu_detector
&lt;chroma.gpu.detector.GPUDetector object at 0x10b5ce810&gt;
(Pdb) p context
&lt;pycuda._driver.Context object at 0x10b5cf758&gt;
(Pdb)</pre>
</div>
</div>
<div class="section" id="update-for-changed-api">
<h2><a class="toc-backref" href="#id6">Update for changed API</a><a class="headerlink" href="#update-for-changed-api" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python benchmark.py
[ . . . . . . . . . . ]
benchmark.py:48: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))
/usr/local/env/chroma_env/src/chroma/chroma/tools.py:19: UserWarning: Obsolete: the std_dev attribute should not be called anymore: use .std_dev instead of .std_dev(). Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  msd = -int(math.floor(math.log10(x.std_dev())))
/usr/local/env/chroma_env/src/chroma/chroma/tools.py:21: UserWarning: Obsolete: the std_dev attribute should not be called anymore: use .std_dev instead of .std_dev(). Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  msd, round(x.std_dev(), msd))
5000000 +/- 1000000 ray intersections/sec.
[ . . . . . . . . . . ]
benchmark.py:70: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))
20000000 +/- 4000000 photons loaded/sec.
[ . . . . . . . . . . ]
benchmark.py:98: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nphotons/ufloat((np.mean(run_times),np.std(run_times)))
2200000 +/- 300000 photons propagated/sec.
[ . . . . . . . . . . ]
benchmark.py:156: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nevents*nreps*ndaq/ufloat((np.mean(run_times),np.std(run_times)))
78 +/- 3 100 MeV events histogrammed/s
[ . . . . . . . . . . ]
benchmark.py:241: UserWarning: Obsolete: either use ufloat(nominal_value, std_dev), ufloat(nominal_value, std_dev, tag), or the ufloat_fromstr() function, for string representations. Code can be automatically updated with python -m uncertainties.1to2 -w ProgramDirectory.
  return nevents*nreps*ndaq/ufloat((np.mean(run_times),np.std(run_times)))
8500 +/- 600 100 MeV events/s accumulated in PDF evaluation data structure (100 GEANT4 x 16 Chroma x 128 DAQ)
(chroma_env)delta:chroma blyth$</pre>
</div>
</div>
<div class="section" id="after-uncertainties-refactor">
<h2><a class="toc-backref" href="#id7">After uncertainties refactor</a><a class="headerlink" href="#after-uncertainties-refactor" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>(chroma_env)delta:chroma blyth$ python benchmark.py
[ . . . . . . . . . . ]
5000000 +/- 1000000 ray intersections/sec.
[ . . . . . . . . . . ]
18400000 +/- 600000 photons loaded/sec.
[ . . . . . . . . . . ]
2100000 +/- 200000 photons propagated/sec.
[ . . . . . . . . . . ]
77 +/- 5 100 MeV events histogrammed/s
[ . . . . . . . . . . ]
8800 +/- 400 100 MeV events/s accumulated in PDF evaluation data structure (100 GEANT4 x 16 Chroma x 128 DAQ)
(chroma_env)delta:chroma blyth$</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../chroma_cam/" title="bin/chroma-cam"
             >next</a> |</li>
        <li class="right" >
          <a href="../chroma_tests/" title="Unittests"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >chroma</a> &raquo;</li>
          <li><a href="../" >tests</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>