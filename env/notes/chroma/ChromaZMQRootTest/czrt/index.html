<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CZRT : ChromaZMQRootTest &mdash; Env  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/highstock/highstock.js"></script>
    <script type="text/javascript" src="../../../_static/highstock/modules/exporting.js"></script>
    <link rel="top" title="Env  documentation" href="../../../" />
    <link rel="up" title="ChromaZMQRootTest" href="../" />
    <link rel="next" title="Chroma Use Of CURand" href="../../chroma_curand/" />
    <link rel="prev" title="ZMQRoot/MyTMessage dtor issue" href="../czrt_double_free/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../chroma_curand/" title="Chroma Use Of CURand"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../czrt_double_free/" title="ZMQRoot/MyTMessage dtor issue"
             accesskey="P">previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >chroma</a> &raquo;</li>
          <li><a href="../" accesskey="U">ChromaZMQRootTest</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Links</h3>
<ul class="this-page-menu">
	<li><a href="/tracs/env"> env </a>  <a href="/tracs/env/timeline"> tl </a> <a href="/repos/env/trunk"> repo </a> <a href="/e"> edocs </a> </li>
	<li><a href="/tracs/heprez"> heprez </a>  <a href="/tracs/heprez/timeline"> tl </a> <a href="/repos/heprez/trunk"> repo</a> <a href="/h">hdocs</a>   </li>
        <li><a href="/e/scm/monitor/" > backup status </a> </li>
</ul>

<h3>Content Skeleton</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing <strong>env</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../base/">Base Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log/May2012/">LOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO/">TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sysadmin/">Sys Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot/">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/">SCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trac/">Trac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../root/">ROOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext/">Sphinx Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../matplotlib/">Matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nose/">nose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svn/">SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../npy/">Numerical Python, numpy et al</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pypy/">PyPy : faster python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysqlhotcopy/">MySQL hotcopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/">MySQL Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../db/">DB scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qxml/">QXML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fossil/">Fossil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/">Java Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycuda/">pycuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../geant4/">geant4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../muon_simulation/">muon_simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">chroma</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../G4DAEChroma/">G4DAEChroma</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_issues/">Chroma Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_intersection/">Chroma Intersection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma/">CHROMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how_chroma_works/">How Chroma Works ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/">Chroma Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../refs/">Chroma Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_prerequisites/">Chroma Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_geant4_integration/">Chroma Geant4 Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_nuwa_geant4_integration/">Chroma/NuWa/Geant4 Integration with ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_nuwa_integration/">Chroma NuWa Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda_photon/">Chroma CUDA Photon handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_collada/">Chroma COLLADA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_pycuda/">Getting to know how Chroma uses PyCUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_pyublas/">Chroma Use of PyUblas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_geometry/">Chroma Geometry Source Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_materials/">Chroma Materials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_propagate/">Photon Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_physics/">Chroma Physics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_detector/">Chroma Modeling of Sensitive Detectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_server/">Chroma Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_zeromq/">Chroma ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_camera/">chroma_camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_sim/">chroma_sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda_freeze/">Chroma CUDA Freeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_cuda/">Chroma CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_visualisation/">Chroma Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../photon_mapping/">Photon Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../geant4_background/">Geant4 Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cuda_background/">Cuda Threads and Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bvh_background/">Bounding Volume Hierarchy (BVH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware/">Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_install/">install issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_tests/">tests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">ChromaZMQRootTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_curand/">Chroma Use Of CURand</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chroma_reemission/">Chroma Reemission</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../llvm/">llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphics/">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda/">cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencl/">opencl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_management/">Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui/">ui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/">debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mercurial/">mercurial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/">javascript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nuwa/">nuwa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ccgpu/">ccgpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pygame/">pygame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zeromq/">zeromq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/">doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../osx/">osx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hg/">hg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simoncblyth.bitbucket.org/">simoncblyth.bitbucket.org</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../numpy/">numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentation/">Muon Simulation Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optix/">optix</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/chroma/ChromaZMQRootTest/czrt.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../czrt_double_free/"
                        title="previous chapter">ZMQRoot/MyTMessage dtor issue</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../chroma_curand/"
                        title="next chapter">Chroma Use Of CURand</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="czrt-chromazmqroottest">
<h1>CZRT : ChromaZMQRootTest<a class="headerlink" href="#czrt-chromazmqroottest" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li>TODO: bring echoserver code into czrt folder, its already in the nuwapkg</li>
</ol>
<div class="section" id="memory-issue">
<h2>Memory Issue<a class="headerlink" href="#memory-issue" title="Permalink to this headline">¶</a></h2>
<p>With MyTMessage used on stack in the test (rather than heap)
get <strong>pointer being freed was not allocated</strong>
as it goes out of scope:</p>
<div class="highlight-python"><pre>ChromaZMQRootTest(36786,0x7fff7ab15310) malloc: *** error for object 0x10561df08: pointer being freed was not allocated
*** set a breakpoint in malloc_error_break to debug</pre>
</div>
<p>Suspect something funny related to the TObject status bits and
the fact that the object is serialized in one place and deserialised elsewhere.
Saw something similar with pyzmq which was resolved using PyROOT <cite>ROOT.SetOwnnership(kFALSE)</cite>.</p>
<p>Currently MyTMessage usage on heap without deletion looks like a leak.
Need to investigate TObject internals to understand further.</p>
</div>
<div class="section" id="running-echoserver">
<h2>Running Echoserver<a class="headerlink" href="#running-echoserver" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>[blyth@belle7 cmt]$ czrt-nuwapkg-testserver
=== nuwacmt-config : for pkg /data1/env/local/dyb/NuWa-trunk/dybgaudi/Utilities/ChromaZMQRootTest
Removing all previous make fragments from i686-slc5-gcc41-dbg
Creating setup scripts.
Creating cleanup scripts.
ZMQEchoServer.exe
do_bind tcp://*:5555</pre>
</div>
</div>
<div class="section" id="functions">
<h2>FUNCTIONS<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><em>czrt-build</em></dt>
<dd>cmake controlled build</dd>
<dt><em>czrt-build-full</em></dt>
<dd>build after first deleting the build directory</dd>
<dt><em>czrt-nuwapkg-cpto</em></dt>
<dd>copy source into the corresponding DYB NuWa pkg</dd>
</dl>
</div>
<div class="section" id="scripts">
<h2>SCRIPTS<a class="headerlink" href="#scripts" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><em>czrt.sh</em></dt>
<dd>send test CPL TObject to the configured <em>zmq-broker-url-frontend</em></dd>
</dl>
</div>
<div class="section" id="local-debug">
<h2>Local DEBUG<a class="headerlink" href="#local-debug" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Initially <em>czrt.sh</em> gives symbol loading issue</p>
</li>
<li><p class="first">After a <em>czrt-build</em> runs, but meets NUU network blockage:</p>
<div class="highlight-python"><pre>delta:collada blyth$ czrt.sh

   zmq-broker-url          : tcp://203.64.184.126:5001
   zmq-broker-url-frontend : tcp://203.64.184.126:5001
   zmq-broker-url-backend  : tcp://203.64.184.126:5002

   zmq-broker-host         : 203.64.184.126

ZMQRoot::ZMQRoot envvar [CHROMA_CLIENT_CONFIG][Q] config [tcp://203.64.184.126:5001]
ChromaPhotonList::Print  [6]
ZMQRoot::SendObject sent bytes: 457</pre>
</div>
</li>
<li><p class="first">Attempt to tunnel through the block, getting refused:</p>
<div class="highlight-python"><pre>delta:~ blyth$ czrt.sh --zmqtunnelnode=N

   zmq-broker-url          : tcp://203.64.184.126:5001
   zmq-broker-url-frontend : tcp://203.64.184.126:5001
   zmq-broker-url-backend  : tcp://203.64.184.126:5002

   zmq-broker-host         : 203.64.184.126

=== ssh-tunnel-open : opening ssh tunnel using below command
ssh -fN -p 22 -L 127.0.0.1:64542:203.64.184.126:5001 N
=== ssh-tunnel-open : modifying ZMQ_BROKER_URL_FRONTEND to tcp://127.0.0.1:64542 in order to use the ssh tunnel
ZMQRoot::ZMQRoot envvar [CHROMA_CLIENT_CONFIG][Q] config [tcp://127.0.0.1:64542]
ChromaPhotonList::Print  [6]
ZMQRoot::SendObject sent bytes: 457
channel 1: open failed: connect failed: Connection refused
channel 1: open failed: connect failed: Connection refused
channel 1: open failed: connect failed: Connection refused</pre>
</div>
</li>
</ol>
</div>
<div class="section" id="nuwa-debug">
<h2>NuWa DEBUG<a class="headerlink" href="#nuwa-debug" title="Permalink to this headline">¶</a></h2>
<p>Not getting through, nothing showing on broker:</p>
<div class="highlight-python"><pre>[blyth@belle7 env]$ LD_LIBRARY_PATH=$DYB/external/zmq/4.0.4/i686-slc5-gcc41-dbg/lib:$LD_LIBRARY_PATH CHROMA_CLIENT_CONFIG=tcp://127.0.0.1:5001 ChromaZMQRootTest.exe
ZMQRoot::ZMQRoot envvar [CHROMA_CLIENT_CONFIG] config [tcp://127.0.0.1:5001]
ChromaPhotonList::Print UID [0] [6]
ZMQRoot::SendObject sent bytes: 457</pre>
</div>
<div class="section" id="works-locally">
<h3>works locally<a class="headerlink" href="#works-locally" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>[blyth@belle7 src]$ LD_LIBRARY_PATH=$DYB/external/zmq/4.0.4/i686-slc5-gcc41-dbg/lib:$LD_LIBRARY_PATH ECHO_SERVER_CONFIG=tcp://*:4000 ZMQEchoServer.exe
do_bind tcp://*:4000
do_receive zmq_msg_recv waiting...
do_receive got bytes:457
do_send... sending msg of  457 bytes
do_send... queued  457 bytes
do_receive zmq_msg_recv waiting...

[blyth@belle7 ~]$ LD_LIBRARY_PATH=$DYB/external/zmq/4.0.4/i686-slc5-gcc41-dbg/lib:$LD_LIBRARY_PATH CHROMA_CLIENT_CONFIG=tcp://127.0.0.1:4000 ChromaZMQRootTest.exe
ZMQRoot::ZMQRoot envvar [CHROMA_CLIENT_CONFIG] config [tcp://127.0.0.1:4000]
ChromaPhotonList::Print UID [0] [6]
ZMQRoot::SendObject sent bytes: 457
ZMQRoot::ReceiveObject received bytes: 457
ZMQRoot::ReceiveObject reading TObject from the TMessage
ZMQRoot::ReceiveObject returning TObject
ReceiveObject
ChromaPhotonList::Print UID [0] [6]
ChromaPhotonList::Print UID [0] [6]
ChromaPhotonList::Details [6]
 index 0 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
 index 1 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
 index 2 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
 index 3 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
 index 4 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
 index 5 pos (1,1,1) mom (2,2,2) pol (3,3,3) _t 0 _wavelength 100 _pmtid 101
[blyth@belle7 ~]$</pre>
</div>
<div class="sidebar">
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../chroma_curand/" title="Chroma Use Of CURand"
             >next</a> |</li>
        <li class="right" >
          <a href="../czrt_double_free/" title="ZMQRoot/MyTMessage dtor issue"
             >previous</a> |</li>
    <li><a href="/tracs/env/timeline">env</a> &raquo;</li>
    
        <li><a href="../../../">Env  documentation</a> &raquo;</li>

          <li><a href="../../" >chroma</a> &raquo;</li>
          <li><a href="../" >ChromaZMQRootTest</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Simon C Blyth.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>